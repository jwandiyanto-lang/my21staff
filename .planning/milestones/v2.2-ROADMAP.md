# Milestone v2.2: ARI & User Flow

**Status:** SHIPPED 2026-01-20
**Phases:** 1-6 (Phase 4 skipped, Phase 7 deferred)
**Total Plans:** 23

## Overview

End-to-end user journey from social media leads to paid consultations via ARI WhatsApp bot. First client: Eagle Overseas Education.

## Phases

### Phase 1: Database Schema & Inbox Overhaul

**Goal**: Foundation for ARI + improved inbox experience
**Depends on**: v2.1 completion
**Plans**: 5 plans

Plans:
- [x] 01-01-PLAN.md — ARI database tables (7 tables, 21 RLS policies)
- [x] 01-02-PLAN.md — Contacts cache fields + phone normalization
- [x] 01-03-PLAN.md — RLS policies + realtime publication for ARI tables
- [x] 01-04-PLAN.md — Active/All filter toggle + enhanced inbox filters
- [x] 01-05-PLAN.md — Typing indicators + real-time sync improvements

**Details:**
- Created ari_config, ari_destinations, ari_conversations, ari_messages, ari_payments, ari_appointments, ari_ai_comparison tables
- Kapso metadata caching for instant inbox loading
- E.164 phone normalization with libphonenumber-js
- Realtime subscriptions for all ARI tables

---

### Phase 2: ARI Core Conversation

**Goal**: ARI pulls form data and has intelligent conversations
**Depends on**: Phase 1
**Plans**: 5 plans

Plans:
- [x] 02-01-PLAN.md — ARI foundation: types and multi-LLM clients (Grok + Sea-Lion)
- [x] 02-02-PLAN.md — State machine and context builder
- [x] 02-03-PLAN.md — Webhook integration and message processing
- [x] 02-04-PLAN.md — Form validation and qualification logic
- [x] 02-05-PLAN.md — Knowledge base integration for university questions

**Details:**
- OpenAI SDK for both Grok and Sea-Lion (compatible API)
- Hash-based A/B testing (same contact always gets same model)
- State machine: greeting -> qualifying -> scoring -> booking -> scheduling -> handoff -> completed
- Indonesian language with configurable persona

---

### Phase 3: Lead Scoring & Routing

**Goal**: Dynamic scoring and automatic lead routing
**Depends on**: Phase 2
**Plans**: 4 plans

Plans:
- [x] 03-01-PLAN.md — Scoring calculation engine (0-100 with breakdown)
- [x] 03-02-PLAN.md — Processor integration and routing logic
- [x] 03-03-PLAN.md — UI: Score breakdown component in sidebar
- [x] 03-04-PLAN.md — Routing action execution (handoff, community link)

**Details:**
- Weighted scoring: basic 25pts, qualification 35pts, documents 30pts, engagement 10pts
- Temperature thresholds: hot >= 70, warm >= 40, cold < 40
- Hot leads get consultation push, cold leads get community link
- Jest test infrastructure added

---

### Phase 4: Payment Integration (SKIPPED)

**Goal**: Midtrans payment gateway for consultation booking
**Status**: Skipped — Client (Eagle) has existing payment method
**Deferred to**: v2.3

---

### Phase 5: Scheduling & Handoff

**Goal**: Book consultations and hand off to consultants
**Depends on**: Phase 3
**Plans**: 4 plans

Plans:
- [x] 05-01-PLAN.md — Slot database schema and CRUD API
- [x] 05-02-PLAN.md — Knowledge Base UI with slot management
- [x] 05-03-PLAN.md — ARI booking conversation flow
- [x] 05-04-PLAN.md — Handoff automation and notifications

**Details:**
- consultant_slots table with weekly patterns
- Indonesian day/time parsing for booking
- Scheduling sub-states: asking_day -> showing_slots -> confirming -> booked
- Auto-generated notes with conversation summary
- Appointment reminder cron (45-75 min window)

---

### Phase 6: Admin Interface

**Goal**: "Your Intern" configuration page
**Depends on**: Phase 5
**Plans**: 5 plans

Plans:
- [x] 06-01-PLAN.md — Persona tab (name, tone, greeting, community link)
- [x] 06-02-PLAN.md — Flow tab (custom conversation stages)
- [x] 06-03-PLAN.md — Database tab (categories + entries)
- [x] 06-04-PLAN.md — Scoring tab (thresholds + weights)
- [x] 06-05-PLAN.md — Integration (enable all tabs)

**Details:**
- 5-tab interface: Persona, Flow, Database, Scoring, Slots
- ARI config API with upsert pattern
- ari_flow_stages, ari_knowledge_categories, ari_knowledge_entries, ari_scoring_config tables
- Responsive mobile styling (icons only on small screens)

---

### Phase 7: AI Model Selection (DEFERRED)

**Goal**: Grok + Sea-Lion A/B testing UI
**Status**: Deferred — Core functionality complete, UI can wait
**Deferred to**: v2.3

---

## Milestone Summary

**Key Decisions:**
- Multi-tenant ARI infrastructure (workspace_id on all tables)
- User-initiated WhatsApp trigger (form shows WA CTA, user starts conversation)
- Fire-and-forget webhook pattern (processWithARI not awaited)
- Direct booking -> scheduling transition (payment skipped)
- One ARI conversation per contact per workspace (UNIQUE constraint)

**Issues Resolved:**
- Inbox real-time sync with idempotent updates
- Phone number matching with E.164 normalization
- State machine escape hatch (handoff always allowed)

**Issues Deferred:**
- Phase 6 "Your Intern" page API timeout (to be investigated post-milestone)
- AI model selection UI (Phase 7 → v2.3)
- Payment integration (Phase 4 → v2.3)

**Technical Debt Incurred:**
- Type casts for ari_* tables (database.ts not regenerated)
- Your Intern page API needs debugging

---

*For current project status, see .planning/ROADMAP.md*
