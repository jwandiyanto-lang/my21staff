---
phase: 05-grok-manager-bot
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - convex/brainAnalysis.ts
  - convex/crons.ts
autonomous: true

must_haves:
  truths:
    - "Brain can generate summaries using Grok 4.1-fast API"
    - "Daily summary runs automatically via Convex cron"
    - "Summary respects brainConfig settings (enabled, metrics)"
  artifacts:
    - path: "convex/brainAnalysis.ts"
      provides: "Core Grok API integration and summary generation"
      exports: ["generateDailySummary", "generateSummaryForWorkspace"]
    - path: "convex/crons.ts"
      provides: "Daily summary scheduler"
      contains: "brainAnalysis.generateDailySummary"
  key_links:
    - from: "convex/brainAnalysis.ts"
      to: "convex/brainConfig.ts"
      via: "reads config for enabled/metrics"
      pattern: "brainConfig.getByWorkspaceId"
    - from: "convex/brainAnalysis.ts"
      to: "convex/brainSummaries.ts"
      via: "stores generated summaries"
      pattern: "brainSummaries.createSummary"
    - from: "convex/crons.ts"
      to: "convex/brainAnalysis.ts"
      via: "scheduled trigger"
      pattern: "brainAnalysis.generateDailySummary"
---

<objective>
Implement Brain summary generation using Grok 4.1-fast API with daily scheduling.

Purpose: Enable automated daily summaries and manual !summary triggers that analyze lead data and generate conversational insights.

Output: Working summary generation that reads from brainConfig, calls Grok API, and stores results.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-grok-manager-bot/05-CONTEXT.md
@.planning/phases/05-grok-manager-bot/05-RESEARCH.md
@convex/brainConfig.ts
@convex/leads.ts
@convex/ai/brain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create brainAnalysis.ts with Grok API integration</name>
  <files>convex/brainAnalysis.ts</files>
  <action>
Create new file convex/brainAnalysis.ts with core Brain analysis logic:

**1. System prompt constant:**
```typescript
const BRAIN_SUMMARY_SYSTEM_PROMPT = `You are Brain - the analytical AI assistant for my21staff. Your job is to summarize lead activity in a conversational, friendly tone.

TONE: Conversational assistant (friendly but focused)
- Good: "Here's what happened today - you've got 3 hot ones!"
- Bad: "Today's summary: 5 new leads, 3 hot leads, 2 conversions"
- Bad: "5 new | 3 need attention | 2 went cold"

FORMAT: Hybrid conversational + data
- Start with natural language intro (1-2 sentences)
- Include key metrics as bullet points
- End with 1-2 specific action recommendations

KEEP IT SHORT: Under 800 characters for WhatsApp readability.

If data is insufficient, say "Not enough data yet" instead of guessing.`;
```

**2. internalAction: generateSummaryForWorkspace**
- Args: workspace_id, trigger ('cron' | 'command' | 'api'), triggered_by? (phone if !summary)
- Steps:
  1. Fetch brainConfig for workspace (use internal query)
  2. If config.summary.enabled === false, return { skipped: true }
  3. Fetch lead stats using leads.getLeadStats query
  4. Fetch hot leads using leads.getLeadsByStatus with status='qualified', limit=5
  5. Build prompt with stats and hot lead names
  6. Call Grok 4.1-fast API (model: "grok-4.1-fast", NOT "grok-3")
  7. Store summary via brainSummaries.createSummary
  8. Return { success: true, summaryText, tokens_used, cost_usd }

**3. Grok API call function:**
```typescript
async function callGrokAPI(systemPrompt: string, userPrompt: string): Promise<{
  content: string;
  tokens: number;
  cost: number;
}> {
  const grokApiKey = process.env.GROK_API_KEY;
  if (!grokApiKey) throw new Error("GROK_API_KEY not configured");

  const response = await fetch("https://api.x.ai/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${grokApiKey}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: "grok-4.1-fast",  // Cost-effective: $0.20/$0.50 per M tokens
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      max_tokens: 500,
      temperature: 0.5, // Slightly creative for conversational tone
    }),
  });

  if (!response.ok) {
    throw new Error(`Grok API error: ${response.status}`);
  }

  const data = await response.json();
  const inputTokens = data.usage?.prompt_tokens || 0;
  const outputTokens = data.usage?.completion_tokens || 0;
  // Grok 4.1-fast pricing: $0.20 input, $0.50 output per M tokens
  const cost = (inputTokens * 0.20 + outputTokens * 0.50) / 1_000_000;

  return {
    content: data.choices?.[0]?.message?.content || "",
    tokens: inputTokens + outputTokens,
    cost,
  };
}
```

**4. Prompt builder function:**
```typescript
function buildSummaryPrompt(stats: LeadStats, hotLeads: Lead[], config: BrainConfig): string {
  const metrics = config.summary.includeMetrics;

  let prompt = `Generate a conversational summary of today's lead activity.\n\nData:\n`;

  if (metrics.newLeads) {
    prompt += `- New leads today: ${stats.newToday}\n`;
    prompt += `- Total leads: ${stats.total}\n`;
  }

  prompt += `- By temperature: ${stats.byTemperature.hot} hot, ${stats.byTemperature.warm} warm, ${stats.byTemperature.cold} cold\n`;

  if (hotLeads.length > 0) {
    const names = hotLeads.map(l => l.name || 'Unknown').join(', ');
    prompt += `- Hot leads: ${names}\n`;
  }

  if (metrics.responseTimes) {
    prompt += `- Avg lead score: ${stats.avgScore}\n`;
  }

  prompt += `\nGenerate a friendly, conversational summary following the tone guidelines.`;

  return prompt;
}
```

**5. internalAction: generateDailySummary** (for cron)
- Args: none (processes all workspaces)
- Steps:
  1. Query all workspaces with brainConfig.summary.enabled = true
  2. For each workspace, call generateSummaryForWorkspace
  3. Log results
  </action>
  <verify>Run `npx convex dev` - file compiles without TypeScript errors</verify>
  <done>brainAnalysis.ts exports generateSummaryForWorkspace and generateDailySummary actions</done>
</task>

<task type="auto">
  <name>Task 2: Add daily summary cron job</name>
  <files>convex/crons.ts</files>
  <action>
Update convex/crons.ts to add daily Brain summary job:

1. Import the internal API for brainAnalysis

2. Add new cron job after existing background-sync job:
```typescript
// Run Brain daily summary at 09:00 WIB (01:00 UTC)
// Configured time can override this in brainConfig.summary.time
crons.daily(
  "brain-daily-summary",
  { hourUTC: 1, minuteUTC: 0 }, // 09:00 WIB (Indonesia Western Time)
  internal.brainAnalysis.generateDailySummary
);
```

Note: The cron runs at fixed time. Per-workspace custom times would require more complex scheduling (defer to future enhancement).

3. Add action cleanup cron (runs every 6 hours):
```typescript
// Clean up expired action recommendations every 6 hours
crons.interval(
  "brain-action-cleanup",
  { hours: 6 },
  internal.brainActions.cleanupExpiredActions
);
```
  </action>
  <verify>Run `npx convex dev` - crons.ts compiles and cron jobs are registered</verify>
  <done>Crons.ts includes brain-daily-summary (daily at 01:00 UTC) and brain-action-cleanup (every 6h)</done>
</task>

<task type="auto">
  <name>Task 3: Add internal query for workspace iteration</name>
  <files>convex/brainAnalysis.ts</files>
  <action>
Add helper queries to brainAnalysis.ts:

**1. internalQuery: getWorkspacesWithBrainEnabled**
- Query all workspaces
- For each, check if brainConfig exists and summary.enabled = true
- Return list of workspace IDs with Brain enabled

```typescript
export const getWorkspacesWithBrainEnabled = internalQuery({
  handler: async (ctx) => {
    const workspaces = await ctx.db.query("workspaces").collect();
    const enabled: string[] = [];

    for (const ws of workspaces) {
      const config = await ctx.db
        .query("brainConfig")
        .withIndex("by_workspace", (q) => q.eq("workspace_id", ws._id))
        .first();

      if (config?.summary?.enabled) {
        enabled.push(ws._id);
      }
    }

    return enabled;
  },
});
```

**2. Update generateDailySummary to use this query:**
```typescript
export const generateDailySummary = internalAction({
  handler: async (ctx) => {
    const workspaceIds = await ctx.runQuery(internal.brainAnalysis.getWorkspacesWithBrainEnabled);

    console.log(`[Brain] Running daily summary for ${workspaceIds.length} workspaces`);

    const results = [];
    for (const wsId of workspaceIds) {
      try {
        const result = await generateSummaryForWorkspaceInternal(ctx, wsId, 'cron');
        results.push({ workspace: wsId, ...result });
      } catch (error) {
        console.error(`[Brain] Summary failed for ${wsId}:`, error);
        results.push({ workspace: wsId, error: String(error) });
      }
    }

    return { processed: results.length, results };
  },
});
```

Note: generateSummaryForWorkspaceInternal is a helper function (not exported) that contains the core logic.
  </action>
  <verify>Run `npx convex dev` - all functions compile and cron can call generateDailySummary</verify>
  <done>Daily summary iterates through all Brain-enabled workspaces and generates summaries</done>
</task>

</tasks>

<verification>
1. Run `npx convex dev` - all files compile
2. Check Convex dashboard - cron jobs visible in Functions tab
3. Verify GROK_API_KEY is set in Convex environment variables
4. Optional: Manually trigger generateSummaryForWorkspace from Convex dashboard to test
</verification>

<success_criteria>
- brainAnalysis.ts compiles with Grok 4.1-fast API integration
- Daily cron job registered at 01:00 UTC (09:00 WIB)
- Summary generation reads brainConfig and respects enabled flag
- Summaries stored in brainSummaries table
- Cost tracking included ($0.20/$0.50 per M tokens)
</success_criteria>

<output>
After completion, create `.planning/phases/05-grok-manager-bot/05-02-SUMMARY.md`
</output>
