---
phase: 05-grok-manager-bot
plan: 05
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - convex/http.ts
  - convex/brainAnalysis.ts
autonomous: true

must_haves:
  truths:
    - "!summary command triggers Brain summary via HTTP endpoint"
    - "Summary is returned in WhatsApp-friendly format (<800 chars)"
    - "Kapso workflow can call the endpoint to get summary text"
  artifacts:
    - path: "convex/http.ts"
      provides: "HTTP endpoint for !summary command"
      contains: "/brain/summary"
    - path: "convex/brainAnalysis.ts"
      provides: "Summary generation for command trigger"
      exports: ["generateCommandSummary"]
  key_links:
    - from: "convex/http.ts"
      to: "convex/brainAnalysis.ts"
      via: "HTTP action calls summary generation"
      pattern: "brainAnalysis.generateCommandSummary"
---

<objective>
Implement !summary command handler as HTTP endpoint for Kapso workflow integration.

Purpose: Enable business owners to request instant summaries via WhatsApp by sending "!summary" command.

Output: HTTP endpoint that Kapso can call, returning WhatsApp-ready summary text.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-grok-manager-bot/05-CONTEXT.md
@.planning/phases/05-grok-manager-bot/05-RESEARCH.md
@convex/http.ts
@convex/sarah.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generateCommandSummary action for !summary</name>
  <files>convex/brainAnalysis.ts</files>
  <action>
Add a specialized summary generator for the !summary command:

**internalAction: generateCommandSummary**
```typescript
export const generateCommandSummary = internalAction({
  args: {
    workspaceId: v.id("workspaces"),
    triggeredBy: v.string(), // Phone number of who sent !summary
  },
  handler: async (ctx, args): Promise<{ success: boolean; summaryText: string; error?: string }> => {
    console.log(`[Brain] !summary command from ${args.triggeredBy}`);

    try {
      // 1. Get lead stats
      const stats = await ctx.runQuery(internal.leads.getLeadStats, {
        workspaceId: args.workspaceId,
      });

      // 2. Get hot leads for highlighting
      const hotLeads = await ctx.runQuery(internal.leads.getLeadsByStatus, {
        workspaceId: args.workspaceId,
        status: 'qualified',
        limit: 5,
      });

      // Filter to only hot temperature leads
      const hotOnes = hotLeads.filter((l: any) => l.leadTemperature === 'hot');

      // 3. Build concise prompt for WhatsApp
      const prompt = `Generate a SHORT WhatsApp summary (under 800 characters).

Today's data:
- New leads today: ${stats.newToday}
- Total leads: ${stats.total}
- Hot: ${stats.byTemperature.hot}, Warm: ${stats.byTemperature.warm}, Cold: ${stats.byTemperature.cold}
${hotOnes.length > 0 ? `- Hot leads: ${hotOnes.map((l: any) => l.name || 'Unknown').join(', ')}` : '- No hot leads today'}
- Avg score: ${stats.avgScore}

Respond conversationally, like: "Here's what happened today - you've got X hot ones!"
Keep it under 800 characters for WhatsApp.`;

      // 4. Call Grok for summary
      const result = await callGrokAPI(BRAIN_SUMMARY_SYSTEM_PROMPT, prompt);

      // 5. Ensure it's under 800 chars
      let summaryText = result.content.trim();
      if (summaryText.length > 800) {
        summaryText = summaryText.substring(0, 797) + '...';
      }

      // 6. Store the summary
      await ctx.runMutation(internal.brainSummaries.createSummary, {
        workspace_id: args.workspaceId,
        summary_text: summaryText,
        summary_type: 'manual',
        trigger: 'command',
        triggered_by: args.triggeredBy,
        metrics: {
          newLeadsCount: stats.newToday,
          hotLeadsCount: stats.byTemperature.hot,
          warmLeadsCount: stats.byTemperature.warm,
          coldLeadsCount: stats.byTemperature.cold,
          avgScore: stats.avgScore,
        },
        tokens_used: result.tokens,
        cost_usd: result.cost,
      });

      return { success: true, summaryText };

    } catch (error) {
      console.error("[Brain] !summary failed:", error);

      // Return fallback summary on error
      const fallback = "Sorry, I couldn't generate the summary right now. Please try again in a moment.";
      return { success: false, summaryText: fallback, error: String(error) };
    }
  },
});
```

Note: This function is designed for quick execution - it uses existing stats queries rather than regenerating everything. The daily cron does more comprehensive analysis.
  </action>
  <verify>Run `npx convex dev` - action compiles without errors</verify>
  <done>generateCommandSummary action creates WhatsApp-friendly summaries for !summary command</done>
</task>

<task type="auto">
  <name>Task 2: Add HTTP endpoint for Kapso !summary trigger</name>
  <files>convex/http.ts</files>
  <action>
Add HTTP endpoints to convex/http.ts for Brain summary:

**1. Add import for brain analysis:**
```typescript
// At top with other imports
import { internal } from "./_generated/api";
```

**2. Add GET endpoint for summary retrieval (Kapso Function node):**
```typescript
// ============================================
// Brain Summary: !summary command handler
// ============================================

/**
 * POST /brain/summary - Generate summary for !summary command
 *
 * Called by Kapso when user sends "!summary" command.
 * Returns WhatsApp-ready summary text (<800 chars).
 *
 * Body:
 *   - workspace_id: The workspace ID (required)
 *   - triggered_by: Phone number of requester (required)
 */
http.route({
  path: "/brain/summary",
  method: "POST",
  handler: httpAction(async (ctx, request) => {
    const startTime = Date.now();

    try {
      const body = await request.json();
      const { workspace_id, triggered_by } = body;

      // Validate required fields
      if (!workspace_id) {
        return new Response(
          JSON.stringify({ error: "workspace_id is required" }),
          { status: 400, headers: { "Content-Type": "application/json" } }
        );
      }

      if (!triggered_by) {
        return new Response(
          JSON.stringify({ error: "triggered_by is required" }),
          { status: 400, headers: { "Content-Type": "application/json" } }
        );
      }

      console.log(`[Brain HTTP] !summary request from ${triggered_by}`);

      // Generate summary via internal action
      const result = await ctx.runAction(internal.brainAnalysis.generateCommandSummary, {
        workspaceId: workspace_id,
        triggeredBy: triggered_by,
      });

      const duration = Date.now() - startTime;
      console.log(`[Brain HTTP] Summary generated in ${duration}ms`);

      return new Response(
        JSON.stringify({
          success: result.success,
          summary_text: result.summaryText,
          error: result.error,
        }),
        { status: 200, headers: { "Content-Type": "application/json" } }
      );

    } catch (error) {
      const duration = Date.now() - startTime;
      console.error(`[Brain HTTP] Error after ${duration}ms:`, error);

      return new Response(
        JSON.stringify({
          success: false,
          summary_text: "Sorry, I couldn't generate the summary. Please try again.",
          error: String(error),
        }),
        { status: 500, headers: { "Content-Type": "application/json" } }
      );
    }
  }),
});
```

**3. Add GET endpoint for retrieving latest summary:**
```typescript
/**
 * GET /brain/summary - Get latest summary for workspace
 *
 * Query params:
 *   - workspace_id: The workspace ID (required)
 */
http.route({
  path: "/brain/summary",
  method: "GET",
  handler: httpAction(async (ctx, request) => {
    const url = new URL(request.url);
    const workspace_id = url.searchParams.get("workspace_id");

    if (!workspace_id) {
      return new Response(
        JSON.stringify({ error: "workspace_id is required" }),
        { status: 400, headers: { "Content-Type": "application/json" } }
      );
    }

    const summary = await ctx.runQuery(internal.brainSummaries.getLatestSummary, {
      workspaceId: workspace_id as any, // Cast for ID type
    });

    if (!summary) {
      return new Response(
        JSON.stringify({ summary: null, message: "No summary available" }),
        { status: 200, headers: { "Content-Type": "application/json" } }
      );
    }

    return new Response(
      JSON.stringify({ summary }),
      { status: 200, headers: { "Content-Type": "application/json" } }
    );
  }),
});
```
  </action>
  <verify>Run `npx convex dev` - HTTP routes register without errors</verify>
  <done>HTTP endpoints /brain/summary (GET and POST) available for Kapso integration</done>
</task>

<task type="auto">
  <name>Task 3: Document Kapso workflow integration</name>
  <files>convex/brainAnalysis.ts</files>
  <action>
Add documentation comment at top of brainAnalysis.ts explaining Kapso integration:

```typescript
/**
 * Brain Analysis Module - Grok-powered lead intelligence
 *
 * This module provides AI-powered analytics for leads:
 * - Daily summaries (via cron)
 * - !summary command (via HTTP endpoint)
 * - Action recommendations (follow-ups, handoffs, opportunities)
 * - Pattern analysis (topics, objections, rejections)
 *
 * === KAPSO INTEGRATION ===
 *
 * The !summary command is triggered via Kapso workflow:
 *
 * 1. User sends "!summary" to WhatsApp
 * 2. Kapso Rules Engine detects keyword
 * 3. Kapso Function Node calls POST /brain/summary with:
 *    {
 *      "workspace_id": "{{workspace.id}}",
 *      "triggered_by": "{{contact.phone}}"
 *    }
 * 4. Convex generates summary using Grok 4.1-fast
 * 5. Returns { "success": true, "summary_text": "..." }
 * 6. Kapso Send Message Node sends summary_text to user
 *
 * Kapso Workflow Node Configuration:
 * - Node Type: Function
 * - URL: https://YOUR_CONVEX_URL/brain/summary
 * - Method: POST
 * - Headers: { "Content-Type": "application/json" }
 * - Body: { "workspace_id": "...", "triggered_by": "{{contact.phone}}" }
 *
 * === COST TRACKING ===
 *
 * Uses Grok 4.1-fast: $0.20 input / $0.50 output per million tokens
 * Typical summary: ~500 input tokens, ~200 output tokens = ~$0.0002 per summary
 *
 * Token usage is logged to brainSummaries.tokens_used and brainSummaries.cost_usd
 */
```

Also add a note about the workspace_id resolution in real deployment:
```typescript
// NOTE: In production, workspace_id resolution would come from Kapso config.
// The Kapso Function node should be configured with the workspace_id.
// Alternative: Look up workspace by phone_config_id from the Kapso context.
```
  </action>
  <verify>Documentation is clear and actionable for Kapso setup</verify>
  <done>Kapso integration documented with node configuration details</done>
</task>

</tasks>

<verification>
1. Run `npx convex dev` - all code compiles
2. Test POST /brain/summary endpoint via curl:
   ```bash
   curl -X POST https://YOUR_CONVEX_URL/brain/summary \
     -H "Content-Type: application/json" \
     -d '{"workspace_id": "...", "triggered_by": "+62xxx"}'
   ```
3. Verify response contains summary_text under 800 characters
4. Check brainSummaries table for stored record with trigger='command'
</verification>

<success_criteria>
- HTTP endpoint /brain/summary (POST) accepts workspace_id and triggered_by
- Returns WhatsApp-friendly summary (<800 chars)
- Stores summary in brainSummaries with summary_type='manual', trigger='command'
- Error handling returns graceful fallback message
- GET endpoint returns latest summary for dashboard display
- Documentation explains Kapso workflow configuration
</success_criteria>

<output>
After completion, create `.planning/phases/05-grok-manager-bot/05-05-SUMMARY.md`
</output>
