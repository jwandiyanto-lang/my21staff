---
phase: 05-grok-manager-bot
plan: 06
type: execute
wave: 3
depends_on: ["05-02", "05-03", "05-04"]
files_modified:
  - .planning/phases/05-grok-manager-bot/kapso-brain-workflow.json
autonomous: false

must_haves:
  truths:
    - "Kapso workflow triggers Brain summary on !summary command"
    - "Workflow calls Convex HTTP endpoint for summary generation"
    - "Response is sent to user via WhatsApp"
  artifacts:
    - path: ".planning/phases/05-grok-manager-bot/kapso-brain-workflow.json"
      provides: "Kapso workflow configuration for !summary"
      contains: "brain/summary"
  key_links:
    - from: "Kapso workflow"
      to: "convex/http.ts"
      via: "Function node HTTP call"
      pattern: "/brain/summary"
---

<objective>
Configure Kapso workflow to handle !summary command by calling Brain HTTP endpoint.

Purpose: Connect WhatsApp command to Brain summary generation, completing the end-to-end flow.

Output: Kapso workflow updated with !summary keyword trigger and Function node calling Convex.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-grok-manager-bot/05-CONTEXT.md
@.planning/phases/03-sarah-chat-bot/rules-engine-with-sarah.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document Kapso workflow update for !summary</name>
  <files>.planning/phases/05-grok-manager-bot/kapso-brain-workflow.json</files>
  <action>
Create a JSON document that describes the Kapso workflow changes needed:

```json
{
  "workflow_update": {
    "name": "Rules Engine - Keyword Triggers (with Sarah and Brain)",
    "workflow_id": "6cae069e-7d5c-4fbb-834d-79e1f66e4672",
    "description": "Updates to existing Rules Engine workflow to add Brain !summary handler"
  },

  "changes": [
    {
      "type": "update_ai_decide",
      "node": "AI Decide",
      "change": "Add 'brain_summary' as new classification option",
      "keywords": ["!summary", "!Summary", "SUMMARY", "ringkasan", "report"],
      "note": "AI should route exact match '!summary' to brain_summary path"
    },
    {
      "type": "add_branch",
      "name": "brain_summary",
      "description": "Path for !summary command handling"
    },
    {
      "type": "add_function_node",
      "name": "Generate Brain Summary",
      "path": "brain_summary",
      "config": {
        "function_type": "http_request",
        "url": "https://YOUR_CONVEX_SITE_URL/brain/summary",
        "method": "POST",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "workspace_id": "WORKSPACE_ID_HERE",
          "triggered_by": "{{contact.phone}}"
        }
      },
      "output_variable": "brain_response"
    },
    {
      "type": "add_send_message",
      "name": "Send Brain Summary",
      "path": "brain_summary",
      "after": "Generate Brain Summary",
      "config": {
        "message_template": "{{brain_response.summary_text}}",
        "fallback": "Sorry, I couldn't generate the summary right now. Please try again."
      }
    }
  ],

  "environment_variables": {
    "CONVEX_SITE_URL": "Required - Your Convex deployment URL (e.g., https://xxx.convex.site)",
    "WORKSPACE_ID": "Required - The my21staff workspace ID from Convex"
  },

  "testing": {
    "test_message": "!summary",
    "expected_flow": [
      "1. User sends '!summary' to WhatsApp",
      "2. AI Decide classifies as 'brain_summary'",
      "3. Function node calls POST /brain/summary",
      "4. Convex generates summary via Grok",
      "5. Send Message node sends summary to user"
    ],
    "expected_response": "Conversational summary under 800 characters"
  },

  "notes": [
    "The existing Rules Engine workflow already handles keyword triggers",
    "Adding brain_summary as a new classification alongside: handoff, manager, faq_pricing, faq_services, ai_fallback",
    "Function node uses Cloudflare Worker pattern similar to fetch-intern-settings",
    "Workspace ID must be hardcoded until multi-tenant Kapso support is added"
  ]
}
```
  </action>
  <verify>JSON is valid and contains all required configuration details</verify>
  <done>Kapso workflow update documented with exact node configurations</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Brain summary generation system with:
1. Convex HTTP endpoint /brain/summary (POST)
2. Grok 4.1-fast integration for conversational summaries
3. Daily cron job for automatic summaries
4. Kapso workflow configuration document
  </what-built>
  <how-to-verify>
**Step 1: Verify Convex endpoints**
1. Check Convex dashboard for deployed functions:
   - brainAnalysis.generateCommandSummary
   - brainAnalysis.generateDailySummary
2. Check HTTP routes include /brain/summary

**Step 2: Test summary generation (if workspace has data)**
Run from Convex dashboard:
```
brainAnalysis.generateSummaryForWorkspace({
  workspaceId: "YOUR_WORKSPACE_ID",
  trigger: "api",
  triggeredBy: "test"
})
```

**Step 3: Test HTTP endpoint**
```bash
curl -X POST https://YOUR_CONVEX_URL/brain/summary \
  -H "Content-Type: application/json" \
  -d '{"workspace_id": "YOUR_WORKSPACE_ID", "triggered_by": "+62123456"}'
```
Expected: JSON response with summary_text

**Step 4: Apply Kapso workflow changes**
Using Kapso dashboard or API:
1. Open workflow "Rules Engine - Keyword Triggers"
2. Add "brain_summary" classification to AI Decide node
3. Add Function node calling /brain/summary endpoint
4. Add Send Message node with {{brain_response.summary_text}}
5. Test by sending "!summary" to WhatsApp

**Step 5: Verify end-to-end**
1. Send "!summary" to WhatsApp number +62 813-1859-025
2. Should receive conversational summary within 5-10 seconds
  </how-to-verify>
  <resume-signal>Type "approved" if Brain summary works end-to-end, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Convex functions deployed and accessible
2. HTTP endpoint returns valid summary response
3. Kapso workflow updated with brain_summary path
4. !summary command triggers full flow: WhatsApp -> Kapso -> Convex -> Grok -> WhatsApp
</verification>

<success_criteria>
- !summary command in WhatsApp triggers Brain summary
- Summary generated by Grok 4.1-fast in conversational tone
- Response under 800 characters (WhatsApp friendly)
- Summary stored in brainSummaries table for dashboard
- End-to-end flow works within 10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/05-grok-manager-bot/05-06-SUMMARY.md`
</output>
