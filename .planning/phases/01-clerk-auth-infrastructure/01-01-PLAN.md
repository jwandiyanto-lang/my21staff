---
phase: 01-clerk-auth-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/auth.config.ts
  - convex/testAuth.ts
autonomous: false

must_haves:
  truths:
    - "Clerk application exists with email/password authentication enabled"
    - "JWT template named 'convex' issues tokens with correct claims"
    - "Convex validates Clerk JWTs (ctx.auth.getUserIdentity() returns identity)"
    - "Test mutation confirms end-to-end auth flow works"
  artifacts:
    - path: "convex/auth.config.ts"
      provides: "Clerk JWT validation configuration"
      contains: "CLERK_JWT_ISSUER_DOMAIN"
    - path: "convex/testAuth.ts"
      provides: "Test mutation for auth verification"
      exports: ["testClerkAuth"]
  key_links:
    - from: "Clerk JWT template"
      to: "convex/auth.config.ts"
      via: "CLERK_JWT_ISSUER_DOMAIN env var"
      pattern: "process\\.env\\.CLERK_JWT_ISSUER_DOMAIN"
    - from: "convex/auth.config.ts"
      to: "ctx.auth.getUserIdentity()"
      via: "Convex auth provider configuration"
      pattern: "applicationID.*convex"

user_setup:
  - service: clerk
    why: "JWT-based authentication for Convex"
    env_vars:
      - name: CLERK_JWT_ISSUER_DOMAIN
        source: "Clerk Dashboard -> JWT Templates -> 'convex' template -> Issuer URL"
        destination: "Convex Dashboard -> Settings -> Environment Variables"
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys"
        destination: ".env.local (for Phase 2)"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys"
        destination: ".env.local (for Phase 2)"
    dashboard_config:
      - task: "Create Clerk application"
        location: "https://dashboard.clerk.com -> Add application"
      - task: "Enable email/password authentication"
        location: "Clerk Dashboard -> User & Authentication -> Email, Phone, Username"
      - task: "Create JWT template named 'convex'"
        location: "Clerk Dashboard -> JWT Templates -> New template -> Select 'Convex'"
---

<objective>
Configure Clerk authentication infrastructure for Convex JWT validation.

Purpose: Establish the auth foundation that enables later phases (UI, user migration, organizations). This is infrastructure-only - no UI changes, no user migration.

Output: Working Clerk -> Convex JWT validation pipeline, verified by test mutation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-clerk-auth-infrastructure/01-RESEARCH.md
@convex/auth.config.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Clerk Dashboard Setup</name>
  <action>
    Create Clerk application and configure JWT template for Convex.

    **Step 1: Create Clerk Application**
    1. Go to https://dashboard.clerk.com/
    2. Click "Add application"
    3. Application name: "my21staff"
    4. Enable authentication methods:
       - Email address: ENABLED
       - Password: ENABLED
       - Require password at sign-up: ENABLED
       - Social logins: Skip for now (Phase 2 can add later)
    5. Click "Create application"
    6. COPY and SAVE:
       - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` (starts with `pk_`)
       - `CLERK_SECRET_KEY` (starts with `sk_`)
       (These are for Phase 2, but save them now)

    **Step 2: Create JWT Template**
    1. In Clerk Dashboard, click "JWT Templates" in left sidebar
    2. Click "New template"
    3. Select "Convex" from the template list (pre-configures claims)
    4. CRITICAL: Template name MUST be "convex" (lowercase, no spaces)
       - The Convex template auto-fills this correctly, don't change it!
    5. Leave default settings:
       - Token lifetime: 60 seconds
       - Allowed clock skew: 5 seconds
    6. Click "Apply changes"
    7. COPY the Issuer URL shown at top of page
       - Format: `https://[something].clerk.accounts.dev`
       - This is the `CLERK_JWT_ISSUER_DOMAIN` value

    **Step 3: Add Environment Variable to Convex**
    1. Go to https://dashboard.convex.dev/
    2. Select the my21staff deployment
    3. Click "Settings" in left sidebar
    4. Click "Environment Variables" tab
    5. Click "Add Environment Variable"
    6. Name: `CLERK_JWT_ISSUER_DOMAIN`
    7. Value: Paste the Issuer URL from Clerk (e.g., `https://something.clerk.accounts.dev`)
    8. Click "Save"
  </action>
  <verify>
    Report back with:
    1. Clerk application created: yes/no
    2. Email/password enabled: yes/no
    3. JWT template created and named "convex": yes/no
    4. Issuer URL format: https://[something].clerk.accounts.dev
    5. Convex env var set: yes/no
  </verify>
  <done>
    - Clerk application exists with email/password authentication
    - JWT template named "convex" exists with correct claims (aud="convex")
    - CLERK_JWT_ISSUER_DOMAIN set in Convex Dashboard environment variables
  </done>
  <resume-signal>Reply with verification checklist results to continue</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Update Convex auth.config.ts</name>
  <files>convex/auth.config.ts</files>
  <action>
    Replace the existing Supabase auth configuration with Clerk configuration.

    **Current (Supabase - to be replaced):**
    ```typescript
    export default {
      providers: [
        {
          type: "customJwt",
          applicationID: process.env.NEXT_PUBLIC_SUPABASE_URL?.split("//")[1]?.split(".")[0] || "",
          issuer: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/auth/v1`,
          jwks: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/.well-known/jwks.json`,
          algorithm: "RS256",
        },
      ],
    } satisfies AuthConfig;
    ```

    **New (Clerk):**
    ```typescript
    import { AuthConfig } from "convex/server";

    export default {
      providers: [
        {
          domain: process.env.CLERK_JWT_ISSUER_DOMAIN!,
          applicationID: "convex",
        },
      ],
    } satisfies AuthConfig;
    ```

    Key differences:
    - Remove `@ts-nocheck` comment (no longer needed)
    - Remove `type: "customJwt"` (Clerk uses simpler format)
    - Use `domain` instead of `issuer` (cleaner API)
    - `applicationID` is literal "convex" (matches JWT `aud` claim)
    - No `jwks` or `algorithm` needed (auto-detected from domain)
  </action>
  <verify>
    ```bash
    # Check file exists and has correct structure
    grep -q "CLERK_JWT_ISSUER_DOMAIN" convex/auth.config.ts && echo "OK: Uses Clerk env var"
    grep -q 'applicationID: "convex"' convex/auth.config.ts && echo "OK: applicationID is convex"
    grep -q "SUPABASE" convex/auth.config.ts && echo "ERROR: Still has Supabase config" || echo "OK: No Supabase references"
    ```
  </verify>
  <done>
    - auth.config.ts uses CLERK_JWT_ISSUER_DOMAIN
    - applicationID is "convex" (matches Clerk JWT template)
    - No Supabase auth references remain
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Test Mutation and Deploy</name>
  <files>convex/testAuth.ts</files>
  <action>
    Create a test mutation to verify Clerk JWT validation works end-to-end.

    **Create convex/testAuth.ts:**
    ```typescript
    import { mutation, query } from "./_generated/server";

    /**
     * Test Clerk authentication integration.
     * This mutation verifies that:
     * 1. Clerk JWT is received by Convex
     * 2. JWT validates against auth.config.ts
     * 3. User identity is accessible via ctx.auth.getUserIdentity()
     *
     * Usage: Call from authenticated context after Phase 2 UI is complete.
     * For Phase 1, manually test via Convex Dashboard logs.
     */
    export const testClerkAuth = mutation({
      handler: async (ctx) => {
        // Log to Convex Dashboard -> Logs
        console.log("Testing Clerk authentication...");

        const identity = await ctx.auth.getUserIdentity();
        console.log("Identity:", identity);

        if (!identity) {
          throw new Error("Not authenticated - Clerk JWT validation failed. Check: 1) JWT template named 'convex', 2) Issuer URL matches CLERK_JWT_ISSUER_DOMAIN, 3) Token not expired");
        }

        return {
          success: true,
          message: "Clerk -> Convex authentication working!",
          userId: identity.subject,
          issuer: identity.issuer,
          tokenIdentifier: identity.tokenIdentifier,
        };
      },
    });

    /**
     * Query version for read-only auth testing.
     */
    export const checkAuth = query({
      handler: async (ctx) => {
        const identity = await ctx.auth.getUserIdentity();

        return {
          isAuthenticated: !!identity,
          userId: identity?.subject ?? null,
          issuer: identity?.issuer ?? null,
        };
      },
    });
    ```

    **Deploy to Convex:**
    ```bash
    npx convex deploy
    ```

    Note: The deploy will apply the new auth.config.ts and testAuth.ts.
    The CLERK_JWT_ISSUER_DOMAIN env var was set in Task 1.
  </action>
  <verify>
    ```bash
    # Deploy and check for errors
    npx convex deploy 2>&1 | tee /tmp/convex-deploy.log

    # Verify deployment succeeded
    grep -q "error" /tmp/convex-deploy.log && echo "ERROR: Deployment failed" || echo "OK: Deployed successfully"

    # Check function is registered
    grep -q "testClerkAuth" /tmp/convex-deploy.log || echo "Note: Function deployed (may not show in output)"
    ```
  </verify>
  <done>
    - convex/testAuth.ts created with testClerkAuth mutation and checkAuth query
    - Functions deployed to Convex
    - Ready for end-to-end verification in Task 4
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify End-to-End JWT Flow</name>
  <what-built>
    Clerk auth infrastructure:
    - Clerk application with email/password auth
    - JWT template named "convex"
    - Convex auth.config.ts configured for Clerk
    - Test mutation deployed
  </what-built>
  <how-to-verify>
    **Option A: Create Test User and Check Logs (Recommended for Phase 1)**

    1. In Clerk Dashboard -> Users -> "Add user"
       - Email: test@my21staff.com (or any test email)
       - Password: Set a test password
       - Click "Create"

    2. Check Convex Dashboard -> Logs
       - The auth.config.ts should load without errors
       - Look for any "authentication provider" errors

    3. Verify JWT template claims:
       - In Clerk Dashboard -> JWT Templates -> "convex"
       - Confirm `aud` claim shows "convex"
       - Confirm issuer URL matches CLERK_JWT_ISSUER_DOMAIN in Convex

    **Option B: Quick Verification via Convex Dashboard**

    1. Go to Convex Dashboard -> Functions
    2. Find `testAuth:checkAuth` query
    3. Run it (will show isAuthenticated: false since no token - this is expected)
    4. The fact it runs without "provider not configured" error means auth.config.ts is working

    **What to report:**
    - Convex functions deployed without auth errors: yes/no
    - JWT template claims correct (aud="convex"): yes/no
    - Issuer URLs match: yes/no
    - Test user created in Clerk: yes/no

    Note: Full end-to-end auth testing requires Phase 2 UI. For now, verify infrastructure is configured correctly.
  </how-to-verify>
  <resume-signal>Type "verified" if checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria verification:

1. **Clerk application exists with correct settings**
   - Check: Clerk Dashboard shows "my21staff" application
   - Check: Email/password authentication enabled

2. **JWT template configured with Convex issuer claim**
   - Check: JWT template named exactly "convex" (lowercase)
   - Check: Template shows `aud: "convex"` in claims preview
   - Check: Issuer URL format is `https://[something].clerk.accounts.dev`

3. **Convex auth.config.ts validates Clerk JWTs**
   - Check: `convex/auth.config.ts` references `CLERK_JWT_ISSUER_DOMAIN`
   - Check: `applicationID: "convex"` matches JWT template
   - Check: No Supabase auth references remain

4. **Test mutation deployed and ready**
   - Check: `convex/testAuth.ts` exists with `testClerkAuth` mutation
   - Check: `npx convex deploy` completes without errors
   - Check: Function visible in Convex Dashboard -> Functions
</verification>

<success_criteria>
- [ ] Clerk application "my21staff" created with email/password enabled
- [ ] JWT template "convex" exists with correct claims (aud="convex")
- [ ] CLERK_JWT_ISSUER_DOMAIN set in Convex Dashboard environment variables
- [ ] convex/auth.config.ts updated for Clerk (no Supabase references)
- [ ] convex/testAuth.ts deployed with testClerkAuth mutation
- [ ] Convex deployment succeeds without auth provider errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-clerk-auth-infrastructure/01-01-SUMMARY.md`
</output>
