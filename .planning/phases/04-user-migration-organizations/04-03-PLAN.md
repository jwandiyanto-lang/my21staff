---
phase: 04-user-migration-organizations
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - scripts/update-convex-user-ids.ts
  - convex/schema.ts
  - convex/migrate.ts
autonomous: true

must_haves:
  truths:
    - "All user_id fields updated to Clerk IDs"
    - "All owner_id fields updated to Clerk IDs"
    - "No Supabase UUIDs remain in user reference fields"
  artifacts:
    - path: "scripts/update-convex-user-ids.ts"
      provides: "Batch update script for Convex user ID migration"
      min_lines: 100
    - path: "convex/migrate.ts"
      provides: "Migration mutations for user ID updates"
      exports: ["updateUserIds", "updateOwnerIds"]
  key_links:
    - from: "scripts/update-convex-user-ids.ts"
      to: ".planning/migrations/user-id-mapping.json"
      via: "JSON file read"
      pattern: "user-id-mapping\\.json"
    - from: "scripts/update-convex-user-ids.ts"
      to: "convex/migrate.ts"
      via: "Convex mutations"
      pattern: "api\\.migrate\\.updateUserIds"
---

<objective>
Update all Convex tables to use Clerk user IDs instead of Supabase UUIDs.

Purpose: Complete the user ID migration so app queries use Clerk IDs consistently
Output: All user references in Convex tables point to Clerk IDs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-migration-organizations/04-01-SUMMARY.md
@.planning/phases/04-user-migration-organizations/04-02-SUMMARY.md
@convex/schema.ts
@convex/migrate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user ID update mutations to Convex</name>
  <files>convex/migrate.ts</files>
  <action>
Extend the existing migrate.ts with new mutations for updating user IDs:

```typescript
/**
 * Update user IDs in workspaces table.
 * Changes owner_id from Supabase UUID to Clerk ID.
 */
export const updateWorkspaceOwnerIds = mutation({
  args: {
    updates: v.array(v.object({
      workspaceId: v.id("workspaces"),
      newOwnerId: v.string(), // Clerk ID
    })),
  },
  handler: async (ctx, args) => {
    for (const update of args.updates) {
      await ctx.db.patch(update.workspaceId, {
        owner_id: update.newOwnerId,
        updated_at: Date.now(),
      });
    }
    return { updated: args.updates.length };
  },
});

/**
 * Update user IDs in workspaceMembers table.
 */
export const updateWorkspaceMemberUserIds = mutation({
  args: {
    updates: v.array(v.object({
      memberId: v.id("workspaceMembers"),
      newUserId: v.string(), // Clerk ID
    })),
  },
  handler: async (ctx, args) => {
    for (const update of args.updates) {
      await ctx.db.patch(update.memberId, {
        user_id: update.newUserId,
      });
    }
    return { updated: args.updates.length };
  },
});
```

Add similar mutations for:
- contacts.assigned_to
- conversations.assigned_to
- messages.sender_id
- contactNotes.user_id
- tickets.requester_id, tickets.assigned_to
- ticketComments.author_id
- ticketStatusHistory.changed_by

Each mutation takes batch of {recordId, newUserId} and patches the record.
  </action>
  <verify>
Run `npx convex dev` - no TypeScript errors, mutations appear in Convex dashboard
  </verify>
  <done>Migration mutations exist for all tables with user ID fields</done>
</task>

<task type="auto">
  <name>Task 2: Create user ID update script</name>
  <files>scripts/update-convex-user-ids.ts</files>
  <action>
Create a TypeScript script that:

1. **Load ID mappings:**
   - Read .planning/migrations/user-id-mapping.json
   - Build supabaseId -> clerkId lookup map

2. **For each table with user references, query and update:**

   ```typescript
   // Example for workspaces
   const workspaces = await convex.query(api.workspaces.list); // Need to add this query
   const updates = workspaces
     .filter(ws => idMap[ws.owner_id]) // Has mapping
     .map(ws => ({
       workspaceId: ws._id,
       newOwnerId: idMap[ws.owner_id],
     }));
   await convex.mutation(api.migrate.updateWorkspaceOwnerIds, { updates });
   ```

3. **Process tables in order:**
   - workspaces.owner_id
   - workspaceMembers.user_id
   - contacts.assigned_to (optional field)
   - conversations.assigned_to (optional field)
   - messages.sender_id (optional field)
   - contactNotes.user_id
   - tickets.requester_id, tickets.assigned_to
   - ticketComments.author_id
   - ticketStatusHistory.changed_by

4. **Handle missing mappings:**
   - Log warning for any Supabase UUID not in mapping
   - Continue processing (don't fail entire migration)

5. **Generate report:**
   - Output summary of records updated per table
   - Save to .planning/migrations/user-id-update-report.json

Script should support --dry-run to show what would be updated.
  </action>
  <verify>
Run `npx tsx scripts/update-convex-user-ids.ts --dry-run` shows update counts per table
  </verify>
  <done>Script exists and dry-run shows correct update counts</done>
</task>

<task type="auto">
  <name>Task 3: Run user ID update migration</name>
  <files>.planning/migrations/user-id-update-report.json</files>
  <action>
Execute the migration script:

```bash
npx tsx scripts/update-convex-user-ids.ts
```

Expected output:
- Records updated in each table
- Summary report generated
- Any warnings for unmapped IDs logged

After script completes, verify in Convex Dashboard:
- Query a workspace -> owner_id is Clerk ID format (user_xxx)
- Query a workspaceMember -> user_id is Clerk ID format
  </action>
  <verify>
1. Check .planning/migrations/user-id-update-report.json exists
2. Verify update counts match expected (no errors)
3. Spot-check Convex data: `npx convex run workspaces:list` shows Clerk IDs
  </verify>
  <done>All user references in Convex use Clerk IDs</done>
</task>

</tasks>

<verification>
1. No Supabase UUIDs remain in user_id/owner_id fields
2. Spot check confirms Clerk ID format (user_xxx)
3. Update report shows all tables processed
4. No warnings for unmapped IDs (all users migrated)
</verification>

<success_criteria>
- USER-04: User ID mapping preserves data relationships
- All Convex tables use Clerk IDs for user references
- Data integrity maintained (no orphaned references)
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-migration-organizations/04-03-SUMMARY.md`
</output>
