---
phase: 04-user-migration-organizations
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - scripts/migrate-workspaces-to-orgs.ts
  - convex/schema.ts
  - convex/organizations.ts
autonomous: false

must_haves:
  truths:
    - "All workspaces exist as Clerk organizations"
    - "Jonathan is owner of all organizations"
    - "Organization ID mapping exists for data migration"
  artifacts:
    - path: "scripts/migrate-workspaces-to-orgs.ts"
      provides: "Workspace to organization migration logic"
      min_lines: 60
    - path: "convex/organizations.ts"
      provides: "Organization sync mutations for Clerk webhooks"
      exports: ["createOrganization", "updateOrganization"]
  key_links:
    - from: "scripts/migrate-workspaces-to-orgs.ts"
      to: "Clerk Backend API"
      via: "clerk.organizations.createOrganization"
      pattern: "organizations\\.createOrganization"
    - from: "scripts/migrate-workspaces-to-orgs.ts"
      to: ".planning/migrations/user-id-mapping.json"
      via: "JSON file read"
      pattern: "user-id-mapping\\.json"
---

<objective>
Convert existing workspaces to Clerk organizations with proper ownership.

Purpose: Enable Clerk-native team management with organization invitations
Output: All workspaces exist as Clerk organizations with Jonathan as owner
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-migration-organizations/04-01-SUMMARY.md
@convex/schema.ts
@convex/workspaces.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace-to-organization migration script</name>
  <files>scripts/migrate-workspaces-to-orgs.ts</files>
  <action>
Create a TypeScript migration script that:

1. **Load user ID mapping:**
   - Read .planning/migrations/user-id-mapping.json
   - Build supabaseId -> clerkId lookup map

2. **Fetch workspaces from Convex:**
   - Use Convex Node.js client to query all workspaces
   - Extract: _id (Convex ID), name, slug, owner_id (Supabase UUID)

3. **Find Jonathan's Clerk ID:**
   - Jonathan's email: Look it up from user mapping
   - This user becomes owner of all organizations initially

4. **Create Clerk organizations:**
   - For each workspace, call POST /organizations with:
     - name: `${workspace.name} - my21staff` (standardized format from CONTEXT.md)
     - slug: workspace.slug
     - created_by: Jonathan's Clerk ID
     - public_metadata: { convexWorkspaceId: workspace._id, supabaseOwnerId: workspace.owner_id }
   - Add the original workspace owner as admin (if different from Jonathan)

5. **Generate mapping file:**
   - Output JSON: { convexWorkspaceId: clerkOrgId, ... }
   - Save to .planning/migrations/workspace-org-mapping.json

Script should be idempotent - skip orgs that already exist (check by slug).

Handle Clerk rate limiting (20 req/sec).
  </action>
  <verify>
Run `npx tsx scripts/migrate-workspaces-to-orgs.ts --dry-run` shows organizations that would be created.
  </verify>
  <done>Script exists and dry-run shows correct workspace list</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Review organization naming</name>
  <what-built>Migration script with organization names</what-built>
  <how-to-verify>
Review the dry-run output:

1. Run: `npx tsx scripts/migrate-workspaces-to-orgs.ts --dry-run`
2. Check organization names follow format: "[Business Name] - my21staff"
3. Confirm Jonathan will be set as owner of all organizations
4. Note any issues with naming or ownership

Expected workspaces:
- My21Staff workspace -> "My21Staff - my21staff" org
- Eagle Overseas workspace -> "Eagle Overseas - my21staff" org

Type "approved" to proceed with migration, or describe issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe naming issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Run organization migration</name>
  <files>.planning/migrations/workspace-org-mapping.json</files>
  <action>
Execute the migration script:

```bash
npx tsx scripts/migrate-workspaces-to-orgs.ts
```

Expected output:
- Organizations created in Clerk
- Jonathan added as owner of each
- Original workspace owners added as admins (if different from Jonathan)
- Mapping file generated at .planning/migrations/workspace-org-mapping.json

After script completes, verify in Clerk Dashboard:
- Organizations appear in Organizations list
- Click an org -> Members shows Jonathan as owner
  </action>
  <verify>
1. Check .planning/migrations/workspace-org-mapping.json exists
2. Run `cat .planning/migrations/workspace-org-mapping.json | jq '. | length'` to count orgs
3. Check Clerk Dashboard -> Organizations shows the migrated organizations
  </verify>
  <done>All workspaces exist as Clerk organizations with Jonathan as owner</done>
</task>

</tasks>

<verification>
1. All workspaces appear as organizations in Clerk Dashboard
2. Organization names follow "[Business Name] - my21staff" format
3. Jonathan is owner of all organizations
4. Mapping file exists at .planning/migrations/workspace-org-mapping.json
</verification>

<success_criteria>
- ORG-01: Clerk organizations created for existing workspaces
- Jonathan is owner of all organizations (can transfer later)
- Mapping file exists for subsequent data migration
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-migration-organizations/04-02-SUMMARY.md`
</output>
