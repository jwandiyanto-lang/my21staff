---
phase: 04-user-migration-organizations
plan: 05
type: execute
wave: 5
depends_on: ["04-04"]
files_modified:
  - src/app/(dashboard)/[workspace]/team/page.tsx
  - src/lib/queries/use-organization.ts
  - src/components/workspace/invite-modal.tsx
autonomous: false

must_haves:
  truths:
    - "Team page shows organization members from Clerk"
    - "Invite button opens Clerk organization invitation flow"
    - "Owner can manage team members via Clerk UI"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/team/page.tsx"
      provides: "Team management UI using Clerk organizations"
      min_lines: 50
    - path: "src/lib/queries/use-organization.ts"
      provides: "React Query hook for organization data"
      exports: ["useOrganization", "useOrganizationMembers"]
  key_links:
    - from: "src/app/(dashboard)/[workspace]/team/page.tsx"
      to: "@clerk/nextjs"
      via: "OrganizationProfile, useOrganization"
      pattern: "OrganizationProfile|useOrganization"
---

<objective>
Update team management UI to use Clerk organizations instead of custom invitation system.

Purpose: Complete the migration by connecting frontend to Clerk organization features
Output: Team page uses Clerk for invitations and member management
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-migration-organizations/04-04-SUMMARY.md
@src/app/(dashboard)/[workspace]/team/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization hook</name>
  <files>src/lib/queries/use-organization.ts</files>
  <action>
Create a React Query hook that fetches organization data:

```typescript
import { useOrganization, useOrganizationList } from "@clerk/nextjs";
import { useQuery } from "@tanstack/react-query";

/**
 * Hook to get current organization from Clerk.
 * Also queries Convex for workspace data.
 */
export function useCurrentOrganization() {
  const { organization, isLoaded } = useOrganization();

  return {
    organization,
    isLoaded,
    // Extract workspace ID from organization metadata
    workspaceId: organization?.publicMetadata?.convexWorkspaceId as string | undefined,
  };
}

/**
 * Hook to get organization members.
 * Returns list of members with their roles.
 */
export function useOrganizationMembers() {
  const { organization } = useOrganization();

  return useQuery({
    queryKey: ["organization-members", organization?.id],
    queryFn: async () => {
      if (!organization) return [];
      const members = await organization.getMemberships();
      return members.map(m => ({
        id: m.id,
        userId: m.publicUserData.userId,
        identifier: m.publicUserData.identifier,
        firstName: m.publicUserData.firstName,
        lastName: m.publicUserData.lastName,
        imageUrl: m.publicUserData.imageUrl,
        role: m.role,
        createdAt: m.createdAt,
      }));
    },
    enabled: !!organization,
  });
}
```

This wraps Clerk's organization hooks with TanStack Query for caching.
  </action>
  <verify>
TypeScript compiles without errors: `npm run build -- --filter=type-check`
  </verify>
  <done>Organization hooks exist and compile</done>
</task>

<task type="auto">
  <name>Task 2: Update team page to use Clerk OrganizationProfile</name>
  <files>src/app/(dashboard)/[workspace]/team/page.tsx</files>
  <action>
Replace custom team management with Clerk's OrganizationProfile component:

```tsx
import { OrganizationProfile } from "@clerk/nextjs";

export default function TeamPage() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold">Tim</h1>
      </div>

      <div className="rounded-lg border bg-card">
        <OrganizationProfile
          appearance={{
            elements: {
              rootBox: "w-full",
              card: "shadow-none border-0",
              navbar: "hidden", // Hide Clerk's navbar, we have our own
              pageScrollBox: "p-0",
            },
          }}
          // Only show members page, hide other tabs
          routing="hash"
        />
      </div>
    </div>
  );
}
```

The OrganizationProfile component provides:
- Member list with avatars
- Invite new members button
- Role management (admin/member)
- Remove members
- Pending invitations

Remove:
- Custom invitation modal (Clerk handles this)
- Custom member list fetching (Clerk provides this)
- Manual role management UI

Keep:
- Page layout and styling
- Any workspace-specific settings not in Clerk
  </action>
  <verify>
Run `npm run dev`, navigate to /[workspace]/team, see Clerk OrganizationProfile
  </verify>
  <done>Team page renders Clerk OrganizationProfile</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify team management flow</name>
  <what-built>Team page with Clerk organization management</what-built>
  <how-to-verify>
1. Go to http://localhost:3000/dashboard (or active workspace)
2. Navigate to Team page
3. Verify:
   - [ ] Member list shows current organization members
   - [ ] "Invite member" button works (opens Clerk modal)
   - [ ] Can change member roles (if you're owner)
   - [ ] Can remove members (if you're owner)
4. Test invitation flow:
   - Click "Invite member"
   - Enter a test email
   - Check Clerk Dashboard -> Organizations -> [Org] -> Invitations

Type "approved" if team management works, or describe issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Team page shows organization members
2. Invite button opens Clerk invitation modal
3. Role changes sync to Convex (via webhook)
4. Member removal syncs to Convex
</verification>

<success_criteria>
- ORG-02: Clerk organization invitations replace custom invitation system
- Team page functional with Clerk components
- Seamless user experience (no broken flows)
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-migration-organizations/04-05-SUMMARY.md`
</output>
