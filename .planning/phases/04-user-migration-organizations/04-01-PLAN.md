---
phase: 04-user-migration-organizations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-users-to-clerk.ts
  - convex/schema.ts
  - convex/users.ts
autonomous: false
user_setup:
  - service: clerk
    why: "User import requires Backend API access"
    env_vars:
      - name: CLERK_SECRET_KEY
        source: "Already configured from Phase 1"
    dashboard_config:
      - task: "Enable Organizations feature"
        location: "Clerk Dashboard -> Organizations -> Enable organizations"

must_haves:
  truths:
    - "All existing Supabase users exist in Clerk"
    - "Users have external_id set to Supabase UUID"
    - "ID mapping file exists for data migration"
  artifacts:
    - path: "scripts/migrate-users-to-clerk.ts"
      provides: "User export and Clerk import logic"
      min_lines: 80
    - path: "convex/users.ts"
      provides: "Extended user schema with supabase_id mapping"
      exports: ["createUser", "updateUser", "deleteUser", "getUserByClerkId"]
  key_links:
    - from: "scripts/migrate-users-to-clerk.ts"
      to: "Clerk Backend API"
      via: "clerk.users.createUser"
      pattern: "users\\.createUser"
    - from: "scripts/migrate-users-to-clerk.ts"
      to: "Supabase auth.users"
      via: "supabaseAdmin.auth.admin.listUsers"
      pattern: "auth\\.admin\\.listUsers"
---

<objective>
Migrate existing Supabase users to Clerk with ID mapping preserved.

Purpose: Enable existing users to continue using the app after Clerk migration
Output: All users exist in Clerk with external_id mapping to Supabase UUID
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-users-table-webhook/03-01-SUMMARY.md
@.planning/phases/03-users-table-webhook/03-02-SUMMARY.md
@convex/schema.ts
@convex/users.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user migration script</name>
  <files>scripts/migrate-users-to-clerk.ts</files>
  <action>
Create a TypeScript migration script that:

1. **Exports users from Supabase:**
   - Use Supabase admin client to list all users from auth.users
   - Also fetch profiles table for full_name
   - Extract: id (UUID), email, full_name, created_at

2. **Creates users in Clerk:**
   - Use Clerk Backend API (@clerk/clerk-sdk-node or direct fetch)
   - For each Supabase user, call POST /users with:
     - email_address: user.email
     - external_id: user.id (Supabase UUID - CRITICAL for mapping)
     - first_name/last_name: parsed from full_name
     - skip_password_require: true (users will use forgot password flow)
   - Handle rate limiting (Clerk has 20 req/sec limit)

3. **Generate mapping file:**
   - Output JSON mapping: { supabaseId: clerkId, ... }
   - Save to .planning/migrations/user-id-mapping.json
   - This will be used by subsequent plans to update Convex tables

4. **Super-admin setup:**
   - Jonathan's user (email: jonathan@...) gets a flag in public_metadata: { superAdmin: true }
   - This enables cross-org access for support/debugging

Script should be idempotent - skip users that already exist in Clerk (check by external_id).

Use dotenv to load CLERK_SECRET_KEY from .env.local.
  </action>
  <verify>
Run `npx tsx scripts/migrate-users-to-clerk.ts --dry-run` shows users that would be migrated without actually creating them.
  </verify>
  <done>Script exists and dry-run shows correct user list from Supabase</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Enable Clerk Organizations</name>
  <what-built>Migration script ready to import users</what-built>
  <action>
Before running migration, enable Organizations in Clerk Dashboard:

1. Go to Clerk Dashboard -> Organizations
2. Click "Enable organizations"
3. Configure organization settings:
   - Allow users to create organizations: No (admin-only)
   - Allow users to delete organizations: No
   - Max organizations per user: Leave default

This is required because Phase 04-02 will create organizations for workspaces.
  </action>
  <how-to-verify>
1. Go to Clerk Dashboard -> Organizations
2. Confirm "Organizations" feature is enabled
3. Type "done" when complete
  </how-to-verify>
  <resume-signal>Type "done" when Organizations feature is enabled</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Run user migration</name>
  <files>.planning/migrations/user-id-mapping.json</files>
  <action>
Execute the migration script for real:

```bash
npx tsx scripts/migrate-users-to-clerk.ts
```

Expected output:
- Users created in Clerk with external_id set
- Mapping file generated at .planning/migrations/user-id-mapping.json
- Any errors logged to console

If any users fail, script should continue and report failures at end.

After script completes, verify in Clerk Dashboard:
- All users appear in Users list
- Click a user -> external_id shows Supabase UUID
  </action>
  <verify>
1. Check .planning/migrations/user-id-mapping.json exists
2. Run `cat .planning/migrations/user-id-mapping.json | jq '. | length'` to count migrated users
3. Check Clerk Dashboard -> Users shows the migrated users
  </verify>
  <done>All Supabase users exist in Clerk with external_id mapping</done>
</task>

</tasks>

<verification>
1. All Supabase users appear in Clerk Dashboard
2. Each user has external_id = Supabase UUID
3. Mapping file exists at .planning/migrations/user-id-mapping.json
4. Jonathan's user has superAdmin: true in public_metadata
</verification>

<success_criteria>
- USER-03: Existing Supabase users imported to Clerk with password hashes (using skip_password_require flow)
- Mapping file exists for subsequent data migration
- Super-admin flag set for Jonathan's account
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-migration-organizations/04-01-SUMMARY.md`
</output>
