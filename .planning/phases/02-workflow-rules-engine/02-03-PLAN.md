# Plan 02-03: End-to-End Testing + Verification

---
phase: 02-workflow-rules-engine
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/lib/workflow/rules-engine.ts
  - .planning/phases/02-workflow-rules-engine/02-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "Keyword 'human' triggers handoff action in logs"
    - "Keyword '!summary' triggers manager_bot action in logs"
    - "FAQ keyword 'harga' matches pricing template"
    - "Regular messages pass through to AI processor"
    - "New vs returning lead detection works correctly"
  artifacts:
    - path: ".planning/phases/02-workflow-rules-engine/02-VERIFICATION.md"
      provides: "Test results documentation"
      contains: "Verified"
  key_links:
    - from: "src/app/api/webhook/kapso/route.ts"
      to: "convex/workflows.ts"
      via: "logExecution mutation"
      pattern: "workflows\\.logExecution"
---

<objective>
Verify the workflow rules engine works end-to-end via live WhatsApp testing.

Purpose: Confirm all rule types (keyword triggers, FAQ templates, lead routing) function correctly in production before moving to Phase 2.5 Settings UI.

Output:
- Live test results documented
- Verification of keyword trigger detection
- Confirmation of rules-first, AI-fallback flow
- Any bug fixes applied
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-workflow-rules-engine/02-CONTEXT.md
@.planning/phases/02-workflow-rules-engine/02-01-SUMMARY.md
@.planning/phases/02-workflow-rules-engine/02-02-SUMMARY.md

Relevant code:
@src/lib/workflow/rules-engine.ts
@src/app/api/webhook/kapso/route.ts
@convex/workflows.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy and verify webhook receives messages</name>
  <files>N/A</files>
  <action>
1. Deploy the updated webhook to Vercel:
```bash
cd /home/jfransisco/Desktop/21/my21staff
git add .
git commit -m "feat(02): add workflow rules engine with webhook integration"
git push origin master
```

2. Wait for Vercel deployment to complete (check deployment URL or Vercel dashboard).

3. Verify the webhook endpoint is accessible:
```bash
curl -X GET https://www.my21staff.com/api/webhook/kapso
```
Expected: `{"status":"Webhook endpoint ready"}`

4. Check Vercel function logs to confirm deployment succeeded.
  </action>
  <verify>
Webhook endpoint returns 200 status and "Webhook endpoint ready" message.
  </verify>
  <done>Webhook is deployed and accessible at production URL.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Workflow rules engine with keyword triggers, FAQ templates, and lead routing integrated into webhook</what-built>
  <how-to-verify>
**Live WhatsApp Testing Protocol**

Using the my21staff WhatsApp number (+62 813-1859-025), send these test messages from your personal phone:

**Test 1: Handoff Keyword Trigger**
1. Send: "I want to speak to a human"
2. Expected: See in Vercel logs: `[RulesEngine] Keyword trigger matched: handoff-trigger`
3. Expected: Response with placeholder handoff message

**Test 2: Manager Bot Keyword Trigger**
1. Send: "!summary"
2. Expected: See in Vercel logs: `[RulesEngine] Keyword trigger matched: manager-trigger`
3. Expected: Rules engine handles (manager bot not implemented yet, but trigger detected)

**Test 3: FAQ Template Match**
1. Send: "Berapa harga layanan?"
2. Expected: See in Vercel logs: `[RulesEngine] FAQ template matched: pricing-faq`
3. Expected: Response with placeholder pricing info

**Test 4: Pass-Through to AI**
1. Send: "Halo, saya tertarik dengan layanan Anda"
2. Expected: See in Vercel logs: `[RulesEngine] No rule match, passing to AI`
3. Expected: AI (ARI) responds with conversational message

**Test 5: Returning Lead Detection**
1. Wait 5 minutes, send another message
2. Expected: See in Vercel logs: `[RulesEngine] Lead type: returning`

**How to check Vercel logs:**
1. Go to Vercel dashboard > my21staff project
2. Click "Functions" tab
3. Look for `/api/webhook/kapso` function
4. View real-time logs during testing

**Success Indicators:**
- Keyword triggers are detected before AI
- FAQ responses are sent (even if placeholder)
- Unmatched messages go to AI
- Execution logs are created (check Convex dashboard > workflow_executions table)
  </how-to-verify>
  <resume-signal>Type "verified" with test results, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Document verification results</name>
  <files>.planning/phases/02-workflow-rules-engine/02-VERIFICATION.md</files>
  <action>
Create verification documentation with test results:

```markdown
# Phase 02: Workflow Rules Engine - Verification

**Verified:** [DATE]
**Tester:** User (live WhatsApp testing)

## Test Results

### Test 1: Handoff Keyword Trigger
- **Message sent:** [message]
- **Expected behavior:** Keyword trigger matched, handoff action
- **Actual result:** [PASS/FAIL + details]
- **Logs:** [relevant log excerpt]

### Test 2: Manager Bot Trigger
- **Message sent:** [message]
- **Expected behavior:** Keyword trigger matched, manager_bot action
- **Actual result:** [PASS/FAIL + details]
- **Logs:** [relevant log excerpt]

### Test 3: FAQ Template Match
- **Message sent:** [message]
- **Expected behavior:** FAQ template matched, response sent
- **Actual result:** [PASS/FAIL + details]
- **Logs:** [relevant log excerpt]

### Test 4: AI Pass-Through
- **Message sent:** [message]
- **Expected behavior:** No rule match, AI processes
- **Actual result:** [PASS/FAIL + details]
- **Logs:** [relevant log excerpt]

### Test 5: Lead Type Detection
- **Scenario:** Returning lead (sent message after previous)
- **Expected behavior:** Lead type: returning
- **Actual result:** [PASS/FAIL + details]

## Execution Logs

Convex workflow_executions table entries:
- Total executions logged: [N]
- Breakdown by action: handoff: [N], manager_bot: [N], faq_response: [N], ai_fallback: [N]

## Issues Found

[List any issues and fixes applied, or "None"]

## Conclusion

**Phase 02 Verification:** [PASSED/FAILED]

Requirements verified:
- [x] RULE-01: Keyword trigger for handoff
- [x] RULE-02: Keyword trigger for manager bot
- [x] RULE-03: Lead routing (new vs returning)
- [x] RULE-04: FAQ template responses
- [x] RULE-05: Conditional routing (rules first, AI fallback)

---

*Ready for Phase 2.5: Settings & Configuration*
```

Fill in actual test results based on user's verification feedback.
  </action>
  <verify>
File exists at `.planning/phases/02-workflow-rules-engine/02-VERIFICATION.md` with test results.
  </verify>
  <done>Verification document created with all test results.</done>
</task>

</tasks>

<verification>
1. Webhook deployed and accessible
2. Live WhatsApp tests confirm rule detection
3. Execution logs visible in Convex dashboard
4. Verification document created with results
</verification>

<success_criteria>
- [ ] Webhook deployed to production
- [ ] Handoff keyword triggers detected (RULE-01)
- [ ] Manager bot keyword triggers detected (RULE-02)
- [ ] Lead type detection works (RULE-03)
- [ ] FAQ template matches work (RULE-04)
- [ ] Unmatched messages pass to AI (RULE-05)
- [ ] Execution logs created in Convex
- [ ] Verification document completed
</success_criteria>

<output>
After completion, create `.planning/phases/02-workflow-rules-engine/02-03-SUMMARY.md`
</output>
