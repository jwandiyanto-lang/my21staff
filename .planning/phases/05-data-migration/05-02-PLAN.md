---
phase: 05-data-migration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - scripts/migrate-supabase-to-convex.ts
  - convex/migrate.ts
autonomous: true

must_haves:
  truths:
    - "Migration script reads all data from Supabase tables"
    - "Migration script writes data to Convex tables with proper ID mapping"
    - "Workspace IDs mapped correctly from Supabase UUID to Convex ID"
    - "Migration report shows successful transfer counts"
  artifacts:
    - path: "scripts/migrate-supabase-to-convex.ts"
      provides: "One-time migration script for bulk data transfer"
      min_lines: 200
    - path: ".planning/migrations/data-migration-report.json"
      provides: "Migration results and record counts"
  key_links:
    - from: "scripts/migrate-supabase-to-convex.ts"
      to: "Supabase database"
      via: "supabase-js client"
      pattern: "createClient"
    - from: "scripts/migrate-supabase-to-convex.ts"
      to: "convex/migrate.ts"
      via: "Convex HTTP action"
      pattern: "fetch.*convex.site"
---

<objective>
Create and execute migration scripts to transfer all remaining Supabase data to Convex.

Purpose: Complete one-time bulk migration of ARI tables, CMS content, and utility data.
Output: All Supabase data transferred to Convex with mapping preserved.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-data-migration/05-01-SUMMARY.md

Reference existing migration patterns:
@scripts/migrate-users-to-clerk.ts
@scripts/migrate-workspaces-to-orgs.ts
@.planning/migrations/workspace-org-mapping.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Convex migration mutations</name>
  <files>convex/migrate.ts</files>
  <action>
Extend convex/migrate.ts with internal mutations for bulk data import. These are used by the migration script via HTTP action.

Add the following internalMutation functions:

1. **bulkInsertAriDestinations**: Accept array of destination records, insert to ariDestinations
2. **bulkInsertAriPayments**: Accept array of payment records, insert to ariPayments
3. **bulkInsertAriAppointments**: Accept array of appointment records, insert to ariAppointments
4. **bulkInsertAriAiComparison**: Accept array of comparison records, insert to ariAiComparison
5. **bulkInsertAriFlowStages**: Accept array of flow stage records, insert to ariFlowStages
6. **bulkInsertAriKnowledgeCategories**: Accept array of category records, insert to ariKnowledgeCategories
7. **bulkInsertAriKnowledgeEntries**: Accept array of entry records, insert to ariKnowledgeEntries
8. **bulkInsertAriScoringConfig**: Accept array of config records, insert to ariScoringConfig
9. **bulkInsertConsultantSlots**: Accept array of slot records, insert to consultantSlots
10. **bulkInsertArticles**: Accept array of article records, insert to articles
11. **bulkInsertWebinars**: Accept array of webinar records, insert to webinars
12. **bulkInsertWebinarRegistrations**: Accept array of registration records, insert to webinarRegistrations

Each mutation should:
- Accept a `records` parameter: v.array(v.object({...}))
- Process in batches of 100 (Convex limit)
- Return count of inserted records
- Handle idempotency via supabaseId where applicable

Pattern from existing code:
```typescript
export const bulkInsertArticles = internalMutation({
  args: {
    records: v.array(v.object({
      workspace_id: v.string(), // Will be looked up to get Convex ID
      title: v.string(),
      // ... other fields
      supabaseId: v.string(),
    })),
  },
  handler: async (ctx, args) => {
    let inserted = 0;
    for (const record of args.records) {
      // Look up workspace Convex ID by slug or supabaseId
      const workspace = await ctx.db
        .query("workspaces")
        .filter(q => q.eq(q.field("slug"), record.workspace_slug))
        .first();
      if (!workspace) continue;

      await ctx.db.insert("articles", {
        workspace_id: workspace._id,
        // ... map fields
      });
      inserted++;
    }
    return { inserted };
  },
});
```
  </action>
  <verify>Run `npx convex dev` - mutations compile without errors</verify>
  <done>12 bulk insert mutations defined in migrate.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create migration script</name>
  <files>scripts/migrate-supabase-to-convex.ts</files>
  <action>
Create a TypeScript migration script that:

1. **Setup**:
   - Load Supabase service role credentials from env
   - Load Convex deployment URL and admin key
   - Load workspace mapping from `.planning/migrations/workspace-org-mapping.json`

2. **Migration order** (respecting foreign keys):
   - First: Independent tables (articles, webinars, ariDestinations, ariScoringConfig, ariFlowStages, ariKnowledgeCategories, consultantSlots, ariAiComparison)
   - Second: Dependent tables (ariKnowledgeEntries depends on categories, webinarRegistrations depends on webinars)
   - Third: ARI conversation-related (ariPayments, ariAppointments depend on ariConversations)

3. **For each table**:
   - Query all records from Supabase
   - Transform data (timestamps from ISO to epoch, map workspace_id to slug for Convex lookup)
   - Call Convex mutation via HTTP action
   - Log progress and counts
   - Handle errors gracefully (log and continue)

4. **ID Mapping Strategy**:
   - workspace_id: Look up Convex workspace by slug (already migrated)
   - contact_id: Look up by phone+workspace (already in Convex)
   - ari_conversation_id: Look up by contact_id+workspace (already in Convex)
   - category_id: Build mapping during ariKnowledgeCategories migration

5. **Output**:
   - Write migration report to `.planning/migrations/data-migration-report.json`
   - Include: table name, source count, migrated count, skipped count, errors

Script structure:
```typescript
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.SUPABASE_URL!;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const CONVEX_URL = process.env.CONVEX_URL!; // e.g., https://pleasant-antelope-109.convex.site

interface MigrationReport {
  timestamp: string;
  tables: Record<string, {
    source: number;
    migrated: number;
    skipped: number;
    errors: string[];
  }>;
}

async function main() {
  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
  const report: MigrationReport = { timestamp: new Date().toISOString(), tables: {} };

  // Load workspace mapping
  const workspaceMapping = require('../.planning/migrations/workspace-org-mapping.json');

  // Migrate each table...
  await migrateArticles(supabase, report);
  await migrateWebinars(supabase, report);
  // ... etc

  // Write report
  fs.writeFileSync('.planning/migrations/data-migration-report.json', JSON.stringify(report, null, 2));
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit scripts/migrate-supabase-to-convex.ts`</verify>
  <done>Migration script created with all table handlers</done>
</task>

<task type="auto">
  <name>Task 3: Execute migration and verify</name>
  <files>.planning/migrations/data-migration-report.json</files>
  <action>
1. Ensure Convex dev is running: `npx convex dev` (in separate terminal if needed)

2. Run the migration script:
   ```bash
   npx tsx scripts/migrate-supabase-to-convex.ts
   ```

3. Review the migration report output

4. Verify data in Convex dashboard:
   - Check record counts match report
   - Spot check a few records for data integrity
   - Verify foreign key relationships (workspace_id, contact_id) are valid

Note: Per CONTEXT.md, this is a one-time migration. If any table has 0 records in Supabase, that's fine - the migration script should handle empty tables gracefully.
  </action>
  <verify>
- Migration script completes without fatal errors
- `.planning/migrations/data-migration-report.json` exists with results
- Report shows migrated counts >= 0 for each table (0 is acceptable for unused tables)
  </verify>
  <done>Data migration complete with report generated</done>
</task>

</tasks>

<verification>
- [ ] Migration script compiles and runs
- [ ] All 12 tables processed (even if some have 0 records)
- [ ] Migration report saved to `.planning/migrations/data-migration-report.json`
- [ ] No critical errors in migration (warnings for 0-record tables are OK)
- [ ] Spot check: At least one table with data shows matching counts in Convex
</verification>

<success_criteria>
All Supabase data migrated to Convex:
- Migration script successfully transfers data
- Report shows migration results for each table
- Data integrity preserved (foreign keys resolve)
- Ready for API route updates in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-migration/05-02-SUMMARY.md`
</output>
