---
phase: 05-data-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
autonomous: true

must_haves:
  truths:
    - "All remaining Supabase tables have corresponding Convex table definitions"
    - "Schema compiles without errors"
    - "Schema deployed to Convex dev"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Complete table definitions for all data"
      contains: "ariDestinations, ariPayments, ariAppointments, ariAiComparison, ariFlowStages, ariKnowledgeCategories, ariKnowledgeEntries, ariScoringConfig, consultantSlots, articles, webinars, webinarRegistrations"
  key_links:
    - from: "convex/schema.ts"
      to: "Convex deployment"
      via: "npx convex dev"
      pattern: "Schema deployed"
---

<objective>
Extend Convex schema with all remaining Supabase tables not yet defined.

Purpose: Complete the data model before migration scripts run.
Output: Updated schema.ts with 12 new table definitions deployed to Convex.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/schema.ts

Reference Supabase migrations for field definitions:
@supabase/migrations/34_ari_tables.sql
@supabase/migrations/37_consultant_slots.sql
@supabase/migrations/40_flow_stages.sql
@supabase/migrations/41_knowledge_entries.sql
@supabase/migrations/42_scoring_config.sql
@supabase/migrations/05_website_content.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ARI extended tables to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add the following table definitions to convex/schema.ts, following the existing snake_case convention and v3.0 patterns:

1. **ariDestinations** (university knowledge base):
   - workspace_id: v.id("workspaces")
   - country: v.string()
   - city: v.optional(v.string())
   - university_name: v.string()
   - requirements: v.optional(v.any()) - JSONB for ielts_min, gpa_min, budget_min, budget_max, deadline
   - programs: v.optional(v.array(v.string()))
   - is_promoted: v.boolean()
   - priority: v.number()
   - notes: v.optional(v.string())
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_workspace_country

2. **ariPayments** (payment records):
   - ari_conversation_id: v.id("ariConversations")
   - workspace_id: v.id("workspaces")
   - amount: v.number()
   - currency: v.string() (default 'IDR')
   - payment_method: v.optional(v.string())
   - gateway: v.string() (default 'midtrans')
   - gateway_transaction_id: v.optional(v.string())
   - gateway_response: v.optional(v.any())
   - status: v.string() (pending, success, failed, expired, refunded)
   - expires_at: v.optional(v.number())
   - paid_at: v.optional(v.number())
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_conversation, by_status

3. **ariAppointments** (consultation scheduling):
   - ari_conversation_id: v.id("ariConversations")
   - workspace_id: v.id("workspaces")
   - payment_id: v.optional(v.id("ariPayments"))
   - consultant_id: v.optional(v.string()) - Clerk user ID
   - scheduled_at: v.number()
   - duration_minutes: v.number() (default 60)
   - meeting_link: v.optional(v.string())
   - status: v.string() (scheduled, confirmed, completed, cancelled, no_show)
   - reminder_sent_at: v.optional(v.number())
   - notes: v.optional(v.string())
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_conversation, by_consultant

4. **ariAiComparison** (A/B testing metrics):
   - workspace_id: v.id("workspaces")
   - ai_model: v.string()
   - conversation_count: v.number()
   - avg_response_time_ms: v.optional(v.number())
   - total_tokens_used: v.number()
   - conversion_count: v.number()
   - satisfaction_score: v.optional(v.number())
   - period_start: v.optional(v.number())
   - period_end: v.optional(v.number())
   - created_at, updated_at: v.number()
   - Index: by_workspace_model

5. **ariFlowStages** (custom conversation stages):
   - workspace_id: v.id("workspaces")
   - name: v.string()
   - goal: v.string()
   - sample_script: v.optional(v.string())
   - exit_criteria: v.optional(v.string())
   - stage_order: v.number()
   - is_active: v.boolean()
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_workspace_order

6. **ariKnowledgeCategories** (knowledge base categories):
   - workspace_id: v.id("workspaces")
   - name: v.string()
   - description: v.optional(v.string())
   - display_order: v.number()
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_workspace_order

7. **ariKnowledgeEntries** (knowledge base entries):
   - workspace_id: v.id("workspaces")
   - category_id: v.optional(v.id("ariKnowledgeCategories"))
   - title: v.string()
   - content: v.string()
   - is_active: v.boolean()
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_category

8. **ariScoringConfig** (scoring thresholds):
   - workspace_id: v.id("workspaces")
   - hot_threshold: v.number() (default 70)
   - warm_threshold: v.number() (default 40)
   - weight_basic: v.number() (default 25)
   - weight_qualification: v.number() (default 35)
   - weight_document: v.number() (default 30)
   - weight_engagement: v.number() (default 10)
   - created_at, updated_at: v.number()
   - Index: by_workspace

9. **consultantSlots** (booking availability):
   - workspace_id: v.id("workspaces")
   - consultant_id: v.optional(v.string()) - Clerk user ID
   - day_of_week: v.number() (0-6)
   - start_time: v.string() (HH:MM format)
   - end_time: v.string() (HH:MM format)
   - duration_minutes: v.number() (default 60)
   - booking_window_days: v.number() (default 14)
   - max_bookings_per_slot: v.number() (default 1)
   - is_active: v.boolean()
   - created_at, updated_at: v.number()
   - Indexes: by_workspace, by_workspace_day
  </action>
  <verify>Run `npx convex dev` - no schema compilation errors</verify>
  <done>9 ARI/utility tables defined in schema.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add CMS tables to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add CMS table definitions to convex/schema.ts:

1. **articles** (CMS articles):
   - workspace_id: v.id("workspaces")
   - title: v.string()
   - slug: v.string()
   - excerpt: v.optional(v.string())
   - content: v.optional(v.string())
   - cover_image_url: v.optional(v.string())
   - status: v.string() (draft, published)
   - published_at: v.optional(v.number())
   - created_at, updated_at: v.number()
   - supabaseId: v.optional(v.string()) - for migration reference
   - Indexes: by_workspace, by_workspace_slug, by_status

2. **webinars** (CMS webinars):
   - workspace_id: v.id("workspaces")
   - title: v.string()
   - slug: v.string()
   - description: v.optional(v.string())
   - cover_image_url: v.optional(v.string())
   - scheduled_at: v.number()
   - duration_minutes: v.number() (default 60)
   - meeting_url: v.optional(v.string())
   - max_registrations: v.optional(v.number())
   - status: v.string() (draft, published, completed, cancelled)
   - published_at: v.optional(v.number())
   - created_at, updated_at: v.number()
   - supabaseId: v.optional(v.string())
   - Indexes: by_workspace, by_workspace_slug, by_status, by_scheduled

3. **webinarRegistrations** (registration records):
   - webinar_id: v.id("webinars")
   - contact_id: v.id("contacts")
   - workspace_id: v.id("workspaces")
   - registered_at: v.number()
   - attended: v.boolean()
   - Indexes: by_webinar, by_contact, by_workspace
  </action>
  <verify>Run `npx convex dev` - schema compiles successfully</verify>
  <done>3 CMS tables defined in schema.ts</done>
</task>

<task type="auto">
  <name>Task 3: Deploy schema to Convex dev</name>
  <files>convex/schema.ts</files>
  <action>
1. Run `npx convex dev` to deploy the updated schema
2. Verify all 12 new tables appear in Convex dashboard
3. Check no deployment errors

Note: Use `npx convex dev` not `npx convex deploy` (CLI bug with deploy noted in STATE.md)
  </action>
  <verify>
Run `npx convex dev --once` and confirm output shows:
- "Convex functions ready!"
- No errors
- Check Convex dashboard shows new tables (optional manual check)
  </verify>
  <done>Schema deployed to Convex dev with all 12 new tables</done>
</task>

</tasks>

<verification>
- [ ] `npx convex dev --once` succeeds without errors
- [ ] Schema includes all 12 new tables: ariDestinations, ariPayments, ariAppointments, ariAiComparison, ariFlowStages, ariKnowledgeCategories, ariKnowledgeEntries, ariScoringConfig, consultantSlots, articles, webinars, webinarRegistrations
- [ ] Each table has appropriate indexes defined
- [ ] Tables follow snake_case convention matching existing schema
</verification>

<success_criteria>
Complete Convex schema ready for data migration:
- 12 new tables defined matching Supabase structure
- Schema compiles and deploys without errors
- Ready for migration scripts in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-migration/05-01-SUMMARY.md`
</output>
