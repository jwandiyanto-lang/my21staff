---
phase: 03-users-table-webhook
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - convex/_internal/webhook.js
autonomous: false

user_setup:
  - service: clerk
    why: "Webhook endpoint configuration"
    env_vars:
      - name: CLERK_WEBHOOK_SECRET
        source: "Clerk Dashboard -> Webhooks -> Signing Secret (after creating endpoint)"
    dashboard_config:
      - task: "Create webhook endpoint pointing to Convex URL"
        location: "Clerk Dashboard -> Webhooks -> Add Endpoint"

must_haves:
  truths:
    - "Clerk webhook syncs user.created events to Convex"
    - "Clerk webhook syncs user.updated events to Convex"
    - "Clerk webhook syncs user.deleted events to Convex"
    - "Webhook validates svix signatures"
  artifacts:
    - path: "convex/_internal/webhook.js"
      provides: "Clerk webhook HTTP action at /webhook/clerk"
      contains: "path: \"/webhook/clerk\""
  key_links:
    - from: "convex/_internal/webhook.js"
      to: "convex/users.ts"
      via: "internalMutation calls"
      pattern: "internal\\.users\\.(createUser|updateUser|deleteUser)"
    - from: "Clerk Dashboard"
      to: "Convex HTTP endpoint"
      via: "webhook configuration"
      pattern: "https://.*convex.cloud/api/webhook/clerk"
---

<objective>
Create Clerk webhook HTTP action in Convex and configure Clerk Dashboard to send user events.

Purpose: Sync user data from Clerk to Convex automatically on user creation, updates, and deletion.

Output: Working webhook endpoint that processes Clerk user events and stores them in Convex
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-users-table-webhook/03-CONTEXT.md
@.planning/phases/03-users-table-webhook/03-01-SUMMARY.md

@convex/_internal/webhook.js (existing Kapso webhook pattern)
@convex/users.ts (mutations to call)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Clerk webhook route to webhook.js</name>
  <files>convex/_internal/webhook.js</files>
  <action>
Add Clerk webhook handler to the existing webhook.js file (which already has Kapso webhook).

Add after the existing Kapso webhook routes:

```javascript
// ============================================
// Clerk Webhook: User sync events
// ============================================

http.route({
  path: "/webhook/clerk",
  method: "POST",
  handler: httpAction(async ({ runMutation }, request) => {
    const startTime = Date.now();
    let eventType = "unknown";
    let clerkId = null;

    try {
      // Get raw body and headers for signature verification
      const rawBody = await request.text();
      const svixId = request.headers.get("svix-id");
      const svixTimestamp = request.headers.get("svix-timestamp");
      const svixSignature = request.headers.get("svix-signature");

      // Verify svix signature
      const webhookSecret = process.env.CLERK_WEBHOOK_SECRET;
      if (!webhookSecret) {
        console.error("[Clerk Webhook] CLERK_WEBHOOK_SECRET not set");
        return new Response(JSON.stringify({ error: "Webhook secret not configured" }), {
          status: 500,
          headers: { "Content-Type": "application/json" },
        });
      }

      // Svix signature verification
      // Format: v1,<signature>
      const signaturePayload = `${svixId}.${svixTimestamp}.${rawBody}`;
      const crypto = require("crypto");

      // Extract the signature (may have multiple, take first v1)
      const signatures = svixSignature.split(" ");
      let verified = false;

      for (const sig of signatures) {
        const [version, signature] = sig.split(",");
        if (version === "v1") {
          const secretBytes = Buffer.from(webhookSecret.replace("whsec_", ""), "base64");
          const expectedSignature = crypto
            .createHmac("sha256", secretBytes)
            .update(signaturePayload)
            .digest("base64");

          if (signature === expectedSignature) {
            verified = true;
            break;
          }
        }
      }

      if (!verified) {
        console.error("[Clerk Webhook] Invalid signature");
        await runMutation(internal.users.logWebhookEvent, {
          event_type: "signature_failed",
          payload: { headers: { svixId, svixTimestamp } },
          status: "error",
          error_message: "Invalid svix signature",
        });
        return new Response(JSON.stringify({ error: "Invalid signature" }), {
          status: 401,
          headers: { "Content-Type": "application/json" },
        });
      }

      // Parse the verified payload
      const payload = JSON.parse(rawBody);
      eventType = payload.type;
      const userData = payload.data;
      clerkId = userData?.id;

      console.log(`[Clerk Webhook] Processing ${eventType} for user ${clerkId}`);

      // Handle user events
      switch (eventType) {
        case "user.created":
          await runMutation(internal.users.createUser, {
            clerk_id: clerkId,
          });
          break;

        case "user.updated":
          await runMutation(internal.users.updateUser, {
            clerk_id: clerkId,
          });
          break;

        case "user.deleted":
          await runMutation(internal.users.deleteUser, {
            clerk_id: clerkId,
          });
          break;

        default:
          console.log(`[Clerk Webhook] Ignoring event type: ${eventType}`);
      }

      // Log successful processing
      await runMutation(internal.users.logWebhookEvent, {
        event_type: eventType,
        clerk_id: clerkId,
        payload: { type: eventType, user_id: clerkId },
        status: "success",
      });

      const duration = Date.now() - startTime;
      console.log(`[Clerk Webhook] Processed ${eventType} in ${duration}ms`);

      return new Response(JSON.stringify({ received: true }), {
        status: 200,
        headers: { "Content-Type": "application/json" },
      });

    } catch (error) {
      const duration = Date.now() - startTime;
      console.error(`[Clerk Webhook] Error after ${duration}ms:`, error);

      // Log error for debugging
      await runMutation(internal.users.logWebhookEvent, {
        event_type: eventType,
        clerk_id: clerkId,
        payload: { error: error.message },
        status: "error",
        error_message: error.message,
      });

      return new Response(JSON.stringify({ error: "Processing failed" }), {
        status: 500,
        headers: { "Content-Type": "application/json" },
      });
    }
  }),
});
```

Also add the internal import at the top of the file (after existing imports):
```javascript
import { internal } from "../_generated/api.js";
```

Notes:
- Svix signature verification uses HMAC-SHA256 with base64 encoding
- Clerk webhook secrets start with "whsec_" - strip prefix before decoding
- Log all events to webhookAudit table for debugging
- Return 200 quickly to avoid Clerk retries (Clerk has 5-second timeout)
  </action>
  <verify>Run `npx convex dev --once` and confirm no errors. Check that /webhook/clerk route exists in deployment.</verify>
  <done>Clerk webhook HTTP action added to webhook.js with svix signature verification</done>
</task>

<task type="auto">
  <name>Task 2: Set CLERK_WEBHOOK_SECRET env var in Convex</name>
  <files>N/A (Convex Dashboard)</files>
  <action>
The webhook secret will be generated when creating the Clerk webhook endpoint.

For now, set a placeholder to allow deployment:

```bash
npx convex env set CLERK_WEBHOOK_SECRET "placeholder_will_update_after_clerk_config"
```

This will be replaced with the real secret from Clerk Dashboard in the checkpoint task.

Note: Dev deployment only for now. Production deployment uses Convex Dashboard.
  </action>
  <verify>Run `npx convex env list` and confirm CLERK_WEBHOOK_SECRET is set</verify>
  <done>CLERK_WEBHOOK_SECRET env var exists in Convex (placeholder for now)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Clerk webhook HTTP action at /webhook/clerk ready to receive user events</what-built>
  <how-to-verify>
**Step 1: Get Convex webhook URL**

Your Convex webhook URL is:
```
https://intent-otter-212.convex.cloud/api/webhook/clerk
```

**Step 2: Create Clerk webhook endpoint**

1. Go to Clerk Dashboard: https://dashboard.clerk.com
2. Select "my21staff" application
3. Navigate to: Webhooks (left sidebar)
4. Click "Add Endpoint"
5. Configure:
   - **Endpoint URL:** `https://intent-otter-212.convex.cloud/api/webhook/clerk`
   - **Subscribe to events:** Select these user events:
     - `user.created`
     - `user.updated`
     - `user.deleted`
6. Click "Create"
7. Copy the **Signing Secret** (starts with `whsec_`)

**Step 3: Update Convex env var with real secret**

Run in terminal:
```bash
npx convex env set CLERK_WEBHOOK_SECRET "whsec_your_actual_secret_here"
```

**Step 4: Test the webhook**

1. In Clerk Dashboard, go to your webhook endpoint
2. Click "Testing" tab
3. Select "user.created" event
4. Click "Send Test"
5. Check webhook delivery shows 200 success

**Expected Result:** Test webhook returns 200, and a record appears in your Convex webhookAudit table.

To verify in Convex Dashboard:
1. Go to https://dashboard.convex.dev
2. Select your project
3. Click "Data" tab
4. Check webhookAudit table for the test event
  </how-to-verify>
  <resume-signal>Type "webhook configured" after completing Clerk Dashboard setup, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Clerk webhook endpoint exists and configured for user events
2. Test webhook from Clerk Dashboard returns 200
3. webhookAudit table shows test event with status "success"
4. CLERK_WEBHOOK_SECRET is set to real Clerk signing secret
</verification>

<success_criteria>
- Clerk webhook syncs user.created events to Convex users table
- Clerk webhook syncs user.updated events to Convex users table
- Clerk webhook syncs user.deleted events removes user from Convex
- Webhook validates svix signatures for security
- Audit log captures all webhook events for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/03-users-table-webhook/03-02-SUMMARY.md`
</output>
