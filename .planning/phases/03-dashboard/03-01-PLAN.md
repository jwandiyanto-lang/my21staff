---
phase: 03-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Stats query returns contact and conversation counts"
    - "Stats query filters by time period"
    - "Activity query returns paginated notes"
    - "Queries are workspace-scoped"
  artifacts:
    - path: "convex/dashboard.ts"
      provides: "Dashboard queries for stats and activity"
      exports: ["getStats", "listActivity"]
  key_links:
    - from: "convex/dashboard.ts"
      to: "contacts, conversations, contactNotes tables"
      via: "Convex db.query with workspace index"
      pattern: "withIndex.*by_workspace"
---

<objective>
Create Convex queries for dashboard statistics and activity feed.

Purpose: Backend foundation for real-time dashboard data. Stats query provides counts (contacts, conversations, status breakdown) with time filtering. Activity query provides paginated recent workspace activity (notes for v3.2, expandable later).

Output: `convex/dashboard.ts` with getStats and listActivity queries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dashboard/03-CONTEXT.md
@.planning/phases/03-dashboard/03-RESEARCH.md
@convex/schema.ts
@convex/contacts.ts
@convex/contactNotes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard Convex module with getStats query</name>
  <files>convex/dashboard.ts</files>
  <action>
Create `convex/dashboard.ts` with getStats query:

1. Import patterns:
   - Use `@ts-nocheck` at top (matches existing convex/*.ts pattern)
   - Import query from "./_generated/server"
   - Import v from "convex/values"

2. getStats query args:
   - workspace_id: v.string() (will be cast to Id)
   - time_filter: v.optional(v.union(v.literal("week"), v.literal("month"), v.literal("all")))

3. getStats implementation:
   - Calculate time cutoffs: weekAgo = now - 7 days, monthAgo = now - 30 days
   - Fetch all contacts using `withIndex("by_workspace", ...)`
   - Fetch all conversations using `withIndex("by_workspace", ...)`
   - Apply time filter to created_at timestamps
   - Calculate status breakdown from contacts (reduce to count per lead_status)
   - Get workspace to check kapso_phone_id for onboarding
   - Return: { totalContacts, totalConversations, activeConversations (unread_count > 0), statusBreakdown, hasKapsoConnected, hasContacts, hasConversations }

Note: Do NOT add requireWorkspaceMembership auth check yet - the existing contacts.ts and conversations.ts also don't have it in their list queries. Follow existing pattern.
  </action>
  <verify>
Run `npx convex dev` and verify no TypeScript errors. Check that getStats appears in api.dashboard.
  </verify>
  <done>
getStats query returns workspace stats with time filtering. Query uses workspace indexes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add listActivity paginated query</name>
  <files>convex/dashboard.ts</files>
  <action>
Add listActivity query to convex/dashboard.ts:

1. Import paginationOptsValidator from "convex/server"

2. listActivity query args:
   - workspace_id: v.string()
   - paginationOpts: paginationOptsValidator

3. listActivity implementation:
   - Query contactNotes with `withIndex("by_workspace", ...)`
   - Order by "desc" (most recent first)
   - Use `.paginate(args.paginationOpts)`
   - Fetch associated contacts for each note (batch lookup by unique contact_ids)
   - Return paginated result with page items mapped to include:
     - All note fields
     - type: 'note' as const
     - contact: { name, phone } or null if contact deleted

4. Follow existing pagination pattern from RESEARCH.md code examples.

Note: For v3.2, activity feed only shows notes. Form fills and chat summaries deferred to future iteration per RESEARCH.md open questions.
  </action>
  <verify>
Run `npx convex dev` and verify no errors. Check that listActivity appears in api.dashboard.
  </verify>
  <done>
listActivity query returns paginated workspace activity with contact info. Pagination works correctly.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. Both getStats and listActivity queries are available in api.dashboard
3. Queries use workspace indexes for efficient filtering
</verification>

<success_criteria>
- convex/dashboard.ts exists with getStats and listActivity exports
- Queries follow existing codebase patterns (index usage, type casting)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-dashboard/03-01-SUMMARY.md`
</output>
