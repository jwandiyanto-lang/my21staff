---
phase: 04-support-ticketing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/26_tickets.sql
autonomous: true

must_haves:
  truths:
    - "Tickets table exists with all required columns"
    - "ticket_comments table exists for discussions"
    - "ticket_status_history table exists for audit trail"
    - "RLS policies use existing get_user_role_in_workspace function"
    - "Indexes exist for common query patterns"
  artifacts:
    - path: "supabase/migrations/26_tickets.sql"
      provides: "Database schema for ticketing system"
      contains: "CREATE TABLE tickets"
  key_links:
    - from: "tickets"
      to: "workspace_members"
      via: "workspace_id foreign key"
      pattern: "REFERENCES workspaces\\(id\\)"
    - from: "ticket_comments"
      to: "tickets"
      via: "ticket_id foreign key"
      pattern: "REFERENCES tickets\\(id\\)"
---

<objective>
Create database schema for support ticketing system with RLS policies.

Purpose: Foundation for all ticketing functionality - tables, constraints, indexes, and row-level security.
Output: Migration file 26_tickets.sql ready for deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-support-ticketing/04-CONTEXT.md
@.planning/phases/04-support-ticketing/04-RESEARCH.md
@supabase/migrations/25_member_lead_visibility.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tickets migration file</name>
  <files>supabase/migrations/26_tickets.sql</files>
  <action>
Create migration file with three tables:

1. **tickets table:**
   - id UUID PRIMARY KEY
   - workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE
   - requester_id UUID NOT NULL REFERENCES auth.users(id)
   - assigned_to UUID REFERENCES auth.users(id)
   - title VARCHAR(255) NOT NULL
   - description TEXT NOT NULL
   - category VARCHAR(50) NOT NULL (constraint: 'bug', 'feature', 'question')
   - priority VARCHAR(50) NOT NULL (constraint: 'low', 'medium', 'high')
   - stage VARCHAR(50) NOT NULL DEFAULT 'report' (constraint: 'report', 'discuss', 'outcome', 'implementation', 'closed')
   - pending_approval BOOLEAN DEFAULT FALSE
   - pending_stage VARCHAR(50)
   - approval_requested_at TIMESTAMPTZ
   - reopen_token VARCHAR(255)
   - closed_at TIMESTAMPTZ
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - updated_at TIMESTAMPTZ DEFAULT NOW()

2. **ticket_comments table:**
   - id UUID PRIMARY KEY
   - ticket_id UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE
   - author_id UUID NOT NULL REFERENCES auth.users(id)
   - content TEXT NOT NULL
   - is_stage_change BOOLEAN DEFAULT FALSE
   - created_at TIMESTAMPTZ DEFAULT NOW()

3. **ticket_status_history table:**
   - id UUID PRIMARY KEY
   - ticket_id UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE
   - changed_by UUID NOT NULL REFERENCES auth.users(id)
   - from_stage VARCHAR(50)
   - to_stage VARCHAR(50) NOT NULL
   - reason TEXT
   - created_at TIMESTAMPTZ DEFAULT NOW()

Add CHECK constraints for category, priority, and stage enums.
  </action>
  <verify>Run `cat supabase/migrations/26_tickets.sql` and verify all three tables are defined with correct columns and constraints</verify>
  <done>Migration file exists with tickets, ticket_comments, and ticket_status_history tables</done>
</task>

<task type="auto">
  <name>Task 2: Add RLS policies using existing function</name>
  <files>supabase/migrations/26_tickets.sql</files>
  <action>
Add to the same migration file:

1. Enable RLS on all three tables
2. Create policies using `private.get_user_role_in_workspace()` (already exists from migration 25):

**tickets policies:**
- SELECT: Any workspace member can view (role IS NOT NULL)
- INSERT: Any member can create, requester_id must equal auth.uid()
- UPDATE: Owner/admin OR assigned_to = auth.uid() OR requester_id = auth.uid()

**ticket_comments policies:**
- SELECT: Members can view if ticket is in their workspace
- INSERT: Members can add, author_id must equal auth.uid()

**ticket_status_history policies:**
- SELECT: Members can view if ticket is in their workspace

Pattern from migration 25:
```sql
(SELECT private.get_user_role_in_workspace(workspace_id)) IS NOT NULL
```

For joined tables (comments, history), use subquery:
```sql
ticket_id IN (
  SELECT id FROM tickets
  WHERE (SELECT private.get_user_role_in_workspace(workspace_id)) IS NOT NULL
)
```
  </action>
  <verify>Grep for "ENABLE ROW LEVEL SECURITY" and "CREATE POLICY" - should find 3 enables and 6 policies</verify>
  <done>RLS enabled on all tables with correct policies for workspace-based access</done>
</task>

<task type="auto">
  <name>Task 3: Add indexes for performance</name>
  <files>supabase/migrations/26_tickets.sql</files>
  <action>
Add to the same migration file:

```sql
-- Tickets indexes
CREATE INDEX idx_tickets_workspace ON tickets(workspace_id);
CREATE INDEX idx_tickets_requester ON tickets(requester_id);
CREATE INDEX idx_tickets_assigned ON tickets(assigned_to);
CREATE INDEX idx_tickets_stage ON tickets(stage);
CREATE INDEX idx_tickets_workspace_stage ON tickets(workspace_id, stage);

-- Comments indexes
CREATE INDEX idx_ticket_comments_ticket ON ticket_comments(ticket_id);
CREATE INDEX idx_ticket_comments_ticket_created ON ticket_comments(ticket_id, created_at);

-- Status history indexes
CREATE INDEX idx_ticket_status_history_ticket ON ticket_status_history(ticket_id);
```

Also add updated_at trigger:
```sql
CREATE TRIGGER update_tickets_updated_at
  BEFORE UPDATE ON tickets
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

Note: update_updated_at_column() already exists from earlier migrations. If not, create it.
  </action>
  <verify>Grep for "CREATE INDEX" - should find 8 indexes. Grep for "CREATE TRIGGER" - should find 1 trigger.</verify>
  <done>Indexes created for workspace, requester, assigned_to, stage, and composite queries</done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/26_tickets.sql
2. File contains CREATE TABLE for tickets, ticket_comments, ticket_status_history
3. File contains CHECK constraints for category, priority, stage
4. File contains ENABLE ROW LEVEL SECURITY for all 3 tables
5. File contains CREATE POLICY statements (6 total)
6. File contains CREATE INDEX statements (8 total)
7. File is syntactically valid SQL
</verification>

<success_criteria>
- Migration file 26_tickets.sql created with complete schema
- All three tables defined with correct column types and constraints
- RLS policies use existing private.get_user_role_in_workspace() function
- Indexes cover common query patterns (workspace, stage, ticket_id)
- Ready for deployment via Supabase dashboard or CLI
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-ticketing/04-01-SUMMARY.md`
</output>
