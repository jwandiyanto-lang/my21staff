---
phase: 04-support-ticketing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tickets/types.ts
  - src/lib/tickets/constants.ts
  - src/lib/tickets/transitions.ts
  - src/lib/tickets/tokens.ts
  - src/lib/tickets/index.ts
  - src/lib/permissions/types.ts
  - src/lib/permissions/constants.ts
autonomous: true

must_haves:
  truths:
    - "TicketStage, TicketCategory, TicketPriority types are defined"
    - "canTransition() validates stage progression"
    - "Admin can skip stages with isAdminSkip flag"
    - "Reopen token uses HMAC with 7-day expiry"
    - "Ticket permissions are defined in permission system"
  artifacts:
    - path: "src/lib/tickets/types.ts"
      provides: "TypeScript types for ticketing"
      exports: ["TicketStage", "TicketCategory", "TicketPriority", "Ticket", "TicketComment"]
    - path: "src/lib/tickets/transitions.ts"
      provides: "Stage transition validation"
      exports: ["canTransition", "getNextStage", "isSkipTransition"]
    - path: "src/lib/tickets/tokens.ts"
      provides: "HMAC token generation/verification"
      exports: ["generateReopenToken", "verifyReopenToken"]
  key_links:
    - from: "src/lib/tickets/transitions.ts"
      to: "src/lib/tickets/constants.ts"
      via: "imports VALID_TRANSITIONS"
      pattern: "import.*VALID_TRANSITIONS.*from"
---

<objective>
Create TypeScript utilities for ticketing system - types, constants, state machine, and token handling.

Purpose: Type-safe foundation for all ticketing logic without external dependencies.
Output: src/lib/tickets/ module with types, constants, transitions, tokens.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-support-ticketing/04-CONTEXT.md
@.planning/phases/04-support-ticketing/04-RESEARCH.md
@src/lib/permissions/types.ts
@src/lib/permissions/constants.ts
@src/lib/crypto.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ticket types and constants</name>
  <files>src/lib/tickets/types.ts, src/lib/tickets/constants.ts</files>
  <action>
Create src/lib/tickets/ directory and files:

**types.ts:**
```typescript
export type TicketStage = 'report' | 'discuss' | 'outcome' | 'implementation' | 'closed'
export type TicketCategory = 'bug' | 'feature' | 'question'
export type TicketPriority = 'low' | 'medium' | 'high'

export interface Ticket {
  id: string
  workspace_id: string
  requester_id: string
  assigned_to: string | null
  title: string
  description: string
  category: TicketCategory
  priority: TicketPriority
  stage: TicketStage
  pending_approval: boolean
  pending_stage: TicketStage | null
  approval_requested_at: string | null
  reopen_token: string | null
  closed_at: string | null
  created_at: string
  updated_at: string
  // Joined data
  requester?: { id: string; full_name: string | null; email: string }
  assignee?: { id: string; full_name: string | null; email: string } | null
}

export interface TicketComment {
  id: string
  ticket_id: string
  author_id: string
  content: string
  is_stage_change: boolean
  created_at: string
  // Joined data
  author?: { id: string; full_name: string | null; email: string }
}

export interface TicketStatusHistory {
  id: string
  ticket_id: string
  changed_by: string
  from_stage: TicketStage | null
  to_stage: TicketStage
  reason: string | null
  created_at: string
}
```

**constants.ts:**
```typescript
import { type TicketStage, type TicketCategory, type TicketPriority } from './types'

export const STAGE_CONFIG: Record<TicketStage, { label: string; labelId: string; next: TicketStage | null }> = {
  report: { label: 'Report', labelId: 'Laporan', next: 'discuss' },
  discuss: { label: 'Discuss', labelId: 'Diskusi', next: 'outcome' },
  outcome: { label: 'Outcome', labelId: 'Keputusan', next: 'implementation' },
  implementation: { label: 'Implementation', labelId: 'Implementasi', next: 'closed' },
  closed: { label: 'Closed', labelId: 'Selesai', next: null }
}

export const CATEGORY_CONFIG: Record<TicketCategory, { label: string; labelId: string }> = {
  bug: { label: 'Bug', labelId: 'Bug' },
  feature: { label: 'Feature', labelId: 'Fitur' },
  question: { label: 'Question', labelId: 'Pertanyaan' }
}

export const PRIORITY_CONFIG: Record<TicketPriority, { label: string; labelId: string; color: string }> = {
  low: { label: 'Low', labelId: 'Rendah', color: 'text-gray-500' },
  medium: { label: 'Medium', labelId: 'Sedang', color: 'text-amber-500' },
  high: { label: 'High', labelId: 'Tinggi', color: 'text-red-500' }
}

// Normal progression: each stage can only go to its next stage
export const VALID_TRANSITIONS: Record<TicketStage, TicketStage[]> = {
  report: ['discuss'],
  discuss: ['outcome'],
  outcome: ['implementation'],
  implementation: ['closed'],
  closed: ['report'] // Reopen goes back to report
}

export const STAGES_ORDER: TicketStage[] = ['report', 'discuss', 'outcome', 'implementation', 'closed']
```
  </action>
  <verify>Verify files exist with `ls src/lib/tickets/` and check exports with `grep -n "export" src/lib/tickets/types.ts src/lib/tickets/constants.ts`</verify>
  <done>Types and constants defined for all ticket enums and configurations</done>
</task>

<task type="auto">
  <name>Task 2: Create transition validation and token utilities</name>
  <files>src/lib/tickets/transitions.ts, src/lib/tickets/tokens.ts, src/lib/tickets/index.ts</files>
  <action>
**transitions.ts:**
```typescript
import { VALID_TRANSITIONS, STAGES_ORDER, STAGE_CONFIG, type TicketStage } from './constants'

/**
 * Check if a stage transition is valid
 * @param fromStage - Current stage
 * @param toStage - Target stage
 * @param isAdminSkip - Whether this is an admin skipping stages (requires approval)
 */
export function canTransition(
  fromStage: TicketStage,
  toStage: TicketStage,
  isAdminSkip: boolean = false
): boolean {
  // Same stage - no transition needed
  if (fromStage === toStage) return false

  // Reopen from closed
  if (fromStage === 'closed' && toStage === 'report') return true

  // Normal transition to next stage
  if (VALID_TRANSITIONS[fromStage].includes(toStage)) return true

  // Admin skip (any forward progression except from closed)
  if (isAdminSkip && fromStage !== 'closed') {
    const fromIndex = STAGES_ORDER.indexOf(fromStage)
    const toIndex = STAGES_ORDER.indexOf(toStage)
    return toIndex > fromIndex // Can only skip forward
  }

  return false
}

/**
 * Get the next stage in normal progression
 */
export function getNextStage(currentStage: TicketStage): TicketStage | null {
  return STAGE_CONFIG[currentStage].next
}

/**
 * Check if this transition is a skip (not the immediate next stage)
 */
export function isSkipTransition(fromStage: TicketStage, toStage: TicketStage): boolean {
  return !VALID_TRANSITIONS[fromStage].includes(toStage) && fromStage !== 'closed'
}

/**
 * Get all valid target stages for a given stage (for UI dropdown)
 */
export function getValidTargetStages(
  currentStage: TicketStage,
  isAdminOrOwner: boolean
): TicketStage[] {
  if (currentStage === 'closed') {
    return ['report'] // Can only reopen
  }

  const targets: TicketStage[] = []
  const currentIndex = STAGES_ORDER.indexOf(currentStage)

  // Always include next stage
  const next = getNextStage(currentStage)
  if (next) targets.push(next)

  // Admin can skip to any later stage
  if (isAdminOrOwner) {
    for (let i = currentIndex + 2; i < STAGES_ORDER.length; i++) {
      targets.push(STAGES_ORDER[i])
    }
  }

  return targets
}
```

**tokens.ts:**
```typescript
import { createHmac, timingSafeEqual } from 'crypto'

const SECRET = process.env.TICKET_TOKEN_SECRET || process.env.ENCRYPTION_KEY

/**
 * Generate HMAC-signed reopen token with 7-day expiry
 */
export function generateReopenToken(ticketId: string, requesterId: string): string {
  if (!SECRET) {
    throw new Error('TICKET_TOKEN_SECRET or ENCRYPTION_KEY required for reopen tokens')
  }

  const expiry = Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
  const payload = `${ticketId}:${requesterId}:${expiry}`
  const signature = createHmac('sha256', SECRET)
    .update(payload)
    .digest('hex')

  return Buffer.from(`${payload}:${signature}`).toString('base64url')
}

/**
 * Verify reopen token and extract ticket/requester IDs
 * Returns null if token is invalid or expired
 */
export function verifyReopenToken(token: string): { ticketId: string; requesterId: string } | null {
  if (!SECRET) return null

  try {
    const decoded = Buffer.from(token, 'base64url').toString()
    const parts = decoded.split(':')

    if (parts.length !== 4) return null

    const [ticketId, requesterId, expiryStr, signature] = parts

    // Check expiry
    const expiry = parseInt(expiryStr, 10)
    if (Date.now() > expiry) return null

    // Verify signature
    const payload = `${ticketId}:${requesterId}:${expiryStr}`
    const expected = createHmac('sha256', SECRET)
      .update(payload)
      .digest('hex')

    const sigBuffer = Buffer.from(signature)
    const expectedBuffer = Buffer.from(expected)

    if (sigBuffer.length !== expectedBuffer.length) return null
    if (!timingSafeEqual(sigBuffer, expectedBuffer)) return null

    return { ticketId, requesterId }
  } catch {
    return null
  }
}
```

**index.ts:**
```typescript
// Types
export * from './types'

// Constants
export * from './constants'

// Transitions
export { canTransition, getNextStage, isSkipTransition, getValidTargetStages } from './transitions'

// Tokens
export { generateReopenToken, verifyReopenToken } from './tokens'
```
  </action>
  <verify>Run `grep -n "export" src/lib/tickets/index.ts` to verify all exports. Check token functions use crypto module.</verify>
  <done>Transition validation and HMAC token utilities ready for API usage</done>
</task>

<task type="auto">
  <name>Task 3: Add ticket permissions to permission system</name>
  <files>src/lib/permissions/types.ts, src/lib/permissions/constants.ts</files>
  <action>
Update existing permission files to add ticket-related permissions:

**types.ts** - Add to Permission union type:
```typescript
export type Permission =
  | 'leads:delete'
  | 'leads:view_all'
  | 'leads:export'
  | 'team:invite'
  | 'team:remove'
  | 'team:change_role'
  | 'workspace:settings'
  // Ticket permissions
  | 'tickets:assign'      // Assign tickets to team members
  | 'tickets:transition'  // Move tickets between stages
  | 'tickets:skip_stage'  // Skip stages (requires approval)
```

**constants.ts** - Add ticket permissions to roles:
```typescript
export const ROLE_PERMISSIONS: Record<WorkspaceRole, Permission[]> = {
  owner: [
    'leads:delete',
    'leads:view_all',
    'leads:export',
    'team:invite',
    'team:remove',
    'team:change_role',
    'workspace:settings',
    // Ticket permissions
    'tickets:assign',
    'tickets:transition',
    'tickets:skip_stage'
  ],
  admin: [
    'leads:view_all',
    'leads:export',
    // Ticket permissions
    'tickets:assign',
    'tickets:transition',
    'tickets:skip_stage'
  ],
  member: []
}
```

Note: All workspace members can create tickets and comment (RLS handles this). These permissions are for management actions.
  </action>
  <verify>Run `grep "tickets:" src/lib/permissions/types.ts src/lib/permissions/constants.ts` to verify new permissions added</verify>
  <done>Ticket permissions integrated into existing permission system</done>
</task>

</tasks>

<verification>
1. src/lib/tickets/ directory exists with 5 files
2. Types include TicketStage, TicketCategory, TicketPriority, Ticket, TicketComment
3. Constants include STAGE_CONFIG, VALID_TRANSITIONS, STAGES_ORDER
4. canTransition() handles normal progression and admin skip
5. generateReopenToken() uses HMAC-SHA256 with expiry
6. verifyReopenToken() validates signature and checks expiry
7. Permission types include tickets:assign, tickets:transition, tickets:skip_stage
8. ROLE_PERMISSIONS updated for owner and admin roles
</verification>

<success_criteria>
- src/lib/tickets/ module complete with all utilities
- TypeScript types match database schema from Plan 01
- Transition validation covers all cases (normal, skip, reopen)
- Token generation/verification uses secure HMAC pattern
- Permission system extended for ticket management
- All exports available through index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-ticketing/04-02-SUMMARY.md`
</output>
