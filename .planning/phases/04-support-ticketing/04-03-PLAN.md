---
phase: 04-support-ticketing
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/app/api/tickets/route.ts
  - src/app/api/tickets/[id]/route.ts
  - src/app/api/tickets/[id]/comments/route.ts
  - src/app/api/tickets/[id]/transition/route.ts
  - src/app/api/tickets/[id]/approval/route.ts
  - src/app/api/tickets/[id]/reopen/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/tickets returns workspace tickets list"
    - "POST /api/tickets creates new ticket"
    - "GET /api/tickets/[id] returns ticket with comments"
    - "POST /api/tickets/[id]/transition moves ticket to next stage"
    - "POST /api/tickets/[id]/approval handles approve/reject"
    - "POST /api/tickets/[id]/reopen allows requester to reopen"
    - "POST /api/tickets/[id]/comments adds comment"
  artifacts:
    - path: "src/app/api/tickets/route.ts"
      provides: "List and create tickets"
      exports: ["GET", "POST"]
    - path: "src/app/api/tickets/[id]/transition/route.ts"
      provides: "Stage transition with notification toggle"
      exports: ["POST"]
    - path: "src/app/api/tickets/[id]/reopen/route.ts"
      provides: "Token-based reopen endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/tickets/route.ts"
      to: "requireWorkspaceMembership"
      via: "auth import"
      pattern: "requireWorkspaceMembership"
    - from: "src/app/api/tickets/[id]/transition/route.ts"
      to: "canTransition"
      via: "transition validation"
      pattern: "canTransition"
---

<objective>
Create API routes for ticket CRUD, comments, stage transitions, approval flow, and reopen functionality.

Purpose: Backend logic for all ticketing operations with proper auth and validation.
Output: Complete API layer ready for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-support-ticketing/04-CONTEXT.md
@.planning/phases/04-support-ticketing/04-RESEARCH.md
@.planning/phases/04-support-ticketing/04-01-SUMMARY.md
@.planning/phases/04-support-ticketing/04-02-SUMMARY.md
@src/lib/auth/workspace-auth.ts
@src/lib/permissions/check.ts
@src/app/api/contacts/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ticket list and create routes</name>
  <files>src/app/api/tickets/route.ts</files>
  <action>
Create src/app/api/tickets/route.ts:

**GET /api/tickets** - List tickets in workspace
- Query params: workspaceId (required), stage (optional filter)
- Auth: requireWorkspaceMembership
- Returns: { tickets: Ticket[] } with requester and assignee joined

**POST /api/tickets** - Create new ticket
- Body: { workspaceId, title, description, category, priority }
- Auth: requireWorkspaceMembership (any member can create)
- Validation: title 3-255 chars, description non-empty, valid category/priority
- Sets requester_id to current user
- Returns: { ticket: Ticket }

Pattern from src/app/api/contacts/route.ts:
- Use createClient from @/lib/supabase/server
- Use requireWorkspaceMembership for auth
- Return NextResponse.json with proper status codes
- Handle errors with try/catch

Add to ticket_status_history on creation:
```sql
INSERT INTO ticket_status_history (ticket_id, changed_by, to_stage, reason)
VALUES (ticket.id, user.id, 'report', 'Tiket dibuat')
```
  </action>
  <verify>Test with curl: `curl -X GET "http://localhost:3000/api/tickets?workspaceId=..." -H "Cookie: ..."` should return 200</verify>
  <done>List and create endpoints working with proper auth</done>
</task>

<task type="auto">
  <name>Task 2: Create ticket detail and comment routes</name>
  <files>src/app/api/tickets/[id]/route.ts, src/app/api/tickets/[id]/comments/route.ts</files>
  <action>
**src/app/api/tickets/[id]/route.ts:**

**GET /api/tickets/[id]** - Get ticket detail
- Fetch ticket with requester and assignee
- Verify workspace membership using ticket.workspace_id
- Returns: { ticket: Ticket }

**PATCH /api/tickets/[id]** - Update ticket (assignment only)
- Body: { assigned_to }
- Auth: requirePermission('tickets:assign')
- Only owner/admin can assign tickets
- Returns: { ticket: Ticket }

**src/app/api/tickets/[id]/comments/route.ts:**

**GET /api/tickets/[id]/comments** - List comments
- Fetch comments with author joined
- Order by created_at ascending (oldest first for timeline)
- Returns: { comments: TicketComment[] }

**POST /api/tickets/[id]/comments** - Add comment
- Body: { content }
- Auth: any workspace member
- Sets author_id to current user
- Validation: content non-empty, max 10000 chars
- Returns: { comment: TicketComment }

Follow Next.js 15 pattern for route params:
```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params
  // ...
}
```
  </action>
  <verify>Test detail endpoint returns ticket with joined user data. Test comment creation adds to list.</verify>
  <done>Ticket detail and comments endpoints working</done>
</task>

<task type="auto">
  <name>Task 3: Create transition, approval, and reopen routes</name>
  <files>src/app/api/tickets/[id]/transition/route.ts, src/app/api/tickets/[id]/approval/route.ts, src/app/api/tickets/[id]/reopen/route.ts</files>
  <action>
**src/app/api/tickets/[id]/transition/route.ts:**

**POST /api/tickets/[id]/transition** - Move to next stage
- Body: { toStage, notifyParticipants?, comment? }
- Auth: Owner/admin OR assigned_to for normal transitions
- If isSkipTransition(fromStage, toStage): Sets pending_approval=true, pending_stage=toStage
- Otherwise: Updates stage directly
- Adds status_history entry
- If comment provided, adds system comment with is_stage_change=true
- notifyParticipants flag stored for email (handled in Plan 05)
- Returns: { success: true, pendingApproval?: boolean }

Use canTransition() and isSkipTransition() from @/lib/tickets:
```typescript
import { canTransition, isSkipTransition, STAGE_CONFIG } from '@/lib/tickets'
```

**src/app/api/tickets/[id]/approval/route.ts:**

**POST /api/tickets/[id]/approval** - Approve/reject stage skip
- Body: { approved: boolean }
- Auth: ONLY requester can approve/reject
- If approved: Update stage to pending_stage, clear pending_approval
- If rejected: Clear pending_approval, add rejection comment
- Add status_history entry
- Returns: { success: true }

**src/app/api/tickets/[id]/reopen/route.ts:**

**POST /api/tickets/[id]/reopen** - Reopen closed ticket
- Body: { token } OR authenticated requester
- Token verification using verifyReopenToken()
- If valid token OR authenticated as requester: Set stage='report', clear closed_at, clear reopen_token
- Add status_history entry
- Returns: { success: true }

Token endpoint allows anonymous access (for email link):
```typescript
// Check token first
const tokenResult = verifyReopenToken(body.token)
if (tokenResult && tokenResult.ticketId === ticketId) {
  // Valid token - proceed without auth
}
// Else check if authenticated requester
```
  </action>
  <verify>Test transition updates stage. Test approval only works for requester. Test reopen works with valid token.</verify>
  <done>All ticket management endpoints complete with proper validation</done>
</task>

</tasks>

<verification>
1. All 6 route files exist in src/app/api/tickets/
2. List endpoint filters by workspaceId
3. Create endpoint validates required fields
4. Transition uses canTransition() for validation
5. Skip transitions set pending_approval flag
6. Approval endpoint only allows requester to approve
7. Reopen works with HMAC token (anonymous) or authenticated requester
8. All endpoints use requireWorkspaceMembership
9. Status history entries created for all stage changes
</verification>

<success_criteria>
- Complete CRUD API for tickets
- Comments endpoint with flat timeline
- Transition respects state machine rules
- Approval flow for stage skipping
- Secure reopen via token or authenticated requester
- All routes follow existing codebase patterns
- Proper error responses (400, 401, 403, 404, 500)
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-ticketing/04-03-SUMMARY.md`
</output>
