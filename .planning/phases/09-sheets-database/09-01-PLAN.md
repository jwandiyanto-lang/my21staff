---
phase: 09-sheets-database
plan: 01
type: execute
---

<objective>
Create n8n workflow to sync Google Sheets data to Supabase contacts table.

Purpose: Enable importing leads/contacts from spreadsheets into the CRM database automatically.
Output: Working n8n workflow that reads from Google Sheets and upserts to contacts table.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-sheets-database/09-CONTEXT.md

**n8n Instance:** http://100.113.96.25:5678 (Tailscale)

**Target Schema (contacts table):**
- phone (VARCHAR 50, required, unique per workspace)
- name (VARCHAR 255)
- email (VARCHAR 255)
- lead_status (VARCHAR 50, default 'new')
- lead_score (INTEGER, default 0)
- tags (TEXT[])
- metadata (JSONB)

**Expected Sheet Columns:**
| Sheet Column | DB Field | Transform |
|--------------|----------|-----------|
| Name | name | Direct |
| Phone | phone | Format +62xxx |
| Email | email | Validate format |
| Status | lead_status | Map to enum |
| Notes | metadata.notes | JSON wrap |

**Workflow Structure:**
```
Schedule Trigger (hourly)
  → Google Sheets (Read all rows)
  → Code (Transform & validate)
  → Postgres (Upsert by phone)
```

**n8n Nodes:**
- nodes-base.scheduleTrigger (v1.2)
- nodes-base.googleSheets (v4.7)
- nodes-base.code (for transform)
- nodes-base.postgres (v2.6)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n workflow via API</name>
  <files>n8n workflow (external)</files>
  <action>
Create the workflow JSON and deploy to n8n instance:

1. Build workflow JSON with nodes:
   - Schedule Trigger: Run every hour
   - Google Sheets: Read operation, range A:F
   - Code: Transform sheet data to contacts schema
   - Postgres: Upsert operation on contacts table, match by phone

2. POST to n8n API at http://100.113.96.25:5678/api/v1/workflows

3. The Code node transform logic:
```javascript
// Transform sheet rows to contacts schema
return items.map(item => {
  const row = item.json;
  return {
    json: {
      phone: formatPhone(row.Phone),
      name: row.Name || null,
      email: row.Email || null,
      lead_status: mapStatus(row.Status) || 'new',
      lead_score: 0,
      metadata: { notes: row.Notes || '', source: 'google_sheets' }
    }
  };
});

function formatPhone(phone) {
  if (!phone) return null;
  let cleaned = phone.replace(/\D/g, '');
  if (cleaned.startsWith('0')) cleaned = '62' + cleaned.slice(1);
  if (!cleaned.startsWith('62')) cleaned = '62' + cleaned;
  return '+' + cleaned;
}

function mapStatus(status) {
  const map = { 'Baru': 'new', 'Panas': 'hot', 'Hangat': 'warm', 'Dingin': 'cold' };
  return map[status] || 'new';
}
```

4. Name workflow: "Sheets to Database Sync"
  </action>
  <verify>
Workflow appears in n8n UI at http://100.113.96.25:5678 with all 4 nodes connected.
  </verify>
  <done>Workflow created with Schedule Trigger → Google Sheets → Code → Postgres nodes.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure credentials in n8n UI</action>
  <instructions>
I created the workflow structure. Now you need to configure credentials in n8n:

**1. Google Sheets OAuth:**
- Open workflow in n8n UI
- Click Google Sheets node
- Click "Create New Credential"
- Select "OAuth2" → Connect Google Account
- Grant access to Google Sheets
- Select your spreadsheet and sheet name

**2. Postgres Connection (Supabase):**
- Click Postgres node
- Click "Create New Credential"
- Enter Supabase connection details:
  - Host: db.[project-ref].supabase.co
  - Database: postgres
  - User: postgres
  - Password: [from Supabase dashboard]
  - Port: 5432
  - SSL: Enable

**3. Set Workspace ID:**
- In the Code node, add workspace_id to the output
- Use the workspace UUID from your Supabase workspaces table

**4. Save and activate workflow**
  </instructions>
  <verification>Workflow shows "Active" status in n8n, no credential errors</verification>
  <resume-signal>Type "configured" when credentials are set up</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Google Sheets to Database sync workflow</what-built>
  <how-to-verify>
    1. Add test row to Google Sheet with: Name, Phone (+62xxx), Email, Status
    2. In n8n, click "Execute Workflow" to run manually
    3. Check execution log for success (green checkmarks)
    4. Query Supabase: SELECT * FROM contacts ORDER BY created_at DESC LIMIT 5
    5. Verify the test contact appears with correct data
    6. If working, enable schedule trigger for automatic hourly sync
  </how-to-verify>
  <resume-signal>Type "verified" if data syncs correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Workflow exists in n8n with 4 connected nodes
- [ ] Google Sheets credential connected and working
- [ ] Postgres credential connected to Supabase
- [ ] Manual execution successfully imports test row
- [ ] Contact appears in database with correct field mapping
- [ ] Schedule trigger enabled for automatic sync
</verification>

<success_criteria>

- Workflow deployed and active in n8n
- Google Sheets reads data successfully
- Data transforms correctly (phone format, status mapping)
- Postgres upsert works (inserts new, updates existing by phone)
- Hourly schedule running
</success_criteria>

<output>
After completion, create `.planning/phases/09-sheets-database/09-01-SUMMARY.md`:

# Phase 9 Plan 1: Sheets to Database Sync Summary

**[One-liner about what was accomplished]**

## Accomplishments

- n8n workflow created and activated
- Google Sheets → Database sync working
- Hourly schedule configured

## Configuration

- Workflow name: Sheets to Database Sync
- Schedule: Every hour
- Source: [Google Sheet URL]
- Target: contacts table

## Column Mapping

| Sheet | Database |
|-------|----------|
| Name | name |
| Phone | phone (+62 format) |
| Email | email |
| Status | lead_status |
| Notes | metadata.notes |

## Next Step

Phase 9 complete, v1.2 milestone finished.
</output>
