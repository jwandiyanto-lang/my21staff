---
phase: 13-lead-management-enhancement
plan: 01
type: execute
---

<objective>
Create contact update API and add status/score editing to contact detail sheet.

Purpose: Enable users to move leads through the pipeline and adjust lead scores directly from the CRM.
Output: Working PATCH endpoint for contacts, status dropdown and score slider in detail sheet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
@src/lib/lead-status.ts
@src/types/database.ts

**Established patterns:**
- API routes use Next.js App Router format (route.ts)
- Supabase client from @/lib/supabase/server
- Server actions pattern with revalidatePath
- Shadcn/ui components for UI

**Constraints:**
- Must validate workspace membership before allowing updates
- Use optimistic UI where appropriate
- Status values must match LeadStatus type
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact update API route</name>
  <files>src/app/api/contacts/[id]/route.ts</files>
  <action>
Create PATCH endpoint that:
1. Accepts { lead_status?, lead_score?, tags?, name?, email? } in body
2. Validates user is authenticated (getUser())
3. Validates contact exists and belongs to a workspace user has access to
4. Updates contact in Supabase
5. Returns updated contact

Use createClient from @/lib/supabase/server. Pattern reference: existing API routes in the codebase.

Validation:
- lead_status must be valid LeadStatus if provided
- lead_score must be 0-100 if provided
- tags must be string array if provided
  </action>
  <verify>curl -X PATCH localhost:3000/api/contacts/[test-id] -H "Content-Type: application/json" -d '{"lead_status":"hot_lead"}' returns 200 with updated contact (or 401 if not authenticated)</verify>
  <done>PATCH endpoint handles status, score, tags updates with proper auth validation</done>
</task>

<task type="auto">
  <name>Task 2: Add status dropdown and lead score slider to detail sheet</name>
  <files>src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx</files>
  <action>
Enhance ContactDetailSheet to allow editing:

1. **Status dropdown:**
   - Replace static Badge with Select dropdown
   - Use LEAD_STATUSES array for options
   - Style options with status colors
   - Call PATCH API on change
   - Show loading state during update
   - Optimistic update: change UI immediately, revert on error

2. **Lead score slider:**
   - Add Slider component below score display
   - Range 0-100, step 1
   - Debounce API calls (500ms) to avoid spam
   - Show current value updating in real-time
   - Call PATCH API after debounce

Use Shadcn Select and Slider components. Import useRouter for revalidation after update.

State management: useState for local edits, useTransition for loading states.
  </action>
  <verify>npm run build passes, dev server shows status dropdown and score slider in contact detail sheet</verify>
  <done>Status can be changed via dropdown, score via slider, changes persist to database</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] API route returns 401 for unauthenticated requests
- [ ] API route returns 404 for non-existent contact
- [ ] Status dropdown changes status and persists
- [ ] Score slider changes score and persists
- [ ] UI updates optimistically
</verification>

<success_criteria>

- Contact update API handles status, score, tags
- Detail sheet has working status dropdown
- Detail sheet has working score slider
- Changes persist to database
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-lead-management-enhancement/13-01-SUMMARY.md`
</output>
