---
phase: 13-lead-management-enhancement
plan: 03
type: execute
---

<objective>
Add AI handover toggle in inbox to pause/resume automation per conversation.

Purpose: Enable human agents to take over from AI when needed, and hand back when done.
Output: Handover button in inbox header, Kapso API integration for workflow status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-lead-management-enhancement/13-01-SUMMARY.md
@.planning/phases/13-lead-management-enhancement/13-02-SUMMARY.md

**Key files:**
@src/app/(dashboard)/[workspace]/inbox/message-thread.tsx
@src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
@src/lib/kapso/client.ts

**Kapso API (from docs):**
- PATCH /workflow_executions/{execution_id} â†’ status: "handoff" | "ended" | "waiting"
- PATCH /whatsapp/conversations/{conversation_id} â†’ close/reopen

**Current state:**
- AI Auto-Reply workflow runs on Kapso side (Phase 8)
- Our webhook syncs messages to Supabase
- No handover controls exist yet
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add handover API route and Kapso integration</name>
  <files>src/app/api/conversations/[id]/handover/route.ts, src/lib/kapso/client.ts</files>
  <action>
1. **Extend Kapso client** with handover methods:
   - `setHandover(conversationId: string, handoff: boolean)` - toggle AI automation
   - Use Kapso API: PATCH /whatsapp/conversations/{kapso_conversation_id}
   - Need to map our conversation ID to Kapso's conversation ID (may need to store or query)

2. **Create handover API route:**
   - POST /api/conversations/[id]/handover
   - Body: { handoff: boolean }
   - Validate user is authenticated and has workspace access
   - Call Kapso API to toggle handover
   - Update local conversation record with handover status (add `ai_paused` field if needed)
   - Return success/error

3. **Track handover state:**
   - Either query Kapso for current status, OR
   - Store `ai_paused: boolean` on conversations table locally
   - Simpler: store locally, sync to Kapso on toggle

Note: May need to check Kapso docs for exact conversation ID mapping. If Kapso uses phone number as conversation key, use that.
  </action>
  <verify>API route responds to POST with valid handover toggle, Kapso API called successfully</verify>
  <done>Handover API works, toggles AI state via Kapso</done>
</task>

<task type="auto">
  <name>Task 2: Add handover toggle button to inbox header</name>
  <files>src/app/(dashboard)/[workspace]/inbox/message-thread.tsx</files>
  <action>
Add handover control to message thread header:

1. **UI button:**
   - In header (next to contact name/status badge)
   - When AI active: "ðŸ¤– AI Active" button, click to "Take Over"
   - When human takeover: "ðŸ‘¤ You're responding" button, click to "Hand to AI"
   - Use Switch or Button component from Shadcn

2. **State management:**
   - Fetch current handover state (from conversation or local storage)
   - Call /api/conversations/[id]/handover on toggle
   - Show loading state during API call
   - Optimistic update with revert on error

3. **Visual feedback:**
   - Badge or indicator showing current mode (AI vs Human)
   - Toast notification on successful toggle

Keep it simple - single button that toggles state.
  </action>
  <verify>npm run build passes, handover button visible in inbox, clicking toggles state</verify>
  <done>Users can toggle AI/human control per conversation from inbox</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Handover API route exists and handles POST
- [ ] Kapso API called on toggle (check logs)
- [ ] UI shows current AI/human state
- [ ] Toggle button works and persists state
- [ ] AI stops responding after handover (test with real message if possible)
</verification>

<success_criteria>

- Handover toggle works end-to-end
- Users can take over from AI
- Users can hand back to AI
- State persists and displays correctly
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-lead-management-enhancement/13-03-SUMMARY.md`
</output>
