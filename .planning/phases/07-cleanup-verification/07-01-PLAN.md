---
phase: 07-cleanup-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/workspace-auth.ts
  - src/app/auth/callback/route.ts
  - src/app/api/auth/password-changed/route.ts
  - src/app/api/invitations/route.ts
  - src/app/api/invitations/accept/route.ts
  - src/app/api/invitations/set-password/route.ts
  - src/app/api/invitations/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Auth callback route deleted (Clerk handles OAuth/password reset)"
    - "Password change route deleted (Clerk handles)"
    - "Invitation system redirects to Clerk organization invites"
    - "workspace-auth helper uses Clerk + Convex instead of Supabase"
  artifacts:
    - path: "src/lib/auth/workspace-auth.ts"
      provides: "Clerk-based workspace auth helper"
      contains: "auth()"
    - path: "src/app/api/invitations/route.ts"
      provides: "Redirect to Clerk org invites"
      status: "deleted or redirects"
  key_links:
    - from: "src/lib/auth/workspace-auth.ts"
      to: "@clerk/nextjs/server"
      via: "auth() import"
      pattern: "from '@clerk/nextjs/server'"
---

<objective>
Remove Supabase auth infrastructure and migrate to Clerk auth system.

Purpose: Eliminate Supabase auth dependency - Clerk now handles all authentication, password reset, and organization invitations.
Output: Auth routes deleted/migrated, workspace-auth helper using Clerk
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-middleware-provider-auth-ui/02-01-SUMMARY.md
@.planning/phases/04-user-migration-organizations/04-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete Supabase auth routes</name>
  <files>
    src/app/auth/callback/route.ts
    src/app/api/auth/password-changed/route.ts
  </files>
  <action>
Delete these files entirely:
1. `src/app/auth/callback/route.ts` - Supabase OAuth callback (Clerk handles via /sign-in)
2. `src/app/api/auth/password-changed/route.ts` - Supabase password webhook (Clerk handles)

Also delete the containing directories if empty:
- `src/app/auth/` (if callback was the only file)

These routes are dead code - Clerk now handles:
- OAuth callbacks via [[...sign-in]] catch-all
- Password reset via Clerk hosted UI
- Email verification via Clerk
  </action>
  <verify>
Files no longer exist:
- `ls src/app/auth/callback/route.ts` returns "No such file"
- `ls src/app/api/auth/password-changed/route.ts` returns "No such file"
- No import errors when running `npm run build`
  </verify>
  <done>
Supabase auth routes deleted, no references remaining
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate workspace-auth helper to Clerk</name>
  <files>src/lib/auth/workspace-auth.ts</files>
  <action>
Rewrite workspace-auth.ts to use Clerk + Convex instead of Supabase:

```typescript
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'
import { type WorkspaceRole } from '@/lib/permissions/types'
import { NextResponse } from 'next/server'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export interface AuthResult {
  user: { id: string; email: string }
  workspaceId: string
  role: WorkspaceRole
}

export async function requireWorkspaceMembership(
  workspaceId: string
): Promise<AuthResult | NextResponse> {
  const { userId } = await auth()

  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // Get user from Convex
  const user = await convex.query(api.users.getByClerkId, { clerkId: userId })
  if (!user) {
    return NextResponse.json({ error: 'User not found' }, { status: 401 })
  }

  // Check workspace membership via Convex
  const member = await convex.query(api.workspaces.getMembership, {
    workspace_id: workspaceId,
    user_id: userId,
  })

  if (!member) {
    return NextResponse.json(
      { error: 'Not authorized to access this workspace' },
      { status: 403 }
    )
  }

  return {
    user: { id: userId, email: user.email || '' },
    workspaceId,
    role: member.role as WorkspaceRole
  }
}
```

Check if `api.workspaces.getMembership` exists. If not, add it to convex/workspaces.ts:
```typescript
export const getMembership = query({
  args: { workspace_id: v.string(), user_id: v.string() },
  handler: async (ctx, { workspace_id, user_id }) => {
    return await ctx.db
      .query("workspaceMembers")
      .withIndex("by_workspace_user", q =>
        q.eq("workspace_id", workspace_id).eq("user_id", user_id)
      )
      .first();
  },
});
```
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in workspace-auth.ts returns nothing
- Import from @clerk/nextjs/server present
  </verify>
  <done>
workspace-auth.ts uses Clerk auth() + Convex queries, no Supabase
  </done>
</task>

<task type="auto">
  <name>Task 3: Deprecate invitation routes (Clerk handles)</name>
  <files>
    src/app/api/invitations/route.ts
    src/app/api/invitations/accept/route.ts
    src/app/api/invitations/set-password/route.ts
    src/app/api/invitations/[id]/route.ts
  </files>
  <action>
The invitation system was for Supabase auth. Clerk handles invitations via OrganizationProfile (implemented in 04-05).

Option A (preferred): Delete these files entirely if no code references them.
Option B: Keep skeleton that returns error pointing to Clerk.

Check for references first:
```bash
grep -r "api/invitations" src/ --include="*.ts" --include="*.tsx"
```

If references exist in UI, update them to use Clerk's organization invite flow:
- Team page already uses Clerk OrganizationProfile (04-05)
- Any direct API calls should be removed

Delete all 4 files:
- `src/app/api/invitations/route.ts`
- `src/app/api/invitations/accept/route.ts`
- `src/app/api/invitations/set-password/route.ts`
- `src/app/api/invitations/[id]/route.ts`

Delete the directory if empty: `src/app/api/invitations/`

Also delete `src/app/(auth)/set-password/` page if it exists (only used by old invitations).
  </action>
  <verify>
- `ls src/app/api/invitations/` returns "No such file or directory"
- `npm run build` passes
- No references to `/api/invitations` in codebase
  </verify>
  <done>
Invitation routes deleted, team invitations work via Clerk OrganizationProfile
  </done>
</task>

</tasks>

<verification>
Run full build to verify no broken imports:
```bash
npm run build
```

Check no Supabase imports in auth files:
```bash
grep -r "supabase" src/lib/auth/ src/app/auth/ src/app/api/auth/ 2>/dev/null || echo "Clean"
```
</verification>

<success_criteria>
1. Auth callback route deleted (Clerk handles)
2. Password change route deleted (Clerk handles)
3. Invitation routes deleted (Clerk OrganizationProfile handles)
4. workspace-auth.ts uses Clerk + Convex
5. `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-01-SUMMARY.md`
</output>
