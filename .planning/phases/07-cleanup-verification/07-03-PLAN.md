---
phase: 07-cleanup-verification
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/contacts/export/route.ts
  - src/app/api/contacts/import/route.ts
  - src/app/api/contacts/merge/route.ts
  - src/app/api/contacts/[id]/notes/route.ts
  - src/app/api/notes/export/route.ts
  - src/app/api/leads/route.ts
autonomous: true

must_haves:
  truths:
    - "Contact export uses Convex"
    - "Contact import uses Convex"
    - "Contact merge uses Convex"
    - "Contact notes uses Convex"
    - "Notes export uses Convex"
    - "Leads route uses Convex"
  artifacts:
    - path: "src/app/api/contacts/export/route.ts"
      provides: "CSV export via Convex"
      contains: "convex"
    - path: "src/app/api/contacts/import/route.ts"
      provides: "CSV import via Convex"
      contains: "convex"
  key_links:
    - from: "All contact routes"
      to: "convex/contacts.ts"
      via: "ConvexHttpClient"
      pattern: "api\\.contacts\\."
---

<objective>
Migrate contact management API routes from Supabase to Convex.

Purpose: Remove Supabase dependencies from contact CRUD, import/export, and notes routes.
Output: All contact-related API routes use Convex + Clerk auth
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/contacts.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate contact export/import routes</name>
  <files>
    src/app/api/contacts/export/route.ts
    src/app/api/contacts/import/route.ts
  </files>
  <action>
**contacts/export/route.ts** - Export contacts to CSV:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function GET(request: NextRequest) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { searchParams } = new URL(request.url)
  const workspaceId = searchParams.get('workspace_id')

  if (!workspaceId) {
    return NextResponse.json({ error: 'workspace_id required' }, { status: 400 })
  }

  try {
    const contacts = await convex.query(api.contacts.listByWorkspace, {
      workspace_id: workspaceId
    })

    // Convert to CSV
    const headers = ['name', 'phone', 'email', 'lead_status', 'lead_score', 'tags', 'created_at']
    const csvRows = [headers.join(',')]

    for (const contact of contacts) {
      const row = [
        contact.name || '',
        contact.phone || '',
        contact.email || '',
        contact.lead_status || '',
        contact.lead_score?.toString() || '0',
        (contact.tags || []).join(';'),
        new Date(contact.created_at).toISOString()
      ].map(v => `"${v.replace(/"/g, '""')}"`)
      csvRows.push(row.join(','))
    }

    return new NextResponse(csvRows.join('\n'), {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="contacts-${Date.now()}.csv"`
      }
    })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to export contacts' }, { status: 500 })
  }
}
```

**contacts/import/route.ts** - Import contacts from CSV:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'
import { normalizePhone } from '@/lib/phone/normalize'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function POST(request: NextRequest) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const formData = await request.formData()
    const file = formData.get('file') as File
    const workspaceId = formData.get('workspace_id') as string

    if (!file || !workspaceId) {
      return NextResponse.json({ error: 'File and workspace_id required' }, { status: 400 })
    }

    const text = await file.text()
    const lines = text.split('\n').filter(l => l.trim())
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''))

    let imported = 0
    let skipped = 0

    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''))
      const row: Record<string, string> = {}
      headers.forEach((h, idx) => { row[h] = values[idx] || '' })

      const phone = row.phone
      if (!phone) {
        skipped++
        continue
      }

      const normalized = normalizePhone(phone) || phone

      try {
        await convex.mutation(api.contacts.upsertContact, {
          workspace_id: workspaceId,
          phone,
          phone_normalized: normalized,
          name: row.name || null,
          email: row.email || null,
          lead_status: row.lead_status || 'new',
          tags: row.tags ? row.tags.split(';') : [],
        })
        imported++
      } catch {
        skipped++
      }
    }

    return NextResponse.json({ imported, skipped })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to import contacts' }, { status: 500 })
  }
}
```

Add upsertContact mutation to convex/contacts.ts if missing:
```typescript
export const upsertContact = mutation({
  args: {
    workspace_id: v.string(),
    phone: v.string(),
    phone_normalized: v.string(),
    name: v.optional(v.union(v.string(), v.null())),
    email: v.optional(v.union(v.string(), v.null())),
    lead_status: v.optional(v.string()),
    tags: v.optional(v.array(v.string())),
  },
  handler: async (ctx, args) => {
    const existing = await ctx.db
      .query("contacts")
      .withIndex("by_workspace_phone", q =>
        q.eq("workspace_id", args.workspace_id).eq("phone_normalized", args.phone_normalized)
      )
      .first();

    if (existing) {
      await ctx.db.patch(existing._id, {
        name: args.name ?? existing.name,
        email: args.email ?? existing.email,
        lead_status: args.lead_status ?? existing.lead_status,
        tags: args.tags ?? existing.tags,
        updated_at: Date.now(),
      });
      return existing._id;
    } else {
      return await ctx.db.insert("contacts", {
        workspace_id: args.workspace_id,
        phone: args.phone,
        phone_normalized: args.phone_normalized,
        name: args.name ?? null,
        email: args.email ?? null,
        lead_status: args.lead_status ?? "new",
        lead_score: 0,
        tags: args.tags ?? [],
        created_at: Date.now(),
        updated_at: Date.now(),
      });
    }
  },
});
```
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in these files returns nothing
  </verify>
  <done>
Contact export/import routes migrated to Convex
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate contact merge, notes, and leads routes</name>
  <files>
    src/app/api/contacts/merge/route.ts
    src/app/api/contacts/[id]/notes/route.ts
    src/app/api/notes/export/route.ts
    src/app/api/leads/route.ts
  </files>
  <action>
**contacts/merge/route.ts** - Merge duplicate contacts:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function POST(request: NextRequest) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { primaryId, secondaryId, workspaceId } = await request.json()

  if (!primaryId || !secondaryId || !workspaceId) {
    return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
  }

  try {
    await convex.mutation(api.contacts.mergeContacts, {
      primary_id: primaryId,
      secondary_id: secondaryId,
      workspace_id: workspaceId,
    })
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to merge contacts' }, { status: 500 })
  }
}
```

**contacts/[id]/notes/route.ts** - Contact notes CRUD:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: contactId } = await params

  try {
    const notes = await convex.query(api.contacts.getNotes, { contact_id: contactId })
    return NextResponse.json(notes)
  } catch (error) {
    return NextResponse.json({ error: 'Failed to fetch notes' }, { status: 500 })
  }
}

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: contactId } = await params
  const { content, due_date, workspaceId } = await request.json()

  try {
    const noteId = await convex.mutation(api.contacts.createNote, {
      contact_id: contactId,
      workspace_id: workspaceId,
      user_id: userId,
      content,
      due_date: due_date || null,
    })
    return NextResponse.json({ id: noteId })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to create note' }, { status: 500 })
  }
}
```

**notes/export/route.ts** - Export notes to CSV (similar pattern to contacts export)

**leads/route.ts** - Legacy leads endpoint (check what it does, migrate or delete if obsolete)

Add needed mutations to convex/contacts.ts:
```typescript
export const mergeContacts = mutation({
  args: {
    primary_id: v.id("contacts"),
    secondary_id: v.id("contacts"),
    workspace_id: v.string(),
  },
  handler: async (ctx, { primary_id, secondary_id }) => {
    // Move conversations, notes to primary
    const conversations = await ctx.db
      .query("conversations")
      .withIndex("by_contact", q => q.eq("contact_id", secondary_id))
      .collect();
    for (const conv of conversations) {
      await ctx.db.patch(conv._id, { contact_id: primary_id });
    }
    // Delete secondary contact
    await ctx.db.delete(secondary_id);
  },
});

export const getNotes = query({
  args: { contact_id: v.string() },
  handler: async (ctx, { contact_id }) => {
    return await ctx.db
      .query("contactNotes")
      .withIndex("by_contact", q => q.eq("contact_id", contact_id))
      .order("desc")
      .collect();
  },
});

export const createNote = mutation({
  args: {
    contact_id: v.string(),
    workspace_id: v.string(),
    user_id: v.string(),
    content: v.string(),
    due_date: v.optional(v.union(v.number(), v.null())),
  },
  handler: async (ctx, args) => {
    return await ctx.db.insert("contactNotes", {
      ...args,
      created_at: Date.now(),
    });
  },
});
```
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in these files returns nothing
  </verify>
  <done>
Contact merge, notes, and leads routes migrated to Convex
  </done>
</task>

</tasks>

<verification>
Run full build:
```bash
npm run build
```

Verify no Supabase in contact routes:
```bash
grep -r "supabase" src/app/api/contacts/ src/app/api/notes/ src/app/api/leads/ 2>/dev/null || echo "Clean"
```
</verification>

<success_criteria>
1. Contact export uses Convex
2. Contact import uses Convex
3. Contact merge uses Convex
4. Contact notes use Convex
5. Notes export uses Convex
6. Leads route uses Convex (or deleted if obsolete)
7. `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-03-SUMMARY.md`
</output>
