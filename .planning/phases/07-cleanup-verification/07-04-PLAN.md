---
phase: 07-cleanup-verification
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/messages/send-media/route.ts
  - src/app/api/tickets/[id]/reopen/route.ts
  - src/app/api/tickets/[id]/transition/route.ts
  - src/app/api/tickets/[id]/approval/route.ts
  - src/app/api/tickets/[id]/attachments/route.ts
  - src/lib/storage/ticket-attachments.ts
autonomous: true

must_haves:
  truths:
    - "Message send-media uses Convex"
    - "Ticket reopen uses Convex"
    - "Ticket transition uses Convex"
    - "Ticket approval uses Convex"
    - "Ticket attachments use Convex file storage"
  artifacts:
    - path: "src/app/api/messages/send-media/route.ts"
      provides: "Media message sending via Convex"
      contains: "convex"
    - path: "src/lib/storage/ticket-attachments.ts"
      provides: "Convex file storage for attachments"
      contains: "convex"
  key_links:
    - from: "Attachment routes"
      to: "Convex storage"
      via: "storage.store()"
      pattern: "storage\\.store"
---

<objective>
Migrate message and ticket routes from Supabase to Convex, including file storage migration.

Purpose: Remove Supabase dependencies from messaging and ticket routes, migrate attachment storage to Convex.
Output: All message/ticket routes use Convex, attachments use Convex file storage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/tickets.ts
@convex/messages.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate message and ticket action routes</name>
  <files>
    src/app/api/messages/send-media/route.ts
    src/app/api/tickets/[id]/reopen/route.ts
    src/app/api/tickets/[id]/transition/route.ts
    src/app/api/tickets/[id]/approval/route.ts
  </files>
  <action>
**messages/send-media/route.ts** - Send media via WhatsApp:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function POST(request: NextRequest) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const formData = await request.formData()
  const conversationId = formData.get('conversationId') as string
  const file = formData.get('file') as File
  const caption = formData.get('caption') as string || ''

  if (!conversationId || !file) {
    return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
  }

  try {
    // Get conversation details from Convex
    const conversation = await convex.query(api.conversations.getById, {
      id: conversationId
    })

    if (!conversation) {
      return NextResponse.json({ error: 'Conversation not found' }, { status: 404 })
    }

    // For now, store media reference in message metadata
    // Actual media upload to WhatsApp uses Kapso API directly
    const messageId = await convex.mutation(api.messages.create, {
      conversation_id: conversationId,
      workspace_id: conversation.workspace_id,
      direction: 'outbound',
      sender_type: 'user',
      content: caption || '[Media]',
      message_type: file.type.startsWith('image/') ? 'image' : 'document',
      sender_id: userId,
    })

    return NextResponse.json({ success: true, messageId })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to send media' }, { status: 500 })
  }
}
```

**tickets/[id]/reopen/route.ts** - Reopen ticket:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: ticketId } = await params
  const { reason } = await request.json()

  try {
    await convex.mutation(api.tickets.reopenTicket, {
      ticket_id: ticketId,
      reason: reason || 'Reopened by user',
      user_id: userId,
    })
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to reopen ticket' }, { status: 500 })
  }
}
```

**tickets/[id]/transition/route.ts** - Transition ticket stage:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: ticketId } = await params
  const { stage, comment } = await request.json()

  try {
    await convex.mutation(api.tickets.transitionTicket, {
      ticket_id: ticketId,
      stage,
      comment,
      user_id: userId,
    })
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to transition ticket' }, { status: 500 })
  }
}
```

**tickets/[id]/approval/route.ts** - Approve/reject ticket:
Similar pattern - use Convex mutation `api.tickets.approveTicket` or `api.tickets.rejectTicket`

Add needed mutations to convex/tickets.ts if missing.
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in these files returns nothing
  </verify>
  <done>
Message and ticket action routes migrated to Convex
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate ticket attachments to Convex file storage</name>
  <files>
    src/app/api/tickets/[id]/attachments/route.ts
    src/lib/storage/ticket-attachments.ts
  </files>
  <action>
**Migrate to Convex file storage:**

1. Update ticket-attachments.ts to use Convex file storage:
```typescript
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']

export interface UploadResult {
  url: string
  storageId: string
  size: number
}

export async function uploadTicketAttachment(
  ticketId: string,
  file: File
): Promise<UploadResult> {
  if (!ALLOWED_TYPES.includes(file.type)) {
    throw new Error('Only images are allowed (JPEG, PNG, GIF, WebP)')
  }
  if (file.size > MAX_FILE_SIZE) {
    throw new Error('File size must be under 5MB')
  }

  // Get upload URL from Convex
  const uploadUrl = await convex.mutation(api.storage.generateUploadUrl, {})

  // Upload file to Convex storage
  const result = await fetch(uploadUrl, {
    method: 'POST',
    headers: { 'Content-Type': file.type },
    body: file,
  })

  if (!result.ok) {
    throw new Error('Failed to upload file')
  }

  const { storageId } = await result.json()

  // Get serving URL
  const url = await convex.query(api.storage.getUrl, { storageId })

  return {
    url: url || '',
    storageId,
    size: file.size,
  }
}

export async function deleteTicketAttachment(storageId: string): Promise<void> {
  await convex.mutation(api.storage.deleteById, { storageId })
}

export async function getAttachmentUrl(storageId: string): Promise<string> {
  const url = await convex.query(api.storage.getUrl, { storageId })
  return url || ''
}

export { MAX_FILE_SIZE, ALLOWED_TYPES }
```

2. Add storage functions to Convex (create convex/storage.ts if needed):
```typescript
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const generateUploadUrl = mutation({
  args: {},
  handler: async (ctx) => {
    return await ctx.storage.generateUploadUrl();
  },
});

export const getUrl = query({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, { storageId }) => {
    return await ctx.storage.getUrl(storageId);
  },
});

export const deleteById = mutation({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, { storageId }) => {
    await ctx.storage.delete(storageId);
  },
});
```

3. Update tickets/[id]/attachments/route.ts to use new storage:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { uploadTicketAttachment } from '@/lib/storage/ticket-attachments'

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: ticketId } = await params
  const formData = await request.formData()
  const file = formData.get('file') as File

  if (!file) {
    return NextResponse.json({ error: 'No file provided' }, { status: 400 })
  }

  try {
    const result = await uploadTicketAttachment(ticketId, file)
    return NextResponse.json(result)
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Upload failed'
    return NextResponse.json({ error: message }, { status: 400 })
  }
}
```
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in storage files returns nothing
- Convex storage functions exist
  </verify>
  <done>
Ticket attachments migrated to Convex file storage
  </done>
</task>

</tasks>

<verification>
Run full build:
```bash
npm run build
```

Verify no Supabase in message/ticket routes:
```bash
grep -r "supabase" src/app/api/messages/ src/app/api/tickets/ src/lib/storage/ 2>/dev/null || echo "Clean"
```
</verification>

<success_criteria>
1. Message send-media uses Convex
2. Ticket action routes use Convex
3. Ticket attachments use Convex file storage
4. Storage helper migrated to Convex
5. `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-04-SUMMARY.md`
</output>
