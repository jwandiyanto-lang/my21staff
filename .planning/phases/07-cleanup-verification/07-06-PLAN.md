---
phase: 07-cleanup-verification
plan: 06
type: execute
wave: 2
depends_on: ["07-01a", "07-01b", "07-02", "07-03", "07-04", "07-05"]
files_modified:
  - src/app/api/webhook/kapso/route.ts
  - src/lib/ari/processor.ts
  - src/lib/ari/handoff.ts
  - src/lib/ari/scheduling.ts
  - src/lib/ari/knowledge-base.ts
autonomous: true

must_haves:
  truths:
    - "Kapso webhook uses Convex for all database operations"
    - "ARI processor uses Convex instead of Supabase"
    - "ARI handoff uses Convex"
    - "ARI scheduling uses Convex"
    - "ARI knowledge-base uses Convex"
  artifacts:
    - path: "src/app/api/webhook/kapso/route.ts"
      provides: "WhatsApp message handling via Convex"
      contains: "convex"
    - path: "src/lib/ari/processor.ts"
      provides: "ARI processing via Convex"
      contains: "convex"
  key_links:
    - from: "src/app/api/webhook/kapso/route.ts"
      to: "convex/contacts.ts"
      via: "ConvexHttpClient"
      pattern: "api\\.contacts\\."
    - from: "src/lib/ari/processor.ts"
      to: "convex/ari.ts"
      via: "ConvexHttpClient"
      pattern: "api\\.ari\\."
---

<objective>
Migrate Kapso webhook and ARI system from Supabase to Convex.

Purpose: This is the largest migration - 580-line webhook + 999-line processor + supporting files. Critical for WhatsApp message handling.
Output: Kapso webhook and entire ARI system use Convex
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-data-migration/05-05-SUMMARY.md
@convex/ari.ts
@convex/contacts.ts
@convex/conversations.ts
@convex/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Kapso webhook to Convex</name>
  <files>src/app/api/webhook/kapso/route.ts</files>
  <action>
The Kapso webhook is 580 lines handling WhatsApp message ingestion. Migrate all Supabase calls to Convex.

**Key functions to migrate:**

1. `processWebhookAsync` - Replace `createApiAdminClient()` with ConvexHttpClient
2. `getOrCreateContactsBatch` - Use Convex contact queries/mutations
3. `getOrCreateConversationsBatch` - Use Convex conversation queries/mutations
4. `getKapsoCredentials` - Use Convex workspace query

**Pattern to follow:**

```typescript
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

// Replace Supabase query patterns:
// BEFORE: const { data } = await supabase.from('workspaces').select('...').eq('id', id)
// AFTER:  const data = await convex.query(api.workspaces.getById, { workspace_id: id })

// BEFORE: await supabase.from('contacts').insert(newContacts)
// AFTER:  await convex.mutation(api.contacts.createBatch, { contacts: newContacts })

// BEFORE: await supabase.from('messages').insert(messageInserts)
// AFTER:  await convex.mutation(api.messages.createBatch, { messages: messageInserts })
```

**Specific migrations:**

1. Workspace lookup by kapso_phone_id:
   - Add `api.workspaces.getByKapsoPhoneId` query if missing

2. Contact get/create batch:
   - Use existing `api.contacts.findByPhone` or add batch version
   - Use existing `api.contacts.create` or add batch version

3. Conversation get/create batch:
   - Use existing `api.conversations.getByContact` or add if missing
   - Use existing `api.conversations.create` or add if missing

4. Message insert batch:
   - Add `api.messages.createBatch` mutation for efficiency

5. Conversation update (unread count, last_message):
   - Add `api.conversations.updateLastMessage` mutation

6. ARI config check:
   - Use `api.ari.getConfig` query (should exist from 05-03)

7. Kapso credentials:
   - Add `api.workspaces.getKapsoCredentials` query

**Important:** Keep the same logic flow, just replace Supabase client calls with Convex calls. The webhook processing logic (message parsing, batching, ARI triggering) stays the same.

Add needed Convex functions as you migrate.
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in kapso webhook returns nothing
- grep for "createApiAdminClient" in kapso webhook returns nothing
  </verify>
  <done>
Kapso webhook uses Convex for all database operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate ARI system to Convex</name>
  <files>
    src/lib/ari/processor.ts
    src/lib/ari/handoff.ts
    src/lib/ari/scheduling.ts
    src/lib/ari/knowledge-base.ts
  </files>
  <action>
The ARI system is complex (999 lines in processor.ts alone). Migrate systematically.

**processor.ts key migrations:**

1. Replace `createApiAdminClient()` at top with ConvexHttpClient
2. `getOrCreateConversation` -> Use `api.ari.getConversationByContact` / `api.ari.upsertConversation`
3. `getConfig` -> Use `api.ari.getConfig`
4. `saveMessage` -> Use `api.ari.createMessage`
5. `updateConversationState` -> Use `api.ari.updateConversationState`
6. `getContact` / `updateContact` -> Use `api.contacts.*`

Pattern:
```typescript
// At top of file
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

// In functions, replace:
// const supabase = createApiAdminClient()
// const { data } = await supabase.from('ari_conversations')...
// WITH:
// const data = await convex.query(api.ari.getConversationByContact, {...})
```

**handoff.ts migrations:**
- `executeHandoff` -> Use `api.ari.createAppointment`, update conversation

**scheduling.ts migrations:**
- `getAvailableSlots` -> Use `api.ari.getSlots`
- `bookAppointment` -> Use `api.ari.createAppointment`
- Slot queries -> Use `api.ari.getSlotsForDay`

**knowledge-base.ts migrations:**
- `getDestinationsForCountry` -> Use `api.ari.getDestinations`
- `detectUniversityQuestion` -> Use `api.ari.getKnowledgeEntries`

Most of these Convex functions should already exist from Phase 5 (05-03 ARI API routes update). Check convex/ari.ts for existing functions.

**Critical:** The AI routing, state machine, and response generation logic does NOT change. Only the database access layer changes from Supabase to Convex.
  </action>
  <verify>
- `npm run build` passes
- grep for "supabase" in ARI files returns nothing
- grep for "createApiAdminClient" in ARI files returns nothing
  </verify>
  <done>
ARI system (processor, handoff, scheduling, knowledge-base) uses Convex
  </done>
</task>

</tasks>

<verification>
Run full build:
```bash
npm run build
```

Verify no Supabase in Kapso/ARI:
```bash
grep -r "supabase" src/app/api/webhook/kapso/ src/lib/ari/ 2>/dev/null || echo "Clean"
```
</verification>

<success_criteria>
1. Kapso webhook uses Convex
2. ARI processor uses Convex
3. ARI handoff uses Convex
4. ARI scheduling uses Convex
5. ARI knowledge-base uses Convex
6. `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-06-SUMMARY.md`
</output>
