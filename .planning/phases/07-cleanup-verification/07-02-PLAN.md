---
phase: 07-cleanup-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/workspace-members/[id]/route.ts
  - src/app/api/members/[id]/role/route.ts
  - src/app/api/workspaces/[id]/settings/route.ts
  - src/app/api/admin/clients/route.ts
  - convex/workspaces.ts
autonomous: true

must_haves:
  truths:
    - "Workspace member routes use Clerk + Convex"
    - "Role management uses Clerk organization roles"
    - "Workspace settings route uses Convex"
    - "Admin clients route uses Convex"
  artifacts:
    - path: "src/app/api/workspace-members/[id]/route.ts"
      provides: "Member management via Convex"
      contains: "convex"
    - path: "src/app/api/workspaces/[id]/settings/route.ts"
      provides: "Workspace settings via Convex"
      contains: "convex"
    - path: "convex/workspaces.ts"
      provides: "removeMember and updateMemberRole mutations"
      contains: "removeMember"
  key_links:
    - from: "All API routes in this plan"
      to: "convex/workspaces.ts"
      via: "ConvexHttpClient"
      pattern: "api\\.workspaces\\."
---

<objective>
Migrate workspace and member management API routes from Supabase to Convex.

Purpose: Remove Supabase dependencies from workspace/member management routes.
Output: All workspace-related API routes use Convex + Clerk auth
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/workspaces.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and add Convex mutations for member management</name>
  <files>convex/workspaces.ts</files>
  <action>
**PREREQUISITE CHECK:** Before modifying API routes, verify required Convex mutations exist.

1. Check for removeMember mutation:
```bash
grep -n "export const removeMember" convex/workspaces.ts || echo "NOT FOUND: removeMember"
```

2. Check for updateMemberRole mutation:
```bash
grep -n "export const updateMemberRole" convex/workspaces.ts || echo "NOT FOUND: updateMemberRole"
```

**If either is NOT FOUND**, add them to convex/workspaces.ts:

```typescript
export const removeMember = mutation({
  args: { member_id: v.id("workspaceMembers") },
  handler: async (ctx, { member_id }) => {
    const member = await ctx.db.get(member_id);
    if (!member) {
      throw new Error("Member not found");
    }
    await ctx.db.delete(member_id);
    return { success: true };
  },
});

export const updateMemberRole = mutation({
  args: { member_id: v.id("workspaceMembers"), role: v.string() },
  handler: async (ctx, { member_id, role }) => {
    const member = await ctx.db.get(member_id);
    if (!member) {
      throw new Error("Member not found");
    }
    if (!['owner', 'admin', 'member'].includes(role)) {
      throw new Error("Invalid role");
    }
    await ctx.db.patch(member_id, { role, updated_at: Date.now() });
    return { success: true };
  },
});
```

**Note:** These are different from the internal mutations in convex/organizations.ts which are for Clerk webhooks. These mutations are for direct API route calls using workspaceMembers table.

3. Verify after adding:
```bash
npx convex dev --once
```
  </action>
  <verify>
- `grep "export const removeMember" convex/workspaces.ts` returns match
- `grep "export const updateMemberRole" convex/workspaces.ts` returns match
- `npx convex dev --once` completes without errors
  </verify>
  <done>
Convex mutations for member management exist and are deployable
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate workspace member routes</name>
  <files>
    src/app/api/workspace-members/[id]/route.ts
    src/app/api/members/[id]/role/route.ts
  </files>
  <action>
Migrate these routes to use Clerk + Convex:

**workspace-members/[id]/route.ts** - DELETE member from workspace:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: memberId } = await params

  try {
    // Delete via Convex mutation
    await convex.mutation(api.workspaces.removeMember, { member_id: memberId })
    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('Error removing member:', error)
    return NextResponse.json({ error: 'Failed to remove member' }, { status: 500 })
  }
}
```

**members/[id]/role/route.ts** - Update member role:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: memberId } = await params
  const { role } = await request.json()

  if (!['owner', 'admin', 'member'].includes(role)) {
    return NextResponse.json({ error: 'Invalid role' }, { status: 400 })
  }

  try {
    await convex.mutation(api.workspaces.updateMemberRole, {
      member_id: memberId,
      role
    })
    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('Error updating role:', error)
    return NextResponse.json({ error: 'Failed to update role' }, { status: 500 })
  }
}
```
  </action>
  <verify>
- `npm run build` passes
- `grep "supabase" src/app/api/workspace-members/` returns nothing
- `grep "supabase" src/app/api/members/` returns nothing
  </verify>
  <done>
Member management routes use Convex + Clerk auth
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate workspace settings and admin routes</name>
  <files>
    src/app/api/workspaces/[id]/settings/route.ts
    src/app/api/admin/clients/route.ts
  </files>
  <action>
**workspaces/[id]/settings/route.ts** - Get/update workspace settings:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: workspaceId } = await params

  try {
    const workspace = await convex.query(api.workspaces.getById, {
      workspace_id: workspaceId
    })
    if (!workspace) {
      return NextResponse.json({ error: 'Workspace not found' }, { status: 404 })
    }
    return NextResponse.json(workspace)
  } catch (error) {
    return NextResponse.json({ error: 'Failed to fetch workspace' }, { status: 500 })
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id: workspaceId } = await params
  const updates = await request.json()

  try {
    await convex.mutation(api.workspaces.updateSettings, {
      workspace_id: workspaceId,
      ...updates
    })
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to update workspace' }, { status: 500 })
  }
}
```

**admin/clients/route.ts** - Admin list/create clients:
Check what this route does. If it lists workspaces for super-admin:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from '@/../convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

// Super admin check
const SUPER_ADMIN_IDS = ['user_38fViPWAnLiNth62ZaAJj3PQDWU'] // jwandiyanto@gmail.com

export async function GET(request: NextRequest) {
  const { userId } = await auth()
  if (!userId || !SUPER_ADMIN_IDS.includes(userId)) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const workspaces = await convex.query(api.workspaces.listAll, {})
    return NextResponse.json(workspaces)
  } catch (error) {
    return NextResponse.json({ error: 'Failed to fetch clients' }, { status: 500 })
  }
}
```

Add needed queries/mutations to convex/workspaces.ts if missing.
  </action>
  <verify>
- `npm run build` passes
- `grep "supabase" src/app/api/workspaces/` returns nothing
- `grep "supabase" src/app/api/admin/clients/` returns nothing
  </verify>
  <done>
Workspace settings and admin routes migrated to Convex
  </done>
</task>

</tasks>

<verification>
Run full build:
```bash
npm run build
```

Verify no Supabase in modified files:
```bash
grep -r "supabase" src/app/api/workspace-members/ src/app/api/members/ src/app/api/workspaces/ src/app/api/admin/clients/ 2>/dev/null || echo "Clean"
```
</verification>

<success_criteria>
1. Convex mutations for member management exist
2. workspace-members routes use Convex
3. Role management uses Convex
4. Workspace settings uses Convex
5. Admin clients route uses Convex
6. `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-verification/07-02-SUMMARY.md`
</output>
