---
phase: 10-sarah-bot-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - business_21/03_bots/Sarah-Kapso-Prompt.md
  - .planning/phases/10-sarah-bot-refinement/KAPSO-CLI-REFERENCE.md
autonomous: false
user_setup:
  - service: kapso-dashboard
    why: "Kapso API does not support workflow editing - must use Dashboard UI"
    dashboard_config:
      - task: "Update Sarah Agent node system prompt"
        location: "Kapso Dashboard > Workflows > Sarah Chat Bot > Sarah Agent node"
      - task: "Update check-keywords function code"
        location: "Kapso Dashboard > Workflows > Sarah Chat Bot > check-keywords function"
        action: "Replace handoff keywords array with updated list from Sarah-Kapso-Prompt.md"

must_haves:
  truths:
    - "Sarah messages are under 140 characters with conversational Indonesian tone"
    - "Sarah uses 'Kamu' pronoun (not Kak/Sis/Anda) and NO emojis"
    - "Sarah escalates to human when user requests handoff or conversation stalls"
    - "Sarah extracts lead fields in correct order: name, business_type, location, tenure, pain confirmation"
    - "User can message +62 813-1859-025 and see updated Sarah behavior immediately"
  artifacts:
    - path: "business_21/03_bots/Sarah-Kapso-Prompt.md"
      provides: "Production-ready system prompt for Kapso Agent node"
      min_lines: 80
    - path: ".planning/phases/10-sarah-bot-refinement/KAPSO-CLI-REFERENCE.md"
      provides: "CLI commands for future workflow modifications"
      min_lines: 50
  key_links:
    - from: "business_21/03_bots/Sarah-Kapso-Prompt.md"
      to: "Kapso Dashboard Agent node"
      via: "Manual copy-paste"
      pattern: "System prompt content"
---

<objective>
Refine Sarah bot persona and behavior to match the training manual, then document CLI workflow for future modifications.

Purpose: Sarah currently doesn't match the persona guide (Sarah-Training.md). This plan aligns the Kapso workflow with the documented behavior: professional Indonesian tone, no emojis, proper slot collection order, and correct handoff triggers.

Output:
1. Production-ready Kapso system prompt (Sarah-Kapso-Prompt.md)
2. CLI reference guide for future workflow changes
3. Updated Sarah behavior testable via live WhatsApp
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@business_21/03_bots/Sarah-Training.md
@.planning/phases/03-sarah-chat-bot/03-03-SUMMARY.md
@.kapso-project.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production Kapso system prompt from Sarah-Training.md</name>
  <files>business_21/03_bots/Sarah-Kapso-Prompt.md</files>
  <action>
Create a Kapso-ready system prompt by adapting Sarah-Training.md for the Agent node:

**Key changes from current prompt (in 03-03-SUMMARY.md) to Sarah-Training.md guidelines:**

1. **Tone & Style (CRITICAL DIFFERENCES):**
   - NO emojis (current prompt says "1-2 emoji" - WRONG)
   - Use "Kamu" pronoun (not Kakak/Kak)
   - Use "Saya" for self-reference
   - Never use "Anda" (too stiff)
   - Refer to company as "di sini" or "kita" (not repeating "my21staff")

2. **Message Rules:**
   - Maximum 1-2 sentences per message
   - Ask ONE question at a time (no double-barrel questions)
   - Keep under 140 characters

3. **Slot Collection Order (from Sarah-Training.md):**
   1. name - "Boleh tau nama kamu?"
   2. business_type - "Salam kenal [Nama]! Bisnisnya di bidang apa?"
   3. location - "Domisili di mana?"
   4. tenure - "Udah berapa lama bisnisnya jalan?"
   5. pain_confirmed - "Sekarang handle chat dan staff masih manual pakai spreadsheet/WhatsApp biasa, atau udah pakai tools khusus?"
   6. interest_confirmed - "If I... Will You?" close

4. **Language Detection:**
   - "Halo, mau tanya." → Indonesian
   - "Hi, I need info." → English
   - "Price?" → English
   - Default: Indonesian

5. **Price Deflection (Daniel G Philosophy):**
   - "Bisa saya jelasin harganya, tapi biar nggak salah kasih saran—tim kamu sekarang ada berapa orang? Soalnya beda paket."

6. **Closing (If I... Will You?):**
   - "Kalau saya bisa tunjukin cara pangkas waktu urus staff dari hitungan jam jadi menit pakai automation, kamu open buat liat cara kerjanya?"

7. **Validation Rules (data quality requirements):**
   - `name`: Non-empty string, min 2 characters
   - `business_type`: Free text, min 3 characters (e.g., "F&B", "Retail", "Service")
   - `location`: City/region name (e.g., "Jakarta", "Surabaya", "Bandung")
   - `tenure`: Duration format - accept variations like "2 tahun", "6 bulan", "baru mulai"
   - `pain_confirmed`: Boolean - true when user admits manual/spreadsheet pain (keywords: "manual", "spreadsheet", "ribet", "capek")
   - `interest_confirmed`: Boolean - true when user agrees to "If I... Will You?" close (keywords: "mau", "boleh", "ok", "iya", "yes")

8. **Handoff Triggers (SARAH-02 - for check-keywords function):**
   Include this list of keywords that trigger human handoff:
   ```
   human, manusia, person, sales, consultant, talk to someone,
   operator, cs, customer service, bicara dengan, ngobrol sama orang
   ```
   Also trigger handoff when conversation stalls (3+ messages without slot progress).

**Format the output as:**
```markdown
# Sarah - Kapso Agent System Prompt

## Instructions
[Copy-paste ready prompt for Kapso Agent node]

## Quick Reference
[Slot order, key phrases, handoff triggers, validation rules]

## check-keywords Function Code
[Copy-paste ready code for Kapso check-keywords function with handoff keywords array]

## Testing Checklist
[How to verify each behavior]
```
  </action>
  <verify>
- File exists at business_21/03_bots/Sarah-Kapso-Prompt.md
- Prompt contains NO emoji instructions (verify with grep)
- Prompt uses "Kamu" pronoun
- Slot collection order matches: name → business_type → location → tenure → pain_confirmed → interest_confirmed
- Price deflection phrase included
- "If I... Will You?" close included
- Validation rules section exists with format requirements for ALL 6 slots (name, business_type, location, tenure, pain_confirmed, interest_confirmed)
- check-keywords function code section exists with handoff keywords array
- Handoff keywords include at minimum: human, manusia, person, sales, consultant, bicara dengan
  </verify>
  <done>
Production-ready system prompt exists that matches Sarah-Training.md guidelines exactly, ready for copy-paste into Kapso Dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI reference for Kapso workflow modifications</name>
  <files>.planning/phases/10-sarah-bot-refinement/KAPSO-CLI-REFERENCE.md</files>
  <action>
Document all available methods to modify Kapso workflows for future reference:

**Section 1: Kapso Project Context**
```
Project: my21staff
Project ID: 1fda0f3d-a913-4a82-bc1f-a07e1cb5213c
Workflow: Sarah Chat Bot
Workflow ID: 048c075f-bab4-4ccd-920c-fe5e9a3435b5
Phone: +62 813-1859-025
Config ID: 827ce387-4f0a-4ca7-9e5a-0a3af01c9320
```

**Section 2: What CAN be done via API/CLI**
- Read workflow definition (GET)
- Read function code (GET)
- Create new functions (POST)
- Deploy functions (POST)
- Send test messages via MCP tools

**Section 3: What CANNOT be done via API/CLI (Dashboard only)**
- Edit existing workflow graph
- Edit Agent node system prompt
- Edit function code in workflow
- Change workflow trigger
- Add/remove nodes from workflow
- Set environment variables

**Section 4: MCP Tools Available (when connected to project)**
Note: Currently MCP is connected to Eagle project, not my21staff.
To use MCP tools for my21staff, would need to reconfigure MCP server.

Document these tools anyway for reference:
- `mcp__kapso__whatsapp_send_text_message` - Send test messages
- `mcp__kapso__whatsapp_get_contact_context` - Check conversation state
- `mcp__kapso__whatsapp_search_conversations` - Find conversations
- `mcp__kapso__whatsapp_configs_overview` - List phone configs

**Section 5: Testing Sarah Changes**
```bash
# 1. Make changes in Kapso Dashboard
# 2. Test via WhatsApp: message +62 813-1859-025
# 3. Check Convex state: curl https://intent-otter-212.convex.cloud/sarah/state?contact_phone=+62xxx
```

**Section 6: Troubleshooting**
- How to check if workflow is active
- How to view execution logs
- How to reset conversation state
  </action>
  <verify>
- File exists at .planning/phases/10-sarah-bot-refinement/KAPSO-CLI-REFERENCE.md
- Contains project IDs and workflow IDs
- Documents API limitations clearly
- Includes MCP tool reference
- Has testing commands
  </verify>
  <done>
CLI reference document exists with clear guidance on what can/cannot be automated, enabling future developers to quickly understand workflow modification options.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Update Sarah workflow in Kapso Dashboard</action>
  <instructions>
**You need to manually update the Sarah workflow in Kapso Dashboard:**

1. **Open Kapso Dashboard:**
   - URL: https://app.kapso.ai
   - Project: my21staff

2. **Navigate to Sarah Chat Bot workflow:**
   - Workflows > Sarah Chat Bot
   - Workflow ID: 048c075f-bab4-4ccd-920c-fe5e9a3435b5

3. **Update the Agent Node (Sarah) system prompt:**
   - Click on the "Sarah (Gemini 2.5 Flash)" Agent node
   - Replace the entire System Prompt with the content from:
     `business_21/03_bots/Sarah-Kapso-Prompt.md`
   - Ensure Max Tokens is set to 150
   - Ensure Temperature is 0.7

4. **Update check-keywords function (REQUIRED for SARAH-02):**
   - Navigate to check-keywords function node in workflow
   - Update handoff keywords array to match Sarah-Kapso-Prompt.md:
     `human, manusia, person, sales, consultant, talk to someone, operator, cs, customer service, bicara dengan, ngobrol sama orang`
   - This is REQUIRED - handoff behavior is controlled by this function, not the system prompt

5. **Save and Activate:**
   - Save workflow changes
   - Ensure workflow is Active (not Draft)

6. **Test immediately:**
   - Send a WhatsApp message to +62 813-1859-025
   - Say "Halo" and verify Sarah's response:
     - Uses "kamu" (not "kakak")
     - No emojis
     - Under 140 characters
     - Asks for name first
  </instructions>
  <resume-signal>
Type "tested" when you've completed ALL test cases below.

**REQUIRED TEST CASES (all must pass for SARAH-02 and TEST-01):**

Perform each test and report the ACTUAL response from Sarah:

**Test 1: Basic Response (tone/style)**
- Send: "Halo"
- Expected: Greeting with no emojis, uses "kamu" pronoun, under 140 characters
- [ ] PASS / FAIL - Paste response: ___

**Test 2: Slot Order (multi-turn conversation)**
- Continue conversation to collect 2-3 slots
- Expected: Asks name FIRST, then business_type, then location (in that order)
- [ ] PASS / FAIL - Describe slot collection order observed: ___

**Test 3: Handoff Trigger (SARAH-02 - check-keywords function)**
- In a NEW conversation, send: "human" or "mau bicara dengan orang"
- Expected: Sarah transfers to human/escalates (does NOT continue bot flow)
- [ ] PASS / FAIL - Describe what happened: ___

**Test 4: Stall Detection (3+ no-progress messages)**
- In a conversation, send 3+ off-topic messages (e.g., "hmm", "ok", "menarik")
- Expected: Sarah recognizes stall and offers handoff or redirects
- [ ] PASS / FAIL - Describe Sarah's behavior after 3+ stalls: ___

**Example valid Test 1 response:**
"Halo. Saya Sarah, Staff Digital my21staff. Gimana kabarnya?"
(Then: "Boleh tau nama kamu?")

**If ANY test fails:** Describe what's wrong. You may need to:
- Re-update the system prompt (Tests 1, 2, 4)
- Re-update check-keywords function (Test 3 - handoff keywords)
  </resume-signal>
</task>

</tasks>

<verification>
Phase 10 Plan 1 is complete when:
1. Sarah-Kapso-Prompt.md exists with proper guidelines (no emoji, correct pronouns, slot order)
2. KAPSO-CLI-REFERENCE.md documents all CLI/API capabilities and limitations
3. User has updated Kapso Dashboard with new prompt
4. User has tested Sarah via WhatsApp and confirmed correct behavior
</verification>

<success_criteria>
- Sarah responds in Indonesian with "kamu" pronoun when user says "Halo"
- Sarah's response contains NO emojis
- Sarah's response is under 140 characters
- Sarah asks for name as first slot collection question
- CLI reference document enables future workflow modifications
</success_criteria>

<output>
After completion, create `.planning/phases/10-sarah-bot-refinement/10-01-SUMMARY.md`
</output>
