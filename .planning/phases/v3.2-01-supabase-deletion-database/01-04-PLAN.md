---
phase: v3.2-01
plan: "04"
type: execute
wave: 3
depends_on: ["02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All Google Sheets leads appear in Contact Database (count matches within 5%)"
    - "n8n webhook creates contacts in Convex"
    - "Incremental sync works (only new leads added)"
  artifacts: []
  key_links:
    - from: "n8n workflow"
      to: "intent-otter-212.convex.site/webhook/n8n"
      via: "HTTP POST"
      pattern: "webhook/n8n"

deferred:
  - id: CLEAN-02
    description: "Remove Supabase env vars from Vercel"
    reason: "Deferred until after v3.2 deployment verification - env vars don't affect build, only billing"
    follow_up: "Can be done via Vercel dashboard after confirming app works in production"
---

<objective>
Verify n8n sync brings all Google Sheets leads into the Contact Database.

Purpose: Ensure Eagle's lead flow works - user reported "hundreds in Sheets but only 25 in database"
Output: All Google Sheets leads visible in Contact Database
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-CONTEXT.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-RESEARCH.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-02-SUMMARY.md
@convex/n8n.ts
@convex/http.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify n8n webhook endpoint is working</name>
  <files>None</files>
  <action>
Test the n8n webhook endpoint directly:

```bash
curl -X POST https://intent-otter-212.convex.site/webhook/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Lead",
    "phone": "+6281234567890",
    "email": "test@example.com",
    "lead_score": 50,
    "metadata": {"source": "manual_test"}
  }'
```

**Expected response:** JSON with success status and contact ID

If the webhook returns an error:
1. Check convex/http.ts has the /webhook/n8n route
2. Check convex/n8n.ts has the createLead mutation
3. Check Convex dashboard for function logs

After successful test, verify the contact appears:
- Go to Convex dashboard > Data > contacts table
- Find the test contact with phone +6281234567890
- Delete the test contact after verification
  </action>
  <verify>
1. Webhook returns 200 with contact ID
2. Contact appears in Convex contacts table
3. Test contact cleaned up
  </verify>
  <done>
n8n webhook endpoint functional. Creates contacts in Convex.
  </done>
</task>

<task type="auto">
  <name>Task 2: Check n8n workflow configuration</name>
  <files>None</files>
  <action>
Access n8n at http://100.113.96.25:5678 (via Tailscale) and review the Google Sheets sync workflow:

1. **Find the workflow:** Look for a workflow that reads from Google Sheets and posts to Convex
2. **Check the trigger:** Should be hourly schedule
3. **Check the HTTP Request node:**
   - URL should be: https://intent-otter-212.convex.site/webhook/n8n
   - Method: POST
   - Body: JSON with all Google Sheets columns mapped

**If workflow sends one row at a time:**
Check that ALL columns from Google Sheets are mapped to the JSON payload:
- name
- phone
- email
- lead_score (if calculated)
- metadata (should contain form answers)

**If workflow is missing or misconfigured:**
Document what needs to be fixed but DO NOT make changes yet. This will be addressed in the checkpoint.

**Check n8n execution history:**
- Are there recent successful executions?
- Any errors in the logs?
- How many items processed per execution?
  </action>
  <verify>
1. n8n workflow exists for Google Sheets sync
2. Workflow points to correct Convex webhook URL
3. Execution history shows recent runs
  </verify>
  <done>
n8n workflow configuration documented. Issues (if any) identified.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Verified n8n webhook endpoint and workflow configuration for Google Sheets sync.
  </what-built>
  <how-to-verify>
1. Go to http://localhost:3000/eagle-overseas/database (or production URL)
2. Check the total contact count - should match Google Sheets lead count

**Expected counts (for verification):**
- Note the exact contact count in the database UI
- Open Google Sheets and count total leads
- Counts should match within 5% (small gap acceptable due to sync timing)

3. If counts don't match significantly (>10% difference):
   - Open n8n (http://100.113.96.25:5678)
   - Find the Google Sheets sync workflow
   - Run it manually once
   - Refresh the Contact Database page
   - Verify new leads appear

**Questions to answer:**
- How many contacts are in the database now? (exact number)
- How many leads are in Google Sheets? (exact number)
- Did manual n8n run bring in missing leads?

If there's a significant gap, we may need to:
- Check if n8n is filtering some rows
- Check if duplicate detection is blocking inserts
- Run a one-time full sync
  </how-to-verify>
  <resume-signal>
Describe the sync status: "[X] contacts in database, [Y] in Sheets, sync [working/needs-fix]"
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. n8n webhook creates contacts successfully
2. n8n workflow is configured correctly
3. User verified lead counts match (or identified gap to fix)
</verification>

<success_criteria>
- n8n webhook endpoint responds to POST requests
- Contacts created via webhook appear in database
- User confirms Google Sheets leads are syncing (counts within 5%)
- Any sync issues documented for follow-up
</success_criteria>

<output>
After completion, create `.planning/phases/v3.2-01-supabase-deletion-database/01-04-SUMMARY.md`
</output>
