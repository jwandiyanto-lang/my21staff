---
phase: 09-testing-polish
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/[workspace]/inbox/page.tsx
  - src/components/dashboard/lead-detail-sheet.tsx
autonomous: false

must_haves:
  truths:
    - "CRM inbox displays Kapso embedded inbox"
    - "Inbox feels native (full height, seamless styling)"
    - "Lead detail panel links to Kapso conversation"
    - "User can message from embedded Kapso inbox"
  artifacts:
    - path: "src/app/[workspace]/inbox/page.tsx"
      provides: "Kapso iframe embed with seamless styling"
    - path: "src/components/dashboard/lead-detail-sheet.tsx"
      provides: "Link from lead to Kapso conversation"
  key_links:
    - from: "Inbox page"
      to: "Kapso inbox embed"
      via: "iframe https://inbox.kapso.ai/embed/Cv9A2966GyrRtqhSTrlLG4gUoPcN4SvaJNylE8yhphk"
    - from: "Lead detail panel"
      to: "Kapso conversation"
      via: "Link to Kapso inbox with conversation filter"
---

<objective>
Embed Kapso inbox iframe to mirror Kapso functionality in CRM and connect leads to conversations.

Purpose: Leverage Kapso's production-ready inbox instead of building custom. CRM becomes the primary interface while Kapso handles messaging infrastructure.
Output: Seamless embedded inbox + lead-to-conversation linking.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-testing-polish/09-CONTEXT.md
@src/app/[workspace]/inbox/page.tsx
@src/components/dashboard/lead-detail-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace custom inbox with Kapso iframe embed</name>
  <files>src/app/[workspace]/inbox/page.tsx</files>
  <action>
Replace the current custom inbox implementation with Kapso iframe embed:

1. Read the current inbox page structure
2. Replace the content with iframe embed:

```tsx
<iframe
  src="https://inbox.kapso.ai/embed/Cv9A2966GyrRtqhSTrlLG4gUoPcN4SvaJNylE8yhphk"
  style={{ width: '100%', height: '100%', border: 0 }}
  className="w-full h-full"
  title="WhatsApp Inbox"
/>
```

3. Ensure the parent container has proper height (100vh or flex-1)
4. Remove unnecessary custom inbox components if they're no longer used
5. Keep the page layout structure (sidebar should still be visible)

Styling goals:
- Full height (no scrollbars within iframe)
- Seamless appearance (no borders, padding matches CRM)
- Responsive (works on mobile/tablet/desktop)

Note: The embed URL is workspace-specific, so this will show all conversations for the my21staff Kapso workspace.
  </action>
  <verify>Inbox page renders Kapso iframe with seamless styling</verify>
  <done>Kapso inbox embedded in CRM inbox page</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Kapso inbox iframe embedded in CRM</what-built>
  <how-to-verify>
Test the embedded inbox in production:

1. Deploy the changes (if not auto-deployed)
2. Go to www.my21staff.com and sign in
3. Navigate to Inbox in the sidebar
4. Observe the embedded Kapso inbox

Check:
- Does the Kapso inbox load? (yes/no)
- Can you see conversations? (yes/no)
- Can you click a conversation and view messages? (yes/no)
- Does it feel seamless (no obvious iframe borders)? (yes/no)
- Can you send a test message? (yes/no)

If issues:
- Check browser console for errors
- Verify iframe src URL is correct
- Check if there are CORS or embedding restrictions
- Screenshot the result

Target: Inbox should feel like a native part of the CRM, not an embedded iframe.
  </how-to-verify>
  <resume-signal>Type "inbox-embed-works" if successful, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Add lead-to-conversation linking</name>
  <files>src/components/dashboard/lead-detail-sheet.tsx</files>
  <action>
Connect leads to their Kapso conversations for easy navigation:

1. Read lead-detail-sheet.tsx to understand current structure
2. Find the contact/lead data being displayed
3. Add a "View in Inbox" button or link that:
   - Opens the Inbox page
   - Optionally filters to the specific conversation (if Kapso embed supports query params)
   - Uses the contact's phone number to identify the conversation

Implementation:
```tsx
<Button
  variant="outline"
  onClick={() => {
    // Navigate to inbox with conversation filter
    router.push(`/${workspaceSlug}/inbox?phone=${contact.phone}`)
  }}
>
  <MessageSquare className="h-4 w-4 mr-2" />
  View in Inbox
</Button>
```

Alternative approach if Kapso embed supports conversation ID in URL:
```tsx
// If we know the Kapso conversation ID
router.push(`/${workspaceSlug}/inbox?conversation=${kapsoConversationId}`)
```

Note: Research if Kapso embed URL supports query parameters for pre-selecting conversations. If not, just navigate to inbox and user can search by phone.
  </action>
  <verify>"View in Inbox" button added to lead detail panel</verify>
  <done>Leads connected to Kapso conversations via navigation button</done>
</task>

<task type="auto">
  <name>Task 3: Store Kapso conversation IDs in Convex</name>
  <files>convex/schema.ts, convex/contacts.ts</files>
  <action>
To properly link leads to conversations, store Kapso conversation IDs:

1. Check current contacts schema for kapso_conversation_id field
2. If missing, add it:
```typescript
contacts: defineTable({
  // ... existing fields
  kapso_conversation_id: v.optional(v.string()),
  // ... rest of schema
})
```

3. Update the webhook sync or Sarah state sync to populate this field
4. When a message comes in from Kapso, extract the conversation ID
5. Store it in the contact record for future reference

This enables:
- Direct linking to specific conversations
- Tracking which leads have active WhatsApp conversations
- Syncing conversation metadata (last message, unread count, etc.)

If schema already has this field, verify it's being populated by the webhook.
  </action>
  <verify>Kapso conversation IDs stored in contacts table</verify>
  <done>Convex contacts linked to Kapso conversations via stored IDs</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Lead-to-conversation linking with stored Kapso IDs</what-built>
  <how-to-verify>
Test lead-to-inbox navigation:

1. Go to www.my21staff.com and sign in
2. Navigate to Leads (Database page)
3. Click on the test lead from Sarah conversation
4. Look for "View in Inbox" button in the lead detail panel
5. Click the button

Check:
- Does it navigate to the Inbox page? (yes/no)
- Does it show the correct conversation? (yes/no)
- If not, can you manually find the conversation by phone? (yes/no)

Then verify data sync:
1. Send a new WhatsApp message to the number
2. Check if Kapso conversation ID is stored in Convex
3. Use Convex dashboard to inspect the contacts table
4. Look for kapso_conversation_id field

If conversation ID is missing:
- Check webhook logs for incoming messages
- Verify the sync logic is extracting conversation IDs
- May need to trigger a manual sync

Share the results.
  </how-to-verify>
  <resume-signal>Type "lead-linking-works" if successful, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Polish and verify end-to-end flow</name>
  <files>src/app/[workspace]/inbox/page.tsx, src/components/dashboard/lead-detail-sheet.tsx</files>
  <action>
Final polish for seamless user experience:

1. Verify styling matches CRM theme:
   - Iframe container has proper height
   - No visual glitches or layout shifts
   - Loading state while iframe loads (optional spinner)

2. Test full flow:
   - Start from Leads page
   - Click a lead with conversation history
   - Click "View in Inbox"
   - See the conversation in embedded Kapso inbox
   - Send a test message
   - Verify message appears in Kapso

3. Document any limitations:
   - Can we pre-select conversations via URL params?
   - Does the embed support all Kapso inbox features?
   - Are there any CORS or security restrictions?

4. Update STATE.md with new architecture decision:
   - "Embedded Kapso inbox" replaces custom inbox implementation
   - Rationale: Leverage production-ready Kapso features
   - Trade-offs: Less customization, but faster delivery and reliability

This completes the pivot to embedded Kapso inbox.
  </action>
  <verify>End-to-end flow works: Lead → Inbox → Message → Kapso</verify>
  <done>CRM mirrors Kapso with embedded inbox, leads connected to conversations</done>
</task>

</tasks>

<verification>
1. Inbox page displays Kapso iframe embed
2. Iframe is styled seamlessly (full height, no borders)
3. Lead detail panel has "View in Inbox" button
4. Kapso conversation IDs stored in Convex contacts
5. Navigation from lead to inbox works
6. Messages sent via embed appear in Kapso
</verification>

<success_criteria>
- CRM inbox mirrors Kapso functionality via iframe
- Seamless appearance (feels native, not embedded)
- Leads connected to conversations (via stored IDs or phone search)
- User can message directly from CRM inbox
- No degradation in messaging experience compared to native Kapso
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing-polish/09-02-SUMMARY.md`
</output>
