---
phase: 09-testing-polish
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/components/dashboard/lead-detail-sheet.tsx
autonomous: false

must_haves:
  truths:
    - "Lead detail panel shows AI-generated notes"
    - "Grok summary appears for leads with conversation history"
    - "Notes can be manually refreshed"
  artifacts:
    - path: "src/components/dashboard/lead-detail-sheet.tsx"
      provides: "Lead detail with Brain notes display"
  key_links:
    - from: "lead-detail-sheet.tsx"
      to: "api.brainSummaries.getLatestForContact"
      via: "useQuery"
    - from: "Grok API"
      to: "brainSummaries table"
      via: "generateDailySummary action"
---

<objective>
Verify Brain/Grok notes generation and display in lead detail panel.

Purpose: Brain provides practical AI note-taking from conversations to help sales follow-up.
Output: Verified notes appear in lead panel with any fixes applied.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-testing-polish/09-CONTEXT.md
@convex/brainSummaries.ts
@convex/brainAnalysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze Brain summary generation flow</name>
  <files>convex/brainSummaries.ts, convex/brainAnalysis.ts</files>
  <action>
Review how Brain summaries are generated and stored:

1. Read brainSummaries.ts - understand the schema and queries
2. Read brainAnalysis.ts - understand the Grok integration
3. Document the current flow:
   - Daily cron: When does it run? (01:00 UTC / 09:00 WIB)
   - What triggers summary generation?
   - Where are summaries stored?
   - How are they queried?

Check for:
- Is Grok API key configured?
- Is the daily cron active?
- Are there any summaries in the database?

Use Convex dashboard or queries to check existing summaries.
  </action>
  <verify>Brain summary flow documented</verify>
  <done>Understand how summaries flow from Grok to database to UI</done>
</task>

<task type="auto">
  <name>Task 2: Check lead detail panel integration</name>
  <files>src/components/dashboard/lead-detail-sheet.tsx</files>
  <action>
Verify the lead detail panel displays Brain notes:

1. Read lead-detail-sheet.tsx
2. Find where Brain summaries are queried and displayed
3. Check if there's a manual refresh button
4. Verify the UI for notes display

Expected integration:
- useQuery for latest summary for the contact
- Display area for summary text
- Refresh button to trigger on-demand generation
- Loading state while summary generates

If integration is missing:
- Document what needs to be added
- Note the specific location in the component
  </action>
  <verify>Lead detail panel has Brain notes integration (or documented gaps)</verify>
  <done>Brain notes UI integration verified or gaps identified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Analyzed Brain summary integration in lead detail panel</what-built>
  <how-to-verify>
Test Brain notes in production:

1. Go to www.my21staff.com and sign in
2. Navigate to Leads (Database page)
3. Click on the test lead from Sarah conversation
4. Look for the AI Notes / Brain Summary section

Check:
- Is there a notes/summary section visible? (yes/no)
- If yes, does it show any content? (yes/no)
- Is there a refresh button? (yes/no)
- If you click refresh, does it generate a summary? (yes/no)

If no notes section:
- Describe what's shown in the lead detail panel
- We may need to add this integration

If notes section exists but empty:
- Check if Grok API is configured in environment
- Check Convex function logs for errors

Share what you see in the lead detail panel.
  </how-to-verify>
  <resume-signal>Type "brain-notes-working" if notes appear, or describe what you see</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Fix or implement Brain notes display (if needed)</name>
  <files>src/components/dashboard/lead-detail-sheet.tsx</files>
  <action>
Based on checkpoint findings, implement or fix Brain notes:

If notes section is MISSING:
1. Add a "AI Summary" section to lead-detail-sheet.tsx
2. Query: useQuery(api.brainSummaries.getLatestForContact, { contact_id })
3. Display the summary text with timestamp
4. Add refresh button that triggers generateCommandSummary

If notes section EXISTS but EMPTY:
1. Check if getLatestForContact query is working
2. Verify contact_id is being passed correctly
3. Add fallback message: "No AI summary yet. Click refresh to generate."
4. Implement refresh button functionality

If notes section is WORKING:
1. Verify styling matches the rest of the panel
2. Ensure timestamp formatting is consistent
3. Add loading indicator during refresh

Use existing patterns from the component for consistency.
  </action>
  <verify>Brain notes section displays in lead detail panel</verify>
  <done>Brain notes integrated and displaying (or generating on refresh)</done>
</task>

</tasks>

<verification>
1. Brain summary generation flow documented
2. Lead detail panel has notes section
3. Notes query fetches from Convex correctly
4. Refresh button triggers new summary generation
5. Summary text displays with timestamp
</verification>

<success_criteria>
- AI notes section visible in lead detail panel
- Existing summaries display correctly
- Refresh button generates new summary (if Grok API configured)
- Graceful handling when no summary exists
- Silent retry on API failures (no user-facing errors)
</success_criteria>

<output>
After completion, create `.planning/phases/09-testing-polish/09-03-SUMMARY.md`
</output>
