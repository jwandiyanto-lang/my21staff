---
phase: 06-ui-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/settings/page.tsx
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settings page loads without React errors or crashes in production"
    - "Settings page displays all sections (General, Lead Stages, ARI)"
    - "AI status toggle is visible and reflects workspace configuration"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      provides: "Client component that fetches AI config with Clerk auth context"
      exports: ["SettingsClient"]
    - path: "src/app/(dashboard)/[workspace]/settings/page.tsx"
      provides: "Server component that only fetches workspace (no auth required)"
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/[workspace]/settings/page.tsx"
      to: "api.workspaces.getBySlug"
      via: "fetchQuery during SSR"
      pattern: "fetchQuery\\(api\\.workspaces\\.getBySlug"
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "api.ari.getAriConfig"
      via: "useQuery with Clerk context"
      pattern: "useQuery\\(api\\.ari\\.getAriConfig"
---

<objective>
Fix Settings page SSR auth crash by moving AI config fetch from server component to client component.

Purpose: Settings page crashes with server-side exception because it calls auth-protected Convex query during SSR without Clerk auth context. The fix separates concerns: server component fetches public workspace data (no auth), client component fetches auth-protected AI config (with Clerk context via ClerkProvider).

Output: Settings page loads successfully in production without server-side exceptions.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/planning/STATE.md

@/home/jfransisco/Desktop/21/my21staff/planning/debug/settings-page-crash.md
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/settings/page.tsx
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/settings/settings-client.tsx
@/home/jfransisco/Desktop/21/my21staff/convex/ari.ts
</context>

<tasks>

<task type="auto">
  <name>Move AI config fetch from server to client component</name>
  <files>
    src/app/(dashboard)/[workspace]/settings/page.tsx
    src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  </files>
  <action>
**Context - Why Previous Attempts Failed:**

Commit 40fb338 ("fix: resolve Clerk hooks Rules of Hooks violations") fixed a DIFFERENT bug - it moved `useAuth()` and `useUser()` calls out of conditional branches to satisfy React's Rules of Hooks. That fix made Database and Settings pages LOAD, but Settings STILL crashes in production with SSR auth errors.

The root cause was NEVER addressed: Settings page.tsx (server component) still calls `fetchQuery(api.ari.getAriConfig)` during SSR at line 48. This query requires authentication via `requireWorkspaceMembership`, which calls `getAuthUserId(ctx)`. In SSR context, Clerk auth is unavailable, so `getAuthUserId` returns null and throws "Unauthorized" error.

**This plan addresses the actual root cause** by moving the auth-protected query from SSR to client-side where Clerk context exists.

**Root Cause:** Settings page is a server component that calls `fetchQuery(api.ari.getAriConfig)` during SSR (line 48). The `getAriConfig` query requires authentication via `requireWorkspaceMembership`, which calls `getAuthUserId(ctx)` to get Clerk user ID. In SSR context, Clerk auth is unavailable, causing `getAuthUserId` to return null and throwing "Unauthorized" error.

**Fix Strategy:** Move the auth-protected `getAriConfig` query from server component (SSR) to client component where ClerkProvider context is available.

**Step 1: Update page.tsx (server component)**

Remove the ARI config fetch that's causing the SSR crash:

1. Find lines 47-53 where `getAriConfig` is called:
   ```tsx
   // Get ARI config to check if AI is enabled
   const ariConfig = await fetchQuery(api.ari.getAriConfig, {
     workspace_id: workspace._id,
   })

   const aiEnabled = ariConfig?.enabled !== false
   ```
   DELETE these lines entirely.

2. Remove `aiEnabled` from the props passed to SettingsClient:
   ```tsx
   // BEFORE:
   <SettingsClient workspace={workspace} aiEnabled={aiEnabled} />

   // AFTER:
   <SettingsClient workspace={workspace} />
   ```

3. If `fetchQuery` is no longer used in the file, remove it from imports.

**Step 2: Update settings-client.tsx (client component)**

Add AI config fetch on client side where Clerk auth is available:

1. Remove `aiEnabled` from component props:
   ```tsx
   // BEFORE:
   interface SettingsClientProps {
     workspace: any
     aiEnabled: boolean
   }

   // AFTER:
   interface SettingsClientProps {
     workspace: any
   }
   ```

2. Add Convex imports at the top:
   ```tsx
   import { useQuery } from 'convex/react'
   import { api } from '@/convex/_generated/api'
   ```

3. Inside the SettingsClient component function (after the function declaration), add client-side query:
   ```tsx
   export default function SettingsClient({ workspace }: SettingsClientProps) {
     const isDevMode = process.env.NEXT_PUBLIC_DEV_MODE === 'true'

     // Fetch AI config on client side with Clerk auth context
     const ariConfig = useQuery(
       api.ari.getAriConfig,
       isDevMode ? 'skip' : { workspace_id: workspace.id }
     )

     // In dev mode, default to enabled. In production, wait for query result.
     const aiEnabled = isDevMode ? true : (ariConfig?.enabled !== false)

     // ... rest of component code ...
   }
   ```

4. Handle loading state: The component should already handle the case where `aiEnabled` might be undefined initially (while `ariConfig` loads).

**Why this fixes the crash:**

1. Server component (page.tsx) only calls `api.workspaces.getBySlug` which has NO auth check
2. Client component (settings-client.tsx) calls `api.ari.getAriConfig` which HAS auth check
3. Client component runs in browser where ClerkProvider provides auth context
4. `getAuthUserId(ctx)` in Convex query now returns valid user ID from Clerk session
5. No more "Unauthorized" error, page loads successfully

**Dev mode handling:** Dev mode check ensures localhost testing works without Convex/Clerk.
  </action>
  <verify>
1. Test localhost: `npm run dev` and visit http://localhost:3000/demo/settings
   - Page should load without errors
   - Console should show no React errors

2. Check the changes:
   ```bash
   grep -n "fetchQuery.*getAriConfig" src/app/(dashboard)/[workspace]/settings/page.tsx
   ```
   Should return NO results (query removed from server component)

   ```bash
   grep -n "useQuery.*getAriConfig" src/app/(dashboard)/[workspace]/settings/settings-client.tsx
   ```
   Should show the client-side query

3. Deploy and test production:
   - Navigate to Settings page
   - Should load without server-side exception
   - All settings sections visible
   - AI toggle reflects workspace config
  </verify>
  <done>
Settings page loads successfully in both localhost and production. No server-side exceptions. AI status is fetched client-side with proper Clerk authentication. All settings sections display correctly.
  </done>
</task>

</tasks>

<verification>
**Localhost test:**
1. `npm run dev`
2. Visit http://localhost:3000/demo/settings
3. Page loads without errors
4. No console errors about auth or SSR

**Production test:**
1. Navigate to Settings page at my21staff.com
2. Page loads without crash (no Digest: 2181255606 error)
3. All sections visible: General, Lead Stages, ARI
4. AI toggle displays correct state

**Code verification:**
```bash
# Verify query removed from server component
grep -c "getAriConfig" src/app/(dashboard)/[workspace]/settings/page.tsx
# Should be 0

# Verify query added to client component
grep -c "useQuery.*getAriConfig" src/app/(dashboard)/[workspace]/settings/settings-client.tsx
# Should be 1 or more
```
</verification>

<success_criteria>
- Settings page loads in production without SSR errors
- AI config fetched client-side with Clerk auth context
- Server component only fetches public workspace data
- Dev mode continues to work with mock data
- No "Unauthorized" errors in Convex logs
</success_criteria>

<output>
After completion, create `planning/phases/06-ui-polish/06-03-SUMMARY.md`
</output>
