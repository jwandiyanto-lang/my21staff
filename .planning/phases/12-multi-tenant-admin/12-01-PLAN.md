---
phase: 12-multi-tenant-admin
plan: 01
type: execute
---

<objective>
Build multi-tenant admin system where owner (Jonathan) can manage all client workspaces, and clients login with temporary credentials they must change on first login.

Purpose: Proper SaaS multi-tenancy with admin oversight and client self-service.
Output: Admin dashboard + client onboarding flow with password change.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Current State:**
- 2 workspaces exist (My21Staff, Eagle Overseas)
- 1 owner user (jwandiyanto@gmail.com) owns both
- No admin vs client role separation
- No first-login password change flow

**User Roles:**
- **Admin (owner)**: Jonathan - sees all workspaces, all data
- **Client**: Business owner - sees only their workspace

**Database Changes Needed:**
- Add `role` to users (admin | client)
- Add `must_change_password` flag
- Add `workspace_members` junction table (user ↔ workspace)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema updates</name>
  <files>Supabase SQL</files>
  <action>
Add new columns and tables:

```sql
-- Add role and password change flag to auth.users metadata
-- (Supabase uses user_metadata for custom fields)

-- Create workspace_members junction table
CREATE TABLE IF NOT EXISTS workspace_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  must_change_password BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(workspace_id, user_id)
);

-- RLS policies for workspace_members
ALTER TABLE workspace_members ENABLE ROW LEVEL SECURITY;

-- Users can see their own memberships
CREATE POLICY "Users can view own memberships"
  ON workspace_members FOR SELECT
  USING (auth.uid() = user_id);

-- Admins can manage all memberships
CREATE POLICY "Admins can manage memberships"
  ON workspace_members FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM workspace_members wm
      WHERE wm.user_id = auth.uid()
      AND wm.role IN ('owner', 'admin')
    )
  );
```
  </action>
  <verify>Tables created, RLS policies active</verify>
  <done>Database schema updated for multi-tenancy</done>
</task>

<task type="auto">
  <name>Task 2: Create admin user setup</name>
  <files>Supabase SQL</files>
  <action>
Set up Jonathan as admin:

```sql
-- Add Jonathan to workspace_members as owner of all workspaces
INSERT INTO workspace_members (workspace_id, user_id, role, must_change_password)
SELECT
  w.id,
  'd7012f0e-54a7-4013-9dfa-f63057040c08'::uuid,
  'owner',
  false
FROM workspaces w
ON CONFLICT (workspace_id, user_id) DO UPDATE SET role = 'owner';
```
  </action>
  <verify>Jonathan is owner of all workspaces</verify>
  <done>Admin user configured</done>
</task>

<task type="auto">
  <name>Task 3: Admin dashboard - all workspaces view</name>
  <files>src/app/(dashboard)/admin/*</files>
  <action>
Create admin dashboard that shows:
- All workspaces with stats (contacts count, messages count)
- Quick access to each workspace
- Client management (add new client)
- Only visible to admin role users

Components:
- /admin/page.tsx - Admin overview
- /admin/clients/page.tsx - Client list
- /admin/clients/new/page.tsx - Add new client
  </action>
  <verify>Admin can see all workspaces</verify>
  <done>Admin dashboard created</done>
</task>

<task type="auto">
  <name>Task 4: Client onboarding with dummy credentials</name>
  <files>src/app/(dashboard)/admin/clients/new/*</files>
  <action>
Create client onboarding flow:
1. Admin enters client info (name, email, business name)
2. System generates temporary password
3. Creates Supabase user with dummy password
4. Creates workspace for client
5. Adds user to workspace_members with must_change_password=true
6. Shows credentials to admin (to share with client)

Temporary password format: `Welcome123!` or auto-generated
  </action>
  <verify>Admin can create new client with temp credentials</verify>
  <done>Client onboarding flow created</done>
</task>

<task type="auto">
  <name>Task 5: First-login password change</name>
  <files>src/app/(auth)/change-password/*, src/middleware.ts</files>
  <action>
Force password change on first login:
1. After login, check must_change_password flag
2. If true, redirect to /change-password
3. User enters new password
4. Update password in Supabase Auth
5. Set must_change_password = false
6. Redirect to dashboard

Middleware check:
- If logged in AND must_change_password = true
- Redirect to /change-password (except for /change-password itself)
  </action>
  <verify>New clients forced to change password</verify>
  <done>First-login password change working</done>
</task>

<task type="auto">
  <name>Task 6: Dashboard routing by role</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
Update dashboard to route based on role:
- Admin → /admin (see all workspaces)
- Client → /[workspace] (their workspace directly)

Logic:
1. Get user's workspace_members entries
2. If role = 'owner' or 'admin' → show admin dashboard
3. If role = 'member' → redirect to their workspace
  </action>
  <verify>Users see appropriate dashboard for their role</verify>
  <done>Role-based routing working</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] workspace_members table created with RLS
- [ ] Jonathan set as owner of all workspaces
- [ ] Admin dashboard shows all workspaces
- [ ] Admin can create new client with temp password
- [ ] New client forced to change password on first login
- [ ] Clients only see their own workspace
- [ ] Admin sees all workspaces
</verification>

<success_criteria>
- Multi-tenant admin system working
- Admin (Jonathan) can manage all clients
- Clients get temporary credentials
- Password change enforced on first login
- Role-based access control (admin vs client)
</success_criteria>
