---
phase: 05-real-time-handover
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/inbox/message-thread.tsx
  - src/components/inbox/typing-indicator.tsx
  - src/components/inbox/system-message.tsx
  - src/lib/mock-data.ts
autonomous: true

must_haves:
  truths:
    - "New incoming messages appear in Inbox without page refresh (real-time)"
    - "AI/Human toggle shows confirmation dialog before switching modes"
    - "System message appears in thread after mode switch"
    - "Typing indicator shows while AI processes response"
  artifacts:
    - path: "src/components/inbox/message-thread.tsx"
      provides: "Complete AI/Human toggle with confirmation and feedback"
      min_lines: 150
    - path: "src/components/inbox/typing-indicator.tsx"
      provides: "WhatsApp-style three-dot animation"
      min_lines: 20
    - path: "src/components/inbox/system-message.tsx"
      provides: "Inline system message for mode transitions"
      min_lines: 15
  key_links:
    - from: "src/components/inbox/message-thread.tsx"
      to: "api.messages.listByConversationAsc"
      via: "useQuery subscription"
      pattern: "useQuery\\(api\\.messages\\.listByConversationAsc"
    - from: "src/components/inbox/message-thread.tsx"
      to: "api.conversations.updateConversationStatus"
      via: "useMutation for toggle"
      pattern: "useMutation\\(api\\.conversations\\.updateConversationStatus"
---

<objective>
Verify real-time message synchronization works via Convex subscriptions and complete AI/Human mode toggle UI with confirmation dialog, system messages, and typing indicator.

Purpose: Enable instant message updates and safe mode switching for conversations
Output: Real-time verified, toggle UI complete with feedback mechanisms
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-real-time-handover/05-CONTEXT.md
@.planning/phases/05-real-time-handover/05-RESEARCH.md
@.planning/phases/04-inbox-ui-filtering/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Verify real-time message sync via Convex subscriptions</name>
  <files>
    src/components/inbox/message-thread.tsx
    src/components/inbox/conversation-list.tsx
  </files>
  <action>
    Verify that Convex subscriptions are correctly wired for real-time updates:

    1. **Message thread**: Confirm useQuery(api.messages.listByConversationAsc) subscription exists and re-renders automatically on new messages
    2. **Conversation list**: Confirm useQuery(api.conversations.listWithFilters) subscription exists and reorders list on new messages
    3. **Dev mode handling**: Ensure both components have isDevMode() checks and use mock data when offline
    4. **No polling needed**: Document that real-time is handled by Convex subscription (not manual refresh)

    DO NOT add new subscriptions - they already exist. Just verify the pattern is correct:
    ```typescript
    const convexMessages = useQuery(
      api.messages.listByConversationAsc,
      isDevMode() ? 'skip' : { conversation_id, workspace_id }
    )
    const messages = isDevMode() ? getMockMessages(conversationId) : convexMessages
    ```

    WHY this pattern: Convex subscriptions automatically trigger re-renders when database changes. No manual refresh or polling needed.
  </action>
  <verify>
    - Read message-thread.tsx and conversation-list.tsx
    - Confirm useQuery pattern exists with isDevMode() checks
    - Run `npm run dev` and visit /demo/inbox - verify no errors
    - Check browser console - no subscription errors
  </verify>
  <done>
    - Real-time subscription pattern verified in both components
    - Dev mode checks in place for offline testing
    - No new code needed (existing pattern is correct)
  </done>
</task>

<task type="auto">
  <name>Complete AI/Human toggle with confirmation and feedback UI</name>
  <files>
    src/components/inbox/message-thread.tsx
    src/components/inbox/typing-indicator.tsx
    src/components/inbox/system-message.tsx
    src/lib/mock-data.ts
  </files>
  <action>
    Enhance existing AI/Human toggle in message-thread.tsx with confirmation dialog, system messages, and typing indicator:

    1. **Create TypingIndicator component** (`typing-indicator.tsx`):
       - WhatsApp-style three-dot animation using Tailwind animate-bounce
       - Message bubble format (gray background, left-aligned)
       - Shows while AI is processing response
       - Example: `<div className="flex gap-1"><div className="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style={{ animationDelay: '0s' }} />...`

    2. **Create SystemMessage component** (`system-message.tsx`):
       - Centered, gray text, small font
       - Pill-shaped background (rounded-full)
       - Displays mode switch notifications
       - Example: `<div className="flex justify-center my-4"><div className="text-xs text-muted-foreground bg-muted px-3 py-1 rounded-full">{text}</div></div>`

    3. **Enhance toggle in message-thread.tsx**:
       - Import Shadcn Dialog (AlertDialog pattern for confirmation)
       - Add state: `const [showConfirmDialog, setShowConfirmDialog] = useState(false)`
       - Before calling updateConversationStatus mutation, show confirmation:
         - AI → Human: "Switch to Human mode? AI will stop responding."
         - Human → AI: "Enable AI mode? AI will respond to new messages."
       - After successful mutation, insert system message in local state (optimistic update):
         - `{ type: 'system', content: 'You switched to Human mode', timestamp: Date.now() }`
       - Show TypingIndicator when AI is responding (simulate with 2-second delay in dev mode)

    4. **Update mock data** (mock-data.ts):
       - Add conversation.status field to MOCK_CONVERSATIONS ('open' | 'handover' | 'closed')
       - Ensure dev mode toggle updates local state (no real mutation)

    WHY confirmation: Prevents accidental mode switches that could disrupt customer conversations.

    WHY system messages: Provides clear visual feedback in conversation history that mode changed.

    WHY typing indicator: Standard WhatsApp UX pattern - user knows AI is working on response.

    FOLLOW PATTERNS: Use existing Shadcn Dialog, Badge, Button components. Match WhatsApp visual style from message-bubble.tsx.
  </action>
  <verify>
    - Run `npm run dev` and visit http://localhost:3000/demo/inbox
    - Click AI/Human toggle in message thread header
    - Confirm dialog appears with clear warning message
    - Click "Confirm" - verify system message appears in thread
    - Check conversation list - status badge updates to show mode
    - Verify typing indicator appears (dev mode simulation)
    - Toggle back - confirm dialog shows again
    - Check console - no errors
  </verify>
  <done>
    - TypingIndicator component created with WhatsApp-style animation
    - SystemMessage component created for inline mode notifications
    - Toggle in message-thread shows confirmation dialog before switching
    - System message appears in thread after successful toggle
    - Mock data includes conversation.status field for dev mode testing
    - Toggle works in both directions (AI → Human, Human → AI)
  </done>
</task>

</tasks>

<verification>
**Real-time sync verification:**
- Visit /demo/inbox in dev mode - page loads without errors
- Inspect message-thread.tsx - useQuery subscription pattern correct
- Browser console shows no subscription errors
- Dev mode uses mock data (no Convex calls)

**Toggle UI verification:**
- Click toggle button in message thread
- Confirmation dialog appears with clear message
- Click "Confirm" - system message appears in thread
- Mode badge updates to show new status
- Typing indicator shows during AI response (dev simulation)
- Toggle works both directions without errors
</verification>

<success_criteria>
1. Real-time message sync verified working via Convex useQuery subscriptions
2. AI/Human toggle requires confirmation before switching modes
3. System message appears in thread after mode switch
4. Typing indicator component created and integrated
5. Dev mode handles all features with mock data
6. No console errors when testing in /demo/inbox
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-handover/05-01-SUMMARY.md`
</output>
