---
phase: 05-real-time-handover
plan: "02"
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - convex/kapso.ts
  - src/lib/mock-data.ts
autonomous: true

must_haves:
  truths:
    - "When AI toggle is OFF (handover mode), new messages do NOT trigger ARI processing"
    - "When AI toggle is ON (open mode), new messages DO trigger ARI processing"
    - "Mode check happens before scheduling processARI action"
  artifacts:
    - path: "convex/kapso.ts"
      provides: "Conversation status gate in webhook handler"
      contains: "conversation.status !== 'handover'"
      min_lines: 400
  key_links:
    - from: "convex/kapso.ts (handleKapsoWebhook)"
      to: "conversation.status field"
      via: "Database query and conditional check"
      pattern: "if.*status.*handover.*continue"
    - from: "convex/kapso.ts (handleKapsoWebhook)"
      to: "internal.ari.processARI"
      via: "Schedule only when AI enabled"
      pattern: "ctx\\.scheduler\\.runAfter.*processARI"
---

<objective>
Wire AI/Human toggle to processARI gate so that conversations in 'handover' status (Human mode) skip ARI processing for new incoming messages.

Purpose: Prevent AI from responding when user has switched to Human mode
Output: ARI processing gated by conversation.status field
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-real-time-handover/05-CONTEXT.md
@.planning/phases/05-real-time-handover/05-RESEARCH.md
@.planning/phases/05-real-time-handover/05-01-SUMMARY.md
@.planning/phases/03-your-intern-configuration/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add conversation status gate to ARI processing in webhook handler</name>
  <files>
    convex/kapso.ts
    src/lib/mock-data.ts
  </files>
  <action>
    Add conversation.status check in Kapso webhook handler to skip ARI processing when conversation is in 'handover' (Human) mode:

    1. **Locate handleKapsoWebhook function** in convex/kapso.ts:
       - Find the section that iterates through incoming messages
       - Identify where processARI is scheduled (ctx.scheduler.runAfter call)

    2. **Add conversation status check** BEFORE scheduling processARI:
       ```typescript
       // Skip ARI if conversation is in handover (Human) mode
       const conversation = await ctx.db.get(conversationId)
       if (!conversation) {
         console.error(`[ARI Gate] Conversation ${conversationId} not found`)
         continue
       }

       if (conversation.status === 'handover') {
         console.log(`[ARI Gate] Skipping ARI for conversation ${conversationId} - Human mode active`)
         continue
       }

       // Conversation is in 'open' or 'closed' - proceed with ARI
       await ctx.scheduler.runAfter(0, internal.ari.processARI, {
         // ... existing args
       })
       ```

    3. **Follow existing pattern from Phase 03-02** (Global AI toggle):
       - Use similar gating pattern as ariConfig.enabled check
       - Use `continue` statement to skip iteration cleanly
       - Log when skipping for debugging

    4. **Update mock data** if needed:
       - Ensure MOCK_CONVERSATIONS in mock-data.ts have status field
       - Set some to 'handover' for testing

    WHY check conversation.status: This is the per-conversation toggle. Different from global AI toggle (ariConfig.enabled) which affects entire workspace. Both gates must pass for ARI to run.

    WHY check BEFORE scheduling: Avoid unnecessary database writes and action invocations. Early return is more efficient.

    FOLLOW PATTERN: Match the ariConfig.enabled gate from Phase 03-02 (lines 383-387 in handleKapsoWebhook). Both are early-exit checks using `continue`.
  </action>
  <verify>
    - Read convex/kapso.ts - verify conversation.status check added before processARI scheduling
    - Run `npm run dev` - no TypeScript errors
    - Check Convex dashboard logs (if testing with real webhook):
      - Should see "[ARI Gate] Skipping ARI for conversation X - Human mode active" when conversation.status = 'handover'
      - Should see normal processARI scheduling when conversation.status = 'open'
    - In dev mode (/demo/inbox):
      - Toggle to Human mode
      - Simulate incoming message (manual test - add message to mock data)
      - Verify no ARI response triggered
  </verify>
  <done>
    - Conversation.status check added to handleKapsoWebhook before processARI scheduling
    - Conversations with status = 'handover' skip ARI processing
    - Conversations with status = 'open' or 'closed' proceed normally
    - Logging shows gate status for debugging
    - Dev mode respects conversation.status in mock data
  </done>
</task>

</tasks>

<verification>
**Code verification:**
- Read convex/kapso.ts - conversation.status check exists before ctx.scheduler.runAfter(internal.ari.processARI)
- Pattern matches ariConfig.enabled gate (early exit with `continue`)
- TypeScript compiles without errors

**Functional verification (dev mode):**
- Visit /demo/inbox
- Select conversation, toggle to Human mode
- Check browser console - no unexpected errors
- Verify system understands 'handover' status

**Functional verification (with Kapso webhook - if available):**
- Use Kapso MCP tools to send test message
- Check Convex logs for "[ARI Gate] Skipping ARI..." message
- Verify AI does not respond when conversation in handover mode
- Toggle back to AI mode
- Send another test message
- Verify AI responds normally
</verification>

<success_criteria>
1. Conversation.status check added to handleKapsoWebhook before processARI scheduling
2. Conversations with status = 'handover' skip ARI processing
3. Conversations with status = 'open' proceed with ARI normally
4. Gate logs messages for debugging
5. Pattern matches existing ariConfig.enabled gate from Phase 03-02
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-handover/05-02-SUMMARY.md`
</output>
