---
phase: 06-ari-flow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/kapso.ts
  - convex/ai/context.ts
  - convex/ai/mouth.ts
autonomous: true

must_haves:
  truths:
    - "getAriContext returns workspace persona config (bot name, description, tone)"
    - "getAriContext returns workspace flow stages (greeting, qualifying, routing)"
    - "Mouth system prompt uses workspace persona instead of hardcoded values"
    - "Changing Persona tab in Your Intern affects next bot response (no restart)"
  artifacts:
    - path: "convex/kapso.ts"
      provides: "Enhanced getAriContext with workspace.settings fetch"
      exports: ["getAriContext"]
      min_lines: 30
    - path: "convex/ai/context.ts"
      provides: "buildMouthSystemPrompt accepts workspace config"
      exports: ["buildMouthSystemPrompt"]
    - path: "convex/ai/mouth.ts"
      provides: "Mouth uses workspace config from getAriContext"
      contains: "generateMouthResponse"
  key_links:
    - from: "convex/kapso.ts"
      to: "workspace.settings"
      via: "db.get(workspace._id).settings"
      pattern: "workspace\\.settings"
    - from: "convex/ai/context.ts"
      to: "workspace config"
      via: "function parameters"
      pattern: "personaConfig|flowStages"
    - from: "convex/ai/mouth.ts"
      to: "getAriContext"
      via: "receive workspace config in args"
      pattern: "args\\.persona|args\\.flow"
---

<objective>
Wire Mouth to read latest Persona/Flow config from workspace.settings on every ARI call. Changes to Your Intern tabs immediately affect bot behavior without restart.

Purpose: Enable hot-reload configuration - admins can edit bot personality, conversation flow, and see changes in next message.
Output: Mouth system prompts built from fresh workspace config, not hardcoded strings.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-CONTEXT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-RESEARCH.md

# Prior work
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/03-your-intern-configuration/03-01-SUMMARY.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/03-your-intern-configuration/03-02-SUMMARY.md

# Key files
@/home/jfransisco/Desktop/21/my21staff/convex/kapso.ts
@/home/jfransisco/Desktop/21/my21staff/convex/ai/context.ts
@/home/jfransisco/Desktop/21/my21staff/convex/ai/mouth.ts
@/home/jfransisco/Desktop/21/my21staff/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance getAriContext to include workspace.settings config</name>
  <files>convex/kapso.ts</files>
  <action>
    Update getAriContext mutation (lines 625-713) to fetch and return workspace configuration:

    1. After fetching workspace (line 632), read workspace.settings field
    2. Parse settings to extract: persona (bot_name, description, tone), flow_stages array, scoring_rules, consultation_slots
    3. Add to return object after line 696:
       ```typescript
       persona: {
         name: workspace.settings?.persona?.name ?? ariConfig.bot_name ?? "Ari",
         description: workspace.settings?.persona?.description ?? "",
         tone: workspace.settings?.persona?.tone ?? "friendly",
       },
       flowStages: workspace.settings?.flow_stages ?? [],
       scoringRules: workspace.settings?.scoring_rules ?? {},
       consultationSlots: workspace.settings?.consultation_slots ?? [],
       ```
    4. Keep existing ariConfig fallback for backward compatibility

    Pattern: Fresh fetch on every call (no caching) - mutation already runs fresh each time, no changes to call pattern needed.
  </action>
  <verify>
    ```bash
    # Check getAriContext returns workspace config
    grep -A 10 "persona:" convex/kapso.ts
    grep -A 5 "flowStages:" convex/kapso.ts
    ```
  </verify>
  <done>getAriContext return object includes persona, flowStages, scoringRules, consultationSlots from workspace.settings</done>
</task>

<task type="auto">
  <name>Task 2: Update buildMouthSystemPrompt to accept workspace config</name>
  <files>convex/ai/context.ts</files>
  <action>
    Modify buildMouthSystemPrompt function (currently uses hardcoded greeting/qualifying instructions):

    1. Add optional parameters to function signature (after existing params):
       ```typescript
       personaConfig?: { name: string; description: string; tone: string }
       flowStages?: Array<{ name: string; description: string; questions: string[] }>
       ```
    2. Replace hardcoded buildGreetingInstructions with workspace flow stage instructions:
       - If flowStages provided, find stage with name "greeting" and use its description + questions
       - Fallback to existing hardcoded instructions if not found
    3. Replace hardcoded buildQualifyingInstructions with workspace flow stage instructions:
       - Find stage with name "qualifying" and use its description + questions
       - Fallback to existing document collection logic if not found
    4. Use personaConfig.name instead of hardcoded bot name
    5. Inject persona tone into system prompt: "You are {name}. {description}. Communication style: {tone}."

    Keep existing QualificationContext pattern for document tracking.
  </action>
  <verify>
    ```bash
    # Check buildMouthSystemPrompt accepts workspace config
    grep "personaConfig?" convex/ai/context.ts
    grep "flowStages?" convex/ai/context.ts
    ```
  </verify>
  <done>buildMouthSystemPrompt uses workspace persona and flow stages when provided, falls back to hardcoded instructions otherwise</done>
</task>

<task type="auto">
  <name>Task 3: Wire Mouth to use workspace config from getAriContext</name>
  <files>convex/ai/mouth.ts</files>
  <action>
    Update generateMouthResponse action to accept and use workspace config:

    1. Add optional args (after existing args):
       ```typescript
       persona: v.optional(v.object({
         name: v.string(),
         description: v.string(),
         tone: v.string(),
       })),
       flowStages: v.optional(v.array(v.any())),
       ```
    2. Pass workspace config to buildMouthSystemPrompt call (line 59):
       ```typescript
       const systemPrompt = buildMouthSystemPrompt(
         args.persona?.name ?? args.botName ?? "Ari",
         args.contactName ?? "kakak",
         args.language ?? "id",
         args.state ?? "greeting",
         args.context as QualificationContext | undefined,
         args.communityLink,
         args.persona, // NEW
         args.flowStages // NEW
       );
       ```
    3. Update processARI call in kapso.ts to pass workspace config from getAriContext result

    Pattern: Mouth receives fresh config on every call via processARI invocation.
  </action>
  <verify>
    ```bash
    # Check Mouth accepts workspace config
    grep "persona:" convex/ai/mouth.ts
    grep "flowStages:" convex/ai/mouth.ts

    # Check processARI passes config to Mouth
    grep -A 5 "generateMouthResponse" convex/kapso.ts | grep persona
    ```
  </verify>
  <done>Mouth receives and uses workspace persona/flow config from getAriContext; changing Your Intern tabs affects next bot response</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Check getAriContext fetches workspace.settings:
   ```bash
   grep "workspace.settings" convex/kapso.ts
   ```

2. Verify buildMouthSystemPrompt uses workspace config:
   ```bash
   grep -A 3 "personaConfig" convex/ai/context.ts
   ```

3. Confirm Mouth receives config from processARI:
   ```bash
   grep -B 5 -A 10 "generateMouthResponse" convex/kapso.ts | grep -E "persona|flowStages"
   ```

Expected: No caching anywhere (getAriContext is mutation, runs fresh each call). Config changes in Your Intern immediately visible in next ARI response.
</verification>

<success_criteria>
- [ ] getAriContext returns persona, flowStages, scoringRules, consultationSlots from workspace.settings
- [ ] buildMouthSystemPrompt accepts and uses workspace config (persona name, description, tone)
- [ ] Mouth system prompt built from workspace flow stages (greeting, qualifying instructions)
- [ ] processARI passes fresh workspace config to Mouth on every invocation
- [ ] No caching anywhere - config changes in Your Intern affect next message without restart
</success_criteria>

<output>
After completion, create `.planning/phases/06-ari-flow-integration/06-01-SUMMARY.md`
</output>
