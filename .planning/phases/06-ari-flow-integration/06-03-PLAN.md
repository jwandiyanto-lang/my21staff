---
phase: 06-ari-flow-integration
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/ari/scheduling.ts
  - convex/ai/context.ts
autonomous: true

must_haves:
  truths:
    - "Bot offers only available consultation slots from workspace config"
    - "Scheduling logic checks consultation_slots for day/time availability"
    - "Changing Slots tab in Your Intern affects next consultation offer"
  artifacts:
    - path: "src/lib/ari/scheduling.ts"
      provides: "Scheduling logic with workspace slots integration"
      contains: "getAvailableSlots"
      min_lines: 30
    - path: "convex/ai/context.ts"
      provides: "buildMouthSystemPrompt includes available slots"
      contains: "consultationSlots"
  key_links:
    - from: "src/lib/ari/scheduling.ts"
      to: "workspace.settings.consultation_slots"
      via: "getAriContext result"
      pattern: "consultationSlots"
    - from: "convex/ai/context.ts"
      to: "available slots"
      via: "format slots for prompt"
      pattern: "formatAvailableSlots"
---

<objective>
Wire routing logic to respect workspace consultation_slots config. Bot offers only available times when suggesting consultation booking.

Purpose: Enable admin-configured availability - bot offers consultation times based on Slots tab configuration.
Output: Scheduling logic checks workspace slots; bot prompts include available times only.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-CONTEXT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-RESEARCH.md

# Prior work
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-01-SUMMARY.md

# Key files (if exist)
@/home/jfransisco/Desktop/21/my21staff/src/lib/ari/scheduling.ts
@/home/jfransisco/Desktop/21/my21staff/convex/ai/context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify scheduling.ts exists and update slot availability logic</name>
  <files>src/lib/ari/scheduling.ts</files>
  <action>
    Check if scheduling.ts exists. If not, create it. Update to use workspace consultation_slots:

    1. Check file existence:
       ```bash
       ls src/lib/ari/scheduling.ts 2>/dev/null || echo "File does not exist"
       ```
    2. If file exists:
       - Find getAvailableSlots or similar function
       - Update to filter by workspace consultation_slots config
       - Slots format: { day: "Monday", time: "10:00", duration_minutes: 60, available: true }
       - Only include slots where available === true
    3. If file does NOT exist:
       - Create new scheduling.ts with getAvailableSlots function
       - Accept consultationSlots parameter
       - Filter to available slots only
       - Return formatted slot list (day + time)
    4. Export function for use in context builder

    Pattern: Scheduling reads from workspace config, no hardcoded times.
  </action>
  <verify>
    ```bash
    # Check scheduling.ts exists and has slot filtering
    ls src/lib/ari/scheduling.ts
    grep "consultationSlots" src/lib/ari/scheduling.ts
    grep "getAvailableSlots" src/lib/ari/scheduling.ts
    ```
  </verify>
  <done>Scheduling logic filters workspace consultation_slots to show only available times</done>
</task>

<task type="auto">
  <name>Task 2: Update buildMouthSystemPrompt to include available slots in prompt</name>
  <files>convex/ai/context.ts</files>
  <action>
    Enhance buildMouthSystemPrompt to format consultation slots for AI prompt:

    1. Add consultationSlots parameter (already added in Plan 01 if following dependency):
       ```typescript
       consultationSlots?: Array<{ day: string; time: string; duration_minutes: number; available: boolean }>
       ```
    2. Create helper function formatAvailableSlots:
       ```typescript
       function formatAvailableSlots(slots: Array<{...}>): string {
         const available = slots.filter(s => s.available);
         if (available.length === 0) return "No slots available";
         return available.map(s => `${s.day} ${s.time}`).join(", ");
       }
       ```
    3. When state === "booking" or "scheduling", include available slots in system prompt:
       ```
       Available consultation times: {formatAvailableSlots(consultationSlots)}
       Only offer these specific times to the user.
       ```
    4. If no available slots, prompt should say "Currently no slots available, will contact you soon"

    Pattern: Bot prompt includes only available times from workspace config.
  </action>
  <verify>
    ```bash
    # Check context builder formats available slots
    grep "formatAvailableSlots" convex/ai/context.ts
    grep "consultationSlots" convex/ai/context.ts
    ```
  </verify>
  <done>buildMouthSystemPrompt includes formatted available consultation slots; bot offers only workspace-configured times</done>
</task>

<task type="auto">
  <name>Task 3: Verify processARI passes consultationSlots to Mouth (from Plan 01)</name>
  <files>convex/kapso.ts</files>
  <action>
    Verify that processARI already passes consultationSlots from getAriContext to Mouth (should be done in Plan 01):

    1. Check processARI invocation of generateMouthResponse
    2. Confirm consultationSlots passed from getAriContext result to Mouth args:
       ```typescript
       const mouthResult = await ctx.runAction(internal.ai.mouth.generateMouthResponse, {
         // ... existing args
         consultationSlots: context.consultationSlots, // Should exist from Plan 01
       });
       ```
    3. If missing, add consultationSlots to Mouth invocation

    Pattern: Complete data flow: workspace.settings -> getAriContext -> processARI -> Mouth -> system prompt.
  </action>
  <verify>
    ```bash
    # Check processARI passes consultationSlots to Mouth
    grep -A 15 "generateMouthResponse" convex/kapso.ts | grep consultationSlots
    ```
  </verify>
  <done>processARI passes workspace consultationSlots to Mouth; complete config flow verified</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Check scheduling logic exists:
   ```bash
   ls src/lib/ari/scheduling.ts
   grep "getAvailableSlots" src/lib/ari/scheduling.ts
   ```

2. Verify context builder formats slots:
   ```bash
   grep "formatAvailableSlots" convex/ai/context.ts
   ```

3. Confirm processARI passes slots to Mouth:
   ```bash
   grep -A 15 "generateMouthResponse" convex/kapso.ts | grep consultationSlots
   ```

Expected: Bot offers only available consultation slots from workspace config. Changing Slots tab affects next consultation offer.
</verification>

<success_criteria>
- [ ] scheduling.ts exists with getAvailableSlots function (or equivalent)
- [ ] Scheduling logic filters workspace consultation_slots to available only
- [ ] buildMouthSystemPrompt formats available slots for AI prompt
- [ ] Bot prompts include only workspace-configured available times
- [ ] processARI passes consultationSlots from getAriContext to Mouth
- [ ] Changing Slots tab in Your Intern affects next consultation offer
- [ ] When no slots available, bot says "will contact you soon" (graceful degradation)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ari-flow-integration/06-03-SUMMARY.md`
</output>
