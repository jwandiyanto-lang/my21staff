---
phase: 05-lead-flow
plan: 07
type: execute
wave: 2
depends_on: ["05-06"]
files_modified:
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  - src/app/api/workspaces/[id]/status-config/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can view current lead stages in Settings"
    - "User can add new lead stages"
    - "User can edit stage names and colors"
    - "User can delete stages (except minimum required)"
    - "Changes persist to workspace settings"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      provides: "Lead Stages tab in Settings"
      contains: "Lead Stages"
    - path: "src/app/api/workspaces/[id]/status-config/route.ts"
      provides: "API endpoint for status config CRUD"
      exports: ["GET", "PUT"]
  key_links:
    - from: "settings-client.tsx"
      to: "/api/workspaces/[id]/status-config"
      via: "fetch calls"
      pattern: "status-config"
    - from: "route.ts"
      to: "convex workspaces:updateStatusConfig"
      via: "convex mutation"
      pattern: "updateStatusConfig"
---

<objective>
Add Lead Stages configuration UI to Settings page.

Purpose: Allow users to customize their lead status pipeline - defining stage names, colors, and which stages correspond to AI temperature classifications.

Output:
- New "Lead Stages" tab in Settings
- Full CRUD for lead status configuration
- Changes saved to workspace via Convex
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/STATE.md
@planning/phases/05-lead-flow/05-06-PLAN.md

Key files:
@src/app/(dashboard)/[workspace]/settings/settings-client.tsx
@src/lib/lead-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API endpoint for status configuration</name>
  <files>src/app/api/workspaces/[id]/status-config/route.ts</files>
  <action>
Create a new API route for getting and updating workspace status configuration:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  try {
    const { id } = await params;
    const statusConfig = await convex.query(api.workspaces.getStatusConfig, {
      workspaceId: id as Id<"workspaces">,
    });

    return NextResponse.json(statusConfig);
  } catch (error) {
    console.error("[GET status-config] Error:", error);
    return NextResponse.json(
      { error: "Failed to get status config" },
      { status: 500 }
    );
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth();
  if (!userId) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  try {
    const { id } = await params;
    const body = await request.json();
    const { leadStatuses } = body;

    if (!Array.isArray(leadStatuses)) {
      return NextResponse.json(
        { error: "leadStatuses must be an array" },
        { status: 400 }
      );
    }

    await convex.mutation(api.workspaces.updateStatusConfig, {
      workspaceId: id as Id<"workspaces">,
      leadStatuses,
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("[PUT status-config] Error:", error);
    return NextResponse.json(
      { error: "Failed to update status config" },
      { status: 500 }
    );
  }
}
```

Note: Create the directory structure if it doesn't exist: `src/app/api/workspaces/[id]/status-config/`
  </action>
  <verify>
Run `npm run build` to verify the route compiles. The API should be accessible at `/api/workspaces/{id}/status-config`.
  </verify>
  <done>
- GET endpoint returns workspace status config (or defaults)
- PUT endpoint saves new status config to workspace
- Auth check on both endpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Lead Stages tab to Settings page</name>
  <files>src/app/(dashboard)/[workspace]/settings/settings-client.tsx</files>
  <action>
1. Add imports at the top:
```typescript
import { GripVertical, Palette } from 'lucide-react'
```

2. Add new interface for status config after existing interfaces:
```typescript
interface LeadStatusConfig {
  key: string;
  label: string;
  color: string;
  bgColor: string;
  temperature: "hot" | "warm" | "cold" | null;
}
```

3. Add state for lead stages after the import state section (~line 140):
```typescript
// Lead stages state
const [leadStatuses, setLeadStatuses] = useState<LeadStatusConfig[]>([]);
const [isLoadingStatuses, setIsLoadingStatuses] = useState(true);
const [isSavingStatuses, setIsSavingStatuses] = useState(false);
const [editingStatus, setEditingStatus] = useState<LeadStatusConfig | null>(null);
const [newStatus, setNewStatus] = useState<Partial<LeadStatusConfig>>({});
const [isAddingStatus, setIsAddingStatus] = useState(false);
```

4. Add useEffect to load statuses (after existing useEffect or state declarations):
```typescript
// Load lead statuses on mount
useEffect(() => {
  const loadStatuses = async () => {
    try {
      const res = await fetch(`/api/workspaces/${workspace.id}/status-config`);
      if (res.ok) {
        const data = await res.json();
        setLeadStatuses(data);
      }
    } catch (error) {
      console.error('Failed to load lead statuses:', error);
    } finally {
      setIsLoadingStatuses(false);
    }
  };
  loadStatuses();
}, [workspace.id]);
```

Note: Add `import { useEffect } from 'react'` at the top if not already imported.

5. Add handlers for lead stages (after existing handlers):
```typescript
// Lead stages handlers
const saveLeadStatuses = async (statuses: LeadStatusConfig[]) => {
  setIsSavingStatuses(true);
  try {
    const res = await fetch(`/api/workspaces/${workspace.id}/status-config`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ leadStatuses: statuses }),
    });
    if (!res.ok) throw new Error('Failed to save');
    setLeadStatuses(statuses);
  } catch (error) {
    console.error('Failed to save lead statuses:', error);
  } finally {
    setIsSavingStatuses(false);
  }
};

const handleAddStatus = async () => {
  if (!newStatus.key?.trim() || !newStatus.label?.trim()) return;

  // Check for duplicate key
  if (leadStatuses.some(s => s.key === newStatus.key)) {
    alert('A stage with this key already exists');
    return;
  }

  const status: LeadStatusConfig = {
    key: newStatus.key.trim().toLowerCase().replace(/\s+/g, '_'),
    label: newStatus.label.trim(),
    color: newStatus.color || '#6B7280',
    bgColor: newStatus.bgColor || '#F3F4F6',
    temperature: newStatus.temperature || null,
  };

  await saveLeadStatuses([...leadStatuses, status]);
  setNewStatus({});
  setIsAddingStatus(false);
};

const handleUpdateStatus = async () => {
  if (!editingStatus) return;
  const updated = leadStatuses.map(s =>
    s.key === editingStatus.key ? editingStatus : s
  );
  await saveLeadStatuses(updated);
  setEditingStatus(null);
};

const handleDeleteStatus = async (key: string) => {
  if (leadStatuses.length <= 2) {
    alert('You must have at least 2 stages');
    return;
  }
  const updated = leadStatuses.filter(s => s.key !== key);
  await saveLeadStatuses(updated);
};

const handleMoveStatus = async (index: number, direction: 'up' | 'down') => {
  const newIndex = direction === 'up' ? index - 1 : index + 1;
  if (newIndex < 0 || newIndex >= leadStatuses.length) return;

  const updated = [...leadStatuses];
  [updated[index], updated[newIndex]] = [updated[newIndex], updated[index]];
  await saveLeadStatuses(updated);
};
```

6. Add the TabsTrigger in the TabsList (after the Tags tab, ~line 396):
```tsx
<TabsTrigger value="lead-stages" className="gap-2">
  <Palette className="h-4 w-4" />
  Lead Stages
  <Badge variant="secondary" className="ml-1 text-xs">
    {leadStatuses.length}
  </Badge>
</TabsTrigger>
```

7. Add the TabsContent for lead-stages (after the Tags TabsContent, before the Data TabsContent):
```tsx
{/* Lead Stages Tab */}
<TabsContent value="lead-stages" className="space-y-6">
  <Card>
    <CardHeader>
      <div className="flex items-center justify-between">
        <div>
          <CardTitle className="text-lg">Lead Stages</CardTitle>
          <CardDescription>
            Configure your sales pipeline stages. The AI will categorize leads based on temperature (hot/warm/cold).
          </CardDescription>
        </div>
        <Button onClick={() => setIsAddingStatus(true)} disabled={isAddingStatus}>
          <Plus className="h-4 w-4 mr-2" />
          Add Stage
        </Button>
      </div>
    </CardHeader>
    <CardContent className="space-y-4">
      {isLoadingStatuses ? (
        <div className="flex items-center justify-center py-8">
          <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
        </div>
      ) : (
        <>
          {/* Add new status form */}
          {isAddingStatus && (
            <div className="border rounded-lg p-4 space-y-3 bg-muted/50">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Stage Name</Label>
                  <Input
                    placeholder="e.g., Qualified Lead"
                    value={newStatus.label || ''}
                    onChange={(e) => setNewStatus({
                      ...newStatus,
                      label: e.target.value,
                      key: e.target.value.toLowerCase().replace(/\s+/g, '_'),
                    })}
                  />
                </div>
                <div className="space-y-2">
                  <Label>AI Temperature</Label>
                  <Select
                    value={newStatus.temperature || 'none'}
                    onValueChange={(v) => setNewStatus({
                      ...newStatus,
                      temperature: v === 'none' ? null : v as "hot" | "warm" | "cold",
                    })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Select temperature" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">None (manual only)</SelectItem>
                      <SelectItem value="hot">Hot (high intent)</SelectItem>
                      <SelectItem value="warm">Warm (medium intent)</SelectItem>
                      <SelectItem value="cold">Cold (low intent)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Text Color</Label>
                  <div className="flex gap-2">
                    <Input
                      type="color"
                      value={newStatus.color || '#6B7280'}
                      onChange={(e) => setNewStatus({ ...newStatus, color: e.target.value })}
                      className="w-12 h-9 p-1"
                    />
                    <Input
                      value={newStatus.color || '#6B7280'}
                      onChange={(e) => setNewStatus({ ...newStatus, color: e.target.value })}
                      placeholder="#6B7280"
                    />
                  </div>
                </div>
                <div className="space-y-2">
                  <Label>Background Color</Label>
                  <div className="flex gap-2">
                    <Input
                      type="color"
                      value={newStatus.bgColor || '#F3F4F6'}
                      onChange={(e) => setNewStatus({ ...newStatus, bgColor: e.target.value })}
                      className="w-12 h-9 p-1"
                    />
                    <Input
                      value={newStatus.bgColor || '#F3F4F6'}
                      onChange={(e) => setNewStatus({ ...newStatus, bgColor: e.target.value })}
                      placeholder="#F3F4F6"
                    />
                  </div>
                </div>
              </div>
              <div className="flex gap-2">
                <Button onClick={handleAddStatus} disabled={isSavingStatuses}>
                  {isSavingStatuses ? 'Saving...' : 'Save'}
                </Button>
                <Button variant="outline" onClick={() => {
                  setIsAddingStatus(false);
                  setNewStatus({});
                }}>
                  Cancel
                </Button>
              </div>
            </div>
          )}

          {/* List of stages */}
          <div className="space-y-2">
            {leadStatuses.map((status, index) => (
              <div key={status.key} className="border rounded-lg p-4">
                {editingStatus?.key === status.key ? (
                  <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label>Stage Name</Label>
                        <Input
                          value={editingStatus.label}
                          onChange={(e) => setEditingStatus({ ...editingStatus, label: e.target.value })}
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>AI Temperature</Label>
                        <Select
                          value={editingStatus.temperature || 'none'}
                          onValueChange={(v) => setEditingStatus({
                            ...editingStatus,
                            temperature: v === 'none' ? null : v as "hot" | "warm" | "cold",
                          })}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="none">None (manual only)</SelectItem>
                            <SelectItem value="hot">Hot (high intent)</SelectItem>
                            <SelectItem value="warm">Warm (medium intent)</SelectItem>
                            <SelectItem value="cold">Cold (low intent)</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label>Text Color</Label>
                        <div className="flex gap-2">
                          <Input
                            type="color"
                            value={editingStatus.color}
                            onChange={(e) => setEditingStatus({ ...editingStatus, color: e.target.value })}
                            className="w-12 h-9 p-1"
                          />
                          <Input
                            value={editingStatus.color}
                            onChange={(e) => setEditingStatus({ ...editingStatus, color: e.target.value })}
                          />
                        </div>
                      </div>
                      <div className="space-y-2">
                        <Label>Background Color</Label>
                        <div className="flex gap-2">
                          <Input
                            type="color"
                            value={editingStatus.bgColor}
                            onChange={(e) => setEditingStatus({ ...editingStatus, bgColor: e.target.value })}
                            className="w-12 h-9 p-1"
                          />
                          <Input
                            value={editingStatus.bgColor}
                            onChange={(e) => setEditingStatus({ ...editingStatus, bgColor: e.target.value })}
                          />
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <Button onClick={handleUpdateStatus} disabled={isSavingStatuses}>
                        {isSavingStatuses ? 'Saving...' : 'Save'}
                      </Button>
                      <Button variant="outline" onClick={() => setEditingStatus(null)}>
                        Cancel
                      </Button>
                    </div>
                  </div>
                ) : (
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="flex flex-col gap-1">
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-5 w-5"
                          onClick={() => handleMoveStatus(index, 'up')}
                          disabled={index === 0 || isSavingStatuses}
                        >
                          <GripVertical className="h-4 w-4 rotate-90" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-5 w-5"
                          onClick={() => handleMoveStatus(index, 'down')}
                          disabled={index === leadStatuses.length - 1 || isSavingStatuses}
                        >
                          <GripVertical className="h-4 w-4 rotate-90" />
                        </Button>
                      </div>
                      <Badge
                        style={{
                          backgroundColor: status.bgColor,
                          color: status.color,
                          borderColor: status.color,
                        }}
                        className="border"
                      >
                        {status.label}
                      </Badge>
                      {status.temperature && (
                        <span className="text-xs text-muted-foreground">
                          AI: {status.temperature}
                        </span>
                      )}
                    </div>
                    <div className="flex gap-1">
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-8 w-8"
                        onClick={() => setEditingStatus(status)}
                      >
                        <Pencil className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-8 w-8 text-destructive"
                        onClick={() => handleDeleteStatus(status.key)}
                        disabled={isSavingStatuses || leadStatuses.length <= 2}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>

          {leadStatuses.length === 0 && !isAddingStatus && (
            <div className="text-center py-8 text-muted-foreground">
              <Palette className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>No lead stages configured</p>
              <p className="text-sm mt-1">Click "Add Stage" to create your pipeline</p>
            </div>
          )}
        </>
      )}
    </CardContent>
  </Card>
</TabsContent>
```

Important: Make sure `useEffect` is imported from 'react' at the top of the file.
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Start `npm run dev` and navigate to Settings page to verify the Lead Stages tab appears and loads.
  </verify>
  <done>
- Lead Stages tab appears in Settings
- Statuses load from API on mount
- Add/Edit/Delete functionality works
- Color pickers for customizing stage appearance
- Temperature dropdown for AI categorization
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npm run build` succeeds with no errors
2. Navigate to Settings page at `/{workspace}/settings`
3. Verify "Lead Stages" tab appears
4. Verify default stages load (New, Cold Lead, Warm Lead, Hot Lead, Client, Lost)
5. Test adding a new stage
6. Test editing an existing stage's label and colors
7. Test deleting a stage (should fail if only 2 remain)
8. Verify changes persist after page refresh
</verification>

<success_criteria>
- [ ] Lead Stages tab visible in Settings
- [ ] Default stages load correctly
- [ ] Can add new stages with custom name, colors, temperature
- [ ] Can edit existing stages
- [ ] Can delete stages (minimum 2 required)
- [ ] Changes persist to workspace settings
- [ ] No TypeScript or runtime errors
</success_criteria>

<output>
After completion, create `planning/phases/05-lead-flow/05-07-SUMMARY.md`
</output>
