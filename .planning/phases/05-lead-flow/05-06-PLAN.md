---
phase: 05-lead-flow
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/ai/brain.ts
  - convex/workspaces.ts
  - src/lib/lead-status.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Workspace can store custom lead status configuration"
    - "Brain reads status config from workspace when mapping temperature"
    - "UI can render dynamic status labels from workspace config"
    - "Default statuses provided when workspace has no custom config"
  artifacts:
    - path: "convex/schema.ts"
      provides: "lead_statuses field in workspaces table settings"
      contains: "lead_statuses"
    - path: "convex/ai/brain.ts"
      provides: "getWorkspaceStatusConfig function"
      contains: "getWorkspaceStatusConfig"
    - path: "convex/workspaces.ts"
      provides: "Query to get workspace status config"
      contains: "getStatusConfig"
    - path: "src/lib/lead-status.ts"
      provides: "Dynamic status config support"
      contains: "LeadStatusConfig"
  key_links:
    - from: "convex/ai/brain.ts"
      to: "convex/workspaces.ts"
      via: "getStatusConfig query"
      pattern: "getStatusConfig"
    - from: "src/lib/lead-status.ts"
      to: "workspace.settings.lead_statuses"
      via: "config parameter"
      pattern: "statusConfig\\?"
---

<objective>
Add workspace-level lead status configuration to enable customizable sales stages.

Purpose: Fix the status value mismatch between Brain (hot/warm/cold) and UI (prospect/cold_lead/hot_lead). Users can define their own status names and the number of stages.

Output:
- Schema updated with lead_statuses in workspace settings
- Brain reads workspace config for status mapping
- UI lib supports dynamic status configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/STATE.md
@planning/phases/05-lead-flow/05-03-SUMMARY.md

Key files:
@convex/schema.ts
@convex/ai/brain.ts
@src/lib/lead-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lead status configuration to workspace settings</name>
  <files>convex/schema.ts, convex/workspaces.ts</files>
  <action>
1. The workspace schema already has `settings: v.optional(v.any())` which can store the lead_statuses array. No schema change needed.

2. In `convex/workspaces.ts`, add a new query `getStatusConfig`:

```typescript
export const getStatusConfig = query({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const workspace = await ctx.db.get(args.workspaceId);
    if (!workspace) return null;

    // Return custom config or default
    const customConfig = workspace.settings?.lead_statuses;
    if (customConfig && Array.isArray(customConfig) && customConfig.length > 0) {
      return customConfig;
    }

    // Default status configuration matching Brain's temperature mapping
    return [
      { key: "new", label: "New", color: "#6B7280", bgColor: "#F3F4F6", temperature: null },
      { key: "cold", label: "Cold Lead", color: "#3B82F6", bgColor: "#DBEAFE", temperature: "cold" },
      { key: "warm", label: "Warm Lead", color: "#F59E0B", bgColor: "#FEF3C7", temperature: "warm" },
      { key: "hot", label: "Hot Lead", color: "#DC2626", bgColor: "#FEE2E2", temperature: "hot" },
      { key: "client", label: "Client", color: "#10B981", bgColor: "#D1FAE5", temperature: null },
      { key: "lost", label: "Lost", color: "#4B5563", bgColor: "#E5E7EB", temperature: null },
    ];
  },
});
```

3. Also add a mutation `updateStatusConfig` for saving custom statuses:

```typescript
export const updateStatusConfig = mutation({
  args: {
    workspaceId: v.id("workspaces"),
    leadStatuses: v.array(v.object({
      key: v.string(),
      label: v.string(),
      color: v.string(),
      bgColor: v.string(),
      temperature: v.union(v.literal("hot"), v.literal("warm"), v.literal("cold"), v.null()),
    }))
  },
  handler: async (ctx, args) => {
    const workspace = await ctx.db.get(args.workspaceId);
    if (!workspace) throw new Error("Workspace not found");

    await ctx.db.patch(args.workspaceId, {
      settings: {
        ...workspace.settings,
        lead_statuses: args.leadStatuses,
      },
      updated_at: Date.now(),
    });
  },
});
```

Note: Import `query` and `mutation` from "../_generated/server" if not already imported.
  </action>
  <verify>
Run `npx convex dev` and verify no type errors. Check that `getStatusConfig` and `updateStatusConfig` appear in the Convex dashboard functions list.
  </verify>
  <done>
- getStatusConfig query returns default status array or custom workspace config
- updateStatusConfig mutation saves lead_statuses to workspace.settings
- No type errors in Convex
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Brain to use workspace status configuration</name>
  <files>convex/ai/brain.ts</files>
  <action>
1. Modify the `analyzeConversation` action to fetch workspace status config before mapping.

2. Add an internal query to get status config (since actions can't call queries directly, use runQuery):

At the top of the file, add a helper internal query:
```typescript
export const getWorkspaceStatusConfig = internalQuery({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const workspace = await ctx.db.get(args.workspaceId);
    if (!workspace?.settings?.lead_statuses) {
      // Default config with temperature mappings
      return [
        { key: "new", temperature: null },
        { key: "cold", temperature: "cold" },
        { key: "warm", temperature: "warm" },
        { key: "hot", temperature: "hot" },
        { key: "client", temperature: null },
        { key: "lost", temperature: null },
      ];
    }
    return workspace.settings.lead_statuses;
  },
});
```

3. Modify `mapTemperatureToStatus` to accept status config:

```typescript
function mapTemperatureToStatus(
  temperature: "hot" | "warm" | "cold",
  statusConfig: Array<{ key: string; temperature: string | null }>
): string {
  // Find status with matching temperature
  const matchingStatus = statusConfig.find(s => s.temperature === temperature);
  if (matchingStatus) {
    return matchingStatus.key;
  }

  // Fallback to temperature value directly (backwards compatible)
  return temperature;
}
```

4. In `analyzeConversation`, before calling `updateContactScore`, fetch the status config:

```typescript
// Fetch workspace status config
const statusConfig = await ctx.runQuery(internal.ai.brain.getWorkspaceStatusConfig, {
  workspaceId: args.workspaceId,
});

// Update contact lead score with mapped status
await ctx.runMutation(internal.ai.brain.updateContactScore, {
  contactId: args.contactId,
  leadScore: analysis.lead_score,
  leadStatus: mapTemperatureToStatus(analysis.temperature, statusConfig),
});
```

5. Import `internalQuery` from "../_generated/server".
  </action>
  <verify>
Run `npx convex dev` and verify no type errors. The function should compile without issues.
  </verify>
  <done>
- Brain fetches workspace status config before mapping temperature
- mapTemperatureToStatus uses config to return correct status key
- Default config ensures backwards compatibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Update lead-status.ts for dynamic configuration</name>
  <files>src/lib/lead-status.ts</files>
  <action>
1. Refactor lead-status.ts to support both static defaults and dynamic workspace config:

```typescript
// Status configuration type
export interface LeadStatusConfig {
  key: string;
  label: string;
  color: string;
  bgColor: string;
  temperature: "hot" | "warm" | "cold" | null;
}

// Default configuration (matches Brain's default)
export const DEFAULT_LEAD_STATUSES: LeadStatusConfig[] = [
  { key: "new", label: "New", color: "#6B7280", bgColor: "#F3F4F6", temperature: null },
  { key: "cold", label: "Cold Lead", color: "#3B82F6", bgColor: "#DBEAFE", temperature: "cold" },
  { key: "warm", label: "Warm Lead", color: "#F59E0B", bgColor: "#FEF3C7", temperature: "warm" },
  { key: "hot", label: "Hot Lead", color: "#DC2626", bgColor: "#FEE2E2", temperature: "hot" },
  { key: "client", label: "Client", color: "#10B981", bgColor: "#D1FAE5", temperature: null },
  { key: "lost", label: "Lost", color: "#4B5563", bgColor: "#E5E7EB", temperature: null },
];

// Legacy type for backwards compatibility
export type LeadStatus = string;

// Helper to get status config (static version for non-dynamic contexts)
export function getStatusConfig(
  statusKey: string,
  workspaceConfig?: LeadStatusConfig[]
): LeadStatusConfig {
  const config = workspaceConfig || DEFAULT_LEAD_STATUSES;
  const found = config.find(s => s.key === statusKey);

  // Return found config or a fallback for unknown statuses
  if (found) return found;

  return {
    key: statusKey,
    label: statusKey.charAt(0).toUpperCase() + statusKey.slice(1).replace(/_/g, ' '),
    color: "#6B7280",
    bgColor: "#F3F4F6",
    temperature: null,
  };
}

// Legacy exports for backwards compatibility
export const LEAD_STATUS_CONFIG: Record<string, { label: string; color: string; bgColor: string }> =
  Object.fromEntries(
    DEFAULT_LEAD_STATUSES.map(s => [s.key, { label: s.label, color: s.color, bgColor: s.bgColor }])
  );

export const LEAD_STATUSES = DEFAULT_LEAD_STATUSES.map(s => s.key);

export const DEFAULT_LEAD_STATUS = "new";
```

2. This maintains backwards compatibility with existing code while enabling dynamic configuration.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles without errors. Check that existing imports of LEAD_STATUS_CONFIG still work.
  </verify>
  <done>
- LeadStatusConfig interface defined
- DEFAULT_LEAD_STATUSES array with temperature mappings
- getStatusConfig helper for dynamic lookup
- Legacy exports preserved for backwards compatibility
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npx convex dev` runs without errors
2. `npm run build` succeeds
3. In Convex dashboard, verify:
   - `workspaces:getStatusConfig` query exists
   - `workspaces:updateStatusConfig` mutation exists
   - `ai.brain:getWorkspaceStatusConfig` internal query exists

4. Test the default behavior:
   - Brain should now map "hot" -> "hot", "warm" -> "warm", "cold" -> "cold" (matching default config keys)
   - UI should display these as "Hot Lead", "Warm Lead", "Cold Lead" (using DEFAULT_LEAD_STATUSES labels)
</verification>

<success_criteria>
- [ ] Workspace can store custom lead_statuses in settings
- [ ] Brain reads workspace config before mapping temperature to status
- [ ] Default configuration aligns Brain output with UI display
- [ ] Legacy LEAD_STATUS_CONFIG still works for existing code
- [ ] No TypeScript or Convex errors
</success_criteria>

<output>
After completion, create `planning/phases/05-lead-flow/05-06-SUMMARY.md`
</output>
