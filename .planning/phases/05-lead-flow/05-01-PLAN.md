---
phase: 05-lead-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "n8n webhook endpoint responds with 200 on valid lead data"
    - "Lead created via webhook appears in Convex database"
    - "Duplicate phone numbers return 'exists' status (not error)"
  artifacts:
    - path: "convex/http.ts"
      provides: "HTTP endpoint at /webhook/n8n"
      contains: "path: \"/webhook/n8n\""
    - path: "convex/n8n.ts"
      provides: "createLead mutation with duplicate detection"
      exports: ["createLead"]
  key_links:
    - from: "HTTP /webhook/n8n"
      to: "api.n8n.createLead"
      via: "ctx.runMutation"
      pattern: "runMutation.*n8n\\.createLead"
    - from: "createLead"
      to: "contacts table"
      via: "ctx.db.insert"
      pattern: "db\\.insert.*contacts"
---

<objective>
Verify n8n webhook endpoint works in production with real lead data

Purpose: Confirm LEAD-01 requirement â€” n8n webhook delivers leads to Convex CRM in production
Output: Verified webhook endpoint with documented test results
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/05-lead-flow/05-RESEARCH.md
@convex/http.ts
@convex/n8n.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test webhook endpoint with curl</name>
  <files>N/A (no files modified - verification only)</files>
  <action>
Test the production n8n webhook endpoint with a curl request:

```bash
curl -X POST https://intent-otter-212.convex.cloud/webhook/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Lead Phase5",
    "phone": "+6281234500001",
    "email": "test-phase5@example.com",
    "lead_score": 65,
    "metadata": {
      "form_answers": {
        "Level Bahasa Inggris": "Menengah",
        "Budget": "100-300jt",
        "Negara Tujuan": "UK"
      },
      "source": "phase-5-verification"
    }
  }'
```

Expected response:
- status: 200
- body: `{ "success": true, "status": "created", "contact_id": "..." }`

If endpoint returns error:
- 404: Check Convex deployment status
- 500: Check Convex logs in dashboard
- Connection error: Verify production URL is correct

Log the full response for verification.
  </action>
  <verify>
curl command returns 200 with `success: true` and `status: "created"` or `status: "exists"`
  </verify>
  <done>
Webhook endpoint responds correctly to POST request with lead data
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify duplicate detection works</name>
  <files>N/A (no files modified - verification only)</files>
  <action>
Test duplicate detection by sending the same phone number again:

```bash
curl -X POST https://intent-otter-212.convex.cloud/webhook/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Lead Phase5 Duplicate",
    "phone": "+6281234500001",
    "email": "duplicate@example.com",
    "lead_score": 80,
    "metadata": {
      "source": "phase-5-duplicate-test"
    }
  }'
```

Expected response:
- status: 200 (NOT 400 or 500)
- body: `{ "success": true, "status": "exists", "contact_id": "..." }`

The contact_id should match the first request. This confirms:
1. Phone normalization works (+6281234500001 matches)
2. Duplicate detection via `by_workspace_phone` index works
3. Idempotent behavior (no error on duplicate)
  </action>
  <verify>
Second curl command returns `status: "exists"` with same contact_id as first request
  </verify>
  <done>
Duplicate phone numbers are detected and return success with "exists" status
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Webhook endpoint verification with production endpoint</what-built>
  <how-to-verify>
1. Check Convex logs in dashboard:
   - Go to https://dashboard.convex.dev
   - Select intent-otter-212 deployment
   - View Logs tab
   - Look for "[n8n Webhook] Received lead data" and "[n8n] Contact created"

2. Verify lead in Contact Database:
   - Go to https://my21staff.com/eagle-overseas/database
   - Search for "Test Lead Phase5" or phone "+6281234500001"
   - Confirm fields are correct:
     - Name: "Test Lead Phase5"
     - Phone: "+6281234500001"
     - Email: "test-phase5@example.com"
     - Lead Score: 65
     - Status: "new"
     - Tags: ["google-form"]
     - Source: "n8n"
  </how-to-verify>
  <resume-signal>Type "approved" if lead appears correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] curl POST to production webhook returns 200
- [ ] Response contains `success: true`
- [ ] First request: `status: "created"`
- [ ] Second request (same phone): `status: "exists"`
- [ ] Convex logs show webhook processing
- [ ] Lead visible in Contact Database UI
</verification>

<success_criteria>
LEAD-01 is verified when:
1. Production webhook endpoint accepts POST requests
2. Valid lead data creates contact in database
3. Duplicate detection prevents double entries
4. Lead is visible in Contact Database UI
</success_criteria>

<output>
After completion, create `planning/phases/05-lead-flow/05-01-SUMMARY.md`
</output>
