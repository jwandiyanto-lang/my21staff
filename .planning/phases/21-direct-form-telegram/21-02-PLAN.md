# Plan 21-02: Connect Pricing Form to API

## Frontmatter

```yaml
wave: 1
depends_on: [21-01]
files_modified:
  - src/app/pricing/page.tsx (update)
autonomous: true
estimated_time: 10min
```

## Goal

Update the pricing page form to submit to the new `/api/leads` endpoint instead of n8n webhook.

## Context

- Current form posts to `process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL`
- Need to change to `/api/leads` (relative URL)
- Form data structure matches what API expects
- No other changes needed - form already collects all fields

## Tasks

<task id="1">
Update `src/app/pricing/page.tsx` - change the `handleSubmit` function:

**Find this code (around line 90-131):**
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setIsSubmitting(true);

  const webhookUrl = process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL || "https://n8n.example.com/webhook/pricing-form";

  try {
    const response = await fetch(webhookUrl, {
      // ...
    });
```

**Replace with:**
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setIsSubmitting(true);

  try {
    const response = await fetch("/api/leads", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nama,
        whatsapp: `${countryCode}${whatsapp}`,
        jenisBisnis,
        dariManaTahu,
        leadSources: leadSources.join(", "),
        currentTracking,
        leadsPerMonth,
        masalahBisnis,
        teamSize,
        paket: selectedPlan,
        timestamp: new Date().toISOString(),
      }),
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || "Failed to submit form");
    }

    // Success
    setSubmitSuccess(true);
    resetForm();

    // Close modal after brief success state
    setTimeout(() => {
      setModalOpen(false);
      setSubmitSuccess(false);
    }, 2000);
  } catch (error) {
    console.error("Form submission error:", error);
    alert("Gagal mengirim form. Silakan coba lagi.");
  } finally {
    setIsSubmitting(false);
  }
};
```

Key changes:
1. Remove `webhookUrl` variable - use `/api/leads` directly
2. Keep all existing form data fields
3. Better error handling (parse error message from response)
</task>

## Verification

1. **Form submits to API:** Open pricing page, fill form, submit
   - Check Network tab: POST to `/api/leads` (not n8n)
   - Check response: `{"success":true,...}`

2. **Contact appears in Supabase:**
   - Query: `SELECT * FROM contacts ORDER BY created_at DESC LIMIT 1`
   - Verify: name, phone, tags include 'pricing-form-lead'

3. **Telegram notification received:** (if configured)
   - Check Telegram chat for notification with lead details

## must_haves

- [ ] Form submits to `/api/leads` (not n8n webhook)
- [ ] Success state shows after submission
- [ ] Error message displays if API fails
- [ ] Modal closes after 2 seconds on success
