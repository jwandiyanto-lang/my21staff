# Plan 21-01: Leads API + Telegram Notifications

## Frontmatter

```yaml
wave: 1
depends_on: []
files_modified:
  - src/app/api/leads/route.ts (create)
  - src/lib/telegram/client.ts (create)
  - .env.example (update)
autonomous: true
estimated_time: 20min
```

## Goal

Create a public API endpoint for lead submission that saves to Supabase and sends Telegram notification.

## Context

- Follow pattern from `src/app/api/webinars/register/route.ts`
- Use existing `rateLimit` from `src/lib/rate-limit.ts`
- Contacts table has: id, workspace_id, phone, name, email, lead_score, lead_status, tags, metadata
- Telegram API: POST https://api.telegram.org/bot{TOKEN}/sendMessage

## Tasks

<task id="1">
Create Telegram client at `src/lib/telegram/client.ts`:

```typescript
/**
 * Telegram notification client
 * Sends instant notifications when new leads arrive
 */

interface TelegramMessage {
  chatId: string
  text: string
  parseMode?: 'HTML' | 'Markdown'
}

export async function sendTelegramMessage({ chatId, text, parseMode = 'HTML' }: TelegramMessage): Promise<boolean> {
  const token = process.env.TELEGRAM_BOT_TOKEN

  if (!token) {
    console.warn('TELEGRAM_BOT_TOKEN not configured, skipping notification')
    return false
  }

  try {
    const response = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text,
        parse_mode: parseMode,
      }),
    })

    if (!response.ok) {
      const error = await response.text()
      console.error('Telegram API error:', error)
      return false
    }

    return true
  } catch (error) {
    console.error('Telegram send failed:', error)
    return false
  }
}

export function formatLeadNotification(lead: {
  name: string
  phone: string
  businessType: string
  plan: string
  problem: string
}): string {
  return `ðŸ†• <b>New Lead!</b>

<b>Name:</b> ${lead.name}
<b>WhatsApp:</b> ${lead.phone}
<b>Business:</b> ${lead.businessType}
<b>Plan:</b> ${lead.plan}
<b>Problem:</b> ${lead.problem}

ðŸ“± <a href="https://wa.me/${lead.phone.replace(/\+/g, '')}">Chat on WhatsApp</a>`
}
```
</task>

<task id="2">
Create leads API endpoint at `src/app/api/leads/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { rateLimit } from '@/lib/rate-limit'
import { sendTelegramMessage, formatLeadNotification } from '@/lib/telegram/client'

function isDevMode(): boolean {
  return process.env.NEXT_PUBLIC_DEV_MODE === 'true' && process.env.NODE_ENV !== 'production'
}

/**
 * POST /api/leads
 *
 * PUBLIC endpoint - no auth required.
 * Receives lead submissions from pricing form, creates contact, sends Telegram notification.
 */
export async function POST(request: NextRequest) {
  try {
    // Rate limit: 10 requests per minute per IP
    const rateLimitResponse = rateLimit(request, { limit: 10, windowMs: 60 * 1000 })
    if (rateLimitResponse) return rateLimitResponse

    const body = await request.json()
    const {
      nama,
      whatsapp,
      jenisBisnis,
      dariManaTahu,
      leadSources,
      currentTracking,
      leadsPerMonth,
      masalahBisnis,
      teamSize,
      paket,
      workspace_id,
    } = body

    // Validate required fields
    if (!nama?.trim()) {
      return NextResponse.json({ error: 'nama is required' }, { status: 400 })
    }

    if (!whatsapp?.trim()) {
      return NextResponse.json({ error: 'whatsapp is required' }, { status: 400 })
    }

    // Normalize phone number - remove spaces
    const normalizedPhone = whatsapp.trim().replace(/\s+/g, '')

    // Get workspace ID from body or env
    const actualWorkspaceId = workspace_id || process.env.NEXT_PUBLIC_PRICING_WORKSPACE_ID

    if (!actualWorkspaceId) {
      console.error('No workspace_id configured for leads')
      return NextResponse.json({ error: 'Server configuration error' }, { status: 500 })
    }

    if (isDevMode()) {
      // Dev mode: return mock success
      const now = new Date().toISOString()
      return NextResponse.json({
        success: true,
        contact_id: `contact-${Date.now()}`,
        is_new_contact: true,
        message: 'Lead received (dev mode)',
        created_at: now,
      }, { status: 201 })
    }

    const supabase = await createClient()

    // Check if contact exists by phone in workspace
    const { data: existingContact } = await supabase
      .from('contacts')
      .select('id, name')
      .eq('workspace_id', actualWorkspaceId)
      .eq('phone', normalizedPhone)
      .single()

    let contactId: string
    let isNewContact = false
    const now = new Date().toISOString()

    if (existingContact) {
      // Contact exists - update metadata
      contactId = existingContact.id

      await supabase
        .from('contacts')
        .update({
          metadata: {
            source: 'pricing_form',
            plan: paket,
            business_type: jenisBisnis,
            referral_source: dariManaTahu,
            lead_sources: leadSources,
            current_tracking: currentTracking,
            leads_per_month: leadsPerMonth,
            pain_point: masalahBisnis,
            team_size: teamSize,
            updated_from_form: now,
          },
          updated_at: now,
        })
        .eq('id', contactId)
    } else {
      // Create new contact
      const { data: newContact, error: contactError } = await supabase
        .from('contacts')
        .insert({
          workspace_id: actualWorkspaceId,
          phone: normalizedPhone,
          name: nama.trim(),
          lead_score: 60, // Higher score for pricing form leads (showing intent)
          lead_status: 'new',
          tags: ['pricing-form-lead', `plan-${paket?.toLowerCase() || 'unknown'}`],
          metadata: {
            source: 'pricing_form',
            plan: paket,
            business_type: jenisBisnis,
            referral_source: dariManaTahu,
            lead_sources: leadSources,
            current_tracking: currentTracking,
            leads_per_month: leadsPerMonth,
            pain_point: masalahBisnis,
            team_size: teamSize,
          },
          created_at: now,
          updated_at: now,
        })
        .select('id')
        .single()

      if (contactError || !newContact) {
        console.error('Create contact error:', contactError)
        return NextResponse.json({ error: 'Failed to create contact' }, { status: 500 })
      }

      contactId = newContact.id
      isNewContact = true
    }

    // Send Telegram notification (async, don't block response)
    const telegramChatId = process.env.TELEGRAM_CHAT_ID
    if (telegramChatId) {
      const notificationText = formatLeadNotification({
        name: nama.trim(),
        phone: normalizedPhone,
        businessType: jenisBisnis || 'Not specified',
        plan: paket || 'Not specified',
        problem: masalahBisnis || 'Not specified',
      })

      // Fire and forget - don't await
      sendTelegramMessage({
        chatId: telegramChatId,
        text: notificationText,
      }).catch(err => console.error('Telegram notification failed:', err))
    }

    return NextResponse.json({
      success: true,
      contact_id: contactId,
      is_new_contact: isNewContact,
      message: isNewContact ? 'Lead created successfully' : 'Lead updated successfully',
      created_at: now,
    }, { status: 201 })
  } catch (error) {
    console.error('POST /api/leads error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```
</task>

<task id="3">
Update `.env.example` with new variables:

Add these lines:
```env
# Telegram notifications
TELEGRAM_BOT_TOKEN=your-bot-token-from-botfather
TELEGRAM_CHAT_ID=your-chat-id

# Pricing form workspace (for lead capture)
NEXT_PUBLIC_PRICING_WORKSPACE_ID=your-workspace-id
```
</task>

## Verification

1. **Telegram client exists:** `ls src/lib/telegram/client.ts`
2. **API route exists:** `ls src/app/api/leads/route.ts`
3. **Build passes:** `npm run build` succeeds
4. **Test API (dev mode):**
   ```bash
   curl -X POST http://localhost:3000/api/leads \
     -H "Content-Type: application/json" \
     -d '{"nama":"Test","whatsapp":"+6281234567890","jenisBisnis":"Test Business","paket":"Solo"}'
   ```
   Should return `{"success":true,...}`

## must_haves

- [ ] `/api/leads` endpoint accepts POST with form data
- [ ] Rate limiting active (10/min per IP)
- [ ] Contact created in Supabase with correct workspace_id
- [ ] Telegram notification sent on new lead
- [ ] Phone number normalized (spaces removed)
- [ ] Dev mode returns mock response without DB/Telegram calls
