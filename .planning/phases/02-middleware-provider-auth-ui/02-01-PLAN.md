---
phase: 02-middleware-provider-auth-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/providers.tsx
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "ClerkProvider wraps the entire app"
    - "ConvexProviderWithClerk passes Clerk tokens to Convex"
    - "Protected routes redirect unauthenticated users to /sign-in"
    - "Public routes accessible without authentication"
  artifacts:
    - path: "src/app/providers.tsx"
      provides: "ClerkProvider + ConvexProviderWithClerk setup"
      contains: "ClerkProvider"
    - path: "src/middleware.ts"
      provides: "Clerk route protection"
      contains: "clerkMiddleware"
  key_links:
    - from: "src/app/providers.tsx"
      to: "convex"
      via: "ConvexProviderWithClerk with useAuth"
      pattern: "ConvexProviderWithClerk.*useAuth"
    - from: "src/middleware.ts"
      to: "Clerk"
      via: "clerkMiddleware"
      pattern: "clerkMiddleware"
---

<objective>
Set up Clerk infrastructure: install packages, configure providers with Convex integration, and implement route protection middleware.

Purpose: Enable Clerk authentication to work with existing Convex backend, replacing Supabase middleware.
Output: Working Clerk provider wrapping the app, middleware protecting routes, ready for auth UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-clerk-auth-infrastructure/01-01-SUMMARY.md
@.planning/phases/02-middleware-provider-auth-ui/02-CONTEXT.md

# Existing files to modify
@src/app/providers.tsx
@src/middleware.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk packages and configure providers</name>
  <files>
    - package.json
    - src/app/providers.tsx
  </files>
  <action>
1. Install @clerk/nextjs:
   ```bash
   npm install @clerk/nextjs
   ```

2. Update src/app/providers.tsx to:
   - Import ClerkProvider from @clerk/nextjs
   - Import ConvexProviderWithClerk from convex/react-clerk
   - Import ConvexReactClient from convex/react
   - Import useAuth from @clerk/nextjs
   - Create ConvexReactClient with NEXT_PUBLIC_CONVEX_URL
   - Wrap children with ClerkProvider -> ConvexProviderWithClerk -> QueryClientProvider

Structure:
```tsx
'use client'

import { ClerkProvider, useAuth } from '@clerk/nextjs'
import { ConvexProviderWithClerk } from 'convex/react-clerk'
import { ConvexReactClient } from 'convex/react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { useState } from 'react'

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export function Providers({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({...existing config...}))

  return (
    <ClerkProvider>
      <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
        <QueryClientProvider client={queryClient}>
          {children}
        </QueryClientProvider>
      </ConvexProviderWithClerk>
    </ClerkProvider>
  )
}
```

Note: The NEXT_PUBLIC_CONVEX_URL env var should already exist from v3.0. If not, add it to .env.local.
  </action>
  <verify>
    - `npm ls @clerk/nextjs` shows package installed
    - `grep -l "ClerkProvider" src/app/providers.tsx` returns the file
    - `grep -l "ConvexProviderWithClerk" src/app/providers.tsx` returns the file
    - `npm run build` passes (no TypeScript errors)
  </verify>
  <done>
    - @clerk/nextjs installed in package.json
    - providers.tsx exports Providers with ClerkProvider wrapping ConvexProviderWithClerk wrapping QueryClientProvider
    - Build compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace Supabase middleware with Clerk middleware</name>
  <files>src/middleware.ts</files>
  <action>
Replace the entire src/middleware.ts content with Clerk middleware:

```tsx
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

// Public routes that don't require authentication
const isPublicRoute = createRouteMatcher([
  '/',
  '/sign-in(.*)',
  '/sign-up(.*)',
  '/pricing',
  '/articles(.*)',
  '/api/webhooks(.*)',
  '/api/public(.*)',
])

export default clerkMiddleware(async (auth, request) => {
  if (!isPublicRoute(request)) {
    await auth.protect()
  }
})

export const config = {
  matcher: [
    // Skip Next.js internals and static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
}
```

Key changes from Supabase middleware:
- Remove all Supabase imports and client creation
- Remove must_change_password check (Clerk handles password flows)
- Use clerkMiddleware with createRouteMatcher for public routes
- auth.protect() handles redirects automatically (to /sign-in by default)

Public routes preserved from existing config:
- / (landing page)
- /sign-in, /sign-up (new Clerk auth pages)
- /pricing
- /articles/* (public CMS content)
- /api/webhooks/* (Kapso, n8n webhooks)
- /api/public/* (public API endpoints like pricing form)

Removed from public (now require auth):
- /login, /signup (old routes, redirect to /sign-in, /sign-up)
- /change-password, /set-password, /forgot-password, /reset-password (Clerk handles internally)
  </action>
  <verify>
    - `grep -l "clerkMiddleware" src/middleware.ts` returns the file
    - `grep -v "supabase" src/middleware.ts` shows no Supabase references
    - `npm run build` passes
  </verify>
  <done>
    - middleware.ts uses clerkMiddleware from @clerk/nextjs/server
    - No Supabase imports remain in middleware
    - Public routes defined: /, /sign-in, /sign-up, /pricing, /articles/*, /api/webhooks/*, /api/public/*
    - Protected routes redirect to /sign-in when unauthenticated
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Clerk env vars and test middleware</name>
  <files>None (verification only)</files>
  <action>
1. Verify environment variables exist in .env.local:
   - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY (from Phase 1)
   - CLERK_SECRET_KEY (from Phase 1)
   - NEXT_PUBLIC_CONVEX_URL (from v3.0)

2. Start dev server and test:
   ```bash
   npm run dev
   ```

3. Test public routes are accessible:
   - Visit http://localhost:3000 (landing page)
   - Visit http://localhost:3000/pricing

4. Test protected routes redirect:
   - Visit http://localhost:3000/dashboard (should redirect to /sign-in)
   - Visit http://localhost:3000/eagle (any workspace, should redirect)

Note: /sign-in page doesn't exist yet, so redirect will 404. This is expected - Plan 02 creates the auth pages.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Landing page (/) loads correctly
    - Protected routes redirect to /sign-in (even if 404)
    - No Supabase-related errors in console
  </verify>
  <done>
    - Dev server runs without Clerk/Convex errors
    - Public routes accessible without auth
    - Protected routes trigger redirect to /sign-in
    - Clerk middleware is functioning correctly
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` completes successfully
2. `npm run dev` starts without errors
3. ClerkProvider and ConvexProviderWithClerk wrap the app
4. Middleware protects routes correctly
5. No Supabase auth code remains in middleware or providers
</verification>

<success_criteria>
- @clerk/nextjs installed and working
- providers.tsx: ClerkProvider -> ConvexProviderWithClerk -> QueryClientProvider hierarchy
- middleware.ts: Clerk-based route protection
- Public routes accessible, protected routes redirect to /sign-in
- No Supabase auth references in middleware or providers
- Build passes, dev server runs
</success_criteria>

<output>
After completion, create `.planning/phases/02-middleware-provider-auth-ui/02-01-SUMMARY.md`
</output>
