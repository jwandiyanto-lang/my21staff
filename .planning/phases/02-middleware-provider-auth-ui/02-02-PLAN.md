---
phase: 02-middleware-provider-auth-ui
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
  - src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
  - src/components/workspace/sidebar.tsx
  - src/components/portal/portal-header.tsx
autonomous: false

must_haves:
  truths:
    - "User can sign in with Clerk SignIn component"
    - "User can sign up with Clerk SignUp component"
    - "User profile menu uses Clerk UserButton"
    - "Password reset works via Clerk built-in flow"
    - "Sign-out redirects to landing page"
  artifacts:
    - path: "src/app/(auth)/sign-in/[[...sign-in]]/page.tsx"
      provides: "Clerk sign-in page"
      contains: "SignIn"
    - path: "src/app/(auth)/sign-up/[[...sign-up]]/page.tsx"
      provides: "Clerk sign-up page"
      contains: "SignUp"
    - path: "src/components/workspace/sidebar.tsx"
      provides: "User menu with Clerk UserButton"
      contains: "UserButton"
  key_links:
    - from: "src/app/(auth)/sign-in"
      to: "Clerk"
      via: "SignIn component"
      pattern: "<SignIn"
    - from: "src/components/workspace/sidebar.tsx"
      to: "Clerk"
      via: "UserButton component"
      pattern: "<UserButton"
---

<objective>
Create Clerk auth UI pages and replace user profile menu with Clerk UserButton.

Purpose: Complete the user-facing authentication experience with sign-in, sign-up, password reset (built-in), and user menu.
Output: Working auth pages matching my21staff brand, UserButton in sidebar and portal header.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-middleware-provider-auth-ui/02-CONTEXT.md
@.planning/phases/02-middleware-provider-auth-ui/02-01-SUMMARY.md

# Existing files to reference for styling
@src/app/(auth)/login/page.tsx
@src/app/(auth)/signup/page.tsx

# Files to modify
@src/components/workspace/sidebar.tsx
@src/components/portal/portal-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Clerk sign-in and sign-up pages</name>
  <files>
    - src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
    - src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
  </files>
  <action>
Create new auth pages using Clerk components with my21staff styling.

**Important:** Use Clerk's catch-all route pattern `[[...sign-in]]` for proper handling of Clerk's internal routes (password reset, MFA, etc).

1. Create src/app/(auth)/sign-in/[[...sign-in]]/page.tsx:

```tsx
import { SignIn } from '@clerk/nextjs'
import Link from 'next/link'

export default function SignInPage() {
  return (
    <div className="min-h-screen relative overflow-hidden">
      {/* Background - matches existing auth pages */}
      <div className="absolute inset-0 bg-gradient-to-br from-[#9CB99C] via-[#A8C5A8] to-[#B5D1B5]">
        <div
          className="absolute inset-0 opacity-30"
          style={{
            backgroundImage: `
              linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)
            `,
            backgroundSize: '60px 60px'
          }}
        />
        <div className="absolute top-20 left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl" />
        <div className="absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl" />
        <div className="absolute top-1/2 left-1/3 w-48 h-48 bg-[#2D4B3E]/10 rounded-full blur-2xl" />
      </div>

      {/* Frosted overlay */}
      <div className="absolute inset-0 backdrop-blur-[2px] bg-black/5" />

      {/* Navigation */}
      <nav className="relative z-20 px-6 py-4">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <Link href="/" className="text-2xl font-black text-white drop-shadow-sm">
            21
          </Link>
        </div>
      </nav>

      {/* Clerk SignIn */}
      <div className="relative z-10 min-h-[calc(100vh-80px)] flex items-center justify-center px-4">
        <SignIn
          appearance={{
            elements: {
              rootBox: 'mx-auto',
              card: 'backdrop-blur-xl bg-white/70 rounded-3xl shadow-2xl border border-white/50',
              headerTitle: 'text-3xl font-bold text-gray-900',
              headerSubtitle: 'text-gray-600',
              socialButtonsBlockButton: 'bg-white/50 border-gray-200/50 hover:bg-white/70',
              formButtonPrimary: 'bg-[#2D4B3E] hover:bg-[#243D32] shadow-lg shadow-[#2D4B3E]/20',
              formFieldInput: 'bg-white/50 border-gray-200/50 focus:ring-[#2D4B3E]/30 focus:border-[#2D4B3E]/50 rounded-xl',
              footerActionLink: 'text-[#2D4B3E] font-semibold hover:underline',
            },
          }}
          routing="path"
          path="/sign-in"
          signUpUrl="/sign-up"
          forceRedirectUrl="/dashboard"
        />
      </div>
    </div>
  )
}
```

2. Create src/app/(auth)/sign-up/[[...sign-up]]/page.tsx:

```tsx
import { SignUp } from '@clerk/nextjs'
import Link from 'next/link'

export default function SignUpPage() {
  return (
    <div className="min-h-screen relative overflow-hidden">
      {/* Background - same as sign-in */}
      <div className="absolute inset-0 bg-gradient-to-br from-[#9CB99C] via-[#A8C5A8] to-[#B5D1B5]">
        <div
          className="absolute inset-0 opacity-30"
          style={{
            backgroundImage: `
              linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)
            `,
            backgroundSize: '60px 60px'
          }}
        />
        <div className="absolute top-20 left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl" />
        <div className="absolute bottom-20 right-20 w-96 h-96 bg-white/10 rounded-full blur-3xl" />
        <div className="absolute top-1/2 left-1/3 w-48 h-48 bg-[#2D4B3E]/10 rounded-full blur-2xl" />
      </div>

      <div className="absolute inset-0 backdrop-blur-[2px] bg-black/5" />

      <nav className="relative z-20 px-6 py-4">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <Link href="/" className="text-2xl font-black text-white drop-shadow-sm">
            21
          </Link>
        </div>
      </nav>

      <div className="relative z-10 min-h-[calc(100vh-80px)] flex items-center justify-center px-4">
        <SignUp
          appearance={{
            elements: {
              rootBox: 'mx-auto',
              card: 'backdrop-blur-xl bg-white/70 rounded-3xl shadow-2xl border border-white/50',
              headerTitle: 'text-3xl font-bold text-gray-900',
              headerSubtitle: 'text-gray-600',
              socialButtonsBlockButton: 'bg-white/50 border-gray-200/50 hover:bg-white/70',
              formButtonPrimary: 'bg-[#2D4B3E] hover:bg-[#243D32] shadow-lg shadow-[#2D4B3E]/20',
              formFieldInput: 'bg-white/50 border-gray-200/50 focus:ring-[#2D4B3E]/30 focus:border-[#2D4B3E]/50 rounded-xl',
              footerActionLink: 'text-[#2D4B3E] font-semibold hover:underline',
            },
          }}
          routing="path"
          path="/sign-up"
          signInUrl="/sign-in"
          forceRedirectUrl="/dashboard"
        />
      </div>
    </div>
  )
}
```

**Key points:**
- Use `forceRedirectUrl="/dashboard"` to redirect after auth (as per CONTEXT.md: redirect to /app)
- Clerk's appearance API styles the components to match my21staff brand
- Password reset is handled automatically by Clerk (no separate page needed)
- Email verification handled by Clerk built-in flow
  </action>
  <verify>
    - Both page files exist with SignIn/SignUp components
    - `npm run build` passes (no TypeScript errors)
    - Both pages render correctly at /sign-in and /sign-up
  </verify>
  <done>
    - /sign-in page with Clerk SignIn component and my21staff styling
    - /sign-up page with Clerk SignUp component and my21staff styling
    - Both pages use consistent brand colors (#2D4B3E, sage gradient)
    - Password reset accessible via "Forgot password?" link in SignIn
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace user profile menus with Clerk UserButton</name>
  <files>
    - src/components/workspace/sidebar.tsx
    - src/components/portal/portal-header.tsx
  </files>
  <action>
Replace the custom user profile sections with Clerk UserButton.

1. Update src/components/workspace/sidebar.tsx:

Replace the "User Profile" section at the bottom of the sidebar with UserButton:

```tsx
// Add import at top
import { UserButton } from '@clerk/nextjs'

// Replace the User Profile div (lines ~213-233) with:
{/* User Profile */}
<div className={cn('p-2', collapsed ? 'px-2' : 'p-4')}>
  {collapsed ? (
    <div className="flex justify-center p-2">
      <UserButton
        appearance={{
          elements: {
            avatarBox: 'w-10 h-10',
          },
        }}
        afterSignOutUrl="/"
      />
    </div>
  ) : (
    <div className="flex items-center gap-3 p-3 bg-white/10 rounded-2xl border border-white/10">
      <UserButton
        appearance={{
          elements: {
            avatarBox: 'w-10 h-10',
          },
        }}
        afterSignOutUrl="/"
        showName={false}
      />
      <div className="overflow-hidden">
        <p className="text-sm font-bold text-white truncate">{workspace.name}</p>
        <p className="text-[10px] text-white/50 font-mono uppercase tracking-tighter">
          {isAdmin ? 'Admin' : 'Client'} Access
        </p>
      </div>
    </div>
  )}
</div>
```

Also remove:
- The `User` import from lucide-react (no longer needed for profile section)
- Keep createClient import if still used elsewhere (for unread count query)

2. Update src/components/portal/portal-header.tsx:

Replace the custom dropdown with UserButton:

```tsx
'use client'

import Link from 'next/link'
import { Ticket } from 'lucide-react'
import { UserButton } from '@clerk/nextjs'

interface PortalHeaderProps {
  userName: string
  userEmail: string
}

export function PortalHeader({ userName, userEmail }: PortalHeaderProps) {
  return (
    <header className="border-b bg-background">
      <div className="container mx-auto px-4 py-4 max-w-4xl flex items-center justify-between">
        <Link href="/portal/support" className="flex items-center gap-2">
          <Ticket className="h-6 w-6" />
          <span className="font-semibold text-lg">Support Portal</span>
        </Link>

        <div className="flex items-center gap-3">
          <div className="text-right mr-2">
            <p className="text-sm font-medium">{userName}</p>
            <p className="text-xs text-muted-foreground">{userEmail}</p>
          </div>
          <UserButton afterSignOutUrl="/" />
        </div>
      </div>
    </header>
  )
}
```

Remove:
- useState import (no longer needed)
- useRouter import (no longer needed)
- Button import
- DropdownMenu imports
- LogOut icon import
- createClient import

**afterSignOutUrl="/"** ensures sign-out redirects to landing page (as per CONTEXT.md).
  </action>
  <verify>
    - `grep -l "UserButton" src/components/workspace/sidebar.tsx` returns the file
    - `grep -l "UserButton" src/components/portal/portal-header.tsx` returns the file
    - `npm run build` passes
  </verify>
  <done>
    - Workspace sidebar uses Clerk UserButton for profile section
    - Portal header uses Clerk UserButton
    - Sign-out redirects to / (landing page)
    - Avatar shows user photo or initials fallback (Clerk default)
    - "Manage account" option available in UserButton dropdown
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Clerk env vars to middleware config</name>
  <files>None (verification of existing setup)</files>
  <action>
Verify the Clerk environment variables are properly configured for the sign-in/sign-up redirects:

1. Check .env.local has:
   - NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
   - NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
   - NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
   - NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard

   If missing, add them to .env.local.

2. These env vars tell Clerk where to redirect for auth flows.

Note: The forceRedirectUrl in SignIn/SignUp components takes precedence, but these env vars provide fallbacks and are used by middleware.
  </action>
  <verify>
    - .env.local contains NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
    - .env.local contains NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
  </verify>
  <done>
    - Clerk redirect env vars configured
    - Auth flow redirects work correctly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Clerk auth UI: sign-in page, sign-up page, and UserButton in sidebar/portal header. Password reset via Clerk's built-in flow.
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Visit http://localhost:3000/sign-in
       - Verify sign-in form appears with my21staff styling (sage green gradient background)
       - Verify "Forgot password?" link is visible
    3. Visit http://localhost:3000/sign-up
       - Verify sign-up form appears with matching styling
    4. Test sign-in flow:
       - Enter valid credentials (create test user in Clerk Dashboard if needed)
       - Verify redirect to /dashboard after sign-in
    5. Test UserButton:
       - Once signed in, verify UserButton shows in sidebar
       - Click UserButton, verify "Manage account" and "Sign out" options
       - Click "Sign out", verify redirect to landing page (/)
    6. Test password reset:
       - On sign-in page, click "Forgot password?"
       - Enter email, verify Clerk sends reset email
       - (Email actually arrives and works)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` completes successfully
2. /sign-in and /sign-up pages render correctly
3. UserButton appears in sidebar and portal header
4. Sign-in -> redirects to /dashboard
5. Sign-out -> redirects to /
6. Password reset flow works via Clerk
</verification>

<success_criteria>
- Sign-in page at /sign-in with Clerk SignIn component
- Sign-up page at /sign-up with Clerk SignUp component
- Both pages match my21staff brand (sage green gradient, #2D4B3E buttons)
- UserButton replaces custom profile menus in sidebar and portal header
- Sign-out redirects to landing page
- Password reset works via Clerk (fixes broken Supabase flow)
- Full auth flow: sign-up -> email verify -> sign-in -> dashboard -> sign-out -> landing
</success_criteria>

<output>
After completion, create `.planning/phases/02-middleware-provider-auth-ui/02-02-SUMMARY.md`
</output>
