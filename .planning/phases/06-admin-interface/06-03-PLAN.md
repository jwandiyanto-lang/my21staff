---
phase: 06-admin-interface
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/knowledge-base/database-tab.tsx
  - src/app/api/workspaces/[workspaceId]/knowledge/route.ts
  - src/app/api/workspaces/[workspaceId]/knowledge/[entryId]/route.ts
  - supabase/migrations/41_knowledge_entries.sql
  - src/lib/ari/types.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create custom knowledge categories"
    - "Admin can add knowledge entries with title and content"
    - "Admin can edit and delete entries"
    - "Entries are organized by category"
    - "Knowledge persists and loads on refresh"
  artifacts:
    - path: "src/components/knowledge-base/database-tab.tsx"
      provides: "Knowledge database UI component"
      exports: ["DatabaseTab"]
    - path: "src/app/api/workspaces/[workspaceId]/knowledge/route.ts"
      provides: "Knowledge categories and entries API"
      exports: ["GET", "POST"]
    - path: "supabase/migrations/41_knowledge_entries.sql"
      provides: "ari_knowledge_categories and ari_knowledge_entries tables"
  key_links:
    - from: "database-tab.tsx"
      to: "/api/workspaces/[workspaceId]/knowledge"
      via: "fetch for CRUD"
      pattern: "fetch.*knowledge"
---

<objective>
Create the Database tab for managing custom knowledge entries.

Purpose: Replace the structured ari_destinations table (university-specific) with a generic knowledge system. Admins create their own categories (e.g., "Universities", "Scholarships", "FAQ") and add simple key-value entries (Title + Content). This fulfills KB-01 through KB-06 as reinterpreted in CONTEXT.md.

Output: DatabaseTab component + API routes + database tables for flexible knowledge storage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-interface/06-CONTEXT.md

# Current knowledge base approach (being generalized)
@src/lib/ari/knowledge-base.ts
@supabase/migrations/34_ari_tables.sql (ari_destinations - for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Knowledge Database Migration</name>
  <files>supabase/migrations/41_knowledge_entries.sql</files>
  <action>
Create migration for generic knowledge storage:

```sql
-- Categories for organizing knowledge
CREATE TABLE ari_knowledge_categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  display_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(workspace_id, name)
);

-- Individual knowledge entries
CREATE TABLE ari_knowledge_entries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  category_id UUID REFERENCES ari_knowledge_categories(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**RLS Policies:** Use workspace member pattern (same as ari_config).
**Indexes:** workspace_id, category_id.
**Triggers:** updated_at triggers for both tables.
  </action>
  <verify>
Run migration. Tables ari_knowledge_categories and ari_knowledge_entries exist.
  </verify>
  <done>
Database tables for flexible knowledge storage created with RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Knowledge API Routes</name>
  <files>
src/app/api/workspaces/[workspaceId]/knowledge/route.ts
src/app/api/workspaces/[workspaceId]/knowledge/[entryId]/route.ts
src/lib/ari/types.ts
  </files>
  <action>
**Add types to types.ts:**
```typescript
export interface KnowledgeCategory {
  id: string;
  workspace_id: string;
  name: string;
  description: string | null;
  display_order: number;
  created_at: string;
  updated_at: string;
}

export interface KnowledgeEntry {
  id: string;
  workspace_id: string;
  category_id: string | null;
  title: string;
  content: string;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}
```

**Main route (/api/workspaces/[workspaceId]/knowledge):**

**GET** - Fetch all categories with their entries
- Return { categories: KnowledgeCategory[], entries: KnowledgeEntry[] }
- Order categories by display_order
- Order entries by created_at desc

**POST** - Create category or entry
- Body type: "category" -> create category { name, description? }
- Body type: "entry" -> create entry { category_id?, title, content }

**Entry route (/api/workspaces/[workspaceId]/knowledge/[entryId]):**

**PUT** - Update entry
- Body: { title?, content?, category_id?, is_active? }

**DELETE** - Delete entry
- Deletes single entry by ID

**Category operations via main route:**
- POST with type="category" creates
- PUT (special case: body has { category_id, name, description }) updates category
- DELETE (query param: categoryId) deletes category and all its entries
  </action>
  <verify>
- GET returns empty arrays initially
- POST type=category creates category
- POST type=entry creates entry
- PUT updates entry
- DELETE removes entry
- Category delete cascades to entries
  </verify>
  <done>
API supports full CRUD for categories and entries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DatabaseTab Component</name>
  <files>src/components/knowledge-base/database-tab.tsx</files>
  <action>
Create DatabaseTab component with category/entry management:

**Layout:**
- Two-column: Categories sidebar (left, narrow) + Entries list (right, wide)
- "Add Category" button in sidebar header
- "Add Entry" button in entries header

**Categories Sidebar:**
- List of category names as clickable items
- "All" option at top (shows all entries)
- Click category to filter entries
- Right-click or menu icon for Edit/Delete category
- Active category highlighted

**Entries List:**
- Table or card list of entries
- Columns: Title, Content (truncated), Category badge, Actions
- Click entry to expand/edit inline
- Actions: Edit, Delete

**Add Category Dialog:**
- Name input (required)
- Description textarea (optional)
- Create button

**Add Entry Dialog:**
- Category dropdown (optional, can be "Uncategorized")
- Title input (required)
- Content textarea (required, larger)
- Create button

**Edit Entry (inline or dialog):**
- Same fields as add, pre-filled
- Save/Cancel buttons

**Behavior:**
- Load categories and entries on mount
- Filter entries by selected category
- Toast feedback on all CRUD operations
- Confirm dialog for deletes
- Show entry count per category in sidebar

**Empty States:**
- No categories: "Create your first category to organize knowledge"
- No entries: "Add entries to build your intern's knowledge base"
  </action>
  <verify>
- Component renders with empty state
- Can create category
- Can create entry (with/without category)
- Can filter by category
- Can edit and delete entries
- Can edit and delete categories (with cascade warning)
  </verify>
  <done>
DatabaseTab component provides intuitive knowledge management UI.
  </done>
</task>

</tasks>

<verification>
1. Navigate to Your Intern page
2. Click Database tab (after enabling in knowledge-base-client.tsx)
3. Create category "Universities"
4. Create entry in Universities: Title="University of Melbourne", Content="Located in Australia..."
5. Create category "FAQ"
6. Create entry without category (uncategorized)
7. Filter by category - see filtered entries
8. Edit an entry's content
9. Delete an entry
10. Delete a category (see cascade warning)
11. Refresh - all changes persist
</verification>

<success_criteria>
- KB-01: Knowledge CRUD (add, edit, delete) - COMPLETE via entries
- KB-02: No hierarchy needed (flat categories) - SIMPLIFIED per CONTEXT.md
- KB-03: Requirements per entry not needed (free-form content) - SIMPLIFIED
- KB-04: Programs list not needed (content is flexible text) - SIMPLIFIED
- KB-05: Promotion toggle not needed (simpler system) - DEFERRED
- KB-06: Notes field = Content field - COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-interface/06-03-SUMMARY.md`

Note: The existing ari_destinations table remains for backward compatibility. This new generic knowledge system is additive. Future work may migrate ari_destinations data or integrate both sources.
</output>
