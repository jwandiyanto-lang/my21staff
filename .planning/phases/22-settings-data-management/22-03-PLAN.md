---
phase: 22-settings-data-management
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - supabase/migrations/19_workspace_invitations.sql
  - src/types/database.ts
  - src/lib/email/transporter.ts
  - src/app/api/invitations/route.ts
  - src/app/api/invitations/accept/route.ts
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  - package.json
autonomous: false

user_setup:
  - service: hostinger-smtp
    why: "Send team invitation emails"
    env_vars:
      - name: SMTP_HOST
        value: "smtp.hostinger.com"
      - name: SMTP_PORT
        value: "587"
      - name: SMTP_USER
        source: "Hostinger email account (e.g., no-reply@my21staff.com)"
      - name: SMTP_PASS
        source: "Hostinger email password"
      - name: SMTP_FROM
        source: "Same as SMTP_USER"

must_haves:
  truths:
    - "Admin can invite team members by email"
    - "Invited user receives email with magic link"
    - "Clicking magic link adds user to workspace"
    - "Pending invitations are visible in team list"
    - "Invitation expires after 7 days"
  artifacts:
    - path: "supabase/migrations/19_workspace_invitations.sql"
      provides: "Database table for invitation tracking"
      contains: "CREATE TABLE workspace_invitations"
    - path: "src/lib/email/transporter.ts"
      provides: "Nodemailer SMTP configuration"
      exports: ["sendInvitationEmail"]
    - path: "src/app/api/invitations/route.ts"
      provides: "POST endpoint to create invitation"
      exports: ["POST"]
    - path: "src/app/api/invitations/accept/route.ts"
      provides: "GET endpoint to accept invitation"
      exports: ["GET"]
  key_links:
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "/api/invitations"
      via: "POST on invite button click"
      pattern: "api/invitations"
    - from: "src/lib/email/transporter.ts"
      to: "smtp.hostinger.com"
      via: "Nodemailer transport"
      pattern: "createTransport"
---

<objective>
Implement team member invitation via email with magic links using custom SMTP.

Purpose: Allow workspace admins to invite new team members who can then access the CRM.
Output: Working invitation flow: enter email -> send invitation -> user clicks link -> added to workspace.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-settings-data-management/22-RESEARCH.md
@.planning/phases/22-settings-data-management/22-01-SUMMARY.md

@src/app/(dashboard)/[workspace]/settings/settings-client.tsx
@src/lib/supabase/server.ts
@src/lib/auth/workspace-auth.ts
@src/types/database.ts
@supabase/migrations/18_contacts_assigned_to.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Invitations Table and Install Nodemailer</name>
  <files>
    supabase/migrations/19_workspace_invitations.sql
    src/types/database.ts
    package.json
  </files>
  <action>
1. Install Nodemailer:
   ```bash
   npm install nodemailer
   npm install -D @types/nodemailer
   ```

2. Create migration at `supabase/migrations/19_workspace_invitations.sql`:
   ```sql
   -- Team member invitations
   CREATE TABLE workspace_invitations (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
     email VARCHAR(255) NOT NULL,
     role VARCHAR(50) DEFAULT 'member',
     token VARCHAR(255) NOT NULL UNIQUE,
     status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'accepted', 'expired', 'cancelled'
     invited_by UUID REFERENCES auth.users(id),
     expires_at TIMESTAMPTZ NOT NULL,
     accepted_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW()
   );

   CREATE INDEX idx_invitations_workspace ON workspace_invitations(workspace_id);
   CREATE INDEX idx_invitations_email ON workspace_invitations(email);
   CREATE INDEX idx_invitations_token ON workspace_invitations(token);
   CREATE INDEX idx_invitations_status ON workspace_invitations(status);

   -- RLS: Only workspace admins/owners can manage invitations
   ALTER TABLE workspace_invitations ENABLE ROW LEVEL SECURITY;

   CREATE POLICY "Members can view invitations" ON workspace_invitations
     FOR SELECT USING (
       workspace_id IN (
         SELECT workspace_id FROM workspace_members
         WHERE user_id = auth.uid()
       )
     );

   CREATE POLICY "Admins can manage invitations" ON workspace_invitations
     FOR ALL USING (
       workspace_id IN (
         SELECT workspace_id FROM workspace_members
         WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
       )
     );
   ```

3. Update `src/types/database.ts` - add WorkspaceInvitation type:
   ```typescript
   export interface WorkspaceInvitation {
     id: string
     workspace_id: string
     email: string
     role: string
     token: string
     status: 'pending' | 'accepted' | 'expired' | 'cancelled'
     invited_by: string | null
     expires_at: string
     accepted_at: string | null
     created_at: string
     updated_at: string
   }
   ```
   Also add to Database interface Tables if following that pattern.

4. Apply migration:
   ```bash
   npx supabase db push
   ```
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Check migration applied in Supabase dashboard.
  </verify>
  <done>
    workspace_invitations table created with RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Email Transporter and Invitation APIs</name>
  <files>
    src/lib/email/transporter.ts
    src/app/api/invitations/route.ts
    src/app/api/invitations/accept/route.ts
  </files>
  <action>
1. Create email transporter at `src/lib/email/transporter.ts`:
   ```typescript
   import nodemailer from 'nodemailer'

   const transporter = nodemailer.createTransport({
     host: process.env.SMTP_HOST || 'smtp.hostinger.com',
     port: parseInt(process.env.SMTP_PORT || '587'),
     secure: process.env.SMTP_PORT === '465',
     auth: {
       user: process.env.SMTP_USER,
       pass: process.env.SMTP_PASS,
     },
   })

   export async function sendInvitationEmail({
     to,
     inviteLink,
     workspaceName,
     inviterName,
   }: {
     to: string
     inviteLink: string
     workspaceName: string
     inviterName: string
   }) {
     await transporter.sendMail({
       from: `"my21staff" <${process.env.SMTP_FROM || process.env.SMTP_USER}>`,
       to,
       subject: `Anda diundang ke ${workspaceName}`,
       html: `
         <div style="font-family: 'Plus Jakarta Sans', Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
           <h2 style="color: #1a1a1a;">Undangan Bergabung</h2>
           <p style="color: #4a4a4a; line-height: 1.6;">
             <strong>${inviterName}</strong> mengundang Anda untuk bergabung ke <strong>${workspaceName}</strong> di my21staff.
           </p>
           <p style="margin: 24px 0;">
             <a href="${inviteLink}"
                style="display: inline-block; background: #F7931A; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: 600;">
               Terima Undangan
             </a>
           </p>
           <p style="color: #888; font-size: 14px;">
             Link ini berlaku selama 7 hari.
           </p>
           <hr style="border: none; border-top: 1px solid #eee; margin: 24px 0;" />
           <p style="color: #888; font-size: 12px;">
             my21staff - WhatsApp CRM untuk bisnis Indonesia
           </p>
         </div>
       `,
     })
   }
   ```

2. Create invitation endpoint at `src/app/api/invitations/route.ts`:
   - POST accepting { email, workspaceId }
   - Use `requireWorkspaceMembership` for auth (must be admin/owner)
   - Check if email already has pending invitation
   - Use `createApiAdminClient().auth.admin.generateLink()`:
     ```typescript
     const { data: linkData, error } = await adminClient.auth.admin.generateLink({
       type: 'invite',
       email,
       options: {
         redirectTo: `${process.env.NEXT_PUBLIC_APP_URL || 'https://my21staff.vercel.app'}/api/invitations/accept`,
       },
     })
     ```
   - Extract token from linkData.properties.hashed_token
   - Store invitation in workspace_invitations table
   - Send email via sendInvitationEmail()
   - Return { success: true, invitation }

3. Create accept endpoint at `src/app/api/invitations/accept/route.ts`:
   - GET endpoint (Supabase redirects here after auth)
   - Parse token from URL (Supabase adds it as query param)
   - Look up invitation by token
   - Verify not expired, not already accepted
   - Add user to workspace_members table
   - Update invitation status to 'accepted'
   - Redirect to /{workspace-slug}/inbox
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build passes.
  </verify>
  <done>
    Email transporter and invitation APIs created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Settings UI for Team Invitations</name>
  <files>
    src/app/(dashboard)/[workspace]/settings/settings-client.tsx
    src/app/(dashboard)/[workspace]/settings/page.tsx
  </files>
  <action>
1. Update page.tsx to fetch pending invitations:
   ```typescript
   // After fetching members, also fetch pending invitations
   const { data: invitations } = await supabase
     .from('workspace_invitations')
     .select('*')
     .eq('workspace_id', workspace.id)
     .eq('status', 'pending')
     .order('created_at', { ascending: false })
   ```
   Pass `invitations` to SettingsClient.

2. Update settings-client.tsx:
   - Add invitations prop to SettingsClientProps
   - Update handleInvite to call API:
     ```typescript
     const handleInvite = async () => {
       if (!email.trim()) return
       setIsInviting(true)
       try {
         const res = await fetch('/api/invitations', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
             email: email.trim(),
             workspaceId: workspace.id,
           }),
         })
         if (!res.ok) {
           const err = await res.json()
           throw new Error(err.error || 'Failed to send invitation')
         }
         setEmail('')
         // Optionally refresh page or add to local state
         window.location.reload()
       } catch (error) {
         alert(error instanceof Error ? error.message : 'Failed to invite')
       } finally {
         setIsInviting(false)
       }
     }
     ```

3. In Team tab, show pending invitations below members table:
   ```tsx
   {invitations.length > 0 && (
     <Card className="mt-6">
       <CardHeader>
         <CardTitle className="text-lg">Pending Invitations</CardTitle>
       </CardHeader>
       <CardContent>
         <Table>
           <TableHeader>
             <TableRow>
               <TableHead>Email</TableHead>
               <TableHead>Sent</TableHead>
               <TableHead>Expires</TableHead>
             </TableRow>
           </TableHeader>
           <TableBody>
             {invitations.map((inv) => (
               <TableRow key={inv.id}>
                 <TableCell>{inv.email}</TableCell>
                 <TableCell>{formatDistanceToNow(new Date(inv.created_at), { addSuffix: true })}</TableCell>
                 <TableCell>{formatDistanceToNow(new Date(inv.expires_at), { addSuffix: true })}</TableCell>
               </TableRow>
             ))}
           </TableBody>
         </Table>
       </CardContent>
     </Card>
   )}
   ```
  </action>
  <verify>
    ```bash
    npm run dev
    ```
    Settings Team tab shows invite form and pending invitations.
  </verify>
  <done>
    Team invitation UI complete with pending invitations display.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Team invitation system with SMTP email and magic links</what-built>
  <how-to-verify>
1. Navigate to Settings > Team tab
2. Enter a test email address
3. Click Invite button
4. Check that email is received (may need to configure SMTP env vars first)
5. Click the magic link in the email
6. Verify user is added to workspace members
7. Check pending invitations list updates

Note: SMTP environment variables must be set:
- SMTP_HOST=smtp.hostinger.com
- SMTP_PORT=587
- SMTP_USER=no-reply@my21staff.com (or your Hostinger email)
- SMTP_PASS=(your email password)
- SMTP_FROM=no-reply@my21staff.com
  </how-to-verify>
  <resume-signal>Type "verified" if invitations work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Migration creates workspace_invitations table
3. Invite API creates user and sends email
4. Magic link adds user to workspace
5. Pending invitations visible in UI
6. Expired invitations are rejected
</verification>

<success_criteria>
- [ ] Nodemailer installed
- [ ] workspace_invitations table created
- [ ] POST /api/invitations creates invitation and sends email
- [ ] GET /api/invitations/accept processes magic link
- [ ] UI shows invite form and pending invitations
- [ ] Email received with branded template
</success_criteria>

<output>
After completion, create `.planning/phases/22-settings-data-management/22-03-SUMMARY.md`
</output>
