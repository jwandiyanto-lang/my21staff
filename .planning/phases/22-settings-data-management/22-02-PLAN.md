---
phase: 22-settings-data-management
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/app/api/contacts/import/preview/route.ts
  - src/app/api/contacts/import/route.ts
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  - src/lib/validations/csv.ts
  - src/lib/utils/phone.ts
autonomous: true

must_haves:
  truths:
    - "User can upload a CSV file and see preview of rows"
    - "Invalid rows are highlighted with specific error messages"
    - "User can confirm import after reviewing preview"
    - "Existing contacts are updated, new contacts are created"
    - "Phone numbers are normalized to E.164 format"
  artifacts:
    - path: "src/app/api/contacts/import/preview/route.ts"
      provides: "POST endpoint for CSV preview validation"
      exports: ["POST"]
    - path: "src/app/api/contacts/import/route.ts"
      provides: "POST endpoint for confirmed import"
      exports: ["POST"]
    - path: "src/lib/validations/csv.ts"
      provides: "Zod schema for CSV row validation"
      exports: ["contactRowSchema"]
    - path: "src/lib/utils/phone.ts"
      provides: "Phone normalization to E.164"
      exports: ["normalizePhone"]
  key_links:
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "/api/contacts/import/preview"
      via: "FormData POST on file select"
      pattern: "api/contacts/import/preview"
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "/api/contacts/import"
      via: "JSON POST on confirm"
      pattern: "api/contacts/import"
---

<objective>
Add CSV import functionality with preview validation and batch upsert.

Purpose: Allow users to bulk import contacts from spreadsheets with error detection before commit.
Output: Working import flow: upload -> preview with errors -> confirm -> batch upsert.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-settings-data-management/22-RESEARCH.md
@.planning/phases/22-settings-data-management/22-01-SUMMARY.md

@src/app/(dashboard)/[workspace]/settings/settings-client.tsx
@src/lib/supabase/server.ts
@src/lib/auth/workspace-auth.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Validation Schema and Phone Normalizer</name>
  <files>
    src/lib/validations/csv.ts
    src/lib/utils/phone.ts
  </files>
  <action>
1. Create phone normalizer at `src/lib/utils/phone.ts`:
   ```typescript
   /**
    * Normalize phone number to E.164 format
    * Handles: 081234567890, +6281234567890, 6281234567890, 0812-3456-7890
    * Returns: +6281234567890
    */
   export function normalizePhone(phone: string): string {
     // Remove all non-digits except leading +
     let cleaned = phone.replace(/[^\d+]/g, '')

     // Remove leading + for processing
     const hasPlus = cleaned.startsWith('+')
     if (hasPlus) cleaned = cleaned.slice(1)

     // Handle Indonesian numbers starting with 0
     if (cleaned.startsWith('0')) {
       cleaned = '62' + cleaned.slice(1)
     }

     // If no country code, assume Indonesia (+62)
     if (cleaned.length <= 12 && !cleaned.startsWith('62')) {
       cleaned = '62' + cleaned
     }

     return '+' + cleaned
   }

   /**
    * Validate phone is valid E.164 format
    * Length: 10-15 digits after +
    */
   export function isValidPhone(phone: string): boolean {
     const normalized = normalizePhone(phone)
     return /^\+\d{10,15}$/.test(normalized)
   }
   ```

2. Create CSV validation schema at `src/lib/validations/csv.ts`:
   ```typescript
   import { z } from 'zod'
   import { normalizePhone, isValidPhone } from '@/lib/utils/phone'

   export const contactRowSchema = z.object({
     name: z.string().max(255).optional().nullable(),
     phone: z.string().refine(
       (val) => isValidPhone(val),
       { message: 'Invalid phone number format' }
     ),
     email: z.string().email().optional().nullable().or(z.literal('')),
     tags: z.string().optional().nullable(), // Comma-separated
     lead_status: z.enum(['new', 'hot', 'warm', 'cold', 'converted', 'lost'])
       .optional()
       .nullable()
       .default('new'),
     lead_score: z.coerce.number().int().min(0).max(100).optional().nullable().default(0),
   })

   export type ContactRow = z.infer<typeof contactRowSchema>

   export interface ValidatedRow {
     row: number
     data: Record<string, unknown>
     valid: boolean
     errors: { path: string; message: string }[]
     normalized?: {
       phone: string
       tags: string[]
     }
   }
   ```
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build passes with no TypeScript errors.
  </verify>
  <done>
    Phone normalizer and CSV validation schema created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Import Preview and Confirm API Routes</name>
  <files>
    src/app/api/contacts/import/preview/route.ts
    src/app/api/contacts/import/route.ts
  </files>
  <action>
1. Create preview endpoint at `src/app/api/contacts/import/preview/route.ts`:
   - POST endpoint accepting FormData with `file` and `workspace` fields
   - Use `requireWorkspaceMembership` for auth
   - Parse CSV with PapaParse:
     ```typescript
     Papa.parse(text, {
       header: true,
       skipEmptyLines: true,
       transformHeader: (h) => h.trim().toLowerCase().replace(/\s+/g, '_'),
     })
     ```
   - Validate each row with `contactRowSchema.safeParse()`
   - Normalize phone numbers
   - Check for duplicates within the CSV
   - Return:
     ```json
     {
       "totalRows": 100,
       "validRows": 95,
       "invalidRows": 5,
       "duplicatesInFile": 2,
       "preview": [/* first 10 validated rows */],
       "allValidated": [/* all rows for import */]
     }
     ```

2. Create import endpoint at `src/app/api/contacts/import/route.ts`:
   - POST endpoint accepting JSON with `workspace` and `rows` (validated rows)
   - Use `requireWorkspaceMembership` for auth
   - Use `createApiAdminClient()` for database operations (bypasses RLS)
   - Batch upsert pattern from 22-RESEARCH.md:
     - Process in batches of 50
     - Check existing contacts by phone
     - Insert new, update existing
   - Return:
     ```json
     {
       "created": 45,
       "updated": 50,
       "errors": []
     }
     ```
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build passes.
  </verify>
  <done>
    /api/contacts/import/preview and /api/contacts/import routes created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Import UI to Settings Data Tab</name>
  <files>
    src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  </files>
  <action>
Update the Data tab in settings-client.tsx to add import functionality:

1. Add state for import flow:
   ```typescript
   const [importFile, setImportFile] = useState<File | null>(null)
   const [importPreview, setImportPreview] = useState<{
     totalRows: number
     validRows: number
     invalidRows: number
     duplicatesInFile: number
     preview: ValidatedRow[]
     allValidated: ValidatedRow[]
   } | null>(null)
   const [isUploading, setIsUploading] = useState(false)
   const [isImporting, setIsImporting] = useState(false)
   const [importResult, setImportResult] = useState<{
     created: number
     updated: number
   } | null>(null)
   ```

2. Add file input handler:
   ```typescript
   const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
     const file = e.target.files?.[0]
     if (!file) return
     setImportFile(file)
     setIsUploading(true)

     const formData = new FormData()
     formData.append('file', file)
     formData.append('workspace', workspace.id)

     const res = await fetch('/api/contacts/import/preview', {
       method: 'POST',
       body: formData,
     })
     const data = await res.json()
     setImportPreview(data)
     setIsUploading(false)
   }
   ```

3. Add confirm import handler:
   ```typescript
   const handleConfirmImport = async () => {
     if (!importPreview) return
     setIsImporting(true)

     const validRows = importPreview.allValidated.filter(r => r.valid)
     const res = await fetch('/api/contacts/import', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         workspace: workspace.id,
         rows: validRows,
       }),
     })
     const result = await res.json()
     setImportResult(result)
     setIsImporting(false)
     // Reset after 3 seconds
     setTimeout(() => {
       setImportFile(null)
       setImportPreview(null)
       setImportResult(null)
     }, 3000)
   }
   ```

4. Add Card 3 to Data tab: "Import Contacts"
   - File input (hidden) triggered by button "Select CSV File"
   - When preview loaded:
     - Show summary: "X valid rows, Y invalid rows, Z duplicates"
     - Show preview table (first 5 rows) with error highlighting
     - Invalid rows: red background, show error message
     - "Cancel" button to clear
     - "Import X Contacts" button (disabled if 0 valid)
   - When importing: show progress spinner
   - When complete: show success message "Created X, Updated Y"

Style error rows with `bg-red-50 text-red-700` for invalid data.
  </action>
  <verify>
    ```bash
    npm run dev
    ```
    Navigate to settings, upload a test CSV, verify preview shows.
  </verify>
  <done>
    Import UI complete with file upload, preview table, error highlighting, and confirm button.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Upload valid CSV shows all rows as valid
3. Upload CSV with invalid phone shows error message
4. Upload CSV with duplicate phones shows duplicate warning
5. Confirm import creates/updates contacts in database
6. Phone numbers are normalized to E.164 format
</verification>

<success_criteria>
- [ ] Phone normalizer handles all common formats (0812, +6281, 6281)
- [ ] CSV validation schema catches invalid data
- [ ] Preview API parses and validates CSV
- [ ] Import API batch upserts contacts
- [ ] UI shows preview with errors highlighted
- [ ] Import button creates/updates contacts
</success_criteria>

<output>
After completion, create `.planning/phases/22-settings-data-management/22-02-SUMMARY.md`
</output>
