---
phase: 2.1-production-bug-remediation
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - src/components/inbox/conversation-filter-tabs.tsx
  - src/components/inbox/activities-sidebar.tsx
  - convex/conversations.ts
autonomous: true

must_haves:
  truths:
    - "User can filter conversations by status (Active, Qualified, Archived)"
    - "User can filter conversations by tags"
    - "User can filter conversations by assignment"
    - "Activities sidebar remains clickable after tab navigation"
    - "Filter tabs display correct conversation counts"
  artifacts:
    - path: "src/components/inbox/conversation-filter-tabs.tsx"
      provides: "Filter tabs with working status/tags/assignment filters"
      min_lines: 100
    - path: "src/components/inbox/activities-sidebar.tsx"
      provides: "Activities sidebar with persistent click handlers"
      min_lines: 50
    - path: "convex/conversations.ts"
      provides: "Filtered conversation queries"
      exports: ["listByStatus", "listByTags", "listByAssignment"]
  key_links:
    - from: "src/components/inbox/conversation-filter-tabs.tsx"
      to: "convex/conversations"
      via: "useQuery with filter parameters"
      pattern: "useQuery\\(api\\.conversations\\."
    - from: "src/components/inbox/activities-sidebar.tsx"
      to: "conversation selection handler"
      via: "onClick event handlers"
      pattern: "onClick.*setSelected"
---

<objective>
Fix Inbox filter tabs and activities sidebar to enable proper conversation filtering and navigation.

Purpose: Inbox filter tabs are completely non-functional (Issue #3) - only "All" tab works, status/tags/assignment filters do nothing. Additionally, activities sidebar freezes after tab navigation (Issue #4), requiring page reload. These issues degrade the core Inbox experience and make conversation management difficult.

Output: Working filter tabs with proper conversation filtering and persistent activities sidebar.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# Inbox components (v3.4 modernization)
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/
</context>

<tasks>

<task type="auto">
  <name>Fix Inbox filter tabs to properly filter conversations</name>
  <files>
    src/components/inbox/conversation-filter-tabs.tsx
    convex/conversations.ts
    src/app/(dashboard)/[workspace]/inbox/page.tsx
  </files>
  <action>
**Root cause investigation:**

Filter tabs don't work - only "All" tab shows conversations. This suggests:
1. **Filter state not connected to query** - tabs update state but query ignores it
2. **Missing Convex queries** - no filtered queries for status/tags/assignment
3. **Query parameters wrong** - filter values not passed to Convex correctly

**Fix steps:**

1. **Find filter tabs component**:
```bash
find src/components/inbox -name "*filter*" -o -name "*tab*"
grep -r "Active.*Qualified.*Archived" src/components/inbox/
```

2. **Check if filter state exists**:
   - Look for useState or URL params storing active filter
   - Verify state updates when clicking different tabs
   - Check if state is passed to conversation list component

3. **Add or fix filtered queries in convex/conversations.ts**:
```typescript
// List conversations by status
export const listByStatus = query({
  args: {
    workspace_id: v.id("workspaces"),
    status: v.string(),  // "active" | "qualified" | "archived"
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    const conversations = await ctx.db
      .query("conversations")
      .withIndex("by_workspace", (q) => q.eq("workspace_id", args.workspace_id))
      .filter((q) => q.eq(q.field("status"), args.status))
      .order("desc")
      .take(100);

    return conversations;
  },
});

// List conversations by tags
export const listByTags = query({
  args: {
    workspace_id: v.id("workspaces"),
    tags: v.array(v.string()),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Get conversations where ANY tag matches
    const conversations = await ctx.db
      .query("conversations")
      .withIndex("by_workspace", (q) => q.eq("workspace_id", args.workspace_id))
      .filter((q) =>
        args.tags.some(tag => q.field("tags").includes(tag))
      )
      .order("desc")
      .take(100);

    return conversations;
  },
});

// List conversations by assignment
export const listByAssignment = query({
  args: {
    workspace_id: v.id("workspaces"),
    assigned_to: v.optional(v.string()),  // User ID or null for unassigned
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    const conversations = await ctx.db
      .query("conversations")
      .withIndex("by_workspace", (q) => q.eq("workspace_id", args.workspace_id))
      .filter((q) => q.eq(q.field("assigned_to"), args.assigned_to || null))
      .order("desc")
      .take(100);

    return conversations;
  },
});
```

4. **Wire filter state to queries in Inbox page**:
```typescript
// In inbox/page.tsx or conversation-list component
const [activeFilter, setActiveFilter] = useState<{
  type: 'all' | 'status' | 'tags' | 'assignment',
  value: string | string[] | null
}>({ type: 'all', value: null });

// Use conditional queries based on filter type
const allConversations = useQuery(
  api.conversations.listByWorkspace,
  activeFilter.type === 'all' ? { workspace_id } : 'skip'
);

const statusFiltered = useQuery(
  api.conversations.listByStatus,
  activeFilter.type === 'status' ? { workspace_id, status: activeFilter.value } : 'skip'
);

const tagsFiltered = useQuery(
  api.conversations.listByTags,
  activeFilter.type === 'tags' ? { workspace_id, tags: activeFilter.value } : 'skip'
);

// Show appropriate result
const conversations = activeFilter.type === 'all' ? allConversations :
                     activeFilter.type === 'status' ? statusFiltered :
                     activeFilter.type === 'tags' ? tagsFiltered :
                     assignmentFiltered;
```

5. **Update filter tabs to set filter state on click**:
```typescript
<TabButton
  active={activeFilter.type === 'status' && activeFilter.value === 'active'}
  onClick={() => setActiveFilter({ type: 'status', value: 'active' })}
>
  Active
</TabButton>
```

**Testing approach:**
1. Click "Active" tab - should show only active conversations
2. Click "Qualified" tab - should show only qualified conversations
3. Click "Archived" tab - should show only archived conversations
4. Click tag filter - should show conversations with that tag
5. Verify counts match filtered results
  </action>
  <verify>
```bash
# Manual verification required (UI interaction)
echo "Test filter tabs:"
echo "1. Visit https://www.my21staff.com/eagle-overseas/inbox"
echo "2. Note total conversation count on 'All' tab"
echo "3. Click 'Active' tab - count should be different (only active conversations)"
echo "4. Click 'Qualified' tab - count should change again"
echo "5. Click 'Archived' tab - count should change again"
echo "6. Click tags filter - should show tagged conversations"
echo ""
echo "Expected: Each tab shows different conversation subsets"
echo "Bug pattern: All tabs show same conversations (filter ignored)"
```
  </verify>
  <done>
- Filter tabs update conversation list based on selected filter
- "Active" tab shows only active conversations
- "Qualified" tab shows only qualified conversations
- "Archived" tab shows only archived conversations
- Tags filter shows conversations with selected tags
- Assignment filter shows conversations assigned to selected user
- Filter counts are accurate
- Issue #3 from verification report resolved
  </done>
</task>

<task type="auto">
  <name>Fix activities sidebar freeze after tab navigation</name>
  <files>
    src/components/inbox/activities-sidebar.tsx
    src/components/inbox/inbox-layout.tsx
  </files>
  <action>
**Root cause investigation:**

Activities sidebar becomes unclickable after switching between filter tabs (Issue #4). This pattern suggests:
1. **Event handlers removed** - React component unmounts/remounts incorrectly
2. **State collision** - Tab switch overwrites click handlers
3. **Z-index issue** - Overlay covers sidebar after navigation
4. **React key mismatch** - Component identity changes, breaking handlers

**Fix steps:**

1. **Find activities sidebar component**:
```bash
find src/components/inbox -name "*activit*" -o -name "*sidebar*"
grep -r "onClick.*activity" src/components/inbox/
```

2. **Check component mounting behavior**:
   - Verify sidebar doesn't unmount when tabs change
   - Look for conditional rendering that removes/re-adds sidebar
   - Check if sidebar is inside tab content (wrong) vs outside (correct)

3. **Common fix patterns**:

**Pattern A: Sidebar inside tab content (wrong)**
```typescript
// BAD: Sidebar remounts on every tab change
{activeTab === 'all' && <ConversationList />}
{activeTab === 'all' && <ActivitiesSidebar />} // Remounts!
```

**Pattern B: Sidebar outside tab content (correct)**
```typescript
// GOOD: Sidebar persists across tab changes
<div className="inbox-layout">
  <div className="filters">
    <FilterTabs />
  </div>
  <div className="content">
    <ConversationList />
  </div>
  <div className="sidebar">
    <ActivitiesSidebar /> {/* Always mounted */}
  </div>
</div>
```

4. **Fix event handler preservation**:
   - Use stable onClick handlers (useCallback)
   - Don't recreate handlers on every render
   - Ensure handlers reference correct conversation state

```typescript
// In activities sidebar
const handleActivityClick = useCallback((activityId: string) => {
  // Navigate to conversation or show details
  onSelectActivity(activityId);
}, [onSelectActivity]);

// Use stable handler in render
<div onClick={() => handleActivityClick(activity.id)}>
  {activity.title}
</div>
```

5. **Check for CSS issues**:
   - Verify no overlay covers sidebar after tab switch
   - Check z-index values don't conflict
   - Ensure pointer-events not disabled

**Testing approach:**
1. Open Inbox with activities visible
2. Click activity - should work
3. Switch to different tab
4. Click activity again - should still work (not freeze)
5. Repeat for all tabs
  </action>
  <verify>
```bash
# Manual verification required
echo "Test activities sidebar persistence:"
echo "1. Visit https://www.my21staff.com/eagle-overseas/inbox"
echo "2. Click an activity in sidebar - should navigate/show details"
echo "3. Switch to 'Active' tab"
echo "4. Click same activity - should still work (not frozen)"
echo "5. Switch to 'Qualified' tab"
echo "6. Click activity - should still work"
echo "7. Switch back to 'All' tab"
echo "8. Click activity - should still work"
echo ""
echo "Expected: Activities always clickable, no page reload needed"
echo "Bug pattern: Activities freeze after tab switch, require reload"
```
  </verify>
  <done>
- Activities sidebar remains clickable after tab navigation
- No unmount/remount cycle when switching tabs
- Event handlers persist across filter changes
- No page reload required to restore functionality
- Issue #4 from verification report resolved
  </done>
</task>

</tasks>

<verification>
**Filter tabs verification:**
- Click each filter tab (All, Active, Qualified, Archived, Tags, Assignment)
- Verify conversation list updates correctly
- Check filter counts are accurate

**Activities sidebar verification:**
- Click activity → switch tab → click activity again
- Should work without page reload
- Event handlers should persist

**Success indicators:**
- All filter tabs functional
- Activities sidebar always clickable
- No freeze/reload issues
- Issues #3 and #4 resolved
</verification>

<success_criteria>
1. Filter tabs properly filter conversations by status/tags/assignment
2. "All" tab shows all conversations
3. "Active/Qualified/Archived" tabs show filtered subsets
4. Tags and assignment filters work correctly
5. Activities sidebar remains clickable after tab navigation
6. No unmount/remount cycle breaks event handlers
7. Verification confirms Issues #3 and #4 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-production-bug-remediation/2.1-03-SUMMARY.md`
</output>
