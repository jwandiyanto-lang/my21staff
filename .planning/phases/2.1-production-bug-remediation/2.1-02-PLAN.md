---
phase: 2.1-production-bug-remediation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/mutations.ts
  - src/components/database/contact-actions.tsx
  - src/components/database/status-toggle.tsx
autonomous: true

must_haves:
  truths:
    - "User can update a contact's information and changes persist"
    - "User can delete a contact and it's removed from database"
    - "Status toggle affects only the selected contact (not all contacts)"
    - "Database operations return success responses (not errors)"
  artifacts:
    - path: "convex/mutations.ts"
      provides: "Contact CRUD mutations"
      exports: ["updateContact", "deleteContact", "updateContactStatus"]
    - path: "src/components/database/contact-actions.tsx"
      provides: "Update and delete UI components"
      min_lines: 50
    - path: "src/components/database/status-toggle.tsx"
      provides: "Status toggle component with contact-specific logic"
      min_lines: 30
  key_links:
    - from: "src/components/database/contact-actions.tsx"
      to: "convex/mutations"
      via: "useMutation hook"
      pattern: "useMutation\\(api\\.mutations\\."
    - from: "src/components/database/status-toggle.tsx"
      to: "convex/mutations.updateContactStatus"
      via: "mutation call with specific contact ID"
      pattern: "contact_id.*args"
---

<objective>
Fix database mutation failures preventing contact updates, deletions, and status changes.

Purpose: Database operations are completely broken in production. Users cannot update contact information (Issue #8), cannot delete contacts (Issue #9), and status toggle incorrectly affects ALL contacts instead of just the selected one (Issue #10 - critical data integrity bug). These mutations likely fail due to Convex schema mismatches or missing mutation implementations.

Output: Working database operations with proper contact-specific mutations.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# Existing contact mutations
@/home/jfransisco/Desktop/21/my21staff/convex/contacts.ts
@/home/jfransisco/Desktop/21/my21staff/src/app/api/contacts/route.ts
</context>

<tasks>

<task type="auto">
  <name>Fix contact update and delete mutations</name>
  <files>
    convex/mutations.ts
    src/app/api/contacts/route.ts
  </files>
  <action>
**Root cause investigation:**

Database operations fail with these patterns:
1. **Update contact fails** (Issue #8) - mutation not implemented or schema mismatch
2. **Delete contact fails** (Issue #9) - mutation exists in route.ts but may have auth issues
3. **Operations may be missing from convex/mutations.ts**

**Fix steps:**

1. **Check if mutations.ts exists and has required exports**:
```bash
ls convex/mutations.ts
grep -E "(updateContact|deleteContact)" convex/mutations.ts
```

2. **If mutations missing, create them in convex/mutations.ts**:
```typescript
// Update contact mutation
export const updateContact = mutation({
  args: {
    contact_id: v.id("contacts"),
    workspace_id: v.id("workspaces"),
    name: v.optional(v.string()),
    email: v.optional(v.string()),
    phone: v.optional(v.string()),
    lead_status: v.optional(v.string()),
    tags: v.optional(v.array(v.string())),
    // Add other fields as needed
  },
  handler: async (ctx, args) => {
    // Verify workspace membership
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Get contact to verify workspace ownership
    const contact = await ctx.db.get(args.contact_id);
    if (!contact || contact.workspace_id !== args.workspace_id) {
      throw new Error("Contact not found or access denied");
    }

    // Update contact
    const { contact_id, workspace_id, ...updates } = args;
    await ctx.db.patch(args.contact_id, {
      ...updates,
      updated_at: Date.now(),
    });

    return await ctx.db.get(args.contact_id);
  },
});

// Delete contact mutation
export const deleteContact = mutation({
  args: {
    contact_id: v.id("contacts"),
    workspace_id: v.id("workspaces"),
  },
  handler: async (ctx, args) => {
    // Verify workspace membership
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Get contact to verify workspace ownership
    const contact = await ctx.db.get(args.contact_id);
    if (!contact || contact.workspace_id !== args.workspace_id) {
      throw new Error("Contact not found or access denied");
    }

    // Delete associated data first (conversations, notes)
    const conversations = await ctx.db
      .query("conversations")
      .withIndex("by_contact", (q) => q.eq("contact_id", args.contact_id))
      .collect();

    for (const conv of conversations) {
      await ctx.db.delete(conv._id);
    }

    const notes = await ctx.db
      .query("contactNotes")
      .withIndex("by_contact", (q) => q.eq("contact_id", args.contact_id))
      .collect();

    for (const note of notes) {
      await ctx.db.delete(note._id);
    }

    // Delete contact
    await ctx.db.delete(args.contact_id);

    return { success: true };
  },
});
```

3. **Fix API route to use correct workspace_id type**:
   - `/api/contacts` DELETE handler expects workspace ID as query param
   - Convert slug to Convex workspace._id before calling mutation
   - Currently passes slug (string) but mutation expects Id<"workspaces">

4. **Add proper error handling**:
   - Wrap mutation calls in try/catch
   - Return specific error messages (not generic 500)
   - Log errors for debugging

**Testing approach:**
1. Test update contact via API
2. Test delete contact via API
3. Verify mutations appear in Convex dashboard
  </action>
  <verify>
```bash
# Check mutations file exists and has exports
cat convex/mutations.ts | grep -E "(export.*updateContact|export.*deleteContact)"

# Test update contact API
curl -X PATCH https://www.my21staff.com/api/contacts/[contact-id] \
  -H "Content-Type: application/json" \
  -d '{"name":"Updated Name","lead_status":"qualified"}' \
  -v | grep -E "(200|success)"

# Test delete contact API
curl -X DELETE "https://www.my21staff.com/api/contacts?id=[contact-id]&workspace=eagle-overseas" \
  -v | grep -E "(200|success)"

# Both should return 200 success (not 500 errors)
```
  </verify>
  <done>
- convex/mutations.ts has updateContact and deleteContact exports
- Update contact API call succeeds and persists changes
- Delete contact API call succeeds and removes contact
- No 500 errors when performing database operations
- Issues #8 and #9 from verification report resolved
  </done>
</task>

<task type="auto">
  <name>Fix status toggle to affect only selected contact</name>
  <files>
    convex/mutations.ts
    src/components/database/status-toggle.tsx
    src/components/database/contact-table.tsx
  </files>
  <action>
**Root cause investigation:**

Status toggle changes ALL contacts instead of just the selected one (Issue #10 - critical data integrity bug). This suggests:
1. Mutation updates all contacts with same status (missing WHERE contact_id)
2. Frontend passes wrong contact ID (or no ID)
3. Optimistic update affects multiple rows

**Fix steps:**

1. **Find status toggle component**:
```bash
find src/components -name "*status*" -o -name "*toggle*" | grep -i contact
find src/components/database -name "*.tsx" | xargs grep -l "status.*toggle"
```

2. **Check mutation implementation**:
```typescript
// Should be contact-specific, not global
export const updateContactStatus = mutation({
  args: {
    contact_id: v.id("contacts"),  // MUST have this
    workspace_id: v.id("workspaces"),
    lead_status: v.string(),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Get SPECIFIC contact by ID (not all contacts)
    const contact = await ctx.db.get(args.contact_id);
    if (!contact || contact.workspace_id !== args.workspace_id) {
      throw new Error("Contact not found");
    }

    // Update ONLY this contact
    await ctx.db.patch(args.contact_id, {
      lead_status: args.lead_status,
      updated_at: Date.now(),
    });

    return await ctx.db.get(args.contact_id);
  },
});
```

3. **Fix frontend component**:
   - Ensure toggle passes specific contact._id to mutation
   - NOT: Update all contacts with filter
   - YES: Update single contact by ID

```typescript
// Bad pattern (updates all):
await updateStatus({
  workspace_id,
  lead_status: newStatus
}); // Missing contact_id!

// Good pattern (updates one):
await updateStatus({
  contact_id: contact._id,
  workspace_id,
  lead_status: newStatus
});
```

4. **Verify optimistic updates are scoped correctly**:
   - If using optimistic updates, ensure they only affect single row
   - Check if table rerenders all rows (shouldn't happen)

**Testing critical scenarios:**
1. Have 2+ contacts with different statuses visible
2. Toggle status on contact A
3. Verify contact B status unchanged
4. Refresh page and confirm only contact A changed
  </action>
  <verify>
```bash
# Manual verification critical (data integrity bug)
echo "CRITICAL TEST: Status toggle must affect only ONE contact"
echo ""
echo "Test steps:"
echo "1. Open Database page with multiple contacts visible"
echo "2. Note initial statuses (e.g., Contact A=active, Contact B=archived)"
echo "3. Toggle Contact A status to 'qualified'"
echo "4. Verify Contact B status remains 'archived' (NOT changed to 'qualified')"
echo "5. Refresh page"
echo "6. Verify Contact A=qualified, Contact B=archived (persisted correctly)"
echo ""
echo "Expected: Only Contact A changes status"
echo "Bug pattern: All contacts change to 'qualified' (BROKEN)"
```
  </verify>
  <done>
- Status toggle mutation accepts contact_id parameter (not optional)
- Status toggle frontend passes specific contact._id to mutation
- Toggling one contact's status does NOT affect other contacts
- Status changes persist correctly after page refresh
- Issue #10 from verification report resolved (critical data integrity bug fixed)
  </done>
</task>

</tasks>

<verification>
**Database operation tests:**
```bash
# Test update contact
# Test delete contact
# Test status toggle (single contact only)
```

**UI verification (critical for Issue #10):**
- Database page with multiple contacts visible
- Toggle status on one contact
- Verify other contacts unchanged
- Refresh and confirm persistence

**Success indicators:**
- Update contact works and persists changes
- Delete contact removes from database
- Status toggle affects only selected contact (not all)
- No data integrity issues
- Issues #8, #9, #10 resolved
</verification>

<success_criteria>
1. Contact update mutation works and persists changes to database
2. Contact delete mutation removes contact and associated data
3. Status toggle affects ONLY the selected contact (not all contacts)
4. All database operations return success responses (not 500 errors)
5. Data integrity maintained (no unintended bulk updates)
6. Verification confirms Issues #8, #9, #10 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-production-bug-remediation/2.1-02-SUMMARY.md`
</output>
