---
phase: 2.1-production-bug-remediation
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/app/api/workspaces/[id]/quick-replies/route.ts
  - convex/quickReplies.ts
  - src/components/settings/quick-replies-tab.tsx
  - src/components/inbox/message-composer.tsx
autonomous: true

must_haves:
  truths:
    - "User can save quick replies in Settings"
    - "Saved quick replies persist in database"
    - "Quick replies appear in Inbox message composer"
    - "User can insert quick reply into message"
    - "Quick replies sync across page refreshes"
  artifacts:
    - path: "src/app/api/workspaces/[id]/quick-replies/route.ts"
      provides: "Quick replies CRUD API endpoints"
      exports: ["GET", "POST", "PUT", "DELETE"]
      min_lines: 150
    - path: "convex/quickReplies.ts"
      provides: "Quick replies database operations"
      exports: ["listByWorkspace", "create", "update", "delete"]
      min_lines: 100
    - path: "src/components/settings/quick-replies-tab.tsx"
      provides: "Quick replies management UI in Settings"
      min_lines: 100
    - path: "src/components/inbox/message-composer.tsx"
      provides: "Message composer with quick replies dropdown"
      min_lines: 80
  key_links:
    - from: "src/components/settings/quick-replies-tab.tsx"
      to: "/api/workspaces/[id]/quick-replies"
      via: "fetch calls for CRUD operations"
      pattern: "fetch.*quick-replies"
    - from: "src/components/inbox/message-composer.tsx"
      to: "convex/quickReplies"
      via: "useQuery to load quick replies"
      pattern: "useQuery\\(api\\.quickReplies"
    - from: "src/app/api/workspaces/[id]/quick-replies/route.ts"
      to: "convex/quickReplies"
      via: "fetchMutation and fetchQuery calls"
      pattern: "fetch(Mutation|Query)\\(api\\.quickReplies"
---

<objective>
Implement complete quick replies feature end-to-end (Settings save + Inbox display).

Purpose: Quick replies feature is completely non-functional. Users cannot save quick replies in Settings (Issue #11), and even if saved, quick replies don't appear in Inbox compose area (Issue #12). This is likely a missing feature - API endpoints may not exist and database schema may be missing. Quick replies are essential for efficiency in responding to common questions.

Output: Working quick replies feature with Settings management and Inbox integration.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create quick replies API and database schema</name>
  <files>
    src/app/api/workspaces/[id]/quick-replies/route.ts
    convex/quickReplies.ts
    convex/schema.ts
  </files>
  <action>
**Feature implementation:**

Quick replies is a complete feature missing backend implementation. Need to create:
1. Database schema for quick replies
2. Convex queries and mutations
3. API routes for Settings CRUD operations

**Implementation steps:**

1. **Add quick replies table to Convex schema** (convex/schema.ts):
```typescript
quickReplies: defineTable({
  workspace_id: v.id("workspaces"),
  label: v.string(),          // Display name (e.g., "Greeting")
  shortcut: v.string(),        // Keyboard shortcut (e.g., "/hi")
  content: v.string(),         // Reply message text
  created_at: v.number(),
  updated_at: v.number(),
})
.index("by_workspace", ["workspace_id"])
.index("by_workspace_shortcut", ["workspace_id", "shortcut"]),
```

2. **Create Convex queries and mutations** (convex/quickReplies.ts):
```typescript
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";
import { requireWorkspaceMembership } from "./lib/auth";

// List quick replies for workspace
export const listByWorkspace = query({
  args: {
    workspace_id: v.id("workspaces"),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    const replies = await ctx.db
      .query("quickReplies")
      .withIndex("by_workspace", (q) => q.eq("workspace_id", args.workspace_id))
      .collect();

    return replies;
  },
});

// Create quick reply
export const create = mutation({
  args: {
    workspace_id: v.id("workspaces"),
    label: v.string(),
    shortcut: v.string(),
    content: v.string(),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Check for duplicate shortcut
    const existing = await ctx.db
      .query("quickReplies")
      .withIndex("by_workspace_shortcut", (q) =>
        q.eq("workspace_id", args.workspace_id).eq("shortcut", args.shortcut)
      )
      .first();

    if (existing) {
      throw new Error(`Shortcut "${args.shortcut}" already exists`);
    }

    const now = Date.now();
    const id = await ctx.db.insert("quickReplies", {
      workspace_id: args.workspace_id,
      label: args.label,
      shortcut: args.shortcut,
      content: args.content,
      created_at: now,
      updated_at: now,
    });

    return await ctx.db.get(id);
  },
});

// Update quick reply
export const update = mutation({
  args: {
    id: v.id("quickReplies"),
    workspace_id: v.id("workspaces"),
    label: v.optional(v.string()),
    shortcut: v.optional(v.string()),
    content: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    const reply = await ctx.db.get(args.id);
    if (!reply || reply.workspace_id !== args.workspace_id) {
      throw new Error("Quick reply not found");
    }

    // Check shortcut uniqueness if updating
    if (args.shortcut && args.shortcut !== reply.shortcut) {
      const existing = await ctx.db
        .query("quickReplies")
        .withIndex("by_workspace_shortcut", (q) =>
          q.eq("workspace_id", args.workspace_id).eq("shortcut", args.shortcut)
        )
        .first();

      if (existing && existing._id !== args.id) {
        throw new Error(`Shortcut "${args.shortcut}" already exists`);
      }
    }

    await ctx.db.patch(args.id, {
      label: args.label,
      shortcut: args.shortcut,
      content: args.content,
      updated_at: Date.now(),
    });

    return await ctx.db.get(args.id);
  },
});

// Delete quick reply
export const deleteReply = mutation({
  args: {
    id: v.id("quickReplies"),
    workspace_id: v.id("workspaces"),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    const reply = await ctx.db.get(args.id);
    if (!reply || reply.workspace_id !== args.workspace_id) {
      throw new Error("Quick reply not found");
    }

    await ctx.db.delete(args.id);
    return { success: true };
  },
});
```

3. **Create API route** (src/app/api/workspaces/[id]/quick-replies/route.ts):
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { fetchQuery, fetchMutation } from 'convex/nextjs';
import { api } from 'convex/_generated/api';
import { requireWorkspaceMembership } from '@/lib/auth/workspace-auth';

interface RouteParams {
  params: Promise<{ id: string }>;
}

// GET /api/workspaces/[id]/quick-replies
export async function GET(request: NextRequest, { params }: RouteParams) {
  try {
    const { id: workspaceId } = await params;

    // Dev mode check
    if (process.env.NEXT_PUBLIC_DEV_MODE === 'true' && workspaceId === 'demo') {
      return NextResponse.json({
        replies: [
          { id: '1', label: 'Greeting', shortcut: '/hi', content: 'Hello! How can I help you?' },
          { id: '2', label: 'Pricing', shortcut: '/price', content: 'Our pricing starts at...' },
        ],
      });
    }

    const authResult = await requireWorkspaceMembership(workspaceId);
    if (authResult instanceof NextResponse) return authResult;

    const workspace = await fetchQuery(api.workspaces.getBySlug, { slug: workspaceId });
    if (!workspace) {
      return NextResponse.json({ error: 'Workspace not found' }, { status: 404 });
    }

    const replies = await fetchQuery(api.quickReplies.listByWorkspace, {
      workspace_id: workspace._id,
    });

    return NextResponse.json({ replies });
  } catch (error) {
    console.error('Error in quick-replies GET:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// POST /api/workspaces/[id]/quick-replies
export async function POST(request: NextRequest, { params }: RouteParams) {
  try {
    const { id: workspaceId } = await params;

    // Dev mode check
    if (process.env.NEXT_PUBLIC_DEV_MODE === 'true' && workspaceId === 'demo') {
      const body = await request.json();
      return NextResponse.json({
        reply: { id: Date.now().toString(), ...body },
      });
    }

    const authResult = await requireWorkspaceMembership(workspaceId);
    if (authResult instanceof NextResponse) return authResult;

    const workspace = await fetchQuery(api.workspaces.getBySlug, { slug: workspaceId });
    if (!workspace) {
      return NextResponse.json({ error: 'Workspace not found' }, { status: 404 });
    }

    const body = await request.json();

    const reply = await fetchMutation(api.quickReplies.create, {
      workspace_id: workspace._id,
      label: body.label,
      shortcut: body.shortcut,
      content: body.content,
    });

    return NextResponse.json({ reply });
  } catch (error) {
    console.error('Error in quick-replies POST:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// PUT and DELETE similar pattern...
```

4. **Run Convex schema migration**:
```bash
npx convex dev  # Schema will auto-migrate
```

**Testing approach:**
1. Create quick reply via API
2. List quick replies via API
3. Verify data persists in Convex dashboard
  </action>
  <verify>
```bash
# Test quick replies API
curl -X GET https://www.my21staff.com/api/workspaces/eagle-overseas/quick-replies \
  -v | grep -E "(200|replies)"

curl -X POST https://www.my21staff.com/api/workspaces/eagle-overseas/quick-replies \
  -H "Content-Type: application/json" \
  -d '{"label":"Test","shortcut":"/test","content":"Test message"}' \
  -v | grep -E "(200|reply)"

# Should return 200 with data (not 500)
```
  </verify>
  <done>
- convex/schema.ts has quickReplies table definition
- convex/quickReplies.ts has CRUD queries and mutations
- API routes exist for GET/POST/PUT/DELETE quick replies
- Convex schema migrated successfully
- API endpoints return 200 with data
  </done>
</task>

<task type="auto">
  <name>Integrate quick replies into Settings and Inbox UI</name>
  <files>
    src/components/settings/quick-replies-tab.tsx
    src/components/inbox/message-composer.tsx
  </files>
  <action>
**UI integration:**

Now that backend is ready, wire up frontend components.

**Implementation steps:**

1. **Find or create quick replies Settings tab**:
```bash
find src/components/settings -name "*quick*"
find src/app -path "*/settings/*" -name "page.tsx"
```

2. **Implement Settings UI** (src/components/settings/quick-replies-tab.tsx):
```typescript
import { useState } from 'react';
import { useWorkspace } from '@/hooks/use-workspace';

export function QuickRepliesTab() {
  const { workspace } = useWorkspace();
  const [replies, setReplies] = useState([]);
  const [loading, setLoading] = useState(false);

  // Load quick replies on mount
  useEffect(() => {
    async function loadReplies() {
      const res = await fetch(`/api/workspaces/${workspace.slug}/quick-replies`);
      const data = await res.json();
      setReplies(data.replies || []);
    }
    loadReplies();
  }, [workspace]);

  // Save new quick reply
  async function handleCreate(label: string, shortcut: string, content: string) {
    setLoading(true);
    const res = await fetch(`/api/workspaces/${workspace.slug}/quick-replies`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ label, shortcut, content }),
    });

    if (res.ok) {
      const data = await res.json();
      setReplies([...replies, data.reply]);
    } else {
      // Show error
      const error = await res.json();
      alert(error.error);
    }
    setLoading(false);
  }

  // Render form and list...
  return (
    <div>
      <h2>Quick Replies</h2>
      {/* Form to add new quick reply */}
      {/* List of existing quick replies with edit/delete */}
    </div>
  );
}
```

3. **Integrate into Inbox message composer** (src/components/inbox/message-composer.tsx):
```typescript
import { useQuery } from 'convex/react';
import { api } from 'convex/_generated/api';

export function MessageComposer({ workspaceId, onSend }) {
  const [message, setMessage] = useState('');
  const [showQuickReplies, setShowQuickReplies] = useState(false);

  // Load quick replies from Convex
  const quickReplies = useQuery(api.quickReplies.listByWorkspace, {
    workspace_id: workspaceId,
  });

  // Detect "/" trigger for quick replies dropdown
  useEffect(() => {
    if (message.startsWith('/')) {
      setShowQuickReplies(true);
    } else {
      setShowQuickReplies(false);
    }
  }, [message]);

  // Insert quick reply into message
  function handleQuickReplyClick(reply) {
    setMessage(reply.content);
    setShowQuickReplies(false);
  }

  return (
    <div>
      <textarea
        value={message}
        onChange={(e) => setMessage(e.target.value)}
        placeholder="Type / for quick replies"
      />

      {/* Quick replies dropdown */}
      {showQuickReplies && quickReplies && (
        <div className="quick-replies-dropdown">
          {quickReplies
            .filter(r => r.shortcut.startsWith(message))
            .map(reply => (
              <div key={reply._id} onClick={() => handleQuickReplyClick(reply)}>
                <strong>{reply.shortcut}</strong> - {reply.label}
              </div>
            ))}
        </div>
      )}

      <button onClick={() => onSend(message)}>Send</button>
    </div>
  );
}
```

4. **Test end-to-end flow**:
   - Create quick reply in Settings
   - Go to Inbox
   - Type "/" in message composer
   - See quick reply in dropdown
   - Click to insert
   - Verify message populated

**Testing approach:**
1. Settings: Create quick reply "/hi" with content "Hello!"
2. Inbox: Type "/" and see "/hi" in dropdown
3. Click "/hi" and message becomes "Hello!"
4. Send message successfully
  </action>
  <verify>
```bash
# Manual verification required
echo "Test quick replies end-to-end:"
echo ""
echo "Part 1 - Settings:"
echo "1. Visit https://www.my21staff.com/eagle-overseas/settings"
echo "2. Go to Quick Replies tab"
echo "3. Create new quick reply: Label='Greeting', Shortcut='/hi', Content='Hello! How can I help?'"
echo "4. Click Save - should succeed without errors"
echo "5. Refresh page - quick reply should persist"
echo ""
echo "Part 2 - Inbox:"
echo "6. Visit https://www.my21staff.com/eagle-overseas/inbox"
echo "7. Open a conversation"
echo "8. Type '/' in message composer"
echo "9. Quick replies dropdown should appear showing '/hi - Greeting'"
echo "10. Click '/hi' - message should populate with 'Hello! How can I help?'"
echo "11. Send message - should work normally"
echo ""
echo "Expected: Complete flow works without errors"
echo "Bug pattern: Settings save fails OR Inbox doesn't show quick replies"
```
  </verify>
  <done>
- Settings Quick Replies tab allows creating/editing/deleting quick replies
- Quick replies persist in database after save
- Inbox message composer shows quick replies dropdown when typing "/"
- Clicking quick reply inserts content into message
- Quick replies sync across page refreshes
- Issue #11 from verification report resolved (Settings save works)
- Issue #12 from verification report resolved (Inbox displays quick replies)
  </done>
</task>

</tasks>

<verification>
**Backend verification:**
```bash
# Test API endpoints work
curl -X GET /api/workspaces/[id]/quick-replies
curl -X POST /api/workspaces/[id]/quick-replies -d '{"label":"Test","shortcut":"/test","content":"Test"}'
```

**Frontend verification:**
- Settings: Create, edit, delete quick replies
- Inbox: Type "/" and see quick replies dropdown
- Insert quick reply and send message
- Refresh and verify persistence

**Success indicators:**
- Quick replies save successfully in Settings
- Quick replies appear in Inbox composer
- Complete end-to-end flow works
- Issues #11 and #12 resolved
</verification>

<success_criteria>
1. Quick replies can be created/edited/deleted in Settings
2. Quick replies persist in database and sync across sessions
3. Quick replies appear in Inbox message composer dropdown
4. Typing "/" triggers quick replies dropdown
5. Clicking quick reply inserts content into message
6. Complete feature works end-to-end without errors
7. Verification confirms Issues #11 and #12 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-production-bug-remediation/2.1-04-SUMMARY.md`
</output>
