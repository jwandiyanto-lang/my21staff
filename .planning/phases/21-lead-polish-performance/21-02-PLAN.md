---
wave: 1
depends_on: []
files_modified: [src/app/(dashboard)/[workspace]/database/page.tsx, src/app/(dashboard)/[workspace]/database/database-client.tsx]
autonomous: true
---

# 21-02: Contacts Pagination

## Objective

Add pagination to contacts query to prevent loading entire database (performance risk for 1000+ contacts).

## Tasks

<task id="1">
Update `src/app/(dashboard)/[workspace]/database/page.tsx` to add pagination:

In the contacts query (around line 49-53), change from:
```typescript
.select('*')
.eq('workspace_id', workspace.id)
.order('created_at', { ascending: false })
```

To:
```typescript
.select('*', { count: 'exact' })
.eq('workspace_id', workspace.id)
.order('created_at', { ascending: false })
.range(0, 49) // First 50 contacts
```

Pass the count to DatabaseClient:
```typescript
const { data: contacts, count: totalCount } = await supabase.from('contacts')...

<DatabaseClient
  workspace={workspace}
  contacts={contacts}
  totalCount={totalCount ?? 0}
  contactTags={...}
  teamMembers={...}
/>
```
</task>

<task id="2">
Update `src/app/(dashboard)/[workspace]/database/database-client.tsx` to handle pagination:

Add props:
```typescript
interface DatabaseClientProps {
  workspace: Pick<Workspace, 'id' | 'name' | 'slug'>
  contacts: Contact[]
  totalCount: number  // Add this
  contactTags?: string[]
  teamMembers?: TeamMember[]
}
```

Add state for pagination:
```typescript
const [page, setPage] = useState(0)
const PAGE_SIZE = 50
```

Add load more functionality:
```typescript
const loadMoreContacts = async () => {
  const nextPage = page + 1
  const response = await fetch(`/api/contacts?workspace=${workspace.id}&page=${nextPage}&limit=${PAGE_SIZE}`)
  if (response.ok) {
    const data = await response.json()
    setContacts(prev => [...prev, ...data.contacts])
    setPage(nextPage)
  }
}
```

Update header to show pagination info:
```typescript
<p className="text-muted-foreground">
  Showing {contacts.length} of {totalCount} contact{totalCount !== 1 ? 's' : ''}
</p>
```

Add "Load More" button at bottom if more contacts exist:
```typescript
{contacts.length < totalCount && (
  <div className="flex justify-center mt-4">
    <Button variant="outline" onClick={loadMoreContacts}>
      Load More ({totalCount - contacts.length} remaining)
    </Button>
  </div>
)}
```
</task>

<task id="3">
Create API endpoint `src/app/api/contacts/route.ts` for paginated fetch if it doesn't exist:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { requireWorkspaceMembership } from '@/lib/auth'

export async function GET(request: NextRequest) {
  const supabase = await createClient()
  const { searchParams } = new URL(request.url)

  const workspaceId = searchParams.get('workspace')
  const page = parseInt(searchParams.get('page') || '0')
  const limit = parseInt(searchParams.get('limit') || '50')

  if (!workspaceId) {
    return NextResponse.json({ error: 'Workspace required' }, { status: 400 })
  }

  // Verify membership
  await requireWorkspaceMembership(supabase, workspaceId)

  const from = page * limit
  const to = from + limit - 1

  const { data: contacts, error } = await supabase
    .from('contacts')
    .select('*')
    .eq('workspace_id', workspaceId)
    .order('created_at', { ascending: false })
    .range(from, to)

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  return NextResponse.json({ contacts })
}
```
</task>

## Verification

- [ ] Initial page load only fetches 50 contacts
- [ ] Total count shown in header ("Showing 50 of 234 contacts")
- [ ] "Load More" button appears when more contacts exist
- [ ] Clicking "Load More" fetches next page and appends to list
- [ ] All filters still work with paginated data

## must_haves

- Pagination on initial contacts query (limit 50)
- Total count displayed
- Load more functionality
