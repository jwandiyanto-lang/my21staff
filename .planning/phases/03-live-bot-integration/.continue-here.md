---
phase: 03-live-bot-integration
task: inbox_ui_improvements
status: in_progress
last_updated: 2026-01-29T16:45:00+04:00
---

## Current State

Working on inbox UI improvements and message sending functionality. Currently debugging 500 errors when sending messages through the inbox. Messages are appearing on the wrong side (left/white instead of right/green), suggesting they're being saved as "inbound" instead of "outbound".

**Active work**: Message sending flow investigation
**Location**: `/api/messages/send` route and webhook message handling
**Branch**: master (all changes committed and pushed)

## Completed Work

### UI Improvements (✅ Complete)
- ✅ Removed Active/All conversation filter (show all conversations by default)
- ✅ Status and Tags filters side by side (equal width, flex-1)
- ✅ Status filter pulls from workspace settings (custom statuses supported)
- ✅ AI mode disables typing (users must click "Human" to enable compose input)
- ✅ Text box clears when switching conversations (useEffect on conversationId)

### API Key Configuration (✅ Complete)
- ✅ Updated workspace with correct Kapso API key: `92cd6a46d316...`
- ✅ API key test confirmed valid (422 response = valid auth, just 24-hour window issue)
- ✅ Workspace credentials stored in Convex: workspace_id `js7b1cwpdpadcgds1cr8dqw7dh7zv3a3`

### Message Flow Architecture (⚠️ In Progress)
- ✅ Reverted to correct flow: Kapso → Convex (not Convex → Kapso)
- ✅ Added detailed step-by-step logging to `/api/messages/send`
- ⚠️ 500 errors occurring - unable to see server logs yet
- ⚠️ Messages appearing on left side (inbound) instead of right (outbound)

## Remaining Work

### Immediate Issues to Resolve
1. **500 Error Investigation** (BLOCKING)
   - Server logs not appearing in Vercel logs/inspect
   - Error shows: `[Request ID: xxx] Server Error`
   - Added console.log at each step - need to check logs
   - Deployment with logging: `my21staff-qyy1-4p7lz6uan`

2. **Message Direction Bug** (CRITICAL)
   - User's sent messages appear on LEFT (white bubbles)
   - Should appear on RIGHT (green bubbles)
   - Suspect: Webhook processing own sent messages as "inbound"
   - File to check: `convex/kapso.ts` processWebhook function (line 437: direction: "inbound")

3. **Webhook Message Filtering**
   - Webhook may be receiving both inbound AND outbound messages
   - Need to filter out messages where `is_from_me` or similar flag is true
   - Kapso webhook payload structure needs investigation

### Next Steps After Debug
- Fix message direction logic (filter webhook messages or check sender)
- Test message sending within 24-hour window
- Verify real-time updates work correctly
- Complete Phase 3 bot integration remaining plans

## Decisions Made

1. **Filter Layout**: Status and Tags dropdowns side by side (not pills)
   - Reason: User requested dropdown format, more compact

2. **API Key Storage**: Store in `workspace.meta_access_token`, use `safeDecrypt()`
   - Reason: Handles both encrypted and plain text formats

3. **Message Flow**: Send to Kapso FIRST, then save to Convex
   - Reason: Need kapso_message_id for database linkage
   - Correct: Kapso → get message_id → Convex with ID

4. **AI Mode Behavior**: Disable compose input when AI is active
   - Reason: Prevents accidental human messages during AI conversation
   - User must explicitly click "Human" button to take over

5. **Conversation Filter**: Show ALL by default (removed Active/All toggle)
   - Reason: Simpler UX, less confusion

## Blockers

1. **Server Logs Not Visible** (MEDIUM)
   - `vercel logs` and `vercel inspect` not showing runtime errors
   - Added console.log statements but can't see output
   - Workaround: Asked user to check Network tab → Response for error details

2. **Message Appearing Wrong Side** (CRITICAL)
   - Root cause unknown - either:
     - A) Webhook processing own messages as inbound
     - B) Send API failing but webhook catching the message
     - C) Direction field set incorrectly in createOutboundMessage
   - Blocking proper testing of message flow

## Context

### What We're Debugging

The inbox message sending has THREE issues happening simultaneously:

1. **500 Error**: API route failing somewhere in the send flow
2. **Wrong Side**: Messages show left (white) instead of right (green)
3. **Error Toast**: Shows "Failed to send message" even though message appears

**The mystery**: Messages ARE appearing in the inbox (visible on left side), which means:
- Either the send succeeded and is being processed by webhook as inbound
- Or the send failed but the message came from somewhere else (user's phone?)

### Message Flow (Intended)

```
User types → Click Send
  ↓
/api/messages/send
  ↓
1. Auth check (Clerk)
2. Get conversation → contact → workspace
3. Decrypt API key
4. Send via Kapso API ← (422 if >24hr window, 200 if success)
5. Save to Convex with kapso_message_id
  ↓
Convex real-time update
  ↓
Message appears (RIGHT side, green)
```

### Webhook Flow (Potential Issue)

```
WhatsApp receives message
  ↓
Kapso webhook fires
  ↓
/webhook/kapso (convex/http.ts)
  ↓
processWebhook (convex/kapso.ts:90)
  ↓
Creates message with direction: "inbound" ← ALWAYS INBOUND?
  ↓
Message appears (LEFT side, white)
```

**Hypothesis**: Webhook might be receiving OUR OWN sent messages and saving them as "inbound". Need to check if Kapso sends a flag like `is_from_me` or `direction` in webhook payload.

### Files Modified (All Committed)

- `src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx` - Filter layout
- `src/components/inbox/filter-tabs.tsx` - Status from settings
- `src/components/inbox/message-thread.tsx` - Disable compose when AI active
- `src/components/inbox/compose-input.tsx` - Clear on conversation change
- `src/app/api/messages/send/route.ts` - Added detailed logging
- Scripts: test-kapso-api.js, test-send.js, update-contact-names.js (diagnostic scripts)

## Next Action

**Immediate** (when resuming):

1. Ask user to send a message and check Network tab → Response body for actual error
2. OR check if messages in screenshot were sent from user's phone (not inbox)
3. Read `convex/kapso.ts` processWebhook to understand message payload structure
4. Look for `is_from_me`, `direction`, or `sender` field in webhook payload
5. Add filter to skip processing outbound messages in webhook

**Specific command**:
```bash
# Check webhook message handling
grep -A 20 "direction.*inbound" convex/kapso.ts
```

**Question for user**: "Are you also sending these messages from your phone/WhatsApp, or only from the inbox?"

## Environment

- Deployment: https://www.my21staff.com
- Latest deploy: `my21staff-qyy1-4p7lz6uan` (with logging)
- Workspace: Eagle Overseas (`js7b1cwpdpadcgds1cr8dqw7dh7zv3a3`)
- Phone ID: `930016923526449`
- API Key: `92cd6a46d316...` (confirmed working)
