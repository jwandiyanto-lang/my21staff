---
phase: 03-live-bot-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/workspaces/[id]/ari-config/route.ts
  - src/lib/auth/workspace-auth.ts
  - convex/ari.ts
autonomous: true

must_haves:
  truths:
    - "ARI Config API returns 200 with valid configuration"
    - "Your Intern Persona tab loads without errors"
    - "Configuration saves persist to database"
    - "All 5 Your Intern tabs functional (Persona, Flow, Database, Scoring, Slots)"
  artifacts:
    - path: "src/app/api/workspaces/[id]/ari-config/route.ts"
      provides: "ARI Config API with proper workspace ID handling"
      min_lines: 50
    - path: "convex/ari.ts"
      provides: "getAriConfig query with workspace_id string parameter"
      contains: "workspace_id: v.string()"
  key_links:
    - from: "src/app/(dashboard)/[workspace]/your-intern/*"
      to: "/api/workspaces/[workspace]/ari-config"
      via: "fetch in useQuery"
      pattern: "fetch.*ari-config"
    - from: "src/app/api/workspaces/[id]/ari-config/route.ts"
      to: "convex/ari.ts getAriConfig"
      via: "ConvexHttpClient query"
      pattern: "convex.query.*getAriConfig"
---

<objective>
Fix ARI Config API to restore Your Intern functionality before live bot testing.

Purpose: Your Intern configuration must work to control bot behavior in production. Issues #1, #2, #7 from Phase 2.1 blocked all bot configuration - this is the root cause fix.

Output: Working ARI Config API that Your Intern pages can use to save and load bot configuration.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-live-bot-integration/PHASE-3-NOTES.md
@.planning/phases/02-production-deployment/02-03-SUMMARY.md
@.planning/phases/2.1-production-bug-remediation/2.1-01-PLAN.md

# Key context from Phase 2.1 investigation
The ARI Config API fails because:
1. Route param [id] is workspace slug (e.g., "eagle-overseas")
2. Auth function requireWorkspaceMembership() expects Convex workspace ID
3. Convex query getAriConfig() expects workspace_id as string (not v.id("workspaces"))

Previous fix attempt broke Settings page - need proper workspace resolution.
</context>

<tasks>

<task type="auto">
  <name>Fix ARI Config API workspace ID handling</name>
  <files>
    src/app/api/workspaces/[id]/ari-config/route.ts
    src/lib/auth/workspace-auth.ts
  </files>
  <action>
    Update the ARI Config API route to properly handle workspace slug vs ID:

    1. In route.ts GET handler:
       - Fetch workspace by slug using convex.query(api.workspaces.getBySlug, { slug: params.id })
       - Extract workspace._id for auth check
       - Pass workspace._id to requireWorkspaceMembership (as string)
       - Use workspace._id (string) for getAriConfig query

    2. In route.ts PATCH handler:
       - Same workspace resolution pattern
       - Pass workspace._id (string) to upsertAriConfig mutation

    3. Verify auth pattern matches Settings API:
       - Check src/app/api/workspaces/[id]/settings/route.ts for reference
       - Use same workspace resolution approach
       - Ensure consistent ID type handling (workspace._id is Id<"workspaces">, convert to string for Convex calls)

    Key: The route param is SLUG, auth needs ID, Convex expects string. Resolution: fetch workspace first, extract _id as string.
  </action>
  <verify>
    npm run build (no TypeScript errors)
    curl https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config (returns 200 with config)
  </verify>
  <done>
    ARI Config API returns 200 for GET requests with valid workspace slug
    TypeScript build succeeds without workspace ID type errors
  </done>
</task>

<task type="auto">
  <name>Verify Convex schema workspace_id type consistency</name>
  <files>
    convex/ari.ts
    convex/schema.ts
  </files>
  <action>
    Ensure Convex ARI queries use correct workspace_id parameter type:

    1. In convex/ari.ts getAriConfig:
       - Verify args uses: workspace_id: v.string()
       - NOT: workspace_id: v.id("workspaces")
       - This matches how workspace._id is passed as string from API routes

    2. In convex/schema.ts ariConfig table:
       - Verify workspace_id field is: v.id("workspaces")
       - Index by_workspace uses workspace_id correctly
       - This is correct - table stores ID type, but query accepts string (Convex auto-converts)

    3. Check other ARI mutations (upsertAriConfig, etc.):
       - All should accept workspace_id: v.string() in args
       - Database stores as v.id("workspaces")
       - Convex handles string-to-ID conversion internally

    No code changes expected - this is verification that Phase 2.1 fix was correct.
  </action>
  <verify>
    grep -A5 "getAriConfig = query" convex/ari.ts | grep "workspace_id: v.string()"
    npx convex dev (schema validates without errors)
  </verify>
  <done>
    All ARI queries accept workspace_id as v.string() parameter
    Schema correctly stores workspace_id as v.id("workspaces")
    No type conflicts between API routes and Convex functions
  </done>
</task>

<task type="auto">
  <name>Test Your Intern configuration end-to-end</name>
  <files>None (testing only)</files>
  <action>
    Verify all Your Intern functionality works in production:

    1. Manual test via browser (https://www.my21staff.com/eagle-overseas/your-intern):
       - Visit each tab: Persona, Flow, Database, Scoring, Slots
       - Verify each tab loads without console errors
       - Make a small config change (e.g., change bot name in Persona)
       - Save configuration
       - Reload page - verify change persists

    2. API test via curl:
       ```bash
       # GET config
       curl -H "Authorization: Bearer $(clerk token)" \
         https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config

       # PATCH config (update bot_name)
       curl -X PATCH \
         -H "Authorization: Bearer $(clerk token)" \
         -H "Content-Type: application/json" \
         -d '{"bot_name":"ARI-Test"}' \
         https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config

       # GET again to verify
       curl -H "Authorization: Bearer $(clerk token)" \
         https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config
       ```

    3. Check Convex dashboard:
       - Visit https://dashboard.convex.dev
       - Inspect ariConfig table
       - Verify workspace_id matches Eagle Overseas workspace
       - Confirm configuration changes appear in database

    Document any errors encountered - this validates Issues #1, #2, #7 are fully resolved.
  </action>
  <verify>
    All 5 Your Intern tabs accessible without errors
    Configuration changes persist across page reloads
    API returns 200 for GET and PATCH requests
  </verify>
  <done>
    Your Intern pages load successfully in production
    Configuration saves work end-to-end (UI -> API -> Convex)
    Issues #1, #2, #7 from Phase 2.1 are resolved
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
- npm run build succeeds
- TypeScript compiler has no workspace ID type errors
- ARI Config API returns 200 for valid workspace slug

**Manual verification:**
- Visit https://www.my21staff.com/eagle-overseas/your-intern
- All 5 tabs load without console errors
- Configuration changes save and persist
- curl tests return 200 with valid JSON

**Success indicators:**
- ARI Config API functional (root cause fixed)
- Your Intern fully operational
- Ready for bot activation
</verification>

<success_criteria>
1. ARI Config API returns 200 for workspace slug requests
2. All Your Intern tabs render without errors
3. Configuration saves persist to Convex database
4. No TypeScript build errors related to workspace ID types
5. Manual testing confirms Issues #1, #2, #7 resolved
</success_criteria>

<output>
After completion, create `.planning/phases/03-live-bot-integration/03-01-SUMMARY.md` with:
- ARI Config API fix details
- Test results from all 5 Your Intern tabs
- API test command outputs
- Confirmation Issues #1, #2, #7 resolved
</output>
