---
phase: 03-live-bot-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: []
autonomous: false

user_setup:
  - service: kapso
    why: "Update webhook URL to production endpoint"
    dashboard_config:
      - task: "Update webhook URL in Kapso dashboard"
        location: "Kapso Dashboard → Settings → Webhooks"
        details: "Change webhook URL from localhost/ngrok to https://www.my21staff.com/api/webhook/kapso"
      - task: "Note the webhook signing secret"
        location: "Kapso Dashboard → Settings → Webhooks → Signing Secret"
        details: "Verify it matches KAPSO_WEBHOOK_SECRET in Vercel env vars"

must_haves:
  truths:
    - "Kapso webhook URL points to production endpoint"
    - "GET challenge request returns plain text challenge"
    - "Valid webhook signatures accepted (200 response)"
    - "Invalid webhook signatures rejected (401 response)"
    - "Test webhook delivery succeeds"
  artifacts:
    - path: "src/app/api/webhook/kapso/route.ts"
      provides: "Webhook handler with GET challenge and POST signature verification"
      contains: "verifyKapsoSignature"
  key_links:
    - from: "Kapso platform"
      to: "https://www.my21staff.com/api/webhook/kapso"
      via: "POST with x-kapso-signature header"
      pattern: "signature verification"
---

<objective>
Configure Kapso webhook to production endpoint and verify signature verification works.

Purpose: Kapso must deliver WhatsApp messages to production, not localhost. Signature verification ensures only genuine Kapso webhooks are processed.

Output: Live webhook connection between Kapso and production, with working signature validation.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-live-bot-integration/03-01-SUMMARY.md
@src/app/api/webhook/kapso/route.ts
@src/lib/kapso/verify-signature.ts
@.env.production

# Kapso webhook endpoint already implemented
The webhook handler at /api/webhook/kapso supports:
- GET: Returns hub.challenge for webhook verification
- POST: Processes Meta webhook format with signature verification
- Uses KAPSO_WEBHOOK_SECRET env var for HMAC validation

Production environment has KAPSO_WEBHOOK_SECRET configured.
</context>

<tasks>

<task type="auto">
  <name>Test webhook GET challenge endpoint</name>
  <files>None (testing only)</files>
  <action>
    Verify the webhook verification endpoint works:

    1. Test GET with challenge parameter:
       ```bash
       curl "https://www.my21staff.com/api/webhook/kapso?hub.challenge=test123"
       ```
       Expected: Returns "test123" as plain text (status 200)

    2. Test GET without challenge:
       ```bash
       curl "https://www.my21staff.com/api/webhook/kapso"
       ```
       Expected: Returns JSON {"status":"Webhook endpoint ready"} (status 200)

    3. Test alternative challenge parameter name:
       ```bash
       curl "https://www.my21staff.com/api/webhook/kapso?challenge=test456"
       ```
       Expected: Returns "test456" as plain text (supports both formats)

    Document the responses - this confirms Kapso can verify the webhook endpoint.
  </action>
  <verify>
    curl "https://www.my21staff.com/api/webhook/kapso?hub.challenge=test123" returns "test123"
    curl "https://www.my21staff.com/api/webhook/kapso" returns JSON status message
  </verify>
  <done>
    GET endpoint returns challenge parameter correctly
    Webhook endpoint ready for Kapso verification
  </done>
</task>

<task type="auto">
  <name>Verify webhook signature validation logic</name>
  <files>
    src/app/api/webhook/kapso/route.ts
    src/lib/kapso/verify-signature.ts
  </files>
  <action>
    Review and document the signature verification implementation:

    1. Check verifyKapsoSignature function:
       - Reads from src/lib/kapso/verify-signature.ts
       - Uses HMAC-SHA256 with KAPSO_WEBHOOK_SECRET
       - Compares computed signature with x-kapso-signature header
       - Returns true/false (no exceptions thrown)

    2. Check webhook route POST handler:
       - Gets raw body text for signature verification
       - Reads signature from x-kapso-signature header
       - Calls verifyKapsoSignature(rawBody, signature, secret)
       - Returns 401 if signature invalid
       - Returns 200 and processes if valid (or if secret not set - graceful degradation)

    3. Check environment variable:
       ```bash
       # Verify KAPSO_WEBHOOK_SECRET is set in production
       vercel env ls --environment production | grep KAPSO_WEBHOOK_SECRET
       ```

    4. Log signature verification behavior:
       - Add console.log in verifyKapsoSignature showing:
         - Signature from header (first 10 chars)
         - Computed signature (first 10 chars)
         - Match result (true/false)
       - This helps debug signature mismatches

    No code changes expected unless signature verification has bugs. This is validation.
  </action>
  <verify>
    grep -A10 "verifyKapsoSignature" src/lib/kapso/verify-signature.ts shows HMAC-SHA256 logic
    grep "KAPSO_WEBHOOK_SECRET" src/app/api/webhook/kapso/route.ts confirms env var usage
  </verify>
  <done>
    Signature verification logic confirmed correct
    Environment variable KAPSO_WEBHOOK_SECRET present in production
    Logging added for debugging signature validation
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-to-do>Update Kapso webhook URL to production endpoint</what-to-do>
  <why>Claude cannot access Kapso dashboard - user must update webhook URL manually</why>
  <instructions>
    1. Log in to Kapso dashboard: https://kapso.com (or your Kapso provider dashboard)

    2. Navigate to: Settings → Webhooks (or equivalent webhook configuration page)

    3. Find webhook URL field - currently set to:
       - Localhost: http://localhost:3000/api/webhook/kapso
       - OR ngrok: https://xxxxx.ngrok.io/api/webhook/kapso

    4. Update webhook URL to production:
       ```
       https://www.my21staff.com/api/webhook/kapso
       ```

    5. Verify webhook signing secret matches environment variable:
       - Copy signing secret from Kapso dashboard
       - Compare with KAPSO_WEBHOOK_SECRET in Vercel env vars
       - If they don't match, update Vercel env var:
         ```bash
         vercel env add KAPSO_WEBHOOK_SECRET production
         # Paste the secret from Kapso dashboard
         ```

    6. Save webhook configuration in Kapso dashboard

    7. Trigger webhook verification (if Kapso has a "Test Webhook" button):
       - Kapso will send GET request with hub.challenge parameter
       - Should receive the challenge value back
       - Webhook status should show "Verified" or "Active"

    **What to verify:**
    - Webhook URL updated to production (not localhost/ngrok)
    - Signing secret matches between Kapso and Vercel
    - Webhook verification test passes (if available)

    **Common issues:**
    - If verification fails, check:
      - URL is exactly: https://www.my21staff.com/api/webhook/kapso
      - No trailing slash
      - HTTPS (not HTTP)
      - Domain spelling correct
  </instructions>
  <resume-signal>Type "webhook-updated" when Kapso webhook URL is configured</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Webhook endpoint deployed and configured in Kapso dashboard</what-built>
  <how-to-verify>
    Test webhook delivery end-to-end:

    1. **Send test message via Kapso dashboard** (if available):
       - Most webhook platforms have "Send Test Event" button
       - Trigger a test webhook delivery
       - Check production logs for webhook receipt

    2. **Send test WhatsApp message** (recommended):
       - Send a WhatsApp message to Eagle Overseas number from your phone
       - Message content: "Test webhook delivery"
       - Wait 5-10 seconds
       - Check production logs:
         ```bash
         vercel logs --production | grep -i webhook
         ```
       - Look for: "[Webhook] Received payload (masked)"
       - Look for: "[Webhook] Signature verified" (if secret configured)

    3. **Verify message appears in database**:
       - Visit Convex dashboard: https://dashboard.convex.dev
       - Open messages table
       - Check for new message with content "Test webhook delivery"
       - Verify contact_id and conversation_id are populated

    4. **Check for signature verification**:
       - In logs, verify line: "[Webhook] Signature verified"
       - If you see "[Webhook] Warning: KAPSO_WEBHOOK_SECRET not set", webhook secret is missing
       - If you see "[Webhook] Invalid signature", signature mismatch (check secret matches)

    **Expected results:**
    - ✓ Webhook received (log shows "Received payload")
    - ✓ Signature verified (if secret configured)
    - ✓ Message saved to Convex database
    - ✓ No errors in processing

    **If webhook not received:**
    - Verify Kapso webhook URL is exactly: https://www.my21staff.com/api/webhook/kapso
    - Check Kapso dashboard webhook delivery logs for errors
    - Verify production deployment is live (visit https://www.my21staff.com)
    - Check Vercel deployment logs for any errors

    **If signature fails:**
    - Verify KAPSO_WEBHOOK_SECRET matches Kapso dashboard signing secret
    - Re-deploy to apply environment variable changes:
      ```bash
      vercel --prod
      ```
  </how-to-verify>
  <resume-signal>Type "verified" if test message delivered successfully, or describe issues</resume-signal>
</task>

</tasks>

<verification>
**Automated checks:**
- GET /api/webhook/kapso?hub.challenge=test returns "test"
- Signature verification logic present in code
- KAPSO_WEBHOOK_SECRET environment variable set

**Manual verification:**
- Kapso webhook URL updated to production
- Test webhook delivery succeeds
- Signature verification passes
- Message appears in Convex database

**Success indicators:**
- Production logs show webhook receipt
- Signature verified (no 401 errors)
- Messages saved to database
</verification>

<success_criteria>
1. Kapso webhook URL points to production endpoint
2. GET challenge request returns challenge value
3. Valid signatures accepted (200 response)
4. Invalid signatures rejected (401 response)
5. Test message delivered and saved to database
</success_criteria>

<output>
After completion, create `.planning/phases/03-live-bot-integration/03-02-SUMMARY.md` with:
- Webhook GET endpoint test results
- Signature verification review findings
- Kapso dashboard configuration steps completed
- Test message delivery logs
- Webhook functionality status (verified/issues)
</output>
