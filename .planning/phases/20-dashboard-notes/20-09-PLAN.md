---
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/page.tsx
autonomous: true
---

# Plan 20-09: Dashboard Task Sorting & Complete Action

## Objective

Add "Mark Complete" action to dashboard tasks and verify sorting is correct (nearest due date first).

## Context

UAT Gaps #3 and #4:
- Gap #3: Dashboard to-do list should sort by due date (recent to farthest) - Current query already does this with `ascending: true`
- Gap #4: Dashboard needs "finish follow up" action to mark tasks done

## Tasks

<task id="1">
Add `completed_at` column to contact_notes table by creating migration `17_notes_completed_at.sql`:

```sql
-- Add completed_at column to contact_notes
ALTER TABLE contact_notes ADD COLUMN IF NOT EXISTS completed_at TIMESTAMPTZ DEFAULT NULL;

-- Add index for filtering uncompleted tasks
CREATE INDEX IF NOT EXISTS idx_contact_notes_uncompleted
ON contact_notes (workspace_id, due_date)
WHERE completed_at IS NULL;
```
</task>

<task id="2">
Update the dashboard query to filter out completed tasks by adding `.is('completed_at', null)` to the query.

Current (lines 69-76):
```typescript
supabase
  .from('contact_notes')
  .select('id, content, due_date, contact_id')
  .eq('workspace_id', workspace.id)
  .not('due_date', 'is', null)
  .gte('due_date', todayStart)
  .order('due_date', { ascending: true })
  .limit(10),
```

Change to:
```typescript
supabase
  .from('contact_notes')
  .select('id, content, due_date, contact_id')
  .eq('workspace_id', workspace.id)
  .not('due_date', 'is', null)
  .is('completed_at', null)
  .gte('due_date', todayStart)
  .order('due_date', { ascending: true })
  .limit(10),
```
</task>

<task id="3">
Create a server action to mark a task as complete. Create file `src/app/(dashboard)/[workspace]/actions.ts`:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function completeTask(noteId: string, workspaceSlug: string) {
  const supabase = await createClient()

  // Verify user has access
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) throw new Error('Unauthorized')

  // Update the note with completed_at timestamp
  const { error } = await supabase
    .from('contact_notes')
    .update({ completed_at: new Date().toISOString() })
    .eq('id', noteId)

  if (error) throw new Error(error.message)

  revalidatePath(`/${workspaceSlug}`)
}
```
</task>

<task id="4">
Extract the Upcoming Tasks section into a client component. Create file `src/components/dashboard/upcoming-tasks.tsx`:

```typescript
'use client'

import { useState } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Check, Loader2 } from 'lucide-react'
import { completeTask } from '@/app/(dashboard)/[workspace]/actions'

interface Task {
  id: string
  content: string
  due_date: string | null
  contact_id: string
}

interface Contact {
  id: string
  name: string | null
  phone: string | null
}

interface UpcomingTasksProps {
  tasks: Task[]
  contactMap: Map<string, Contact>
  workspaceSlug: string
}

export function UpcomingTasks({ tasks: initialTasks, contactMap, workspaceSlug }: UpcomingTasksProps) {
  const [tasks, setTasks] = useState(initialTasks)
  const [loading, setLoading] = useState<string | null>(null)

  const handleComplete = async (taskId: string) => {
    setLoading(taskId)
    try {
      await completeTask(taskId, workspaceSlug)
      setTasks(tasks.filter(t => t.id !== taskId))
    } catch (error) {
      console.error('Failed to complete task:', error)
    } finally {
      setLoading(null)
    }
  }

  return (
    <Card>
      <CardContent className="pt-6">
        {tasks.length > 0 ? (
          <div className="space-y-3">
            {tasks.map((task) => {
              const contact = contactMap.get(task.contact_id)
              return (
                <div
                  key={task.id}
                  className="flex items-start gap-3 p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors"
                >
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-6 w-6 p-0 rounded-full border border-muted-foreground/30 hover:bg-green-100 hover:border-green-500"
                    onClick={() => handleComplete(task.id)}
                    disabled={loading === task.id}
                  >
                    {loading === task.id ? (
                      <Loader2 className="h-3 w-3 animate-spin" />
                    ) : (
                      <Check className="h-3 w-3 opacity-0 group-hover:opacity-100" />
                    )}
                  </Button>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium truncate">{task.content}</p>
                    <p className="text-xs text-muted-foreground">
                      {contact?.name || contact?.phone || 'Unknown contact'}
                    </p>
                  </div>
                  <div className="text-xs text-muted-foreground whitespace-nowrap">
                    {task.due_date && new Date(task.due_date).toLocaleDateString('id-ID', {
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </div>
                </div>
              )
            })}
          </div>
        ) : (
          <p className="text-sm text-muted-foreground text-center py-8">
            No upcoming tasks. Add due dates to notes to see them here.
          </p>
        )}
      </CardContent>
    </Card>
  )
}
```
</task>

<task id="5">
Update the dashboard page to use the new UpcomingTasks component. Replace the current Upcoming Tasks Card section (lines 203-238) with the component.

Add import:
```typescript
import { UpcomingTasks } from '@/components/dashboard/upcoming-tasks'
```

Replace the Card in the Upcoming Tasks section with:
```typescript
<UpcomingTasks
  tasks={upcomingTasks || []}
  contactMap={contactMap}
  workspaceSlug={workspaceSlug}
/>
```
</task>

<task id="6">
Update TypeScript types in `src/types/database.ts` to include `completed_at` field in contact_notes if not already present.
</task>

## Verification

- [ ] Dashboard tasks sorted by nearest due date first
- [ ] Each task has a complete button
- [ ] Clicking complete removes the task from the list
- [ ] Completed tasks don't reappear on page refresh
- [ ] Migration applied successfully

## Must-Haves

- Tasks can be marked as complete
- Completed tasks are hidden from dashboard
- Sorting remains correct (nearest due date first)
- Optimistic UI update when completing a task
