---
wave: 1
depends_on: []
files_modified:
  - src/app/api/contacts/[id]/notes/route.ts
autonomous: true
---

# Plan 20-08: Fix Notes Creation Error Handling

## Objective

Improve error handling in the notes API to help debug "Failed to create note" errors by returning more specific error messages.

## Context

UAT Gap #1 (Blocker): Users see "Failed to create note" with no details. The actual Supabase error is logged server-side but not returned to the client. This makes debugging impossible.

## Tasks

<task id="1">
Update the POST handler in `src/app/api/contacts/[id]/notes/route.ts` to return the actual error message from Supabase in the response.

Current (line 148-154):
```typescript
if (insertError) {
  console.error('Error creating note:', insertError)
  return NextResponse.json(
    { error: 'Failed to create note' },
    { status: 500 }
  )
}
```

Change to:
```typescript
if (insertError) {
  console.error('Error creating note:', insertError)
  return NextResponse.json(
    { error: `Failed to create note: ${insertError.message}` },
    { status: 500 }
  )
}
```
</task>

<task id="2">
Add due_date format validation before the insert. If due_date is provided but invalid, return a 400 error with a clear message.

Add before the insert (around line 133):
```typescript
// Validate due_date format if provided
if (due_date && isNaN(new Date(due_date).getTime())) {
  return NextResponse.json(
    { error: 'Invalid due date format' },
    { status: 400 }
  )
}
```
</task>

<task id="3">
Update the generic catch block to also include more details:

Current (line 157-162):
```typescript
} catch (error) {
  console.error('Error in notes API:', error)
  return NextResponse.json(
    { error: 'Internal server error' },
    { status: 500 }
  )
}
```

Change to:
```typescript
} catch (error) {
  console.error('Error in notes API:', error)
  const message = error instanceof Error ? error.message : 'Unknown error'
  return NextResponse.json(
    { error: `Internal server error: ${message}` },
    { status: 500 }
  )
}
```
</task>

## Verification

- [ ] Create a note with a due date - should succeed without error
- [ ] If creation fails, error message includes actual cause (not just "Failed to create note")
- [ ] Invalid due_date format returns 400 with clear error message

## Must-Haves

- Error messages include actual cause for debugging
- due_date validation before insert
- No generic "Failed to create note" without details
