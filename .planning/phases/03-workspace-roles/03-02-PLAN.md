---
phase: 03-workspace-roles
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/api/contacts/route.ts
  - src/app/api/contacts/export/route.ts
  - src/app/api/invitations/route.ts
  - src/app/api/invitations/[id]/route.ts
  - src/app/api/workspaces/[id]/settings/route.ts
autonomous: true

must_haves:
  truths:
    - "DELETE /api/contacts returns 403 for non-owners"
    - "Export contacts returns 403 for members"
    - "POST /api/invitations returns 403 for non-owners"
    - "Workspace settings returns 403 for non-owners"
  artifacts:
    - path: "src/app/api/contacts/route.ts"
      provides: "Delete contact with owner-only check"
      contains: "requirePermission"
    - path: "src/app/api/contacts/export/route.ts"
      provides: "Export with owner/admin check"
      contains: "requirePermission"
    - path: "src/app/api/invitations/route.ts"
      provides: "Invite with owner-only check"
      contains: "requirePermission"
    - path: "src/app/api/invitations/[id]/route.ts"
      provides: "Delete/resend invitation with owner-only check"
      contains: "requirePermission"
  key_links:
    - from: "API routes"
      to: "src/lib/permissions/check.ts"
      via: "imports requirePermission"
      pattern: "import.*requirePermission.*from.*permissions"
    - from: "API routes"
      to: "src/lib/auth/workspace-auth.ts"
      via: "uses role from authResult"
      pattern: "authResult\\.role"
---

<objective>
Add permission enforcement to API routes â€” use `requirePermission()` to guard sensitive operations.

Purpose: Backend enforcement of role permissions. UI can be bypassed; API cannot.
Output: All sensitive API routes check permissions before proceeding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-roles/03-CONTEXT.md
@.planning/phases/03-workspace-roles/03-RESEARCH.md
@.planning/phases/03-workspace-roles/03-01-SUMMARY.md

# API routes to modify
@src/app/api/contacts/route.ts
@src/app/api/contacts/export/route.ts
@src/app/api/invitations/route.ts
@src/app/api/invitations/[id]/route.ts
@src/app/api/workspaces/[id]/settings/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DELETE handler with owner-only permission to contacts route</name>
  <files>src/app/api/contacts/route.ts</files>
  <action>
Add DELETE handler to contacts route. Per CONTEXT.md: "Delete leads: Owner only"

The route currently only has GET. Add DELETE handler:

```typescript
import { requireWorkspaceMembership } from '@/lib/auth/workspace-auth'
import { requirePermission } from '@/lib/permissions/check'

// DELETE /api/contacts?id=xxx - Delete a contact (owner only)
export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const contactId = searchParams.get('id')
    const workspaceId = searchParams.get('workspace')

    if (!contactId || !workspaceId) {
      return NextResponse.json(
        { error: 'Contact ID and workspace ID required' },
        { status: 400 }
      )
    }

    // Verify membership and get role
    const authResult = await requireWorkspaceMembership(workspaceId)
    if (authResult instanceof NextResponse) return authResult

    // Check permission - delete requires owner
    const permError = requirePermission(
      authResult.role,
      'leads:delete',
      'Only workspace owners can delete leads'
    )
    if (permError) return permError

    const supabase = await createClient()

    // Verify contact belongs to this workspace
    const { data: contact } = await supabase
      .from('contacts')
      .select('id')
      .eq('id', contactId)
      .eq('workspace_id', workspaceId)
      .single()

    if (!contact) {
      return NextResponse.json({ error: 'Contact not found' }, { status: 404 })
    }

    // Delete the contact
    const { error } = await supabase
      .from('contacts')
      .delete()
      .eq('id', contactId)

    if (error) {
      console.error('Error deleting contact:', error)
      return NextResponse.json({ error: error.message }, { status: 500 })
    }

    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('DELETE /api/contacts error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

Also update the existing GET handler to use the new auth that returns role (optional but good for consistency).
  </action>
  <verify>
```bash
# Test with curl - should get 403 for non-owner
curl -X DELETE "http://localhost:3000/api/contacts?id=xxx&workspace=yyy" \
  -H "Cookie: [member-session-cookie]"
# Expected: 403 "Only workspace owners can delete leads"
```
  </verify>
  <done>
DELETE /api/contacts returns 403 for admin/member users, 200 for owners.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add permission check to export route</name>
  <files>src/app/api/contacts/export/route.ts</files>
  <action>
Update export route to check `leads:export` permission. Per CONTEXT.md: "Admin: View all leads + export data"

The route already uses `requireWorkspaceMembership`. Update to:
1. Get role from authResult
2. Check `leads:export` permission (owner and admin have this)

```typescript
import { requirePermission } from '@/lib/permissions/check'

// In GET handler, after requireWorkspaceMembership:
const authResult = await requireWorkspaceMembership(workspaceId)
if (authResult instanceof NextResponse) return authResult

// Check export permission - owners and admins only
const permError = requirePermission(
  authResult.role,
  'leads:export',
  'Only workspace owners and admins can export data'
)
if (permError) return permError
```
  </action>
  <verify>
```bash
# Test export as member - should get 403
curl "http://localhost:3000/api/contacts/export?workspace=xxx" \
  -H "Cookie: [member-session-cookie]"
# Expected: 403 "Only workspace owners and admins can export data"
```
  </verify>
  <done>
Export returns 403 for members, 200 for owners/admins.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix invitation routes to owner-only</name>
  <files>
    src/app/api/invitations/route.ts
    src/app/api/invitations/[id]/route.ts
  </files>
  <action>
Update invitation routes per CONTEXT.md: "Team management (invite/remove): Owner only"

Currently these routes allow admin role (incorrect per CONTEXT.md).

**src/app/api/invitations/route.ts (POST - create invitation):**

Replace the manual role check with requirePermission:
```typescript
import { requireWorkspaceMembership } from '@/lib/auth/workspace-auth'
import { requirePermission } from '@/lib/permissions/check'

// Instead of:
// if (!membership || !['owner', 'admin'].includes(membership.role)) {...}

// Use:
const authResult = await requireWorkspaceMembership(workspaceId)
if (authResult instanceof NextResponse) return authResult

const permError = requirePermission(
  authResult.role,
  'team:invite',
  'Only workspace owners can invite team members'
)
if (permError) return permError
```

**src/app/api/invitations/[id]/route.ts (DELETE and POST/resend):**

Apply same pattern to both handlers:
- DELETE: Check `team:remove` permission
- POST (resend): Check `team:invite` permission

The invitation routes currently do their own membership lookup. Refactor to use `requireWorkspaceMembership` after getting the workspace_id from the invitation.

Note: The invitation must first be fetched to get workspace_id, then check permissions.
  </action>
  <verify>
```bash
# Test invitation as admin - should get 403 (owner only now)
curl -X POST "http://localhost:3000/api/invitations" \
  -H "Content-Type: application/json" \
  -H "Cookie: [admin-session-cookie]" \
  -d '{"email": "test@test.com", "workspaceId": "xxx"}'
# Expected: 403 "Only workspace owners can invite team members"
```
  </verify>
  <done>
Invitation create/delete/resend returns 403 for admin/member, 200 for owners only.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. DELETE /api/contacts requires owner role
3. GET /api/contacts/export requires owner or admin role
4. POST /api/invitations requires owner role
5. DELETE/POST /api/invitations/[id] requires owner role
6. All 403 responses include clear error message explaining why
</verification>

<success_criteria>
- All sensitive API routes import and use `requirePermission()`
- Error messages follow CONTEXT.md tone: helpful, not accusatory
- `npm run build` passes
- Non-owners receive 403 on owner-only operations
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-roles/03-02-SUMMARY.md`
</output>
