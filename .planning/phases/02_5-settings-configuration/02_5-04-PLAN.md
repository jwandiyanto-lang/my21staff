---
wave: 2
depends_on: []
files_modified:
  - src/components/inbox/conversation-list.tsx
  - src/components/inbox/message-view.tsx
  - src/components/inbox/template-dialog.tsx
  - src/components/inbox/interactive-dialog.tsx
  - src/app/(dashboard)/[workspace]/inbox/page.tsx
  - src/app/api/whatsapp/conversations/route.ts
  - src/app/api/whatsapp/messages/[id]/route.ts
  - src/lib/whatsapp-client.ts
  - src/lib/mock-whatsapp-data.ts
  - src/app/globals.css
autonomous: true
---

# 02_5-04-PLAN.md: WhatsApp Inbox (Fork whatsapp-cloud-inbox)

<objective>
Fork and integrate Kapso's whatsapp-cloud-inbox into my21staff dashboard with custom black/white branding. Use the repository as a foundation, applying my21staff styling (black/white, Geist Mono) while preserving all WhatsApp functionality (conversations, messages, templates, media).
</objective>

<must_haves>
- Fork whatsapp-cloud-inbox components into my21staff codebase
- Apply black/white + Geist Mono branding (override WhatsApp green theme)
- Two-panel layout: conversation list (left) + message view (right)
- Conversations fetched from Kapso API with auto-polling (10s)
- Messages fetched from Kapso API with auto-polling (5s)
- Send text messages, templates, and interactive messages
- Media support (image, video, audio, document)
- Dev mode works offline with mock data
- Mobile-responsive design
- Connect to workspace Kapso credentials from Convex
</must_haves>

<tasks>

## Task 1: Install dependencies and set up Kapso client

Install the Kapso WhatsApp Cloud API SDK and create a client wrapper for my21staff.

Files modified:
- RUN: `npm install @kapso/whatsapp-cloud-api`
- CREATE: src/lib/whatsapp-client.ts

```typescript
// WhatsApp client wrapper for Kapso API integration

import { WhatsAppClient } from "@kapso/whatsapp-cloud-api";

interface WhatsAppClientConfig {
  kapsoApiKey: string;
  phoneNumberId: string;
}

/**
 * Creates a configured WhatsApp client for Kapso API
 */
export function createWhatsAppClient(config: WhatsAppClientConfig): WhatsAppClient {
  return new WhatsAppClient({
    baseUrl: "https://api.kapso.ai/meta/whatsapp",
    kapsoApiKey: config.kapsoApiKey,
  });
}

/**
 * Gets WhatsApp credentials from workspace settings
 * In dev mode, returns mock credentials
 */
export async function getWhatsAppConfig(workspaceId: string) {
  const isDevMode = process.env.NEXT_PUBLIC_DEV_MODE === 'true'

  if (isDevMode) {
    return {
      kapsoApiKey: 'mock-api-key',
      phoneNumberId: 'mock-phone-id',
    }
  }

  // In production, fetch from Convex workspace settings
  // This will be implemented when workspace settings table exists
  throw new Error('Production WhatsApp config not yet implemented')
}
```

Verification:
- [ ] @kapso/whatsapp-cloud-api is installed
- [ ] createWhatsAppClient() function exists
- [ ] getWhatsAppConfig() supports dev mode

## Task 2: Create API routes for conversations and messages

Build Next.js API routes that proxy WhatsApp operations through Kapso.

Files modified:
- CREATE: src/app/api/whatsapp/conversations/route.ts
- CREATE: src/app/api/whatsapp/messages/[id]/route.ts

**Conversations route:**
```typescript
// GET /api/whatsapp/conversations?workspace={workspaceId}

import { NextResponse } from 'next/server'
import { createWhatsAppClient, getWhatsAppConfig } from '@/lib/whatsapp-client'
import { isDevMode, MOCK_WHATSAPP_CONVERSATIONS } from '@/lib/mock-whatsapp-data'

export async function GET(request: Request) {
  // Dev mode: return mock data
  if (isDevMode()) {
    return NextResponse.json({ conversations: MOCK_WHATSAPP_CONVERSATIONS })
  }

  // Production: fetch from Kapso
  try {
    const { searchParams } = new URL(request.url)
    const workspaceId = searchParams.get('workspace')

    if (!workspaceId) {
      return NextResponse.json({ error: 'Missing workspace ID' }, { status: 400 })
    }

    const config = await getWhatsAppConfig(workspaceId)
    const client = createWhatsAppClient(config)

    const result = await client.conversations.list({
      phoneNumberId: config.phoneNumberId,
      status: 'active',
      limit: 50,
    })

    return NextResponse.json({ conversations: result.data })
  } catch (error) {
    console.error('Failed to fetch conversations:', error)
    return NextResponse.json(
      { error: 'Failed to fetch conversations' },
      { status: 500 }
    )
  }
}
```

**Messages route:**
```typescript
// GET /api/whatsapp/messages/[id]?workspace={workspaceId}

import { NextResponse } from 'next/server'
import { createWhatsAppClient, getWhatsAppConfig } from '@/lib/whatsapp-client'
import { isDevMode, getMockMessages } from '@/lib/mock-whatsapp-data'

export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: conversationId } = await params

  // Dev mode: return mock messages
  if (isDevMode()) {
    const messages = getMockMessages(conversationId)
    return NextResponse.json({ messages, reactionMap: {} })
  }

  // Production: fetch from Kapso
  try {
    const { searchParams } = new URL(request.url)
    const workspaceId = searchParams.get('workspace')

    if (!workspaceId) {
      return NextResponse.json({ error: 'Missing workspace ID' }, { status: 400 })
    }

    const config = await getWhatsAppConfig(workspaceId)
    const client = createWhatsAppClient(config)

    const result = await client.messages.listByConversation({
      phoneNumberId: config.phoneNumberId,
      conversationId,
      limit: 100,
    })

    // Transform to match whatsapp-cloud-inbox format
    return NextResponse.json({ messages: result.data, reactionMap: {} })
  } catch (error) {
    console.error('Failed to fetch messages:', error)
    return NextResponse.json(
      { error: 'Failed to fetch messages' },
      { status: 500 }
    )
  }
}
```

Verification:
- [ ] Both API routes exist and handle dev mode
- [ ] Routes accept workspace ID parameter
- [ ] Error handling is in place

## Task 3: Create mock data for dev mode

Create mock WhatsApp conversations and messages for offline development.

Files modified:
- CREATE: src/lib/mock-whatsapp-data.ts

```typescript
// Mock WhatsApp data for dev mode testing

export function isDevMode(): boolean {
  return process.env.NEXT_PUBLIC_DEV_MODE === 'true'
}

export const MOCK_WHATSAPP_CONVERSATIONS = [
  {
    id: 'conv-1',
    phoneNumber: '+62 812-3456-7890',
    contactName: 'Budi Santoso',
    status: 'active',
    lastActiveAt: new Date().toISOString(),
    messagesCount: 5,
    lastMessage: {
      content: 'Terima kasih untuk infonya!',
      direction: 'inbound',
      type: 'text',
    },
  },
  {
    id: 'conv-2',
    phoneNumber: '+62 813-9876-5432',
    contactName: 'Siti Rahma',
    status: 'active',
    lastActiveAt: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
    messagesCount: 12,
    lastMessage: {
      content: 'Kapan bisa mulai?',
      direction: 'inbound',
      type: 'text',
    },
  },
  {
    id: 'conv-3',
    phoneNumber: '+62 821-1111-2222',
    contactName: undefined,
    status: 'active',
    lastActiveAt: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
    messagesCount: 3,
    lastMessage: {
      content: 'Halo, saya tertarik dengan layanan Anda',
      direction: 'inbound',
      type: 'text',
    },
  },
]

export function getMockMessages(conversationId: string) {
  // Return mock message history based on conversation ID
  return [
    {
      id: `msg-${conversationId}-1`,
      conversationId,
      direction: 'inbound',
      content: 'Halo, saya butuh info tentang layanan Anda',
      timestamp: new Date(Date.now() - 7200000).toISOString(),
      type: 'text',
      status: 'delivered',
    },
    {
      id: `msg-${conversationId}-2`,
      conversationId,
      direction: 'outbound',
      content: 'Halo! Tentu, dengan senang hati saya bantu. Layanan apa yang Anda cari?',
      timestamp: new Date(Date.now() - 7000000).toISOString(),
      type: 'text',
      status: 'read',
    },
    {
      id: `msg-${conversationId}-3`,
      conversationId,
      direction: 'inbound',
      content: 'Saya tertarik dengan paket premium',
      timestamp: new Date(Date.now() - 3600000).toISOString(),
      type: 'text',
      status: 'delivered',
    },
  ]
}
```

Verification:
- [ ] Mock conversations exist with realistic Indonesian data
- [ ] Mock messages function returns conversation-specific messages
- [ ] isDevMode() helper is exported

## Task 4: Fork inbox components from whatsapp-cloud-inbox

Copy and adapt the core inbox components from whatsapp-cloud-inbox repository.

Files modified:
- CREATE: src/components/inbox/conversation-list.tsx
- CREATE: src/components/inbox/message-view.tsx
- CREATE: src/components/inbox/template-dialog.tsx
- CREATE: src/components/inbox/interactive-dialog.tsx

Key adaptations:
1. Update API endpoints to use my21staff routes (`/api/whatsapp/...`)
2. Add workspace ID parameter to all fetch calls
3. Replace WhatsApp green theme with black/white
4. Ensure Geist Mono font is used for data
5. Add dev mode support (check `isDevMode()` flag)

Component checklist:
- [ ] ConversationList: Auto-polling, search, skeleton loaders
- [ ] MessageView: Message bubbles, media support, send/reply
- [ ] TemplateDialog: Template selection and sending
- [ ] InteractiveDialog: Interactive message creation

Verification:
- [ ] All 4 components exist in src/components/inbox/
- [ ] Components use my21staff API routes
- [ ] Components respect dev mode flag
- [ ] TypeScript has no errors

## Task 5: Create inbox page and integrate into dashboard

Create the inbox page route and add it to the sidebar navigation.

Files modified:
- CREATE: src/app/(dashboard)/[workspace]/inbox/page.tsx
- MODIFY: src/components/workspace/sidebar.tsx

**Inbox page:**
```typescript
// Inbox page with conversation list + message view

import { Suspense } from 'react'
import { notFound } from 'next/navigation'
import { fetchQuery } from 'convex/nextjs'
import { api } from 'convex/_generated/api'
import { ConversationList } from '@/components/inbox/conversation-list'
import { MessageView } from '@/components/inbox/message-view'
import { shouldUseMockData, MOCK_CONVEX_WORKSPACE } from '@/lib/mock-data'
import type { Id } from 'convex/_generated/dataModel'

interface InboxPageProps {
  params: Promise<{ workspace: string }>
}

export default async function InboxPage({ params }: InboxPageProps) {
  const { workspace: workspaceSlug } = await params

  // Dev mode: use mock workspace
  if (shouldUseMockData(workspaceSlug)) {
    return (
      <div className="flex h-screen">
        <ConversationList workspaceId={MOCK_CONVEX_WORKSPACE._id as Id<'workspaces'>} />
        <MessageView workspaceId={MOCK_CONVEX_WORKSPACE._id as Id<'workspaces'>} />
      </div>
    )
  }

  // Production: fetch real workspace
  const workspace = await fetchQuery(api.workspaces.getBySlug, {
    slug: workspaceSlug,
  })

  if (!workspace) {
    notFound()
  }

  return (
    <div className="flex h-screen">
      <ConversationList workspaceId={workspace._id} />
      <MessageView workspaceId={workspace._id} />
    </div>
  )
}
```

**Sidebar update:**
```typescript
// Add Inbox to operations navigation

const operationsNav = [
  {
    title: 'Inbox',
    icon: MessageSquare,
    href: '/inbox',
  },
  {
    title: 'Your Team',
    icon: Users,
    href: '/your-team',
  },
]
```

Verification:
- [ ] Inbox page exists and renders two-panel layout
- [ ] Dev mode shows mock conversations
- [ ] Inbox appears in sidebar navigation
- [ ] Route is accessible at /[workspace]/inbox

## Task 6: Apply my21staff branding (black/white + Geist Mono)

Override the whatsapp-cloud-inbox theme with my21staff's black/white aesthetic.

Files modified:
- MODIFY: src/app/globals.css

```css
/* Override WhatsApp green theme with my21staff black/white */
:root {
  /* Primary colors: Black instead of WhatsApp green */
  --primary: 0 0% 0%;           /* Pure black */
  --primary-foreground: 0 0% 100%;

  /* Background: Pure white */
  --background: 0 0% 100%;
  --foreground: 0 0% 0%;

  /* Muted: Subtle grey for backgrounds */
  --muted: 0 0% 96%;
  --muted-foreground: 0 0% 45%;

  /* Borders: Light grey */
  --border: 0 0% 90%;

  /* Cards */
  --card: 0 0% 100%;
  --card-foreground: 0 0% 0%;

  /* Accent: Orange highlight (from my21staff brand) */
  --accent: 25 95% 53%;         /* #F7931A */
  --accent-foreground: 0 0% 100%;

  /* Destructive: Red for errors */
  --destructive: 0 84% 60%;
  --destructive-foreground: 0 0% 100%;

  /* Input */
  --input: 0 0% 90%;
  --ring: 0 0% 0%;
}

/* Dark mode (optional, keep consistent with light) */
.dark {
  --primary: 0 0% 100%;
  --primary-foreground: 0 0% 0%;

  --background: 0 0% 0%;
  --foreground: 0 0% 100%;

  --muted: 0 0% 10%;
  --muted-foreground: 0 0% 60%;

  --border: 0 0% 20%;

  --card: 0 0% 5%;
  --card-foreground: 0 0% 100%;

  --accent: 25 95% 53%;
  --accent-foreground: 0 0% 0%;
}

/* Ensure Geist Mono is used for data (phone numbers, timestamps, message content) */
.inbox-data {
  font-family: var(--font-geist-mono);
}
```

Additional component-level styling:
- Add `.inbox-data` class to phone numbers, timestamps, message text
- Ensure message bubbles have proper contrast (black text on white, white text on black)
- Keep WhatsApp message bubble shape (rounded corners)
- Use `--accent` orange for highlights (new message indicator, unread badge)

Verification:
- [ ] Primary color is black (not WhatsApp green)
- [ ] Background is white with subtle grey for muted elements
- [ ] Geist Mono is applied to data fields
- [ ] Orange accent used for highlights
- [ ] Message bubbles have good contrast

## Task 7: Add dev mode indicator and test offline

Ensure inbox works perfectly in dev mode without network calls.

Files modified:
- MODIFY: src/components/inbox/conversation-list.tsx (add dev mode check)
- MODIFY: src/components/inbox/message-view.tsx (add dev mode check)

Add dev mode checks in fetch functions:
```typescript
// In ConversationList
const fetchConversations = async () => {
  if (isDevMode()) {
    setConversations(MOCK_WHATSAPP_CONVERSATIONS)
    setLoading(false)
    return
  }
  // Production fetch...
}

// In MessageView
const fetchMessages = async (conversationId: string) => {
  if (isDevMode()) {
    const messages = getMockMessages(conversationId)
    setMessages(messages)
    setLoading(false)
    return
  }
  // Production fetch...
}
```

Add "Offline Mode" indicator to inbox header:
```tsx
{isDevMode() && (
  <div className="px-4 py-2 bg-accent/10 border-b border-border">
    <div className="flex items-center gap-2 text-sm text-muted-foreground">
      <div className="w-2 h-2 rounded-full bg-accent" />
      <span className="font-mono">Offline Mode</span>
    </div>
  </div>
)}
```

Verification:
- [ ] `/demo/inbox` loads without network calls
- [ ] Mock conversations are displayed
- [ ] Mock messages load when conversation is selected
- [ ] "Offline Mode" indicator appears in dev mode
- [ ] Can "send" messages (stored in local state)

</tasks>

<verification>
- [ ] Inbox page exists at /[workspace]/inbox
- [ ] Conversation list displays with auto-polling (10s in production)
- [ ] Message view displays with auto-polling (5s in production)
- [ ] Can send text messages via Kapso API
- [ ] Template and interactive message dialogs work
- [ ] Media messages (image/video/audio/document) display correctly
- [ ] Mobile-responsive: single-panel view on small screens
- [ ] Black/white branding applied (no WhatsApp green)
- [ ] Geist Mono used for phone numbers, timestamps, message content
- [ ] Dev mode works offline with mock data
- [ ] "Offline Mode" indicator appears in dev mode
- [ ] Inbox in sidebar navigation
- [ ] No TypeScript errors (npm run type-check)
- [ ] No console errors in browser
</verification>
