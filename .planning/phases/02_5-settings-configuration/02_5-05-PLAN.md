---
wave: 3
depends_on: [02_5-01, 02_5-02, 02_5-03, 02_5-04]
files_modified:
  - convex/schema.ts
  - convex/settingsBackup.ts
  - src/app/api/workspaces/[workspace]/settings-backup/route.ts
  - src/components/settings/sync-status-indicator.tsx
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
autonomous: true
---

# 02_5-05-PLAN.md: Settings Backup & Sync Status

<objective>
Store bot configurations in Convex as backup, with sync status indicator showing last sync time and any errors. This ensures settings are recoverable and users know their configuration state.
</objective>

<must_haves>
- Convex schema for settings backup (bot configs, timestamps)
- Settings backup on every save operation
- Sync status indicator in Settings page header
- Shows: last sync time, sync status (synced/syncing/error)
- Error recovery guidance when sync fails
- Dev mode shows "Offline Mode" indicator
</must_haves>

<tasks>

## Task 1: Add settingsBackup table to Convex schema

Create table for storing configuration snapshots.

Files modified:
- MODIFY: convex/schema.ts

Add table:
```typescript
settingsBackup: defineTable({
  workspace_id: v.id("workspaces"),
  backup_type: v.string(), // 'intern_config', 'brain_config', 'bot_names', 'full'
  config_data: v.any(), // JSON of configuration
  source: v.string(), // 'user_save', 'auto_backup', 'import'
  created_at: v.number(),
  created_by: v.optional(v.string()), // Clerk user ID
})
  .index("by_workspace", ["workspace_id"])
  .index("by_workspace_type", ["workspace_id", "backup_type"])
```

Add sync tracking to workspaces table (settings field):
- last_settings_sync: timestamp
- settings_sync_status: 'synced' | 'pending' | 'error'
- settings_sync_error: string (if error)

Verification:
- [ ] Schema compiles (npx convex dev)
- [ ] Table created in Convex

## Task 2: Create settingsBackup Convex functions

Add functions for backup operations.

Files modified:
- CREATE: convex/settingsBackup.ts

Functions:
```typescript
// Create a new backup
export const createBackup = mutation({
  args: {
    workspace_id: v.string(),
    backup_type: v.string(),
    config_data: v.any(),
    source: v.string(),
  },
  handler: async (ctx, args) => {
    // Create backup record
    // Update workspace sync status
  },
})

// Get latest backup for a type
export const getLatestBackup = query({
  args: {
    workspace_id: v.string(),
    backup_type: v.string(),
  },
  handler: async (ctx, args) => {
    // Return most recent backup
  },
})

// Get backup history
export const listBackups = query({
  args: {
    workspace_id: v.string(),
    backup_type: v.optional(v.string()),
    limit: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    // Return backup history
  },
})

// Restore from backup (returns config data)
export const getBackupData = query({
  args: { backup_id: v.id("settingsBackup") },
  handler: async (ctx, args) => {
    // Return specific backup data
  },
})

// Update sync status
export const updateSyncStatus = mutation({
  args: {
    workspace_id: v.string(),
    status: v.string(),
    error: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Update workspace settings sync status
  },
})
```

Verification:
- [ ] Functions deploy without errors
- [ ] Can create and retrieve backups
- [ ] Sync status updates correctly

## Task 3: Create API route for settings backup

Add Next.js API route for backup operations.

Files modified:
- CREATE: src/app/api/workspaces/[workspace]/settings-backup/route.ts

```typescript
// GET: Get sync status and latest backups
export async function GET(request: Request, { params }) {
  // Return {
  //   syncStatus: 'synced' | 'pending' | 'error',
  //   lastSyncTime: timestamp,
  //   syncError: string | null,
  //   recentBackups: BackupSummary[]
  // }
}

// POST: Create manual backup
export async function POST(request: Request, { params }) {
  // Create backup from request body
  // Update sync status to 'synced'
}
```

Verification:
- [ ] GET returns sync status
- [ ] POST creates backup and updates status

## Task 4: Create SyncStatusIndicator component

Build UI component for showing sync status.

Files modified:
- CREATE: src/components/settings/sync-status-indicator.tsx

```tsx
interface SyncStatusIndicatorProps {
  workspaceId: string
}

export function SyncStatusIndicator({ workspaceId }: SyncStatusIndicatorProps) {
  // States: synced (green), syncing (orange pulse), error (red)

  // UI:
  // [Green dot] Synced - 2 minutes ago
  // [Orange pulse] Syncing...
  // [Red dot] Sync error - Click to retry

  // Dev mode:
  // [Orange dot] Offline Mode
}
```

Visual design:
- Small indicator with icon + text
- Green checkmark for synced
- Orange spinner for syncing
- Red warning for error
- Tooltip with details on hover
- Click to retry on error

Verification:
- [ ] Component renders all states correctly
- [ ] Shows appropriate colors/icons
- [ ] Tooltip shows details
- [ ] Click to retry works

## Task 5: Integrate sync indicator into Settings page

Add sync status to Settings page header.

Files modified:
- MODIFY: src/app/(dashboard)/[workspace]/settings/settings-client.tsx

Add to header area:
```tsx
<div className="mb-8 flex items-start justify-between">
  <div>
    <h1 className="text-3xl font-bold tracking-tight">Settings</h1>
    <p className="text-muted-foreground mt-1">
      Manage your workspace settings and team
    </p>
  </div>
  <div className="flex items-center gap-4">
    <SyncStatusIndicator workspaceId={workspace.id} />
    <Link href={`/${workspace.slug}/team`}>
      <Button variant="outline">
        <Users className="h-4 w-4 mr-2" />
        Manage Team
      </Button>
    </Link>
  </div>
</div>
```

Verification:
- [ ] Sync indicator appears in Settings header
- [ ] Status updates after saves
- [ ] Dev mode shows "Offline Mode"

## Task 6: Integrate backup creation into save operations

Modify existing save handlers to create backups.

Files modified:
- MODIFY: src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  - After successful save, call backup API
  - Update sync status to 'synced'

- MODIFY: src/components/your-team/intern-settings.tsx (from 02_5-03)
  - After successful save, create backup

- MODIFY: src/components/your-team/brain-settings.tsx (from 02_5-03)
  - After successful save, create backup

Implementation:
```typescript
// Helper function to backup after save
async function backupSettings(workspaceId: string, type: string, data: any) {
  if (isDevMode()) return // Skip in dev mode

  try {
    await fetch(`/api/workspaces/${workspaceId}/settings-backup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type, data }),
    })
  } catch (error) {
    console.error('Backup failed:', error)
    // Don't throw - backup failure shouldn't block save
  }
}
```

Verification:
- [ ] Backups created on save
- [ ] Sync status updates
- [ ] Backup failures don't block saves

</tasks>

<verification>
- [ ] settingsBackup table exists in Convex
- [ ] Backup functions work (create, get, list)
- [ ] API routes function correctly
- [ ] SyncStatusIndicator shows correct states
- [ ] Settings page displays sync status
- [ ] Saves trigger backup creation
- [ ] Sync status updates after saves
- [ ] Dev mode shows "Offline Mode"
- [ ] Backup failures are handled gracefully
- [ ] No type errors (npm run type-check)
</verification>
