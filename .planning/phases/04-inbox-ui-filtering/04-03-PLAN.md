---
phase: 04-inbox-ui-filtering
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
autonomous: false

must_haves:
  truths:
    - "User sees status tabs above conversation list with real-time counts"
    - "User sees tag filter dropdown below status tabs"
    - "Clicking status tab filters conversations by that status"
    - "Selecting tags filters conversations by all selected tags (AND logic)"
    - "Combined filters work: status + tags narrow results"
    - "Message bubbles display with WhatsApp-style green/white colors"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx"
      provides: "Integrated filter UI with FilterTabs and TagFilterDropdown"
      contains: "FilterTabs and TagFilterDropdown imports and rendering"
      min_lines: 350
  key_links:
    - from: "FilterTabs component"
      to: "inbox-client statusFilter state"
      via: "onChange callback"
      pattern: "setStatusFilter"
    - from: "TagFilterDropdown component"
      to: "inbox-client tagFilter state"
      via: "onChange callback"
      pattern: "setTagFilter"
    - from: "statusFilter + tagFilter state"
      to: "listWithFilters Convex query"
      via: "query args"
      pattern: "statusFilters.*tagFilters"
---

<objective>
Integrate FilterTabs and TagFilterDropdown into inbox-client; replace popover filters with tab-based UI and verify complete filtering workflow.

Purpose: Enable users to filter conversations using WhatsApp-style status tabs and tag multi-select with real-time updates.
Output: Functional inbox with status tabs, tag dropdown, combined filtering, and enhanced message display.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-CONTEXT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-RESEARCH.md

# Components created in Plan 04-01 and 04-02
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/filter-tabs.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/tag-filter-dropdown.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/message-bubble.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/message-thread.tsx

# Current inbox client (to be modified)
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Replace popover filters with FilterTabs and TagFilterDropdown</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Modify inbox-client.tsx to integrate new filter components created in Plan 04-01.

**Remove old filter UI:**
- Remove Popover-based status filter (lines with Popover, PopoverContent, PopoverTrigger for status filtering)
- Keep viewMode toggle (Active/All button group) - this stays above filters
- Remove Filter icon imports if only used for removed popover

**Add new filter UI imports:**
```typescript
import { FilterTabs } from '@/components/inbox/filter-tabs'
import { TagFilterDropdown } from '@/components/inbox/tag-filter-dropdown'
```

**Layout structure (top of inbox, above conversation list):**
```tsx
<div className="flex flex-col gap-3 p-4 border-b">
  {/* View mode toggle (Active/All) - keep existing */}
  <div className="flex items-center gap-2">
    {/* Existing Active/All button group */}
  </div>

  {/* Status filter tabs - NEW */}
  <FilterTabs
    value={statusFilter}
    onChange={setStatusFilter}
    workspaceId={workspaceId}
    activeOnly={viewMode === 'active'}
  />

  {/* Tag filter + Search - NEW LAYOUT */}
  <div className="flex items-center gap-2">
    <TagFilterDropdown
      value={tagFilter}
      onChange={setTagFilter}
      workspaceId={workspaceId}
    />
    {/* Keep existing search input */}
    <Input
      placeholder="Search conversations..."
      value={searchQuery}
      onChange={(e) => setSearchQuery(e.target.value)}
      className="flex-1"
    />
  </div>
</div>
```

**State management (already exists - verify correctness):**
- `statusFilter` state: Should be `LeadStatus[]` array, not single value
- `tagFilter` state: Should be `string[]` array
- `viewMode` state: Should be `'active' | 'all'`
- FilterTabs onChange: `setStatusFilter([newStatus])` (single selection, replaces array)
- TagFilterDropdown onChange: `setTagFilter(newTags)` (multi-select, full array)

**Convex query (already correct - verify args):**
- listWithFilters query receives: statusFilters, tagFilters, active
- Pass statusFilter.length > 0 ? statusFilter : undefined
- Pass tagFilter.length > 0 ? tagFilter : undefined

**Client-side filtering fallback (dev mode - already exists):**
- Keep existing useMemo logic for filtering MOCK_CONVERSATIONS
- Status filter: OR logic (show conversations matching ANY selected status)
- Tag filter: AND logic (show conversations with ALL selected tags)

**Remove clutter:**
- Remove any unused imports after removing popover (Popover, PopoverContent, PopoverTrigger, Filter icon if unused)
- Clean up any orphaned state or handlers related to old filter UI

DO NOT change other parts of inbox-client: conversation selection, message thread rendering, info sidebar, etc. ONLY replace filter UI section.
  </action>
  <verify>
```bash
# New components imported
grep -q "import.*FilterTabs" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep -q "import.*TagFilterDropdown" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# Old popover removed
! grep -q "PopoverContent.*status" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# Components rendered
grep -q "<FilterTabs" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep -q "<TagFilterDropdown" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# State wired correctly
grep -q "value={statusFilter}" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep -q "value={tagFilter}" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
```
  </verify>
  <done>inbox-client.tsx modified with FilterTabs above conversation list, TagFilterDropdown next to search, old popover filters removed, state wired to new components, layout restructured with proper spacing and borders</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Inbox UI with status tabs, tag filtering, and WhatsApp-style message bubbles</what-built>
  <how-to-verify>
1. **Start dev server and navigate to inbox:**
   ```bash
   npm run dev
   # Visit: http://localhost:3000/demo/inbox
   ```

2. **Verify status filter tabs (FilterTabs component):**
   - [ ] Status tabs visible above conversation list: All | New | Hot | Warm | Cold | Client | Lost
   - [ ] Each tab shows count badge: e.g., "Hot (5)" (counts from mock data)
   - [ ] Click "Hot" tab: Only hot leads show in conversation list
   - [ ] Click "All" tab: All conversations show (filter cleared)
   - [ ] Active tab has primary color background, inactive tabs have muted background

3. **Verify tag filter dropdown (TagFilterDropdown component):**
   - [ ] Tag filter button visible below status tabs, next to search input
   - [ ] Click button: Dropdown opens with checkboxes for each tag
   - [ ] Select multiple tags: Button shows "Tags (N)" count badge
   - [ ] Conversations filtered to show only those with ALL selected tags (AND logic)
   - [ ] Click "Clear all": All tags deselected, filter cleared

4. **Verify combined filtering:**
   - [ ] Select status tab "Hot" + tag "interested": Shows conversations matching both filters
   - [ ] Filter narrows correctly: status first, then tags within that status
   - [ ] Counts update: Status tabs show counts for active filter combination

5. **Verify message thread (WhatsApp-style UI):**
   - [ ] Select any conversation: Message thread opens
   - [ ] Sender messages (outgoing): Right-aligned, emerald-500 background, white text, rounded-tr-sm
   - [ ] Receiver messages (incoming): Left-aligned, white background, dark text, rounded-tl-sm
   - [ ] Both bubble types: 70% max-width, shadow, proper padding
   - [ ] Timestamps visible in bubbles: text-xs, opacity-70

6. **Verify auto-scroll behavior:**
   - [ ] Message thread scrolls to bottom on open (instant)
   - [ ] Scroll up manually: Check if "New messages" button appears (if new message simulation possible)
   - [ ] Message thread container has scroll detection (inspect: onScroll handler)

7. **Verify Active/All toggle still works:**
   - [ ] Toggle "Active" vs "All" at top: Conversation list updates
   - [ ] Search input: Type to filter conversations by name/phone

8. **Check for console errors:**
   - [ ] Open browser DevTools console
   - [ ] No errors related to FilterTabs, TagFilterDropdown, or message components
   - [ ] No Convex query errors (should use mock data in dev mode)

9. **Check responsive layout:**
   - [ ] Resize browser to mobile width (~375px)
   - [ ] Status tabs wrap or scroll horizontally (mobile-friendly)
   - [ ] Tag filter and search stack properly
   - [ ] Message bubbles maintain 70% max-width on mobile
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
After Task 1 completes and before checkpoint:

1. Syntax check:
```bash
# No TypeScript errors
npx tsc --noEmit --project tsconfig.json 2>&1 | grep -i "inbox-client" || echo "No errors"

# Component imports resolve
grep "from '@/components/inbox/filter-tabs'" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep "from '@/components/inbox/tag-filter-dropdown'" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
```

2. Dev mode check:
```bash
# Verify dev mode flag in .env.local
grep "NEXT_PUBLIC_DEV_MODE=true" .env.local
```

3. File changes:
```bash
# Count lines changed in inbox-client
git diff --stat src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
```

During human verification checkpoint:
- User tests all filter combinations
- User confirms WhatsApp-style bubbles match design
- User verifies auto-scroll behavior
- User checks for console errors
- User approves or reports issues
</verification>

<success_criteria>
- [ ] FilterTabs component integrated above conversation list
- [ ] TagFilterDropdown component integrated next to search input
- [ ] Old popover-based filters removed from inbox-client
- [ ] Status filter works: Clicking tab filters conversations by status
- [ ] Tag filter works: Selecting tags filters by all selected tags (AND logic)
- [ ] Combined filters work: Status + tags narrow results correctly
- [ ] Real-time counts display in status tabs (from Convex or mock data)
- [ ] Message bubbles display with WhatsApp-style green/white colors
- [ ] Auto-scroll behavior works: Scrolls to bottom on new messages if at bottom
- [ ] "New messages" indicator appears when scrolled up (if testable)
- [ ] No console errors in dev mode
- [ ] Layout responsive on mobile widths
- [ ] Active/All toggle and search input still functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-inbox-ui-filtering/04-03-SUMMARY.md`
</output>
