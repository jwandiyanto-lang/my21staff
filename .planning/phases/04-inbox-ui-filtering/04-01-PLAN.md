---
phase: 04-inbox-ui-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/inbox/filter-tabs.tsx
  - src/components/inbox/tag-filter-dropdown.tsx
  - convex/conversations.ts
autonomous: true

must_haves:
  truths:
    - "User sees status tabs above conversation list showing All | New | Hot | Warm | Cold | Client | Lost"
    - "Each status tab displays real-time conversation count: 'Hot (5)'"
    - "User can select tag filter from multi-select dropdown showing workspace tags"
  artifacts:
    - path: "src/components/inbox/filter-tabs.tsx"
      provides: "Status tabs with real-time counts"
      min_lines: 80
    - path: "src/components/inbox/tag-filter-dropdown.tsx"
      provides: "Tag multi-select dropdown"
      min_lines: 60
    - path: "convex/conversations.ts"
      provides: "getConversationCountsByStatus query"
      exports: ["getConversationCountsByStatus"]
  key_links:
    - from: "src/components/inbox/filter-tabs.tsx"
      to: "convex/conversations.ts"
      via: "useQuery for real-time counts"
      pattern: "useQuery.*getConversationCountsByStatus"
    - from: "src/components/inbox/tag-filter-dropdown.tsx"
      to: "convex/workspaces.ts"
      via: "fetch workspace tags"
      pattern: "useQuery.*workspaces\\.get"
---

<objective>
Create filter UI components for Inbox: status tabs with real-time counts and tag multi-select dropdown.

Purpose: Enable users to filter conversations by status (hot/warm/cold/new/client/lost) and tags using WhatsApp-style tab interface with live counts.
Output: Three foundational filter components ready for integration into inbox-client.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-CONTEXT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-RESEARCH.md

# Current inbox implementation
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/conversation-list.tsx
@/home/jfransisco/Desktop/21/my21staff/src/lib/lead-status.ts

# Convex schema and existing queries
@/home/jfransisco/Desktop/21/my21staff/convex/conversations.ts
@/home/jfransisco/Desktop/21/my21staff/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Create FilterTabs component with status tabs and real-time counts</name>
  <files>src/components/inbox/filter-tabs.tsx</files>
  <action>
Create FilterTabs component that displays status filter as horizontal tabs (not popover). Component accepts:
- `value: LeadStatus[]` - currently selected statuses
- `onChange: (statuses: LeadStatus[]) => void` - callback when selection changes
- `workspaceId: Id<'workspaces'>` - for fetching counts
- `activeOnly: boolean` - for count query filter

Design:
- Horizontal tab bar with: All | New | Hot | Warm | Cold | Client | Lost
- Each tab shows count badge: "Hot (5)" (uses Shadcn Badge component)
- "All" tab selected by default (empty statusFilter array means "all")
- Single selection only (clicking tab replaces current filter, not multi-select)
- Use Shadcn Button components styled as tabs
- Active tab: bg-primary text-primary-foreground
- Inactive tabs: bg-muted hover:bg-muted/80
- Use LEAD_STATUS_CONFIG from @/lib/lead-status for status definitions

Real-time counts:
- Use useQuery(api.conversations.getConversationCountsByStatus, { workspace_id, active })
- Dev mode: Return MOCK_CONVERSATIONS.length for each status
- Display count only if > 0 (hide if zero to reduce clutter)

Error handling:
- If query loading: Show tabs without counts (loading state)
- If query error: Show tabs with "(?)" placeholder

Import from: lucide-react (icons), @/components/ui/button, @/components/ui/badge, convex/react (useQuery), @/lib/lead-status
  </action>
  <verify>
```bash
# Component created with proper types
grep -q "export function FilterTabs" src/components/inbox/filter-tabs.tsx

# Uses getConversationCountsByStatus query
grep -q "getConversationCountsByStatus" src/components/inbox/filter-tabs.tsx

# Has dev mode support
grep -q "isDevMode" src/components/inbox/filter-tabs.tsx
```
  </verify>
  <done>FilterTabs component file exists with status tab buttons, real-time count display via Convex useQuery, dev mode mock counts, and single-selection behavior</done>
</task>

<task type="auto">
  <name>Create TagFilterDropdown component with multi-select</name>
  <files>src/components/inbox/tag-filter-dropdown.tsx</files>
  <action>
Create TagFilterDropdown component for filtering conversations by tags. Component accepts:
- `value: string[]` - currently selected tags
- `onChange: (tags: string[]) => void` - callback when selection changes
- `workspaceId: Id<'workspaces'>` - for fetching available tags

Design:
- Use Shadcn Popover + Button trigger showing "Tags" with Tag icon
- Trigger shows count when filters active: "Tags (3)" with Badge
- Dropdown content: list of checkboxes (Shadcn Checkbox) for each tag
- Multi-select: clicking checkbox toggles tag in/out of selection
- Show "Clear all" button at bottom if any tags selected
- Use AND logic (consistent with CONTEXT.md: conversations must have ALL selected tags)

Tag source:
- Fetch workspace tags from useQuery(api.workspaces.get, { id: workspaceId })
- Extract unique tags from workspace.settings.tags array
- Dev mode: Use MOCK_CONVEX_WORKSPACE.settings.tags from @/lib/mock-data
- Sort tags alphabetically
- If no tags available: Show "No tags configured" message

Styling:
- Popover: max-height 300px, overflow-y-auto
- Checkbox items: py-2 px-3 hover:bg-muted cursor-pointer
- Selected tags: Show checkmark (Checkbox checked state)

Import from: lucide-react (Tag icon), @/components/ui/popover, @/components/ui/button, @/components/ui/checkbox, @/components/ui/badge, convex/react (useQuery), @/lib/mock-data (isDevMode, MOCK_CONVEX_WORKSPACE)
  </action>
  <verify>
```bash
# Component created with proper types
grep -q "export function TagFilterDropdown" src/components/inbox/tag-filter-dropdown.tsx

# Uses workspace query for tags
grep -q "api.workspaces.get" src/components/inbox/tag-filter-dropdown.tsx

# Has multi-select checkbox logic
grep -q "Checkbox" src/components/inbox/tag-filter-dropdown.tsx

# Has dev mode support
grep -q "isDevMode" src/components/inbox/tag-filter-dropdown.tsx
```
  </verify>
  <done>TagFilterDropdown component file exists with multi-select checkboxes, workspace tag fetching, dev mode mock tags, AND logic for tag filtering, and clear-all functionality</done>
</task>

<task type="auto">
  <name>Create getConversationCountsByStatus Convex query</name>
  <files>convex/conversations.ts</files>
  <action>
Add getConversationCountsByStatus query to existing convex/conversations.ts file (do not overwrite file - add to existing exports).

Query signature:
```typescript
export const getConversationCountsByStatus = query({
  args: {
    workspace_id: v.id("workspaces"),
    active: v.optional(v.boolean()), // Filter active vs all conversations
  },
  handler: async (ctx, args) => {
    // Implementation
  }
})
```

Implementation:
1. Query conversations by workspace_id using existing by_workspace index
2. If args.active === true, filter to conversations.status === 'open'
3. For each conversation, fetch related contact via conversations.contact_id
4. Group conversations by contact.lead_status (default to "new" if null)
5. Return object: { new: 5, hot: 12, warm: 8, cold: 3, client: 2, lost: 1 }

Performance considerations:
- Use ctx.db.query().withIndex() for indexed lookup (existing by_workspace index)
- Fetch contacts in batch if possible (use Promise.all for parallel fetches)
- Return 0 for statuses with no conversations (omit from object to save bytes)

Edge cases:
- Contact not found (deleted): Skip conversation in count
- Contact has no lead_status: Count as "new"
- Empty workspace: Return empty object {}

Match existing pattern:
- Study listWithFilters query in same file for workspace filtering pattern
- Use same index and filtering approach
- Follow same error handling conventions

DO NOT use .collect() unnecessarily - iterate through query results directly if possible for memory efficiency.
  </action>
  <verify>
```bash
# Query exported
grep -q "export const getConversationCountsByStatus = query" convex/conversations.ts

# Has workspace_id arg
grep -A 5 "getConversationCountsByStatus = query" convex/conversations.ts | grep -q "workspace_id"

# Uses by_workspace index
grep -A 20 "getConversationCountsByStatus" convex/conversations.ts | grep -q "by_workspace"

# Returns object with status counts
grep -A 20 "getConversationCountsByStatus" convex/conversations.ts | grep -q "return"
```
  </verify>
  <done>getConversationCountsByStatus query added to convex/conversations.ts with workspace filtering, contact status grouping, active/all toggle, and returns status count object</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. FilterTabs component:
```bash
# Verify component structure
cat src/components/inbox/filter-tabs.tsx | grep -c "Button" # Should see multiple (one per status)
cat src/components/inbox/filter-tabs.tsx | grep "getConversationCountsByStatus"
```

2. TagFilterDropdown component:
```bash
# Verify multi-select logic
cat src/components/inbox/tag-filter-dropdown.tsx | grep "Checkbox"
cat src/components/inbox/tag-filter-dropdown.tsx | grep "api.workspaces.get"
```

3. Convex query:
```bash
# Verify query added without breaking existing
npm run convex:dev -- env | head -5  # Should start successfully
grep -c "export const" convex/conversations.ts  # Count should increase by 1
```

4. Dev mode support:
- All three components handle isDevMode() check
- FilterTabs returns mock counts for dev mode
- TagFilterDropdown uses MOCK_CONVEX_WORKSPACE.settings.tags
</verification>

<success_criteria>
- [ ] FilterTabs component renders status tabs with count badges
- [ ] TagFilterDropdown component renders tag checkboxes with multi-select
- [ ] getConversationCountsByStatus query returns status counts from Convex
- [ ] All components support dev mode with mock data
- [ ] FilterTabs uses single-selection (clicking tab replaces current filter)
- [ ] TagFilterDropdown uses AND logic (all selected tags must match)
- [ ] Real-time counts update via Convex subscriptions (no manual polling)
- [ ] No new npm packages required (all tools already in project)
- [ ] Components follow existing inbox patterns (Shadcn/ui, Tailwind, Convex useQuery)
</success_criteria>

<output>
After completion, create `.planning/phases/04-inbox-ui-filtering/04-01-SUMMARY.md`
</output>
