---
phase: 04-inbox-ui-filtering
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Inbox displays with 2-column layout (conversation sidebar + message thread)"
    - "Right sidebar (InfoSidebar) does not overlay message thread"
    - "Filter bar has dedicated space, not cramped in header"
    - "Layout proportions match WhatsApp Web (narrow sidebar, wide thread)"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx"
      provides: "2-column grid layout with responsive proportions"
      contains: "grid grid-cols-\\[25%_1fr\\]|grid-cols-\\[350px_1fr\\]"
      min_lines: 400
  key_links:
    - from: "FilterTabs component"
      to: "dedicated filter section"
      via: "separate div with border-b"
      pattern: "border-b.*FilterTabs"
    - from: "InfoSidebar conditional render"
      to: "third column in grid (desktop only)"
      via: "grid-cols responsive pattern"
      pattern: "lg:grid-cols-\\[.*1fr.*350px\\]"
---

<objective>
Restructure inbox-client.tsx from 3-column overlay layout to 2-column integrated design matching Kapso WhatsApp Cloud Inbox architecture.

Purpose: Align inbox layout with Kapso reference design - clean 2-column structure (sidebar + thread) with integrated right panel on desktop, hidden on mobile.
Output: Inbox with proper 2-column grid layout, no overlay sidebar blocking message thread, dedicated filter bar section.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-inbox-ui-filtering-UAT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/debug/inbox-kapso-design-gap.md

# Current implementation with architecture mismatch
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/contact/info-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Restructure inbox-client layout to 2-column grid with responsive right panel</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Modify inbox-client.tsx to use 2-column grid layout instead of 3-column flex with overlay.

**Current architecture (lines 300-418):**
```tsx
<div className="flex h-[calc(100vh-4rem)] relative">
  <div className="w-80 border-r">Conversation list</div>
  <div className="flex-1">Message thread</div>
  {showInfoSidebar && (
    <div className="absolute right-0 top-0 z-10 shadow-lg">InfoSidebar overlay</div>
  )}
</div>
```

**New architecture (2-column with responsive 3rd column):**
```tsx
<div className={cn(
  "grid h-[calc(100vh-4rem)]",
  showInfoSidebar && selectedConversationId
    ? "grid-cols-[350px_1fr] lg:grid-cols-[350px_1fr_400px]"
    : "grid-cols-[350px_1fr]"
)}>
  {/* Left: Conversation list - fixed 350px */}
  <div className="border-r bg-background flex flex-col">...</div>

  {/* Center: Message thread - flex-1 */}
  <div className="flex flex-col bg-muted/30 min-w-0">...</div>

  {/* Right: InfoSidebar - integrated on desktop, hidden on mobile */}
  {showInfoSidebar && selectedConversationId && contactForSidebar && (
    <div className="hidden lg:flex border-l bg-background overflow-y-auto">
      <InfoSidebar ... />
    </div>
  )}
</div>
```

**Key changes:**

1. **Root container:** Change from `flex relative` to `grid` with responsive columns
   - Mobile/tablet (< 1024px): 2 columns `[350px_1fr]` (sidebar + thread, InfoSidebar hidden)
   - Desktop (≥ 1024px): 3 columns when InfoSidebar shown `[350px_1fr_400px]`
   - Use conditional grid-cols based on showInfoSidebar state

2. **Left sidebar (conversation list):**
   - Change from `w-80` (320px) to fixed 350px in grid-cols
   - Keep all existing structure: Active/All toggle, FilterTabs, TagFilterDropdown, search, ConversationList
   - No changes to internal components or logic

3. **Center area (message thread):**
   - Remove `relative` positioning (no longer needed for overlay)
   - Keep all existing MessageThreadWrapper logic
   - MessageThread component unchanged

4. **Right sidebar (InfoSidebar):**
   - Remove `absolute right-0 top-0 h-full z-10 shadow-lg` positioning
   - Add `hidden lg:flex` classes (hidden on mobile, shown as flex on desktop)
   - Add `border-l bg-background overflow-y-auto` for proper grid integration
   - Keep all existing InfoSidebar props unchanged
   - On mobile: InfoSidebar hidden (future: convert to modal/drawer)

5. **Responsive behavior:**
   - Mobile (< 1024px): Hide InfoSidebar entirely (user can't open it yet - acceptable gap)
   - Desktop (≥ 1024px): Show InfoSidebar as integrated third column when showInfoSidebar=true
   - Toggle button in MessageThread still works (controls showInfoSidebar state)

**Why this approach:**
- Minimal changes to existing components (FilterTabs, TagFilterDropdown, MessageThread, InfoSidebar all unchanged)
- Proper grid layout eliminates overlay z-index issues
- Responsive behavior: mobile gets 2-col (clean), desktop gets 3-col when needed
- InfoSidebar no longer blocks message thread (integrated in grid flow)

**DO NOT:**
- Change FilterTabs, TagFilterDropdown, MessageThread, or InfoSidebar components
- Modify state management or filter logic
- Change search functionality or ConversationList
- Touch message sending or auto-scroll behavior

**Reference from debug investigation:**
- Current issue: "InfoSidebar uses floating overlay instead of integrated panel" (.planning/debug/inbox-kapso-design-gap.md Evidence 5)
- Gap: "Dedicated filter bar (separate section below search)" and "Integrated right panel (not overlay)" (UAT.md missing items)
  </action>
  <verify>
```bash
# Grid layout implemented
grep -q "grid.*grid-cols-\[350px_1fr\]" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# Responsive 3-column for InfoSidebar
grep -q "lg:grid-cols-\[.*1fr.*400px\]" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# InfoSidebar no longer absolute positioned
! grep -q "absolute right-0.*InfoSidebar" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# InfoSidebar has responsive classes
grep -q "hidden lg:flex.*InfoSidebar" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx

# Root container is grid, not flex
grep -q "grid h-\[calc(100vh-4rem)\]" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
```
  </verify>
  <done>inbox-client.tsx restructured with 2-column grid layout (350px sidebar + flex-1 thread), responsive 3rd column for InfoSidebar on desktop (lg:), no overlay positioning, proper grid integration with border-l and overflow handling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Restructured inbox layout with 2-column grid and integrated InfoSidebar (desktop only)</what-built>
  <how-to-verify>
1. **Start dev server and test desktop layout:**
   ```bash
   npm run dev
   # Visit: http://localhost:3000/demo/inbox
   ```

2. **Verify 2-column base layout (no conversation selected):**
   - [ ] Left sidebar: 350px width, fixed
   - [ ] Right area: Message thread fills remaining space
   - [ ] No third column visible (InfoSidebar hidden when no conversation selected)
   - [ ] Layout feels spacious, not cramped

3. **Verify 3-column layout with InfoSidebar (desktop):**
   - [ ] Select any conversation from list
   - [ ] Message thread appears in center
   - [ ] InfoSidebar appears on right as third column (NOT overlay)
   - [ ] InfoSidebar does NOT block message thread
   - [ ] InfoSidebar has left border (visual separation)
   - [ ] Can scroll InfoSidebar independently
   - [ ] Can read messages AND see contact info simultaneously

4. **Verify InfoSidebar toggle:**
   - [ ] Click toggle button in MessageThread header
   - [ ] InfoSidebar disappears: layout switches to 2-column
   - [ ] Message thread expands to fill space (no gap where sidebar was)
   - [ ] Click toggle again: InfoSidebar reappears, layout back to 3-column

5. **Verify filter bar spacing (not cramped):**
   - [ ] Active/All toggle has proper spacing at top
   - [ ] FilterTabs below has full width, not squished
   - [ ] TagFilterDropdown + Search row has proper gap between elements
   - [ ] All three sections (toggle, tabs, search) have vertical spacing (space-y-3)

6. **Verify mobile layout (resize to < 1024px width):**
   - [ ] Resize browser to mobile width (e.g., 768px)
   - [ ] InfoSidebar hidden completely (expected - no modal yet)
   - [ ] Left sidebar + message thread visible in 2-column layout
   - [ ] Filter UI still functional (can filter and view messages)

7. **Verify no visual regressions:**
   - [ ] Conversation list renders correctly
   - [ ] Status tabs with counts visible
   - [ ] Tag dropdown works
   - [ ] Message bubbles display properly (emerald sender, white receiver)
   - [ ] Auto-scroll still works in message thread

8. **Check for layout issues:**
   - [ ] No horizontal scrollbar (layout fits viewport)
   - [ ] No overlapping elements
   - [ ] No z-index conflicts
   - [ ] InfoSidebar doesn't cover message thread

9. **Console check:**
   - [ ] No React errors in console
   - [ ] No "Warning: Each child should have unique key" errors
   - [ ] No Convex query errors (should use mock data in dev mode)

10. **Compare to Kapso reference (if accessible):**
    - [ ] Layout now closer to 2-column WhatsApp Web aesthetic
    - [ ] Sidebar proportions feel balanced (not too narrow or wide)
    - [ ] InfoSidebar integrated, not floating
  </how-to-verify>
  <resume-signal>Type "approved" if layout restructure successful, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After Task 1 completes:

1. **File changes check:**
```bash
# Verify layout structure changed
git diff src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx | grep -E "grid|flex|absolute"
```

2. **Component imports unchanged:**
```bash
# All existing imports should still be present
grep "import.*FilterTabs" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep "import.*MessageThread" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep "import.*InfoSidebar" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
```

3. **State management unchanged:**
```bash
# Filter state should still exist
grep "useState.*statusFilter" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
grep "useState.*showInfoSidebar" src/app/\(dashboard\)/\[workspace\]/inbox/inbox-client.tsx
```

During human verification:
- User confirms 2-column layout matches WhatsApp Web aesthetic
- User verifies InfoSidebar no longer overlays message thread
- User tests toggle functionality (show/hide InfoSidebar)
- User checks mobile responsive behavior (InfoSidebar hidden)
- User approves or reports layout issues
</verification>

<success_criteria>
- [ ] Root container uses grid layout with responsive columns
- [ ] Base layout is 2-column: `grid-cols-[350px_1fr]`
- [ ] Desktop with InfoSidebar: `lg:grid-cols-[350px_1fr_400px]`
- [ ] InfoSidebar no longer uses absolute positioning
- [ ] InfoSidebar hidden on mobile (`hidden lg:flex`)
- [ ] InfoSidebar integrated on desktop with border-l and proper scrolling
- [ ] Left sidebar fixed at 350px (better than previous 320px w-80)
- [ ] Message thread no longer covered by overlay
- [ ] Toggle button still controls InfoSidebar visibility
- [ ] Filter bar has proper spacing (not cramped)
- [ ] No z-index conflicts or overlapping elements
- [ ] Layout responsive on mobile (InfoSidebar hidden gracefully)
- [ ] All existing functionality preserved (filters, search, messaging)
</success_criteria>

<output>
After completion, create `.planning/phases/04-inbox-ui-filtering/04-04-SUMMARY.md`
</output>
