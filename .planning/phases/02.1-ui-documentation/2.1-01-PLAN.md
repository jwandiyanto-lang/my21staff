---
phase: 02.1-ui-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/workspaces/[id]/ari-config/route.ts
  - convex/ariConfig.ts
autonomous: true

must_haves:
  truths:
    - "ARI Config API returns 200 OK with valid configuration data"
    - "Your Intern Persona tab loads without 'Failed to load persona settings' error"
    - "Your Intern tabs can save configuration changes successfully"
  artifacts:
    - path: "src/app/api/workspaces/[id]/ari-config/route.ts"
      provides: "API endpoint for ARI configuration GET/PATCH"
      exports: ["GET", "PATCH"]
    - path: "convex/ariConfig.ts"
      provides: "Database queries/mutations for ARI configuration"
      exports: ["get", "update", "create"]
  key_links:
    - from: "src/app/(dashboard)/[workspace]/your-intern/page.tsx"
      to: "/api/workspaces/[id]/ari-config"
      via: "fetch in useEffect"
      pattern: "fetch.*ari-config"
    - from: "src/app/api/workspaces/[id]/ari-config/route.ts"
      to: "convex/ariConfig"
      via: "Convex query/mutation calls"
      pattern: "api\\.ariConfig\\.(get|update|create)"
---

<objective>
Fix ARI Config API 500 error and restore complete Your Intern functionality (Issues #1, #2, #7).

Purpose: ARI Config API is the root cause blocking all Your Intern configuration features. The API returns 500 errors, preventing persona settings from loading and configuration saves from persisting. This blocks bot personality configuration which is critical for Phase 3 (Live Bot Integration).

Output: Working ARI Config API endpoint returning 200 OK, Your Intern tabs loading configuration successfully, all 5 tabs functional for save operations.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# ARI Config API files
@/home/jfransisco/Desktop/21/my21staff/src/app/api/workspaces/[id]/ari-config/route.ts
@/home/jfransisco/Desktop/21/my21staff/convex/ariConfig.ts
@/home/jfransisco/Desktop/21/my21staff/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate ARI Config API 500 error</name>
  <files>
    src/app/api/workspaces/[id]/ari-config/route.ts
    convex/ariConfig.ts
  </files>
  <action>
Read browser DevTools Network tab error response from production (https://www.my21staff.com/api/workspaces/[id]/ari-config).

Read the API route file and Convex query to identify the root cause:
- Check if Convex query exists and is properly exported
- Check if authentication/authorization is failing
- Check if workspace ID validation is failing
- Check for missing error handling causing unhandled exceptions
- Check for incorrect Convex function references

Common causes to investigate:
1. Missing or incorrectly named Convex function (ariConfig.get doesn't exist)
2. Auth token not being passed to Convex query
3. Workspace ID not being properly extracted from URL params
4. Missing try/catch causing unhandled promise rejections
5. Incorrect Convex client initialization

Document findings in code comments.
  </action>
  <verify>
Read error logs from Vercel deployment or browser console showing specific error message and stack trace.
  </verify>
  <done>
Root cause identified and documented with specific line numbers and error messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix ARI Config API endpoint</name>
  <files>
    src/app/api/workspaces/[id]/ari-config/route.ts
    convex/ariConfig.ts
  </files>
  <action>
Based on findings from Task 1, apply the appropriate fix:

**If Convex function is missing:**
- Add proper ariConfig.get/update/create exports to convex/ariConfig.ts
- Ensure functions accept workspaceId parameter
- Return proper default configuration if none exists

**If auth is failing:**
- Ensure Clerk auth().userId is being passed to Convex client
- Add proper workspace membership validation
- Include organizationId in Convex query context

**If parameter extraction is broken:**
- Fix params.id extraction from Next.js route parameters
- Ensure workspace ID is being validated before Convex calls
- Add proper error handling for missing/invalid IDs

**If error handling is missing:**
- Wrap all Convex calls in try/catch blocks
- Return proper 500 responses with error messages
- Log errors for debugging

**General fixes to apply:**
- Ensure GET endpoint returns valid JSON structure matching Your Intern frontend expectations
- Ensure PATCH endpoint validates input before saving
- Add proper TypeScript types for request/response
- Test endpoint returns 200 OK with valid configuration data

Reference working patterns from other API routes (e.g., /api/contacts/route.ts) for Convex client usage.
  </action>
  <verify>
Run locally: `npm run dev`, visit http://localhost:3000/demo/your-intern, check browser console shows no API errors and Persona tab loads successfully.

Deploy to production: `git push origin master`, visit https://www.my21staff.com/eagle-overseas/your-intern, verify all 5 tabs load without errors.
  </verify>
  <done>
ARI Config API returns 200 OK at https://www.my21staff.com/api/workspaces/[id]/ari-config, Your Intern tabs load successfully, no "Failed to load persona settings" errors in console.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Your Intern configuration save functionality</name>
  <files>
    src/app/api/workspaces/[id]/ari-config/route.ts
  </files>
  <action>
Test the complete Your Intern configuration flow at https://www.my21staff.com:

1. Open Your Intern > Persona tab
2. Verify settings load without errors
3. Make a change to persona name or description
4. Click save
5. Verify toast notification shows "Configuration saved successfully"
6. Reload page
7. Verify changes persisted

Repeat for Flow, Scoring, and Slots tabs.

If save operations fail:
- Check PATCH endpoint implementation
- Verify mutation calls in convex/ariConfig.ts
- Ensure proper request body parsing
- Add error logging to identify failure points

Fix any issues found and re-test until all tabs can save successfully.
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas/your-intern:
1. Persona tab: Change name to "Test Persona", save, reload - name persists
2. Flow tab: Toggle global AI on/off, save, reload - toggle state persists
3. Scoring tab: Adjust scoring weights, save, reload - weights persist
4. Slots tab: Add/edit consultation slot, save, reload - slot persists

All operations complete without errors, toast notifications confirm saves.
  </verify>
  <done>
Your Intern configuration saves work end-to-end for all 5 tabs (Persona, Flow, Database, Scoring, Slots). Changes persist across page reloads. Issues #1, #2, #7 resolved.
  </done>
</task>

</tasks>

<verification>
**API Health Check:**
- GET https://www.my21staff.com/api/workspaces/org_38fXP0PN0rgNQ2coi1KsqozLJYb/ari-config returns 200 OK
- Response contains valid JSON with persona, flow, scoring, and slots configuration
- No 500 errors in Network tab

**Your Intern UI:**
- Visit https://www.my21staff.com/eagle-overseas/your-intern
- All 5 tabs load without "Failed to load" errors
- Persona settings display correctly
- Can edit and save configuration across all tabs
- Changes persist after page reload

**Root Cause Verification:**
- Issues #2 and #7 (caused by Issue #1) are also resolved
- Your Intern is fully functional in production
</verification>

<success_criteria>
**Must be TRUE:**
1. ARI Config API endpoint returns 200 OK (not 500)
2. Your Intern Persona tab loads without errors
3. All 5 Your Intern tabs functional (Persona, Flow, Database, Scoring, Slots)
4. Configuration saves persist across page reloads
5. No "Failed to load persona settings" errors
6. Issues #1, #2, #7 from verification report are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ui-documentation/2.1-01-SUMMARY.md` following the template structure with:
- Performance metrics (duration, files modified)
- Accomplishments (ARI Config API restored)
- Root cause analysis (what was broken and why)
- Verification results (all 3 issues resolved)
- Impact on downstream plans (unlocks Your Intern for Phase 3)
</output>
