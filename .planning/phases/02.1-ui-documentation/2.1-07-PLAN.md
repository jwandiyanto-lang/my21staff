---
phase: 02.1-ui-documentation
plan: 07
type: execute
wave: 3
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/database/columns.tsx
  - src/app/(dashboard)/[workspace]/database/database-client.tsx
  - convex/contacts.ts
  - convex/workspaces.ts
  - src/components/database/add-contact-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Database table displays Tags column showing contact tags"
    - "User can add new contact via Add Contact button and modal"
    - "New contacts do not auto-tag as 'google-form'"
    - "Status filter settings can be saved and persist"
    - "Status changes apply globally in real-time"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/database/columns.tsx"
      provides: "Table column definitions including Tags column"
      contains: "tags column definition"
    - path: "src/components/database/add-contact-dialog.tsx"
      provides: "Add Contact modal with form"
      contains: "contact creation form"
    - path: "convex/contacts.ts"
      provides: "Create contact mutation without auto-tagging"
      exports: ["create"]
    - path: "convex/workspaces.ts"
      provides: "Workspace settings mutations for status config"
      exports: ["updateSettings"]
  key_links:
    - from: "database-client.tsx Add Contact button"
      to: "add-contact-dialog.tsx"
      via: "dialog state trigger"
      pattern: "setShowAddDialog.*true"
    - from: "add-contact-dialog.tsx form submit"
      to: "convex/contacts.create"
      via: "mutation call"
      pattern: "api\\.contacts\\.create"
---

<objective>
Add Tags column to database table, implement Add Contact feature, fix auto-tagging, and improve status management (Issues #17, #18, #19, #22, #23).

Purpose: Two critical features are missing from the database view (Tags column and Add Contact button), and three bugs affect contact and status management (auto-tagging to "google-form", status filter not saving, status changes not applying globally). These issues reduce database usability and workflow efficiency.

Output: Database table with visible Tags column, functional Add Contact button and modal, correct tag behavior (no auto-tagging), persistent status filter settings, real-time global status updates.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02.1-ui-documentation/02.1-CONTEXT.md

# Database table and contact creation files
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/database/columns.tsx
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/database/database-client.tsx
@/home/jfransisco/Desktop/21/my21staff/convex/contacts.ts
@/home/jfransisco/Desktop/21/my21staff/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Tags column to database table (Issue #22)</name>
  <files>
    src/app/(dashboard)/[workspace]/database/columns.tsx
  </files>
  <action>
Issue #22: Tags exist in data model but aren't displayed in the database table.

**Check current columns:**
Read columns.tsx to see which columns are defined:
- Name, Phone, Email, Status, Lead Score, etc.
- Check if Tags column definition exists but is hidden
- Or if Tags column is completely missing

**Add Tags column:**

1. **Define Tags column in columns.tsx:**
```typescript
{
  accessorKey: "tags",
  header: "Tags",
  cell: ({ row }) => {
    const tags = row.getValue("tags") as string[] | undefined
    if (!tags || tags.length === 0) return <span className="text-muted-foreground">-</span>

    return (
      <div className="flex gap-1 flex-wrap">
        {tags.map(tag => (
          <Badge key={tag} variant="secondary" className="text-xs">
            {tag}
          </Badge>
        ))}
      </div>
    )
  },
  filterFn: (row, id, value) => {
    const tags = row.getValue(id) as string[] | undefined
    if (!tags) return false
    return value.every((tag: string) => tags.includes(tag))
  }
}
```

2. **Ensure column is visible by default:**
Check if columns visibility is controlled by localStorage or state:
- Find `database-visible-columns` setting
- Ensure Tags is included in default visible columns
- Or add Tags to always-visible columns

3. **Position column appropriately:**
Place Tags column logically in table:
- Suggested: After Status or before Lead Score
- Should be visible without horizontal scrolling on desktop

Test locally: `npm run dev`, check http://localhost:3000/demo/database for Tags column
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas/database:
1. Database table loads
2. Tags column visible in header row
3. Contacts with tags show badge UI with tag names
4. Contacts without tags show "-" or empty state
5. Tags column is in visible area (no need to scroll right)
6. Column toggle menu shows Tags as visible

Issue #22 resolved: Tags column displays in database table.
  </verify>
  <done>
Tags column added to database table and visible by default. Tags display as badges with proper styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Add Contact button and modal (Issue #23)</name>
  <files>
    src/app/(dashboard)/[workspace]/database/database-client.tsx
    src/components/database/add-contact-dialog.tsx
    convex/contacts.ts
  </files>
  <action>
Issue #23: No Add Contact button or modal in database view. Users must use API or import to create contacts.

**Implementation steps:**

1. **Add "+ Add Contact" button to database toolbar:**
In database-client.tsx, find toolbar section (likely near filters):
```typescript
<Button onClick={() => setShowAddDialog(true)}>
  <Plus className="h-4 w-4 mr-2" />
  Add Contact
</Button>
```

2. **Create Add Contact dialog component:**
Create `src/components/database/add-contact-dialog.tsx`:
```typescript
export function AddContactDialog({
  open,
  onOpenChange,
  workspaceId
}: Props) {
  const [name, setName] = useState("")
  const [phone, setPhone] = useState("")
  const [email, setEmail] = useState("")
  const [status, setStatus] = useState("new")

  const createContact = useMutation(api.contacts.create)

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault()

    await createContact({
      workspaceId,
      name,
      phone,
      email,
      status,
      tags: [], // Empty by default (Issue #17 fix)
    })

    toast.success("Contact created successfully")
    onOpenChange(false)
    // Reset form
    setName("")
    setPhone("")
    setEmail("")
    setStatus("new")
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Add New Contact</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit}>
          <div className="space-y-4">
            <Input
              label="Name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
            />
            <Input
              label="Phone"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              placeholder="+62812..."
              required
            />
            <Input
              label="Email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
            <Select value={status} onValueChange={setStatus}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="new">New</SelectItem>
                <SelectItem value="hot">Hot</SelectItem>
                <SelectItem value="warm">Warm</SelectItem>
                <SelectItem value="cold">Cold</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <DialogFooter>
            <Button type="submit">Create Contact</Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

3. **Ensure Convex mutation exists:**
Check convex/contacts.ts for `create` mutation:
- Should accept workspaceId, name, phone, email, status, tags
- Should NOT auto-tag with "google-form" (Issue #17 fix)
- Should initialize with empty tags array if not provided
- Should set default leadScore, metadata, etc.

Test locally: `npm run dev`, test Add Contact at http://localhost:3000/demo/database
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas/database:
1. "+ Add Contact" button visible in toolbar
2. Click button - modal opens
3. Fill form: name, phone, email, status
4. Click Create - success toast appears
5. Modal closes, contact appears in table
6. Open contact detail - all fields saved correctly
7. Check tags - should be empty (not "google-form")

Issue #23 resolved: Add Contact feature works end-to-end.
  </verify>
  <done>
Add Contact button and modal implemented. Users can create contacts via UI with proper form validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix auto-tagging, status filter persistence, and global status sync (Issues #17, #18, #19)</name>
  <files>
    convex/contacts.ts
    src/app/(dashboard)/[workspace]/settings/settings-client.tsx
    convex/workspaces.ts
  </files>
  <action>
Three related issues to fix:

**Issue #17: Tags auto-assigned to "google-form"**
New contacts automatically tagged incorrectly.

Find where contacts are created (Convex create mutation):
- Check if default tags include "google-form"
- Remove auto-tagging logic or set default to empty array
- Only tag "google-form" for contacts actually from Google Forms
- Check webhook handlers (e.g., n8n integration) for auto-tagging

Fix:
```typescript
// convex/contacts.ts create mutation
export const create = mutation({
  handler: async (ctx, args) => {
    // ...
    await ctx.db.insert("contacts", {
      ...args,
      tags: args.tags || [], // Empty by default, not ["google-form"]
      // ...
    })
  }
})
```

**Issue #18: Status filter no save button**
Filter settings can't be persisted, lost on reload.

This refers to Settings > Status Management (customization of status options):
- Find status configuration UI in Settings
- Add save button for status filter preferences
- Save to workspace settings in Convex
- Load on mount to restore user preferences

Implementation:
1. Add state for status filter preferences
2. Add save button to persist to workspace settings
3. Load preferences from workspace settings on mount
4. Apply preferences to status filter dropdown

**Issue #19: Status changes don't auto-apply globally**
Status customization requires manual refresh for real-time sync.

This likely refers to customizing status labels/colors in Settings:
- When user changes status configuration, should update everywhere
- Use Convex real-time subscriptions to broadcast changes
- Update status displays in Dashboard, Database, Inbox immediately
- No page reload required

Fix approach:
1. Settings saves status config to workspace settings
2. All components subscribe to workspace settings query
3. When settings change, all components re-render with new status config
4. Use Convex `useQuery(api.workspaces.getSettings)` across components

Test all three fixes together:
1. Create new contact - verify no "google-form" tag
2. Customize status filter in Settings - verify save button works
3. Change status labels in Settings - verify updates globally without refresh
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas:

**Auto-tagging (Issue #17):**
- Settings > Add new contact
- Check tags field - empty (not pre-filled with "google-form")
- Create contact
- Verify tags array is empty in database

**Status filter persistence (Issue #18):**
- Settings > Status Management
- Customize status filter preferences
- Click save button - success toast
- Reload page - preferences still applied

**Global status sync (Issue #19):**
- Settings > Status Management
- Change a status label (e.g., "New" â†’ "Fresh Lead")
- Without reloading, check Dashboard - label updated
- Check Database status dropdown - label updated
- Check Inbox status filter - label updated
- All updates happen in real-time

Issues #17, #18, #19 resolved.
  </verify>
  <done>
Auto-tagging disabled (contacts start with empty tags). Status filter settings save and persist. Status changes apply globally in real-time via Convex subscriptions.
  </done>
</task>

</tasks>

<verification>
**Tags Column (Issue #22):**
- Database table shows Tags column
- Tags display as badges for contacts with tags
- Empty state for contacts without tags
- Column visible without scrolling

**Add Contact (Issue #23):**
- "+ Add Contact" button in database toolbar
- Click opens modal with form
- Fill and submit creates contact
- Contact appears in table immediately

**Auto-Tagging (Issue #17):**
- New contacts have empty tags (not "google-form")
- Only Google Form submissions get that tag

**Status Filter Persistence (Issue #18):**
- Status filter settings can be saved
- Settings persist across page reloads

**Global Status Sync (Issue #19):**
- Status label changes update everywhere instantly
- No page reload required

**Overall:**
All 5 database and settings issues resolved. Missing features added, bugs fixed.
</verification>

<success_criteria>
**Must be TRUE:**
1. Database table displays Tags column with badge UI
2. Add Contact button exists and opens functional modal
3. New contacts created with empty tags (not auto-tagged)
4. Status filter settings have save button and persist
5. Status customization applies globally in real-time
6. All components sync via Convex real-time subscriptions
7. Issues #17, #18, #19, #22, #23 from verification report are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ui-documentation/2.1-07-SUMMARY.md` following the template structure with:
- Performance metrics (duration, files modified)
- Accomplishments (Tags column, Add Contact, 3 bug fixes)
- Technical approach (real-time sync via Convex, localStorage for preferences)
- Verification results (all 5 issues resolved)
- UI/UX improvements (complete database feature set)
</output>
