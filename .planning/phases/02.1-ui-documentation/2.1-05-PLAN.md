---
phase: 02.1-ui-documentation
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - src/app/api/contacts/merge/route.ts
  - convex/contacts.ts
  - src/components/database/lead-score-chat.tsx
autonomous: true

must_haves:
  truths:
    - "Merge contacts operation completes successfully without errors"
    - "Lead score chat component shows real data (not dummy values)"
    - "Form lead score calculation works correctly"
  artifacts:
    - path: "src/app/api/contacts/merge/route.ts"
      provides: "Contact merge endpoint"
      exports: ["POST"]
    - path: "convex/contacts.ts"
      provides: "Merge mutation with conversation/note consolidation"
      exports: ["merge"]
    - path: "src/components/database/lead-score-chat.tsx"
      provides: "Lead score visualization component"
      contains: "score calculation display"
  key_links:
    - from: "src/app/(dashboard)/[workspace]/database/merge-contacts-dialog.tsx"
      to: "/api/contacts/merge"
      via: "fetch POST"
      pattern: "fetch.*contacts/merge"
    - from: "lead-score-chat.tsx"
      to: "contact.leadScore"
      via: "props"
      pattern: "leadScore.*calculation|breakdown"
---

<objective>
Fix merge contacts operation and remove dummy data from lead score chat component (Issues #5, #6).

Purpose: Contact merge fails with errors, blocking the workflow for consolidating duplicate contacts. Additionally, lead score chat component displays hardcoded dummy data instead of real calculated scores, confusing users. Both issues must be fixed for proper contact management and lead qualification.

Output: Working contact merge operation that consolidates conversations and notes, lead score chat showing accurate real-time data matching form calculations.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02.1-ui-documentation/02.1-CONTEXT.md

# Merge and lead score files
@/home/jfransisco/Desktop/21/my21staff/src/app/api/contacts/merge/route.ts
@/home/jfransisco/Desktop/21/my21staff/convex/contacts.ts
@/home/jfransisco/Desktop/21/my21staff/src/components/database/lead-score-chat.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate and fix merge contacts failure</name>
  <files>
    src/app/api/contacts/merge/route.ts
    convex/contacts.ts
  </files>
  <action>
Test merge operation at https://www.my21staff.com/eagle-overseas/database:

1. Click "Merge Duplicates" button (enters merge mode)
2. Select 2 contacts to merge
3. Click "Merge Selected (2)"
4. In merge dialog, select values for each field
5. Click "Merge Contacts"
6. Check Network tab for error response

Capture error details:
- HTTP status code and error message
- Request payload structure
- Which Convex mutation is being called
- Any validation errors or permission issues

Read the merge endpoint and Convex mutation:

**Check /api/contacts/merge/route.ts:**
- Is POST handler implemented correctly?
- Is request body being validated?
- Are primaryId and secondaryId being extracted?
- Is field selection data being parsed correctly?
- Is Convex mutation being called with correct arguments?

**Check convex/contacts.ts merge mutation:**
- Does merge mutation exist and is it exported?
- Does it properly merge contact fields based on selection?
- Does it handle tags union (combine tags from both contacts)?
- Does it handle metadata deep merge?
- Does it transfer conversations to primary contact?
- Does it transfer notes to primary contact?
- Does it delete secondary contact after transfer?
- Does it use transactions (ctx.db.transaction) to ensure atomicity?

**Common issues to fix:**
1. Missing merge mutation in Convex
2. Incorrect field selection logic
3. Not transferring conversations/notes before deleting secondary
4. Not using transactions (partial merge leaves orphaned data)
5. Permission checks failing incorrectly
6. Tags not being merged (should be union, not replacement)
7. Metadata not being deep merged (nested objects lost)

**Correct merge flow:**
```typescript
// 1. Validate both contacts exist and belong to workspace
// 2. Build merged contact data based on field selections
// 3. For tags: union of both arrays
// 4. For metadata: deep merge nested objects
// 5. Start transaction:
//    a. Update conversations (set contactId to primary)
//    b. Update notes (set contactId to primary)
//    c. Update primary contact with merged data
//    d. Delete secondary contact
// 6. Return merged contact
```
  </action>
  <verify>
Test locally first at http://localhost:3000/demo/database:
1. Create 2 test contacts with different data
2. Enter merge mode, select both
3. Merge, choosing mix of fields from each
4. Verify merged contact has correct selected values
5. Verify tags are union of both
6. Verify conversations/notes transferred
7. Verify secondary contact deleted

Check console for no errors, merge completes successfully.
  </verify>
  <done>
Merge contacts logic implemented correctly with proper transaction handling, conversation/note transfer, and field selection. Ready for production testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and verify merge in production</name>
  <files>
    src/app/api/contacts/merge/route.ts
    convex/contacts.ts
  </files>
  <action>
Deploy merge fixes to production:

```bash
git add src/app/api/contacts/merge/route.ts convex/contacts.ts
git commit -m "fix(database): implement contact merge with transaction handling

- Add merge mutation to Convex with proper field selection
- Transfer conversations and notes to primary contact
- Merge tags (union) and metadata (deep merge)
- Use transaction to ensure atomicity
- Delete secondary contact after successful transfer

Fixes Issue #5 (merge contacts fails with error)"
git push origin master
```

Wait for Vercel deployment to complete (check https://vercel.com/deployments).

Test at https://www.my21staff.com/eagle-overseas/database:
1. Identify 2 contacts to merge (or create test contacts)
2. Enter merge mode
3. Select both contacts
4. Open merge dialog
5. Select fields from each contact
6. Click "Merge Contacts"
7. Verify success toast appears
8. Verify merged contact appears with correct data
9. Verify secondary contact removed from list
10. Open merged contact detail sheet
11. Verify conversations transferred correctly
12. Verify notes transferred correctly
13. Verify tags are union of both
14. Verify all selected field values are correct

If any issues, check Vercel logs for errors and fix accordingly.
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas/database:
- Merge 2 contacts successfully
- POST /api/contacts/merge returns 200 OK
- Merged contact has correct field values
- Tags are union of both contacts
- Conversations transferred to primary
- Notes transferred to primary
- Secondary contact deleted
- No orphaned data remains

Issue #5 resolved: Merge contacts works without errors.
  </verify>
  <done>
Contact merge operation works in production. Users can consolidate duplicates successfully with proper data transfer.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove dummy data from lead score chat component</name>
  <files>
    src/components/database/lead-score-chat.tsx
  </files>
  <action>
Issue #6: Lead score chat component shows dummy/hardcoded data instead of real calculated scores.

**Investigation:**
Read lead-score-chat.tsx to find dummy data:
- Look for hardcoded score values (e.g., `score: 75`, `breakdown: { basic: 20, ... }`)
- Check if component is receiving real props but ignoring them
- Verify component is using contact.leadScore data from props

**Expected behavior:**
- Component should receive contact with leadScore data
- leadScore should have overall score (0-100) and breakdown by category
- Categories: basic, qualification, documents, engagement
- Display should match form lead score calculations exactly

**Fix approach:**

1. **Remove hardcoded data:**
```typescript
// BAD (hardcoded dummy data)
const dummyScore = {
  overall: 75,
  breakdown: { basic: 20, qualification: 30, documents: 15, engagement: 10 }
}

// GOOD (use real data from props)
const { leadScore } = contact
```

2. **Display real score breakdown:**
- Show overall score prominently (large number, 0-100)
- Show category breakdown with percentages or bar chart
- Match the scoring logic from v2.2 (documented in prior phases)

3. **Handle missing data gracefully:**
```typescript
if (!leadScore || !leadScore.breakdown) {
  return <div>Lead score not calculated yet</div>
}
```

4. **Ensure visual consistency:**
- Chat component score should match form component score EXACTLY
- Same number, same breakdown values
- If they differ, there's a data sync issue to fix

Test locally: `npm run dev`, check lead score display at http://localhost:3000/demo/database (open contact detail, view lead score)
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas/database:
1. Open contact detail sheet
2. Check lead score chat component
3. Verify score shows real calculated value (not 75 or other dummy value)
4. Verify breakdown shows real category scores
5. Compare to form lead score - values match exactly
6. Test with multiple contacts - each shows unique real score

No dummy data visible, all scores are real and accurate.
  </verify>
  <done>
Lead score chat component displays real calculated scores matching form component. Dummy data removed. Issue #6 resolved.
  </done>
</task>

</tasks>

<verification>
**Merge Contacts (Issue #5):**
- Visit https://www.my21staff.com/eagle-overseas/database
- Merge 2 contacts successfully
- Verify data consolidation (tags union, conversations/notes transferred)
- Verify secondary contact deleted
- No errors in console or Network tab

**Lead Score Chat (Issue #6):**
- Open contact detail sheet
- Lead score chat shows real calculated scores
- Scores match form component exactly
- No dummy data (e.g., hardcoded 75) visible
- Breakdown by category accurate

**Overall:**
Contact management workflows complete and data display accurate.
</verification>

<success_criteria>
**Must be TRUE:**
1. Merge contacts operation completes without errors
2. Merged contact has correct selected field values
3. Tags are union of both source contacts
4. Conversations and notes transferred to primary contact
5. Secondary contact deleted after merge
6. Lead score chat shows real calculated data (not dummy values)
7. Lead score chat matches form lead score exactly
8. Issues #5 and #6 from verification report are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ui-documentation/2.1-05-SUMMARY.md` following the template structure with:
- Performance metrics (duration, files modified)
- Accomplishments (merge working, dummy data removed)
- Technical details (transaction handling, data transfer logic)
- Verification results (both issues resolved)
- Data integrity notes (tags union, metadata merge, conversation transfer)
</output>
