---
phase: 06-kapso-live
plan: 01
type: execute
---

<objective>
Create Kapso webhook endpoint to receive incoming WhatsApp messages and save to database.

Purpose: Enable real-time message reception — when someone sends a WhatsApp message, it appears in the inbox.
Output: Working POST /api/webhook/kapso endpoint that saves inbound messages to Supabase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-kapso-live/06-CONTEXT.md
@.planning/phases/06-kapso-live/06-RESEARCH.md
@.planning/phases/04-inbox-send/04-01-SUMMARY.md

# Relevant source files:
@src/lib/supabase/server.ts
@src/lib/kapso/client.ts
@src/app/api/messages/send/route.ts
@src/middleware.ts

# V1 reference (webhook handler to port):
@~/Desktop/21/my21staff/src/app/api/webhook/kapso/route.ts

**Tech stack available:**
- Supabase admin client (createAdminClient) for bypassing RLS
- Kapso client already exists
- Middleware already allows /api/webhook routes (publicRoutes)

**Established patterns:**
- Dev mode bypass with NEXT_PUBLIC_DEV_MODE
- Separate queries instead of joins for TypeScript inference
- Conversation metadata update (last_message_at, last_message_preview)

**Constraining decisions:**
- Phase 4: Messages use kapso_message_id for deduplication
- Phase 4: Optimistic UI updates via metadata.status field
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Kapso webhook handler (POST + GET)</name>
  <files>src/app/api/webhook/kapso/route.ts</files>
  <action>
Port v1 webhook handler to v2 with these changes:
1. Use createAdminClient() from @/lib/supabase/server (already exists in v2)
2. Remove admin notification logic (not needed for v2 MVP)
3. Keep the same patterns: getOrCreateContact, getOrCreateConversation
4. Include GET handler for webhook verification (hub.challenge response)
5. Add dev mode logging but still process in dev mode (webhook should work locally)

Kapso payload structure (from v1):
- message.id, message.from, message.type, message.text?.body, message.kapso?.content
- conversation.id, conversation.contact_name, conversation.phone_number
- phone_number_id (maps to workspace.kapso_phone_id)

Key implementation details:
- Respond immediately with { received: true } to prevent Kapso retries
- Use workspace lookup by kapso_phone_id (index exists)
- Insert message with direction: 'inbound', sender_type: 'contact'
- Update conversation: last_message_at, last_message_preview, increment unread_count
- Handle duplicate messages gracefully (kapso_message_id may repeat on retry)

Do NOT:
- Add complex error handling (Kapso will retry on failure)
- Add admin notifications (not in v2 scope)
- Add AI/automation triggers (out of scope)
  </action>
  <verify>
1. npm run build succeeds
2. File exists at src/app/api/webhook/kapso/route.ts
3. Both POST and GET handlers exported
  </verify>
  <done>
- Webhook handler accepts Kapso payload structure
- Creates contact if new, gets existing if found
- Creates conversation if new, gets existing if found
- Inserts message to database
- Updates conversation metadata
- GET returns hub.challenge for verification
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Kapso webhook endpoint at /api/webhook/kapso</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Test GET (webhook verification):
   ```
   curl "http://localhost:3000/api/webhook/kapso?hub.challenge=test123"
   ```
   Should return: test123

3. Test POST (message handling) with mock Kapso payload:
   ```
   curl -X POST http://localhost:3000/api/webhook/kapso \
     -H "Content-Type: application/json" \
     -d '{
       "message": {
         "id": "test-msg-001",
         "from": "6281234567890",
         "type": "text",
         "text": { "body": "Hello from webhook test" },
         "timestamp": "1705000000"
       },
       "conversation": {
         "id": "conv-001",
         "contact_name": "Test Contact",
         "phone_number": "6281234567890"
       },
       "phone_number_id": "YOUR_KAPSO_PHONE_ID",
       "is_new_conversation": true
     }'
   ```
   Should return: {"received":true}

4. Check terminal logs for webhook processing output

Note: In dev mode with mock data, workspace lookup will fail (no matching kapso_phone_id).
This is expected — the handler logs the error and returns success to prevent Kapso retries.
  </how-to-verify>
  <resume-signal>Type "approved" if tests pass, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] GET /api/webhook/kapso returns challenge parameter
- [ ] POST /api/webhook/kapso accepts Kapso payload and returns { received: true }
- [ ] Code follows v2 patterns (createAdminClient, separate queries)
</verification>

<success_criteria>
- Webhook endpoint created and functional
- GET handler responds to verification requests
- POST handler processes Kapso message payloads
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-kapso-live/06-01-SUMMARY.md`:

# Phase 6 Plan 1: Kapso Webhook Handler Summary

**[Substantive one-liner]**

## Performance
- Duration: X min
- Tasks: 2 (1 auto + 1 checkpoint)

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `src/app/api/webhook/kapso/route.ts` - Webhook handler

## Decisions Made
[Any decisions during implementation]

## Issues Encountered
[Problems and resolutions]

## Next Phase Readiness
Phase 6 complete — Kapso webhook ready for production deployment.
</output>
