---
phase: 03-convex-spike
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: [convex/migrate.ts, scripts/migrate-convex.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Migration mutations exist for all tables"
    - "Supabase data can be copied to Convex"
    - "supabaseId stored on all Convex records"
    - "Migration script runs without errors"
  artifacts:
    - path: "convex/migrate.ts"
      provides: "Mutation functions for data migration"
      exports: ["migrateWorkspaces", "migrateWorkspaceMembers", "migrateContacts", "migrateConversations", "migrateMessages", "migrateContactNotes"]
    - path: "scripts/migrate-convex.ts"
      provides: "Migration orchestration script"
  key_links:
    - from: "scripts/migrate-convex.ts"
      to: "convex/migrate.ts"
      via: "Convex mutation calls"
      pattern: "mutation.*migrate"
    - from: "scripts/migrate-convex.ts"
      to: "Supabase database"
      via: "@supabase/supabase-js"
      pattern: "supabase.from"
---

<objective>
Create data migration system to copy Supabase data to Convex for performance benchmarking.

Purpose: Populate Convex with real data from Supabase so benchmark comparison is meaningful - comparing performance on actual data vs. empty tables wouldn't be valid.

Output: Working migration script that copies workspaces, contacts, conversations, messages from Supabase to Convex.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-convex-spike/03-RESEARCH.md
@.planning/phases/10-convex-spike/README.md
@convex/schema.ts
@convex/lib/auth.ts

# Reference Supabase schema for table structures
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration mutations in convex/migrate.ts</name>
  <files>convex/migrate.ts</files>
  <action>
    Create convex/migrate.ts with migration mutations:

    1. Import from "./_generated/server" and "convex/values":
       - mutation, v

    2. Export migrateWorkspaces mutation:
       ```
       export const migrateWorkspaces = mutation({
         args: { workspaces: v.array(v.object({
           id: v.string(), // Supabase UUID
           name: v.string(),
           slug: v.string(),
           owner_id: v.string(),
           kapso_phone_id: v.optional(v.string()),
           settings: v.optional(v.any()),
           created_at: v.number(),
           updated_at: v.number(),
         })) },
         handler: async (ctx, args) => {
           const results = [];
           for (const ws of args.workspaces) {
             const id = await ctx.db.insert("workspaces", {
               ...ws,
             });
             results.push({ supabaseId: ws.id, convexId: id });
           }
           return results;
         },
       });
       ```

    3. Export migrateWorkspaceMembers mutation (similar pattern):
       - args: array of { workspace_id, user_id, role, created_at }
       - Insert into workspaceMembers table
       - Note: workspace_id and user_id are strings (Supabase UUIDs), need lookup from Convex ID mapping if needed for foreign keys

    4. Export migrateContacts mutation:
       ```
       export const migrateContacts = mutation({
         args: { contacts: v.array(v.object({
           id: v.string(), // Supabase UUID
           workspace_id: v.id("workspaces"), // Convex workspace ID
           phone: v.string(),
           name: v.optional(v.string()),
           email: v.optional(v.string()),
           lead_score: v.number(),
           lead_status: v.string(),
           tags: v.optional(v.array(v.string())),
           metadata: v.optional(v.any()),
           created_at: v.number(),
           updated_at: v.number(),
         })) },
         handler: async (ctx, args) => {
           const results = [];
           for (const contact of args.contacts) {
             const id = await ctx.db.insert("contacts", {
               ...contact,
               supabaseId: contact.id,
             });
             results.push({ supabaseId: contact.id, convexId: id });
           }
           return results;
         },
       });
       ```

    5. Export migrateConversations mutation:
       - args: array of conversation objects
       - Insert into conversations table with supabaseId

    6. Export migrateMessages mutation:
       - args: array of message objects
       - Insert into messages table with supabaseId

    7. Export migrateContactNotes mutation:
       - args: array of note objects
       - Insert into contactNotes table with supabaseId

    NOTE: All mutations should store the original Supabase UUID in a supabaseId field for reference and potential dual-write later.

    Reference: 03-RESEARCH.md "Pattern 4: Authorization Helper" for mutation structure
    Reference: README.md section on "Migration Mutations"
  </action>
  <verify>
    grep -q "export const migrateWorkspaces = mutation" convex/migrate.ts
    grep -q "export const migrateContacts = mutation" convex/migrate.ts
    grep -q "export const migrateConversations = mutation" convex/migrate.ts
    grep -q "export const migrateMessages = mutation" convex/migrate.ts
  </verify>
  <done>
    migrate.ts exists with all 6 migration mutations (workspaces, workspaceMembers, contacts, conversations, messages, contactNotes)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration orchestration script</name>
  <files>scripts/migrate-convex.ts</files>
  <action>
    Create scripts/migrate-convex.ts:

    1. Import dependencies:
       - @supabase/supabase-js
       - convex/migrate (from ../../convex/migrate.ts)
       - fs, path for file I/O

    2. Read environment variables:
       - NEXT_PUBLIC_SUPABASE_URL
       - SUPABASE_SERVICE_ROLE_KEY
       - NEXT_PUBLIC_CONVEX_URL (if needed for Convex client)

    3. Create Supabase client:
       ```
       const supabase = createClient(
         process.env.NEXT_PUBLIC_SUPABASE_URL!,
         process.env.SUPABASE_SERVICE_ROLE_KEY!
       );
       ```

    4. Fetch data from Supabase in batches:
       - Fetch all workspaces: supabase.from('workspaces').select('*')
       - Fetch all workspace_members: supabase.from('workspace_members').select('*')
       - Fetch all contacts: supabase.from('contacts').select('*')
       - Fetch all conversations: supabase.from('conversations').select('*')
       - Fetch all messages: supabase.from('messages').select('*')
       - Fetch all contact_notes: supabase.from('contact_notes').select('*')

    5. Transform data for Convex:
       - Convert timestamps: new Date(record.created_at).getTime()
       - Map workspace IDs: After migrating workspaces, build a Map<supabaseId, convexId>
       - Use convex workspace IDs for foreign keys in subsequent migrations

    6. Migrate in order (respecting dependencies):
       1. Migrate workspaces first
       2. Migrate workspace_members (using workspace ID mapping)
       3. Migrate contacts (using workspace ID mapping)
       4. Migrate conversations (using contact ID mapping)
       5. Migrate messages (using conversation ID mapping)
       6. Migrate contact_notes (using contact ID mapping)

    7. Call Convex mutations:
       - Use fetch or Convex client to call each mutation
       - Process in batches of 100 to avoid payload size limits
       - Print progress (e.g., "Migrated 50/100 contacts...")

    8. Error handling:
       - Catch and log errors
       - Continue on individual record failures
       - Report summary at end (success/failure counts)

    Reference: README.md section on "Running the Benchmark" > "Migrate Data"
  </action>
  <verify>
    grep -q "createClient" scripts/migrate-convex.ts
    grep -q "migrateWorkspaces" scripts/migrate-convex.ts
    grep -q "migrateContacts" scripts/migrate-convex.ts
  </verify>
  <done>
    migrate-convex.ts script exists, can be run with tsx, migrates all data from Supabase to Convex
  </done>
</task>

</tasks>

<verification>
- convex/migrate.ts exists with 6 migration mutations
- scripts/migrate-convex.ts exists and can be executed
- Migration script reads from Supabase and writes to Convex
- All mutations store supabaseId field
</verification>

<success_criteria>
- Migration mutations exist for all tables (workspaces, workspaceMembers, contacts, conversations, messages, contactNotes)
- Supabase data can be copied to Convex via migration script
- supabaseId stored on all Convex records for reference
- Migration script runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-convex-spike/03-03-SUMMARY.md`
</output>
