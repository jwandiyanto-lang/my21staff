---
phase: 03-convex-spike
plan: 06
type: execute
wave: 5
depends_on: ["03-05"]
files_modified: [.planning/phases/10-convex-spike/03-convex-spike-VERIFICATION.md]
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Convex project initialized and connected to Next.js"
    - "User can authenticate via Supabase and access Convex data (JWT hybrid works)"
    - "/api/contacts/by-phone-convex equivalent in Convex responds with data"
    - "Comparison document exists with P50/P95/P99 for both approaches"
    - "Webhook can be received and processed by Convex HTTP action"
  artifacts:
    - path: ".planning/phases/10-convex-spike/03-convex-spike-VERIFICATION.md"
      provides: "Verification report with benchmark results"
  key_links:
    - from: "benchmark results"
      to: "Phase 4 Decision Gate"
      via: "data-driven decision"
      pattern: "CONV-07.*benchmark"
---

<objective>
Verify Convex spike outcomes and document benchmark results for Phase 4 decision gate.

Purpose: Complete validation of whether Convex offers meaningful performance improvement over optimized Supabase - this is the checkpoint where actual benchmark results are collected and documented before proceeding to decision gate.

Output: Verification report with benchmark comparison and recommendation for Phase 4.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-convex-spike/03-RESEARCH.md
@.planning/phases/10-convex-spike/README.md
@convex/schema.ts
@convex/contacts.ts
@convex/http/contacts.ts

# Reference Phase 2 verification for format
@.planning/phases/02-supabase-optimization/02-supabase-optimization-VERIFICATION.md

# Reference benchmark scripts
@scripts/benchmark.ts
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Convex spike: schema, auth helpers, queries, HTTP actions, migration, benchmark script</what-built>
  <how-to-verify>
    **Step 1: Run Migration (if not already done)**
    ```bash
    tsx scripts/migrate-convex.ts
    ```
    Expected: Data copied from Supabase to Convex without errors

    **Step 2: Run Benchmark**
    ```bash
    # Start Next.js dev server first
    npm run dev

    # In another terminal:
    tsx scripts/benchmark.ts
    ```
    Expected:
    - 50 Supabase queries completed with timings
    - 50 Convex queries completed with timings
    - P50/P95/P99 statistics calculated
    - Comparison output shows speed improvement

    **Step 3: Test HTTP Endpoint**
    ```bash
    # Test via curl:
    curl -X GET "http://localhost:3000/api/contacts/by-phone-convex?phone=6281234567890&workspace_id=25de3c4e-b9ca-4aff-9639-b35668f0a48e" \
      -H "x-api-key: YOUR_CRM_API_KEY"
    ```
    Expected: JSON response with contact context (same structure as Supabase version)

    **Step 4: Test Real-time Subscription (optional)**
    Open convex-test.html in browser:
    1. Enter CRM_API_KEY
    2. Click "Run Test"
    Expected: Response time displayed, contact lookup works

    **Step 5: Review Benchmark Results**
    Look at benchmark output:
    - Supabase P95 should be < 1000ms (after Phase 2 optimizations)
    - Convex P95 target: < 500ms
    - If Convex is at least 50% faster: Convex wins
    - If difference < 20%: Optimize Supabase instead
  </how-to-verify>
  <resume-signal>Type "approved" with benchmark results or describe issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create verification report document</name>
  <files>.planning/phases/10-convex-spike/03-convex-spike-VERIFICATION.md</files>
  <action>
    Create .planning/phases/10-convex-spike/03-convex-spike-VERIFICATION.md:

    Structure similar to 02-supabase-optimization-VERIFICATION.md:

    1. Frontmatter:
       ```
       ---
       phase: 03-convex-spike
       verified: [DATE]
       status: passed|human_needed
       score: [X]/5 must-haves verified
       gaps: []
       ---
       ```

    2. Goal Achievement section:
       - Observable truths table (CONV-01 through CONV-08)
       - Required artifacts table
       - Key link verification

    3. Requirements Coverage table:
       Map each requirement (CONV-01 to CONV-08) to verification status

    4. Benchmark Results section:
       - P50/P95/P99 for Supabase
       - P50/P95/P99 for Convex
       - Speed improvement percentage
       - Real-time subscription latency (if tested)

    5. Conclusion:
       - "Convex wins" OR "Supabase optimization sufficient" based on criteria:
         * Convex P95 < 500ms AND at least 50% faster than Supabase: Convex wins
         * Otherwise: Optimize Supabase instead

    6. Next steps for Phase 4:
       - Decision document template
       - What to implement based on outcome

    Reference: 02-supabase-optimization-VERIFICATION.md for format
  </action>
  <verify>
    File exists with frontmatter containing phase, verified date, status, score
  </verify>
  <done>
    VERIFICATION.md created with benchmark results and recommendation for Phase 4
  </done>
</task>

</tasks>

<verification>
- Verification report exists with benchmark results
- All artifacts from previous plans are listed and verified
- Requirements coverage table shows CONV-01 through CONV-08 status
- Conclusion section provides recommendation for Phase 4
</verification>

<success_criteria>
- Convex project initialized and connected to Next.js app
- User can authenticate via Supabase and access Convex data (JWT hybrid works)
- /api/contacts/by-phone-convex equivalent in Convex responds in <500ms P95
- Kapso webhook can be received and processed by Convex HTTP action
- Comparison document exists with side-by-side P50/P95/P99 for both approaches
</success_criteria>

<output>
After completion, create `.planning/phases/10-convex-spike/03-06-SUMMARY.md`
</output>
