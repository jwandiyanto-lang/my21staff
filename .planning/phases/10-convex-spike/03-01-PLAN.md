---
phase: 03-convex-spike
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/schema.ts, convex/auth.config.ts, convex/_generated.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Convex project initialized and connected to Next.js"
    - "Schema defines workspaces, workspaceMembers, contacts, conversations, messages tables"
    - "Supabase JWT provider configured for auth"
    - "Types generated from schema successfully"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Database schema definition"
      min_lines: 80
    - path: "convex/auth.config.ts"
      provides: "Supabase JWT provider configuration"
      exports: ["AuthConfig"]
    - path: "convex/_generated/server.d.ts"
      provides: "Generated TypeScript types"
  key_links:
    - from: "convex/auth.config.ts"
      to: "https://[SUPABASE-PROJECT].supabase.co/.well-known/jwks.json"
      via: "jwks endpoint for JWT verification"
      pattern: "jwks.*supabase"
    - from: "convex/schema.ts"
      to: "convex/_generated/server.d.ts"
      via: "Convex CLI type generation"
      pattern: "npx convex dev"
---

<objective>
Initialize Convex project with Next.js 15 App Router integration and configure Supabase JWT hybrid auth.

Purpose: Create the foundation for the Convex spike - a working Convex backend that accepts Supabase JWTs for authentication, with schema matching the core Supabase tables needed for performance comparison.

Output: Working Convex deployment with schema types generated and JWT authentication configured.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-convex-spike/03-RESEARCH.md
@.planning/phases/10-convex-spike/README.md
@package.json
@supabase/schema.sql

# Reference Supabase schema for matching table structures
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Convex schema matching core Supabase tables</name>
  <files>convex/schema.ts</files>
  <action>
    Create convex/schema.ts with the following structure:

    1. Import from convex/server and convex/values:
       - defineSchema, defineTable
       - v (validators: string, number, optional, id, array, any)

    2. Define tables matching Supabase schema (from supabase/schema.sql):

       **workspaces table:**
       - id: v.id("workspaces") (auto-generated)
       - name: v.string()
       - slug: v.string()
       - owner_id: v.string() (Supabase user UUID)
       - kapso_phone_id: v.optional(v.string())
       - settings: v.optional(v.any())
       - created_at: v.number() (store as timestamp)
       - updated_at: v.number()

       **workspaceMembers table:**
       - id: v.id("workspaceMembers") (auto-generated)
       - workspace_id: v.id("workspaces")
       - user_id: v.string() (Supabase user UUID)
       - role: v.string() (owner/admin/member)
       - created_at: v.number()

       **contacts table:**
       - id: v.id("contacts") (auto-generated)
       - workspace_id: v.id("workspaces")
       - phone: v.string()
       - name: v.optional(v.string())
       - email: v.optional(v.string())
       - lead_score: v.number()
       - lead_status: v.string()
       - tags: v.optional(v.array(v.string()))
       - metadata: v.optional(v.any())
       - created_at: v.number()
       - updated_at: v.number()
       - supabaseId: v.string() (for migration reference)

       **conversations table:**
       - id: v.id("conversations") (auto-generated)
       - workspace_id: v.id("workspaces")
       - contact_id: v.id("contacts")
       - status: v.string()
       - assigned_to: v.optional(v.string()) (Supabase user UUID)
       - unread_count: v.number()
       - last_message_at: v.optional(v.number())
       - last_message_preview: v.optional(v.string())
       - created_at: v.number()
       - updated_at: v.number()
       - supabaseId: v.string()

       **messages table:**
       - id: v.id("messages") (auto-generated)
       - conversation_id: v.id("conversations")
       - workspace_id: v.id("workspaces")
       - direction: v.string() (inbound/outbound)
       - sender_type: v.string() (contact/user/bot)
       - sender_id: v.optional(v.string())
       - content: v.optional(v.string())
       - message_type: v.string()
       - media_url: v.optional(v.string())
       - kapso_message_id: v.optional(v.string())
       - metadata: v.optional(v.any())
       - created_at: v.number()
       - supabaseId: v.string()

       **contactNotes table:**
       - id: v.id("contactNotes") (auto-generated)
       - workspace_id: v.id("workspaces")
       - contact_id: v.id("contacts")
       - user_id: v.string()
       - content: v.string()
       - created_at: v.number()
       - supabaseId: v.string()

    3. Define indexes for hot paths (matching Supabase composite indexes):

       For workspaces:
       - .index("by_slug", ["slug"])

       For workspaceMembers:
       - .index("by_user_workspace", ["user_id", "workspace_id"])
       - .index("by_workspace", ["workspace_id"])

       For contacts:
       - .index("by_workspace_phone", ["workspace_id", "phone"])
       - .index("by_workspace", ["workspace_id"])

       For conversations:
       - .index("by_workspace_time", ["workspace_id", "last_message_at"])
       - .index("by_contact", ["contact_id"])
       - .index("by_workspace", ["workspace_id"])

       For messages:
       - .index("by_conversation_time", ["conversation_id", "created_at"])
       - .index("by_workspace", ["workspace_id"])

       For contactNotes:
       - .index("by_contact", ["contact_id"])
       - .index("by_workspace", ["workspace_id"])

    4. Export default defineSchema with all tables

    DO NOT use search indexes in this phase (keep simple, focus on performance comparison)
  </action>
  <verify>
    npx convex dev --help (verify Convex CLI available)
    Then: npx convex dev --once
    Verify: convex/_generated/server.d.ts file created with all table types
  </verify>
  <done>
    Schema file exists with 6 tables (workspaces, workspaceMembers, contacts, conversations, messages, contactNotes), all indexes defined, types generated successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Supabase JWT provider in auth.config.ts</name>
  <files>convex/auth.config.ts</files>
  <action>
    Create convex/auth.config.ts:

    1. Import AuthConfig from "convex/server"

    2. Export default AuthConfig object with providers array:

    providers: [
      {
        type: "customJwt",
        // Extract project name from NEXT_PUBLIC_SUPABASE_URL
        // URL format: https://[PROJECT-REF].supabase.co
        applicationID: process.env.NEXT_PUBLIC_SUPABASE_URL?.split("//")[1]?.split(".")[0] || "",
        issuer: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/auth/v1`,
        jwks: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/.well-known/jwks.json`,
        algorithm: "RS256",
      },
    ]

    Reference: 03-RESEARCH.md "Pattern 2: Custom JWT Auth Configuration"

    This configures Convex to:
    - Accept Supabase JWTs via x-auth-token header
    - Verify JWT signatures using Supabase's JWKS endpoint
    - Extract user claims from Supabase tokens
  </action>
  <verify>
    Check file exists with correct structure:
    grep -q "type: 'customJwt'" convex/auth.config.ts
    grep -q "jwks:.*supabase.*jwks.json" convex/auth.config.ts
  </verify>
  <done>
    auth.config.ts created with Supabase customJwt provider, JWKS endpoint configured
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize Convex project and generate types</name>
  <files>convex/_generated</files>
  <action>
    Initialize Convex development environment:

    1. Create Convex project (if not exists):
       npx convex dev --once

    2. This will:
       - Prompt to create new Convex project if needed
       - Deploy schema to Convex development backend
       - Generate TypeScript types in convex/_generated/

    3. Verify NEXT_PUBLIC_SUPABASE_URL is set in .env.local:
       If not set, add placeholder or exit with error message

    4. Run schema sync:
       npx convex dev --once --schema-only

    Accept default project name if prompted (something like "my21staff-convex-spike")
  </action>
  <verify>
    ls convex/_generated/server.d.ts (should exist)
    grep -q "export type Tables" convex/_generated/server.d.ts
    grep -q "export type Document" convex/_generated/server.d.ts
  </verify>
  <done>
    Convex project created, schema deployed, TypeScript types generated in convex/_generated/
  </done>
</task>

</tasks>

<verification>
- convex/schema.ts exists with 6 tables and all indexes defined
- convex/auth.config.ts exists with Supabase JWT provider configured
- convex/_generated/server.d.ts exists with generated types
- `npx convex dev` runs without errors
</verification>

<success_criteria>
- Convex project initialized and connected to Next.js app
- Schema defines workspaces, workspaceMembers, contacts, conversations, messages, contactNotes tables
- Supabase JWT provider configured for auth
- Types generated from schema successfully
</success_criteria>

<output>
After completion, create `.planning/phases/10-convex-spike/03-01-SUMMARY.md`
</output>
