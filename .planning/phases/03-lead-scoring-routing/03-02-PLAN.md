---
phase: 03-lead-scoring-routing
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/ari/processor.ts
  - src/lib/ari/routing.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Score is calculated after qualification is complete"
    - "Score and temperature are saved to ari_conversations table"
    - "Score is synced to contacts.lead_score"
    - "Lead status auto-updates based on temperature"
  artifacts:
    - path: "src/lib/ari/routing.ts"
      provides: "Routing decision logic and actions"
      exports: ["determineRouting", "RoutingDecision"]
    - path: "src/lib/ari/processor.ts"
      provides: "Score calculation integrated into message processing"
  key_links:
    - from: "src/lib/ari/processor.ts"
      to: "src/lib/ari/scoring.ts"
      via: "calculateLeadScore import"
      pattern: "import.*calculateLeadScore.*from"
    - from: "src/lib/ari/processor.ts"
      to: "ari_conversations"
      via: "Supabase update with lead_score"
      pattern: "update.*lead_score"
---

<objective>
Integrate scoring into the ARI processor and create routing logic that determines next actions based on score thresholds.

Purpose: Score leads during conversation and route them appropriately
Output: Processor calculates score, routing module determines actions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lead-scoring-routing/03-CONTEXT.md
@.planning/phases/03-lead-scoring-routing/03-01-SUMMARY.md
@src/lib/ari/processor.ts
@src/lib/ari/state-machine.ts
@src/lib/ari/qualification.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create routing decision module</name>
  <files>src/lib/ari/routing.ts</files>
  <action>
Create routing.ts with routing logic:

```typescript
import type { LeadTemperature } from './types';
import type { DocumentStatus } from './qualification';
import { hasAllRequiredFields, allDocumentsAsked } from './qualification';

export type RoutingAction =
  | 'continue_qualifying'  // Need more info
  | 'handoff_hot'          // Hot lead -> human sends consultation offer
  | 'handoff_warm'         // Warm lead -> ARI continues nurturing
  | 'send_community_cold'  // Cold lead -> send community link, then handoff
  | 'continue_nurturing';  // Warm lead in nurturing mode

export interface RoutingDecision {
  action: RoutingAction;
  temperature: LeadTemperature;
  score: number;
  readyForRouting: boolean;  // All required fields + documents collected
  message?: string;          // Optional message to send
  handoffNotes?: string;     // Notes for human consultant
}

/**
 * Determine routing action based on score and qualification status
 *
 * Key rule: Routing only triggers AFTER qualification is complete
 * (all required fields gathered AND all documents asked)
 */
export function determineRouting(
  score: number,
  temperature: LeadTemperature,
  formAnswers: Record<string, string>,
  documents: DocumentStatus | undefined,
  communityLink: string | null
): RoutingDecision {
  // Check if qualification is complete
  const hasRequiredFields = hasAllRequiredFields(formAnswers);
  const documentsComplete = documents ? allDocumentsAsked(documents) : false;
  const readyForRouting = hasRequiredFields && documentsComplete;

  // Not ready for routing yet - continue qualifying
  if (!readyForRouting) {
    return {
      action: 'continue_qualifying',
      temperature,
      score,
      readyForRouting: false,
    };
  }

  // Ready for routing - determine action based on temperature
  if (temperature === 'hot') {
    return {
      action: 'handoff_hot',
      temperature,
      score,
      readyForRouting: true,
      handoffNotes: `Hot lead (score: ${score}). Ready for consultation offer.`,
    };
  }

  if (temperature === 'warm') {
    return {
      action: 'continue_nurturing',
      temperature,
      score,
      readyForRouting: true,
      // Warm leads: ARI continues conversation, tries to qualify further
    };
  }

  // Cold lead - send community link then handoff
  const communityMessage = communityLink
    ? `Tetap terhubung dengan kami di grup WhatsApp ini ya kak: ${communityLink}. Nanti kalau ada pertanyaan atau update, bisa langsung diskusi di sana.`
    : null;

  return {
    action: 'send_community_cold',
    temperature,
    score,
    readyForRouting: true,
    message: communityMessage || undefined,
    handoffNotes: `Cold lead (score: ${score}). Community link ${communityLink ? 'sent' : 'not configured'}. Follow up in 30 days.`,
  };
}

/**
 * Map lead temperature to lead_status for CRM
 */
export function temperatureToLeadStatus(temperature: LeadTemperature): string {
  switch (temperature) {
    case 'hot': return 'hot_lead';
    case 'warm': return 'prospect';  // Warm stays as prospect until converted
    case 'cold': return 'cold_lead';
  }
}
```
  </action>
  <verify>
`npx tsc --noEmit src/lib/ari/routing.ts`
  </verify>
  <done>
determineRouting returns appropriate action based on score and qualification status
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate scoring and routing into processor</name>
  <files>src/lib/ari/processor.ts</files>
  <action>
Modify processor.ts to:

1. Import scoring and routing:
   ```typescript
   import { calculateLeadScore, getLeadTemperature, getScoreReasons } from './scoring';
   import { determineRouting, temperatureToLeadStatus } from './routing';
   ```

2. After getting form answers and document status (around step 5c), calculate score:
   ```typescript
   // 5d. Calculate lead score
   const documentStatus = conversationContext.documents || {
     passport: null,
     cv: null,
     english_test: null,
     transcript: null,
   };

   const { score: calculatedScore, breakdown, reasons } = calculateLeadScore(
     formAnswers,
     documentStatus,
     undefined  // Engagement score - future enhancement
   );

   const temperature = getLeadTemperature(calculatedScore);
   ```

3. Update ari_conversations with score when it changes (before step 13):
   ```typescript
   // 12b. Update score in ari_conversations if changed
   if (calculatedScore !== conversation.lead_score) {
     await supabase
       .from('ari_conversations')
       .update({
         lead_score: calculatedScore,
         lead_temperature: temperature,
         context: {
           ...conversationContext,
           score_breakdown: breakdown,
           score_reasons: reasons,
         },
       })
       .eq('id', conversation.id);
   }
   ```

4. Sync score to contacts table:
   ```typescript
   // 12c. Sync score to contacts table for CRM visibility
   await supabase
     .from('contacts')
     .update({
       lead_score: calculatedScore,
       lead_status: temperatureToLeadStatus(temperature),
     })
     .eq('id', contactId);
   ```

5. Determine routing after qualification (in qualifying state):
   ```typescript
   // 12d. Check routing decision
   const routing = determineRouting(
     calculatedScore,
     temperature,
     formAnswers,
     documentStatus,
     config.community_link
   );

   // If cold and ready for routing, send community link before handoff
   if (routing.action === 'send_community_cold' && routing.message) {
     // Community message will be sent as part of AI response
     // Add to context so AI knows to include it
     conversationContext.pendingCommunityMessage = routing.message;
   }
   ```

6. Use calculatedScore instead of existing leadScore in getNextState call
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
Score calculated during message processing, saved to both ari_conversations and contacts tables, routing decision made
  </done>
</task>

<task type="auto">
  <name>Task 3: Export routing module and update context builder</name>
  <files>src/lib/ari/index.ts, src/lib/ari/context-builder.ts</files>
  <action>
1. In index.ts, add export:
   ```typescript
   export { determineRouting, temperatureToLeadStatus, type RoutingDecision, type RoutingAction } from './routing';
   ```

2. In context-builder.ts, add score information to system prompt when in scoring state:
   - After the state instructions block, add:
   ```typescript
   // 5c. Scoring state context
   if (ctx.conversation.state === 'scoring' && ctx.contact.leadScore !== undefined) {
     const temp = ctx.contact.leadScore >= 70 ? 'hot' :
                  ctx.contact.leadScore >= 40 ? 'warm' : 'cold';
     const scoreReasons = (ctx.conversation.context as any).score_reasons || [];

     parts.push('\n## HASIL SCORING');
     parts.push(`Lead Score: ${ctx.contact.leadScore}/100 (${temp})`);
     if (scoreReasons.length > 0) {
       parts.push('Alasan:');
       scoreReasons.slice(0, 5).forEach((reason: string) => parts.push(`- ${reason}`));
     }

     if (temp === 'hot') {
       parts.push('\nINSTRUKSI: Lead ini HOT. Transisi ke handoff. Bilang konsultan akan segera menghubungi.');
     } else if (temp === 'cold') {
       const communityMsg = (ctx.conversation.context as any).pendingCommunityMessage;
       if (communityMsg) {
         parts.push(`\nINSTRUKSI: Lead ini COLD. Kirim pesan community: "${communityMsg}"`);
       }
       parts.push('Kemudian bilang konsultan akan follow up nanti.');
     }
   }
   ```

3. Update PromptContext interface in context-builder.ts to include score_reasons in conversation.context
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
Score information visible to AI in system prompt, routing exports available
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Score calculation happens during message processing
3. Score is saved to ari_conversations.lead_score
4. Score is synced to contacts.lead_score
5. Lead status auto-updates based on temperature
</verification>

<success_criteria>
- Score calculated after each message in qualifying state
- Score persisted to ari_conversations with breakdown
- Score synced to contacts table for CRM visibility
- Lead status updates based on temperature (hot_lead, cold_lead, prospect)
- Routing decision determines next action
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-scoring-routing/03-02-SUMMARY.md`
</output>
