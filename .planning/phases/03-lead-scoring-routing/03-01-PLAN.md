---
phase: 03-lead-scoring-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ari/scoring.ts
  - src/lib/ari/types.ts
  - src/lib/ari/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Lead score is calculated as 0-100 based on form data and documents"
    - "Score breakdown shows contribution from each factor"
    - "Timeline penalty applied for 2+ year timelines"
    - "Document readiness contributes to score"
  artifacts:
    - path: "src/lib/ari/scoring.ts"
      provides: "calculateLeadScore function with breakdown"
      exports: ["calculateLeadScore", "getScoreReasons"]
  key_links:
    - from: "src/lib/ari/scoring.ts"
      to: "src/lib/ari/types.ts"
      via: "ScoreBreakdown type import"
      pattern: "import.*ScoreBreakdown.*from"
---

<objective>
Create the lead scoring calculation engine that computes a 0-100 score based on form data, qualification responses, and document readiness.

Purpose: Provide quantified lead quality assessment for routing decisions
Output: Scoring module with calculateLeadScore() function and detailed breakdown
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lead-scoring-routing/03-CONTEXT.md
@src/lib/ari/types.ts
@src/lib/ari/qualification.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scoring calculation module</name>
  <files>src/lib/ari/scoring.ts</files>
  <action>
Create scoring.ts with comprehensive lead scoring algorithm:

1. Import types and qualification helpers:
   - ScoreBreakdown, DocumentStatus from types
   - REQUIRED_FIELDS from qualification

2. Define scoring weights (total = 100):
   - Basic data: 25 points (form completeness, valid email, target country)
   - Qualification: 35 points (english_level, budget clarity, timeline, program)
   - Document readiness: 30 points (passport, cv, english_test, transcript)
   - Engagement signals: 10 points (reserved for conversation quality)

3. Implement calculateLeadScore function:
   ```typescript
   export function calculateLeadScore(
     formAnswers: Record<string, string>,
     documents: DocumentStatus | undefined,
     engagementScore?: number  // Optional, 0-10, provided by conversation analysis
   ): { score: number; breakdown: ScoreBreakdown; reasons: string[] }
   ```

4. Basic data scoring (25 points max):
   - Form completeness: up to 15 points (count filled required fields / total * 15)
   - Valid email format: 5 points
   - Target country specified: 5 points

5. Qualification scoring (35 points max):
   - english_level specified: 10 points (bonus +3 if IELTS 6.5+ mentioned)
   - budget specified: 10 points
   - timeline specified: 10 points
   - TIMELINE PENALTY: If timeline mentions "2 tahun", "2025", or 2+ years away, subtract 10 points
   - program/jurusan specified: 5 points

6. Document readiness scoring (30 points max):
   - Each document (passport, cv, english_test, transcript): 7.5 points if true
   - Documents with null (not asked yet): 0 points
   - Documents with false: 0 points

7. Engagement scoring (10 points max):
   - Pass through engagementScore parameter if provided
   - Default to 5 if not provided (neutral)

8. Implement getScoreReasons function:
   ```typescript
   export function getScoreReasons(
     breakdown: ScoreBreakdown,
     formAnswers: Record<string, string>,
     documents: DocumentStatus | undefined
   ): string[]
   ```
   Returns Indonesian reasons array like:
   - "Form lengkap (15/15)"
   - "Email valid"
   - "Budget jelas: 50jt"
   - "Timeline dekat (6 bulan)"
   - "Paspor siap"
   - "Skor IELTS 6.5+"

9. Export helper to determine temperature:
   ```typescript
   export function getLeadTemperature(score: number): 'hot' | 'warm' | 'cold'
   ```
   - hot: score >= 70
   - warm: score >= 40 && score < 70
   - cold: score < 40
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/ari/scoring.ts`
  </verify>
  <done>
calculateLeadScore returns score 0-100 with breakdown object and reasons array
  </done>
</task>

<task type="auto">
  <name>Task 2: Update types and export scoring module</name>
  <files>src/lib/ari/types.ts, src/lib/ari/index.ts</files>
  <action>
1. In types.ts, update ScoreBreakdown interface to match new structure:
   ```typescript
   export interface ScoreBreakdown {
     basic_score: number;      // 0-25
     qualification_score: number;  // 0-35
     document_score: number;   // 0-30
     engagement_score: number; // 0-10
     total: number;            // 0-100
   }
   ```
   Note: This replaces the existing ScoreBreakdown (budget_score, readiness_score, etc.)

2. In index.ts, add exports:
   ```typescript
   export { calculateLeadScore, getScoreReasons, getLeadTemperature } from './scoring';
   ```
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
ScoreBreakdown type updated, scoring functions exported from index
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for scoring</name>
  <files>src/lib/ari/__tests__/scoring.test.ts</files>
  <action>
Create test file for scoring module:

```typescript
import { calculateLeadScore, getLeadTemperature, getScoreReasons } from '../scoring';
import type { DocumentStatus } from '../qualification';

describe('calculateLeadScore', () => {
  it('returns 0 for empty form and no documents', () => {
    const result = calculateLeadScore({}, undefined);
    expect(result.score).toBeLessThan(20);
  });

  it('returns high score for complete form with documents', () => {
    const form = {
      name: 'Budi',
      email: 'budi@test.com',
      english_level: 'IELTS 7.0',
      budget: '50 juta',
      timeline: '6 bulan',
      country: 'Australia'
    };
    const docs: DocumentStatus = {
      passport: true,
      cv: true,
      english_test: true,
      transcript: true
    };
    const result = calculateLeadScore(form, docs);
    expect(result.score).toBeGreaterThanOrEqual(70);
  });

  it('applies timeline penalty for 2+ year timeline', () => {
    const formNear = { timeline: '6 bulan', country: 'UK' };
    const formFar = { timeline: '2 tahun lagi', country: 'UK' };

    const nearResult = calculateLeadScore(formNear, undefined);
    const farResult = calculateLeadScore(formFar, undefined);

    expect(nearResult.score).toBeGreaterThan(farResult.score);
  });
});

describe('getLeadTemperature', () => {
  it('returns hot for 70+', () => {
    expect(getLeadTemperature(70)).toBe('hot');
    expect(getLeadTemperature(85)).toBe('hot');
  });

  it('returns warm for 40-69', () => {
    expect(getLeadTemperature(40)).toBe('warm');
    expect(getLeadTemperature(69)).toBe('warm');
  });

  it('returns cold for <40', () => {
    expect(getLeadTemperature(0)).toBe('cold');
    expect(getLeadTemperature(39)).toBe('cold');
  });
});
```
  </action>
  <verify>
`npm test -- --testPathPattern=scoring` passes
  </verify>
  <done>
Scoring tests pass, edge cases covered
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm test -- --testPathPattern=scoring` all tests pass
3. Types are correctly exported from src/lib/ari/index.ts
</verification>

<success_criteria>
- calculateLeadScore function returns score 0-100
- ScoreBreakdown shows contribution from each category
- Timeline penalty correctly reduces score
- getLeadTemperature maps score to hot/warm/cold
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-scoring-routing/03-01-SUMMARY.md`
</output>
