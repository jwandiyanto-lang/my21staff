---
phase: 03-lead-scoring-routing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/contact/info-sidebar.tsx
  - src/components/contact/score-breakdown.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Score displayed with temperature badge (Hot/Warm/Cold)"
    - "Score breakdown visible in expandable section"
    - "Score reasons shown in human-readable Indonesian"
    - "Format matches 'ARI Score: [number] - [reasons]'"
  artifacts:
    - path: "src/components/contact/score-breakdown.tsx"
      provides: "Score breakdown UI component"
      exports: ["ScoreBreakdown"]
    - path: "src/components/contact/info-sidebar.tsx"
      provides: "Updated sidebar with ARI score section"
  key_links:
    - from: "src/components/contact/info-sidebar.tsx"
      to: "src/components/contact/score-breakdown.tsx"
      via: "import ScoreBreakdown component"
      pattern: "import.*ScoreBreakdown.*from"
---

<objective>
Create UI components to display lead score with detailed breakdown in the contact info sidebar.

Purpose: Make scoring visible to users with clear reasons
Output: Score breakdown component and updated info sidebar
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lead-scoring-routing/03-CONTEXT.md
@.planning/phases/03-lead-scoring-routing/03-01-SUMMARY.md
@src/components/contact/info-sidebar.tsx
@src/lib/ari/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create score breakdown component</name>
  <files>src/components/contact/score-breakdown.tsx</files>
  <action>
Create a new component to display score breakdown:

```typescript
'use client'

import { useState } from 'react'
import { ChevronDown, ChevronUp, Sparkles } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { cn } from '@/lib/utils'

interface ScoreBreakdownData {
  basic_score?: number;
  qualification_score?: number;
  document_score?: number;
  engagement_score?: number;
  total?: number;
}

interface ScoreBreakdownProps {
  score: number;
  breakdown?: ScoreBreakdownData;
  reasons?: string[];
  showDetails?: boolean;
}

function getTemperature(score: number): { label: string; color: string; bgColor: string } {
  if (score >= 70) return { label: 'Hot', color: '#DC2626', bgColor: '#FEE2E2' };
  if (score >= 40) return { label: 'Warm', color: '#F59E0B', bgColor: '#FEF3C7' };
  return { label: 'Cold', color: '#3B82F6', bgColor: '#DBEAFE' };
}

function getScoreColor(score: number): string {
  if (score >= 70) return '#DC2626';  // red for hot
  if (score >= 40) return '#F59E0B';  // amber for warm
  return '#3B82F6';  // blue for cold
}

export function ScoreBreakdown({ score, breakdown, reasons, showDetails = true }: ScoreBreakdownProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const temp = getTemperature(score);
  const scoreColor = getScoreColor(score);

  // If no breakdown data, just show score
  const hasBreakdown = breakdown && (
    breakdown.basic_score !== undefined ||
    breakdown.qualification_score !== undefined ||
    breakdown.document_score !== undefined
  );

  return (
    <div className="space-y-2">
      {/* Main score display */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Sparkles className="h-4 w-4 text-muted-foreground" />
          <span className="text-xs font-medium text-muted-foreground uppercase tracking-wider">
            ARI Score
          </span>
        </div>
        <div className="flex items-center gap-2">
          <Badge
            style={{ backgroundColor: temp.bgColor, color: temp.color }}
            className="text-xs font-medium"
          >
            {temp.label}
          </Badge>
          <span
            className="text-lg font-bold tabular-nums"
            style={{ color: scoreColor }}
          >
            {score}
          </span>
        </div>
      </div>

      {/* Progress bar */}
      <div className="h-2 rounded-full bg-muted overflow-hidden">
        <div
          className="h-full rounded-full transition-all duration-500"
          style={{
            width: `${Math.min(score, 100)}%`,
            backgroundColor: scoreColor,
          }}
        />
      </div>

      {/* Expandable details */}
      {showDetails && (hasBreakdown || (reasons && reasons.length > 0)) && (
        <button
          onClick={() => setIsExpanded(!isExpanded)}
          className="flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors w-full justify-center pt-1"
        >
          {isExpanded ? (
            <>
              <ChevronUp className="h-3 w-3" />
              Sembunyikan detail
            </>
          ) : (
            <>
              <ChevronDown className="h-3 w-3" />
              Lihat detail skor
            </>
          )}
        </button>
      )}

      {/* Expanded breakdown */}
      {isExpanded && (
        <div className="space-y-3 pt-2 border-t">
          {/* Score breakdown bars */}
          {hasBreakdown && (
            <div className="space-y-2">
              <BreakdownBar
                label="Data Dasar"
                value={breakdown.basic_score || 0}
                max={25}
                color="#10B981"
              />
              <BreakdownBar
                label="Kualifikasi"
                value={breakdown.qualification_score || 0}
                max={35}
                color="#3B82F6"
              />
              <BreakdownBar
                label="Dokumen"
                value={breakdown.document_score || 0}
                max={30}
                color="#8B5CF6"
              />
              <BreakdownBar
                label="Engagement"
                value={breakdown.engagement_score || 0}
                max={10}
                color="#F59E0B"
              />
            </div>
          )}

          {/* Reasons list */}
          {reasons && reasons.length > 0 && (
            <div className="space-y-1">
              <p className="text-xs font-medium text-muted-foreground">Alasan:</p>
              <ul className="text-xs space-y-0.5">
                {reasons.map((reason, i) => (
                  <li key={i} className="text-muted-foreground">
                    â€¢ {reason}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function BreakdownBar({
  label,
  value,
  max,
  color,
}: {
  label: string;
  value: number;
  max: number;
  color: string;
}) {
  const percentage = Math.min((value / max) * 100, 100);

  return (
    <div className="space-y-1">
      <div className="flex items-center justify-between text-xs">
        <span className="text-muted-foreground">{label}</span>
        <span className="font-medium tabular-nums">
          {value}/{max}
        </span>
      </div>
      <div className="h-1.5 rounded-full bg-muted overflow-hidden">
        <div
          className="h-full rounded-full transition-all"
          style={{ width: `${percentage}%`, backgroundColor: color }}
        />
      </div>
    </div>
  );
}
```
  </action>
  <verify>
`npx tsc --noEmit src/components/contact/score-breakdown.tsx`
  </verify>
  <done>
ScoreBreakdown component renders score with temperature badge and expandable breakdown
  </done>
</task>

<task type="auto">
  <name>Task 2: Update info sidebar with ARI score section</name>
  <files>src/components/contact/info-sidebar.tsx</files>
  <action>
Modify info-sidebar.tsx to:

1. Import ScoreBreakdown component:
   ```typescript
   import { ScoreBreakdown } from './score-breakdown'
   ```

2. Add ariScoreData prop to InfoSidebarProps:
   ```typescript
   interface InfoSidebarProps {
     // ... existing props
     ariScoreData?: {
       score: number;
       breakdown?: {
         basic_score?: number;
         qualification_score?: number;
         document_score?: number;
         engagement_score?: number;
       };
       reasons?: string[];
     };
   }
   ```

3. Replace the existing "Lead Score" section (around line 632-665) with the new ARI Score section:
   ```tsx
   {/* ARI Score - replaces old Lead Score section */}
   <div className="space-y-2">
     {ariScoreData ? (
       <ScoreBreakdown
         score={ariScoreData.score}
         breakdown={ariScoreData.breakdown}
         reasons={ariScoreData.reasons}
       />
     ) : (
       // Fallback to manual score slider if no ARI data
       <>
         <div className="flex items-center justify-between">
           <h3 className="text-xs font-medium text-muted-foreground uppercase tracking-wider">
             Lead Score
           </h3>
           <div className="flex items-center gap-2">
             {isUpdatingScore && <Loader2 className="h-3 w-3 animate-spin text-muted-foreground" />}
             <span
               className="text-lg font-semibold tabular-nums"
               style={{ color: getScoreColor(localScore) }}
             >
               {localScore}
             </span>
           </div>
         </div>
         <div className="h-2 rounded-full bg-muted overflow-hidden">
           <div
             className="h-full rounded-full transition-all"
             style={{
               width: `${Math.min(localScore, 100)}%`,
               backgroundColor: getScoreColor(localScore),
             }}
           />
         </div>
         <Slider
           value={[localScore]}
           onValueChange={handleScoreChange}
           min={0}
           max={100}
           step={1}
           className="w-full"
         />
       </>
     )}
   </div>
   ```

4. The component should show:
   - ARI Score with ScoreBreakdown if ariScoreData is provided
   - Manual slider if no ARI data (for manually scored leads)
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
Info sidebar shows ARI score with breakdown when available, falls back to manual score otherwise
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire ARI score data in inbox client</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Update inbox-client.tsx to fetch and pass ARI score data to InfoSidebar:

1. When fetching contact data for the selected conversation, also fetch ari_conversations data:
   Find where the InfoSidebar is rendered with the selected contact.

2. Add a query to fetch ARI conversation data:
   ```typescript
   // Fetch ARI conversation data for the selected contact
   const { data: ariConversation } = await supabase
     .from('ari_conversations')
     .select('lead_score, lead_temperature, context')
     .eq('contact_id', selectedContact.id)
     .eq('workspace_id', workspaceId)
     .single();
   ```

3. Extract score data from ARI conversation:
   ```typescript
   const ariScoreData = ariConversation ? {
     score: ariConversation.lead_score || 0,
     breakdown: (ariConversation.context as any)?.score_breakdown,
     reasons: (ariConversation.context as any)?.score_reasons,
   } : undefined;
   ```

4. Pass to InfoSidebar:
   ```tsx
   <InfoSidebar
     contact={selectedContact}
     // ... other props
     ariScoreData={ariScoreData}
   />
   ```

Note: The inbox-client may use React Query or direct Supabase calls. Follow the existing pattern for data fetching. If using React Query, add a new query hook. If using useEffect, add to existing contact fetch.
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
ARI score data fetched and passed to InfoSidebar in inbox view
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. ScoreBreakdown component renders correctly
3. Info sidebar shows ARI score section with Hot/Warm/Cold badge
4. Breakdown expandable shows category scores
5. Reasons list displays in Indonesian
</verification>

<success_criteria>
- Score displayed as "ARI Score: [number]" with temperature badge
- Expandable breakdown shows contribution from each category
- Reasons shown in human-readable Indonesian format
- Falls back to manual slider when no ARI data
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-scoring-routing/03-03-SUMMARY.md`
</output>
