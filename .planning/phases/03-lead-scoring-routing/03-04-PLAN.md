---
phase: 03-lead-scoring-routing
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/lib/ari/processor.ts
  - src/lib/ari/context-builder.ts
  - src/lib/ari/state-machine.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Hot leads trigger handoff with consultation offer context"
    - "Cold leads receive community link before handoff"
    - "Warm leads continue ARI nurturing"
    - "Routing only triggers after all required data collected"
  artifacts:
    - path: "src/lib/ari/processor.ts"
      provides: "Routing action execution"
    - path: "src/lib/ari/context-builder.ts"
      provides: "Routing-aware system prompts"
  key_links:
    - from: "src/lib/ari/processor.ts"
      to: "sendMessage (Kapso)"
      via: "Community link message"
      pattern: "sendMessage.*community"
---

<objective>
Implement the routing actions: hot lead handoff, cold lead community message + handoff, and warm lead continued nurturing.

Purpose: Execute routing decisions to move leads through the funnel
Output: Processor executes routing actions, state machine updated
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lead-scoring-routing/03-CONTEXT.md
@.planning/phases/03-lead-scoring-routing/03-02-SUMMARY.md
@src/lib/ari/processor.ts
@src/lib/ari/routing.ts
@src/lib/ari/state-machine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update state machine for routing transitions</name>
  <files>src/lib/ari/state-machine.ts</files>
  <action>
Modify state-machine.ts to support routing-based transitions:

1. Update getNextState to accept routing action parameter:
   ```typescript
   export function getNextState(
     current: ARIState,
     context: ARIContext,
     leadScore: number,
     routingAction?: 'handoff_hot' | 'handoff_warm' | 'send_community_cold' | 'continue_qualifying' | 'continue_nurturing'
   ): ARIState {
   ```

2. In the 'qualifying' case, check if routing action indicates completion:
   ```typescript
   case 'qualifying':
     // If routing says we're done qualifying, move to scoring
     if (routingAction === 'handoff_hot' || routingAction === 'send_community_cold') {
       return 'scoring';
     }
     // Need minimum data to move to scoring
     if (leadScore >= MIN_SCORE_FOR_SCORING) {
       return 'scoring';
     }
     // Stay in qualifying to collect more
     return 'qualifying';
   ```

3. In the 'scoring' case, handle routing actions:
   ```typescript
   case 'scoring':
     // All paths from scoring lead to handoff
     // Hot leads: handoff to human who will send consultation offer
     // Warm leads: could stay in nurturing mode (future) or handoff
     // Cold leads: already sent community link, now handoff
     if (routingAction === 'handoff_hot' || routingAction === 'send_community_cold') {
       return 'handoff';
     }
     // Warm leads continue nurturing (stay in scoring for now, will handoff eventually)
     if (routingAction === 'continue_nurturing' && leadScore < HOT_LEAD_THRESHOLD) {
       return 'scoring';  // Can stay to answer more questions
     }
     // Default: hot leads go to booking, others to handoff
     if (leadScore >= HOT_LEAD_THRESHOLD) {
       return 'booking';
     }
     return 'handoff';
   ```

4. Add constant for warm lead handling:
   ```typescript
   const WARM_LEAD_MAX_MESSAGES = 5;  // After 5 messages in scoring, handoff warm leads
   ```
  </action>
  <verify>
`npx tsc --noEmit src/lib/ari/state-machine.ts`
  </verify>
  <done>
State machine supports routing-based transitions
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement routing action execution in processor</name>
  <files>src/lib/ari/processor.ts</files>
  <action>
Update processor.ts to execute routing actions:

1. After calculating routing decision (step 12d from 03-02), execute the action:
   ```typescript
   // 12e. Execute routing action
   if (routing.readyForRouting) {
     if (routing.action === 'send_community_cold' && routing.message) {
       // Send community link message BEFORE AI response
       try {
         await sendMessage(kapsoCredentials, contactPhone, routing.message);
         console.log('[ARI] Sent community link to cold lead');

         // Log community message
         await logMessage(supabase, {
           ariConversationId: conversation.id,
           workspaceId,
           role: 'assistant',
           content: routing.message,
         });
       } catch (sendError) {
         console.error('[ARI] Failed to send community message:', sendError);
       }
     }

     if (routing.action === 'handoff_hot' || routing.action === 'send_community_cold') {
       // Update conversation for handoff
       await supabase
         .from('ari_conversations')
         .update({
           state: 'handoff' as ARIState,
           handoff_at: new Date().toISOString(),
           handoff_reason: routing.action === 'handoff_hot' ? 'hot_lead' : 'cold_lead_community_sent',
           context: {
             ...conversationContext,
             handoff_notes: routing.handoffNotes,
           },
         })
         .eq('id', conversation.id);

       // Add handoff notes to contact notes (if we have a notes API)
       // For now, store in context for human to see

       // Send handoff message
       const handoffMessage = routing.action === 'handoff_hot'
         ? 'Terima kasih sudah berbagi info yang lengkap. Konsultan kami akan segera menghubungi kamu untuk mendiskusikan pilihan yang cocok.'
         : 'Konsultan kami akan follow up nanti ya kak. Kalau ada pertanyaan, langsung chat di grup aja.';

       await logMessage(supabase, {
         ariConversationId: conversation.id,
         workspaceId,
         role: 'assistant',
         content: handoffMessage,
       });

       try {
         await sendMessage(kapsoCredentials, contactPhone, handoffMessage);
       } catch (sendError) {
         console.error('[ARI] Failed to send handoff message:', sendError);
       }

       return {
         success: true,
         response: handoffMessage,
         newState: 'handoff',
       };
     }
   }
   ```

2. Pass routing action to getNextState:
   ```typescript
   const nextState = getNextState(
     conversation.state,
     conversation.context as ARIContext,
     calculatedScore,
     routing.action
   );
   ```

3. Update the context builder call to include community message if pending:
   ```typescript
   const promptContext: PromptContext = {
     // ... existing fields
     conversation: {
       state: conversation.state,
       context: {
         ...conversationContext,
         // Include community message if cold lead
         pendingCommunityMessage: routing.action === 'send_community_cold' ? routing.message : undefined,
       },
       // ...
     },
   };
   ```
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
Routing actions executed: community message sent for cold leads, handoff triggered for hot/cold
  </done>
</task>

<task type="auto">
  <name>Task 3: Update context builder with routing instructions</name>
  <files>src/lib/ari/context-builder.ts</files>
  <action>
Update context-builder.ts to provide clear routing instructions to AI:

1. Update the scoring state instructions (STATE_INSTRUCTIONS):
   ```typescript
   scoring: `Kamu sudah selesai mengumpulkan data. Berdasarkan informasi yang ada, nilai kesiapan lead ini. JANGAN tawarkan konsultasi langsung - tunggu instruksi routing.`,
   ```

2. Add handoff state instructions update:
   ```typescript
   handoff: `Lead sudah di-handoff ke konsultan manusia. Jika masih ada pertanyaan, jawab singkat dan bilang konsultan akan membantu lebih detail.`,
   ```

3. In the buildSystemPrompt function, after the scoring state context block, add routing instructions:
   ```typescript
   // 5d. Routing-specific instructions
   const routingAction = (ctx.conversation.context as any).routingAction;
   const pendingCommunityMessage = (ctx.conversation.context as any).pendingCommunityMessage;

   if (ctx.conversation.state === 'scoring' || ctx.conversation.state === 'qualifying') {
     const score = ctx.contact.leadScore || 0;

     if (score >= 70) {
       parts.push('\n## ROUTING: HOT LEAD');
       parts.push('Lead ini siap untuk konsultasi. JANGAN tawarkan langsung.');
       parts.push('Bilang: "Data kamu sudah lengkap. Konsultan kami akan segera menghubungi untuk mendiskusikan pilihan yang cocok."');
     } else if (score < 40 && pendingCommunityMessage) {
       parts.push('\n## ROUTING: COLD LEAD');
       parts.push('Lead ini cold. Community link sudah dikirim terpisah.');
       parts.push('Bilang: "Terima kasih sudah mengisi. Nanti konsultan kami akan follow up ya. Kalau ada pertanyaan, langsung chat di grup."');
     }
   }
   ```

4. Add explicit "DO NOT" instructions for scoring state:
   ```typescript
   if (ctx.conversation.state === 'scoring') {
     parts.push('\n## LARANGAN DI STATE SCORING');
     parts.push('- JANGAN tawarkan konsultasi atau pembayaran');
     parts.push('- JANGAN kirim link booking sendiri');
     parts.push('- TUNGGU handoff ke manusia');
   }
   ```
  </action>
  <verify>
`npm run build` passes without errors
  </verify>
  <done>
AI receives clear routing instructions, knows not to offer consultation directly
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Hot leads transition to handoff with appropriate message
3. Cold leads receive community link then transition to handoff
4. Warm leads continue in nurturing (stay in scoring/qualifying)
5. AI instructions clear about what to say during routing
</verification>

<success_criteria>
- Hot leads (70+): Handoff message sent, state -> handoff
- Cold leads (<40): Community link sent, then handoff message, state -> handoff
- Warm leads (40-69): Continue ARI conversation
- Routing only happens after qualification complete
- Human receives handoff notes with score and reasons
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-scoring-routing/03-04-SUMMARY.md`
</output>
