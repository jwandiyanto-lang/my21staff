---
phase: 05-implementation
plan: 06
type: execute
wave: 4
depends_on: [05-02, 05-05]
files_modified: [src/lib/queries/use-conversations.ts, src/lib/queries/use-messages.ts, src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Inbox uses Convex real-time subscriptions"
    - "New messages appear instantly without polling"
    - "Conversation list updates in real-time"
  artifacts:
    - path: "src/lib/queries/use-conversations.ts"
      provides: "React Query hook for conversations with Convex"
      exports: ["useConversations"]
    - path: "src/lib/queries/use-messages.ts"
      provides: "React Query hook for messages with Convex"
      exports: ["useMessages"]
    - path: "src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx"
      provides: "Inbox UI using Convex real-time"
      pattern: "useSubscription"
  key_links:
    - from: "src/lib/queries/use-conversations.ts"
      to: "convex/_generated/reactClient"
      via: "useQuery with subscription"
      pattern: "useQuery.*conversations"
    - from: "src/lib/queries/use-messages.ts"
      to: "convex/_generated/reactClient"
      via: "useQuery with subscription"
      pattern: "useQuery.*messages"
---

<objective>
Update inbox to use Convex real-time subscriptions instead of Supabase real-time.

Purpose: Eliminate polling and achieve instant UI updates when new messages arrive via Kapso webhook.

Output: Inbox client component using Convex useQuery with real-time subscriptions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
@src/lib/queries/use-conversations.ts
@src/lib/queries/use-messages.ts
@convex/_generated/reactClient.d.ts
@.planning/phases/05-implementation/05-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Update useConversations hook for Convex</name>
  <files>src/lib/queries/use-conversations.ts</files>
  <action>
    Update src/lib/queries/use-conversations.ts to use Convex:

    1. Replace imports:
       - Remove: import { createClient } from '@/lib/supabase/client'
       - Add: import { useQuery, useMutation } from 'convex/_generated/reactClient'

    2. Update useConversations hook:
       - Replace fetch calls with useQuery(api.conversations.listWithFilters, { workspace_id, page, limit, filters })
       - Return: { data, isLoading, error } from useQuery
       - data contains: { conversations, totalCount, activeCount, teamMembers, quickReplies, contactTags }

    3. Update useInfiniteConversations (if exists):
       - Replace with usePaginatedQuery from Convex or useQuery with cursor

    4. Keep existing type definitions (ConversationFilters, etc.)

    5. Add useOptimisticUpdate for conversation updates:
       - useMutation(api.updateConversationStatus)
       - useMutation(api.assignConversation)
       - useMutation(api.markConversationRead)

    Convex subscriptions are automatic with useQuery - no manual subscription management needed.
  </action>
  <verify>grep "useQuery.*conversations" src/lib/queries/use-conversations.ts</verify>
  <done>useConversations uses Convex real-time subscriptions</done>
</task>

<task type="auto">
  <name>Update useMessages hook for Convex</name>
  <files>src/lib/queries/use-messages.ts</files>
  <action>
    Update src/lib/queries/use-messages.ts to use Convex:

    1. Replace imports:
       - Remove: import { createClient } from '@/lib/supabase/client'
       - Add: import { useQuery, useMutation } from 'convex/_generated/reactClient'

    2. Update useMessages hook:
       - Replace fetch calls with useQuery(api.messages.listByConversation, { conversation_id, workspace_id, limit: 100 })
       - Return: { data, isLoading, error, refetch } from useQuery

    3. Add optimistic update mutations:
       - useMutation(api.createMessage) - for sending messages
       - Handle optimistic UI updates (add pending message to local state before mutation)

    4. Keep useAddOptimisticMessage, useRemoveOptimisticMessage patterns:
       - Adapt to work with Convex useMutation
       - Use mutation.options.onSuccess to update TanStack Query cache

    Convex automatically subscribes to query results - real-time updates are built-in.
  </action>
  <verify>grep "useQuery.*messages" src/lib/queries/use-messages.ts</verify>
  <done>useMessages uses Convex real-time subscriptions</done>
</task>

<task type="auto">
  <name>Update inbox-client to use Convex subscriptions</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
    Update src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx:

    1. Remove Supabase real-time subscription useEffect (lines 306-371):
       - Remove: supabase.channel(...).on('postgres_changes', ...).subscribe()
       - Remove: supabase.removeChannel(channel) cleanup

    2. Remove imports:
       - import { createClient } from '@/lib/supabase/client'
       - Keep: useConversations, useMessages from updated hooks

    3. No replacement needed for subscription:
       - Convex useQuery automatically subscribes to data changes
       - When webhook creates messages via Convex, useQuery results update instantly
       - No manual subscription management required

    4. Keep all local state (selectedConversation, filters, etc.)
    5. Keep all event handlers (handleSelectConversation, etc.)
    6. Keep TanStack Query cache helpers (they work with any data source)

    The inbox now receives real-time updates via Convex built-in subscriptions.
  </action>
  <verify>! grep "postgres_changes" src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx && grep "useConversations" src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</verify>
  <done>Inbox uses Convex real-time with no manual subscriptions</done>
</task>

<task type="auto">
  <name>Remove Supabase data queries (keep auth only)</name>
  <files>src/lib/supabase/server.ts, src/lib/supabase/client.ts</files>
  <action>
    Remove Supabase data access, keep only auth:

    1. Keep in src/lib/supabase/server.ts:
       - createClient() - for auth access (supabase.auth)
       - createApiAdminClient() - for admin operations
       - Auth-related functions only

    2. Remove from src/lib/supabase/client.ts (or update if used):
       - Any direct data queries
       - Keep if only used for auth

    3. Verify no data queries remain:
       - Search for supabase.from('...') - should only find in auth-related files
       - Search for supabase.channel() - should be gone after Plan 06 Task 3

    4. Keep Supabase for:
       - Authentication (supabase.auth)
       - Profiles table (user profiles, admin flag)
       - Workspace invitations (invitation flow)
       - Admin clients table (multi-tenant admin)

    These are auth/admin related, not CRM data (now in Convex).
  </action>
  <verify>! grep "supabase.from.*conversations\|supabase.from.*messages\|supabase.from.*contacts" src/lib/supabase/*.ts</verify>
  <done>Supabase data queries removed, auth kept</done>
</task>

</tasks>

<verification>
1. src/lib/queries/use-conversations.ts uses Convex useQuery
2. src/lib/queries/use-messages.ts uses Convex useQuery
3. inbox-client.ts has no Supabase postgres_changes subscriptions
4. Convex queries automatically subscribe to data changes
5. Supabase only used for auth, not CRM data
</verification>

<success_criteria>
1. Inbox updates instantly when webhook creates messages in Convex
2. No polling or manual subscription management needed
3. Conversation list reflects new messages immediately
4. Supabase kept for auth only (auth.getUser, auth.signIn, etc.)
5. All CRM data queries use Convex
</success_criteria>

<output>
After completion, create `.planning/phases/05-implementation/05-06-SUMMARY.md`
</output>
