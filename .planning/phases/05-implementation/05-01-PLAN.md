---
phase: 05-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/schema.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Convex schema includes all fields from Supabase tables"
    - "All indexes defined for hot path queries"
    - "Schema supports ARI lead scoring metadata"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Complete data model for CRM"
      contains: "workspaces, workspaceMembers, contacts, conversations, messages, contactNotes"
    - path: "convex/_generated/server.d.ts"
      provides: "TypeScript types generated from schema"
      exports: ["Doc", "TableNames"]
  key_links:
    - from: "convex/schema.ts"
      to: "Supabase schema"
      via: "field mapping comparison"
      pattern: "phone_normalized, kapso_name, metadata"
---

<objective>
Complete Convex schema with all Supabase table fields and indexes for CRM migration.

Purpose: Ensure Convex schema supports all existing data and optimized queries for hot paths (inbox, contact lookup, messaging).

Output: Updated convex/schema.ts with complete field definitions and indexes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@convex/schema.ts
@.planning/phases/10-convex-spike/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Update contacts schema with missing Supabase fields</name>
  <files>convex/schema.ts</files>
  <action>
    Update the contacts table definition to include all Supabase fields:

    Add to contacts table:
    - phone_normalized: v.optional(v.string()) - for normalized phone matching
    - kapso_name: v.optional(v.string()) - name from WhatsApp profile
    - cache_updated_at: v.optional(v.number()) - timestamp of last cache refresh
    - assigned_to: v.optional(v.string()) - user_id of assigned member
    - source: v.optional(v.string()) - lead source (webinar, referral, etc.)

    Update indexes to include:
    - by_workspace_phone: ["workspace_id", "phone"]
    - by_workspace: ["workspace_id"]
    - by_assigned: ["workspace_id", "assigned_to"] - for filtering by assignment

    Keep existing fields: id, workspace_id, phone, name, email, lead_score, lead_status, tags, metadata, created_at, updated_at, supabaseId

    Read existing schema.ts first, then write updated version preserving all other tables.
  </action>
  <verify>cat convex/schema.ts | grep -E "(phone_normalized|kapso_name|assigned_to|source)"</verify>
  <done>Contacts table has all Supabase fields with correct indexes</done>
</task>

<task type="auto">
  <name>Update messages schema with reply context fields</name>
  <files>convex/schema.ts</files>
  <action>
    Update the messages table definition to support reply tracking:

    Add to metadata schema (or as top-level fields if cleaner):
    - reply_to_kapso_id: store in metadata as v.optional(v.any())
    - reply_to_from: store in metadata as v.optional(v.any())

    Ensure existing fields are present:
    - conversation_id, workspace_id, direction, sender_type, sender_id, content, message_type, media_url, kapso_message_id, metadata, created_at, supabaseId

    Update indexes:
    - by_conversation_time: ["conversation_id", "created_at"]
    - by_workspace: ["workspace_id"]

    The metadata field is already v.optional(v.any()), which supports reply context storage.
  </action>
  <verify>cat convex/schema.ts | grep -A 10 "messages:"</verify>
  <done>Messages table supports reply context tracking via metadata</done>
</task>

<task type="auto">
  <name>Add workspace members settings field for filter presets</name>
  <files>convex/schema.ts</files>
  <action>
    Update workspaceMembers table to include settings JSONB field:

    Add to workspaceMembers table:
    - settings: v.optional(v.any()) - for user preferences (filterPresets, etc.)

    Update indexes:
    - by_user_workspace: ["user_id", "workspace_id"]
    - by_workspace: ["workspace_id"]

    This enables storing filter presets per user as Supabase does.
  </action>
  <verify>grep "settings" convex/schema.ts | grep -A 2 "workspaceMembers"</verify>
  <done>Workspace members table supports settings for filter presets</done>
</task>

<task type="auto">
  <name>Regenerate Convex types from updated schema</name>
  <files>convex/_generated/server.d.ts, convex/_generated/api.d.ts</files>
  <action>
    Run npx convex codegen to regenerate TypeScript types from updated schema.

    Command: npx convex codegen --no-push

    This updates _generated/server.d.ts and _generated/api.d.ts with new field types.
    Types are required for type-safe mutations and queries in subsequent plans.
  </action>
  <verify>grep "Doc" convex/_generated/server.d.ts | head -5</verify>
  <done>TypeScript types generated with all new schema fields</done>
</task>

</tasks>

<verification>
1. convex/schema.ts has all Supabase fields for contacts, messages, workspaceMembers
2. Indexes cover hot path queries (by_workspace_phone, by_assigned, by_conversation_time)
3. npx convex codegen completed successfully
4. Generated types include new fields (Doc<"contacts"> has phone_normalized, etc.)
</verification>

<success_criteria>
1. Convex schema complete with all Supabase fields mapped
2. All hot path indexes defined (phone lookup, assignment filtering, conversation time)
3. TypeScript types regenerated and compile without errors
4. Ready for CRUD mutations in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/05-implementation/05-01-SUMMARY.md`
</output>
