---
phase: 05-implementation
plan: 03
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified: [convex/conversations.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Conversations can be listed with workspace filters"
    - "Conversations support assignment filtering and status filtering"
    - "Active/unread count queries available for inbox"
  artifacts:
    - path: "convex/conversations.ts"
      provides: "Conversation query functions"
      exports: ["listByWorkspace", "getById", "countUnread", "listMembers", "listTags"]
  key_links:
    - from: "convex/conversations.ts"
      to: "convex/mutations.ts"
      via: "Mutation imports"
      pattern: "import.*mutations"
    - from: "convex/conversations.ts"
      to: "convex/lib/auth.ts"
      via: "requireWorkspaceMembership()"
      pattern: "requireWorkspaceMembership"
---

<objective>
Create comprehensive conversation query functions with filters and aggregations for inbox functionality.

Purpose: Provide all queries needed by /api/conversations route (filters, counts, team members, tags).

Output: Extended convex/conversations.ts with inbox query functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@convex/schema.ts
@convex/conversations.ts
@src/app/api/conversations/route.ts
@.planning/phases/05-implementation/05-01-PLAN.md
@.planning/phases/05-implementation/05-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Extend listByWorkspace with filters</name>
  <files>convex/conversations.ts</files>
  <action>
    Update existing listByWorkspace function in convex/conversations.ts:

    Add filter parameters:
    - status: optional string ('open', 'closed', 'handover')
    - assignedTo: optional string (user_id or 'unassigned')
    - limit: optional number (default 50)

    Apply filters:
    - If status provided: filter by conversation.status
    - If assignedTo='unassigned': filter by assigned_to is null
    - If assignedTo is user_id: filter by assigned_to equals user_id
    - Keep ordering by last_message_at DESC (via by_workspace_time index)

    Keep existing contact parallel fetch (contacts in Promise.all).
    Each conversation includes contact data via contact_id lookup.
  </action>
  <verify>cat convex/conversations.ts | grep -A 20 "listByWorkspace"</verify>
  <done>listByWorkspace supports status, assignment, and limit filters</done>
</task>

<task type="auto">
  <name>Create count queries for inbox</name>
  <files>convex/conversations.ts</files>
  <action>
    Add to convex/conversations.ts count aggregation functions:

    1. countUnread - count conversations with unread > 0
       - Args: workspace_id
       - Verifies workspace membership
       - Queries by_workspace_time index
       - Filters for unread_count > 0
       - Returns count

    2. countAll - total conversation count
       - Args: workspace_id
       - Verifies workspace membership
       - Queries by_workspace index
       - Returns count

    These are used for active count badge and pagination.
  </action>
  <verify>cat convex/conversations.ts | grep -E "(countUnread|countAll)"</verify>
  <done>Count queries available for inbox badges</done>
</task>

<task type="auto">
  <name>Create getById and getByContact queries</name>
  <files>convex/conversations.ts</files>
  <action>
    Add to convex/conversations.ts lookup queries:

    1. getById - get single conversation by ID
       - Args: conversation_id, workspace_id
       - Verifies workspace membership
       - Fetches conversation with contact info
       - Returns conversation or null

    2. getByContact - get conversation for a contact
       - Args: contact_id, workspace_id
       - Verifies workspace membership
       - Uses by_contact index
       - Returns conversation or null

    Keep existing getByContact function (update if needed for new schema).
  </action>
  <verify>cat convex/conversations.ts | grep -E "(getById|getByContact)"</verify>
  <done>Conversation lookup queries available</done>
</task>

<task type="auto">
  <name>Create member and tag aggregation queries</name>
  <files>convex/conversations.ts</files>
  <action>
    Add to convex/conversations.ts helper queries for inbox sidebar:

    1. listMembers - get all workspace members with profiles
       - Args: workspace_id
       - Verifies workspace membership
       - Queries workspaceMembers by_workspace index
       - Returns array with user_id, role, profile (name, email, avatar)
       - Note: Profile data may need separate fetch from auth context

    2. listTags - collect all unique tags from contacts
       - Args: workspace_id
       - Verifies workspace membership
       - Queries contacts by_workspace index
       - Collects unique values from tags array
       - Returns array of unique tag strings

    These populate filter dropdowns in inbox.
  </action>
  <verify>cat convex/conversations.ts | grep -E "(listMembers|listTags)"</verify>
  <done>Member and tag aggregation queries available</done>
</task>

<task type="auto">
  <name>Create complex filter query for inbox</name>
  <files>convex/conversations.ts</files>
  <action>
    Add to convex/conversations.ts comprehensive inbox query:

    1. listWithFilters - single query for all inbox data
       - Args: workspace_id, filters (active, statusFilters, tagFilters, assignedTo), limit, page
       - Verifies workspace membership
       - Queries by_workspace_time index ordered DESC
       - Applies status filter if provided
       - Applies assignedTo filter (null for unassigned, user_id for specific user)
       - Note: tag filtering and active filter done client-side after query
       - Paginates with page * limit offset
       - Parallel fetches contacts for each conversation
       - Returns: conversations array, totalCount, activeCount, members, tags

    This matches /api/conversations route structure for easy API migration.
    Active count comes from separate countUnread query in parallel.
  </action>
  <verify>cat convex/conversations.ts | grep "listWithFilters"</verify>
  <done>Comprehensive inbox query with all filters available</done>
</task>

</tasks>

<verification>
1. listByWorkspace supports status, assignedTo, limit filters
2. countUnread and countAll queries exist
3. getById and getByContact lookup queries exist
4. listMembers and listTags aggregation queries exist
5. listWithFilters comprehensive query matches /api/conversations output
</verification>

<success_criteria>
1. All inbox query needs met by Convex functions
2. Queries use appropriate indexes (by_workspace_time, by_contact, by_workspace)
3. All queries include workspace authorization
4. Output structure matches Next.js API expectations
</success_criteria>

<output>
After completion, create `.planning/phases/05-implementation/05-03-SUMMARY.md`
</output>
