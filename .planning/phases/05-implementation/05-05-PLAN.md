---
phase: 05-implementation
plan: 05
type: execute
wave: 3
depends_on: [05-02, 05-03]
files_modified: [src/app/api/contacts/by-phone/route.ts, src/app/api/conversations/route.ts, src/app/api/messages/send/route.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "/api/contacts/by-phone uses Convex instead of Supabase"
    - "/api/conversations uses Convex instead of Supabase"
    - "/api/messages/send uses Convex instead of Supabase"
  artifacts:
    - path: "src/app/api/contacts/by-phone/route.ts"
      provides: "Contact lookup via Convex"
      pattern: "fetchQuery.*getContextByPhone"
    - path: "src/app/api/conversations/route.ts"
      provides: "Inbox conversations via Convex"
      pattern: "fetchQuery.*listByWorkspace"
    - path: "src/app/api/messages/send/route.ts"
      provides: "Message sending via Convex"
      pattern: "fetchMutation.*createMessage"
  key_links:
    - from: "src/app/api/contacts/by-phone/route.ts"
      to: "convex/contacts.ts"
      via: "fetchQuery(api.contacts.getContextByPhone)"
      pattern: "fetchQuery"
    - from: "src/app/api/conversations/route.ts"
      to: "convex/conversations.ts"
      via: "fetchQuery(api.conversations.listByWorkspace)"
      pattern: "fetchQuery"
    - from: "src/app/api/messages/send/route.ts"
      to: "convex/mutations.ts"
      via: "fetchMutation(api.createMessage)"
      pattern: "fetchMutation"
---

<objective>
Update Next.js API routes to use Convex instead of Supabase for hot path endpoints.

Purpose: Achieve sub-500ms response times by using Convex for contacts, conversations, and messages APIs.

Output: Updated API routes calling Convex functions via fetchQuery/fetchMutation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/api/contacts/by-phone/route.ts
@src/app/api/conversations/route.ts
@src/app/api/messages/send/route.ts
@convex/_generated/api.d.ts
@.planning/phases/05-implementation/05-02-PLAN.md
@.planning/phases/05-implementation/05-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Update /api/contacts/by-phone to use Convex</name>
  <files>src/app/api/contacts/by-phone/route.ts</files>
  <action>
    Update src/app/api/contacts/by-phone/route.ts to use Convex:

    1. Replace Supabase imports with Convex:
       - Remove: import { createApiAdminClient } from '@/lib/supabase/server'
       - Add: import { fetchQuery } from 'convex/_generated/reactClient'

    2. Update GET handler to use Convex:
       - Verify CRM_API_KEY header (keep as-is)
       - Normalize phone (keep as-is)
       - Call fetchQuery(api.contacts.getContextByPhone, { phone: normalizedPhone, workspace_id: workspaceId })
       - Remove Supabase queries (contacts, contact_notes, conversations, messages)
       - Return result from Convex directly (same structure)

    3. Remove summarizeConversation function (Convex returns recent_messages array)

    4. Keep timing instrumentation (withTiming wrapper)

    The Convex getContextByPhone already returns: { found, contact, notes, last_interaction, recent_messages }
    This matches the expected output structure exactly.

    Read existing route.ts, then write updated version using Convex.
  </action>
  <verify>grep "fetchQuery" src/app/api/contacts/by-phone/route.ts && ! grep "supabase" src/app/api/contacts/by-phone/route.ts</verify>
  <done>/api/contacts/by-phone uses Convex and returns sub-500ms</done>
</task>

<task type="auto">
  <name>Update /api/conversations to use Convex</name>
  <files>src/app/api/conversations/route.ts</files>
  <action>
    Update src/app/api/conversations/route.ts to use Convex:

    1. Replace imports:
       - Remove: import { createClient } from '@/lib/supabase/server'
       - Add: import { fetchQuery } from 'convex/_generated/reactClient'

    2. Update GET handler:
       - Verify workspace membership: fetchQuery(api.workspaceMembers.getByUserWorkspace, { workspace_id: workspaceId, user_id: userId })
         Note: Need to create getByUserWorkspace query or get userId from auth context
       - Call fetchQuery(api.conversations.listWithFilters, { workspace_id: workspaceId, page, limit, filters })
       - Remove Supabase queries for teamMembers, contactsWithTags
       - Return result directly (Convex returns same structure)

    3. Handle auth:
       - Keep requireWorkspaceMembership from auth or verify via Convex query
       - For now, use existing auth helper and pass user_id to Convex

    The Convex listWithFilters returns: { conversations, totalCount, activeCount, teamMembers, quickReplies, contactTags }
    This matches the current API structure.

    Note: Team member profiles may need separate fetch (profiles in Supabase, not in Convex)
  </action>
  <verify>grep "fetchQuery.*conversations" src/app/api/conversations/route.ts</verify>
  <done>/api/conversations uses Convex for inbox data</done>
</task>

<task type="auto">
  <name>Create workspace member query for authorization</name>
  <files>convex/workspaceMembers.ts</files>
  <action>
    Create convex/workspaceMembers.ts with authorization queries:

    1. getByUserWorkspace - verify membership and get role
       - Args: workspace_id, user_id
       - Queries by_user_workspace index
       - Returns: { membership, role, user_id }
       - Throws if not found

    2. listByWorkspace - list all members with profiles
       - Args: workspace_id
       - Verifies membership (caller is member)
       - Queries by_workspace index
       - Returns: array of { user_id, role, profile }
       - Note: Profile data from auth context (Supabase profiles table)

    This enables API routes to verify workspace membership via Convex.
  </action>
  <verify>cat convex/workspaceMembers.ts | grep "getByUserWorkspace"</verify>
  <done>Workspace member query functions created for authorization</done>
</task>

<task type="auto">
  <name>Update /api/messages/send to use Convex</name>
  <files>src/app/api/messages/send/route.ts</files>
  <action>
    Update src/app/api/messages/send/route.ts to use Convex:

    1. Replace imports:
       - Remove: import { createClient } from '@/lib/supabase/server'
       - Add: import { fetchMutation, fetchQuery } from 'convex/_generated/reactClient'

    2. Update POST handler:
       - Keep input validation (sendMessageSchema)
       - Get current user from auth (keep Supabase auth.getUser)
       - Rate limit check (keep as-is)
       - Fetch conversation via fetchQuery: fetchQuery(api.conversations.getById, { conversation_id: conversationId, workspace_id })
       - Get contact phone via fetchQuery: fetchQuery(api.contacts.getById, { contact_id: conversation.contact_id, workspace_id })
       - Send via Kapso (keep existing logic, Kapso API call unchanged)
       - Create message via fetchMutation: fetchMutation(api.createMessage, { conversation_id, workspace_id, content, direction: 'outbound', sender_type: 'user', sender_id: user.id, message_type: 'text', kapso_message_id })
       - Update conversation via fetchMutation: fetchMutation(api.updateConversationLastMessage, { conversation_id, workspace_id, last_message_at, last_message_preview })

    3. Keep Kapso API call and dev mode logic unchanged

    Kapso credentials come from workspace.settings (need to fetch from Convex or keep Supabase for settings)
    For fresh start, migrate kapso_phone_id and settings to Convex workspaces table.
  </action>
  <verify>grep "fetchMutation.*createMessage" src/app/api/messages/send/route.ts</verify>
  <done>/api/messages/send uses Convex for message storage</done>
</task>

<task type="auto">
  <name>Create workspace query for Kapso credentials</name>
  <files>convex/workspaces.ts</files>
  <action>
    Create convex/workspaces.ts with settings queries:

    1. getById - get workspace with settings
       - Args: workspace_id
       - Returns: { _id, name, slug, kapso_phone_id, settings }

    2. getBySlug - get workspace by slug (for routing)
       - Args: slug
       - Returns workspace or null

    3. getByKapsoPhoneId - get workspace for webhook
       - Args: kapso_phone_id
       - Uses by_kapso_phone index
       - Returns workspace or null

    These are used by webhook and Kapso integration.
  </action>
  <verify>cat convex/workspaces.ts | grep -E "(getById|getByKapsoPhoneId)"</verify>
  <done>Workspace queries available for Kapso integration</done>
</task>

</tasks>

<verification>
1. /api/contacts/by-phone calls fetchQuery(api.contacts.getContextByPhone)
2. /api/conversations calls fetchQuery(api.conversations.listWithFilters)
3. /api/messages/send calls fetchMutation(api.createMessage)
4. Workspace member queries exist for authorization
5. Workspace queries exist for Kapso credentials
</verification>

<success_criteria>
1. All hot path API routes use Convex instead of Supabase
2. Response time < 500ms (measured after deployment)
3. Authorization still verified via Supabase auth + Convex membership check
4. Kapso API calls unchanged (external service integration)
</success_criteria>

<output>
After completion, create `.planning/phases/05-implementation/05-05-SUMMARY.md`
</output>
