---
phase: 18-kapso-bot-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/contacts/by-phone/[phone]/route.ts
autonomous: true

must_haves:
  truths:
    - "Kapso function can fetch contact profile by phone number"
    - "API returns name, metadata, notes, and recent messages"
    - "API works without authentication (for Kapso function calls)"
  artifacts:
    - path: "src/app/api/contacts/by-phone/[phone]/route.ts"
      provides: "Contact lookup by phone endpoint"
      exports: ["GET"]
  key_links:
    - from: "Kapso sea-lion-reply function"
      to: "/api/contacts/by-phone/[phone]"
      via: "HTTP fetch"
      pattern: "fetch.*contacts/by-phone"
---

<objective>
Build contact lookup API for Kapso function CRM context integration.

Purpose: Enable the Kapso AI function to fetch contact profile data (name, metadata, notes, recent messages) before generating responses, so Kia can personalize replies based on CRM context.

Output: Public API endpoint at `/api/contacts/by-phone/[phone]` that returns contact profile data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-kapso-bot-setup/18-CONTEXT.md
@.planning/phases/18-kapso-bot-setup/18-RESEARCH.md

Reference existing patterns:
@src/app/api/contacts/[id]/route.ts
@src/app/api/contacts/[id]/notes/route.ts
@src/app/api/webhook/kapso/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact lookup API by phone</name>
  <files>src/app/api/contacts/by-phone/[phone]/route.ts</files>
  <action>
Create GET endpoint that looks up contact by phone number and returns profile data for AI context.

Request: `GET /api/contacts/by-phone/[phone]`
- Phone param should be URL-encoded (e.g., `628123456789`)
- No authentication required (Kapso function will call this)
- Require `X-API-Key` header matching `KAPSO_WEBHOOK_SECRET` env var for security

Response shape:
```json
{
  "found": true,
  "contact": {
    "id": "uuid",
    "name": "string|null",
    "phone": "string",
    "lead_status": "string",
    "lead_score": "number",
    "tags": ["string"],
    "metadata": {}
  },
  "notes": [
    { "content": "string", "created_at": "string" }
  ],
  "recent_messages": [
    { "direction": "inbound|outbound", "content": "string", "created_at": "string" }
  ]
}
```

If contact not found:
```json
{
  "found": false,
  "contact": null,
  "notes": [],
  "recent_messages": []
}
```

Implementation:
1. Parse phone from URL params
2. Validate X-API-Key header against KAPSO_WEBHOOK_SECRET
3. Clean phone number (remove non-digits) using cleanPhoneNumber from kapso client
4. Query contacts table by phone (workspace-agnostic for now - single workspace)
5. If found, fetch notes (limit 5, newest first)
6. If found, fetch messages from conversation (limit 10, newest first)
7. Return structured response

Use createApiAdminClient (not createClient) since this is server-to-server call.
  </action>
  <verify>
Test with curl:
```bash
curl -H "X-API-Key: $KAPSO_WEBHOOK_SECRET" \
  https://my21staff.vercel.app/api/contacts/by-phone/628123456789
```
Should return JSON with found, contact, notes, recent_messages fields.
  </verify>
  <done>
- API returns contact profile when phone exists in database
- API returns found:false when phone doesn't exist
- API rejects requests without valid X-API-Key
  </done>
</task>

</tasks>

<verification>
- [ ] GET /api/contacts/by-phone/[phone] returns contact data
- [ ] Response includes name, metadata, notes, recent_messages
- [ ] Invalid API key returns 401
- [ ] Non-existent phone returns found:false gracefully
</verification>

<success_criteria>
- Contact lookup API deployed and accessible from Kapso function
- API returns structured profile data for existing contacts
- API handles missing contacts gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/18-kapso-bot-setup/18-01-SUMMARY.md`
</output>
