---
phase: 18-kapso-bot-setup
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - .planning/phases/18-kapso-bot-setup/KAPSO-FUNCTION-sea-lion-reply.js
autonomous: false

must_haves:
  truths:
    - "Kia responds with Saya/Kak pronouns and NO emoji"
    - "Kia uses CRM context (name, form data, notes) when available"
    - "Kia escalates complex questions appropriately"
    - "AI handover toggle pauses/resumes Kia's responses"
  artifacts:
    - path: ".planning/phases/18-kapso-bot-setup/KAPSO-FUNCTION-sea-lion-reply.js"
      provides: "Updated Kapso function code"
      min_lines: 100
  key_links:
    - from: "KAPSO-FUNCTION-sea-lion-reply.js"
      to: "/api/contacts/by-phone"
      via: "fetch call in function"
      pattern: "fetch.*contacts/by-phone"
    - from: "Kapso workflow"
      to: "sea-lion-reply function"
      via: "Kapso platform trigger"
      pattern: "AI Auto-Reply workflow"
---

<objective>
Update Kapso function with new Kia persona and CRM context integration, then verify full flow.

Purpose: Deploy the refined Kia persona that uses CRM data for personalized responses, following the communication style from CONTEXT.md (Saya/Kak, no emoji, structured responses).

Output: Updated sea-lion-reply function code deployed to Kapso, full verification of message flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-kapso-bot-setup/18-CONTEXT.md
@.planning/phases/18-kapso-bot-setup/18-RESEARCH.md
@.planning/phases/08-sealion-kapso/PERSONA-kia-eagle-overseas.md
@brainstorm/eagle-overseas-bot-persona.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write updated Kapso function code</name>
  <files>.planning/phases/18-kapso-bot-setup/KAPSO-FUNCTION-sea-lion-reply.js</files>
  <action>
Create the updated sea-lion-reply function code file with:

1. **CRM Context Fetch:**
   - Function receives `phone` from Kapso workflow
   - Fetch contact profile from `https://my21staff.vercel.app/api/contacts/by-phone/{phone}`
   - Include X-API-Key header with env.KAPSO_WEBHOOK_SECRET
   - If found, include name, metadata, notes in system prompt

2. **New Kia Persona (from CONTEXT.md):**
   - Name: Kia, Virtual Intern Assistant at Eagle Overseas
   - Pronouns: Saya (self) + Kak (addressing leads)
   - Emoji: NONE at all
   - Tone: Casual tapi sopan
   - Uncertainty: "Bentar ya saya tanya tim dulu kak, nanti saya kabarin"

3. **Company Info (Eagle Overseas):**
   - Services: Global Placement, Akselerasi Bahasa, Career & Success
   - Destinations: UK, Australia, NZ, Germany
   - Visa success rate: 98%
   - CTAs: Book free consultation with Kak Utami, Register for webinar, Follow @iutamiii

4. **Escalation Rules:**
   - Explicit request to speak with someone
   - Complex visa/immigration questions
   - Complaints or issues
   - User seems frustrated
   - After 3 rounds of clarifying questions

5. **What NOT to do:**
   - Promise visa outcomes
   - Give legal/immigration advice
   - Discuss competitors
   - Share pricing (direct to consultation)
   - Use emoji
   - Be pushy

Include sample response formats from CONTEXT.md in the system prompt.

Use Sea Lion model: `aisingapore/Gemma-SEA-LION-v4-27B-IT`
Temperature: 0.8, max_tokens: 150 (slightly more for structured responses)
  </action>
  <verify>
File exists at `.planning/phases/18-kapso-bot-setup/KAPSO-FUNCTION-sea-lion-reply.js`
Function includes CRM fetch, new persona, and company info.
  </verify>
  <done>
- Function code written with CRM context integration
- Persona uses Saya/Kak, no emoji
- Company info and escalation rules included
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Deploy updated function to Kapso</action>
  <instructions>
1. Go to Kapso dashboard: https://app.kapso.ai/projects/2bdca4dd-e230-4a1a-8639-68f8595defa8
2. Navigate to Functions > sea-lion-reply
3. Replace the function code with the content from:
   `.planning/phases/18-kapso-bot-setup/KAPSO-FUNCTION-sea-lion-reply.js`
4. Add new secret if needed: `KAPSO_WEBHOOK_SECRET` (same value as in Vercel env)
5. Save and deploy the function
6. Test with sample input: `{"phone": "628123456789", "message": "Halo"}`
  </instructions>
  <resume-signal>Type "deployed" when function is updated in Kapso dashboard</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Kapso integration with Kia persona and CRM context</what-built>
  <how-to-verify>
**Full End-to-End Flow Verification:**

1. **Inbound Message Test:**
   - Send a WhatsApp message to the Kapso number from your phone
   - Expected: Message appears in CRM inbox within 5 seconds
   - Check: Vercel logs show webhook received

2. **AI Response Test:**
   - Send: "Halo, mau tanya tentang kuliah di Australia"
   - Expected: Kia responds with Saya/Kak style, NO emoji
   - Check: Response uses structured format (options or questions)

3. **CRM Context Test:**
   - If contact exists with name/notes, response should reference them
   - Example: "Halo Kak [Name]" instead of generic greeting

4. **Outbound from CRM Test:**
   - Open conversation in CRM inbox
   - Send a message from the CRM
   - Expected: Message delivered to WhatsApp
   - Check: Message appears on WhatsApp within 5 seconds

5. **AI Handover Test:**
   - Click "AI Nonaktif" toggle in inbox header
   - Send message from WhatsApp
   - Expected: NO AI response (human mode active)
   - Click "AI Aktif" toggle
   - Send another message
   - Expected: AI responds again
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Kapso function code includes CRM context fetch
- [ ] Function deployed to Kapso with new persona
- [ ] Inbound messages appear in CRM
- [ ] AI responds with Kia persona (Saya/Kak, no emoji)
- [ ] AI uses CRM context when available
- [ ] Outbound messages from CRM delivered
- [ ] Handover toggle works (pauses/resumes AI)
</verification>

<success_criteria>
- Full WhatsApp flow working: inbound, AI response, outbound, handover
- Kia persona matches CONTEXT.md specifications
- CRM context integrated into AI responses
</success_criteria>

<output>
After completion, create `.planning/phases/18-kapso-bot-setup/18-02-SUMMARY.md`
</output>
