---
phase: 04.2-inbox-rework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Active/All toggle displays with active count badge"
    - "Status filter shows as dropdown button with selected count"
    - "Tags filter shows as dropdown button with selected count"
    - "Filters update Convex query params when changed"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx"
      provides: "Full v2.0 filter bar"
      contains: "viewMode, setViewMode"
  key_links:
    - from: "viewMode state"
      to: "listWithFilters query"
      via: "active: viewMode === 'active'"
      pattern: "active: viewMode === 'active'"
    - from: "tagFilter state"
      to: "listWithFilters query"
      via: "tagFilters prop"
      pattern: "tagFilters: tagFilter.length > 0"
---

<objective>
Add v2.0 filter bar to inbox with Active/All toggle, Status dropdown, and Tags dropdown.

Purpose: Close UAT gap - user reported missing filter bar components that existed in v2.0.
Output: inbox-client.tsx with complete filter bar matching v2.0 reference at `git show e8f78bb`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/STATE.md
@planning/phases/04.2-inbox-rework/CONTEXT.md
@planning/phases/04.2-inbox-rework/04.2-UAT.md

Reference implementation:
@git show e8f78bb:src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter bar state and query params</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Add filter state and wire to Convex query:

1. Add imports:
   - `Mail, MailOpen, ChevronDown, Tag` from lucide-react
   - `Badge` from @/components/ui/badge
   - `cn` from @/lib/utils

2. Add state variables:
   - `viewMode`: 'active' | 'all' = 'active'
   - `tagFilter`: string[] = []

3. Update Convex query to include filters:
   ```tsx
   const data = useQuery(api.conversations.listWithFilters, {
     workspace_id: workspaceId as any,
     active: viewMode === 'active',
     statusFilters: statusFilter.length > 0 ? statusFilter : undefined,
     tagFilters: tagFilter.length > 0 ? tagFilter : undefined,
   })
   ```

4. Extract data from query response:
   ```tsx
   const activeCount = data?.activeCount ?? 0
   const contactTags = data?.tags ?? []
   ```

5. Add tag toggle handler:
   ```tsx
   const handleTagToggle = (tag: string) => {
     setTagFilter((prev) =>
       prev.includes(tag)
         ? prev.filter((t) => t !== tag)
         : [...prev, tag]
     )
   }
   ```

Reference: v2.0 inbox-client.tsx lines 23-58, 103-110
  </action>
  <verify>TypeScript compiles without errors: `npm run build` passes</verify>
  <done>viewMode and tagFilter state wired to Convex query, activeCount and tags extracted from response</done>
</task>

<task type="auto">
  <name>Task 2: Add Active/All toggle UI</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Replace the current search + filter icon layout with v2.0 filter bar.

1. Restructure header section:
   - Search input on its own row
   - Filter buttons row below with flex-wrap

2. Add Active/All toggle (rounded pill buttons):
   ```tsx
   <div className="flex items-center rounded-full bg-muted p-1">
     <button
       onClick={() => setViewMode('active')}
       className={cn(
         'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all',
         viewMode === 'active'
           ? 'bg-background text-foreground shadow-sm'
           : 'text-muted-foreground hover:text-foreground'
       )}
     >
       <Mail className="h-3.5 w-3.5" />
       Active
       {activeCount > 0 && (
         <span className="bg-primary text-primary-foreground px-1.5 py-0.5 rounded-full text-[10px]">
           {activeCount}
         </span>
       )}
     </button>
     <button
       onClick={() => setViewMode('all')}
       className={cn(
         'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all',
         viewMode === 'all'
           ? 'bg-background text-foreground shadow-sm'
           : 'text-muted-foreground hover:text-foreground'
       )}
     >
       <MailOpen className="h-3.5 w-3.5" />
       All
     </button>
   </div>
   ```

Reference: v2.0 inbox-client.tsx lines 224-257
  </action>
  <verify>Visual inspection: Active/All toggle renders with proper styling</verify>
  <done>Active/All toggle shows in filter bar, Active shows count badge when > 0</done>
</task>

<task type="auto">
  <name>Task 3: Convert Status filter to dropdown button style</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Convert existing status Popover from icon button to v2.0 dropdown button style:

1. Replace PopoverTrigger button with dropdown style:
   ```tsx
   <Popover>
     <PopoverTrigger asChild>
       <button
         className={cn(
           'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all',
           statusFilter.length > 0
             ? 'bg-primary text-primary-foreground'
             : 'bg-muted hover:bg-muted/80 text-muted-foreground'
         )}
       >
         <Filter className="h-3.5 w-3.5" />
         {statusFilter.length > 0 ? (
           <>
             {statusFilter.length} status{statusFilter.length > 1 ? 'es' : ''}
           </>
         ) : (
           'All Status'
         )}
         <ChevronDown className="h-3 w-3" />
       </button>
     </PopoverTrigger>
     {/* Keep existing PopoverContent */}
   </Popover>
   ```

2. Change PopoverContent align to "start":
   `<PopoverContent className="w-56" align="start">`

Reference: v2.0 inbox-client.tsx lines 259-299
  </action>
  <verify>Visual inspection: Status filter shows as text button not icon button</verify>
  <done>Status filter displays "All Status" or "N statuses" with ChevronDown</done>
</task>

<task type="auto">
  <name>Task 4: Add Tags filter dropdown</name>
  <files>src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
Add Tags filter dropdown matching v2.0 style:

```tsx
{/* Tag filter dropdown */}
{contactTags.length > 0 && (
  <Popover>
    <PopoverTrigger asChild>
      <button
        className={cn(
          'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all',
          tagFilter.length > 0
            ? 'bg-primary text-primary-foreground'
            : 'bg-muted hover:bg-muted/80 text-muted-foreground'
        )}
      >
        <Tag className="h-3.5 w-3.5" />
        {tagFilter.length > 0 ? (
          <>
            {tagFilter.length} tag{tagFilter.length > 1 ? 's' : ''}
          </>
        ) : (
          'All Tags'
        )}
        <ChevronDown className="h-3 w-3" />
      </button>
    </PopoverTrigger>
    <PopoverContent className="w-56" align="start">
      <div className="space-y-2">
        <p className="font-medium text-sm">Filter by tag</p>
        {contactTags.map((tag) => (
          <label
            key={tag}
            className="flex items-center gap-2 cursor-pointer"
          >
            <Checkbox
              checked={tagFilter.includes(tag)}
              onCheckedChange={() => handleTagToggle(tag)}
            />
            <Badge variant="secondary" className="text-xs">
              <Tag className="mr-1 h-3 w-3" />
              {tag}
            </Badge>
          </label>
        ))}
        {tagFilter.length > 0 && (
          <Button
            variant="ghost"
            size="sm"
            className="w-full mt-2"
            onClick={() => setTagFilter([])}
          >
            Clear tags
          </Button>
        )}
      </div>
    </PopoverContent>
  </Popover>
)}
```

Reference: v2.0 inbox-client.tsx lines 301-342
  </action>
  <verify>Visual inspection: Tags dropdown appears when contactTags exist</verify>
  <done>Tags filter dropdown shows with checkboxes for each tag, clear button when selected</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Visual inspection at http://localhost:3000/[workspace]/inbox:
   - Active/All toggle visible with pill button styling
   - Active shows count badge when unread conversations exist
   - Status filter shows as "All Status" dropdown button
   - Tags filter shows as "All Tags" dropdown button (if tags exist)
   - Clicking filters updates conversation list
</verification>

<success_criteria>
- Active/All toggle with count badge on Active button
- Status filter as dropdown button with "N statuses" or "All Status"
- Tags filter as dropdown button with "N tags" or "All Tags"
- All filters wire to Convex query and update list
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-inbox-rework/04.2-01-SUMMARY.md`
</output>
