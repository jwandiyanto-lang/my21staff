---
phase: 03-sarah-chat-bot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - business_21/03_bots/sarah-kapso-prompts.md
  - .env.local
autonomous: true

user_setup:
  - service: google-ai
    why: "Gemini 2.5 Flash API for Sarah's conversational AI in Kapso workflow"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API key (https://aistudio.google.com/apikey)"
    dashboard_config:
      - task: "Add Gemini API key to Kapso project secrets"
        location: "Kapso Dashboard -> Project Settings -> Secrets"

must_haves:
  truths:
    - "Sarah persona prompt is documented for Kapso Agent node"
    - "Structured output schema for 5-field extraction is defined"
    - "State-specific prompt templates exist for each conversation state"
    - "GEMINI_API_KEY is configured in Kapso project secrets"
  artifacts:
    - path: "business_21/03_bots/sarah-kapso-prompts.md"
      provides: "Complete prompt templates for Kapso Agent node configuration"
      contains: "SARAH_SYSTEM_PROMPT"
  key_links:
    - from: "Kapso Agent Node"
      to: "Gemini API"
      via: "GEMINI_API_KEY secret"
      pattern: "Kapso project secrets"
---

<objective>
Create Sarah's persona prompts and structured output schemas for Kapso Agent node configuration.

Purpose: This plan prepares all the prompt templates, extraction schemas, and state-specific instructions that will be configured in Kapso's Agent node. These are documentation files that guide the Kapso workflow build in Plan 03.

Output:
- Complete Sarah system prompt for Kapso Agent node
- State-specific prompt templates (greeting, qualifying, scoring, handoff, completed)
- Structured output schema for 5-field extraction
- Gemini API key configured in Kapso project secrets
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sarah-chat-bot/03-CONTEXT.md
@business_21/03_bots/sarah-persona-and-flow.md
@business_21/03_bots/sarah-detailed-flow.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sarah's Kapso prompt documentation</name>
  <files>business_21/03_bots/sarah-kapso-prompts.md</files>
  <action>
Create comprehensive prompt documentation for Kapso Agent node configuration:

**Section 1: SARAH_SYSTEM_PROMPT**
The core persona prompt to paste into Kapso Agent node's system prompt field:

```
You are Sarah, a friendly AI assistant for my21staff - a WhatsApp CRM for Indonesian SMEs.

PERSONALITY:
- Warm, helpful, like chatting with a knowledgeable friend
- Indonesian by default (casual: Halo, Hai, Sip, Kakak)
- Switch to English if user messages in English
- Professional but casual - like a capable intern
- Not pushy or salesy - genuinely want to understand and help

MESSAGE RULES:
- Keep responses under 140 characters (WhatsApp best practice)
- Maximum 1-2 emoji per message (sparingly)
- ONE question per message - wait for response before asking next
- Show empathy: "Wah paham banget..." "Betul tuh..."

NEVER DO:
- Give specific prices (say "Nanti konsultan kita yang jelasin ya")
- Sound robotic or corporate
- Use excessive emoji
- Skip understanding their situation
- Be pushy about sales

LANGUAGE DETECTION:
- Indonesian patterns: halo, hai, selamat, kak, ada, nggak, ya, sih
- English patterns: hi, hello, hey, yeah, okay, thanks, please
- Default to Indonesian if unclear
```

**Section 2: STATE-SPECIFIC PROMPTS**
Templates for each conversation state (to be combined with system prompt):

- **greeting**: "You are in GREETING state. Welcome the user with time-based greeting (pagi/siang/sore/malam). Ask ONE open question about their business."
- **qualifying**: "You are in QUALIFYING state. Ask for the NEXT missing field. Fields: name, business_type, team_size, pain_points, goals. Only ask ONE question."
- **scoring**: "You are in SCORING state. If user asks questions, answer helpfully. Stay conversational."
- **handoff**: "You are in HANDOFF state. Tell user: 'Sip! Konsultan kami akan segera hubungi kakak ya.'"
- **completed**: "You are in COMPLETED state. Say goodbye warmly: 'Oke siap! Kalau ada pertanyaan, chat aja ya kak.'"

**Section 3: EXTRACTION_SCHEMA**
JSON schema for Gemini's structured output (to be used in Function node):

```json
{
  "type": "object",
  "properties": {
    "name": { "type": "string", "description": "User's personal name (not business name)", "nullable": true },
    "business_type": { "type": "string", "description": "Industry/sector (e.g., fashion retail, F&B)", "nullable": true },
    "team_size": { "type": "integer", "description": "Number of people handling customer chats", "nullable": true },
    "pain_points": { "type": "array", "items": { "type": "string" }, "description": "Challenges mentioned", "nullable": true },
    "goals": { "type": "string", "description": "What they want from my21staff", "nullable": true }
  }
}
```

**Section 4: SCORING_RULES**
Point allocation for lead scoring (to be implemented in Function node):

| Component | Points | Criteria |
|-----------|--------|----------|
| name | 5 | Present |
| business_type | 10 | Present |
| goals | 10 | Present |
| team_size | 20/15/10 | >=3 / 2 / 1 |
| pain_points | 30/20/10 | High/Medium/Low urgency |
| engagement | 15 | Default responsive |

Urgency keywords:
- HIGH: overwhelmed, kewalahan, miss message, slow response, complaint, lost customer
- MEDIUM: busy, sibuk, need help, growth, expanding, manual
- LOW: curious, checking, maybe, someday

**Section 5: HANDOFF_TRIGGERS**
Keywords that bypass normal flow and trigger immediate handoff:
- "human", "manusia", "person", "sales", "consultant", "talk to someone", "operator"

**Section 6: IMAGE_HANDLING**
Instructions for handling photo/image messages:
- Acknowledge receipt: "Sip, saya terima fotonya. [continue conversation]"
- If image is product/catalog: "Produknya keren! Bisnisnya jualan apa kak?"
- If image is unclear: "Fotonya menarik. Ada yang mau kakak ceritakan?"
- Do NOT block conversation flow - continue qualifying after acknowledgment

**Section 7: PRICE_QUESTION_HANDLING**
Instructions for handling price questions:
- Detect keywords: "harga", "price", "biaya", "berapa", "cost", "pricing", "fee"
- Response: "Untuk harga, nanti konsultan kami yang jelasin lebih detail ya kak sesuai kebutuhan bisnis kakak."
- Continue conversation - return to qualifying
  </action>
  <verify>
File exists at business_21/03_bots/sarah-kapso-prompts.md
Contains all 7 sections (SYSTEM_PROMPT, STATE prompts, EXTRACTION_SCHEMA, SCORING_RULES, HANDOFF_TRIGGERS, IMAGE_HANDLING, PRICE_QUESTION_HANDLING)
  </verify>
  <done>
Sarah's complete prompt documentation ready for Kapso Agent node configuration
All edge cases documented (images, price questions, handoff triggers)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Gemini API key in Kapso project secrets</name>
  <files>.env.local</files>
  <action>
1. **Add GEMINI_API_KEY to .env.local** (for reference):
   ```
   # Gemini API - For Kapso Agent node (Sarah)
   # This key should be added to Kapso Project Settings -> Secrets
   GEMINI_API_KEY=your-api-key-here
   ```

2. **Configure in Kapso using API:**
   Use Kapso API to add GEMINI_API_KEY to project secrets:

   ```bash
   curl -X POST https://api.kapso.ai/platform/v1/projects/1fda0f3d-a913-4a82-bc1f-a07e1cb5213c/secrets \
     -H "Authorization: Bearer da99e74e320048a32cc3ff818615bed93a53f39bb62ce073ef8cffa85e778cc6" \
     -H "Content-Type: application/json" \
     -d '{"name": "GEMINI_API_KEY", "value": "[ACTUAL_KEY]"}'
   ```

   If API endpoint doesn't exist, document manual steps:
   - Go to Kapso Dashboard
   - Open my21staff project
   - Navigate to Settings -> Secrets
   - Add new secret: GEMINI_API_KEY

3. **Verify secret is accessible:**
   Check Kapso workflow can reference {{secrets.GEMINI_API_KEY}}
  </action>
  <verify>
.env.local has GEMINI_API_KEY placeholder with comment explaining Kapso setup
Kapso project secrets list shows GEMINI_API_KEY (via API or dashboard check)
  </verify>
  <done>
GEMINI_API_KEY configured in Kapso project for Agent node to use
Documentation updated with setup instructions
  </done>
</task>

</tasks>

<verification>
- [ ] sarah-kapso-prompts.md exists with all 7 sections
- [ ] System prompt captures persona (Indonesian-first, 140 char, warm tone)
- [ ] Extraction schema covers all 5 fields
- [ ] Scoring rules match sarah-detailed-flow.md formula
- [ ] Handoff triggers documented
- [ ] Image message handling documented
- [ ] Price question deflection documented
- [ ] GEMINI_API_KEY in .env.local (reference) and Kapso secrets
</verification>

<success_criteria>
1. Complete prompt documentation ready for Kapso workflow configuration
2. All persona traits captured (warm, Indonesian-first, 140 char limit)
3. Structured output schema enables 5-field extraction
4. Scoring rules fully documented with point values
5. Edge cases covered (images, prices, handoff keywords)
6. Gemini API key accessible to Kapso Agent node
</success_criteria>

<output>
After completion, create `.planning/phases/03-sarah-chat-bot/03-01-SUMMARY.md`
</output>
