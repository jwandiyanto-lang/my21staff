---
phase: 03-sarah-chat-bot
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Kapso workflow calls Sarah API on inbound messages"
    - "Sarah responds via WhatsApp with correct persona"
    - "Conversation state persists in Convex across messages"
    - "Hot leads trigger handoff state transition"
  artifacts: []
  key_links:
    - from: "Kapso workflow"
      to: "/api/sarah/process"
      via: "HTTP Function node"
      pattern: "Function node calling Sarah API"
---

<objective>
Connect Sarah to Kapso workflow and verify end-to-end WhatsApp conversation flow.

Purpose: This plan integrates Sarah into the existing Kapso workflow from Phase 2, replacing or augmenting the basic Grok AI fallback with the full Sarah conversation engine. After this plan, real WhatsApp messages will be handled by Sarah.

Output:
- Kapso workflow updated to call Sarah API
- End-to-end test verified via real WhatsApp message
- Documentation of Kapso workflow configuration
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-sarah-chat-bot/03-CONTEXT.md
@.planning/phases/02-workflow-rules-engine/02-03-SUMMARY.md
@.kapso-project.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Kapso workflow to call Sarah API</name>
  <files></files>
  <action>
Modify the existing Kapso workflow "Rules Engine - Keyword Triggers" to route messages to Sarah:

**Workflow ID:** 6cae069e-7d5c-4fbb-834d-79e1f66e4672

**Current flow (from Phase 2):**
1. Inbound message trigger
2. AI decide node (Grok) for intent classification
3. Paths: handoff, manager, FAQ, ai_fallback (Grok agent)

**Updated flow:**
1. Keep existing trigger and AI decide node
2. Modify the "ai_fallback" path to call Sarah instead of Grok:
   - Add **Function node** (HTTP request to Sarah API)
   - URL: `https://[vercel-deployment-url]/api/sarah/process`
   - Method: POST
   - Body:
     ```json
     {
       "workspace_id": "{{trigger.workspace_id}}",
       "contact_id": "{{trigger.contact.id}}",
       "contact_phone": "{{trigger.contact.phone}}",
       "message": "{{trigger.message.content}}"
     }
     ```
   - Parse response and send `response` field as WhatsApp message

3. If Function node fails, fallback to basic Grok response (error handling)

**Option B (if Function node not available):**
Use Kapso's **Agent node** with custom instructions to call the Sarah API. Set system prompt to:
"You are a proxy. Call the Sarah API at [url] with the user message and return the response verbatim."

**Kapso API Reference:**
- Project ID: `1fda0f3d-a913-4a82-bc1f-a07e1cb5213c`
- API Key: `da99e74e320048a32cc3ff818615bed93a53f39bb62ce073ef8cffa85e778cc6`
- API Endpoint: `https://api.kapso.so/platform/v1/workflows/{workflow_id}`

Use Kapso API to update workflow or update via Kapso dashboard UI.
  </action>
  <verify>
Check Kapso workflow shows the updated node
Test with echo message to verify function node calls the API
  </verify>
  <done>
Kapso workflow updated to route ai_fallback messages to Sarah API
Function node configured with correct URL and body mapping
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and test Sarah API endpoint</name>
  <files></files>
  <action>
Ensure Sarah API is deployed and accessible:

1. **Local testing first:**
   - Run `npm run dev`
   - Test: `curl http://localhost:3000/api/sarah/health`
   - Test with mock message

2. **Deploy to Vercel:**
   - Commit all Plan 01-03 changes
   - Push to master (auto-deploys to Vercel)
   - Wait for deployment to complete

3. **Add GEMINI_API_KEY to Vercel:**
   - Vercel Dashboard -> Project -> Settings -> Environment Variables
   - Add: GEMINI_API_KEY = [user's API key]
   - Redeploy if needed

4. **Test deployed endpoint:**
   - `curl https://[vercel-url]/api/sarah/health`
   - Verify returns 200 OK

5. **Update Kapso workflow URL:**
   - Replace localhost with production Vercel URL
   - URL format: `https://my21staff.vercel.app/api/sarah/process` (or custom domain)
  </action>
  <verify>
Production health endpoint returns 200
Kapso workflow points to production URL
  </verify>
  <done>
Sarah API deployed to Vercel
GEMINI_API_KEY environment variable configured
Kapso workflow uses production URL
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Sarah chat bot integration with Kapso WhatsApp workflow:
- Sarah API endpoint at /api/sarah/process
- Kapso workflow calling Sarah for ai_fallback messages
- Convex state storage for conversations
  </what-built>
  <how-to-verify>
**Test the complete flow by sending real WhatsApp messages:**

1. **Send greeting:**
   Send "Halo" to +62 813-1859-025
   - Expected: Sarah responds with Indonesian greeting + business question
   - Example: "Selamat siang! Sarah disini. Bisnis kakak ngelola sendiri atau ada team ya?"

2. **Test data extraction:**
   Reply with "Ada team, 3 orang, jualan baju online"
   - Expected: Sarah acknowledges and asks next question (pain points or goals)
   - Check Convex: ariConversations should show extracted data

3. **Test language switch:**
   Send "Hi, I'm interested"
   - Expected: Sarah switches to English
   - Example: "Hi there! Sarah here. What kind of business do you run?"

4. **Test handoff keyword:**
   Send "I want to talk to a human"
   - Expected: Handoff response triggers (may route to existing handoff path)

5. **Verify Convex state:**
   Check Convex dashboard -> ariConversations table
   - New conversation record exists
   - state field shows correct state
   - context.collected has extracted data
   - lead_score calculated

**Expected persona traits:**
- Under 140 characters per message
- Indonesian by default, switches to English if user uses English
- 1-2 emoji max (not excessive)
- Warm, helpful tone (not robotic or pushy)
  </how-to-verify>
  <resume-signal>Type "approved" if Sarah responds correctly with correct persona and data extraction, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Kapso workflow updated with Sarah integration
- [ ] Sarah API deployed to Vercel
- [ ] GEMINI_API_KEY configured in Vercel
- [ ] Real WhatsApp message triggers Sarah response
- [ ] Sarah persona correct (Indonesian, <140 chars, warm tone)
- [ ] Data extraction working (visible in Convex)
- [ ] Language switching works (Indonesian <-> English)
</verification>

<success_criteria>
1. WhatsApp messages to +62 813-1859-025 trigger Sarah (not just Grok)
2. Sarah's responses match persona (warm, Indonesian-first, 140 char limit)
3. Conversation state persists in Convex ariConversations
4. Lead scoring calculates correctly based on extracted data
5. Handoff keywords trigger appropriate response
</success_criteria>

<output>
After completion, create `.planning/phases/03-sarah-chat-bot/03-04-SUMMARY.md`
</output>
