---
phase: 03-sarah-chat-bot
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Sarah responds to WhatsApp messages via Kapso workflow"
    - "Sarah persona is warm, Indonesian-first, under 140 chars"
    - "5-field data extraction works across messages"
    - "Lead scoring returns appropriate temperature"
    - "Image messages get acknowledged"
    - "Price questions get deflected"
    - "Handoff keywords trigger handoff"
    - "State persists in Convex across messages"
  artifacts: []
  key_links:
    - from: "WhatsApp message"
      to: "Sarah workflow"
      via: "Kapso trigger"
      pattern: "Inbound message -> Sarah Chat Bot workflow"
---

<objective>
Connect Sarah workflow to existing Rules Engine and verify end-to-end WhatsApp conversation flow.

Purpose: This plan wires Sarah into the live WhatsApp flow and verifies everything works together. After this plan, real WhatsApp messages to +62 813-1859-025 will be handled by Sarah (via Kapso).

Output:
- Rules Engine workflow updated to route to Sarah
- End-to-end WhatsApp test verified
- Sarah persona confirmed working
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-sarah-chat-bot/03-CONTEXT.md
@.planning/phases/02-workflow-rules-engine/02-03-SUMMARY.md
@.kapso-project.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Rules Engine to route to Sarah workflow</name>
  <files></files>
  <action>
Modify the existing "Rules Engine - Keyword Triggers" workflow to call Sarah workflow instead of the Grok ai_fallback:

**Current Rules Engine workflow (from Phase 2):**
- Workflow ID: `6cae069e-7d5c-4fbb-834d-79e1f66e4672`
- Has "ai_fallback" path that uses Grok Agent

**Update needed:**
Replace the Grok Agent on ai_fallback path with a "Call Workflow" node that triggers Sarah Chat Bot workflow.

**Option 1: Use Kapso "Execute Workflow" node (if available)**
```bash
curl -X PATCH https://api.kapso.ai/platform/v1/workflows/6cae069e-7d5c-4fbb-834d-79e1f66e4672/nodes/{ai_fallback_node_id} \
  -H "Authorization: Bearer da99e74e320048a32cc3ff818615bed93a53f39bb62ce073ef8cffa85e778cc6" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "execute_workflow",
    "config": {
      "workflow_id": "[SARAH_WORKFLOW_ID]",
      "pass_context": true
    }
  }'
```

**Option 2: Replace ai_fallback with Sarah workflow trigger**
If Kapso doesn't support calling workflows from workflows, update the Sarah workflow to also be triggered by the same inbound trigger, but with a condition (not handoff, not manager, not FAQ).

**Option 3: Direct replacement**
Replace the entire Rules Engine's ai_fallback Agent node with Sarah workflow's Agent node configuration.

Choose the option that Kapso supports. The goal is: when a message doesn't match handoff/manager/FAQ, it goes to Sarah.
  </action>
  <verify>
Rules Engine workflow shows Sarah integration
ai_fallback path triggers Sarah workflow
  </verify>
  <done>
Rules Engine routes unmatched messages to Sarah Chat Bot workflow
Handoff, manager, FAQ paths still work as before
  </done>
</task>

<task type="auto">
  <name>Task 2: Activate Sarah workflow and test trigger</name>
  <files></files>
  <action>
**1. Activate Sarah workflow:**
```bash
curl -X POST https://api.kapso.ai/platform/v1/workflows/{sarah_workflow_id}/activate \
  -H "Authorization: Bearer da99e74e320048a32cc3ff818615bed93a53f39bb62ce073ef8cffa85e778cc6"
```

**2. Verify workflow is active:**
```bash
curl https://api.kapso.ai/platform/v1/workflows/{sarah_workflow_id} \
  -H "Authorization: Bearer da99e74e320048a32cc3ff818615bed93a53f39bb62ce073ef8cffa85e778cc6"
```
Check status is "active".

**3. Test with manual trigger (if available):**
Use Kapso dashboard to manually trigger Sarah workflow with test payload:
```json
{
  "contact": {
    "phone": "+62000000000",
    "name": "Test User"
  },
  "message": {
    "content": "Halo",
    "type": "text"
  }
}
```

Verify response matches Sarah persona (Indonesian greeting, <140 chars).
  </action>
  <verify>
Workflow status is "active"
Manual test returns Sarah-style response
  </verify>
  <done>
Sarah workflow activated and responding
Manual trigger confirms Gemini + persona working
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Sarah Chat Bot integrated with Kapso workflow:
- Kapso workflow "Sarah Chat Bot" with Gemini 2.5 Flash Agent
- Function nodes for state management, scoring, Convex persistence
- Rules Engine updated to route to Sarah
- State stored in Convex for dashboard access
  </what-built>
  <how-to-verify>
**Test the complete flow by sending real WhatsApp messages to +62 813-1859-025:**

**Test 1: Initial greeting (Indonesian)**
Send: "Halo"
- Expected: Sarah responds with Indonesian greeting + business question
- Check: Response is under 140 characters, has 1-2 emoji max, warm tone
- Example: "Selamat siang! Sarah disini. Bisnis kakak ngelola sendiri atau ada team ya?"

**Test 2: Data extraction**
Reply: "Ada team, 3 orang, jualan baju online"
- Expected: Sarah acknowledges and asks next question (pain points or goals)
- Check Convex: sarahConversations table has extracted data (team_size: 3, business_type visible)

**Test 3: Language switch**
Send: "Hi, I'm interested"
- Expected: Sarah switches to English
- Example: "Hi there! Sarah here. What kind of business do you run?"

**Test 4: Image handling**
Send an image/photo
- Expected: Sarah acknowledges image and continues conversation
- Example: "Sip, saya terima fotonya. Produknya keren! Bisnisnya jualan apa kak?"
- NOT: Silence or error

**Test 5: Price question deflection**
Send: "Berapa harga?"
- Expected: Sarah deflects to consultant
- Example: "Untuk harga, nanti konsultan kami yang jelasin lebih detail ya kak."
- NOT: Specific prices

**Test 6: Handoff keyword**
Send: "I want to talk to a human"
- Expected: Handoff response (may route to existing handoff path)
- Check Convex: state should be "handoff"

**Test 7: State persistence**
Wait 1 minute, then send another message
- Expected: Sarah remembers previous conversation, doesn't restart from greeting
- Check: She asks for next missing field, not "what's your business?"

**Verify in Convex Dashboard:**
- Open Convex dashboard -> Data -> sarahConversations
- Find conversation by phone number
- Confirm fields populated: state, lead_score, lead_temperature, extracted_data, message_count

**Expected persona traits (all tests):**
- Under 140 characters per message
- Indonesian by default, switches to English if user uses English
- 1-2 emoji max (not excessive)
- Warm, helpful tone (not robotic or pushy)
- Never gives specific prices
  </how-to-verify>
  <resume-signal>Type "approved" if all 7 tests pass, or describe specific issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Rules Engine routes ai_fallback to Sarah
- [ ] Sarah workflow is active
- [ ] WhatsApp messages trigger Sarah (not old Grok)
- [ ] Sarah persona correct (Indonesian, <140 chars, warm)
- [ ] Data extraction works (visible in Convex)
- [ ] Language switching works (Indonesian <-> English)
- [ ] Image messages acknowledged
- [ ] Price questions deflected
- [ ] Handoff keywords trigger handoff
- [ ] State persists across messages (Convex)
</verification>

<success_criteria>
1. Real WhatsApp messages to +62 813-1859-025 trigger Sarah
2. Sarah's responses match persona (warm, Indonesian-first, 140 char limit)
3. All 5 fields can be extracted through conversation
4. Lead scoring calculates and stores in Convex
5. Image messages handled gracefully
6. Price questions deflected to consultant
7. Handoff keywords trigger handoff state
8. Conversation state persists across messages
</success_criteria>

<output>
After completion, create `.planning/phases/03-sarah-chat-bot/03-04-SUMMARY.md`
</output>
