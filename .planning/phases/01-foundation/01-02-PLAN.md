---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Implement auth middleware and login/signup pages with Supabase authentication.

Purpose: Enable user authentication so the app can verify users before accessing protected routes.
Output: Working login/signup flow with session management and route protection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Reference v1 for patterns:**
@~/Desktop/21/my21staff/src/middleware.ts
@~/Desktop/21/my21staff/src/app/(auth)/login/page.tsx
@~/Desktop/21/my21staff/src/app/(auth)/signup/page.tsx
@~/Desktop/21/my21staff/src/app/auth/callback/route.ts

**Available from Plan 01:**
- src/lib/supabase/config.ts (multi-env config)
- src/lib/supabase/server.ts (server client)
- src/lib/supabase/client.ts (browser client)
- Shadcn UI components (button, card, input, label)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth middleware for session management</name>
  <files>src/middleware.ts</files>
  <action>
    Copy middleware.ts from v1 with these features:
    1. Create Supabase server client with cookie handling for request/response
    2. Refresh session if expired via supabase.auth.getUser()
    3. Define public routes: /login, /signup, /forgot-password, /auth/callback, /api/webhook, /forms (public form pages)
    4. Redirect unauthenticated users to /login (except public routes and /api/ routes)
    5. Redirect authenticated users away from /login and /signup to /dashboard

    Use the matcher config to exclude static files:
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'

    Import getSupabaseConfig from '@/lib/supabase/config'
    Use createServerClient from '@supabase/ssr'
  </action>
  <verify>Visit /dashboard without auth, should redirect to /login</verify>
  <done>Middleware active, unauthenticated users redirected, session refresh working</done>
</task>

<task type="auto">
  <name>Task 2: Create login and signup pages</name>
  <files>src/app/(auth)/login/page.tsx, src/app/(auth)/signup/page.tsx, src/app/(auth)/layout.tsx</files>
  <action>
    1. Create src/app/(auth)/layout.tsx - simple layout wrapper for auth pages (just renders children)

    2. Create src/app/(auth)/login/page.tsx - copy from v1:
       - 'use client' component with useState for email, password, loading, error
       - Uses createClient() from '@/lib/supabase/client'
       - handleLogin calls supabase.auth.signInWithPassword()
       - On success: router.push('/dashboard') and router.refresh()
       - On error: display error message
       - UI: Card with CardHeader, CardContent, CardFooter
       - Link to /signup at bottom

    3. Create src/app/(auth)/signup/page.tsx - similar to login:
       - Add full_name field
       - Call supabase.auth.signUp() with options.data.full_name
       - Show success message about verification email (or auto-redirect if email confirm disabled)
       - Link to /login at bottom
  </action>
  <verify>Navigate to /login, form renders correctly with styling</verify>
  <done>Login and signup pages render, forms functional, navigation works</done>
</task>

<task type="auto">
  <name>Task 3: Create auth callback route</name>
  <files>src/app/auth/callback/route.ts</files>
  <action>
    Create src/app/auth/callback/route.ts for OAuth/magic link flows:
    1. GET handler that reads 'code' from URL params
    2. If code exists: exchange for session using supabase.auth.exchangeCodeForSession()
    3. Redirect to /dashboard on success, /login?error=... on failure
    4. Use createClient() from '@/lib/supabase/server'

    This handles the redirect after email verification or OAuth providers.

    Pattern from v1:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export async function GET(request: Request) {
      const requestUrl = new URL(request.url)
      const code = requestUrl.searchParams.get('code')
      const origin = requestUrl.origin

      if (code) {
        const supabase = await createClient()
        await supabase.auth.exchangeCodeForSession(code)
      }

      return NextResponse.redirect(`${origin}/dashboard`)
    }
    ```
  </action>
  <verify>Auth callback route exists, TypeScript compiles</verify>
  <done>Auth callback handles code exchange, redirects appropriately</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auth flow with middleware, login/signup pages, and callback handling</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/dashboard - should redirect to /login
    3. Visit: http://localhost:3000/login - should show login form with styled card
    4. Visit: http://localhost:3000/signup - should show signup form
    5. Click links between login/signup - navigation should work
    6. Confirm: No console errors, pages styled correctly with orange/neutral theme
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] Middleware redirects work correctly
- [ ] Login page renders with proper styling
- [ ] Signup page renders with proper styling
- [ ] Auth callback route exists
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Auth flow functional (even if Supabase not connected yet)
- Ready for database schema (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` following the summary template.
</output>
