---
phase: 01-foundation
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/webhook-verification.ts
  - src/app/api/webhooks/whatsapp/route.ts
autonomous: true
user_setup: []
---

<objective>
Create the WhatsApp webhook endpoint that receives message events from Kapso.

**Purpose:** This endpoint is the message ingestion point for all inbound WhatsApp messages. It must verify signatures, acknowledge receipt within 10 seconds, and route events to appropriate handlers.

**Output:**
- `src/lib/webhook-verification.ts` - HMAC-SHA256 signature verification utility
- `src/app/api/webhooks/whatsapp/route.ts` - Webhook endpoint (Next.js App Router)
- Endpoint responds to GET (verification) and POST (events) requests

</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-RESEARCH.md

**Key requirements:**
- HMAC-SHA256 signature verification (timing-safe comparison)
- Must respond within 10 seconds (acknowledge first, process async)
- Handle `X-Idempotency-Key` header to prevent duplicate processing
- Support GET request for webhook verification challenge
- Support POST requests with `whatsapp.message.received` events

**Environment variables needed:**
- `WEBHOOK_SECRET` - HMAC secret for signature verification (set in Plan 03)
- `WEBHOOK_VERIFY_TOKEN` - Token for GET verification challenge (set in Plan 03)

**Structure:**
```
src/
├── lib/
│   └── webhook-verification.ts    # HMAC verification utility
└── app/
    └── api/
        └── webhooks/
            └── whatsapp/
                └── route.ts       # POST + GET handlers
```

</context>

<tasks>

<task type="auto">
  <name>Create webhook verification utility</name>
  <files>src/lib/webhook-verification.ts</files>
  <action>
    Create a TypeScript module for HMAC-SHA256 webhook signature verification.

    Use timing-safe comparison to prevent timing attacks:

    ```typescript
    import crypto from 'crypto'

    export function verifyWebhookSignature(
      payload: string | object,
      signature: string | null,
      secret: string
    ): boolean {
      if (!signature) {
        return false
      }

      const payloadString = typeof payload === 'string'
        ? payload
        : JSON.stringify(payload)

      const expectedSignature = crypto
        .createHmac('sha256', secret)
        .update(payloadString)
        .digest('hex')

      try {
        return crypto.timingSafeEqual(
          Buffer.from(signature),
          Buffer.from(expectedSignature)
        )
      } catch {
        // Buffer mismatch (different lengths)
        return false
      }
    }

    export function generateSignature(payload: string | object, secret: string): string {
      const payloadString = typeof payload === 'string'
        ? payload
        : JSON.stringify(payload)

      return crypto
        .createHmac('sha256', secret)
        .update(payloadString)
        .digest('hex')
    }
    ```

    Export the functions for use in the route handler.
  </action>
  <verify>
    `ls -la src/lib/webhook-verification.ts` exists
    TypeScript compiles without errors
  </verify>
  <done>
    HMAC-SHA256 verification utility ready for webhook endpoint
  </done>
</task>

<task type="auto">
  <name>Create webhook endpoint route</name>
  <files>src/app/api/webhooks/whatsapp/route.ts</files>
  <action>
    Create the Next.js App Router route handler for WhatsApp webhooks.

    Requirements:
    1. Export `GET` handler for webhook verification challenge
    2. Export `POST` handler for incoming events
    3. Verify signatures in production (not required in dev mode)
    4. Acknowledge immediately (within 10 seconds)
    5. Log all received events for debugging

    ```typescript
    import { NextRequest, NextResponse } from 'next/server'
    import { verifyWebhookSignature } from '@/lib/webhook-verification'

    // Track processed idempotency keys (in-memory for dev, use Redis/database in prod)
    const processedKeys = new Set<string>()

    // Event type definitions
    interface WebhookEvent {
      event: string
      data: {
        message?: {
          id: string
          timestamp: string
          type: string
          kapso?: {
            direction: string
            status: string
            content: string
          }
        }
        conversation?: {
          id: string
          phone_number: string
          phone_number_id: string
          status: string
        }
        is_new_conversation?: boolean
        phone_number_id: string
      }
      timestamp: string
    }

    export async function GET(req: NextRequest) {
      // Handle webhook verification challenge from Meta/Kapso
      const { searchParams } = new URL(req.url)
      const mode = searchParams.get('hub.mode')
      const token = searchParams.get('hub.verify_token')
      const challenge = searchParams.get('hub.challenge')

      if (mode === 'subscribe' && token === process.env.WEBHOOK_VERIFY_TOKEN) {
        console.log('Webhook verified successfully')
        return new Response(challenge, { status: 200 })
      }

      return new Response('Invalid verification token', { status: 403 })
    }

    export async function POST(req: NextRequest) {
      const signature = req.headers.get('x-webhook-signature')
      const idempotencyKey = req.headers.get('x-idempotency-key')

      // Check idempotency key (prevent duplicate processing)
      if (idempotencyKey && processedKeys.has(idempotencyKey)) {
        console.log('Duplicate event detected:', idempotencyKey)
        return NextResponse.json({ status: 'already processed' }, { status: 200 })
      }

      const body = await req.json()

      // Verify signature in production
      if (process.env.NODE_ENV === 'production') {
        const isValid = verifyWebhookSignature(
          body,
          signature,
          process.env.WEBHOOK_SECRET || ''
        )
        if (!isValid) {
          console.error('Invalid webhook signature')
          return NextResponse.json({ error: 'Invalid signature' }, { status: 401 })
        }
      }

      const webhook = body as WebhookEvent

      // Log received event
      console.log('Webhook received:', {
        event: webhook.event,
        phone_number_id: webhook.data?.phone_number_id,
        timestamp: webhook.timestamp,
      })

      // Handle different event types
      switch (webhook.event) {
        case 'whatsapp.message.received':
          console.log('New message received:', {
            from: webhook.data?.conversation?.phone_number,
            content: webhook.data?.message?.kapso?.content,
            message_id: webhook.data?.message?.id,
          })
          // TODO: Phase 2 - Store to Convex, trigger workflow
          break

        case 'whatsapp.message.sent':
          console.log('Message sent:', webhook.data?.message?.id)
          break

        case 'whatsapp.conversation.created':
          console.log('New conversation:', webhook.data?.conversation?.id)
          break

        case 'whatsapp.conversation.inactive':
          console.log('Conversation ended:', webhook.data?.conversation?.id)
          break

        default:
          console.log('Unknown event type:', webhook.event)
      }

      // Mark idempotency key as processed
      if (idempotencyKey) {
        processedKeys.add(idempotencyKey)
      }

      // Acknowledge immediately (within 10 seconds)
      return NextResponse.json({ received: true }, { status: 200 })
    }
    ```

    Create the directory structure first:
    ```bash
    mkdir -p src/app/api/webhooks/whatsapp
    ```
  </action>
  <verify>
    `ls -la src/app/api/webhooks/whatsapp/route.ts` exists
    `npm run build` or `npx tsc --noEmit` passes
  </verify>
  <done>
    Webhook endpoint ready to receive WhatsApp events
  </done>
</task>

</tasks>

<verification>
1. Build compiles without errors
2. TypeScript types are correct
3. GET handler responds to verification challenge
4. POST handler returns 200 with { received: true }

In dev mode (NEXT_PUBLIC_DEV_MODE=true):
- Webhook accepts events without signature verification
- Logs appear in console
</verification>

<success_criteria>
1. [ ] `src/lib/webhook-verification.ts` created with HMAC-SHA256 verification
2. [ ] `src/app/api/webhooks/whatsapp/route.ts` created with GET + POST handlers
3. [ ] Build succeeds without errors
4. [ ] Dev mode bypasses signature verification
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`

Summary must include:
- Files created/modified
- Webhook endpoint URL (when deployed)
- Dev mode behavior documented
</output>
