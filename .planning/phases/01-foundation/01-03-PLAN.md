---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Set up database schema, TypeScript types, and dashboard shell with workspace architecture.

Purpose: Establish the data layer and basic dashboard structure that all features depend on.
Output: Database schema ready for Supabase, typed queries, and working dashboard layout.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Reference v1 for patterns:**
@~/Desktop/21/my21staff/supabase/schema.sql
@~/Desktop/21/my21staff/src/types/database.ts
@~/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/layout.tsx
@~/Desktop/21/my21staff/src/app/(dashboard)/dashboard/page.tsx
@~/Desktop/21/my21staff/src/components/dashboard/sidebar.tsx
@~/Desktop/21/my21staff/src/components/workspace/workspace-selector.tsx

**Available from previous plans:**
- Supabase config (multi-env)
- Auth middleware + pages
- Shadcn UI components
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema</name>
  <files>supabase/schema.sql</files>
  <action>
    Create supabase/schema.sql - copy core tables from v1 (simplified for v2 scope):

    **Required tables:**
    1. workspaces - id, name, slug, owner_id, kapso_phone_id, settings, created_at, updated_at
    2. workspace_members - id, workspace_id, user_id, role, created_at
    3. contacts - id, workspace_id, phone, name, email, lead_score, lead_status, tags, metadata, created_at, updated_at
    4. conversations - id, workspace_id, contact_id, status, assigned_to, unread_count, last_message_at, last_message_preview, created_at, updated_at
    5. messages - id, conversation_id, workspace_id, direction, sender_type, sender_id, content, message_type, media_url, kapso_message_id, metadata, created_at
    6. profiles - id (refs auth.users), email, full_name, avatar_url, is_admin, created_at, updated_at

    **Include:**
    - UUID extension
    - All indexes from v1
    - RLS policies for multi-tenant access (workspace-scoped)
    - Trigger: handle_new_user() for profile creation on signup
    - Trigger: update_updated_at() for timestamp management
    - Helper function: get_workspace_by_phone_id() for webhook routing

    **Skip for v2 (out of scope):**
    - knowledge_base, flows (automation)
    - sources, student_notes, custom_fields (education-specific)
    - google_sheets_syncs, activity_logs, user_todos

    Add comment at top: "-- Run this in Supabase SQL Editor after project setup"
  </action>
  <verify>SQL syntax is valid (no obvious errors)</verify>
  <done>Schema file exists with core tables, RLS policies, triggers, functions</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript database types</name>
  <files>src/types/database.ts</files>
  <action>
    Create src/types/database.ts matching the schema - copy structure from v1 but only include tables from Task 1:

    1. Define Database interface with public.Tables containing:
       - workspaces (Row, Insert, Update)
       - workspace_members (Row, Insert, Update)
       - contacts (Row, Insert, Update)
       - conversations (Row, Insert, Update)
       - messages (Row, Insert, Update)
       - profiles (Row, Insert, Update)

    2. Define Functions: get_workspace_by_phone_id

    3. Export convenience types:
       - Workspace, Contact, Conversation, Message, Profile
       - ConversationWithContact (Conversation & { contact: Contact })
       - MessageWithSender (Message & { sender?: Profile })

    This provides type safety for all Supabase queries.

    The Supabase clients in lib/supabase/server.ts and client.ts should import this type:
    `createServerClient<Database>` / `createBrowserClient<Database>`
  </action>
  <verify>TypeScript compiles, Supabase clients use Database type</verify>
  <done>Database types complete, Supabase clients typed, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 3: Create dashboard shell with workspace layout</name>
  <files>src/app/(dashboard)/layout.tsx, src/app/(dashboard)/dashboard/page.tsx, src/app/(dashboard)/[workspace]/layout.tsx</files>
  <action>
    1. Create src/app/(dashboard)/layout.tsx:
       - Simple wrapper layout for all dashboard routes
       - Can add Toaster or providers here later

    2. Create src/app/(dashboard)/dashboard/page.tsx:
       - Landing page after login
       - For v2 MVP: Show simple "Select a workspace" message or list workspaces
       - This is where workspace selector will redirect from

    3. Create src/app/(dashboard)/[workspace]/layout.tsx:
       - Workspace-scoped layout
       - Will eventually have sidebar navigation
       - For now: Simple div wrapper that renders children
       - The [workspace] param is the workspace slug

    Keep these minimal - just enough structure to navigate. Full sidebar and workspace logic comes in Phase 2+.

    Pattern:
    ```tsx
    // src/app/(dashboard)/[workspace]/layout.tsx
    export default function WorkspaceLayout({
      children,
      params,
    }: {
      children: React.ReactNode
      params: { workspace: string }
    }) {
      return (
        <div className="min-h-screen bg-background">
          {/* Sidebar will go here in future phase */}
          <main className="flex-1">{children}</main>
        </div>
      )
    }
    ```
  </action>
  <verify>Navigate to /dashboard - renders without error</verify>
  <done>Dashboard structure exists, workspace routes ready for features</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete foundation: database schema, types, and dashboard shell</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Run: npm run build - should succeed with no errors
    3. Check: supabase/schema.sql exists with all tables
    4. Check: src/types/database.ts has typed interfaces
    5. Visit: /dashboard after login - should render
    6. Confirm: TypeScript has no errors in VS Code / editor
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] `npm run build` succeeds
- [ ] supabase/schema.sql contains all required tables and policies
- [ ] src/types/database.ts properly typed
- [ ] Dashboard routes exist and render
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Phase 1 complete - foundation ready for Phase 2 (Database View)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` following the summary template.

**Phase 1 complete marker:** This is the final plan for Phase 1.
</output>
