---
phase: 01-foundation
plan: "03"
type: execute
wave: 2
depends_on:
  - "01-01"
  - "01-02"
files_modified: []
autonomous: false
user_setup:
  - service: kapso
    why: "Workflow trigger creation requires Kapso Dashboard access"
    dashboard_config:
      - task: "Create workflow trigger for inbound messages"
        location: "Kapso Dashboard -> Workflows -> Create Trigger"
---

<objective>
Configure the workflow trigger for inbound messages and verify end-to-end message reception.

**Purpose:** Connects the webhook endpoint to Kapso's workflow engine so that incoming messages trigger automated processing. Final verification proves the entire pipeline works.

**Output:**
- Webhook configured on the phone number
- Workflow trigger for `whatsapp.message.received` events
- Test message verified in system logs

</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**What must exist before this plan:**
- Kapso customer ID (from Plan 01)
- Phone number ID connected to customer (from Plan 01)
- Webhook endpoint deployed and accessible (from Plan 02)

**Steps:**
1. Configure webhook on the phone number
2. Create workflow trigger for inbound messages
3. Send test message and verify in logs

**API endpoints to use:**
- `POST /whatsapp/phone_numbers/{phone_number_id}/webhooks` - Register webhook
- `POST /workflows/{workflow_id}/triggers` - Create trigger (if workflow exists)

</context>

<tasks>

<task type="auto">
  <name>Configure webhook on phone number</name>
  <files>none</files>
  <action>
    Register the webhook endpoint with the Kapso phone number.

    Read the customer and phone IDs:
    ```bash
    cat .kapso-customer.env
    ```

    Create the webhook registration:

    ```bash
    curl --request POST \
      --url "https://api.kapso.ai/platform/v1/whatsapp/phone_numbers/${KAPSO_PHONE_ID}/webhooks" \
      --header 'Content-Type: application/json' \
      --header 'X-API-Key: ${KAPSO_API_KEY}' \
      --data '{
        "whatsapp_webhook": {
          "url": "https://yourapp.com/api/webhooks/whatsapp",
          "events": [
            "whatsapp.message.received",
            "whatsapp.message.sent",
            "whatsapp.conversation.created",
            "whatsapp.conversation.inactive"
          ],
          "enabled": true
        }
      }'
    ```

    Replace `https://yourapp.com` with the actual deployment URL. For local testing, use ngrok or cloudflared tunnel URL.

    Save the webhook configuration:
    ```bash
    echo "KAPSO_WEBHOOK_URL=https://yourapp.com/api/webhooks/whatsapp" >> .kapso-customer.env
    ```
  </action>
  <verify>
    `curl` returns 201 with webhook configuration
    Response includes `id` and `status: active`
  </verify>
  <done>
    Webhook endpoint registered on the Indonesian phone number
  </done>
</task>

<task type="auto">
  <name>Create workflow trigger for inbound messages</name>
  <files>none</files>
  <action>
    Create a workflow trigger that fires on `whatsapp.message.received` events.

    **Option A: If using Kapso Dashboard (recommended for Phase 1):**
    1. Visit Kapso Dashboard -> Workflows
    2. Create new workflow with "WhatsApp Inbound" trigger
    3. Link the trigger to the phone number ID from Plan 01
    4. Set trigger to fire on `whatsapp.message.received` event

    **Option B: Via API (if workflow ID is known):**

    ```bash
    # First, list available workflows
    curl --request GET \
      --url "https://api.kapso.ai/platform/v1/workflows" \
      --header 'X-API-Key: ${KAPSO_API_KEY}'
    ```

    Then create the trigger:

    ```bash
    curl --request POST \
      --url "https://api.kapso.ai/platform/v1/workflows/${WORKFLOW_ID}/triggers" \
      --header 'Content-Type: application/json' \
      --header 'X-API-Key: ${KAPSO_API_KEY}' \
      --data '{
        "workflow_trigger": {
          "name": "my21staff inbound message",
          "event_type": "whatsapp.message.received",
          "phone_number_ids": ["${KAPSO_PHONE_ID}"],
          "enabled": true
        }
      }'
    ```

    For Phase 1, the trigger can be minimal — just logging the event. The actual workflow processing will be built in Phase 2.
  </action>
  <verify>
    Webhook is configured (events array contains message.received)
    Trigger is linked to the phone number
  </verify>
  <done>
    Workflow trigger configured to fire on inbound WhatsApp messages
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify end-to-end message reception</name>
  <what-built>
    Complete pipeline: Kapso workspace → Indonesian number → Webhook → Workflow trigger
  </what-built>
  <how-to-verify>
    **Step 1: Ensure webhook endpoint is accessible**
    - For local testing: Start ngrok: `ngrok http 3000`
    - Note the ngrok URL (e.g., https://abc123.ngrok.io)
    - Update webhook URL via API if needed

    **Step 2: Start dev server and monitor logs**
    ```bash
    npm run dev
    # Keep terminal visible - logs will appear here
    ```

    **Step 3: Send a test message**
    - Send a WhatsApp message to the Indonesian number from your personal phone
    - Or ask someone else to send a message

    **Step 4: Verify in logs**
    Look for console output:
    ```
    Webhook received: { event: 'whatsapp.message.received', ... }
    New message received: { from: '+62xxx', content: 'Hello', ... }
    ```

    **Step 5: Verify in Kapso Dashboard**
    - Check that the message appears in the inbox
    - Check that workflow trigger fired (if visible in dashboard)
  </how-to-verify>
  <resume-signal>
    Type "approved" if test message appeared in logs and Kapso Dashboard
    Describe issues if message was not received
  </resume-signal>
</task>

</tasks>

<verification>
1. Webhook registered on phone number with correct events enabled
2. Workflow trigger created (or dashboard configuration documented)
3. Test message received and logged by webhook endpoint
4. Message visible in Kapso Dashboard inbox
</verification>

<success_criteria>
1. [ ] Webhook endpoint configured on Indonesian phone number
2. [ ] Workflow trigger fires on `whatsapp.message.received` events
3. [ ] Test message received and logged successfully
4. [ ] Message visible in Kapso Dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`

Summary must include:
- Webhook URL registered
- Workflow trigger ID (if created via API)
- Test message verification (timestamp, sender, content)
- Any issues encountered
</output>
---
user_setup_details:
  - step: "Deploy webhook endpoint to Vercel"
    instruction: "Push changes to master branch, Vercel auto-deploys. Verify at https://your-project.vercel.app/api/webhooks/whatsapp"
    blocking: false
  - step: "Configure workflow trigger in Kapso Dashboard"
    instruction: "Kapso Dashboard -> Workflows -> Create Trigger -> WhatsApp Inbound -> Select phone number"
    blocking: true
  - step: "Send test WhatsApp message"
    instruction: "Send a message from any phone to +62 number, observe logs"
    blocking: true
</success_criteria
