---
phase: 12-sarah-template-system
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - business/bots/SARAH-TEMPLATE.md
  - business/bots/kapso-load-config-function.js
autonomous: true

must_haves:
  truths:
    - "Sarah configuration is documented with all settings and defaults"
    - "Kapso workflow integration is documented with code example"
    - "Developer can duplicate Sarah for new workspace using template"
  artifacts:
    - path: "business/bots/SARAH-TEMPLATE.md"
      provides: "Complete Sarah bot template documentation"
      min_lines: 100
    - path: "business/bots/kapso-load-config-function.js"
      provides: "Copy-paste Kapso function node code"
      min_lines: 30
  key_links:
    - from: "business/bots/kapso-load-config-function.js"
      to: "Convex HTTP endpoint"
      via: "fetch call to getConfigByPhone"
      pattern: "fetch.*sarah.*config"
---

<objective>
Document Sarah configuration as a reusable template for new workspaces.

Purpose: Enable developers to quickly set up Sarah for new workspaces using documented template and Kapso integration code.
Output: SARAH-TEMPLATE.md documentation and Kapso function node code for config loading.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-sarah-template-system/12-RESEARCH.md
@.planning/phases/12-sarah-template-system/12-01-SUMMARY.md
@.planning/phases/12-sarah-template-system/12-02-SUMMARY.md

# Existing Sarah documentation
@business/bots/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sarah Template Documentation</name>
  <files>business/bots/SARAH-TEMPLATE.md</files>
  <action>
Create comprehensive Sarah bot template documentation at `business/bots/SARAH-TEMPLATE.md`.

**Document structure:**

```markdown
# Sarah Bot Template

Template for setting up Sarah AI assistant for new workspaces.

## Overview

Sarah is the lead qualification bot for my21staff. She greets WhatsApp contacts, qualifies them through conversational questions, and hands off to humans when ready.

## Configuration Settings

### Customer-Editable Settings (via Dashboard)

| Setting | Field | Type | Default | Description |
|---------|-------|------|---------|-------------|
| Bot Name | bot_name | string | "Your Intern" | Display name in conversations |
| Language | language | enum | "id" | "id" (Indonesian) or "en" (English) |
| Pronoun | pronoun | enum | "Kamu" | "Kamu" (casual) or "Anda" (formal) |
| Trial Link | trial_link | url | https://my21staff.com/trial | Link sent to qualified leads |

### System Settings (Developer Only)

These settings are in the Kapso workflow and not customer-editable:

| Setting | Value | Location |
|---------|-------|----------|
| Model | grok-3-mini | Kapso AI Agent node |
| Max Tokens | 150 | Kapso AI Agent node |
| Temperature | 0.7 | Kapso AI Agent node |
| Workflow ID | 65762c7d-8ab0-4122-810e-9a5562a7a9ca | Kapso Dashboard |

## Persona Prompt

The system prompt that defines Sarah's personality:

[Include the current Sarah prompt from Phase 10 - reference business/bots/SARAH-PERSONA.md if exists]

Key characteristics:
- Indonesian first, English if detected
- Conversational, warm, helpful
- Under 140 characters per message
- NO emojis
- Uses customer's chosen pronoun (Kamu/Anda)

## Kapso Workflow Setup

### Workflow Structure

```
[start] -> [load-config] -> [sarah_agent] -> [send_trial_link]
```

1. **start**: Triggered by incoming WhatsApp message
2. **load-config**: Function node that fetches workspace config from Convex
3. **sarah_agent**: AI agent with dynamic system prompt
4. **send_trial_link**: Sends trial link when qualification complete

### Adding load-config Function Node

See `kapso-load-config-function.js` for the function code.

In Kapso Dashboard:
1. Open workflow editor
2. Add "Function" node after start
3. Paste code from kapso-load-config-function.js
4. Configure environment variable: CONVEX_DEPLOYMENT_URL
5. Connect output to sarah_agent node
6. Update sarah_agent to use {{vars.system_prompt}}

## Duplicating Sarah for New Workspace

### Prerequisites

1. Workspace created in my21staff
2. Kapso phone number connected to workspace
3. kapso_phone_id stored in workspaces table

### Steps

1. **Copy Kapso Workflow**
   - In Kapso Dashboard, duplicate the Sarah workflow
   - Note the new workflow ID
   - Assign to new phone number

2. **Configure Default Settings**
   - New workspaces automatically get default Sarah config
   - Customer can customize via Dashboard > Team page

3. **Verify Integration**
   - Send test WhatsApp message to new number
   - Verify Sarah responds with correct persona
   - Check config loads (view Kapso execution logs)

## Troubleshooting

### Config Not Loading

1. Check kapso_phone_id is set in workspaces table
2. Verify load-config function node is before sarah_agent
3. Check Convex logs for getConfigByPhone errors

### Wrong Language/Pronoun

1. Customer may not have saved config - defaults apply
2. Ask customer to save settings even if using defaults
3. Check config in Convex Dashboard > sarahConfigs table

### Trial Link Not Sent

1. Verify trial_link is valid HTTPS URL
2. Check send_trial_link node uses {{vars.trial_link}}
3. Test with Kapso's "Test" feature

## API Reference

### Convex Endpoints

| Function | Type | Args | Returns |
|----------|------|------|---------|
| sarah.config.getConfig | query | workspace_id | Config object |
| sarah.config.updateConfig | mutation | workspace_id, bot_name, language, pronoun, trial_link | { success, configId } |
| sarah.config.getConfigByPhone | query | phone_id | Config object (for Kapso) |

### Config Object Shape

```typescript
{
  bot_name: string,      // 1-50 chars
  language: "id" | "en",
  pronoun: "Kamu" | "Anda",
  trial_link: string,    // https:// URL
  created_at: number,
  updated_at: number,
}
```
```
  </action>
  <verify>
1. File exists: `ls business/bots/SARAH-TEMPLATE.md`
2. Document has all sections: Overview, Configuration, Kapso Workflow, Duplication Steps
  </verify>
  <done>SARAH-TEMPLATE.md created with complete documentation</done>
</task>

<task type="auto">
  <name>Task 2: Create Kapso Function Node Code</name>
  <files>business/bots/kapso-load-config-function.js</files>
  <action>
Create `business/bots/kapso-load-config-function.js` with the Kapso function node code for loading config.

**Code template:**

```javascript
/**
 * Kapso Function Node: load-config
 *
 * Loads Sarah configuration from Convex based on phone_number_id.
 * Place this node between [start] and [sarah_agent] in the workflow.
 *
 * Environment Variables Required:
 * - CONVEX_DEPLOYMENT_URL: e.g., "https://intent-otter-212.convex.site"
 *
 * Output Variables (available to downstream nodes):
 * - vars.bot_name
 * - vars.language
 * - vars.pronoun
 * - vars.trial_link
 * - vars.system_prompt (pre-built prompt with config applied)
 */

// Default configuration (used if Convex lookup fails)
const DEFAULT_CONFIG = {
  bot_name: "Your Intern",
  language: "id",
  pronoun: "Kamu",
  trial_link: "https://my21staff.com/trial",
};

// Build system prompt with config values
function buildSystemPrompt(config) {
  const languageInstructions = config.language === "id"
    ? "Respond in Indonesian (Bahasa Indonesia)."
    : "Respond in English.";

  const pronounInstruction = config.language === "id"
    ? `Use "${config.pronoun}" as the pronoun for addressing the customer.`
    : "";

  return `You are ${config.bot_name}, a friendly AI assistant for lead qualification.

${languageInstructions}
${pronounInstruction}

Your personality:
- Warm and conversational
- Keep messages under 140 characters
- NO emojis ever
- Ask one question at a time
- Qualify leads by understanding their business needs

When qualification is complete, the trial link is: ${config.trial_link}`;
}

// Main handler function
async function handler(request, env) {
  try {
    const { execution_context } = await request.json();

    // Extract phone_number_id from Kapso context
    const phoneNumberId = execution_context?.conversation?.phone_number_id;

    if (!phoneNumberId) {
      console.log("No phone_number_id in context, using defaults");
      return buildResponse(DEFAULT_CONFIG);
    }

    // Fetch config from Convex
    const convexUrl = env.CONVEX_DEPLOYMENT_URL || "https://intent-otter-212.convex.site";
    const apiUrl = `${convexUrl}/api/query`;

    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        path: "sarah/config:getConfigByPhone",
        args: { phone_id: phoneNumberId },
      }),
    });

    if (!response.ok) {
      console.error("Convex API error:", response.status);
      return buildResponse(DEFAULT_CONFIG);
    }

    const result = await response.json();
    const config = result.value || DEFAULT_CONFIG;

    return buildResponse(config);

  } catch (error) {
    console.error("load-config error:", error);
    return buildResponse(DEFAULT_CONFIG);
  }
}

function buildResponse(config) {
  return new Response(JSON.stringify({
    vars: {
      bot_name: config.bot_name,
      language: config.language,
      pronoun: config.pronoun,
      trial_link: config.trial_link,
      system_prompt: buildSystemPrompt(config),
    },
  }), {
    headers: { "Content-Type": "application/json" },
  });
}

// Export for Kapso
export default { fetch: handler };
```

**Important notes in comments:**
- Graceful degradation: always returns DEFAULT_CONFIG on any error
- No authentication required: phone_id itself is the auth key
- Logging for debugging (visible in Kapso execution logs)
  </action>
  <verify>
1. File exists: `ls business/bots/kapso-load-config-function.js`
2. Code is syntactically valid JavaScript
  </verify>
  <done>kapso-load-config-function.js created with complete function code</done>
</task>

<task type="auto">
  <name>Task 3: Update existing Sarah persona documentation if exists</name>
  <files>business/bots/SARAH-PERSONA.md (if exists)</files>
  <action>
Check if business/bots/SARAH-PERSONA.md exists:
- If exists: Add reference to SARAH-TEMPLATE.md for configuration settings
- If not exists: Skip this task (SARAH-TEMPLATE.md is sufficient)

If updating, add a section at the top:

```markdown
> **Configuration:** See [SARAH-TEMPLATE.md](./SARAH-TEMPLATE.md) for customer-editable settings and Kapso integration.
```

Also verify business/bots/ directory exists. If not, create it.
  </action>
  <verify>
1. Directory exists: `ls -la business/bots/`
2. Both files present: SARAH-TEMPLATE.md, kapso-load-config-function.js
  </verify>
  <done>
- business/bots/ directory contains Sarah documentation
- SARAH-TEMPLATE.md provides complete setup guide
- kapso-load-config-function.js provides copy-paste Kapso code
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `ls business/bots/` shows SARAH-TEMPLATE.md and kapso-load-config-function.js
2. SARAH-TEMPLATE.md covers: settings, Kapso workflow, duplication steps
3. Function code handles errors gracefully with defaults
4. Documentation matches actual implementation from Plans 01 and 02
</verification>

<success_criteria>
- SARAH-TEMPLATE.md exists with complete documentation (100+ lines)
- kapso-load-config-function.js exists with working function code
- A developer can follow the documentation to set up Sarah for a new workspace
- Kapso function code can be copy-pasted into Kapso Dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/12-sarah-template-system/12-03-SUMMARY.md`
</output>
