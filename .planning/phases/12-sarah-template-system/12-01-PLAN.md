---
phase: 12-sarah-template-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/sarah/config.ts
autonomous: true

must_haves:
  truths:
    - "sarahConfigs table exists with workspace_id index"
    - "getConfig query returns default config for new workspaces"
    - "updateConfig mutation creates or updates config"
  artifacts:
    - path: "convex/schema.ts"
      provides: "sarahConfigs table definition"
      contains: "sarahConfigs: defineTable"
    - path: "convex/sarah/config.ts"
      provides: "Query and mutation for Sarah config"
      exports: ["getConfig", "updateConfig", "getConfigByPhone"]
  key_links:
    - from: "convex/sarah/config.ts"
      to: "sarahConfigs"
      via: "Convex queries with workspace_id index"
      pattern: 'withIndex\\("by_workspace"'
---

<objective>
Create Convex backend for Sarah configuration storage and retrieval.

Purpose: Enable per-workspace Sarah bot customization with 4 basic settings (bot name, language, pronoun, trial link).
Output: Schema table and Convex API endpoints for config CRUD operations.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-sarah-template-system/12-RESEARCH.md

# Existing patterns
@convex/schema.ts
@convex/settingsBackup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sarahConfigs table to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add sarahConfigs table to schema.ts after the existing botConfig table (around line 673).

Table definition:
```typescript
// ============================================
// SARAH CONFIGS (Customer-editable Sarah bot settings)
// ============================================
sarahConfigs: defineTable({
  workspace_id: v.id("workspaces"),
  bot_name: v.string(),        // Display name, default "Your Intern"
  language: v.string(),        // "id" | "en"
  pronoun: v.string(),         // "Kamu" | "Anda" (Indonesian formality)
  trial_link: v.string(),      // URL to trial signup
  created_at: v.number(),
  updated_at: v.number(),
})
  .index("by_workspace", ["workspace_id"]),
```

Follow existing codebase patterns:
- Use v.id("workspaces") for workspace_id (not v.string)
- Use v.string() for all string fields (not union literals - keep validation in application layer)
- Include created_at/updated_at timestamps
- Add index for efficient workspace queries
  </action>
  <verify>Run `npx convex dev` and verify schema push succeeds without errors</verify>
  <done>sarahConfigs table appears in Convex dashboard with by_workspace index</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex query and mutation for Sarah config</name>
  <files>convex/sarah/config.ts</files>
  <action>
Create new file `convex/sarah/config.ts` with three functions following settingsBackup.ts patterns.

**Default config values:**
```typescript
const DEFAULT_CONFIG = {
  bot_name: "Your Intern",
  language: "id",
  pronoun: "Kamu",
  trial_link: "https://my21staff.com/trial",
};
```

**1. getConfig query:**
- Args: workspace_id (v.id("workspaces"))
- Returns config if exists, otherwise returns DEFAULT_CONFIG
- Use withIndex("by_workspace") for efficient lookup

**2. updateConfig mutation:**
- Args: workspace_id, bot_name, language, pronoun, trial_link
- Upsert pattern: check if config exists, patch if yes, insert if no
- Set updated_at on every update, created_at only on insert
- Return { success: true, configId }

**3. getConfigByPhone query (for Kapso integration):**
- Args: phone_id (v.string()) - the Kapso phone_number_id
- First lookup workspace by kapso_phone_id using by_kapso_phone index
- Then lookup sarahConfigs by workspace_id
- Return config or DEFAULT_CONFIG if not found
- This enables Kapso function node to fetch config without workspace_id

Include validation:
- bot_name: 1-50 chars
- language: must be "id" or "en"
- pronoun: must be "Kamu" or "Anda"
- trial_link: must be valid URL (starts with https://)

Throw clear error messages on validation failures.
  </action>
  <verify>
Run these commands:
1. `npx convex dev` - verify file compiles
2. Check Convex dashboard Functions tab - verify getConfig, updateConfig, getConfigByPhone appear
  </verify>
  <done>All three Convex functions deployed and visible in dashboard</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Convex dashboard shows sarahConfigs table in Data tab
2. Functions tab shows sarah/config module with 3 functions
3. No TypeScript errors in convex/ directory
</verification>

<success_criteria>
- sarahConfigs table exists with workspace_id index
- getConfig returns default values for new workspaces
- updateConfig creates or updates configuration
- getConfigByPhone enables Kapso integration via phone_id lookup
</success_criteria>

<output>
After completion, create `.planning/phases/12-sarah-template-system/12-01-SUMMARY.md`
</output>
