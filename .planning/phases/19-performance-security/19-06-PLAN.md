---
phase: 19-performance-security
plan: 06
type: execute
wave: 3
depends_on: []
files_modified:
  - src/app/api/webhook/kapso/route.ts
  - src/lib/kapso/verify-signature.ts
autonomous: true

must_haves:
  truths:
    - "Webhook rejects requests without valid Kapso signature"
    - "Signature verification uses HMAC-SHA256"
  artifacts:
    - path: "src/lib/kapso/verify-signature.ts"
      provides: "Signature verification helper"
    - path: "src/app/api/webhook/kapso/route.ts"
      provides: "Verified webhook handler"
      contains: "verifyKapsoSignature"
---

<objective>
Add webhook signature verification for Kapso webhooks

Purpose: Prevent forged webhook payloads from being accepted
Output: Webhook only processes requests signed by Kapso
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create signature verification helper</name>
  <files>src/lib/kapso/verify-signature.ts</files>
  <action>
    Create a helper to verify Kapso webhook signatures using HMAC-SHA256.

    Kapso sends signature in `X-Kapso-Signature` header as hex-encoded HMAC-SHA256.

    ```typescript
    import crypto from 'crypto'

    export function verifyKapsoSignature(
      payload: string,
      signature: string | null,
      secret: string
    ): boolean {
      if (!signature || !secret) return false

      const expectedSignature = crypto
        .createHmac('sha256', secret)
        .update(payload)
        .digest('hex')

      // Use timing-safe comparison to prevent timing attacks
      try {
        return crypto.timingSafeEqual(
          Buffer.from(signature),
          Buffer.from(expectedSignature)
        )
      } catch {
        return false
      }
    }
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Add signature verification to webhook</name>
  <files>src/app/api/webhook/kapso/route.ts</files>
  <action>
    Update the webhook handler to verify signatures before processing.

    1. Get raw body as string (before JSON parse)
    2. Get signature from header
    3. Get webhook secret from environment variable
    4. Verify signature before processing
    5. Return 401 if invalid

    Add at top of POST handler:
    ```typescript
    // Get raw body for signature verification
    const rawBody = await request.text()
    const signature = request.headers.get('x-kapso-signature')
    const webhookSecret = process.env.KAPSO_WEBHOOK_SECRET

    if (webhookSecret && !verifyKapsoSignature(rawBody, signature, webhookSecret)) {
      console.error('[Webhook] Invalid signature')
      return NextResponse.json({ error: 'Invalid signature' }, { status: 401 })
    }

    // Parse body after verification
    const body = JSON.parse(rawBody)
    ```

    Note: Only verify if KAPSO_WEBHOOK_SECRET is configured (graceful degradation for dev)
  </action>
</task>

</tasks>

<verification>
1. grep "verifyKapsoSignature" src/app/api/webhook/kapso/route.ts
2. File exists: src/lib/kapso/verify-signature.ts
3. npm run build passes
</verification>
