---
phase: 19-performance-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/workspace-auth.ts
  - src/app/api/conversations/[id]/assign/route.ts
  - src/app/api/workspaces/[id]/settings/route.ts
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Any authenticated user cannot access other workspaces' conversations"
    - "Any authenticated user cannot modify other workspaces' settings"
    - "DEV_MODE cannot bypass auth in production environment"
  artifacts:
    - path: "src/lib/auth/workspace-auth.ts"
      provides: "Reusable workspace authorization helper"
      exports: ["requireWorkspaceMembership"]
    - path: "src/app/api/conversations/[id]/assign/route.ts"
      provides: "Authorization-protected conversation assignment"
      contains: "requireWorkspaceMembership"
    - path: "src/app/api/workspaces/[id]/settings/route.ts"
      provides: "Authorization-protected workspace settings"
      contains: "requireWorkspaceMembership"
  key_links:
    - from: "src/app/api/conversations/[id]/assign/route.ts"
      to: "src/lib/auth/workspace-auth.ts"
      via: "import requireWorkspaceMembership"
      pattern: "requireWorkspaceMembership"
    - from: "src/middleware.ts"
      to: "process.env.NODE_ENV"
      via: "production check"
      pattern: "NODE_ENV.*production"
---

<objective>
Fix critical authorization vulnerabilities in API routes

Purpose: Close security holes where authenticated users can access/modify resources outside their workspace
Output: All workspace-scoped API routes properly verify membership before allowing operations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-performance-security/19-RESEARCH.md

@src/lib/supabase/server.ts
@src/app/api/messages/send/route.ts (example of proper authorization pattern)
@src/app/api/conversations/[id]/assign/route.ts (needs fix)
@src/app/api/workspaces/[id]/settings/route.ts (needs fix)
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable workspace authorization helper</name>
  <files>src/lib/auth/workspace-auth.ts</files>
  <action>
    Create a new file `src/lib/auth/workspace-auth.ts` with a reusable helper function:

    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export interface AuthResult {
      user: { id: string; email: string }
      workspaceId: string
    }

    export async function requireWorkspaceMembership(
      workspaceId: string
    ): Promise<AuthResult | NextResponse> {
      const supabase = await createClient()

      // Get current user
      const { data: { user }, error: authError } = await supabase.auth.getUser()

      if (authError || !user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      // Verify workspace membership
      const { data: membership } = await supabase
        .from('workspace_members')
        .select('id')
        .eq('workspace_id', workspaceId)
        .eq('user_id', user.id)
        .single()

      if (!membership) {
        return NextResponse.json(
          { error: 'Not authorized to access this workspace' },
          { status: 403 }
        )
      }

      return { user: { id: user.id, email: user.email || '' }, workspaceId }
    }
    ```

    This helper combines auth check + workspace membership verification in one call, returning either the auth result or a NextResponse error.
  </action>
  <verify>File exists at src/lib/auth/workspace-auth.ts and exports requireWorkspaceMembership</verify>
  <done>Helper function created and ready for use in API routes</done>
</task>

<task type="auto">
  <name>Task 2: Fix authorization in assign and settings routes</name>
  <files>src/app/api/conversations/[id]/assign/route.ts, src/app/api/workspaces/[id]/settings/route.ts</files>
  <action>
    **For /api/conversations/[id]/assign/route.ts:**

    1. Import the helper: `import { requireWorkspaceMembership } from '@/lib/auth/workspace-auth'`
    2. After getting conversationId, first fetch the conversation to get workspace_id
    3. Call requireWorkspaceMembership with the workspace_id
    4. Return early if it returns NextResponse (error case)
    5. Continue with existing logic

    The pattern:
    ```typescript
    // Fetch conversation to get workspace_id
    const { data: conversation } = await supabase
      .from('conversations')
      .select('workspace_id')
      .eq('id', conversationId)
      .single()

    if (!conversation) {
      return NextResponse.json({ error: 'Conversation not found' }, { status: 404 })
    }

    // Verify workspace access
    const authResult = await requireWorkspaceMembership(conversation.workspace_id)
    if (authResult instanceof NextResponse) return authResult
    ```

    **For /api/workspaces/[id]/settings/route.ts:**

    1. Import the helper
    2. After getting workspaceId from params, call requireWorkspaceMembership(workspaceId)
    3. Remove the existing auth check (getUser) since helper handles it
    4. Return early if error

    The pattern:
    ```typescript
    const authResult = await requireWorkspaceMembership(workspaceId)
    if (authResult instanceof NextResponse) return authResult

    // Continue with existing update logic
    ```
  </action>
  <verify>
    Both routes import and use requireWorkspaceMembership:
    - grep -l "requireWorkspaceMembership" src/app/api/conversations/[id]/assign/route.ts
    - grep -l "requireWorkspaceMembership" src/app/api/workspaces/[id]/settings/route.ts
  </verify>
  <done>Both API routes verify workspace membership before allowing operations</done>
</task>

<task type="auto">
  <name>Task 3: Add production safeguard for DEV_MODE</name>
  <files>src/middleware.ts</files>
  <action>
    Update the DEV_MODE bypass check in middleware.ts to explicitly check for production:

    Change from:
    ```typescript
    if (process.env.NEXT_PUBLIC_DEV_MODE === 'true') {
      return NextResponse.next({ request })
    }
    ```

    To:
    ```typescript
    // Dev mode bypass - ONLY in development environment
    // Never trust NEXT_PUBLIC_DEV_MODE alone as it could be set incorrectly
    if (
      process.env.NEXT_PUBLIC_DEV_MODE === 'true' &&
      process.env.NODE_ENV !== 'production'
    ) {
      return NextResponse.next({ request })
    }
    ```

    This ensures DEV_MODE bypass is completely disabled in production builds, regardless of the NEXT_PUBLIC_DEV_MODE value.
  </action>
  <verify>
    grep "NODE_ENV.*production" src/middleware.ts returns the safeguard line
  </verify>
  <done>DEV_MODE bypass cannot work in production environment</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. All three files modified as expected:
   - src/lib/auth/workspace-auth.ts exists
   - src/app/api/conversations/[id]/assign/route.ts uses requireWorkspaceMembership
   - src/app/api/workspaces/[id]/settings/route.ts uses requireWorkspaceMembership
   - src/middleware.ts checks NODE_ENV before allowing DEV_MODE
</verification>

<success_criteria>
- Reusable authorization helper exists and is used by vulnerable routes
- Any authenticated user cannot access conversations outside their workspace
- Any authenticated user cannot modify workspace settings they don't belong to
- DEV_MODE bypass is blocked in production builds
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-security/19-01-SUMMARY.md`
</output>
