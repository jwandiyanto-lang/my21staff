---
phase: 19-performance-security
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/validations/index.ts
  - src/lib/validations/contact.ts
  - src/lib/validations/message.ts
  - src/app/api/contacts/[id]/route.ts
  - src/app/api/messages/send/route.ts
autonomous: true

must_haves:
  truths:
    - "Invalid contact updates return 400 with validation errors"
    - "Invalid message sends return 400 with validation errors"
    - "All API inputs are validated against Zod schemas"
  artifacts:
    - path: "src/lib/validations/index.ts"
      provides: "Validation helper with error formatting"
      exports: ["validateBody"]
    - path: "src/lib/validations/contact.ts"
      provides: "Contact validation schemas"
      exports: ["updateContactSchema"]
    - path: "src/lib/validations/message.ts"
      provides: "Message validation schemas"
      exports: ["sendMessageSchema"]
  key_links:
    - from: "src/app/api/contacts/[id]/route.ts"
      to: "src/lib/validations/contact.ts"
      via: "import updateContactSchema"
      pattern: "updateContactSchema"
    - from: "src/app/api/messages/send/route.ts"
      to: "src/lib/validations/message.ts"
      via: "import sendMessageSchema"
      pattern: "sendMessageSchema"
---

<objective>
Add Zod input validation to API endpoints

Purpose: Prevent malformed data from reaching the database and provide clear error messages
Output: Key API endpoints validate all inputs using Zod schemas with proper error responses
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-performance-security/19-RESEARCH.md

@src/app/api/contacts/[id]/route.ts
@src/app/api/messages/send/route.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zod and create validation helpers</name>
  <files>package.json, src/lib/validations/index.ts</files>
  <action>
    1. Install Zod:
    ```bash
    npm install zod
    ```

    2. Create `src/lib/validations/index.ts`:
    ```typescript
    import { z, ZodError, ZodSchema } from 'zod'
    import { NextResponse } from 'next/server'

    export { z }

    /**
     * Validates request body against a Zod schema
     * Returns parsed data on success, or NextResponse error on failure
     */
    export async function validateBody<T extends ZodSchema>(
      request: Request,
      schema: T
    ): Promise<z.infer<T> | NextResponse> {
      try {
        const body = await request.json()
        return schema.parse(body)
      } catch (error) {
        if (error instanceof ZodError) {
          const errors = error.errors.map(e => ({
            field: e.path.join('.'),
            message: e.message
          }))
          return NextResponse.json(
            { error: 'Validation failed', details: errors },
            { status: 400 }
          )
        }
        if (error instanceof SyntaxError) {
          return NextResponse.json(
            { error: 'Invalid JSON body' },
            { status: 400 }
          )
        }
        throw error
      }
    }

    /**
     * Common validation patterns
     */
    export const patterns = {
      // Indonesian phone: +62 followed by 9-12 digits
      phone: z.string().regex(/^\+?62\d{9,12}$/, 'Invalid Indonesian phone number'),

      // General phone: starts with + followed by 10-15 digits
      phoneGeneral: z.string().regex(/^\+?\d{10,15}$/, 'Invalid phone number'),

      // Email
      email: z.string().email('Invalid email address'),

      // Non-empty string
      nonEmpty: z.string().min(1, 'Cannot be empty'),

      // UUID
      uuid: z.string().uuid('Invalid ID format'),
    }
    ```
  </action>
  <verify>
    npm ls zod (shows zod installed)
    ls src/lib/validations/index.ts
  </verify>
  <done>Zod installed and validation helper created</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas for contacts and messages</name>
  <files>src/lib/validations/contact.ts, src/lib/validations/message.ts</files>
  <action>
    **Create src/lib/validations/contact.ts:**
    ```typescript
    import { z } from './index'

    export const updateContactSchema = z.object({
      name: z.string().max(100, 'Name too long').optional(),
      email: z.string().email('Invalid email').max(255).optional().nullable(),
      phone: z.string().regex(/^\+?\d{10,15}$/, 'Invalid phone number').optional(),
      lead_status: z.enum(['new', 'prospect', 'qualified', 'negotiation', 'won', 'lost']).optional(),
      lead_score: z.number().int().min(0).max(100).optional(),
      tags: z.array(z.string().max(50)).max(20).optional(),
      metadata: z.record(z.unknown()).optional(),
    }).strict()

    export const mergeContactSchema = z.object({
      keepContactId: z.string().uuid('Invalid keep contact ID'),
      mergeContactId: z.string().uuid('Invalid merge contact ID'),
      activePhone: z.string().optional(),
      activeEmail: z.string().email().optional().nullable(),
    })
    ```

    **Create src/lib/validations/message.ts:**
    ```typescript
    import { z } from './index'

    export const sendMessageSchema = z.object({
      conversationId: z.string().uuid('Invalid conversation ID'),
      content: z.string()
        .min(1, 'Message cannot be empty')
        .max(4096, 'Message too long (max 4096 characters)'),
    })

    export const sendMediaMessageSchema = z.object({
      conversationId: z.string().uuid('Invalid conversation ID'),
      mediaUrl: z.string().url('Invalid media URL'),
      caption: z.string().max(1024, 'Caption too long').optional(),
      mediaType: z.enum(['image', 'video', 'document', 'audio']),
    })
    ```
  </action>
  <verify>
    ls src/lib/validations/contact.ts
    ls src/lib/validations/message.ts
  </verify>
  <done>Validation schemas created for contacts and messages</done>
</task>

<task type="auto">
  <name>Task 3: Apply validation to key API endpoints</name>
  <files>src/app/api/contacts/[id]/route.ts, src/app/api/messages/send/route.ts</files>
  <action>
    **For /api/contacts/[id]/route.ts (PATCH handler):**

    Replace manual validation with Zod:
    ```typescript
    import { validateBody } from '@/lib/validations'
    import { updateContactSchema } from '@/lib/validations/contact'

    export async function PATCH(request: Request, ...) {
      // Validate input
      const validationResult = await validateBody(request, updateContactSchema)
      if (validationResult instanceof NextResponse) return validationResult

      const body = validationResult
      // ... rest of handler using body
    }
    ```

    **For /api/messages/send/route.ts:**

    Replace the manual validation:
    ```typescript
    import { validateBody } from '@/lib/validations'
    import { sendMessageSchema } from '@/lib/validations/message'

    export async function POST(request: NextRequest) {
      // Validate input
      const validationResult = await validateBody(request, sendMessageSchema)
      if (validationResult instanceof NextResponse) return validationResult

      const { conversationId, content } = validationResult

      // Remove the old manual validation:
      // if (!conversationId || !content?.trim()) { ... }
      // ... rest of handler
    }
    ```

    Note: Apply same pattern to /api/contacts/merge/route.ts and /api/messages/send-media/route.ts if time permits, but the two above are the priority.
  </action>
  <verify>
    grep "validateBody" src/app/api/contacts/[id]/route.ts
    grep "validateBody" src/app/api/messages/send/route.ts
  </verify>
  <done>Key API endpoints validate inputs with Zod schemas</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Zod is in package.json dependencies
3. Validation files exist:
   - src/lib/validations/index.ts
   - src/lib/validations/contact.ts
   - src/lib/validations/message.ts
4. API endpoints use validation:
   - grep "validateBody" src/app/api/contacts/[id]/route.ts
   - grep "validateBody" src/app/api/messages/send/route.ts
</verification>

<success_criteria>
- Zod installed as dependency
- Validation helper provides consistent error responses
- Contact update endpoint validates all fields
- Message send endpoint validates conversationId and content
- Invalid requests return 400 with descriptive error details
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-security/19-03-SUMMARY.md`
</output>
