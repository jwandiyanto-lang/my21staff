---
phase: 19-performance-security
plan: 04
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - src/app/api/webhook/kapso/route.ts
  - src/app/api/contacts/merge/route.ts
autonomous: true

must_haves:
  truths:
    - "Webhook logs do not contain full phone numbers"
    - "Merge logs do not contain PII"
    - "Production logs are safe to view by operations team"
  artifacts:
    - path: "src/app/api/webhook/kapso/route.ts"
      provides: "Masked logging for webhook payloads"
      contains: "maskPhone"
    - path: "src/app/api/contacts/merge/route.ts"
      provides: "PII-free merge logging"
  key_links:
    - from: "src/app/api/webhook/kapso/route.ts"
      to: "console.log"
      via: "masked phone numbers"
      pattern: "\\*\\*\\*"
---

<objective>
Remove or mask PII from production logs

Purpose: Ensure logs are safe for operations viewing and comply with privacy best practices
Output: All console.log statements either removed or have PII masked
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-performance-security/19-RESEARCH.md

@src/app/api/webhook/kapso/route.ts
@src/app/api/contacts/merge/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create phone masking utility and fix webhook logs</name>
  <files>src/app/api/webhook/kapso/route.ts</files>
  <action>
    Add a phone masking helper at the top of the webhook file, then update logs:

    ```typescript
    // Add this helper function near the top
    function maskPhone(phone: string): string {
      if (!phone || phone.length < 6) return '***'
      return phone.slice(0, 3) + '***' + phone.slice(-4)
    }

    function maskPayload(payload: unknown): string {
      const str = JSON.stringify(payload)
      // Mask phone numbers in the log (10-15 digit numbers)
      return str.replace(/"\d{10,15}"/g, '"***MASKED***"')
        .replace(/"from":\s*"\d+"/g, '"from":"***"')
        .replace(/"wa_id":\s*"\d+"/g, '"wa_id":"***"')
    }
    ```

    Update the specific log statements:

    1. Line ~64: Change
       ```typescript
       console.log('[Webhook] Received payload:', JSON.stringify(rawPayload).substring(0, 1000))
       ```
       To:
       ```typescript
       console.log('[Webhook] Received payload (masked):', maskPayload(rawPayload).substring(0, 500))
       ```

    2. Line ~122: Remove or reduce the "All workspaces" log:
       ```typescript
       // Remove: console.log('[Webhook] All workspaces:', JSON.stringify(allWorkspaces))
       // Replace with:
       console.log('[Webhook] Workspace count:', allWorkspaces?.length || 0)
       ```

    3. In the message processing loop, mask the sender phone in any logs:
       ```typescript
       // If logging sender info, mask it:
       console.log(`[Webhook] Processing message from ${maskPhone(senderPhone)}`)
       ```
  </action>
  <verify>
    grep "maskPhone\|maskPayload" src/app/api/webhook/kapso/route.ts
    grep -v "JSON.stringify(rawPayload)" src/app/api/webhook/kapso/route.ts | grep "rawPayload" (should show masked version)
  </verify>
  <done>Webhook logs mask all phone numbers and PII</done>
</task>

<task type="auto">
  <name>Task 2: Fix merge contact logging</name>
  <files>src/app/api/contacts/merge/route.ts</files>
  <action>
    Find and update the merge success log at line ~222:

    Change:
    ```typescript
    console.log(`[Merge] Successfully merged contact ${mergeContactId} into ${keepContactId}. Phone: ${updatedKeepContact.phone}`)
    ```

    To:
    ```typescript
    console.log(`[Merge] Successfully merged contact ${mergeContactId} into ${keepContactId}`)
    ```

    The phone number is not needed in the log - the contact IDs are sufficient for debugging.

    Also review other logs in this file and remove any that include email or phone.
  </action>
  <verify>
    grep "Phone:" src/app/api/contacts/merge/route.ts (should return nothing)
    grep "email" src/app/api/contacts/merge/route.ts | grep console.log (should return nothing)
  </verify>
  <done>Merge logs contain only non-PII identifiers</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. No phone numbers in logs:
   - grep -n "phone" src/app/api/webhook/kapso/route.ts | grep "console.log" (should show masked versions only)
   - grep -n "Phone:" src/app/api/contacts/merge/route.ts (should be empty)
3. No full payloads with PII:
   - Webhook logs use maskPayload() for any payload logging
</verification>

<success_criteria>
- Phone numbers masked as `+62***1234` or `***MASKED***` in all logs
- No raw webhook payloads logged (only masked versions)
- No email addresses in logs
- Contact IDs used for debugging instead of PII
</success_criteria>

<output>
After completion, create `.planning/phases/19-performance-security/19-04-SUMMARY.md`
</output>
