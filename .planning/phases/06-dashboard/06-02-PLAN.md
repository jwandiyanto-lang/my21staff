---
phase: 06-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/leads/lead-filters.tsx
  - src/components/leads/stage-filter.tsx
  - src/components/leads/search-input.tsx
  - src/components/leads/date-range-filter.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter leads by multiple stages simultaneously"
    - "User can search leads by name or phone number instantly"
    - "User can filter leads by date range (today/week/month)"
    - "Filters update results in real-time without submit button"
  artifacts:
    - path: "src/components/leads/lead-filters.tsx"
      provides: "Container for all filter controls"
      exports: ["LeadFilters"]
      min_lines: 40
    - path: "src/components/leads/stage-filter.tsx"
      provides: "Multi-select dropdown for stage filtering"
      exports: ["StageFilter"]
      min_lines: 60
    - path: "src/components/leads/search-input.tsx"
      provides: "Debounced search input for name/phone"
      exports: ["SearchInput"]
      min_lines: 30
    - path: "src/components/leads/date-range-filter.tsx"
      provides: "Date preset selector"
      exports: ["DateRangeFilter"]
      min_lines: 40
  key_links:
    - from: "src/components/leads/lead-filters.tsx"
      to: "@tanstack/react-table"
      via: "column filter state"
      pattern: "setColumnFilters|onColumnFiltersChange"
    - from: "src/components/leads/search-input.tsx"
      to: "table global filter"
      via: "setGlobalFilter callback"
      pattern: "setGlobalFilter"
---

<objective>
Build lead filtering and search components that integrate with TanStack Table for instant, real-time filtering.

Purpose: Enable users to quickly find leads by stage, name/phone, or creation date without page reloads.
Output: Filter bar above lead table with multi-select stage filter, search input, and date presets.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-dashboard/06-CONTEXT.md
@.planning/phases/06-dashboard/06-RESEARCH.md

# TanStack Table filtering patterns
# Reference: Pattern 2 and Pattern 4 from 06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Filter Container and Stage Multi-Select</name>
  <files>
    src/components/leads/lead-filters.tsx
    src/components/leads/stage-filter.tsx
  </files>
  <action>
    Create the filter bar and multi-select stage filter:

    1. **lead-filters.tsx**:
       - Container component for all filters
       - Accept props: globalFilter, setGlobalFilter, columnFilters, setColumnFilters, table
       - Horizontal layout with flexbox, gap-4 between filters
       - Render: StageFilter, SearchInput, DateRangeFilter in a row
       - "Clear all" button to reset filters (appears when any filter active)

       ```tsx
       interface LeadFiltersProps {
         globalFilter: string
         setGlobalFilter: (value: string) => void
         columnFilters: ColumnFiltersState
         setColumnFilters: (filters: ColumnFiltersState) => void
         table: Table<Lead>
       }
       ```

    2. **stage-filter.tsx**:
       - Multi-select dropdown using shadcn/ui Popover + Checkbox pattern (from 06-RESEARCH.md)
       - Stages to filter (matching 06-CONTEXT.md temperature metaphor):
         - 'new' (New)
         - 'warm' (Warm)
         - 'hot' (Hot)
         - 'converted' (Converted)
       - Show selected count in button: "Stage (2)"
       - Checkboxes inside popover for each stage
       - onChange updates columnFilters for 'leadTemperature' column

       **Implementation pattern from research**:
       ```tsx
       const STAGES = [
         { value: 'new', label: 'New', color: 'bg-blue-500' },
         { value: 'warm', label: 'Warm', color: 'bg-orange-500' },
         { value: 'hot', label: 'Hot', color: 'bg-red-500' },
         { value: 'converted', label: 'Converted', color: 'bg-green-500' },
       ]

       <Popover>
         <PopoverTrigger asChild>
           <Button variant="outline">
             Stage {value.length > 0 && `(${value.length})`}
           </Button>
         </PopoverTrigger>
         <PopoverContent className="w-[200px]">
           {STAGES.map((stage) => (
             <div key={stage.value} className="flex items-center space-x-2 py-1">
               <Checkbox
                 id={stage.value}
                 checked={value.includes(stage.value)}
                 onCheckedChange={(checked) => onChange(checked, stage.value)}
               />
               <label htmlFor={stage.value} className="flex items-center gap-2">
                 <div className={`w-2 h-2 rounded-full ${stage.color}`} />
                 {stage.label}
               </label>
             </div>
           ))}
         </PopoverContent>
       </Popover>
       ```

    **Note**: Add custom filterFn to columns.tsx for multi-value filtering:
    ```tsx
    filterFn: (row, id, value: string[]) => {
      if (!value.length) return true
      return value.includes(row.getValue(id))
    }
    ```
  </action>
  <verify>
    npm run type-check passes
    StageFilter and LeadFilters export correctly
  </verify>
  <done>
    Filter container and multi-select stage filter component created with proper Popover + Checkbox pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Search and Date Range Filters</name>
  <files>
    src/components/leads/search-input.tsx
    src/components/leads/date-range-filter.tsx
  </files>
  <action>
    Create remaining filter components:

    1. **search-input.tsx**:
       - Debounced search input (300ms delay to avoid excessive filtering)
       - Placeholder: "Search name or phone..."
       - Uses globalFilter from TanStack Table (searches all columns)
       - Left search icon (magnifying glass)
       - Clear button (X) when input has value

       ```tsx
       interface SearchInputProps {
         value: string
         onChange: (value: string) => void
         placeholder?: string
       }

       export function SearchInput({ value, onChange, placeholder }: SearchInputProps) {
         const [localValue, setLocalValue] = useState(value)

         useEffect(() => {
           const timer = setTimeout(() => onChange(localValue), 300)
           return () => clearTimeout(timer)
         }, [localValue, onChange])

         return (
           <div className="relative">
             <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
             <Input
               value={localValue}
               onChange={(e) => setLocalValue(e.target.value)}
               placeholder={placeholder || "Search..."}
               className="pl-9 pr-8"
             />
             {localValue && (
               <button
                 onClick={() => { setLocalValue(''); onChange('') }}
                 className="absolute right-2 top-1/2 -translate-y-1/2"
               >
                 <X className="h-4 w-4 text-muted-foreground" />
               </button>
             )}
           </div>
         )
       }
       ```

    2. **date-range-filter.tsx**:
       - Preset buttons: Today, This Week, This Month, All Time
       - Uses shadcn/ui Tabs or Button group pattern
       - Filters by 'created_at' column
       - Calculate date ranges client-side:
         - Today: >= start of today
         - This Week: >= 7 days ago
         - This Month: >= 30 days ago
         - All Time: no filter

       ```tsx
       const DATE_PRESETS = [
         { value: 'all', label: 'All Time' },
         { value: 'today', label: 'Today' },
         { value: 'week', label: 'This Week' },
         { value: 'month', label: 'This Month' },
       ]

       function getDateCutoff(preset: string): number | null {
         const now = new Date()
         switch (preset) {
           case 'today':
             return new Date(now.setHours(0, 0, 0, 0)).getTime()
           case 'week':
             return Date.now() - 7 * 24 * 60 * 60 * 1000
           case 'month':
             return Date.now() - 30 * 24 * 60 * 60 * 1000
           default:
             return null
         }
       }
       ```

    **Custom filterFn for date range** (add to lead-columns.tsx):
    ```tsx
    filterFn: (row, id, value: number | null) => {
      if (!value) return true
      const cellValue = row.getValue(id) as number
      return cellValue >= value
    }
    ```
  </action>
  <verify>
    npm run type-check passes
    SearchInput and DateRangeFilter export correctly
  </verify>
  <done>
    Search input with debounce and date range presets created
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Filters with Lead Table</name>
  <files>
    src/app/(dashboard)/[workspace]/leads/leads-client.tsx
    src/components/leads/lead-columns.tsx
    src/components/leads/lead-table.tsx
  </files>
  <action>
    Wire up all filters with TanStack Table:

    1. **Update leads-client.tsx**:
       - Add filter state management:
         ```tsx
         const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([])
         const [globalFilter, setGlobalFilter] = useState('')
         ```
       - Pass filter state to LeadTable
       - Render LeadFilters above LeadTable

    2. **Update lead-table.tsx**:
       - Accept filter props: columnFilters, setColumnFilters, globalFilter, setGlobalFilter
       - Add to useReactTable config:
         ```tsx
         getFilteredRowModel: getFilteredRowModel(),
         onColumnFiltersChange: setColumnFilters,
         onGlobalFilterChange: setGlobalFilter,
         state: {
           columnFilters,
           globalFilter,
           sorting,
         },
         ```
       - Pass table instance to LeadFilters

    3. **Update lead-columns.tsx**:
       - Add filterFn to leadTemperature column for multi-value filtering
       - Add filterFn to created_at column for date range filtering
       - Ensure globalFilterFn searches name and phone columns

    **Testing checklist**:
    - Type in search -> table filters instantly after 300ms debounce
    - Select multiple stages -> only matching stages shown
    - Click date preset -> only leads from that period shown
    - Clear all filters -> all leads return
    - Combine filters (e.g., "hot" stage + "this week") -> intersection shown
  </action>
  <verify>
    Navigate to http://localhost:3000/demo/leads
    Search works (filters by name/phone)
    Stage filter works (multi-select)
    Date presets work (today/week/month/all)
    Combined filters work correctly
    npm run lint passes
  </verify>
  <done>
    All filters integrated with TanStack Table, real-time filtering works
  </done>
</task>

</tasks>

<verification>
- Filter bar renders above lead table
- Stage multi-select shows checkboxes with color indicators
- Search debounces at 300ms
- Date presets filter by created_at correctly
- Filters combine correctly (AND logic)
- "Clear all" resets all filters
- No performance issues with filtering
</verification>

<success_criteria>
1. User can select multiple stages and see only matching leads
2. Search filters by name or phone with 300ms debounce
3. Date presets filter leads by creation date
4. All filters work together (combined filtering)
5. Clear button resets all filters
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard/06-02-SUMMARY.md`
</output>
