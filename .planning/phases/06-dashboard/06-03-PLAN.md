---
phase: 06-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/leads/lead-detail-sheet.tsx
  - src/components/leads/lead-info-card.tsx
  - src/components/leads/lead-notes-timeline.tsx
  - src/components/leads/lead-ai-summary.tsx
  - src/app/(dashboard)/[workspace]/leads/leads-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a lead row to open slide-out detail panel"
    - "Detail panel shows contact info, stage badge, and score"
    - "User can see AI notes from Grok on the lead"
    - "User can see notes timeline with attribution"
    - "Panel stays open while list remains visible behind it"
  artifacts:
    - path: "src/components/leads/lead-detail-sheet.tsx"
      provides: "Slide-out panel container using shadcn Sheet"
      exports: ["LeadDetailSheet"]
      min_lines: 60
    - path: "src/components/leads/lead-info-card.tsx"
      provides: "Contact info display (name, phone, business, stage)"
      exports: ["LeadInfoCard"]
      min_lines: 50
    - path: "src/components/leads/lead-notes-timeline.tsx"
      provides: "Timeline of notes with attribution"
      exports: ["LeadNotesTimeline"]
      min_lines: 40
    - path: "src/components/leads/lead-ai-summary.tsx"
      provides: "AI-generated summary and recommendations"
      exports: ["LeadAISummary"]
      min_lines: 40
  key_links:
    - from: "src/app/(dashboard)/[workspace]/leads/leads-client.tsx"
      to: "src/components/leads/lead-detail-sheet.tsx"
      via: "selectedLead state"
      pattern: "selectedLead.*LeadDetailSheet"
    - from: "src/components/leads/lead-detail-sheet.tsx"
      to: "@/components/ui/sheet"
      via: "shadcn Sheet component"
      pattern: "Sheet.*SheetContent"
---

<objective>
Build slide-out detail panel for viewing lead details including contact info, notes timeline, and AI summaries.

Purpose: Allow quick scanning of lead details without navigating away from the list.
Output: Right-side slide-out panel that opens on lead row click, showing comprehensive lead information.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-dashboard/06-CONTEXT.md
@.planning/phases/06-dashboard/06-RESEARCH.md

# Existing Convex schema for lead data
@convex/schema.ts

# Pattern 3 from research: Sheet slide-out
# Contact data structure
@convex/leads.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Lead Detail Sheet Container</name>
  <files>
    src/components/leads/lead-detail-sheet.tsx
  </files>
  <action>
    Create the main slide-out panel using shadcn/ui Sheet:

    ```tsx
    'use client'

    import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from '@/components/ui/sheet'
    import { LeadInfoCard } from './lead-info-card'
    import { LeadNotesTimeline } from './lead-notes-timeline'
    import { LeadAISummary } from './lead-ai-summary'
    import { StageBadge } from './stage-badge'

    interface Lead {
      _id: string
      phone: string
      name: string
      leadStatus: string
      leadScore: number
      leadTemperature: 'hot' | 'warm' | 'lukewarm' | 'cold'
      businessType?: string
      painPoints?: string[]
      notes?: Array<{ content: string; addedBy: string; addedAt: number }>
      lastActivityAt?: number
      created_at: number
    }

    interface LeadDetailSheetProps {
      lead: Lead | null
      open: boolean
      onOpenChange: (open: boolean) => void
    }

    export function LeadDetailSheet({ lead, open, onOpenChange }: LeadDetailSheetProps) {
      if (!lead) return null

      return (
        <Sheet open={open} onOpenChange={onOpenChange}>
          <SheetContent side="right" className="w-[500px] sm:max-w-[500px] overflow-y-auto">
            <SheetHeader>
              <div className="flex items-center justify-between">
                <SheetTitle className="text-xl">{lead.name}</SheetTitle>
                <StageBadge stage={lead.leadTemperature} />
              </div>
              <SheetDescription className="font-mono text-sm">
                {lead.phone}
              </SheetDescription>
            </SheetHeader>

            <div className="space-y-6 mt-6">
              <LeadInfoCard lead={lead} />
              <LeadAISummary lead={lead} />
              <LeadNotesTimeline notes={lead.notes || []} />
            </div>
          </SheetContent>
        </Sheet>
      )
    }
    ```

    **Key decisions from 06-CONTEXT.md**:
    - Slide-out from right side (side="right")
    - List stays visible while panel shows details
    - Width: 500px to show enough content without overwhelming
    - Scrollable content (overflow-y-auto)
  </action>
  <verify>
    npm run type-check passes
    LeadDetailSheet exports correctly
  </verify>
  <done>
    Lead detail sheet container created with proper structure and responsive width
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Lead Info and Notes Components</name>
  <files>
    src/components/leads/lead-info-card.tsx
    src/components/leads/lead-notes-timeline.tsx
  </files>
  <action>
    Create the info card and notes timeline:

    1. **lead-info-card.tsx**:
       - Display key lead information in a Card
       - Score display with visual indicator (progress bar or ring)
       - Business type if available
       - Pain points as tags/chips if available
       - Created date and last activity
       - Link to open full conversation in inbox (optional, placeholder for now)

       ```tsx
       import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
       import { Badge } from '@/components/ui/badge'
       import { formatDistanceToNow } from 'date-fns'
       import { Briefcase, Calendar, AlertCircle, Gauge } from 'lucide-react'

       interface LeadInfoCardProps {
         lead: {
           leadScore: number
           businessType?: string
           painPoints?: string[]
           created_at: number
           lastActivityAt?: number
         }
       }

       export function LeadInfoCard({ lead }: LeadInfoCardProps) {
         const scoreColor = lead.leadScore >= 70 ? 'text-red-600' : lead.leadScore >= 40 ? 'text-orange-500' : 'text-blue-500'

         return (
           <Card>
             <CardHeader className="pb-3">
               <CardTitle className="text-sm font-medium">Lead Info</CardTitle>
             </CardHeader>
             <CardContent className="space-y-4">
               {/* Score */}
               <div className="flex items-center justify-between">
                 <div className="flex items-center gap-2">
                   <Gauge className="h-4 w-4 text-muted-foreground" />
                   <span className="text-sm">Score</span>
                 </div>
                 <span className={`font-bold ${scoreColor}`}>{lead.leadScore}/100</span>
               </div>

               {/* Business Type */}
               {lead.businessType && (
                 <div className="flex items-center justify-between">
                   <div className="flex items-center gap-2">
                     <Briefcase className="h-4 w-4 text-muted-foreground" />
                     <span className="text-sm">Business</span>
                   </div>
                   <span className="text-sm">{lead.businessType}</span>
                 </div>
               )}

               {/* Pain Points */}
               {lead.painPoints && lead.painPoints.length > 0 && (
                 <div>
                   <div className="flex items-center gap-2 mb-2">
                     <AlertCircle className="h-4 w-4 text-muted-foreground" />
                     <span className="text-sm">Pain Points</span>
                   </div>
                   <div className="flex flex-wrap gap-1">
                     {lead.painPoints.map((point, i) => (
                       <Badge key={i} variant="secondary" className="text-xs">
                         {point}
                       </Badge>
                     ))}
                   </div>
                 </div>
               )}

               {/* Dates */}
               <div className="flex items-center justify-between text-sm text-muted-foreground">
                 <span>Created</span>
                 <span>{formatDistanceToNow(lead.created_at, { addSuffix: true })}</span>
               </div>
               {lead.lastActivityAt && (
                 <div className="flex items-center justify-between text-sm text-muted-foreground">
                   <span>Last Active</span>
                   <span>{formatDistanceToNow(lead.lastActivityAt, { addSuffix: true })}</span>
                 </div>
               )}
             </CardContent>
           </Card>
         )
       }
       ```

    2. **lead-notes-timeline.tsx**:
       - Vertical timeline of notes
       - Each note shows: content, addedBy (Sarah/Grok/user), timestamp
       - Visual indicator for bot vs human notes (different icons or colors)
       - Most recent first (descending order)
       - Show "No notes yet" if empty

       ```tsx
       import { formatDistanceToNow } from 'date-fns'
       import { MessageSquare, Bot, User } from 'lucide-react'

       interface Note {
         content: string
         addedBy: string
         addedAt: number
       }

       export function LeadNotesTimeline({ notes }: { notes: Note[] }) {
         if (notes.length === 0) {
           return (
             <div className="text-center py-4 text-muted-foreground">
               <MessageSquare className="h-8 w-8 mx-auto mb-2 opacity-50" />
               <p className="text-sm">No notes yet</p>
             </div>
           )
         }

         // Sort most recent first
         const sortedNotes = [...notes].sort((a, b) => b.addedAt - a.addedAt)

         return (
           <div>
             <h4 className="text-sm font-medium mb-3">Notes</h4>
             <div className="space-y-3">
               {sortedNotes.map((note, index) => {
                 const isBot = note.addedBy.includes('bot')
                 return (
                   <div key={index} className="flex gap-3">
                     <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isBot ? 'bg-blue-100' : 'bg-gray-100'}`}>
                       {isBot ? <Bot className="h-4 w-4 text-blue-600" /> : <User className="h-4 w-4 text-gray-600" />}
                     </div>
                     <div className="flex-1 min-w-0">
                       <div className="flex items-center gap-2 mb-1">
                         <span className="text-sm font-medium">{note.addedBy}</span>
                         <span className="text-xs text-muted-foreground">
                           {formatDistanceToNow(note.addedAt, { addSuffix: true })}
                         </span>
                       </div>
                       <p className="text-sm text-muted-foreground">{note.content}</p>
                     </div>
                   </div>
                 )
               })}
             </div>
           </div>
         )
       }
       ```
  </action>
  <verify>
    npm run type-check passes
    LeadInfoCard and LeadNotesTimeline export correctly
  </verify>
  <done>
    Lead info card with score, business info, pain points and notes timeline created
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AI Summary Component and Wire Up Sheet</name>
  <files>
    src/components/leads/lead-ai-summary.tsx
    src/app/(dashboard)/[workspace]/leads/leads-client.tsx
    src/lib/mock-data.ts
  </files>
  <action>
    Create AI summary display and integrate with leads page:

    1. **lead-ai-summary.tsx**:
       - Display AI-generated insights for this lead
       - Shows Grok's analysis if available
       - Pull from brainActions for this contact if action exists
       - Fallback to generic message if no AI analysis

       ```tsx
       'use client'

       import { useQuery } from 'convex/react'
       import { api } from 'convex/_generated/api'
       import type { Id } from 'convex/_generated/dataModel'
       import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
       import { Sparkles, MessageSquareText } from 'lucide-react'

       interface LeadAISummaryProps {
         lead: {
           _id: string
           leadTemperature: string
           leadScore: number
         }
         workspaceId?: Id<'workspaces'>
       }

       export function LeadAISummary({ lead, workspaceId }: LeadAISummaryProps) {
         const isDevMode = process.env.NEXT_PUBLIC_DEV_MODE === 'true'

         // In production, could query brainActions for this contact
         // For now, show temperature-based insights

         const getTemperatureInsight = () => {
           switch (lead.leadTemperature) {
             case 'hot':
               return "High engagement detected. This lead shows strong buying signals and should be prioritized for follow-up."
             case 'warm':
               return "Good engagement level. Continue nurturing with relevant content and timely follow-ups."
             case 'lukewarm':
               return "Moderate interest shown. Consider re-engagement strategies or additional qualification."
             case 'cold':
             default:
               return "Early stage lead. Focus on building rapport and understanding their needs."
           }
         }

         return (
           <Card>
             <CardHeader className="pb-3">
               <CardTitle className="text-sm font-medium flex items-center gap-2">
                 <Sparkles className="h-4 w-4 text-purple-500" />
                 AI Insights
               </CardTitle>
             </CardHeader>
             <CardContent>
               <p className="text-sm text-muted-foreground">
                 {getTemperatureInsight()}
               </p>

               {lead.leadScore >= 70 && (
                 <div className="mt-3 p-2 bg-red-50 rounded-md border border-red-100">
                   <div className="flex items-center gap-2 text-red-700 text-sm font-medium">
                     <MessageSquareText className="h-4 w-4" />
                     Ready for handoff
                   </div>
                   <p className="text-xs text-red-600 mt-1">
                     Score indicates high conversion potential
                   </p>
                 </div>
               )}
             </CardContent>
           </Card>
         )
       }
       ```

    2. **Update leads-client.tsx**:
       - Add selectedLead state
       - Add row click handler to select lead
       - Render LeadDetailSheet with selected lead
       - Pass onRowClick to LeadTable

       ```tsx
       const [selectedLead, setSelectedLead] = useState<Lead | null>(null)

       <LeadTable
         data={data}
         onRowClick={setSelectedLead}
         // ... other props
       />
       <LeadDetailSheet
         lead={selectedLead}
         open={!!selectedLead}
         onOpenChange={(open) => !open && setSelectedLead(null)}
       />
       ```

    3. **Update lead-table.tsx**:
       - Accept onRowClick prop
       - Add click handler to table rows
       - Add hover state to rows (cursor-pointer, hover:bg-muted)

    4. **Update mock-data.ts**:
       - Add notes array to MOCK_LEADS with sample notes
       - Include both bot and human notes for testing

       ```tsx
       notes: [
         { content: "Interested in employee management features", addedBy: "sarah-bot", addedAt: Date.now() - 3600000 },
         { content: "Followed up via WhatsApp, awaiting response", addedBy: "jonathan@my21staff.com", addedAt: Date.now() - 7200000 },
       ]
       ```
  </action>
  <verify>
    Navigate to http://localhost:3000/demo/leads
    Click on a lead row - detail sheet slides out from right
    Lead info displays correctly (score, business, pain points)
    Notes timeline shows with proper formatting
    AI insights section shows temperature-based message
    Click outside or X to close sheet
    npm run lint passes
  </verify>
  <done>
    Lead detail sheet fully functional with all sub-components and row click integration
  </done>
</task>

</tasks>

<verification>
- Clicking lead row opens slide-out panel from right
- Panel shows lead name, phone, stage badge in header
- Lead info card displays score with color coding
- Pain points display as tags
- Notes timeline shows chronologically with bot/human differentiation
- AI insights section provides temperature-based guidance
- Panel can be closed by clicking outside or X button
- List remains visible and interactive behind panel
</verification>

<success_criteria>
1. Click any lead row -> detail sheet opens
2. Sheet shows all lead info (contact, score, business, pain points)
3. Notes timeline displays with attribution
4. AI insights section provides contextual guidance
5. Panel closes properly and lead selection clears
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard/06-03-SUMMARY.md`
</output>
