---
phase: 05-central-support-hub
plan: 06
type: execute
wave: 3
depends_on: ["05-05"]
files_modified:
  - package.json
  - src/components/tawk-chat.tsx
  - src/app/portal/layout.tsx
  - .env.local.example
autonomous: true
user_setup:
  - service: tawk.to
    why: "Live chat fallback for clients"
    env_vars:
      - name: NEXT_PUBLIC_TAWK_PROPERTY_ID
        source: "Tawk.to Dashboard -> Administration -> Property Settings"
      - name: NEXT_PUBLIC_TAWK_WIDGET_ID
        source: "Tawk.to Dashboard -> Administration -> Chat Widget"
    dashboard_config:
      - task: "Create free Tawk.to account"
        location: "https://www.tawk.to/"
      - task: "Get Property ID and Widget ID"
        location: "Dashboard -> Administration -> Chat Widget -> Direct Chat Link"

must_haves:
  truths:
    - "Tawk.to widget appears on portal pages when configured"
    - "Widget does not appear on admin dashboard"
    - "Widget gracefully handles missing config"
  artifacts:
    - path: "src/components/tawk-chat.tsx"
      provides: "Tawk.to React wrapper component"
      min_lines: 20
    - path: "src/app/portal/layout.tsx"
      provides: "Portal layout with TawkChat component"
      contains: "TawkChat"
  key_links:
    - from: "src/app/portal/layout.tsx"
      to: "src/components/tawk-chat.tsx"
      via: "import and render"
      pattern: "TawkChat"
---

<objective>
Add optional Tawk.to live chat widget to client portal.

Purpose: Provide live chat fallback for clients who prefer real-time support over tickets. Widget appears only on portal pages, not on admin dashboard.

Output: Tawk.to component integrated into portal layout with env var configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-tawkto-integration/05-RESEARCH.md
@.planning/phases/05-tawkto-integration/05-05-SUMMARY.md

@src/app/portal/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tawkto-react and create component</name>
  <files>
    package.json
    src/components/tawk-chat.tsx
  </files>
  <action>
1. Install tawkto-react:
```bash
npm install tawkto-react
```

2. Create src/components/tawk-chat.tsx:
```tsx
'use client'

import { useRef } from 'react'
import TawkMessengerReact from 'tawkto-react'

interface TawkChatProps {
  userEmail?: string
  userName?: string
}

export function TawkChat({ userEmail, userName }: TawkChatProps) {
  const tawkMessengerRef = useRef<TawkMessengerReact>(null)

  const propertyId = process.env.NEXT_PUBLIC_TAWK_PROPERTY_ID
  const widgetId = process.env.NEXT_PUBLIC_TAWK_WIDGET_ID

  // Don't render if not configured
  if (!propertyId || !widgetId) {
    return null
  }

  const handleLoad = () => {
    // Set visitor attributes if available
    if (typeof window !== 'undefined' && window.Tawk_API && (userEmail || userName)) {
      window.Tawk_API.setAttributes({
        name: userName || '',
        email: userEmail || '',
      }, (error: Error | null) => {
        if (error) {
          console.error('Tawk.to setAttributes error:', error)
        }
      })
    }
  }

  return (
    <TawkMessengerReact
      ref={tawkMessengerRef}
      propertyId={propertyId}
      widgetId={widgetId}
      onLoad={handleLoad}
    />
  )
}

// TypeScript declaration for Tawk_API
declare global {
  interface Window {
    Tawk_API?: {
      setAttributes: (
        attributes: { name?: string; email?: string },
        callback?: (error: Error | null) => void
      ) => void
      hideWidget: () => void
      showWidget: () => void
      maximize: () => void
      minimize: () => void
    }
  }
}
```

Key points:
- Uses useRef to access TawkMessengerReact instance
- Returns null if env vars not set (graceful degradation)
- Sets visitor name/email on load if provided
- Includes TypeScript declarations for Tawk_API
  </action>
  <verify>Run `npm run build` - compiles without errors</verify>
  <done>tawkto-react installed, TawkChat component created with graceful fallback</done>
</task>

<task type="auto">
  <name>Task 2: Add TawkChat to portal layout</name>
  <files>
    src/app/portal/layout.tsx
    .env.local.example
  </files>
  <action>
1. Update src/app/portal/layout.tsx to include TawkChat:
```tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { PortalHeader } from '@/components/portal/portal-header'
import { TawkChat } from '@/components/tawk-chat'

export default async function PortalLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Get user profile
  const { data: profile } = await supabase
    .from('profiles')
    .select('full_name, email')
    .eq('id', user.id)
    .single()

  return (
    <div className="min-h-screen bg-background">
      <PortalHeader
        userName={profile?.full_name || profile?.email || 'User'}
        userEmail={profile?.email || ''}
      />
      <main className="container mx-auto px-4 py-8 max-w-4xl">
        {children}
      </main>
      {/* Tawk.to live chat - only on portal, not admin */}
      <TawkChat
        userName={profile?.full_name || undefined}
        userEmail={profile?.email || undefined}
      />
    </div>
  )
}
```

2. Update .env.local.example (or create if doesn't exist) to document Tawk.to vars:
Add these lines:
```
# Tawk.to Live Chat (optional)
# Get these from Tawk.to Dashboard -> Administration -> Chat Widget
NEXT_PUBLIC_TAWK_PROPERTY_ID=
NEXT_PUBLIC_TAWK_WIDGET_ID=
```

Note: Widget only appears on /portal/* routes because it's only in portal layout. Admin dashboard at /[workspace]/* does NOT have this component.
  </action>
  <verify>
1. `npm run build` passes
2. Widget appears on /portal/support when env vars set
3. Widget does NOT appear on admin dashboard pages
  </verify>
  <done>TawkChat integrated into portal layout, env vars documented</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Without env vars: no widget, no errors
3. With env vars: Tawk.to widget appears on portal pages
4. Admin dashboard (/[workspace]/*): no widget
5. Widget shows user name/email if logged in
</verification>

<success_criteria>
- tawkto-react installed in package.json
- TawkChat component handles missing config gracefully
- Widget appears only on portal pages
- User name/email passed to Tawk.to when available
- Env vars documented in .env.local.example
</success_criteria>

<output>
After completion, create `.planning/phases/05-tawkto-integration/05-06-SUMMARY.md`
</output>
