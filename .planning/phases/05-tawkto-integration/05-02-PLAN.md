---
phase: 05-central-support-hub
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/29_ticket_attachments_storage.sql
  - src/lib/storage/ticket-attachments.ts
  - src/app/api/tickets/[id]/attachments/route.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Supabase Storage bucket exists for ticket attachments"
    - "Users can upload images to tickets they're involved in"
    - "Uploaded images are accessible via public URL"
  artifacts:
    - path: "supabase/migrations/29_ticket_attachments_storage.sql"
      provides: "Storage bucket and RLS policies"
      contains: "ticket-attachments"
    - path: "src/lib/storage/ticket-attachments.ts"
      provides: "Upload helper functions"
      exports: ["uploadTicketAttachment", "deleteTicketAttachment"]
    - path: "src/app/api/tickets/[id]/attachments/route.ts"
      provides: "Upload API endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/lib/storage/ticket-attachments.ts"
      to: "Supabase Storage"
      via: "supabase.storage.from('ticket-attachments')"
      pattern: "from\\('ticket-attachments'\\)"
---

<objective>
Create Supabase Storage bucket for ticket image attachments with proper RLS.

Purpose: Enable clients and admins to attach images to tickets for reporting issues and showing progress/changes.

Output: Storage bucket, RLS policies, TypeScript upload helpers, and API endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-tawkto-integration/05-RESEARCH.md

@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage bucket migration</name>
  <files>supabase/migrations/29_ticket_attachments_storage.sql</files>
  <action>
Create migration for ticket attachments storage bucket:

```sql
-- Migration: 29_ticket_attachments_storage.sql
-- Storage bucket for ticket image attachments

-- Create storage bucket (private - requires auth)
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'ticket-attachments',
  'ticket-attachments',
  false,
  5242880, -- 5MB limit
  ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']
);

-- RLS: Users can upload to tickets they're involved in
-- Path format: {ticket_id}/{timestamp}-{filename}
CREATE POLICY "Users can upload to their tickets" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'ticket-attachments' AND
    auth.role() = 'authenticated' AND
    -- Extract ticket_id from first folder in path
    (storage.foldername(name))[1]::uuid IN (
      SELECT id FROM tickets
      WHERE requester_id = auth.uid()
         OR assigned_to = auth.uid()
         OR (SELECT private.get_user_role_in_workspace(workspace_id)) IS NOT NULL
         OR (admin_workspace_id IS NOT NULL AND
             (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin'))
    )
  );

-- RLS: Users can view attachments for tickets they can view
CREATE POLICY "Users can view ticket attachments" ON storage.objects
  FOR SELECT USING (
    bucket_id = 'ticket-attachments' AND
    (storage.foldername(name))[1]::uuid IN (
      SELECT id FROM tickets
      WHERE requester_id = auth.uid()
         OR assigned_to = auth.uid()
         OR (SELECT private.get_user_role_in_workspace(workspace_id)) IS NOT NULL
         OR (admin_workspace_id IS NOT NULL AND
             (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin'))
    )
  );

-- RLS: Users can delete their own uploads
CREATE POLICY "Users can delete own uploads" ON storage.objects
  FOR DELETE USING (
    bucket_id = 'ticket-attachments' AND
    owner_id = auth.uid()
  );
```

Note: Using private bucket with RLS. Images are served via signed URLs or public URL after policy check.
  </action>
  <verify>Run `npx supabase db push` - storage bucket created</verify>
  <done>Storage bucket 'ticket-attachments' exists with 5MB limit, image-only MIME types, and RLS policies</done>
</task>

<task type="auto">
  <name>Task 2: Create upload helpers and API endpoint</name>
  <files>
    src/lib/storage/ticket-attachments.ts
    src/app/api/tickets/[id]/attachments/route.ts
  </files>
  <action>
1. Create src/lib/storage/ticket-attachments.ts:
```typescript
import { createClient } from '@/lib/supabase/client'

const BUCKET_NAME = 'ticket-attachments'
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']

export interface UploadResult {
  url: string
  path: string
  size: number
}

export async function uploadTicketAttachment(
  ticketId: string,
  file: File
): Promise<UploadResult> {
  // Validate file
  if (!ALLOWED_TYPES.includes(file.type)) {
    throw new Error('Only images are allowed (JPEG, PNG, GIF, WebP)')
  }
  if (file.size > MAX_FILE_SIZE) {
    throw new Error('File size must be under 5MB')
  }

  const supabase = createClient()
  const fileName = `${ticketId}/${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`

  const { data, error } = await supabase.storage
    .from(BUCKET_NAME)
    .upload(fileName, file, {
      contentType: file.type,
      upsert: false
    })

  if (error) throw error

  // Get public URL (bucket is private but we have RLS)
  const { data: { publicUrl } } = supabase.storage
    .from(BUCKET_NAME)
    .getPublicUrl(data.path)

  return {
    url: publicUrl,
    path: data.path,
    size: file.size
  }
}

export async function deleteTicketAttachment(path: string): Promise<void> {
  const supabase = createClient()
  const { error } = await supabase.storage
    .from(BUCKET_NAME)
    .remove([path])
  if (error) throw error
}

export function getAttachmentUrl(path: string): string {
  const supabase = createClient()
  const { data: { publicUrl } } = supabase.storage
    .from(BUCKET_NAME)
    .getPublicUrl(path)
  return publicUrl
}
```

2. Create src/app/api/tickets/[id]/attachments/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

const BUCKET_NAME = 'ticket-attachments'
const MAX_FILE_SIZE = 5 * 1024 * 1024

// POST /api/tickets/[id]/attachments - Upload attachment
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id: ticketId } = await params
    const supabase = await createClient()

    // Get current user
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Verify ticket exists and user can access it
    const { data: ticket, error: ticketError } = await supabase
      .from('tickets')
      .select('id, workspace_id, admin_workspace_id, requester_id, assigned_to')
      .eq('id', ticketId)
      .single()

    if (ticketError || !ticket) {
      return NextResponse.json({ error: 'Ticket not found' }, { status: 404 })
    }

    // Parse form data
    const formData = await request.formData()
    const file = formData.get('file') as File | null

    if (!file) {
      return NextResponse.json({ error: 'No file provided' }, { status: 400 })
    }

    if (file.size > MAX_FILE_SIZE) {
      return NextResponse.json({ error: 'File too large (max 5MB)' }, { status: 400 })
    }

    // Upload to storage
    const fileName = `${ticketId}/${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`
    const arrayBuffer = await file.arrayBuffer()

    const { data: uploadData, error: uploadError } = await supabase.storage
      .from(BUCKET_NAME)
      .upload(fileName, arrayBuffer, {
        contentType: file.type,
        upsert: false
      })

    if (uploadError) {
      console.error('Upload error:', uploadError)
      return NextResponse.json({ error: 'Upload failed' }, { status: 500 })
    }

    // Get public URL
    const { data: { publicUrl } } = supabase.storage
      .from(BUCKET_NAME)
      .getPublicUrl(uploadData.path)

    return NextResponse.json({
      url: publicUrl,
      path: uploadData.path,
      size: file.size
    })
  } catch (error) {
    console.error('POST /api/tickets/[id]/attachments error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```
  </action>
  <verify>
1. Run `npm run build` - TypeScript compiles
2. Test upload via curl or UI
  </verify>
  <done>Upload helpers work, API endpoint accepts file uploads, images stored in Supabase Storage</done>
</task>

</tasks>

<verification>
1. Storage bucket exists in Supabase Studio under Storage
2. `npm run build` passes
3. Test: Create ticket, call POST /api/tickets/{id}/attachments with image file
</verification>

<success_criteria>
- Storage bucket 'ticket-attachments' exists with 5MB limit
- Only image types allowed (JPEG, PNG, GIF, WebP)
- RLS allows upload/view for ticket participants
- API endpoint returns public URL after upload
</success_criteria>

<output>
After completion, create `.planning/phases/05-tawkto-integration/05-02-SUMMARY.md`
</output>
