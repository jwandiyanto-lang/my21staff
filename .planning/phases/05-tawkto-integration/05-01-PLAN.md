---
phase: 05-central-support-hub
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/28_central_support_hub.sql
  - src/lib/tickets/types.ts
  - src/lib/config/support.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tickets can have admin_workspace_id for routing to central hub"
    - "Comments can be marked as internal (hidden from clients)"
    - "Support config provides ADMIN_WORKSPACE_ID constant"
  artifacts:
    - path: "supabase/migrations/28_central_support_hub.sql"
      provides: "admin_workspace_id column, is_internal column, updated RLS policies"
      contains: "admin_workspace_id"
    - path: "src/lib/tickets/types.ts"
      provides: "Updated Ticket and TicketComment types"
      contains: "admin_workspace_id"
    - path: "src/lib/config/support.ts"
      provides: "ADMIN_WORKSPACE_ID constant"
      exports: ["ADMIN_WORKSPACE_ID", "isAdminWorkspace"]
  key_links:
    - from: "supabase/migrations/28_central_support_hub.sql"
      to: "tickets table"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "ADD COLUMN admin_workspace_id"
---

<objective>
Add database schema changes and TypeScript support for cross-workspace ticketing.

Purpose: Enable tickets created in client workspaces to be routed to the my21staff admin workspace for centralized support handling.

Output: Migration file with new columns and RLS policies, updated TypeScript types, support config module.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tawkto-integration/05-RESEARCH.md

@supabase/migrations/26_tickets.sql
@src/lib/tickets/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for cross-workspace support</name>
  <files>supabase/migrations/28_central_support_hub.sql</files>
  <action>
Create migration file with:

1. Add admin_workspace_id column to tickets:
```sql
ALTER TABLE tickets ADD COLUMN admin_workspace_id UUID REFERENCES workspaces(id);
CREATE INDEX idx_tickets_admin_workspace ON tickets(admin_workspace_id);
```

2. Add is_internal column to ticket_comments:
```sql
ALTER TABLE ticket_comments ADD COLUMN is_internal BOOLEAN DEFAULT FALSE;
```

3. Add RLS policy for admin workspace members to view routed tickets:
```sql
CREATE POLICY "Admin workspace can view routed tickets" ON tickets
  FOR SELECT USING (
    admin_workspace_id IS NOT NULL AND
    (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin')
  );

CREATE POLICY "Admin workspace can update routed tickets" ON tickets
  FOR UPDATE USING (
    admin_workspace_id IS NOT NULL AND
    (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin')
  );
```

4. Add RLS policy for admin workspace to view/add comments on routed tickets:
```sql
CREATE POLICY "Admin workspace can view comments on routed tickets" ON ticket_comments
  FOR SELECT USING (
    ticket_id IN (
      SELECT id FROM tickets
      WHERE admin_workspace_id IS NOT NULL AND
      (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin')
    )
  );

CREATE POLICY "Admin workspace can add comments on routed tickets" ON ticket_comments
  FOR INSERT WITH CHECK (
    ticket_id IN (
      SELECT id FROM tickets
      WHERE admin_workspace_id IS NOT NULL AND
      (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin')
    )
    AND author_id = auth.uid()
  );
```

5. Add RLS for status history on routed tickets:
```sql
CREATE POLICY "Admin workspace can view history on routed tickets" ON ticket_status_history
  FOR SELECT USING (
    ticket_id IN (
      SELECT id FROM tickets
      WHERE admin_workspace_id IS NOT NULL AND
      (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin')
    )
  );

CREATE POLICY "Admin workspace can add history on routed tickets" ON ticket_status_history
  FOR INSERT WITH CHECK (
    ticket_id IN (
      SELECT id FROM tickets
      WHERE admin_workspace_id IS NOT NULL AND
      (SELECT private.get_user_role_in_workspace(admin_workspace_id)) IN ('owner', 'admin')
    )
    AND changed_by = auth.uid()
  );
```

Note: Existing policies already allow workspace members to access their own tickets. These new policies ADD access for admin workspace members to view client tickets routed to them.
  </action>
  <verify>Run `npx supabase db push` - migration applies without errors</verify>
  <done>Migration creates admin_workspace_id column, is_internal column, and RLS policies for cross-workspace access</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types and add support config</name>
  <files>
    src/lib/tickets/types.ts
    src/lib/config/support.ts
  </files>
  <action>
1. Update src/lib/tickets/types.ts:
- Add `admin_workspace_id: string | null` to Ticket interface
- Add `is_internal: boolean` to TicketComment interface (default false in DB)
- Add optional `source_workspace?: { id: string; name: string; slug: string }` for joined data

2. Create src/lib/config/support.ts:
```typescript
// Central support hub configuration
// All client tickets are routed to this workspace for centralized handling

export const ADMIN_WORKSPACE_ID = process.env.NEXT_PUBLIC_ADMIN_WORKSPACE_ID
  || '0318fda5-22c4-419b-bdd8-04471b818d17' // my21staff workspace

export function isAdminWorkspace(workspaceId: string): boolean {
  return workspaceId === ADMIN_WORKSPACE_ID
}

export function isClientTicket(ticket: { admin_workspace_id: string | null }): boolean {
  return ticket.admin_workspace_id !== null
}
```
  </action>
  <verify>Run `npm run build` - no TypeScript errors, exports available</verify>
  <done>Ticket type includes admin_workspace_id, TicketComment includes is_internal, support config exports ADMIN_WORKSPACE_ID</done>
</task>

</tasks>

<verification>
1. Migration applies: `npx supabase db push` succeeds
2. TypeScript compiles: `npm run build` passes
3. New columns visible in Supabase Studio
</verification>

<success_criteria>
- admin_workspace_id column exists on tickets table
- is_internal column exists on ticket_comments table
- RLS policies allow admin workspace members to view/manage client tickets
- TypeScript types updated for new fields
- ADMIN_WORKSPACE_ID constant available from src/lib/config/support.ts
</success_criteria>

<output>
After completion, create `.planning/phases/05-tawkto-integration/05-01-SUMMARY.md`
</output>
