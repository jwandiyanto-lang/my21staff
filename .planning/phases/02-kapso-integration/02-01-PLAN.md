---
phase: 02-kapso-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/workspaces.ts
autonomous: true

must_haves:
  truths:
    - "Eagle workspace has kapso_phone_id configured"
    - "Eagle workspace has meta_access_token stored"
    - "Kapso webhook verification (GET) returns challenge"
  artifacts:
    - path: "convex/workspaces.ts"
      provides: "updateKapsoCredentials mutation"
      exports: ["updateKapsoCredentials"]
  key_links:
    - from: "convex/kapso.ts"
      to: "workspaces.kapso_phone_id"
      via: "by_kapso_phone index query"
      pattern: 'withIndex\\("by_kapso_phone"'
---

<objective>
Configure Eagle workspace with Kapso credentials for WhatsApp integration.

Purpose: Without kapso_phone_id and meta_access_token, the webhook handler cannot route messages to the correct workspace and cannot send responses via Kapso API.

Output: Eagle workspace has working Kapso credentials; webhook GET verification passes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/02-kapso-integration/02-RESEARCH.md
@convex/schema.ts
@convex/kapso.ts
@convex/http.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Eagle workspace exists and check current credentials</name>
  <files>convex/workspaces.ts</files>
  <action>
Query the Convex dashboard or create a diagnostic script to:
1. Find Eagle workspace by slug "eagle-overseas"
2. Check if kapso_phone_id is already set
3. Check if meta_access_token is already set
4. Log current state for reference

If credentials already exist and are valid, this task confirms readiness.
If missing, document what needs to be configured.

Create a query function `getWorkspaceKapsoStatus` in convex/workspaces.ts if it doesn't exist:
- Takes workspace_id or slug
- Returns { hasKapsoPhoneId: boolean, hasMetaAccessToken: boolean }
  </action>
  <verify>
Run query against production Convex: `npx convex run workspaces:getBySlug '{"slug": "eagle-overseas"}'`
Confirm workspace exists and note credential status.
  </verify>
  <done>Eagle workspace exists and current Kapso credential status is documented.</done>
</task>

<task type="auto">
  <name>Task 2: Create or verify Kapso credentials update mutation</name>
  <files>convex/workspaces.ts</files>
  <action>
Ensure convex/workspaces.ts has an `updateKapsoCredentials` internal mutation that:
1. Takes workspace_id, kapso_phone_id (string), meta_access_token (string)
2. Updates the workspace record with these fields
3. Logs the update for audit

Credential storage approach: Store meta_access_token as plain text in the workspace document.
This is acceptable because:
- Convex database is encrypted at rest
- Access is controlled via Convex functions (no direct DB access)
- This matches the existing pattern in getKapsoCredentials query (lines 292-308)
- Production secrets should be set via Convex dashboard or CLI, not committed to code

If the mutation already exists (check updateSettings mutation), verify it can handle meta_access_token field.
If not, create updateKapsoCredentials following the existing updateSettings pattern.

Do NOT include actual API keys in code - they will be set via Convex dashboard or CLI.
  </action>
  <verify>
Check convex/workspaces.ts exports updateKapsoCredentials or updateSettings handles meta_access_token.
Verify TypeScript compiles: `cd /home/jfransisco/Desktop/21/my21staff && npx convex dev --once`
  </verify>
  <done>Mutation exists to update Kapso credentials on workspace, storing meta_access_token as plain text.</done>
</task>

<task type="auto">
  <name>Task 3: Test webhook verification endpoint</name>
  <files>N/A (verification only)</files>
  <action>
Test the Kapso webhook GET endpoint to confirm it returns the challenge correctly:

1. Test production endpoint:
   curl "https://intent-otter-212.convex.site/webhook/kapso?hub.challenge=test123"

   Expected: Returns "test123" with 200 OK

2. Test without challenge:
   curl "https://intent-otter-212.convex.site/webhook/kapso"

   Expected: Returns "Kapso webhook endpoint ready" with 200 OK

3. If tests fail, check Convex logs for errors.

Document results for the summary.
  </action>
  <verify>
Both curl commands return expected responses with 200 OK status.
  </verify>
  <done>Webhook GET verification works; Kapso can verify the endpoint during setup.</done>
</task>

</tasks>

<verification>
1. Eagle workspace exists in Convex with slug "eagle-overseas"
2. updateKapsoCredentials mutation exists and compiles
3. Webhook GET returns challenge correctly
4. No TypeScript or runtime errors
</verification>

<success_criteria>
- Eagle workspace found and credential status documented
- Mutation for credential updates available
- Webhook verification endpoint responds correctly to GET requests
</success_criteria>

<output>
After completion, create `planning/phases/02-kapso-integration/02-01-SUMMARY.md`
</output>
