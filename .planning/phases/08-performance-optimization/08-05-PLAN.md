---
phase: 08-performance-optimization
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/inbox/message-input.tsx
  - src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Failed message sends are rolled back from UI (not shown as sent)"
    - "Rollback targets correct conversation even if user switches during API call"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/inbox/message-input.tsx"
      provides: "MessageInput with updated onMessageError signature"
      contains: "onMessageError(conversationId"
    - path: "src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx"
      provides: "handleMessageError accepting conversationId parameter"
      contains: "handleMessageError = useCallback((conversationId: string, optimisticId: string)"
  key_links:
    - from: "message-input.tsx"
      to: "inbox-client.tsx"
      via: "onMessageError callback with conversationId"
      pattern: "onMessageError\\(conversationId"
---

<objective>
Fix optimistic rollback to target the correct conversation when message send fails, even if user has switched conversations during the API call.

Purpose: Address UAT gap 3 - "Failed message sends are rolled back from UI (not shown as sent)"

Output: onMessageError callback receives conversationId as parameter, ensuring rollback targets the conversation where the message was sent, not the currently selected one.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-performance-optimization/08-UAT.md

Root cause from debug session:
- handleMessageError in inbox-client.tsx captures selectedConversation.id via closure
- If user switches conversations during the API call, the closure still references OLD selectedConversation
- When error handler runs, it removes optimistic message from WRONG conversation cache
- Result: Failed message remains visible in original conversation, correct conversation untouched

Current code (inbox-client.tsx line 202-205):
```typescript
const handleMessageError = useCallback((optimisticId: string) => {
  if (!selectedConversation) return
  removeOptimisticMessage(selectedConversation.id, optimisticId)  // BUG: uses current selection, not original
}, [selectedConversation, removeOptimisticMessage])
```

Current code (message-input.tsx line 27):
```typescript
onMessageError: (optimisticId: string) => void
```

Fix: Pass conversationId from MessageInput to error handler, captured at send time.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update onMessageError signature and implementation</name>
  <files>
    src/app/(dashboard)/[workspace]/inbox/message-input.tsx
    src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
  </files>
  <action>
**Step 1: Update MessageInput interface and error call**

In message-input.tsx, change the onMessageError prop type:

```typescript
// Before
onMessageError: (optimisticId: string) => void

// After
onMessageError: (conversationId: string, optimisticId: string) => void
```

Update the error handler call in handleSubmit (around line 195):

```typescript
// Before
onMessageError(optimisticId)

// After
onMessageError(conversationId, optimisticId)
```

The conversationId is already available as a prop, so this captures it at send time (not at error time).

**Step 2: Update handleMessageError in InboxClient**

In inbox-client.tsx, change the callback signature:

```typescript
// Before
const handleMessageError = useCallback((optimisticId: string) => {
  if (!selectedConversation) return
  removeOptimisticMessage(selectedConversation.id, optimisticId)
}, [selectedConversation, removeOptimisticMessage])

// After
const handleMessageError = useCallback((conversationId: string, optimisticId: string) => {
  removeOptimisticMessage(conversationId, optimisticId)
}, [removeOptimisticMessage])
```

Key changes:
1. Accept conversationId as first parameter
2. Remove dependency on selectedConversation (not needed anymore)
3. Use the passed conversationId directly
4. Remove the null check (conversationId is always provided)

This ensures the optimistic message is removed from the conversation where it was sent, regardless of which conversation is currently selected.
  </action>
  <verify>
Manual test:
1. Open Inbox, select a conversation
2. Type a message and send
3. Quickly switch to another conversation before API responds
4. If send fails (simulate by disconnecting network or using invalid workspace):
   - Failed message should disappear from ORIGINAL conversation
   - No ghost message should appear in either conversation

Code verification:
- `npm run build` succeeds
- grep for the pattern: `grep -n "onMessageError(conversationId" src/app/(dashboard)/[workspace]/inbox/message-input.tsx`
  </verify>
  <done>
- onMessageError signature updated to (conversationId, optimisticId)
- MessageInput passes conversationId at send time
- InboxClient handleMessageError uses passed conversationId, not closure
- Optimistic rollback targets correct conversation regardless of user navigation
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. TypeScript check: `npx tsc --noEmit`
3. Manual test scenario:
   - Open Inbox with multiple conversations
   - Send message in Conversation A
   - Immediately switch to Conversation B
   - Simulate send failure (can use browser DevTools to block /api/messages/send)
   - Verify: optimistic message disappears from Conversation A (where sent)
   - Verify: Conversation B is unaffected
4. Normal flow still works:
   - Send message, stays in conversation
   - Message persists after success response
</verification>

<success_criteria>
- Failed message sends are rolled back from UI
- Rollback works correctly even when user switches conversations during API call
- No regressions in normal message flow
</success_criteria>

<output>
After completion, create `.planning/phases/08-performance-optimization/08-05-SUMMARY.md`
</output>
