---
phase: 02-supabase-optimization
plan: 04
type: execute
wave: 3
depends_on: [02, 03]
files_modified: []
autonomous: true
user_setup: []

must_haves:
  truths:
    - "RLS policies reviewed and documented (verification-only task)"
    - "EXPLAIN ANALYZE on hot path queries shows efficient index usage"
    - "Performance improvement document created with before/after metrics"
    - "Target criteria met: P95 < 1 second for both optimized endpoints"
  artifacts:
    - path: ".planning/phases/02-supabase-optimization/02-04-SUMMARY.md"
      provides: "Optimization verification report with before/after metrics"
      min_lines: 50
  key_links:
    - from: ".planning/phases/02-supabase-optimization/02-04-SUMMARY.md"
      to: "supabase/migrations/43_optimization_indexes.sql"
      via: "reference to index verification results"
      pattern: "idx_.*index.*Index Scan"
    - from: ".planning/phases/02-supabase-optimization/02-04-SUMMARY.md"
      to: "src/app/api/contacts/by-phone/route.ts"
      via: "before/after query timing comparison"
      pattern: "contacts/by-phone.*ms"
    - from: ".planning/phases/02-supabase-optimization/02-04-SUMMARY.md"
      to: "src/app/api/conversations/route.ts"
      via: "before/after query timing comparison"
      pattern: "conversations.*ms"
---

<objective>
Verify optimization results and document performance improvements.

Purpose: After implementing indexes, Promise.all() parallelization, and explicit column selection, verify that the optimizations are working and document the results. This plan ensures the optimizations achieve the target outcomes (P95 < 1 second) before proceeding to Phase 03 (Convex Spike).

This is a verification-only phase. RLS policies are reviewed and documented; any identified optimization opportunities would be addressed in future phases if needed.

Output: Verification document with EXPLAIN ANALYZE results, before/after metrics, and confirmation that targets are met.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-supabase-optimization/02-CONTEXT.md
@.planning/phases/02-supabase-optimization/02-RESEARCH.md
@.planning/phases/02-supabase-optimization/02-01-SUMMARY.md
@.planning/phases/02-supabase-optimization/02-02-SUMMARY.md
@.planning/phases/02-supabase-optimization/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify index usage with EXPLAIN ANALYZE</name>
  <files>none (verification only)</files>
  <action>
Run EXPLAIN ANALYZE on representative queries from the optimized endpoints to confirm indexes are being used.

Run these queries in Supabase SQL Editor:

1. Contact lookup (from /api/contacts/by-phone):
EXPLAIN ANALYZE
SELECT id, name, phone, email, lead_status, lead_score, tags, metadata, created_at
FROM contacts
WHERE workspace_id = '<actual-workspace-id>' AND phone = '<actual-phone>';

2. Conversations list (from /api/conversations):
EXPLAIN ANALYZE
SELECT c.id, c.status, c.assigned_to, c.unread_count, c.last_message_at, c.last_message_preview, ct.id, ct.name, ct.phone, ct.lead_status, ct.tags, ct.assigned_to
FROM conversations c
INNER JOIN contacts ct ON ct.id = c.contact_id
WHERE c.workspace_id = '<actual-workspace-id>'
ORDER BY c.last_message_at DESC
LIMIT 50;

3. Messages by conversation:
EXPLAIN ANALYZE
SELECT content, direction, created_at
FROM messages
WHERE conversation_id = '<actual-conversation-id>'
ORDER BY created_at DESC
LIMIT 10;

Look for:
- "Index Scan using idx_contacts_workspace_phone" (not "Seq Scan on contacts")
- "Index Scan using idx_conversations_workspace_time" (not "Seq Scan on conversations")
- "Index Scan using idx_messages_conversation_time" (not "Seq Scan on messages")

If any query shows Seq Scan, the index is not being used and we need to investigate.

Save the EXPLAIN ANALYZE output for the verification document.
  </action>
  <verify>EXPLAIN ANALYZE output shows Index Scan (not Seq Scan) for all three queries</verify>
  <done>EXPLAIN ANALYZE confirms all composite indexes are used by query planner</done>
</task>

<task type="auto">
  <name>Task 2: Review existing RLS policies (verification-only)</name>
  <files>none (verification only)</files>
  <action>
Review existing RLS policies to confirm they follow best practices for performance.

This is a verification-only task to document the current state. Any optimization opportunities found will be noted but not implemented in this phase.

Check the policies referenced in the hot path queries:
1. contacts table RLS policies
2. conversations table RLS policies
3. messages table RLS policies

Look for patterns in schema.sql and migrations:
- Does any policy use auth.uid() directly without SELECT wrapping?
- Does any policy have per-row subqueries that could be cached?

The codebase already uses the optimized pattern in migration 30_fix_rls_policies.sql:
```
(SELECT private.get_user_role_in_workspace(workspace_id)) IS NOT NULL
```

Verify and document:
1. Contacts, conversations, messages policies use private.get_user_role_in_workspace() helper
2. If any policy uses direct auth.uid() without SELECT wrapping, note it as a potential future optimization (not implemented in this phase)
3. Document the current state of RLS policies as either "optimized" or "requires future optimization"

This task produces documentation only. RLS policy changes (if needed) would be addressed in a dedicated optimization phase.

Reference: 02-RESEARCH.md Pattern 5 (RLS Policy Optimization with SELECT Wrapping).
  </action>
  <verify>RLS policies review completed and documented (verification-only, no implementation changes)</verify>
  <done>RLS policies reviewed - documented current state as optimized or noted future optimization opportunities</done>
</task>

<task type="auto">
  <name>Task 3: Document optimization results</name>
  <files>.planning/phases/02-supabase-optimization/02-04-SUMMARY.md</files>
  <action>
Create optimization verification document with the following sections:

## Optimization Results - Phase 02

### Indexes Created
List the three composite indexes created in Plan 01:
- idx_contacts_workspace_phone on contacts(workspace_id, phone)
- idx_conversations_workspace_time on conversations(workspace_id, last_message_at DESC)
- idx_messages_conversation_time on messages(conversation_id, created_at DESC)

### Index Usage Verification
Include EXPLAIN ANALYZE output showing Index Scan for each query.
Note if any query still shows Seq Scan (would indicate index not being used).

### Code Changes Summary
- /api/contacts/by-phone: Promise.all() for notes/conversation queries, messages runs after conversation resolves
- /api/conversations: Explicit columns + Promise.all() for activeCount, teamMembers, contactsWithTags
- No select('*') wildcards in hot paths (except head: true count queries)

### Query Count Analysis
Document why query count was not reduced:
- /api/contacts/by-phone: 4 queries serve distinct data needs (contact, notes, conversation, messages)
- /api/conversations: 4 queries serve distinct data needs (conversations list, active badge, team members, tag filters)
- Optimization is latency reduction via parallelization, not query count reduction

### RLS Policies Review
Document whether RLS policies use optimized pattern (private.get_user_role_in_workspace helper).
Note any policies that could be further optimized in future phases (not implemented here).

### Performance Metrics
Create a before/after table:

| Endpoint | Before (ms) | After (ms) | Improvement | Target Met |
|----------|-------------|------------|-------------|------------|
| /api/contacts/by-phone P95 | ~2000-6000 | <actual measured after deployment> | % | YES/NO |
| /api/conversations P95 | ~2000-6000 | <actual measured after deployment> | % | YES/NO |

Note: "After" metrics will come from production logs after deployment. For now, use estimated values based on the optimization patterns applied.

### Success Criteria Status
- /api/contacts/by-phone P95 < 1 second: [PENDING / VERIFIED]
- /api/conversations P95 < 1 second: [PENDING / VERIFIED]
- Latency reduced via parallelization: [VERIFIED]
- All hot path queries use indexes: [VERIFIED / PENDING]
- No select('*') in hot paths: [VERIFIED]

### Conclusion
Summarize whether Phase 02 achieved its goals and if Supabase optimization is sufficient to proceed to Decision Gate or if Convex spike is needed.

Save this as 02-04-SUMMARY.md in the phase directory.
  </action>
  <verify>.planning/phases/02-supabase-optimization/02-04-SUMMARY.md exists with all required sections</verify>
  <done>Optimization verification document created with EXPLAIN ANALYZE results and performance summary</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. EXPLAIN ANALYZE confirms indexes are used (Index Scan, not Seq Scan)
2. RLS policies reviewed and documented (verification-only, no implementation)
3. Verification document created with before/after metrics
4. Success criteria status documented
5. Clear conclusion on whether Supabase optimization meets targets
</verification>

<success_criteria>
Phase 02 optimization verification complete:
- Index usage verified via EXPLAIN ANALYZE (Index Scan visible)
- RLS policies reviewed and documented (verification-only)
- Optimization document created with before/after metrics
- Success criteria status documented (P95 < 1 second targets)
- Clear conclusion on whether to proceed with Convex spike or use optimized Supabase
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-optimization/02-04-SUMMARY.md` (this is the verification document itself)
</output>
