---
phase: 02-supabase-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [supabase/migrations/43_optimization_indexes.sql]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "idx_contacts_workspace_phone index exists and supports workspace_id + phone queries"
    - "idx_conversations_workspace_time index exists and supports workspace_id + time queries"
    - "idx_messages_conversation_time index exists and supports conversation_id + time queries"
    - "EXPLAIN ANALYZE shows Index Scan using new indexes on hot path queries"
  artifacts:
    - path: "supabase/migrations/43_optimization_indexes.sql"
      provides: "Composite indexes for hot path queries"
      min_lines: 20
  key_links:
    - from: "supabase/migrations/43_optimization_indexes.sql"
      to: "contacts table"
      via: "idx_contacts_workspace_phone composite index"
      pattern: "CREATE INDEX.*idx_contacts_workspace_phone.*contacts"
    - from: "supabase/migrations/43_optimization_indexes.sql"
      to: "conversations table"
      via: "idx_conversations_workspace_time composite index"
      pattern: "CREATE INDEX.*idx_conversations_workspace_time.*conversations"
    - from: "supabase/migrations/43_optimization_indexes.sql"
      to: "messages table"
      via: "idx_messages_conversation_time composite index"
      pattern: "CREATE INDEX.*idx_messages_conversation_time.*messages"
---

<objective>
Create composite indexes on hot path tables to enable efficient query execution.

Purpose: Database indexes are foundational - without them, query optimization cannot succeed. Adding composite indexes matching query patterns (workspace_id + phone, workspace_id + time) enables PostgreSQL's planner to use index scans instead of sequential scans.
Output: Migration file creating three composite indexes that match the query patterns in /api/contacts/by-phone and /api/conversations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-supabase-optimization/02-CONTEXT.md
@.planning/phases/02-supabase-optimization/02-RESEARCH.md
@src/app/api/contacts/by-phone/route.ts
@src/app/api/conversations/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create composite indexes migration</name>
  <files>supabase/migrations/43_optimization_indexes.sql</files>
  <action>
Create migration file with three composite indexes:

1. idx_contacts_workspace_phone on contacts(workspace_id, phone)
   - Supports: /api/contacts/by-phone WHERE workspace_id = ? AND phone = ?
   - Leftmost prefix: workspace_id first (low cardinality), then phone (high cardinality)

2. idx_conversations_workspace_time on conversations(workspace_id, last_message_at DESC)
   - Supports: /api/conversations WHERE workspace_id = ? ORDER BY last_message_at DESC
   - DESC included for documentation (Postgres supports reverse scan)

3. idx_messages_conversation_time on messages(conversation_id, created_at DESC)
   - Supports: Message pagination WHERE conversation_id = ? ORDER BY created_at DESC

Use CONCURRENTLY for all indexes to avoid blocking:
CREATE INDEX CONCURRENTLY IF NOT EXISTS ...

Pattern: Reference migration 26_tickets.sql for CONCURRENTLY usage example.

Do NOT include any table schema changes - only CREATE INDEX statements.
  </action>
  <verify>supabase/migrations/43_optimization_indexes.sql exists and contains 3 CREATE INDEX statements with CONCURRENTLY</verify>
  <done>Migration file created with three composite indexes using CONCURRENTLY to avoid downtime</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration to database</name>
  <files>supabase/migrations/43_optimization_indexes.sql</files>
  <action>
Run the migration using Supabase CLI. Connect to the Supabase project (my21staff, tcpqqublnkphuwhhwizx) and execute the migration.

Use: supabase db push or execute directly via Supabase dashboard SQL Editor.

Verify indexes are created by querying pg_indexes:
SELECT indexname, tablename FROM pg_indexes WHERE indexname LIKE 'idx_%_workspace%' OR indexname LIKE 'idx_messages_conversation%';
  </action>
  <verify>supabase db push succeeds OR pg_indexes query shows the three new indexes</verify>
  <done>All three composite indexes created in production database</done>
</task>

<task type="auto">
  <name>Task 3: Verify index usage with EXPLAIN ANALYZE</name>
  <files>none (verification only)</files>
  <action>
Run EXPLAIN ANALYZE on representative queries to confirm indexes are being used:

1. Contact lookup:
EXPLAIN ANALYZE SELECT id, name, phone FROM contacts WHERE workspace_id = 'test-workspace-id' AND phone = '6281234567890';

2. Conversations list:
EXPLAIN ANALYZE SELECT id, last_message_at FROM conversations WHERE workspace_id = 'test-workspace-id' ORDER BY last_message_at DESC LIMIT 50;

Look for "Index Scan using idx_contacts_workspace_phone" and "Index Scan using idx_conversations_workspace_time" in the output.
Not seeing "Seq Scan" indicates index is being used.

Save EXPLAIN ANALYZE output to a temporary comment in the migration or as a note for comparison.
  </action>
  <verify>EXPLAIN ANALYZE output shows Index Scan (not Seq Scan) for both queries</verify>
  <done>EXPLAIN ANALYZE confirms indexes are used - Index Scan visible in query plans</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. Migration file exists in supabase/migrations/ directory
2. All three indexes exist in database (check via pg_indexes or Supabase dashboard)
3. EXPLAIN ANALYZE on sample queries shows Index Scan (not Seq Scan)
4. No production downtime (CONCURRENTLY used)
</verification>

<success_criteria>
Three composite indexes created and verified:
- idx_contacts_workspace_phone on contacts(workspace_id, phone)
- idx_conversations_workspace_time on conversations(workspace_id, last_message_at DESC)
- idx_messages_conversation_time on messages(conversation_id, created_at DESC)

EXPLAIN ANALYZE confirms indexes are used for hot path queries.
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-optimization/02-01-SUMMARY.md`
</output>
