---
phase: 01-instrumentation-baseline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/layout.tsx
  - src/lib/instrumentation/with-timing.ts
autonomous: true

must_haves:
  truths:
    - "Speed Insights component renders in production"
    - "withTiming HOF can wrap API route handlers"
    - "Query timing helpers exist and can be imported"
  artifacts:
    - path: "src/lib/instrumentation/with-timing.ts"
      provides: "API timing HOF and query logging helpers"
      exports: ["withTiming", "createRequestMetrics", "logQuery"]
    - path: "src/app/layout.tsx"
      provides: "SpeedInsights component in root layout"
      contains: "SpeedInsights"
  key_links:
    - from: "src/app/layout.tsx"
      to: "@vercel/speed-insights/next"
      via: "SpeedInsights component import"
      pattern: "import.*SpeedInsights.*@vercel/speed-insights"
---

<objective>
Install Vercel Speed Insights and create API timing infrastructure.

Purpose: Establish the instrumentation foundation before instrumenting specific routes.
Output: SpeedInsights in layout, withTiming HOF ready for use in API routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-instrumentation-baseline/01-RESEARCH.md
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Speed Insights and add to layout</name>
  <files>package.json, src/app/layout.tsx</files>
  <action>
1. Install @vercel/speed-insights:
   ```
   npm install @vercel/speed-insights
   ```

2. Update src/app/layout.tsx:
   - Import SpeedInsights from "@vercel/speed-insights/next"
   - Add `<SpeedInsights />` component as last child inside `<body>` (after Toaster)
   - SpeedInsights will auto-detect routes in Next.js App Router

Note: The component alone is not enough - Speed Insights must also be enabled in Vercel Dashboard (covered in Plan 03 checkpoint).
  </action>
  <verify>
1. `npm ls @vercel/speed-insights` shows package installed
2. `grep -r "SpeedInsights" src/app/layout.tsx` shows import and usage
  </verify>
  <done>
- @vercel/speed-insights installed
- SpeedInsights component renders in root layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Create withTiming HOF and query helpers</name>
  <files>src/lib/instrumentation/with-timing.ts</files>
  <action>
Create src/lib/instrumentation/with-timing.ts with:

1. **RequestMetrics interface:**
   ```typescript
   interface RequestMetrics {
     queryCount: number
     queries: string[]
   }
   ```

2. **createRequestMetrics()** - Factory to create metrics object for each request

3. **logQuery(metrics, table, durationMs)** - Log a query execution:
   - Increment queryCount
   - Push `"tablename:XXms"` to queries array

4. **withTiming(routeName, handler)** - Higher-order function:
   - Takes route name (e.g., '/api/contacts/by-phone') and handler function
   - Measures total execution time with performance.now()
   - Logs on success: `[API] /api/contacts/by-phone GET - 234ms - 200`
   - Logs on error: `[API] /api/contacts/by-phone GET - 234ms - ERROR: message`
   - Returns wrapped handler function

5. **logQuerySummary(routeName, metrics)** - Log query summary:
   - Format: `[Queries] /api/contacts/by-phone - 4 queries: contacts:45ms, contact_notes:23ms, ...`

Type the handler signature for Next.js 15 App Router:
```typescript
type RouteHandler = (
  request: NextRequest,
  context?: { params: Promise<Record<string, string>> }
) => Promise<NextResponse>
```

Use console.log for all logging (will appear in Vercel logs).
  </action>
  <verify>
1. File exists: `ls src/lib/instrumentation/with-timing.ts`
2. TypeScript compiles: `npx tsc --noEmit src/lib/instrumentation/with-timing.ts`
3. Exports exist: `grep -E "export (function|const)" src/lib/instrumentation/with-timing.ts`
  </verify>
  <done>
- withTiming HOF created with proper Next.js 15 types
- createRequestMetrics and logQuery helpers exported
- logQuerySummary helper for per-request query summary
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. `npm run build` succeeds (no TypeScript errors)
2. SpeedInsights import visible in layout
3. Instrumentation helpers ready for Plan 02
</verification>

<success_criteria>
- @vercel/speed-insights in package.json dependencies
- SpeedInsights component in root layout body
- src/lib/instrumentation/with-timing.ts exports withTiming, createRequestMetrics, logQuery, logQuerySummary
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-instrumentation-baseline/01-01-SUMMARY.md`
</output>
