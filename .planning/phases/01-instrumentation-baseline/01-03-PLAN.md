---
phase: 01-instrumentation-baseline
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - docs/BASELINE.md
autonomous: false

must_haves:
  truths:
    - "Instrumentation deployed to production"
    - "Speed Insights enabled in Vercel Dashboard"
    - "Baseline template document exists for metric capture"
  artifacts:
    - path: "docs/BASELINE.md"
      provides: "Performance baseline template"
      contains: "P50"
  key_links:
    - from: "Vercel Dashboard"
      to: "Speed Insights"
      via: "dashboard config"
      pattern: "N/A - manual verification"
---

<objective>
Deploy instrumentation to production and prepare baseline capture.

Purpose: Get instrumented code running in production so we can collect real metrics.
Output: Production deployment with working instrumentation, baseline template ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-instrumentation-baseline/01-RESEARCH.md
@.planning/phases/01-instrumentation-baseline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create baseline template document</name>
  <files>docs/BASELINE.md</files>
  <action>
Create docs/BASELINE.md with the following template:

```markdown
# Performance Baseline

**Captured:** [DATE - to be filled after 24-48 hours of production traffic]
**Environment:** Production (https://my21staff.com)
**Traffic sample:** [XX hours, ~XXX requests]

## Web Vitals (from Vercel Speed Insights)

| Metric | P50 | P75 | P95 | P99 | Target |
|--------|-----|-----|-----|-----|--------|
| LCP | - | - | - | - | <2.5s |
| INP | - | - | - | - | <200ms |
| CLS | - | - | - | - | <0.1 |
| FCP | - | - | - | - | <1.8s |
| TTFB | - | - | - | - | <800ms |

## API Response Times

### /api/contacts/by-phone
| Percentile | Response Time | Query Count |
|------------|---------------|-------------|
| P50 | -ms | - queries |
| P95 | -ms | - queries |
| P99 | -ms | - queries |

**Query breakdown (typical):**
- contacts: -ms
- contact_notes: -ms
- conversations: -ms
- messages: -ms

### /api/conversations
| Percentile | Response Time | Query Count |
|------------|---------------|-------------|
| P50 | -ms | - queries |
| P95 | -ms | - queries |
| P99 | -ms | - queries |

**Query breakdown (typical):**
- conversations: -ms
- activeCount: -ms
- teamMembers: -ms
- contactsWithTags: -ms

## Observations

- [ ] Observation 1
- [ ] Observation 2
- [ ] Observation 3

## Baseline Captured

- [ ] Speed Insights enabled and collecting (check dashboard)
- [ ] API logs showing timing data (check Vercel logs)
- [ ] Sufficient traffic sample (24-48 hours)
- [ ] Metrics filled in above tables

## Next Steps

Based on this baseline, proceed to Phase 2: Supabase Optimization.

---
*Template created: [DATE]*
*Baseline captured: [DATE - TBD]*
```

Note: Actual metrics will be filled in manually after 24-48 hours of production traffic.
  </action>
  <verify>
1. File exists: `ls docs/BASELINE.md`
2. Contains template tables: `grep "P50" docs/BASELINE.md`
  </verify>
  <done>
- Baseline template document created
- Tables ready for metric capture
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to production</name>
  <files>None (deployment)</files>
  <action>
1. Commit all instrumentation changes:
   ```bash
   git add -A
   git commit -m "feat(instrumentation): add Speed Insights and API timing

   - Install @vercel/speed-insights for Web Vitals tracking
   - Add withTiming HOF for API route instrumentation
   - Instrument /api/contacts/by-phone with query timing
   - Instrument /api/conversations with query timing
   - Create BASELINE.md template for metric capture

   Completes: INST-01, INST-02, INST-03, INST-04 (partial)

   Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
   ```

2. Push to trigger Vercel deployment:
   ```bash
   git push origin master
   ```

3. Wait for deployment to complete (check Vercel dashboard or CLI)
  </action>
  <verify>
1. `git log -1` shows instrumentation commit
2. Vercel deployment succeeds (check dashboard or `vercel ls`)
3. Production site loads: `curl -I https://my21staff.com`
  </verify>
  <done>
- All instrumentation committed and pushed
- Production deployment complete
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Performance instrumentation deployed to production:
- SpeedInsights component in root layout
- API timing wrappers on /api/contacts/by-phone and /api/conversations
- Query-level timing logging
  </what-built>
  <how-to-verify>
1. **Enable Speed Insights in Vercel Dashboard:**
   - Go to https://vercel.com/dashboard
   - Select my21staff project
   - Go to Speed Insights tab
   - Click "Enable" if not already enabled
   - Note: You must redeploy AFTER enabling for routes to work

2. **Verify SpeedInsights script loads:**
   - Visit https://my21staff.com
   - Open DevTools > Network tab
   - Search for "speed-insights" or "_vercel/speed-insights/script.js"
   - Should return 200, not 404

3. **Verify API timing in Vercel logs:**
   - Go to Vercel Dashboard > my21staff > Logs
   - Filter by "Runtime Logs"
   - Trigger an API call (use the inbox, etc.)
   - Look for logs like:
     ```
     [API] /api/conversations GET - 1234ms - 200
     [Queries] /api/conversations - 4 queries: ...
     ```

4. **Confirm Web Vitals collecting:**
   - Vercel Dashboard > Speed Insights tab
   - Should start showing data within minutes of traffic
   - If "No data yet", wait for more traffic or verify script loads
  </how-to-verify>
  <resume-signal>Type "confirmed" after verifying Speed Insights enabled and API logs showing timing data. Note any issues.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 instrumentation complete when:
1. Speed Insights enabled in Vercel Dashboard
2. SpeedInsights script loading on production pages (200, not 404)
3. API timing logs visible in Vercel logs
4. Query breakdown logs visible per request
5. BASELINE.md template exists (metrics filled in later)
</verification>

<success_criteria>
- Production deployment successful
- Speed Insights enabled in Vercel Dashboard
- SpeedInsights script loads (check Network tab)
- API timing visible in Vercel Runtime Logs
- Query count per request visible in logs
- BASELINE.md template created

Note: INST-05 (establish P50/P95/P99 baseline) requires 24-48 hours of production traffic.
After confirming instrumentation works, wait for sufficient traffic before filling in BASELINE.md.
</success_criteria>

<output>
After completion, create `.planning/phases/01-instrumentation-baseline/01-03-SUMMARY.md`
</output>
