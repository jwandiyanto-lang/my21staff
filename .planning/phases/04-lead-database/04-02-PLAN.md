---
phase: 04-lead-database
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - convex/kapso.ts
autonomous: true

must_haves:
  truths:
    - "Every inbound message updates contact lastActivityAt within 200ms"
    - "Every outbound message updates contact lastContactAt"
    - "Contact name/profile syncs from Kapso webhook data"
  artifacts:
    - path: "convex/kapso.ts"
      provides: "Enhanced webhook handler with timestamp tracking"
      contains: "lastActivityAt"
  key_links:
    - from: "convex/kapso.ts"
      to: "contacts table"
      via: "ctx.db.patch"
      pattern: "lastActivityAt.*Date\\.now"
---

<objective>
Enhance Kapso webhook handler to update activity timestamps on contacts for every message, enabling real-time lead tracking.

Purpose: Ensure every WhatsApp message (inbound and outbound) updates the contact's activity timestamps, making lead list sorting and "needs follow-up" queries accurate.
Output: Modified kapso.ts with timestamp updates on message processing.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-lead-database/04-RESEARCH.md
@convex/kapso.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update processWorkspaceMessages to track lastActivityAt</name>
  <files>convex/kapso.ts</files>
  <action>
In the `processWorkspaceMessages` function, modify the contact update logic to include `lastActivityAt`.

**In the existing contact update block (around line 280):**
Change from:
```typescript
const updates: any = {
  updated_at: now,
  phone_normalized: normalized,
  cache_updated_at: now,
};
```

To:
```typescript
const updates: any = {
  updated_at: now,
  phone_normalized: normalized,
  cache_updated_at: now,
  lastActivityAt: now, // NEW: Track all message activity
};
```

**In the new contact creation block (around line 297):**
Add `lastActivityAt` to the insert object:
```typescript
const contactId = await ctx.db.insert("contacts", {
  workspace_id: workspaceId,
  phone: normalized,
  phone_normalized: normalized,
  name: contactInfo?.profile?.name || undefined,
  kapso_name: contactInfo?.profile?.name || undefined,
  email: undefined,
  lead_score: 0,
  lead_status: "new",
  leadStatus: "new", // NEW: Initialize lead status
  lastActivityAt: now, // NEW: Track activity from creation
  tags: [],
  // ... rest of fields
});
```

This ensures:
1. Every inbound message updates `lastActivityAt` on the contact
2. New contacts start with `lastActivityAt` set
3. Existing `updated_at` field continues to work for backwards compatibility
  </action>
  <verify>
1. Search kapso.ts for "lastActivityAt" - should appear in contact update and insert
2. Run `npx convex dev --once` to validate no syntax errors
  </verify>
  <done>
processWorkspaceMessages updates lastActivityAt on every contact touch (update and create paths).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update logOutboundMessage to track lastContactAt</name>
  <files>convex/kapso.ts</files>
  <action>
In the `logOutboundMessage` mutation, add contact timestamp updates for outbound messages.

**Find the logOutboundMessage mutation (around line 946).**

After the conversation update, add a contact update:

```typescript
// Update contact timestamps for outbound message
const contact = await ctx.db.get(args.contact_id);
if (contact) {
  await ctx.db.patch(args.contact_id, {
    lastContactAt: now, // Human/bot reached out
    lastActivityAt: now, // Any activity
    updated_at: now,
  });
}
```

Insert this block right before the final closing brace of the handler, after the conversation patch.

This ensures:
1. `lastContactAt` updates when bot or human sends message
2. `lastActivityAt` also updates (any interaction)
3. Dashboard can query "leads not contacted in X days"
  </action>
  <verify>
1. Search kapso.ts for "lastContactAt" - should appear in logOutboundMessage
2. Run `npx convex dev --once` to validate
  </verify>
  <done>
logOutboundMessage updates both lastContactAt and lastActivityAt when sending messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle contact.updated events from Kapso</name>
  <files>convex/kapso.ts</files>
  <action>
Add handling for Kapso contact update events in the webhook processor.

**In processWebhook mutation, add a new event type check after the message handling:**

```typescript
// Handle Kapso contact.updated events (profile name changes)
if (payload.type === "contact.updated" || payload.event_type === "contact.updated") {
  const phoneNumberId = payload.phone_number_id;
  const contactData = payload.contact || payload.data;

  if (!phoneNumberId || !contactData) {
    console.log("[Kapso] Invalid contact.updated payload");
    return;
  }

  // Find workspace
  const workspace = await ctx.db
    .query("workspaces")
    .withIndex("by_kapso_phone", (q) =>
      q.eq("kapso_phone_id", phoneNumberId)
    )
    .first();

  if (!workspace) {
    console.log(`[Kapso] No workspace for phone_number_id: ${phoneNumberId}`);
    return;
  }

  // Find and update contact
  const phone = contactData.phone_number || contactData.wa_id;
  if (phone) {
    const normalized = phone.replace(/\D/g, "");
    const existing = await ctx.db
      .query("contacts")
      .withIndex("by_workspace_phone", (q) =>
        q.eq("workspace_id", workspace._id).eq("phone", normalized)
      )
      .first();

    if (existing) {
      const now = Date.now();
      await ctx.db.patch(existing._id, {
        kapso_name: contactData.display_name || contactData.profile?.name,
        name: existing.name || contactData.display_name || contactData.profile?.name,
        lastActivityAt: now,
        updated_at: now,
      });
      console.log(`[Kapso] Updated contact profile: ${normalized}`);
    }
  }
  return;
}
```

Place this block near the top of the processWebhook handler, before the existing message processing logic.

This ensures:
1. Contact name updates sync from Kapso when WhatsApp profile changes
2. Only updates kapso_name if different from existing
3. Only sets name if contact doesn't have one (human-entered names preserved)
  </action>
  <verify>
1. Search kapso.ts for "contact.updated" - should appear in processWebhook
2. Run `npx convex dev --once` to validate
  </verify>
  <done>
Webhook handles contact.updated events from Kapso, syncing profile name changes to Convex.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` completes without errors
2. kapso.ts contains lastActivityAt in processWorkspaceMessages (2 locations)
3. kapso.ts contains lastContactAt in logOutboundMessage
4. kapso.ts handles contact.updated event type
</verification>

<success_criteria>
- Every inbound message updates contact lastActivityAt
- Every outbound message updates contact lastContactAt and lastActivityAt
- Contact profile changes from Kapso sync to Convex
- All updates happen within existing webhook flow (no additional latency)
</success_criteria>

<output>
After completion, create `.planning/phases/04-lead-database/04-02-SUMMARY.md`
</output>
