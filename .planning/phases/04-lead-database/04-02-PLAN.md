---
phase: 04-lead-database
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - convex/kapso.ts
autonomous: true

must_haves:
  truths:
    - "Every inbound message updates contact lastActivityAt within 200ms"
    - "Every outbound message updates contact lastContactAt"
    - "Contact name/profile syncs from Kapso webhook data"
    - "All messages (inbound and outbound) are stored in messages table"
  artifacts:
    - path: "convex/kapso.ts"
      provides: "Enhanced webhook handler with timestamp tracking and message sync"
      contains: "lastActivityAt"
  key_links:
    - from: "convex/kapso.ts"
      to: "contacts table"
      via: "ctx.db.patch"
      pattern: "lastActivityAt.*Date\\.now"
    - from: "convex/kapso.ts"
      to: "messages table"
      via: "ctx.db.insert"
      pattern: "messages.*direction"
---

<objective>
Enhance Kapso webhook handler to update activity timestamps on contacts for every message, enabling real-time lead tracking. Verify bidirectional message sync is complete.

Purpose: Ensure every WhatsApp message (inbound and outbound) updates the contact's activity timestamps and is stored in the messages table, making lead list sorting and "needs follow-up" queries accurate.
Output: Modified kapso.ts with timestamp updates on message processing and verified message storage.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-lead-database/04-RESEARCH.md
@convex/kapso.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update processWorkspaceMessages to track lastActivityAt</name>
  <files>convex/kapso.ts</files>
  <action>
In the `processWorkspaceMessages` function, modify the contact update logic to include `lastActivityAt`.

**In the existing contact update block (around line 280):**
Change from:
```typescript
const updates: any = {
  updated_at: now,
  phone_normalized: normalized,
  cache_updated_at: now,
};
```

To:
```typescript
const updates: any = {
  updated_at: now,
  phone_normalized: normalized,
  cache_updated_at: now,
  lastActivityAt: now, // NEW: Track all message activity
};
```

**In the new contact creation block (around line 297):**
Add `lastActivityAt` and `leadStatus` to the insert object:
```typescript
const contactId = await ctx.db.insert("contacts", {
  workspace_id: workspaceId,
  phone: normalized,
  phone_normalized: normalized,
  name: contactInfo?.profile?.name || undefined,
  kapso_name: contactInfo?.profile?.name || undefined,
  email: undefined,
  lead_score: 0,
  lead_status: "new",
  leadStatus: "new", // NEW: Initialize lead status
  lastActivityAt: now, // NEW: Track activity from creation
  tags: [],
  // ... rest of fields
});
```

This ensures:
1. Every inbound message updates `lastActivityAt` on the contact
2. New contacts start with `lastActivityAt` set
3. Existing `updated_at` field continues to work for backwards compatibility
  </action>
  <verify>
1. Grep kapso.ts for "lastActivityAt" - should appear in contact update and insert blocks
2. Run `npx convex dev --once` to validate no syntax errors
  </verify>
  <done>
processWorkspaceMessages updates lastActivityAt on every contact touch (update and create paths).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update logOutboundMessage to track lastContactAt</name>
  <files>convex/kapso.ts</files>
  <action>
In the `logOutboundMessage` mutation, add contact timestamp updates for outbound messages.

**Find the logOutboundMessage mutation (around line 946).**

After the conversation update, add a contact update:

```typescript
// Update contact timestamps for outbound message
const contact = await ctx.db.get(args.contact_id);
if (contact) {
  await ctx.db.patch(args.contact_id, {
    lastContactAt: now, // Human/bot reached out
    lastActivityAt: now, // Any activity
    updated_at: now,
  });
}
```

Insert this block right before the final closing brace of the handler, after the conversation patch.

This ensures:
1. `lastContactAt` updates when bot or human sends message
2. `lastActivityAt` also updates (any interaction)
3. Dashboard can query "leads not contacted in X days"
  </action>
  <verify>
1. Grep kapso.ts for "lastContactAt" - should appear in logOutboundMessage
2. Run `npx convex dev --once` to validate
  </verify>
  <done>
logOutboundMessage updates both lastContactAt and lastActivityAt when sending messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify bidirectional message sync (LEAD-02)</name>
  <files>convex/kapso.ts</files>
  <action>
Verify that ALL messages are synced to the messages table by checking existing code paths:

**1. Verify INBOUND message sync (processWorkspaceMessages):**
Check that the existing code at ~line 458 creates inbound messages:
```typescript
await ctx.db.insert("messages", {
  conversation_id: conversation._id,
  workspace_id: workspaceId,
  direction: "inbound",
  // ... other fields
});
```

**2. Verify OUTBOUND message sync (logOutboundMessage):**
Check that the existing code at ~line 967 creates outbound messages:
```typescript
await ctx.db.insert("messages" as any, {
  conversation_id: conversation._id,
  workspace_id: args.workspace_id,
  direction: "outbound",
  // ... other fields
});
```

**3. Add logging for message sync verification:**
After the message insert in both locations, add a log:
```typescript
console.log(`[Kapso Sync] Message synced: direction=${direction}, kapso_id=${kapso_message_id}`);
```

**4. Handle contact.updated events from Kapso:**
Add handling for Kapso contact update events in the webhook processor.

In processWebhook mutation, add a new event type check after the message handling:

```typescript
// Handle Kapso contact.updated events (profile name changes)
if (payload.type === "contact.updated" || payload.event_type === "contact.updated") {
  const phoneNumberId = payload.phone_number_id;
  const contactData = payload.contact || payload.data;

  if (!phoneNumberId || !contactData) {
    console.log("[Kapso] Invalid contact.updated payload");
    return;
  }

  // Find workspace
  const workspace = await ctx.db
    .query("workspaces")
    .withIndex("by_kapso_phone", (q) =>
      q.eq("kapso_phone_id", phoneNumberId)
    )
    .first();

  if (!workspace) {
    console.log(`[Kapso] No workspace for phone_number_id: ${phoneNumberId}`);
    return;
  }

  // Find and update contact
  const phone = contactData.phone_number || contactData.wa_id;
  if (phone) {
    const normalized = phone.replace(/\D/g, "");
    const existing = await ctx.db
      .query("contacts")
      .withIndex("by_workspace_phone", (q) =>
        q.eq("workspace_id", workspace._id).eq("phone", normalized)
      )
      .first();

    if (existing) {
      const now = Date.now();
      await ctx.db.patch(existing._id, {
        kapso_name: contactData.display_name || contactData.profile?.name,
        name: existing.name || contactData.display_name || contactData.profile?.name,
        lastActivityAt: now,
        updated_at: now,
      });
      console.log(`[Kapso] Updated contact profile: ${normalized}`);
    }
  }
  return;
}
```

Place this block near the top of the processWebhook handler, before the existing message processing logic.
  </action>
  <verify>
1. Grep kapso.ts for 'direction: "inbound"' - should find in processWorkspaceMessages
2. Grep kapso.ts for 'direction: "outbound"' - should find in logOutboundMessage
3. Grep kapso.ts for "contact.updated" - should find handler
4. Run `npx convex dev --once` to validate
  </verify>
  <done>
Both inbound and outbound message paths confirmed to sync messages to Convex. Contact.updated webhook handler added. Logging added for sync verification.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` completes without errors
2. kapso.ts contains lastActivityAt in processWorkspaceMessages (2 locations)
3. kapso.ts contains lastContactAt in logOutboundMessage
4. kapso.ts handles contact.updated event type
5. Messages table receives both inbound and outbound messages
</verification>

<success_criteria>
- Every inbound message updates contact lastActivityAt
- Every outbound message updates contact lastContactAt and lastActivityAt
- Contact profile changes from Kapso sync to Convex
- All messages (both directions) stored in messages table
- All updates happen within existing webhook flow (no additional latency)
</success_criteria>

<output>
After completion, create `.planning/phases/04-lead-database/04-02-SUMMARY.md`
</output>
