---
phase: 01-database-inbox-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/34_ari_tables.sql
autonomous: true

must_haves:
  truths:
    - "ARI config can be stored per workspace"
    - "Universities/destinations can be added with requirements"
    - "ARI conversation state is tracked separately from inbox conversations"
    - "ARI messages are logged with role (assistant/user) and AI model info"
    - "Payments can be recorded with Midtrans transaction data"
    - "Appointments can be scheduled with status tracking"
    - "AI model comparison metrics can be stored for A/B testing"
  artifacts:
    - path: "supabase/migrations/34_ari_tables.sql"
      provides: "ARI database tables: ari_config, ari_destinations, ari_conversations, ari_messages, ari_payments, ari_appointments, ari_ai_comparison"
      min_lines: 200
  key_links:
    - from: "ari_conversations"
      to: "contacts"
      via: "contact_id FK"
      pattern: "REFERENCES contacts\\(id\\)"
    - from: "ari_messages"
      to: "ari_conversations"
      via: "ari_conversation_id FK"
      pattern: "REFERENCES ari_conversations\\(id\\)"
    - from: "ari_payments"
      to: "ari_conversations"
      via: "ari_conversation_id FK"
      pattern: "REFERENCES ari_conversations\\(id\\)"
    - from: "ari_appointments"
      to: "ari_conversations"
      via: "ari_conversation_id FK"
      pattern: "REFERENCES ari_conversations\\(id\\)"
---

<objective>
Create ARI database tables for bot configuration, knowledge base, conversation tracking, payments, and appointments.

Purpose: Foundation for ARI WhatsApp bot functionality - stores persona config, university knowledge base, conversation state, payment records, and appointment scheduling.

Output: Single migration file with 7 tables following existing schema conventions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-inbox-overhaul/01-CONTEXT.md
@.planning/phases/01-database-inbox-overhaul/01-RESEARCH.md
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ARI tables migration</name>
  <files>supabase/migrations/34_ari_tables.sql</files>
  <action>
Create migration file with 7 ARI tables following existing conventions (UUID PKs, workspace_id FK, TIMESTAMPTZ columns):

**ari_config** (DB-01):
- id, workspace_id (FK, unique), bot_name (default 'ARI'), greeting_style ('casual'/'formal'/'professional'), language (default 'id'), tone JSONB (supportive, clear, encouraging), community_link TEXT, created_at, updated_at
- One config per workspace (UNIQUE constraint)

**ari_destinations** (DB-02):
- id, workspace_id (FK), country, city, university_name, requirements JSONB (ielts_min, gpa_min, budget_min, budget_max, deadline), programs TEXT[], is_promoted BOOLEAN, priority INTEGER, notes TEXT, created_at, updated_at
- UNIQUE(workspace_id, country, city, university_name)

**ari_conversations** (DB-03):
- id, workspace_id (FK), contact_id (FK to contacts), conversation_id (FK to conversations, nullable - link to inbox conversation)
- state VARCHAR(50) DEFAULT 'greeting' (greeting, qualifying, scoring, booking, payment, scheduling, handoff, completed)
- lead_score INTEGER DEFAULT 0, lead_temperature VARCHAR(20) (hot/warm/cold)
- context JSONB DEFAULT '{}' (collected info: name, form_data, document_status, etc.)
- ai_model VARCHAR(50) (grok/sea-lion)
- last_ai_message_at, handoff_at, handoff_reason
- created_at, updated_at
- UNIQUE(workspace_id, contact_id)

**ari_messages** (DB-04):
- id, ari_conversation_id (FK to ari_conversations), workspace_id (FK)
- role VARCHAR(20) NOT NULL (assistant/user/system)
- content TEXT NOT NULL
- ai_model VARCHAR(50) (which model generated this)
- tokens_used INTEGER
- response_time_ms INTEGER
- metadata JSONB DEFAULT '{}'
- created_at

**ari_payments** (DB-05):
- id, ari_conversation_id (FK), workspace_id (FK)
- amount INTEGER NOT NULL (in cents/smallest unit)
- currency VARCHAR(3) DEFAULT 'IDR'
- payment_method VARCHAR(50) (qris, gopay, ovo, bank_transfer, card)
- gateway VARCHAR(50) DEFAULT 'midtrans'
- gateway_transaction_id VARCHAR(255)
- gateway_response JSONB
- status VARCHAR(50) DEFAULT 'pending' (pending, success, failed, expired, refunded)
- expires_at TIMESTAMPTZ
- paid_at TIMESTAMPTZ
- created_at, updated_at

**ari_appointments** (DB-06):
- id, ari_conversation_id (FK), workspace_id (FK)
- payment_id UUID (FK to ari_payments, nullable)
- consultant_id UUID (FK to auth.users, nullable)
- scheduled_at TIMESTAMPTZ NOT NULL
- duration_minutes INTEGER DEFAULT 60
- meeting_link TEXT
- status VARCHAR(50) DEFAULT 'scheduled' (scheduled, confirmed, completed, cancelled, no_show)
- reminder_sent_at TIMESTAMPTZ
- notes TEXT
- created_at, updated_at

**ari_ai_comparison** (DB-07):
- id, workspace_id (FK)
- ai_model VARCHAR(50) NOT NULL
- conversation_count INTEGER DEFAULT 0
- avg_response_time_ms INTEGER
- total_tokens_used INTEGER DEFAULT 0
- conversion_count INTEGER DEFAULT 0 (leads that converted to paid)
- satisfaction_score DECIMAL(3,2) (optional: 0.00-5.00)
- period_start TIMESTAMPTZ, period_end TIMESTAMPTZ
- created_at, updated_at
- UNIQUE(workspace_id, ai_model, period_start)

Add updated_at triggers for tables that need it (all except ari_messages and ari_ai_comparison).
  </action>
  <verify>
Run in Supabase SQL Editor or via CLI:
```sql
-- Check tables exist
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public' AND table_name LIKE 'ari_%';
-- Should return 7 tables
```
  </verify>
  <done>7 ARI tables created with proper FKs, indexes, and constraints</done>
</task>

<task type="auto">
  <name>Task 2: Add performance indexes</name>
  <files>supabase/migrations/34_ari_tables.sql</files>
  <action>
Add indexes to the same migration file (at the bottom) for common query patterns:

```sql
-- ari_config: lookup by workspace
CREATE INDEX idx_ari_config_workspace ON ari_config(workspace_id);

-- ari_destinations: search by country, promoted items
CREATE INDEX idx_ari_destinations_workspace ON ari_destinations(workspace_id);
CREATE INDEX idx_ari_destinations_country ON ari_destinations(workspace_id, country);
CREATE INDEX idx_ari_destinations_promoted ON ari_destinations(workspace_id, is_promoted) WHERE is_promoted = true;

-- ari_conversations: active conversations, by contact
CREATE INDEX idx_ari_conversations_workspace ON ari_conversations(workspace_id);
CREATE INDEX idx_ari_conversations_contact ON ari_conversations(contact_id);
CREATE INDEX idx_ari_conversations_state ON ari_conversations(workspace_id, state);

-- ari_messages: by conversation, chronological
CREATE INDEX idx_ari_messages_conversation ON ari_messages(ari_conversation_id);
CREATE INDEX idx_ari_messages_workspace ON ari_messages(workspace_id);
CREATE INDEX idx_ari_messages_created ON ari_messages(created_at DESC);

-- ari_payments: by status, pending payments
CREATE INDEX idx_ari_payments_conversation ON ari_payments(ari_conversation_id);
CREATE INDEX idx_ari_payments_workspace ON ari_payments(workspace_id);
CREATE INDEX idx_ari_payments_status ON ari_payments(workspace_id, status);
CREATE INDEX idx_ari_payments_pending ON ari_payments(workspace_id, status, expires_at) WHERE status = 'pending';

-- ari_appointments: upcoming appointments
CREATE INDEX idx_ari_appointments_conversation ON ari_appointments(ari_conversation_id);
CREATE INDEX idx_ari_appointments_workspace ON ari_appointments(workspace_id);
CREATE INDEX idx_ari_appointments_scheduled ON ari_appointments(workspace_id, scheduled_at);
CREATE INDEX idx_ari_appointments_consultant ON ari_appointments(consultant_id) WHERE consultant_id IS NOT NULL;

-- ari_ai_comparison: by model and period
CREATE INDEX idx_ari_ai_comparison_workspace ON ari_ai_comparison(workspace_id);
CREATE INDEX idx_ari_ai_comparison_model ON ari_ai_comparison(workspace_id, ai_model);
```
  </action>
  <verify>
Check indexes exist:
```sql
SELECT indexname FROM pg_indexes WHERE tablename LIKE 'ari_%';
```
  </verify>
  <done>Performance indexes added for all ARI tables</done>
</task>

</tasks>

<verification>
After running migration:
1. All 7 tables exist: `SELECT count(*) FROM information_schema.tables WHERE table_name LIKE 'ari_%'` returns 7
2. Foreign keys work: Can insert test data with valid workspace_id and contact_id
3. Unique constraints work: Duplicate (workspace_id, contact_id) in ari_conversations fails
4. Indexes exist: `SELECT count(*) FROM pg_indexes WHERE tablename LIKE 'ari_%'` returns expected count
</verification>

<success_criteria>
- [x] 7 ARI tables created (ari_config, ari_destinations, ari_conversations, ari_messages, ari_payments, ari_appointments, ari_ai_comparison)
- [x] All tables have workspace_id FK with ON DELETE CASCADE
- [x] Proper foreign key relationships established
- [x] Unique constraints prevent duplicates
- [x] Performance indexes added for common queries
- [x] updated_at triggers applied to relevant tables
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-inbox-overhaul/01-01-SUMMARY.md`
</output>
