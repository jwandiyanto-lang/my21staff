---
phase: 02-ari-core-conversation
plan: 04
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/lib/ari/qualification.ts
  - src/lib/ari/context-builder.ts
  - src/lib/ari/index.ts
autonomous: true

must_haves:
  truths:
    - "ARI identifies missing form fields"
    - "ARI generates follow-up questions for missing data"
    - "ARI tracks document readiness (passport, CV, IELTS, transcript)"
    - "Document status stored in conversation context"
  artifacts:
    - path: "src/lib/ari/qualification.ts"
      provides: "Form validation and follow-up questions"
      exports: ["getMissingFields", "getFollowUpQuestion", "updateDocumentStatus", "parseDocumentResponse"]
  key_links:
    - from: "src/lib/ari/qualification.ts"
      to: "ari_conversations.context"
      via: "document status update"
      pattern: "documents|passport|cv|ielts|transcript"
---

# 02-04-PLAN: ARI Form Validation and Qualification

## Goal

Build form validation logic to identify missing data and generate intelligent follow-up questions.

## Context

**From 02-02-PLAN:** Context builder creates prompts with form data

**Form fields from Google Form (via n8n):**
Based on Eagle Overseas form structure:
- name: Full name
- email: Email address
- phone: WhatsApp number (already matched)
- english_level: Pemula/Menengah/Mahir
- budget: Budget range in IDR
- timeline: When they want to start
- activity: Working/Student
- country: Target destination
- notes: Additional info

**Document readiness (ARI-05):**
- passport: Do you have a valid passport?
- cv: Do you have your CV ready?
- english_test: IELTS/TOEFL score or plan to take?
- transcript: Academic transcripts available?

## Tasks

<task id="1">
<title>Create form validation and missing field detection</title>
<action>
1. Create `src/lib/ari/qualification.ts`:

2. Define required fields for qualification:
   ```typescript
   const REQUIRED_FIELDS = [
     'name',
     'email',
     'english_level',
     'budget',
     'timeline',
     'country',
   ] as const;

   const IMPORTANT_FIELDS = [
     'activity',
     'notes',
   ] as const;
   ```

3. Implement `getMissingFields(formAnswers: Record<string, string>)`:
   - Check each REQUIRED_FIELD
   - Return list of missing field names
   - Consider empty string as missing
   - Return { required: string[], important: string[] }

4. Implement `getFieldLabel(fieldName: string): string`:
   - Map field names to Indonesian labels:
     - name -> "nama lengkap"
     - email -> "alamat email"
     - english_level -> "kemampuan bahasa Inggris"
     - budget -> "budget"
     - timeline -> "kapan mau mulai kuliah"
     - country -> "negara tujuan"
     - activity -> "status (kerja/kuliah)"
   - Return the Indonesian label

5. Implement `getFollowUpQuestion(missingField: string): string`:
   - Return natural Indonesian question for each field:
     - name -> "Boleh tau nama lengkapnya siapa kak?"
     - email -> "Email yang aktif apa kak? Buat kirim info lebih lanjut."
     - english_level -> "Kalau bahasa Inggris, udah di level mana kak? Pemula, menengah, atau udah mahir?"
     - budget -> "Budget untuk kuliah kira-kira berapa kak? Nanti saya carikan yang cocok."
     - timeline -> "Rencananya mau berangkat kapan kak? Tahun ini atau tahun depan?"
     - country -> "Negara tujuannya kemana kak? UK, Australia, atau yang lain?"
   - Return the question string
</action>
<verify>
- File exists at src/lib/ari/qualification.ts
- getMissingFields correctly identifies empty/missing fields
- getFollowUpQuestion returns Indonesian questions
- All required fields have corresponding questions
</verify>
</task>

<task id="2">
<title>Create document readiness tracking</title>
<action>
1. Add to `src/lib/ari/qualification.ts`:

2. Define document types:
   ```typescript
   interface DocumentStatus {
     passport: boolean | null;  // null = not asked yet
     cv: boolean | null;
     english_test: boolean | null;
     transcript: boolean | null;
   }
   ```

3. Implement `getDocumentQuestions(): Array<{ key: string; question: string }>`:
   ```typescript
   return [
     {
       key: 'passport',
       question: 'Paspor udah punya belum kak?'
     },
     {
       key: 'cv',
       question: 'CV atau resume udah siap kak?'
     },
     {
       key: 'english_test',
       question: 'Udah punya skor IELTS atau TOEFL kak? Atau masih rencana mau ambil?'
     },
     {
       key: 'transcript',
       question: 'Transkrip akademik dari kampus/sekolah udah ada kak?'
     },
   ];
   ```

4. Implement `parseDocumentResponse(response: string): boolean | null`:
   - Check for positive indicators: 'sudah', 'udah', 'ada', 'punya', 'yes', 'iya'
   - Check for negative indicators: 'belum', 'tidak', 'gak', 'no', 'nggak'
   - Return true/false or null if unclear

5. Implement `updateDocumentStatus(current: DocumentStatus, key: string, value: boolean)`:
   - Return new DocumentStatus with updated key
   - Immutable update pattern

6. Implement `getNextDocumentQuestion(status: DocumentStatus): string | null`:
   - Find first document with null status
   - Return its question, or null if all asked
</action>
<verify>
- DocumentStatus type exported
- parseDocumentResponse('udah ada') returns true
- parseDocumentResponse('belum') returns false
- parseDocumentResponse('mungkin') returns null
- getNextDocumentQuestion returns null when all documents checked
</verify>
</task>

<task id="3">
<title>Integrate qualification into context builder</title>
<action>
1. Update `src/lib/ari/context-builder.ts`:

2. Import from qualification.ts:
   ```typescript
   import {
     getMissingFields,
     getFollowUpQuestion,
     getNextDocumentQuestion,
     DocumentStatus,
   } from './qualification';
   ```

3. Extend PromptContext.conversation.context type to include:
   ```typescript
   documents?: DocumentStatus;
   askedFields?: string[]; // Fields we've already asked about
   ```

4. Update `buildSystemPrompt()` for 'qualifying' state:
   - Check missing fields using getMissingFields
   - If missing required fields, include instruction to ask about NEXT missing field
   - Include the specific follow-up question in prompt
   - If no missing fields, check document status
   - If documents incomplete, include next document question

5. Add to prompt for qualifying state:
   ```
   ## QUALIFYING INSTRUCTIONS
   Data yang masih kosong: {missingFields.join(', ')}
   Tanyakan: {getFollowUpQuestion(firstMissingField)}

   Kalau data form sudah lengkap, tanyakan dokumen:
   {getNextDocumentQuestion(documentStatus)}

   PENTING: Tanya SATU hal per pesan. Jangan borong!
   ```

6. Update `src/lib/ari/index.ts` to export qualification utilities:
   - Export getMissingFields, getFollowUpQuestion, getNextDocumentQuestion
   - Export DocumentStatus type
   - Export parseDocumentResponse, updateDocumentStatus
</action>
<verify>
- buildSystemPrompt includes missing field questions when in qualifying state
- Document questions appear after form data is complete
- Only one question per message is emphasized in prompt
- All qualification functions exported from @/lib/ari
</verify>
</task>

## Verification

- [ ] getMissingFields identifies empty required fields
- [ ] Follow-up questions are natural Indonesian
- [ ] Document status tracking works (passport, CV, IELTS, transcript)
- [ ] Context builder includes qualification instructions
- [ ] One question at a time rule enforced in prompt

## Success Criteria

- ARI identifies incomplete form submissions
- ARI asks specific follow-up questions for missing data
- ARI tracks document readiness status
- Questions are in natural Indonesian language

## Requirements Addressed

- **ARI-03**: Validate form completeness and ask follow-up questions
- **ARI-05**: Ask document readiness questions
- **ARI-07**: Natural Indonesian language
