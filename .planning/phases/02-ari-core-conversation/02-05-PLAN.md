---
phase: 02-ari-core-conversation
plan: 05
type: execute
wave: 4
depends_on: [02-03, 02-04]
files_modified:
  - src/lib/ari/knowledge-base.ts
  - src/lib/ari/context-builder.ts
  - src/lib/ari/processor.ts
  - src/lib/ari/index.ts
autonomous: true

must_haves:
  truths:
    - "ARI fetches relevant destinations from knowledge base"
    - "ARI answers university questions using destination data"
    - "Promoted destinations appear first in recommendations"
    - "Requirements info (IELTS, budget) included in responses"
    - "Document responses parsed and saved to ari_conversations.context.documents"
  artifacts:
    - path: "src/lib/ari/knowledge-base.ts"
      provides: "University/destination lookup"
      exports: ["getDestinationsForCountry", "findMatchingDestinations", "formatDestinationInfo"]
  key_links:
    - from: "src/lib/ari/knowledge-base.ts"
      to: "ari_destinations table"
      via: "supabase query"
      pattern: "from\\('ari_destinations'\\)"
    - from: "src/lib/ari/processor.ts"
      to: "parseDocumentResponse"
      via: "import and call"
      pattern: "parseDocumentResponse"
    - from: "src/lib/ari/processor.ts"
      to: "ari_conversations.context"
      via: "supabase update"
      pattern: "update.*context.*documents"
---

# 02-05-PLAN: ARI Knowledge Base Integration

## Goal

Enable ARI to answer university and destination questions using the knowledge base (ari_destinations table).

## Context

**From 02-03-PLAN:** Webhook integration working
**From 02-04-PLAN:** Qualification logic ready, including parseDocumentResponse and updateDocumentStatus

**Database schema (ari_destinations):**
- country, city, university_name
- requirements: JSONB with ielts_min, gpa_min, budget_min, budget_max, deadline
- programs: TEXT[] array of available programs
- is_promoted: boolean for priority display
- priority: integer for ordering
- notes: special info (scholarships, etc.)

**Common user questions:**
- "Universitas apa yang bagus di UK?"
- "Berapa biaya kuliah di Australia?"
- "Syarat IELTS untuk kuliah di Kanada?"
- "Ada beasiswa gak?"

## Tasks

<task id="1">
<title>Create knowledge base query functions</title>
<action>
1. Create `src/lib/ari/knowledge-base.ts`:

2. Import SupabaseClient type and create query functions:

3. Implement `getDestinationsForCountry(supabase, workspaceId, country)`:
   - Query ari_destinations WHERE workspace_id AND country (case-insensitive)
   - Order by is_promoted DESC, priority DESC
   - Return array of destinations with requirements

4. Implement `findMatchingDestinations(supabase, workspaceId, criteria)`:
   ```typescript
   interface SearchCriteria {
     country?: string;
     maxBudget?: number;
     minIelts?: number;
     program?: string;
   }
   ```
   - Build query based on provided criteria
   - Filter by budget_max <= maxBudget if provided
   - Filter by ielts_min <= minIelts if provided
   - Use ILIKE for program search in programs array
   - Return matching destinations

5. Implement `getPromotedDestinations(supabase, workspaceId, limit = 3)`:
   - Query WHERE is_promoted = true
   - Order by priority DESC
   - Limit results
   - Used for proactive recommendations

6. Define types:
   ```typescript
   interface Destination {
     id: string;
     country: string;
     city: string | null;
     university_name: string;
     requirements: {
       ielts_min?: number;
       gpa_min?: number;
       budget_min?: number;
       budget_max?: number;
       deadline?: string;
     };
     programs: string[];
     is_promoted: boolean;
     notes: string | null;
   }
   ```
</action>
<verify>
- File exists at src/lib/ari/knowledge-base.ts
- getDestinationsForCountry returns destinations array
- Promoted destinations appear first in results
- Query handles case-insensitive country matching
</verify>
</task>

<task id="2">
<title>Create destination formatting for AI prompts</title>
<action>
1. Add to `src/lib/ari/knowledge-base.ts`:

2. Implement `formatDestinationInfo(destination: Destination): string`:
   - Format as readable text for AI prompt:
   ```
   - {university_name}, {city}, {country}
     IELTS min: {ielts_min || 'tidak ditentukan'}
     Budget: Rp{budget_min}-{budget_max} juta/tahun
     Program: {programs.join(', ')}
     {notes ? `Info: ${notes}` : ''}
   ```

3. Implement `formatDestinationList(destinations: Destination[]): string`:
   - Format multiple destinations
   - Group by country if multiple countries
   - Mark promoted ones with star or highlight

4. Implement `detectUniversityQuestion(message: string): { isQuestion: boolean; country?: string }`:
   - Check for university-related keywords:
     - 'universitas', 'kampus', 'kuliah', 'university', 'college'
     - 'syarat', 'requirements', 'biaya', 'cost', 'budget'
     - 'program', 'jurusan', 'major'
   - Extract country if mentioned:
     - Map common variations: 'UK' -> 'United Kingdom', 'Aussie' -> 'Australia'
     - Return detected country or undefined

5. Implement `getRecommendationText(destinations: Destination[], userBudget?: number): string`:
   - Generate natural Indonesian recommendation text
   - Prioritize promoted destinations
   - Filter by budget if provided
   - Example: "Berdasarkan budget kamu, saya rekomendasikan..."
</action>
<verify>
- formatDestinationInfo returns readable string
- detectUniversityQuestion detects "berapa biaya kuliah di UK"
- Country mapping handles common variations (UK, US, AU)
</verify>
</task>

<task id="3">
<title>Integrate knowledge base and document tracking into processor</title>
<action>
1. Update `src/lib/ari/processor.ts`:

2. Import knowledge base and qualification functions:
   ```typescript
   import {
     getDestinationsForCountry,
     formatDestinationList,
     detectUniversityQuestion,
   } from './knowledge-base';
   import {
     parseDocumentResponse,
     updateDocumentStatus,
     DocumentStatus,
   } from './qualification';
   ```

3. In `processWithARI()`, add document response parsing:
   - After receiving user message, check if conversation is in 'qualifying' state
   - If state is 'qualifying' AND context has pending document question:
     - Call parseDocumentResponse(userMessage)
     - If result is not null, update context.documents via supabase:
       ```typescript
       const currentDocs = conversation.context?.documents || {
         passport: null,
         cv: null,
         english_test: null,
         transcript: null,
       };
       const pendingKey = conversation.context?.pendingDocumentQuestion;
       if (pendingKey && parsedResponse !== null) {
         const newDocs = updateDocumentStatus(currentDocs, pendingKey, parsedResponse);
         await supabase
           .from('ari_conversations')
           .update({
             context: {
               ...conversation.context,
               documents: newDocs,
               pendingDocumentQuestion: null, // Clear pending
             },
           })
           .eq('id', conversation.id);
       }
       ```

4. Add destination lookup before building prompt:
   - Call detectUniversityQuestion(userMessage)
   - If isQuestion is true, fetch relevant destinations:
     ```typescript
     let destinations: Destination[] = [];
     const detection = detectUniversityQuestion(userMessage);
     if (detection.isQuestion) {
       destinations = await getDestinationsForCountry(
         supabase,
         workspaceId,
         detection.country || contact.metadata?.form_answers?.country
       );
     }
     ```
   - Pass destinations to buildSystemPrompt via PromptContext

5. Update `src/lib/ari/context-builder.ts`:
   - Import knowledge base functions:
     ```typescript
     import { formatDestinationList } from './knowledge-base';
     ```
   - Update buildSystemPrompt() to include destinations section:
     - If destinations array provided and not empty, add:
       ```
       ## KNOWLEDGE BASE - UNIVERSITAS
       Berikut data universitas yang tersedia:
       {formatDestinationList(destinations)}

       Gunakan data ini untuk menjawab pertanyaan tentang universitas, syarat, dan biaya.
       Jika user tanya tentang universitas yang tidak ada di data, bilang "Saya cek dulu ya kak, nanti saya infoin."
       ```

6. Update `src/lib/ari/index.ts` to export knowledge base functions
</action>
<verify>
- processor.ts imports and calls parseDocumentResponse
- Document status updates saved to ari_conversations.context.documents via supabase update
- University questions trigger destination lookup
- formatDestinationList output included in system prompt when destinations available
</verify>
</task>

## Verification

- [ ] Destinations fetched for user's target country
- [ ] Promoted destinations appear first
- [ ] Requirements (IELTS, budget) included in formatted output
- [ ] University questions detected correctly
- [ ] Knowledge base section added to prompt when relevant
- [ ] Document responses parsed and saved to context.documents

## Success Criteria

- ARI answers university questions using ari_destinations data
- Promoted destinations prioritized in recommendations
- Requirements and budget info included in responses
- Natural Indonesian formatting for destination info
- Document status tracking persists across conversation

## Requirements Addressed

- **ARI-04**: Answer questions about universities/destinations using knowledge base
- **ARI-05**: Track document readiness (wired to save responses)
