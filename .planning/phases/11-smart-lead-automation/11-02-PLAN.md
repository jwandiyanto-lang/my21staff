---
phase: 11-smart-lead-automation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/database/lead-panel.tsx
  - src/app/(dashboard)/[workspace]/database/inline-edit-field.tsx
  - src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
  - convex/queries.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard shows lead activity timestamps for follow-up prioritization"
    - "User can see lead data organized in sections (Contact Vitals, Source Intelligence, Engagement, Profile)"
    - "User can edit any field with inline editing (click to edit, auto-save on blur)"
    - "Activity timeline shows daily summaries with expandable message details"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/database/lead-panel.tsx"
      provides: "Lead panel with structured sections"
      min_lines: 150
    - path: "src/app/(dashboard)/[workspace]/database/inline-edit-field.tsx"
      provides: "Reusable inline edit component with auto-save"
      exports: ["InlineEditField"]
  key_links:
    - from: "lead-panel.tsx"
      to: "convex/mutations.ts:updateContact"
      via: "useMutation for auto-save"
      pattern: "useMutation.*updateContact"
    - from: "contact-detail-sheet.tsx"
      to: "lead-panel.tsx"
      via: "Component import and render"
      pattern: "LeadPanel"
    - from: "lead-panel.tsx"
      to: "src/lib/utils/timezone.ts"
      via: "Import formatDistanceWIB, formatWIB, DATE_FORMATS (verified: these exports exist)"
      pattern: "from.*timezone"
---

<objective>
Build the dashboard right panel to display lead data in structured sections with inline editing capability, showing Contact Vitals, Source Intelligence, Engagement Signals, Lead Profile, and Activity Timeline.

Purpose: Enable users to view and edit lead data efficiently for follow-up prioritization.
Output: Lead panel component integrated into the database contact detail sheet.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-smart-lead-automation/11-CONTEXT.md
@.planning/phases/11-smart-lead-automation/11-RESEARCH.md
@business_21/03_bots/universal-data.md
@src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
@src/lib/utils/timezone.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineEditField component</name>
  <files>src/app/(dashboard)/[workspace]/database/inline-edit-field.tsx</files>
  <action>
Create a reusable InlineEditField component for click-to-edit fields with auto-save on blur.

Features:
- Click to enter edit mode
- Auto-save on blur (no explicit save button)
- Loading state during save
- Escape key to cancel
- Enter key to save
- Revert on error
- Optional placeholder text

```typescript
'use client'

import { useState, useEffect, useRef } from 'react'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Loader2, Pencil } from 'lucide-react'
import { cn } from '@/lib/utils'

interface InlineEditFieldProps {
  value: string | undefined | null
  onSave: (value: string) => Promise<void>
  label?: string
  placeholder?: string
  multiline?: boolean
  className?: string
  valueClassName?: string
}

export function InlineEditField({
  value,
  onSave,
  label,
  placeholder = 'Click to edit',
  multiline = false,
  className,
  valueClassName,
}: InlineEditFieldProps) {
  const [isEditing, setIsEditing] = useState(false)
  const [localValue, setLocalValue] = useState(value || '')
  const [isSaving, setIsSaving] = useState(false)
  const inputRef = useRef<HTMLInputElement | HTMLTextAreaElement>(null)

  // Sync local value when prop changes
  useEffect(() => {
    if (!isEditing) {
      setLocalValue(value || '')
    }
  }, [value, isEditing])

  // Focus input when entering edit mode
  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus()
      // Select all text
      if ('select' in inputRef.current) {
        inputRef.current.select()
      }
    }
  }, [isEditing])

  const handleSave = async () => {
    if (localValue === (value || '')) {
      setIsEditing(false)
      return
    }

    setIsSaving(true)
    try {
      await onSave(localValue)
      setIsEditing(false)
    } catch (error) {
      console.error('Save failed:', error)
      setLocalValue(value || '') // Revert on error
    } finally {
      setIsSaving(false)
    }
  }

  const handleCancel = () => {
    setLocalValue(value || '')
    setIsEditing(false)
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !multiline) {
      e.preventDefault()
      handleSave()
    }
    if (e.key === 'Escape') {
      handleCancel()
    }
  }

  const InputComponent = multiline ? Textarea : Input

  return (
    <div className={cn('group', className)}>
      {label && (
        <label className="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-1 block">
          {label}
        </label>
      )}
      {isEditing ? (
        <div className="relative">
          <InputComponent
            ref={inputRef as any}
            value={localValue}
            onChange={(e) => setLocalValue(e.target.value)}
            onBlur={handleSave}
            onKeyDown={handleKeyDown}
            disabled={isSaving}
            className={cn(
              'text-sm',
              multiline ? 'min-h-[80px] resize-none' : 'h-8',
              valueClassName
            )}
            placeholder={placeholder}
          />
          {isSaving && (
            <Loader2 className="absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 animate-spin text-muted-foreground" />
          )}
        </div>
      ) : (
        <div
          onClick={() => setIsEditing(true)}
          className={cn(
            'px-3 py-2 border border-transparent rounded cursor-pointer min-h-[32px] flex items-center justify-between gap-2',
            'hover:border-muted-foreground/20 hover:bg-muted/50 transition-colors',
            valueClassName
          )}
        >
          <span className={cn('text-sm', !value && 'text-muted-foreground')}>
            {value || placeholder}
          </span>
          <Pencil className="h-3 w-3 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0" />
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>
1. File exists at src/app/(dashboard)/[workspace]/database/inline-edit-field.tsx
2. Component exports InlineEditField
3. TypeScript compiles: `npm run typecheck`
  </verify>
  <done>
InlineEditField component created with auto-save on blur functionality
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LeadPanel component with structured sections</name>
  <files>src/app/(dashboard)/[workspace]/database/lead-panel.tsx</files>
  <action>
Create a LeadPanel component that displays lead data in organized sections.

**Runtime dependency:** This component uses `useMutation(api.mutations.updateContact)` from convex/mutations.ts. The updateContact mutation already exists and accepts contact_id, workspace_id, and field updates.

**Timezone utilities:** Uses `formatDistanceWIB`, `formatWIB`, `DATE_FORMATS` from `@/lib/utils/timezone` (verified to exist).

**Sections (from CONTEXT.md decisions):**
1. **Contact Vitals** - name, phone, email, location, timezone
2. **Source Intelligence** - traffic_source, campaign_id, landing_page_url, device_type
3. **Engagement Signals** - lead_status, response_latency, message_count, lastActivityAt
4. **Lead Profile** - summary, temperature_reason, lead_volume, current_stack, main_pain_point, urgency_timeline
5. **Niche Data** - Conditional based on businessType (my21staff SaaS fields: lead_volume, current_stack, bottleneck)

Note: Activity Timeline already exists in contact-detail-sheet.tsx, so we integrate with that existing component.

```typescript
'use client'

import { useMutation } from 'convex/react'
import { api } from '@/../convex/_generated/api'
import { Id } from '@/../convex/_generated/dataModel'
import { formatDistanceWIB, DATE_FORMATS, formatWIB } from '@/lib/utils/timezone'
import { Separator } from '@/components/ui/separator'
import { Badge } from '@/components/ui/badge'
import { InlineEditField } from './inline-edit-field'
import {
  User,
  Phone,
  Mail,
  MapPin,
  Clock,
  Globe,
  Smartphone,
  BarChart3,
  MessageCircle,
  Zap,
  Target,
  Building,
  AlertCircle,
  Calendar,
} from 'lucide-react'
import { cn } from '@/lib/utils'
import { toast } from 'sonner'

interface Contact {
  _id: Id<'contacts'>
  workspace_id: Id<'workspaces'>
  name?: string | null
  phone: string
  phone_normalized?: string | null
  email?: string | null
  lead_score: number
  lead_status: string
  leadStatus?: string | null
  leadTemperature?: string | null
  tags?: string[] | null
  source?: string | null
  metadata?: Record<string, unknown> | null
  lastActivityAt?: number | null
  lastContactAt?: number | null
  created_at: number
  updated_at: number
  // Sarah fields
  businessType?: string | null
  domisili?: string | null
  story?: string | null
  painPoints?: string[] | null
  urgencyLevel?: string | null
}

interface LeadPanelProps {
  contact: Contact
  workspaceId: string
}

export function LeadPanel({ contact, workspaceId }: LeadPanelProps) {
  const updateContact = useMutation(api.mutations.updateContact)

  const handleFieldSave = async (field: string, value: string) => {
    try {
      await updateContact({
        contact_id: contact._id,
        workspace_id: workspaceId,
        [field]: value || null,
      })
      toast.success('Saved')
    } catch (error) {
      toast.error('Failed to save')
      throw error // Re-throw to trigger revert in InlineEditField
    }
  }

  // Extract metadata fields
  const meta = contact.metadata || {}
  const trafficSource = meta.traffic_source as string | undefined
  const campaignId = meta.campaign_id as string | undefined
  const landingPageUrl = meta.landing_page_url as string | undefined
  const deviceType = meta.device_type as string | undefined
  const messageCount = meta.message_count as number | undefined
  const responseLatency = meta.response_latency as string | undefined
  const summary = meta.summary as string | undefined
  const temperatureReason = meta.temperature_reason as string | undefined
  const leadVolume = meta.lead_volume as string | undefined
  const currentStack = meta.current_stack as string | undefined
  const mainPainPoint = meta.main_pain_point as string | undefined
  const urgencyTimeline = meta.urgency_timeline as string | undefined

  // Determine if we should show SaaS niche section
  const showSaasSection = contact.businessType === 'SaaS' || contact.businessType === 'CRM' || currentStack

  return (
    <div className="space-y-6">
      {/* Contact Vitals */}
      <section>
        <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 flex items-center gap-2">
          <User className="h-3.5 w-3.5" />
          Contact Vitals
        </h3>
        <div className="space-y-2">
          <InlineEditField
            label="Name"
            value={contact.name}
            placeholder="No name"
            onSave={(value) => handleFieldSave('name', value)}
          />
          <div className="flex items-center gap-2 px-3 py-2">
            <Phone className="h-4 w-4 text-muted-foreground" />
            <span className="text-sm">{contact.phone}</span>
            {contact.phone_normalized && contact.phone_normalized !== contact.phone && (
              <span className="text-xs text-muted-foreground">({contact.phone_normalized})</span>
            )}
          </div>
          <InlineEditField
            label="Email"
            value={contact.email}
            placeholder="No email"
            onSave={(value) => handleFieldSave('email', value)}
          />
          <InlineEditField
            label="Location"
            value={contact.domisili}
            placeholder="No location"
            onSave={(value) => handleFieldSave('domisili', value)}
          />
        </div>
      </section>

      <Separator />

      {/* Source Intelligence */}
      <section>
        <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 flex items-center gap-2">
          <Globe className="h-3.5 w-3.5" />
          Source Intelligence
        </h3>
        <div className="space-y-2 text-sm">
          <div className="flex items-center justify-between px-3 py-1.5">
            <span className="text-muted-foreground">Source</span>
            <Badge variant="secondary" className="text-xs">
              {contact.source || 'Unknown'}
            </Badge>
          </div>
          {trafficSource && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground">Traffic</span>
              <span>{trafficSource}</span>
            </div>
          )}
          {campaignId && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground">Campaign</span>
              <span className="text-xs font-mono">{campaignId}</span>
            </div>
          )}
          {deviceType && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground">Device</span>
              <div className="flex items-center gap-1">
                <Smartphone className="h-3 w-3" />
                <span>{deviceType}</span>
              </div>
            </div>
          )}
          <div className="flex items-center justify-between px-3 py-1.5">
            <span className="text-muted-foreground">Added</span>
            <span>{formatWIB(contact.created_at, DATE_FORMATS.DATE_SHORT)}</span>
          </div>
        </div>
      </section>

      <Separator />

      {/* Engagement Signals */}
      <section>
        <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 flex items-center gap-2">
          <BarChart3 className="h-3.5 w-3.5" />
          Engagement Signals
        </h3>
        <div className="space-y-2 text-sm">
          <div className="flex items-center justify-between px-3 py-1.5">
            <span className="text-muted-foreground">Lead Status</span>
            <Badge
              variant="outline"
              className={cn(
                'text-xs',
                contact.leadTemperature === 'hot' && 'border-red-500 text-red-600',
                contact.leadTemperature === 'warm' && 'border-orange-500 text-orange-600',
                contact.leadTemperature === 'lukewarm' && 'border-yellow-500 text-yellow-600',
                contact.leadTemperature === 'cold' && 'border-blue-500 text-blue-600',
              )}
            >
              {contact.leadStatus || contact.lead_status || 'new'}
            </Badge>
          </div>
          {contact.leadTemperature && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground">Temperature</span>
              <Badge
                className={cn(
                  'text-xs',
                  contact.leadTemperature === 'hot' && 'bg-red-100 text-red-700',
                  contact.leadTemperature === 'warm' && 'bg-orange-100 text-orange-700',
                  contact.leadTemperature === 'lukewarm' && 'bg-yellow-100 text-yellow-700',
                  contact.leadTemperature === 'cold' && 'bg-blue-100 text-blue-700',
                )}
              >
                {contact.leadTemperature.toUpperCase()}
              </Badge>
            </div>
          )}
          <div className="flex items-center justify-between px-3 py-1.5">
            <span className="text-muted-foreground">Lead Score</span>
            <span className="font-semibold">{contact.lead_score}/100</span>
          </div>
          {messageCount !== undefined && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground flex items-center gap-1">
                <MessageCircle className="h-3 w-3" />
                Messages
              </span>
              <span>{messageCount}</span>
            </div>
          )}
          {contact.lastActivityAt && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground flex items-center gap-1">
                <Zap className="h-3 w-3" />
                Last Activity
              </span>
              <span title={formatWIB(contact.lastActivityAt, DATE_FORMATS.DATETIME_LONG)}>
                {formatDistanceWIB(contact.lastActivityAt, { addSuffix: true })}
              </span>
            </div>
          )}
          {contact.lastContactAt && (
            <div className="flex items-center justify-between px-3 py-1.5">
              <span className="text-muted-foreground flex items-center gap-1">
                <Calendar className="h-3 w-3" />
                Last Contact
              </span>
              <span title={formatWIB(contact.lastContactAt, DATE_FORMATS.DATETIME_LONG)}>
                {formatDistanceWIB(contact.lastContactAt, { addSuffix: true })}
              </span>
            </div>
          )}
        </div>
      </section>

      <Separator />

      {/* Lead Profile */}
      <section>
        <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 flex items-center gap-2">
          <Target className="h-3.5 w-3.5" />
          Lead Profile
        </h3>
        <div className="space-y-3">
          {contact.story && (
            <div className="px-3">
              <span className="text-xs text-muted-foreground">Story</span>
              <p className="text-sm mt-1">{contact.story}</p>
            </div>
          )}
          {summary && (
            <div className="px-3">
              <span className="text-xs text-muted-foreground">Summary</span>
              <p className="text-sm mt-1">{summary}</p>
            </div>
          )}
          {contact.painPoints && contact.painPoints.length > 0 && (
            <div className="px-3">
              <span className="text-xs text-muted-foreground">Pain Points</span>
              <div className="flex flex-wrap gap-1 mt-1">
                {contact.painPoints.map((pain, i) => (
                  <Badge key={i} variant="outline" className="text-xs">
                    {pain}
                  </Badge>
                ))}
              </div>
            </div>
          )}
          {contact.urgencyLevel && (
            <div className="flex items-center justify-between px-3 py-1.5 text-sm">
              <span className="text-muted-foreground">Urgency</span>
              <Badge variant="secondary" className="text-xs">{contact.urgencyLevel}</Badge>
            </div>
          )}
          {mainPainPoint && (
            <div className="px-3">
              <span className="text-xs text-muted-foreground">Main Pain Point</span>
              <p className="text-sm mt-1 flex items-center gap-1">
                <AlertCircle className="h-3 w-3 text-orange-500" />
                {mainPainPoint}
              </p>
            </div>
          )}
          {urgencyTimeline && (
            <div className="flex items-center justify-between px-3 py-1.5 text-sm">
              <span className="text-muted-foreground">Timeline</span>
              <span>{urgencyTimeline}</span>
            </div>
          )}
        </div>
      </section>

      {/* Niche Data - SaaS/CRM */}
      {showSaasSection && (
        <>
          <Separator />
          <section>
            <h3 className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3 flex items-center gap-2">
              <Building className="h-3.5 w-3.5" />
              Business Info
            </h3>
            <div className="space-y-2 text-sm">
              {contact.businessType && (
                <div className="flex items-center justify-between px-3 py-1.5">
                  <span className="text-muted-foreground">Business Type</span>
                  <Badge variant="secondary">{contact.businessType}</Badge>
                </div>
              )}
              {leadVolume && (
                <div className="flex items-center justify-between px-3 py-1.5">
                  <span className="text-muted-foreground">Lead Volume</span>
                  <span>{leadVolume}</span>
                </div>
              )}
              {currentStack && (
                <div className="flex items-center justify-between px-3 py-1.5">
                  <span className="text-muted-foreground">Current Stack</span>
                  <span>{currentStack}</span>
                </div>
              )}
            </div>
          </section>
        </>
      )}
    </div>
  )
}
```
  </action>
  <verify>
1. File exists at src/app/(dashboard)/[workspace]/database/lead-panel.tsx
2. Component exports LeadPanel
3. All sections present: Contact Vitals, Source Intelligence, Engagement Signals, Lead Profile
4. TypeScript compiles: `npm run typecheck`
5. Imports from @/lib/utils/timezone work (formatDistanceWIB, formatWIB, DATE_FORMATS)
  </verify>
  <done>
LeadPanel component created with structured sections and inline editing support
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate LeadPanel into contact-detail-sheet</name>
  <files>src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx</files>
  <action>
Update contact-detail-sheet.tsx to use the new LeadPanel component in the Details tab.

Changes:
1. Import LeadPanel component
2. Replace the manual Contact Information section with LeadPanel in the Details tab
3. Keep the existing Lead Score tabs and Activity tab as-is (they're already well-implemented)

At the top of the file, add the import:
```typescript
import { LeadPanel } from './lead-panel'
```

In the Details tab content (TabsContent value="details"), replace the "Contact Information" section with:
```tsx
<LeadPanel
  contact={{
    _id: contact.id as any,
    workspace_id: workspace.slug as any,
    name: contact.name,
    phone: contact.phone,
    phone_normalized: contact.phone_normalized,
    email: contact.email,
    lead_score: contact.lead_score,
    lead_status: contact.lead_status,
    leadStatus: contact.leadStatus,
    leadTemperature: contact.leadTemperature,
    tags: contact.tags,
    source: contact.source,
    metadata: contact.metadata,
    lastActivityAt: contact.lastActivityAt,
    lastContactAt: contact.lastContactAt,
    created_at: contact.created_at,
    updated_at: contact.updated_at,
    businessType: contact.businessType,
    domisili: contact.domisili,
    story: contact.story,
    painPoints: contact.painPoints,
    urgencyLevel: contact.urgencyLevel,
  }}
  workspaceId={workspace.slug}
/>
```

The contact type in this file uses Supabase-style types with `id` field. We need to map to Convex-style `_id`. The LeadPanel handles this with `as any` type assertions.

Find the "Contact Information" section (around line 899-1013) and replace it with the LeadPanel component. Keep the Separator and Lead Score section that follows.

NOTE: The existing activity timeline, lead score tabs, and other functionality should remain unchanged. Only the Contact Information section is replaced with LeadPanel for the structured view.
  </action>
  <verify>
1. LeadPanel is imported at top of file
2. LeadPanel component is rendered in Details tab
3. Existing Lead Score and Activity tabs still work
4. TypeScript compiles: `npm run typecheck`
5. Page loads without errors: `npm run dev` and visit database page
  </verify>
  <done>
LeadPanel integrated into contact-detail-sheet.tsx, showing structured lead data
  </done>
</task>

</tasks>

<verification>
Run these commands to verify the UI changes:

```bash
# 1. Type check passes
npm run typecheck

# 2. Lint passes
npm run lint

# 3. Verify timezone utilities exist (should show exports)
grep -n "export.*formatDistanceWIB\|export.*formatWIB\|export.*DATE_FORMATS" src/lib/utils/timezone.ts

# 4. Start dev server and test visually
npm run dev
# Visit http://localhost:3000/demo/database
# Click on a contact to open the detail sheet
# Verify:
#   - Contact Vitals section shows name, phone, email, location
#   - Source Intelligence section shows source, traffic, device info
#   - Engagement Signals section shows lead status, score, last activity
#   - Lead Profile section shows story, pain points, urgency
#   - Inline editing works (click a field, edit, blur to save)
#   - Activity tab still works as before
```
</verification>

<success_criteria>
1. InlineEditField component created with auto-save on blur
2. LeadPanel component created with 5 structured sections
3. LeadPanel integrated into contact-detail-sheet.tsx
4. Dashboard shows lastActivityAt in Engagement Signals section
5. Inline editing works - click to edit, blur to save
6. All TypeScript compiles without errors
7. UI loads without errors in dev mode
</success_criteria>

<output>
After completion, create `.planning/phases/11-smart-lead-automation/11-02-SUMMARY.md`
</output>
