---
phase: 11-smart-lead-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/mutations.ts
autonomous: true

must_haves:
  truths:
    - "New WhatsApp contact automatically creates lead in database"
    - "Existing contact messages update lastActivityAt (no duplicate leads)"
    - "Phone normalization prevents duplicates (+62813 = 0813)"
    - "Webhook retries don't create duplicate leads (idempotency working)"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Index for phone_normalized lookup"
      contains: "by_workspace_phone_normalized"
    - path: "convex/mutations.ts"
      provides: "Fixed findOrCreateContactWebhook mutation"
      contains: "by_workspace_phone_normalized"
  key_links:
    - from: "src/app/api/webhook/kapso/route.ts"
      to: "convex/mutations.ts:findOrCreateContactWebhook"
      via: "convex.mutation call with phone_normalized"
      pattern: "findOrCreateContactWebhook"
---

<objective>
Fix the phone number deduplication bug and add activity timestamp tracking so that:
1. First message from new phone creates a lead
2. Subsequent messages from same phone update existing lead (no duplicates)
3. lastActivityAt is updated on every inbound message for follow-up prioritization

Purpose: This is the core lead automation requirement - automatic lead creation without duplicates.
Output: Fixed Convex mutations that correctly deduplicate by normalized phone number.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-smart-lead-automation/11-CONTEXT.md
@.planning/phases/11-smart-lead-automation/11-RESEARCH.md
@convex/schema.ts
@convex/mutations.ts
@src/lib/phone/normalize.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phone_normalized index to contacts table</name>
  <files>convex/schema.ts</files>
  <action>
Add a new index to the contacts table definition for querying by workspace_id and phone_normalized.

In the contacts table (around line 106-110), add this index after the existing "by_workspace_phone" index:

```typescript
.index("by_workspace_phone_normalized", ["workspace_id", "phone_normalized"])
```

This enables efficient lookup by normalized phone number, which is critical for deduplication.

The existing "by_workspace_phone" index queries by raw phone, which causes duplicates when the same number arrives in different formats (0813, 62813, +62813).
  </action>
  <verify>
Run `npx convex dev --once` to validate schema. Should show index being created.
Check that the index appears in the schema definition.
  </verify>
  <done>
contacts table has "by_workspace_phone_normalized" index defined in schema.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix findOrCreateContactWebhook to use normalized phone lookup</name>
  <files>convex/mutations.ts</files>
  <action>
Update the findOrCreateContactWebhook mutation (around line 1770-1824) to:

1. Query by phone_normalized field instead of phone field
2. Update lastActivityAt on every inbound message (both new and existing contacts)
3. Only update kapso_name if contact.name is empty (preserve manual CRM edits)

**Current code (WRONG - queries by raw phone):**
```typescript
const existing = await ctx.db
  .query("contacts")
  .withIndex("by_workspace_phone", (q) =>
    q.eq("workspace_id", args.workspace_id as any).eq("phone", args.phone)
  )
  .first();
```

**Fixed code (queries by normalized phone):**
```typescript
const existing = await ctx.db
  .query("contacts")
  .withIndex("by_workspace_phone_normalized", (q) =>
    q.eq("workspace_id", args.workspace_id as any).eq("phone_normalized", args.phone_normalized)
  )
  .first();
```

Also update the existing contact patch logic:
- Always update lastActivityAt to Date.now()
- Only update name field if existing.name is empty/null (preserve manual edits)
- Always update cache_updated_at and updated_at

For new contacts:
- Set lastActivityAt to now (same as created_at)

Full replacement for the mutation handler:

```typescript
handler: async (ctx, args) => {
  // Query by normalized phone to prevent duplicates
  const existing = await ctx.db
    .query("contacts")
    .withIndex("by_workspace_phone_normalized", (q) =>
      q.eq("workspace_id", args.workspace_id as any).eq("phone_normalized", args.phone_normalized)
    )
    .first();

  const now = Date.now();

  if (existing) {
    // Always update activity timestamp + cache
    // Only update kapso_name if we have new data
    // Only update name if not manually set (preserve CRM edits)
    await ctx.db.patch(existing._id, {
      lastActivityAt: now,
      cache_updated_at: now,
      updated_at: now,
      ...(args.kapso_name && args.kapso_name !== existing.kapso_name
        ? {
            kapso_name: args.kapso_name,
            // Only overwrite name if empty (preserve manual edits)
            ...(existing.name ? {} : { name: args.kapso_name }),
          }
        : {}),
    });
    return await ctx.db.get(existing._id);
  }

  // Create new contact
  const contactId = await ctx.db.insert("contacts", {
    workspace_id: args.workspace_id as any,
    phone: args.phone,
    phone_normalized: args.phone_normalized,
    name: args.kapso_name,
    kapso_name: args.kapso_name,
    lead_score: 0,
    lead_status: "new",
    tags: [],
    source: "whatsapp",
    metadata: {},
    cache_updated_at: now,
    lastActivityAt: now,
    created_at: now,
    updated_at: now,
    supabaseId: "",
  });

  return await ctx.db.get(contactId);
},
```
  </action>
  <verify>
1. Run `npx convex dev --once` to deploy mutation
2. Check TypeScript compiles without errors: `npm run typecheck`
3. Verify the mutation uses "by_workspace_phone_normalized" index
4. Verify lastActivityAt is set on both existing and new contacts
  </verify>
  <done>
findOrCreateContactWebhook queries by phone_normalized and updates lastActivityAt on every message
  </done>
</task>

<task type="auto">
  <name>Task 3: Test deduplication with different phone formats</name>
  <files>N/A - testing</files>
  <action>
Create a simple test to verify the fix works. In the terminal:

1. Check current contacts in the database:
```bash
npx convex run --help  # Just to verify convex CLI works
```

2. The real test will happen when a WhatsApp message arrives via webhook. The fix ensures:
   - Phone "0812" and "+62812" resolve to same contact (no duplicate)
   - lastActivityAt updates on every message

Since we can't trigger a real webhook in this test, verify the code changes are correct by:
- Confirming the index exists in schema.ts
- Confirming the mutation queries by phone_normalized
- Confirming lastActivityAt is set in both branches (existing + new)

3. Local verification - read the updated files and confirm the patterns:
   - schema.ts has "by_workspace_phone_normalized" index
   - mutations.ts findOrCreateContactWebhook uses that index
   - mutations.ts sets lastActivityAt in both code paths
  </action>
  <verify>
Code review confirms:
- [ ] Index "by_workspace_phone_normalized" in schema.ts
- [ ] findOrCreateContactWebhook uses that index for lookup
- [ ] lastActivityAt set for existing contacts (in patch)
- [ ] lastActivityAt set for new contacts (in insert)
  </verify>
  <done>
Code changes verified - deduplication fix is in place, activity tracking enabled
  </done>
</task>

</tasks>

<verification>
Run these commands to verify the backend changes:

```bash
# 1. Type check passes
npm run typecheck

# 2. Convex schema deploys successfully
npx convex dev --once

# 3. Verify the index exists (search schema.ts)
grep -n "by_workspace_phone_normalized" convex/schema.ts

# 4. Verify mutation uses the index
grep -n "by_workspace_phone_normalized" convex/mutations.ts

# 5. Verify lastActivityAt is set
grep -n "lastActivityAt" convex/mutations.ts | head -20
```
</verification>

<success_criteria>
1. Schema has by_workspace_phone_normalized index
2. findOrCreateContactWebhook queries by phone_normalized (not raw phone)
3. lastActivityAt updated on every inbound message (existing contacts)
4. lastActivityAt set on contact creation (new contacts)
5. All TypeScript compiles without errors
6. Convex schema deploys successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-smart-lead-automation/11-01-SUMMARY.md`
</output>
