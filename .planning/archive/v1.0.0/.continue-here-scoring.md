---
feature: flow-based-scoring
status: in_progress
last_updated: 2026-01-28T13:10:00Z
type: ad_hoc_feature
---

# Flow-Based Scoring System - Work Handoff

## Current State

Mid-development of a flow-based lead scoring system that replaces the old category-weight scoring with conversation outcome-based scoring. The UI is complete and shows dummy data correctly, but the backend logic to actually detect and award outcome points is not yet implemented.

**Location:** Various files across the codebase (see Files Modified below)

## Completed Work

### 1. Database Schema ✅
- Added `ariFlowStageOutcomes` table to Convex schema
- Links outcomes to flow stages with description, points, keywords
- Proper indexing by stage and order

### 2. Backend API ✅
- `getFlowStages` query now includes outcomes per stage
- `syncFlowStageOutcomes` mutation for create/update/delete
- `getFlowStageOutcomes` query for fetching outcomes by stage
- DELETE cascade: deleting a stage deletes its outcomes
- Dev mode returns dummy outcomes for default stages

### 3. Flow Tab UI ✅
- Removed "Scoring Configuration" header (redundant)
- Removed all temperature threshold controls (hot/warm/cold)
- Added "Scoring Outcomes" section in stage edit mode
- Proper spacing with border separator (pt-6 border-t mt-4)
- Collapsed view shows: Goal, Exit criteria, and total score
- Add/edit/delete outcomes in each stage
- Dummy data for Greeting, Qualifying, and Scoring stages

### 4. Removed Scoring Tab ✅
- Deleted scoring-tab import from knowledge-base-client
- Removed Scoring tab from Your Intern interface
- Updated tabs grid from 5 to 4 columns
- All scoring now happens in Flow tab

### 5. Chat Score Display ✅
- Updated contact detail sheet to show flow outcomes
- Displays achieved outcomes with stage badges
- Format: "[Outcome] [Stage badge] +XX pts"
- Example data shows 47 pts total from 4 outcomes

### 6. Total Score Calculation ✅
- Changed from "Average" to "Total Lead Score"
- Formula: Form Score + Chat Score
- Slider range updated to 0-200
- All mock contacts set to lead_score: 0 for auto-calculation
- displayScore = formScore + chatScore (47)

## Remaining Work

### 1. Backend Outcome Detection (NOT STARTED)
**Critical:** The system currently shows dummy 47 pts for all contacts. Need to:
- Create conversation analysis logic in ARI
- Detect achieved outcomes using keywords or AI
- Store achieved outcomes per contact
- Calculate actual chat score from achieved outcomes

**Files to create/modify:**
- New: `convex/ari/scoring.ts` or similar
- Modify: `convex/ari.ts` to call outcome detection
- Add outcome storage to contact metadata or new table

### 2. Real Chat Score Integration (NOT STARTED)
**Current:** Hardcoded `const chatScore = 47` in contact-detail-sheet.tsx
**Needed:**
- Fetch actual achieved outcomes from database
- Calculate real chat score from outcomes
- Display real outcomes (not dummy data)
- Handle contacts with no outcomes yet

### 3. Flow Outcome Keywords/AI Detection (NOT STARTED)
**Current:** Keywords field exists but unused
**Options:**
- Simple keyword matching in message content
- AI-based detection (ask Claude to identify outcomes)
- Hybrid approach (keywords first, AI fallback)

### 4. Outcome Achievement Tracking (NOT STARTED)
**Need to decide:**
- New table `ariContactOutcomes` or store in contact metadata?
- Track timestamp when outcome achieved?
- Allow same outcome multiple times or once per contact?

## Decisions Made

1. **Removed temperature thresholds entirely** - Simplified to pure point-based scoring
2. **Flow-based outcomes over category weights** - More intuitive and actionable
3. **Total score = Form + Chat** - Not average, simple addition
4. **Dummy data shows 47 pts** - Good example data for testing UI
5. **Scoring integrated into Flow tab** - Removed standalone Scoring tab
6. **Keywords field added** - For future detection logic (e.g., "australia, sydney")

## Files Modified

```
convex/schema.ts - Added ariFlowStageOutcomes table
convex/ari.ts - Added getFlowStageOutcomes, syncFlowStageOutcomes, updated getFlowStages
src/app/api/workspaces/[id]/flow-stages/route.ts - Added dummy outcomes to default stages
src/components/knowledge-base/flow-tab.tsx - Added outcomes UI, updated spacing
src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx - Removed Scoring tab
src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx - Updated chat score display and total calculation
src/lib/mock-data.ts - Set all lead_score to 0 for auto-calculation
```

## Blockers

None currently. Work is ready to continue.

## Mental Context

**The Vision:**
Replace abstract "category weights" with concrete conversation achievements. When ARI detects "Located in Australia" in chat, award 15 pts. When budget is "300-500 juta", award 12 pts. Much more transparent and actionable than opaque weight percentages.

**The Flow:**
1. Admin configures outcomes in Flow tab (e.g., "IELTS 6.5+" = 10 pts)
2. ARI has conversation with lead
3. Backend detects achieved outcomes (keyword match or AI)
4. Outcomes stored with contact
5. Chat score auto-calculated from achieved outcomes
6. Total score = Form + Chat displayed in Database

**UI is Done, Logic is Not:**
All the UI work is complete and shows dummy data correctly. The missing piece is the actual detection and storage of achieved outcomes. That's pure backend work.

## Next Action

**When resuming, start with:**

1. **Design outcome detection approach** - Decide between:
   - Simple keyword matching (fast, limited)
   - AI-based detection (accurate, slower)
   - Hybrid (keywords first, AI for ambiguous cases)

2. **Create data model** - Decide storage:
   - New `ariContactOutcomes` table with columns: contact_id, outcome_id, achieved_at
   - OR store in contact metadata as `achieved_outcomes: [outcome_id, outcome_id]`

3. **Implement detection logic** - In `convex/ari.ts`:
   - Function to analyze messages against flow outcomes
   - Award points when outcome achieved
   - Store achievement

4. **Wire up real data** - Replace hardcoded `chatScore = 47` with:
   - Fetch achieved outcomes from DB
   - Calculate actual chat score
   - Display real outcome badges

**Test with:** Create a new contact, have ARI conversation, verify outcomes detected and scored correctly.

---

*Last updated: 2026-01-28 - Flow-based scoring UI complete, backend detection pending*
