---
phase: 02-email-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/email/resend.ts
  - src/lib/email/send.ts
  - src/emails/components/base-layout.tsx
  - src/emails/invitation.tsx
  - src/app/api/invitations/route.ts
  - public/logo.png
  - package.json
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery via HTTP API"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config: []

must_haves:
  truths:
    - "Invitation email sends successfully when admin invites team member"
    - "Email contains branded layout with my21staff logo"
    - "Email CTA button links to password setup page"
    - "nodemailer dependency removed from project"
  artifacts:
    - path: "src/lib/email/resend.ts"
      provides: "Resend client singleton"
      exports: ["resend", "FROM_EMAIL"]
    - path: "src/lib/email/send.ts"
      provides: "Typed email sending functions"
      exports: ["sendInvitationEmail"]
    - path: "src/emails/components/base-layout.tsx"
      provides: "Shared email layout with logo and footer"
      exports: ["BaseLayout"]
    - path: "src/emails/invitation.tsx"
      provides: "Team invitation email template"
      exports: ["InvitationEmail"]
    - path: "public/logo.png"
      provides: "Logo image for email embedding"
  key_links:
    - from: "src/app/api/invitations/route.ts"
      to: "src/lib/email/send.ts"
      via: "sendInvitationEmail import"
      pattern: "import.*sendInvitationEmail.*from.*@/lib/email/send"
    - from: "src/lib/email/send.ts"
      to: "src/emails/invitation.tsx"
      via: "InvitationEmail component"
      pattern: "InvitationEmail\\("
    - from: "src/emails/invitation.tsx"
      to: "src/emails/components/base-layout.tsx"
      via: "BaseLayout wrapper"
      pattern: "<BaseLayout"
---

<objective>
Replace broken nodemailer/SMTP email sending with Resend HTTP API and React Email templates.

Purpose: Fix P0 email delivery issue that blocks team member invitations from working in production (Vercel serverless has DNS resolution issues with SMTP).

Output: Working invitation emails that send via Resend with branded React Email templates matching my21staff visual identity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-system/02-CONTEXT.md
@.planning/phases/02-email-system/02-RESEARCH.md
@src/lib/email/transporter.ts
@src/app/api/invitations/route.ts
@business/brand/logos/wordmark-full-128.png
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup Resend client and React Email infrastructure</name>
  <files>
    src/lib/email/resend.ts
    src/lib/email/send.ts
    src/emails/components/base-layout.tsx
    public/logo.png
    package.json
  </files>
  <action>
    1. Install @react-email/components (NOT react-email dev server - not needed for production):
       ```bash
       npm install @react-email/components
       npm uninstall nodemailer @types/nodemailer
       ```

    2. Copy logo for email embedding:
       ```bash
       cp business/brand/logos/wordmark-full-128.png public/logo.png
       ```

    3. Create src/lib/email/resend.ts:
       - Import Resend from 'resend'
       - Check for RESEND_API_KEY env var (throw if missing)
       - Export resend client singleton
       - Export FROM_EMAIL constant: "Kia dari my21staff <kia@my21staff.com>"

    4. Create src/emails/components/base-layout.tsx:
       - Import Html, Head, Body, Container, Section, Img, Text, Link, Hr, Tailwind from @react-email/components
       - Create Tailwind config with brand colors:
         - brand-forest: '#2D4B3E'
         - brand-text: '#2D2A26'
         - brand-muted: '#8C7E74'
         - brand-orange: '#F7931A'
       - BaseLayoutProps: { preview: string, children: React.ReactNode }
       - Layout structure:
         - Html with lang="id"
         - Tailwind wrapper with config
         - Body with bg-white, font-sans
         - Container max-w-[600px] centered
         - Logo section: Img src="https://my21staff.vercel.app/logo.png" alt="my21staff" width={120}
         - Children slot
         - Footer: Hr + copyright + WhatsApp link (wa.me/6281234567890)

    5. Create src/lib/email/send.ts:
       - Import resend, FROM_EMAIL from ./resend
       - Import InvitationEmail from @/emails/invitation (will create in Task 2)
       - Export sendInvitationEmail function with params: { to, inviteLink, workspaceName, inviterName }
       - Use resend.emails.send with:
         - from: FROM_EMAIL
         - to: to
         - subject: `Anda diundang ke ${workspaceName}`
         - react: InvitationEmail({ inviteLink, workspaceName, inviterName })
       - Handle error with console.error and throw

    Note: The send.ts will have a TypeScript error until Task 2 creates the InvitationEmail component.
  </action>
  <verify>
    - `npm ls @react-email/components` shows installed
    - `npm ls nodemailer` shows "empty" (uninstalled)
    - `ls public/logo.png` exists
    - `cat src/lib/email/resend.ts` shows Resend client
    - `cat src/emails/components/base-layout.tsx` shows BaseLayout component
  </verify>
  <done>
    Resend client configured, base email layout created, logo copied to public folder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invitation email template and wire to API</name>
  <files>
    src/emails/invitation.tsx
    src/app/api/invitations/route.ts
    src/lib/email/transporter.ts
  </files>
  <action>
    1. Create src/emails/invitation.tsx:
       - Import Button, Heading, Text, Section, Preview from @react-email/components
       - Import BaseLayout from ./components/base-layout
       - InvitationEmailProps: { inviteLink: string, workspaceName: string, inviterName: string }
       - Template structure:
         - BaseLayout with preview: `${inviterName} mengundang Anda ke ${workspaceName}`
         - Heading: "Undangan Bergabung" (text-xl font-semibold text-brand-text mb-4)
         - Text paragraph: "{inviterName} mengundang Anda untuk bergabung ke {workspaceName} di my21staff."
         - Button CTA: "Terima Undangan"
           - href: inviteLink
           - className: bg-brand-forest text-white px-6 py-3 rounded-lg font-semibold
           - NOTE: Use bg-brand-forest (green) NOT orange per BRAND.md (orange fails contrast for small text)
         - Text footer: "Link ini berlaku selama 7 hari. Jika Anda tidak mengenal pengirim, abaikan email ini."
       - Export default InvitationEmail (for potential email preview)

    2. Update src/app/api/invitations/route.ts:
       - Change import from:
         `import { sendInvitationEmail } from '@/lib/email/transporter'`
         to:
         `import { sendInvitationEmail } from '@/lib/email/send'`
       - No other changes needed - the function signature is identical

    3. Delete src/lib/email/transporter.ts (no longer needed)
  </action>
  <verify>
    - `cat src/emails/invitation.tsx` shows InvitationEmail component
    - `grep "from '@/lib/email/send'" src/app/api/invitations/route.ts` shows updated import
    - `ls src/lib/email/transporter.ts` returns "No such file"
    - `npm run build` succeeds with no TypeScript errors
  </verify>
  <done>
    Invitation email template created, API wired to Resend, old nodemailer transporter deleted.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` succeeds
2. `npm ls @react-email/components` shows package installed
3. `npm ls nodemailer` shows not installed
4. Files exist:
   - src/lib/email/resend.ts
   - src/lib/email/send.ts
   - src/emails/components/base-layout.tsx
   - src/emails/invitation.tsx
   - public/logo.png
5. src/lib/email/transporter.ts deleted
</verification>

<success_criteria>
- Resend client configured with API key check
- React Email base layout with my21staff branding
- Invitation email template in Bahasa Indonesia
- Invitation API updated to use new email system
- nodemailer completely removed from project
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-system/02-01-SUMMARY.md`
</output>
