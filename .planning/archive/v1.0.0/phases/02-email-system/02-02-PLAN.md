---
phase: 02-email-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/emails/password-reset.tsx
  - src/lib/email/send.ts
autonomous: false
user_setup:
  - service: resend
    why: "Domain verification for email deliverability"
    env_vars: []
    dashboard_config:
      - task: "Add domain my21staff.com"
        location: "Resend Dashboard -> Domains -> Add Domain"
      - task: "Add DNS records to domain registrar"
        location: "Your domain registrar (Hostinger, Cloudflare, etc.)"
        records:
          - type: "TXT"
            host: "resend._domainkey"
            value: "(provided by Resend)"
          - type: "TXT"
            host: "@"
            value: "v=spf1 include:amazonses.com ~all"
          - type: "TXT"
            host: "_dmarc"
            value: "v=DMARC1; p=none;"

must_haves:
  truths:
    - "Password reset email template exists with branded layout"
    - "DNS records configured for email deliverability"
    - "Full invitation flow works end-to-end in production"
  artifacts:
    - path: "src/emails/password-reset.tsx"
      provides: "Password reset email template"
      exports: ["PasswordResetEmail"]
    - path: "src/lib/email/send.ts"
      provides: "Password reset send function added"
      exports: ["sendInvitationEmail", "sendPasswordResetEmail"]
  key_links:
    - from: "src/lib/email/send.ts"
      to: "src/emails/password-reset.tsx"
      via: "PasswordResetEmail component"
      pattern: "PasswordResetEmail\\("
---

<objective>
Complete email system with password reset template and DNS verification for production email deliverability.

Purpose: Ensure emails actually reach recipients' inboxes (not spam) and provide password reset capability using the same branded template system.

Output: Password reset email template ready for future use, DNS records configured, and verified end-to-end invitation flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-system/02-CONTEXT.md
@.planning/phases/02-email-system/02-RESEARCH.md
@.planning/phases/02-email-system/02-01-SUMMARY.md
@src/emails/components/base-layout.tsx
@src/emails/invitation.tsx
@src/lib/email/send.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create password reset email template</name>
  <files>
    src/emails/password-reset.tsx
    src/lib/email/send.ts
  </files>
  <action>
    1. Create src/emails/password-reset.tsx:
       - Import Button, Heading, Text, Section from @react-email/components
       - Import BaseLayout from ./components/base-layout
       - PasswordResetEmailProps: { resetLink: string, userEmail: string }
       - Template structure (Bahasa Indonesia):
         - BaseLayout with preview: "Reset password untuk akun my21staff Anda"
         - Heading: "Reset Password" (text-xl font-semibold text-brand-text mb-4)
         - Text: "Kami menerima permintaan reset password untuk akun {userEmail}."
         - Text: "Klik tombol di bawah untuk membuat password baru:"
         - Button CTA: "Reset Password"
           - href: resetLink
           - className: bg-brand-forest text-white px-6 py-3 rounded-lg font-semibold
         - Text footer: "Link ini berlaku selama 1 jam. Jika Anda tidak meminta reset password, abaikan email ini."
       - Export default PasswordResetEmail

    2. Update src/lib/email/send.ts:
       - Add import for PasswordResetEmail from @/emails/password-reset
       - Add sendPasswordResetEmail function:
         ```typescript
         export async function sendPasswordResetEmail({
           to,
           resetLink,
         }: {
           to: string
           resetLink: string
         }) {
           const { data, error } = await resend.emails.send({
             from: FROM_EMAIL,
             to,
             subject: 'Reset Password - my21staff',
             react: PasswordResetEmail({ resetLink, userEmail: to }),
           })

           if (error) {
             console.error('Failed to send password reset email:', error)
             throw new Error(`Email failed: ${error.message}`)
           }

           return data
         }
         ```

    Note: This template is for future use. The current password reset flow uses Supabase's built-in email, but having a branded template ready allows us to switch to custom emails later.
  </action>
  <verify>
    - `cat src/emails/password-reset.tsx` shows PasswordResetEmail component
    - `grep "sendPasswordResetEmail" src/lib/email/send.ts` shows function exists
    - `npm run build` succeeds
  </verify>
  <done>
    Password reset email template created and send function added.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Email system with Resend HTTP API:
    - Resend client configured
    - Branded React Email templates (invitation + password reset)
    - Invitation API wired to new email system
  </what-built>
  <how-to-verify>
    **Step 1: Set up Resend API key**
    1. Go to https://resend.com and sign up/login
    2. Go to API Keys -> Create API Key
    3. Add to Vercel: `vercel env add RESEND_API_KEY` (paste the key)
    4. Also add to local .env.local for testing

    **Step 2: Configure domain DNS (for production deliverability)**
    1. In Resend Dashboard, go to Domains -> Add Domain
    2. Enter: my21staff.com
    3. Copy the DNS records Resend provides
    4. Add these records to your domain registrar:
       - TXT record for DKIM (resend._domainkey)
       - TXT record for SPF
       - TXT record for DMARC (_dmarc)
    5. Wait for DNS propagation (usually 5-30 minutes)
    6. Click "Verify" in Resend Dashboard

    **Step 3: Test the invitation flow**
    1. Deploy to Vercel: `vercel --prod`
    2. Go to https://my21staff.vercel.app
    3. Login as workspace admin
    4. Go to Settings -> Team tab
    5. Enter a test email and click "Invite"
    6. Check if invitation email arrives (check spam folder too)
    7. Verify email has:
       - my21staff logo at top
       - Correct workspace name
       - Green "Terima Undangan" button
       - Indonesian text
    8. Click the button and verify it goes to password setup page

    **What to look for:**
    - Email should arrive within 1 minute
    - Email should NOT go to spam (if DNS is configured)
    - Email layout should match my21staff branding
    - CTA button should work and redirect to /set-password
  </how-to-verify>
  <resume-signal>
    Type "email works" if invitation email arrives and looks correct.
    Type "dns pending" if email works but went to spam (DNS needs time).
    Describe any issues if something doesn't work.
  </resume-signal>
</task>

</tasks>

<verification>
After task completion:
1. Password reset template exists at src/emails/password-reset.tsx
2. sendPasswordResetEmail function exported from src/lib/email/send.ts
3. npm run build succeeds
4. (After checkpoint) Invitation emails send successfully via Resend
5. (After checkpoint) Emails have branded layout with logo
</verification>

<success_criteria>
- Password reset email template ready for future use
- RESEND_API_KEY configured in Vercel
- DNS records added for SPF, DKIM, DMARC (may take time to propagate)
- End-to-end invitation flow verified working
- Emails arrive in inbox (not spam) once DNS propagates
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-system/02-02-SUMMARY.md`
</output>
