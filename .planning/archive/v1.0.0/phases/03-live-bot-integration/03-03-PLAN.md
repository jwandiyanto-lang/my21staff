---
phase: 03-live-bot-integration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "ARI bot responds to real WhatsApp messages"
    - "Bot greeting sent on first message"
    - "Bot qualification questions asked"
    - "Lead scoring updates in database"
    - "All Your Intern config tabs affect bot behavior"
  artifacts:
    - path: "src/lib/ari/processor.ts"
      provides: "processWithARI function active in production"
      contains: "processWithARI"
    - path: "src/app/api/webhook/kapso/route.ts"
      provides: "Webhook calls processWithARI for new messages"
      contains: "processWithARI"
  key_links:
    - from: "Webhook handler"
      to: "processWithARI"
      via: "After saving message to database"
      pattern: "await processWithARI"
    - from: "processWithARI"
      to: "Kapso sendMessage API"
      via: "Send AI response back to WhatsApp"
      pattern: "sendMessage.*kapsoCredentials"
---

<objective>
Verify ARI bot responds to real WhatsApp messages with complete automation flow.

Purpose: Test the full bot integration end-to-end - from receiving WhatsApp message to AI generating response to sending back via Kapso. This validates all v3.4 bot features work in production.

Output: Confirmed working bot that greets, qualifies, scores, routes, and books consultations with real WhatsApp leads.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-live-bot-integration/03-01-SUMMARY.md
@.planning/phases/03-live-bot-integration/03-02-SUMMARY.md
@src/lib/ari/processor.ts
@src/lib/ari/state-machine.ts
@business/clients/eagle/eagle-ari-journey.md

# ARI Flow (from v3.4)
Complete ARI flow: greeting → qualifying → routing → scheduling → handoff
State machine handles transitions based on lead score and responses
Configuration hot-reload: workspace config applied on every message
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>ARI bot responding to real WhatsApp messages via production webhook</what-built>
  <how-to-verify>
    Test the complete bot flow with a real WhatsApp conversation:

    ## Step 1: Test Initial Greeting

    1. **Send first message from test phone:**
       - WhatsApp to: Eagle Overseas number (connected to Kapso)
       - Message: "Halo"
       - Wait 5-10 seconds

    2. **Verify bot responds:**
       - Check WhatsApp - should receive greeting from ARI
       - Greeting should match Persona tab configuration
       - Check production logs:
         ```bash
         vercel logs --production | grep -i "ARI.*Processing"
         ```
       - Look for: "[ARI] Processing message for contact"
       - Look for: "[ARI] Response sent"

    3. **Check database state:**
       - Convex dashboard → ari_conversations table
       - Find conversation for your phone number
       - Verify state = "greeting"
       - Verify ai_model is set (grok or sea-lion)

    **Expected:** Bot sends personalized greeting in Indonesian, conversation state = "greeting"

    ## Step 2: Test Qualification Flow

    1. **Answer greeting and provide info:**
       - Respond to bot's greeting
       - Provide country preference (e.g., "Saya tertarik kuliah di Australia")
       - Continue conversation, answering bot's questions

    2. **Verify bot qualifies lead:**
       - Bot should ask about:
         - Study destination country
         - Education level
         - Budget
         - Timeline
       - Check logs for state transitions:
         ```bash
         vercel logs --production | grep "ARI.*state"
         ```

    3. **Check lead scoring:**
       - Convex dashboard → contacts table
       - Find your contact by phone
       - Verify lead_score is updating (0-100)
       - Verify lead_status changes (cold/warm/hot)
       - Check ari_conversations → context field has score_breakdown

    **Expected:** Bot asks qualification questions, lead score increases with each answer

    ## Step 3: Test Configuration Impact

    1. **Change bot configuration:**
       - Visit https://www.my21staff.com/eagle-overseas/your-intern
       - Go to Persona tab
       - Change bot_name or greeting_style
       - Save configuration

    2. **Send new message to bot:**
       - Continue WhatsApp conversation
       - Send any message

    3. **Verify config applied:**
       - Bot response should reflect new configuration
       - No server restart required (hot-reload)
       - Check logs for config fetch:
         ```bash
         vercel logs --production | grep "getAriConfig"
         ```

    **Expected:** Configuration changes applied immediately without deployment

    ## Step 4: Test Complete Automation

    1. **Follow full conversation flow:**
       - Answer all qualification questions
       - Provide high-value answers (English proficiency, budget, timeline)
       - Continue until bot routes you

    2. **Verify routing decision:**
       - Hot lead (score 70+): Bot should offer consultation booking
       - Warm lead (score 40-69): Bot should ask more questions
       - Cold lead (score <40): Bot should send community link (if configured)

    3. **Test consultation booking (if hot lead):**
       - Bot should show available days
       - Select a day (e.g., "Senin")
       - Bot shows time slots
       - Select a slot (e.g., "1" for first option)
       - Confirm booking (e.g., "Ya")

    4. **Verify handoff:**
       - Convex dashboard → appointments table
       - Verify appointment created with your contact_id
       - Check ari_conversations → state = "handoff"
       - Check contacts table → tags includes "consultation-booked"

    **Expected:** Complete flow works: greeting → qualification → scoring → routing → booking → handoff

    ## Verification Checklist

    Mark each as ✓ if working, ✗ if broken:

    - [ ] Bot sends greeting on first message
    - [ ] Bot responds within 10 seconds
    - [ ] Responses in Indonesian (configured language)
    - [ ] State transitions tracked (greeting → qualifying → etc)
    - [ ] Lead score updates with each answer
    - [ ] Configuration changes apply without restart
    - [ ] Hot leads routed to consultation
    - [ ] Consultation booking works
    - [ ] Appointment saved to database
    - [ ] Handoff executed (tags, notes updated)

    ## Common Issues

    **Bot doesn't respond:**
    - Check webhook delivery (Step 2 verification)
    - Verify GROK_API_KEY or Sea-Lion endpoint configured
    - Check logs for processWithARI errors

    **Responses generic/wrong language:**
    - Check Your Intern Persona tab configuration
    - Verify bot_name, language, tone settings
    - Reload config (save in Your Intern)

    **Score not updating:**
    - Check form_answers in contact metadata
    - Verify scoring rules in Your Intern Scoring tab
    - Check ari_conversations context for score_breakdown

    **Booking fails:**
    - Verify slots exist in Your Intern Slots tab
    - Check slot availability for selected day
    - Verify appointment creation in Convex logs
  </how-to-verify>
  <resume-signal>
    Provide verification results in this format:

    GREETING: [working/broken]
    QUALIFICATION: [working/broken]
    SCORING: [working/broken]
    CONFIG_RELOAD: [working/broken]
    ROUTING: [working/broken]
    BOOKING: [working/broken]

    Issues (if any): [describe problems]

    Or type "all-working" if everything passed.
  </resume-signal>
</task>

</tasks>

<verification>
**Manual verification required:**
- Send real WhatsApp messages to Eagle Overseas number
- Verify bot responds within 10 seconds
- Test complete conversation flow (greeting → booking)
- Check database for state/score updates
- Verify configuration changes apply immediately

**Success indicators:**
- Bot responds to every message
- Conversation state progresses correctly
- Lead score updates with answers
- Hot leads routed to consultation
- Booking creates appointment record
</verification>

<success_criteria>
1. ARI bot responds to real WhatsApp messages
2. Greeting sent on first contact
3. Qualification questions asked in sequence
4. Lead scoring updates in database
5. Configuration changes apply without restart
6. Complete automation works (greeting → booking)
7. All Your Intern tabs affect bot behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-live-bot-integration/03-03-SUMMARY.md` with:
- Bot testing results (greeting, qualification, scoring, routing, booking)
- Configuration hot-reload test results
- WhatsApp conversation screenshots or logs
- Database state verification (conversations, scores, appointments)
- List of any issues encountered
- Confirmation of complete automation working
</output>
