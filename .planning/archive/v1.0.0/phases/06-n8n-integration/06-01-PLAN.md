---
phase: 06-n8n-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/http.ts
  - convex/n8n.ts
autonomous: false

must_haves:
  truths:
    - "HTTP POST to /webhook/n8n with lead data returns success response"
    - "Duplicate phone numbers return status 'exists' (not duplicated)"
    - "New contacts are created in contacts table with source='n8n'"
    - "Lead metadata is stored in contact's metadata field"
  artifacts:
    - path: "convex/n8n.ts"
      provides: "n8n lead creation mutation"
      exports: ["createLead"]
    - path: "convex/http.ts"
      provides: "HTTP endpoint for n8n webhook"
      contains: "/webhook/n8n"
  key_links:
    - from: "convex/http.ts"
      to: "convex/n8n.ts"
      via: "httpAction calls createLead mutation"
      pattern: "n8n\\.createLead"
    - from: "convex/http.ts"
      to: "workspaces table"
      via: "query workspaces by slug before calling mutation"
      pattern: "by_slug.*eagle-overseas"
---

<objective>
Create Convex HTTP endpoint for n8n lead webhook and connect Eagle's Google Sheets workflow.

Purpose: Restore Eagle's lead capture flow that was broken during Supabase -> Convex migration. This is a temporary bridge until Eagle's website connects directly to the CRM.

Output: Working n8n -> Convex lead flow for Eagle Overseas
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-n8n-integration/06-CONTEXT.md
@business/clients/eagle-n8n-integration.md
@convex/http.ts
@convex/cms.ts (for findOrCreateContact pattern)
@convex/schema.ts (contacts table structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n webhook endpoint and mutation</name>
  <files>convex/n8n.ts, convex/http.ts</files>
  <action>
**Step 1: Create convex/n8n.ts with createLead mutation:**
- Accept fields: workspace_id (v.id("workspaces")), name, phone, email, lead_score, metadata (form_answers)
- Use findOrCreateContact pattern from cms.ts (check by phone using by_workspace_phone index, skip if exists)
- If contact exists: return { success: true, status: "exists", contact_id }
- If new contact: create with source="n8n", tags=["google-form"], return { success: true, status: "created", contact_id }
- No auth required (public mutation like findOrCreateContact in cms.ts)
- Phone normalization: Accept +62 or 0 prefix, normalize to consistent format

**Step 2: Add HTTP route to convex/http.ts:**
- Path: /webhook/n8n
- Method: POST
- Workspace resolution IN HTTP HANDLER (not in mutation):
  1. Query workspaces table using by_slug index with slug "eagle-overseas"
  2. Get workspace._id from result
  3. Pass workspace._id to createLead mutation
- Parse JSON body with fields matching eagle-n8n-integration.md:
  - name, phone, email, lead_score, metadata
- Call n8n.createLead mutation with resolved workspace_id
- Return JSON response: { success: boolean, status: "created"|"exists", contact_id }
- Include basic logging for debugging

This approach keeps the mutation generic (accepts workspace_id) while the HTTP handler hardcodes the slug lookup for Eagle, making it easy to add other workspaces later.
  </action>
  <verify>
npx convex dev (should compile without errors)
Check convex/n8n.ts exists with createLead export
Check convex/http.ts has /webhook/n8n route with workspace query before mutation call
  </verify>
  <done>
HTTP endpoint deployed at pleasant-antelope-109.convex.site/webhook/n8n
createLead mutation handles duplicate detection
Workspace resolved by slug in HTTP handler
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Update n8n workflow URL</name>
  <action>
User must update the n8n workflow to point to the new Convex endpoint.
  </action>
  <instructions>
1. Open n8n at http://100.113.96.25:5678 (via Tailscale)
2. Find the Google Sheets -> Supabase workflow for Eagle
3. Replace the Supabase HTTP Request node with new configuration:
   - URL: https://pleasant-antelope-109.convex.site/webhook/n8n
   - Method: POST
   - Body Content Type: JSON
   - Body Parameters:
     ```json
     {
       "name": "{{ $json['Nama'] }}",
       "phone": "{{ $json['No WhatsApp'] }}",
       "email": "{{ $json['Email'] }}",
       "lead_score": {{ calculated_score }},
       "metadata": {
         "form_answers": {
           "Level Bahasa Inggris": "{{ $json['Level Bahasa Inggris'] }}",
           "Budget": "{{ $json['Budget'] }}",
           "Kapan Mau Berangkat": "{{ $json['Kapan Mau Berangkat'] }}",
           "Aktivitas": "{{ $json['Aktivitas'] }}",
           "Negara Tujuan": "{{ $json['Negara Tujuan'] }}",
           "Remardk": "{{ $json['Remardk'] }}"
         }
       }
     }
     ```
4. Keep the existing score calculation Code node (it works)
5. Save the workflow
  </instructions>
  <resume-signal>Type "n8n updated" when workflow is configured</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify lead flow end-to-end</name>
  <what-built>Complete n8n -> Convex lead integration for Eagle Overseas</what-built>
  <how-to-verify>
1. Submit a test entry to Eagle's Google Form (or add a row directly to the Google Sheet)
   - Use test data: Name="Test N8N Lead", Phone="+628123456789", Email="test@example.com"
2. Wait for n8n to trigger (check n8n execution history)
3. Check n8n workflow execution succeeded (green checkmark)
4. Open my21staff CRM at https://my21staff.com/eagle-overseas/database
5. Search for "Test N8N Lead" or the phone number
6. Verify:
   - Contact appears in database view
   - Lead score is calculated correctly
   - Metadata contains form_answers
   - Tags include "google-form"
   - Source shows "n8n"
7. Submit same phone number again
8. Verify: No duplicate created (n8n response shows "exists")
  </how-to-verify>
  <resume-signal>Type "verified" if lead appears correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Convex compiles without errors
- [ ] HTTP endpoint accessible at /webhook/n8n
- [ ] Test POST returns success response
- [ ] Duplicate phone numbers return "exists" status
- [ ] New leads appear in Eagle's CRM
- [ ] Metadata preserved correctly
</verification>

<success_criteria>
1. HTTP POST to /webhook/n8n returns 200 with success response
2. New leads from POST appear in contacts table with source="n8n"
3. Duplicate submissions return "exists" status (no duplicates created)
4. Lead metadata stored correctly in contact's metadata field
</success_criteria>

<output>
After completion, create `.planning/phases/06-n8n-integration/06-01-SUMMARY.md`
</output>
