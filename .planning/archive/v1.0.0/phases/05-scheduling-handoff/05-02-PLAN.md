---
phase: 05-scheduling-handoff
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/workspace/sidebar.tsx
  - src/app/(dashboard)/[workspace]/knowledge-base/page.tsx
  - src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx
  - src/components/knowledge-base/slot-manager.tsx
autonomous: true

must_haves:
  truths:
    - "Knowledge Base nav item appears in sidebar"
    - "Slot Manager shows list of weekly availability slots"
    - "Admin can add new slots (day + time + duration)"
    - "Admin can toggle slots active/inactive"
    - "Admin can delete slots"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/knowledge-base/page.tsx"
      provides: "Knowledge Base page entry point"
      min_lines: 20
    - path: "src/components/knowledge-base/slot-manager.tsx"
      provides: "Slot management UI component"
      min_lines: 100
  key_links:
    - from: "src/components/knowledge-base/slot-manager.tsx"
      to: "/api/workspaces/[id]/slots"
      via: "fetch calls"
      pattern: "fetch.*slots"
---

<objective>
Create the Knowledge Base section in the CRM with slot management UI.

Purpose: Give admins a place to manage ARI's knowledge and booking slots. This plan focuses on the scheduling slots; persona and university management will be added in Phase 6.

Output: New sidebar nav item, Knowledge Base page, and Slot Manager component for weekly availability patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-scheduling-handoff/05-CONTEXT.md
@src/components/workspace/sidebar.tsx
@src/lib/ari/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Knowledge Base to sidebar navigation</name>
  <files>src/components/workspace/sidebar.tsx</files>
  <action>
Add Knowledge Base nav item to the Admin section in sidebar.tsx.

1. Import BookOpen icon from lucide-react (add to existing imports)

2. Add to adminNav array (before Settings):
```typescript
const adminNav = [
  {
    title: 'Knowledge Base',
    icon: BookOpen,
    href: '/knowledge-base',
  },
  {
    title: 'Settings',
    icon: Settings,
    href: '/settings',
  },
]
```

This places Knowledge Base in Admin section as specified in CONTEXT.md ("Part of Knowledge Base section").
  </action>
  <verify>
Dev server running, navigate to workspace, confirm "Knowledge Base" appears in Admin section of sidebar.
  </verify>
  <done>Knowledge Base nav item visible in sidebar Admin section</done>
</task>

<task type="auto">
  <name>Task 2: Create Knowledge Base page and client component</name>
  <files>
    src/app/(dashboard)/[workspace]/knowledge-base/page.tsx
    src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx
  </files>
  <action>
Create the Knowledge Base page following existing page patterns.

**src/app/(dashboard)/[workspace]/knowledge-base/page.tsx:**

```tsx
import { notFound } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { KnowledgeBaseClient } from './knowledge-base-client'

interface Props {
  params: Promise<{ workspace: string }>
}

export default async function KnowledgeBasePage({ params }: Props) {
  const { workspace: workspaceSlug } = await params
  const supabase = await createClient()

  // Get current user
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return notFound()
  }

  // Get workspace
  const { data: workspace, error } = await supabase
    .from('workspaces')
    .select('id, name, slug')
    .eq('slug', workspaceSlug)
    .single()

  if (error || !workspace) {
    return notFound()
  }

  // Get team members for consultant assignment dropdown
  const { data: members } = await supabase
    .from('workspace_members')
    .select(`
      user_id,
      profiles:user_id (
        id,
        email,
        full_name
      )
    `)
    .eq('workspace_id', workspace.id)

  const teamMembers = (members || []).map(m => ({
    id: m.user_id,
    email: (m.profiles as any)?.email || '',
    full_name: (m.profiles as any)?.full_name || '',
  })).filter(m => m.id)

  return (
    <KnowledgeBaseClient
      workspace={workspace}
      teamMembers={teamMembers}
    />
  )
}
```

**src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx:**

```tsx
'use client'

import { useState } from 'react'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Calendar, Bot, GraduationCap } from 'lucide-react'
import { SlotManager } from '@/components/knowledge-base/slot-manager'

interface TeamMember {
  id: string
  email: string
  full_name: string
}

interface KnowledgeBaseClientProps {
  workspace: {
    id: string
    name: string
    slug: string
  }
  teamMembers: TeamMember[]
}

export function KnowledgeBaseClient({ workspace, teamMembers }: KnowledgeBaseClientProps) {
  const [activeTab, setActiveTab] = useState('scheduling')

  return (
    <div className="p-8 space-y-8">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold text-foreground">Knowledge Base</h1>
        <p className="text-sm text-muted-foreground mt-1">
          Configure ARI's knowledge, persona, and scheduling availability
        </p>
      </div>

      {/* Tabs for different sections */}
      <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
        <TabsList className="grid w-full grid-cols-3 max-w-md">
          <TabsTrigger value="scheduling" className="flex items-center gap-2">
            <Calendar className="w-4 h-4" />
            <span>Scheduling</span>
          </TabsTrigger>
          <TabsTrigger value="persona" disabled className="flex items-center gap-2 opacity-50">
            <Bot className="w-4 h-4" />
            <span>Persona</span>
          </TabsTrigger>
          <TabsTrigger value="universities" disabled className="flex items-center gap-2 opacity-50">
            <GraduationCap className="w-4 h-4" />
            <span>Universities</span>
          </TabsTrigger>
        </TabsList>

        <TabsContent value="scheduling" className="space-y-6">
          <SlotManager workspaceId={workspace.id} teamMembers={teamMembers} />
        </TabsContent>

        <TabsContent value="persona">
          <div className="text-center py-12 text-muted-foreground">
            Persona settings coming in Phase 6
          </div>
        </TabsContent>

        <TabsContent value="universities">
          <div className="text-center py-12 text-muted-foreground">
            University management coming in Phase 6
          </div>
        </TabsContent>
      </Tabs>
    </div>
  )
}
```

Persona and Universities tabs are disabled placeholders - they'll be implemented in Phase 6 (Admin Interface).
  </action>
  <verify>
Navigate to /{workspace}/knowledge-base, verify page loads with tabs, Scheduling tab is selected by default.
  </verify>
  <done>Knowledge Base page renders with Scheduling tab active</done>
</task>

<task type="auto">
  <name>Task 3: Create Slot Manager component</name>
  <files>src/components/knowledge-base/slot-manager.tsx</files>
  <action>
Create the slot management component with list view and add/edit functionality.

```tsx
'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Switch } from '@/components/ui/switch'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Dialog,
  DialogContent,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Plus, Trash2, Loader2, Clock, Calendar } from 'lucide-react'
import { toast } from 'sonner'
import type { ConsultantSlot } from '@/lib/ari/types'

interface TeamMember {
  id: string
  email: string
  full_name: string
}

interface SlotManagerProps {
  workspaceId: string
  teamMembers: TeamMember[]
}

const DAYS_OF_WEEK = [
  { value: 0, label: 'Minggu' },
  { value: 1, label: 'Senin' },
  { value: 2, label: 'Selasa' },
  { value: 3, label: 'Rabu' },
  { value: 4, label: 'Kamis' },
  { value: 5, label: 'Jumat' },
  { value: 6, label: 'Sabtu' },
]

const DURATION_OPTIONS = [
  { value: 30, label: '30 menit' },
  { value: 60, label: '60 menit' },
  { value: 90, label: '90 menit' },
]

export function SlotManager({ workspaceId, teamMembers }: SlotManagerProps) {
  const [slots, setSlots] = useState<ConsultantSlot[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false)
  const [isSaving, setIsSaving] = useState(false)

  // New slot form state
  const [newSlot, setNewSlot] = useState({
    day_of_week: 1, // Monday default
    start_time: '09:00',
    end_time: '10:00',
    duration_minutes: 60,
    booking_window_days: 14,
    consultant_id: '',
  })

  // Fetch slots on mount
  useEffect(() => {
    fetchSlots()
  }, [workspaceId])

  async function fetchSlots() {
    try {
      const res = await fetch(`/api/workspaces/${workspaceId}/slots`)
      if (!res.ok) throw new Error('Failed to fetch')
      const data = await res.json()
      setSlots(data.slots || [])
    } catch (error) {
      console.error('Failed to fetch slots:', error)
      toast.error('Gagal memuat jadwal')
    } finally {
      setIsLoading(false)
    }
  }

  async function handleAddSlot() {
    setIsSaving(true)
    try {
      const res = await fetch(`/api/workspaces/${workspaceId}/slots`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...newSlot,
          consultant_id: newSlot.consultant_id || null,
        }),
      })

      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || 'Failed to create')
      }

      const data = await res.json()
      setSlots([...slots, data.slot])
      setIsAddDialogOpen(false)
      setNewSlot({
        day_of_week: 1,
        start_time: '09:00',
        end_time: '10:00',
        duration_minutes: 60,
        booking_window_days: 14,
        consultant_id: '',
      })
      toast.success('Jadwal berhasil ditambahkan')
    } catch (error: any) {
      toast.error(error.message || 'Gagal menambah jadwal')
    } finally {
      setIsSaving(false)
    }
  }

  async function handleToggleActive(slot: ConsultantSlot) {
    try {
      const res = await fetch(`/api/workspaces/${workspaceId}/slots/${slot.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: !slot.is_active }),
      })

      if (!res.ok) throw new Error('Failed to update')

      setSlots(slots.map(s =>
        s.id === slot.id ? { ...s, is_active: !s.is_active } : s
      ))
      toast.success(slot.is_active ? 'Jadwal dinonaktifkan' : 'Jadwal diaktifkan')
    } catch (error) {
      toast.error('Gagal mengubah status')
    }
  }

  async function handleDeleteSlot(slotId: string) {
    if (!confirm('Hapus jadwal ini?')) return

    try {
      const res = await fetch(`/api/workspaces/${workspaceId}/slots/${slotId}`, {
        method: 'DELETE',
      })

      if (!res.ok) throw new Error('Failed to delete')

      setSlots(slots.filter(s => s.id !== slotId))
      toast.success('Jadwal dihapus')
    } catch (error) {
      toast.error('Gagal menghapus jadwal')
    }
  }

  function formatTime(time: string) {
    // Convert HH:MM:SS or HH:MM to HH:MM
    return time.slice(0, 5)
  }

  function getConsultantName(consultantId: string | null) {
    if (!consultantId) return 'Semua konsultan'
    const member = teamMembers.find(m => m.id === consultantId)
    return member?.full_name || member?.email || 'Unknown'
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header with Add Button */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-lg font-semibold">Jadwal Konsultasi</h2>
          <p className="text-sm text-muted-foreground">
            Atur waktu yang tersedia untuk booking konsultasi
          </p>
        </div>
        <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>
          <DialogTrigger asChild>
            <Button>
              <Plus className="w-4 h-4 mr-2" />
              Tambah Jadwal
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Tambah Jadwal Konsultasi</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              {/* Day of Week */}
              <div className="space-y-2">
                <Label>Hari</Label>
                <Select
                  value={String(newSlot.day_of_week)}
                  onValueChange={(v) => setNewSlot({ ...newSlot, day_of_week: parseInt(v) })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {DAYS_OF_WEEK.map(day => (
                      <SelectItem key={day.value} value={String(day.value)}>
                        {day.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Time Range */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Jam Mulai</Label>
                  <Input
                    type="time"
                    value={newSlot.start_time}
                    onChange={(e) => setNewSlot({ ...newSlot, start_time: e.target.value })}
                  />
                </div>
                <div className="space-y-2">
                  <Label>Jam Selesai</Label>
                  <Input
                    type="time"
                    value={newSlot.end_time}
                    onChange={(e) => setNewSlot({ ...newSlot, end_time: e.target.value })}
                  />
                </div>
              </div>

              {/* Duration */}
              <div className="space-y-2">
                <Label>Durasi per Sesi</Label>
                <Select
                  value={String(newSlot.duration_minutes)}
                  onValueChange={(v) => setNewSlot({ ...newSlot, duration_minutes: parseInt(v) })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {DURATION_OPTIONS.map(opt => (
                      <SelectItem key={opt.value} value={String(opt.value)}>
                        {opt.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Booking Window */}
              <div className="space-y-2">
                <Label>Booking Window (hari ke depan)</Label>
                <Input
                  type="number"
                  min={1}
                  max={60}
                  value={newSlot.booking_window_days}
                  onChange={(e) => setNewSlot({ ...newSlot, booking_window_days: parseInt(e.target.value) || 14 })}
                />
              </div>

              {/* Consultant Assignment */}
              <div className="space-y-2">
                <Label>Konsultan (opsional)</Label>
                <Select
                  value={newSlot.consultant_id || 'any'}
                  onValueChange={(v) => setNewSlot({ ...newSlot, consultant_id: v === 'any' ? '' : v })}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Semua konsultan" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="any">Semua konsultan</SelectItem>
                    {teamMembers.map(member => (
                      <SelectItem key={member.id} value={member.id}>
                        {member.full_name || member.email}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setIsAddDialogOpen(false)}>
                Batal
              </Button>
              <Button onClick={handleAddSlot} disabled={isSaving}>
                {isSaving && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                Simpan
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>

      {/* Slots Table */}
      {slots.length === 0 ? (
        <div className="text-center py-12 border rounded-lg bg-muted/50">
          <Calendar className="w-12 h-12 mx-auto text-muted-foreground mb-4" />
          <p className="text-muted-foreground">Belum ada jadwal konsultasi</p>
          <p className="text-sm text-muted-foreground">
            Tambahkan jadwal untuk mulai menerima booking
          </p>
        </div>
      ) : (
        <div className="border rounded-lg overflow-hidden">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Hari</TableHead>
                <TableHead>Waktu</TableHead>
                <TableHead>Durasi</TableHead>
                <TableHead>Konsultan</TableHead>
                <TableHead>Aktif</TableHead>
                <TableHead className="w-[80px]"></TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {slots.map(slot => (
                <TableRow key={slot.id} className={!slot.is_active ? 'opacity-50' : ''}>
                  <TableCell className="font-medium">
                    {DAYS_OF_WEEK.find(d => d.value === slot.day_of_week)?.label}
                  </TableCell>
                  <TableCell>
                    <span className="flex items-center gap-1">
                      <Clock className="w-3 h-3 text-muted-foreground" />
                      {formatTime(slot.start_time)} - {formatTime(slot.end_time)}
                    </span>
                  </TableCell>
                  <TableCell>{slot.duration_minutes} menit</TableCell>
                  <TableCell>{getConsultantName(slot.consultant_id)}</TableCell>
                  <TableCell>
                    <Switch
                      checked={slot.is_active}
                      onCheckedChange={() => handleToggleActive(slot)}
                    />
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="text-destructive hover:text-destructive"
                      onClick={() => handleDeleteSlot(slot.id)}
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      )}

      {/* Info card */}
      <div className="bg-muted/50 rounded-lg p-4 text-sm text-muted-foreground">
        <p className="font-medium text-foreground mb-1">Cara Kerja</p>
        <ul className="list-disc list-inside space-y-1">
          <li>Jadwal berulang setiap minggu pada hari dan jam yang ditentukan</li>
          <li>Lead dapat booking hingga {slots[0]?.booking_window_days || 14} hari ke depan</li>
          <li>Jadwal yang dinonaktifkan tidak akan ditampilkan untuk booking baru</li>
        </ul>
      </div>
    </div>
  )
}
```

UI uses Bahasa Indonesia for labels (Senin, Selasa, etc.) since target users are Indonesian admins.
  </action>
  <verify>
Navigate to Knowledge Base, add a slot, verify it appears in table.
Toggle active status, confirm UI updates.
Delete slot, confirm removal.
  </verify>
  <done>
Admin can:
- View all slots in table format
- Add new slots with day/time/duration/consultant
- Toggle slots active/inactive
- Delete slots
  </done>
</task>

</tasks>

<verification>
- [ ] Knowledge Base appears in sidebar Admin section
- [ ] Page loads without errors
- [ ] Empty state shows when no slots
- [ ] Add dialog opens and saves new slot
- [ ] Slots display in table with correct formatting
- [ ] Toggle switch updates is_active
- [ ] Delete button removes slot after confirmation
- [ ] Toast notifications for all actions
</verification>

<success_criteria>
- Knowledge Base section accessible from sidebar
- Slot Manager displays all weekly slots
- CRUD operations work via UI
- Indonesian labels for days and UI text
</success_criteria>

<output>
After completion, create `.planning/phases/05-scheduling-handoff/05-02-SUMMARY.md`
</output>
