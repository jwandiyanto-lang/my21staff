---
phase: 06-admin-interface
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/knowledge-base/scoring-tab.tsx
  - src/app/api/workspaces/[workspaceId]/scoring-config/route.ts
  - supabase/migrations/42_scoring_config.sql
  - src/lib/ari/types.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view current scoring thresholds (hot/warm/cold cutoffs)"
    - "Admin can adjust thresholds via sliders"
    - "Admin can view and adjust category weights (basic/qualification/document/engagement)"
    - "Changes save and persist"
  artifacts:
    - path: "src/components/knowledge-base/scoring-tab.tsx"
      provides: "Scoring configuration UI component"
      exports: ["ScoringTab"]
    - path: "src/app/api/workspaces/[workspaceId]/scoring-config/route.ts"
      provides: "Scoring config API"
      exports: ["GET", "PUT"]
    - path: "supabase/migrations/42_scoring_config.sql"
      provides: "ari_scoring_config table"
  key_links:
    - from: "scoring-tab.tsx"
      to: "/api/workspaces/[workspaceId]/scoring-config"
      via: "fetch for GET/PUT"
      pattern: "fetch.*scoring-config"
---

<objective>
Create the Scoring tab for configuring lead scoring thresholds and weights.

Purpose: Workspace owners can adjust what score qualifies as hot/warm/cold, and how much weight each scoring category gets. This fulfills ADMIN-06 and ADMIN-07.

Output: ScoringTab component + API route + database table for scoring configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-interface/06-CONTEXT.md

# Current hardcoded scoring values
@src/lib/ari/scoring.ts (WEIGHTS constant, getLeadTemperature thresholds)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Scoring Config Migration</name>
  <files>supabase/migrations/42_scoring_config.sql</files>
  <action>
Create migration for ari_scoring_config table:

```sql
CREATE TABLE ari_scoring_config (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,

  -- Thresholds (0-100)
  hot_threshold INTEGER NOT NULL DEFAULT 70,
  warm_threshold INTEGER NOT NULL DEFAULT 40,
  -- cold is implicit: < warm_threshold

  -- Category weights (must sum to 100)
  weight_basic INTEGER NOT NULL DEFAULT 25,
  weight_qualification INTEGER NOT NULL DEFAULT 35,
  weight_document INTEGER NOT NULL DEFAULT 30,
  weight_engagement INTEGER NOT NULL DEFAULT 10,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(workspace_id) -- One config per workspace
);
```

**Constraints:**
- CHECK (hot_threshold > warm_threshold)
- CHECK (hot_threshold <= 100 AND hot_threshold >= 1)
- CHECK (warm_threshold >= 0 AND warm_threshold < 100)
- CHECK (weight_basic + weight_qualification + weight_document + weight_engagement = 100)

**RLS Policies:** Workspace member pattern.
**Trigger:** updated_at trigger.
  </action>
  <verify>
Run migration. Table ari_scoring_config exists with constraints.
  </verify>
  <done>
Database table for scoring config created with validation constraints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Scoring Config API Route</name>
  <files>
src/app/api/workspaces/[workspaceId]/scoring-config/route.ts
src/lib/ari/types.ts
  </files>
  <action>
**Add type to types.ts:**
```typescript
export interface ScoringConfig {
  id: string;
  workspace_id: string;
  hot_threshold: number;
  warm_threshold: number;
  weight_basic: number;
  weight_qualification: number;
  weight_document: number;
  weight_engagement: number;
  created_at: string;
  updated_at: string;
}
```

**GET /api/workspaces/[workspaceId]/scoring-config**
- Fetch existing config or return defaults:
  - hot_threshold: 70
  - warm_threshold: 40
  - weight_basic: 25
  - weight_qualification: 35
  - weight_document: 30
  - weight_engagement: 10

**PUT /api/workspaces/[workspaceId]/scoring-config**
- Upsert config
- Body: { hot_threshold, warm_threshold, weight_basic, weight_qualification, weight_document, weight_engagement }
- Validate:
  - hot_threshold > warm_threshold
  - All weights sum to 100
  - All values in valid ranges
- Return { config } on success, { error } with details on validation failure
  </action>
  <verify>
- GET returns defaults when no config exists
- PUT creates config with valid values
- PUT rejects invalid threshold order
- PUT rejects weights not summing to 100
  </verify>
  <done>
API supports GET (with defaults) and PUT (with validation) for scoring config.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ScoringTab Component</name>
  <files>src/components/knowledge-base/scoring-tab.tsx</files>
  <action>
Create ScoringTab component with threshold and weight controls:

**Layout:**
- Two sections: Thresholds (top) and Weights (bottom)
- Save Changes button at bottom

**Thresholds Section:**
- Visual slider/range with three zones: Cold | Warm | Hot
- Hot Threshold slider (1-100, default 70)
- Warm Threshold slider (0-99, default 40, must be < hot)
- Labels showing current values
- Color indicators: Cold=blue, Warm=yellow, Hot=red/orange
- Visual preview: "Score 75 = Hot Lead"

**Weights Section:**
- Four sliders/inputs for category weights
- Labels: "Basic Data", "Qualification", "Documents", "Engagement"
- Show current points allocation (e.g., "25 points")
- Total indicator showing sum (must equal 100)
- Validation error if sum != 100

**UI Components:**
- Use shadcn/ui Slider component
- Show numeric input alongside slider for precision
- Real-time validation feedback
- Disabled save button if validation fails

**Behavior:**
- Load config on mount
- Track dirty state
- Validate thresholds (hot > warm)
- Validate weights (sum = 100)
- Show validation errors inline
- Toast on save success/failure
  </action>
  <verify>
- Component renders with default values
- Can adjust thresholds via sliders
- Cannot set hot <= warm (validation error)
- Can adjust weights
- Cannot save if weights != 100
- Save persists changes
- Refresh shows saved values
  </verify>
  <done>
ScoringTab provides intuitive scoring configuration UI with validation.
  </done>
</task>

</tasks>

<verification>
1. Navigate to Your Intern page
2. Click Scoring tab (after enabling in knowledge-base-client.tsx)
3. See default thresholds: Hot=70, Warm=40
4. See default weights: Basic=25, Qualification=35, Document=30, Engagement=10
5. Adjust hot threshold to 80
6. Try to set warm threshold to 85 - see validation error
7. Set warm threshold to 50 - valid
8. Adjust weights - see sum indicator
9. Try to save with weights summing to 90 - see error
10. Fix weights to sum to 100
11. Save changes
12. Refresh - see persisted values
</verification>

<success_criteria>
- ADMIN-06: Scoring threshold configuration - COMPLETE (hot/warm sliders)
- ADMIN-07: Scoring weight adjustments - COMPLETE (category point allocation)
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-interface/06-04-SUMMARY.md`

Note: This plan creates the UI and storage for scoring config. Integration with the actual scoring calculation (using these values instead of hardcoded WEIGHTS) requires updating src/lib/ari/scoring.ts to read from database. This can be done in a follow-up plan or Phase 7.
</output>
