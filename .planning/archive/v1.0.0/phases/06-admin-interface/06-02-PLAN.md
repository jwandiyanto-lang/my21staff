---
phase: 06-admin-interface
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/knowledge-base/flow-tab.tsx
  - src/app/api/workspaces/[workspaceId]/flow-stages/route.ts
  - supabase/migrations/40_flow_stages.sql
  - src/lib/ari/types.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view existing conversation flow stages"
    - "Admin can add new stages with name, goal, sample script, exit criteria"
    - "Admin can reorder stages via drag-and-drop or arrows"
    - "Admin can edit and delete existing stages"
    - "Stages are ordered and saved to database"
  artifacts:
    - path: "src/components/knowledge-base/flow-tab.tsx"
      provides: "Flow configuration UI component"
      exports: ["FlowTab"]
    - path: "src/app/api/workspaces/[workspaceId]/flow-stages/route.ts"
      provides: "Flow stages CRUD API"
      exports: ["GET", "POST", "PUT", "DELETE"]
    - path: "supabase/migrations/40_flow_stages.sql"
      provides: "ari_flow_stages table schema"
  key_links:
    - from: "flow-tab.tsx"
      to: "/api/workspaces/[workspaceId]/flow-stages"
      via: "fetch for CRUD operations"
      pattern: "fetch.*flow-stages"
---

<objective>
Create the Flow tab for configuring custom conversation stages.

Purpose: Replace the hardcoded state machine (greeting -> qualifying -> scoring -> booking...) with admin-configurable stages. Each stage has a name, goal, sample script, and exit criteria. This enables flexible conversation flows for different business types.

Output: FlowTab component + API route + database table for custom stages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-interface/06-CONTEXT.md

# Reference for current state machine (being replaced)
@src/lib/ari/state-machine.ts
@src/lib/ari/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flow Stages Database Migration</name>
  <files>supabase/migrations/40_flow_stages.sql</files>
  <action>
Create migration for ari_flow_stages table:

```sql
CREATE TABLE ari_flow_stages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  goal TEXT NOT NULL,
  sample_script TEXT,
  exit_criteria TEXT,
  stage_order INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(workspace_id, stage_order)
);
```

Add RLS policies using the workspace member pattern (same as ari_config).
Add updated_at trigger.
Add index on workspace_id.

**Default stages (inserted only if workspace has no stages):**
This will be handled in API, not migration. Migration just creates the table.
  </action>
  <verify>
Run migration locally: `npx supabase db push` or apply to remote.
Table ari_flow_stages exists with correct columns.
  </verify>
  <done>
Database table ari_flow_stages created with RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Flow Stages API Route</name>
  <files>
src/app/api/workspaces/[workspaceId]/flow-stages/route.ts
src/lib/ari/types.ts
  </files>
  <action>
**Add FlowStage type to types.ts:**
```typescript
export interface FlowStage {
  id: string;
  workspace_id: string;
  name: string;
  goal: string;
  sample_script: string | null;
  exit_criteria: string | null;
  stage_order: number;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}
```

**Create API route:**

**GET /api/workspaces/[workspaceId]/flow-stages**
- Fetch all stages ordered by stage_order
- If no stages exist, return default stages (don't save, just return):
  - Greeting (order 0): Goal="Welcome lead, establish rapport", Exit="Lead responds"
  - Qualifying (order 1): Goal="Gather key info: destination, budget, timeline", Exit="All required fields collected"
  - Scoring (order 2): Goal="Assess lead readiness based on collected data", Exit="Score calculated, routing determined"
  - Booking (order 3): Goal="Offer consultation for hot leads", Exit="Lead accepts or declines"
  - Scheduling (order 4): Goal="Book consultation time slot", Exit="Appointment confirmed"
  - Handoff (order 5): Goal="Transfer to human consultant", Exit="Consultant takes over"

**POST /api/workspaces/[workspaceId]/flow-stages**
- Create new stage
- Auto-assign stage_order (max existing + 1)
- Body: { name, goal, sample_script?, exit_criteria? }

**PUT /api/workspaces/[workspaceId]/flow-stages**
- Update stage or reorder multiple stages
- If body has { id, name, goal, ... } -> update single stage
- If body has { stages: [{ id, stage_order }, ...] } -> batch reorder

**DELETE /api/workspaces/[workspaceId]/flow-stages?id=xxx**
- Delete stage by id
- Reorder remaining stages to close gap
  </action>
  <verify>
- GET returns default stages when empty
- POST creates new stage with correct order
- PUT updates stage fields
- PUT with stages array reorders correctly
- DELETE removes and reorders
  </verify>
  <done>
API supports full CRUD + reorder for flow stages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create FlowTab Component</name>
  <files>src/components/knowledge-base/flow-tab.tsx</files>
  <action>
Create FlowTab component with stage management UI:

**Layout:**
- Header: "Conversation Flow" with description
- Add Stage button (top right)
- List of stages as expandable cards, ordered

**Stage Card (collapsed):**
- Drag handle (6 dots icon) or Up/Down arrow buttons
- Stage number badge (1, 2, 3...)
- Stage name
- Edit and Delete buttons

**Stage Card (expanded on click):**
- Name input (required)
- Goal textarea (required)
- Sample Script textarea (optional, placeholder "Example messages...")
- Exit Criteria textarea (optional, placeholder "When to move to next stage...")
- Save button (only when editing existing)

**Add Stage Dialog:**
- Same form fields as expanded card
- Create button creates and closes dialog

**Behavior:**
- Load stages on mount
- Drag-drop reorder (use @dnd-kit or simpler up/down buttons)
- Optimistic UI for reorder
- Toast feedback for all actions
- Confirm dialog for delete

**Styling:**
- Cards have subtle border, hover state
- Active drag shows elevation/shadow
- Stage numbers update dynamically based on position
  </action>
  <verify>
- Component renders with default stages
- Can add new stage via dialog
- Can expand stage to edit
- Can reorder with arrows
- Can delete with confirmation
  </verify>
  <done>
FlowTab component provides full stage management UI.
  </done>
</task>

</tasks>

<verification>
1. Navigate to Your Intern page
2. Click Flow tab (after enabling it in knowledge-base-client.tsx)
3. See default stages listed in order
4. Add a new stage "Custom Stage"
5. Edit existing stage (change goal)
6. Reorder stages (move one up/down)
7. Delete a stage
8. Refresh page - changes persist
</verification>

<success_criteria>
- Custom conversation flow stages replace hardcoded state machine concept
- Each stage has: Name, Goal, Sample Script, Exit Criteria
- Stages are ordered and reorderable
- CRUD operations work with persistence
- UI is intuitive for workspace owners
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-interface/06-02-SUMMARY.md`

Note: This plan creates the UI and storage for flow config. Integration with the actual ARI processor (using these stages instead of hardcoded STATE_TRANSITIONS) is a separate concern that may require future work in Phase 7 or beyond.
</output>
