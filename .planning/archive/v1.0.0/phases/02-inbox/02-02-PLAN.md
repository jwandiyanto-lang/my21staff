---
phase: 02-inbox
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/inbox/message-thread.tsx
  - src/components/inbox/message-bubble.tsx
  - src/components/inbox/date-separator.tsx
  - src/components/inbox/empty-state.tsx
  - src/components/inbox/message-status.tsx
autonomous: true

must_haves:
  truths:
    - "User sees message history for selected conversation"
    - "Messages grouped by date with separators"
    - "Inbound messages on left, outbound on right"
    - "Message bubbles show timestamp and read status"
    - "Images display inline, documents as download cards"
  artifacts:
    - path: "src/components/inbox/message-thread.tsx"
      provides: "Message thread container with auto-scroll"
      exports: ["MessageThread"]
    - path: "src/components/inbox/message-bubble.tsx"
      provides: "Single message bubble"
      exports: ["MessageBubble"]
    - path: "src/components/inbox/date-separator.tsx"
      provides: "Date divider between message groups"
      exports: ["DateSeparator"]
    - path: "src/components/inbox/empty-state.tsx"
      provides: "No conversation selected state"
      exports: ["EmptyState"]
    - path: "src/components/inbox/message-status.tsx"
      provides: "Read receipt checkmarks"
      exports: ["MessageStatus"]
  key_links:
    - from: "src/components/inbox/message-thread.tsx"
      to: "convex/messages.ts"
      via: "useQuery(api.messages.listByConversationAsc)"
      pattern: "useQuery.*messages\\.listByConversationAsc"
    - from: "src/components/inbox/message-thread.tsx"
      to: "src/components/inbox/message-bubble.tsx"
      via: "map over messages"
      pattern: "messages\\.map.*MessageBubble"
---

<objective>
Build the message thread view with WhatsApp-style message bubbles and auto-scroll.

Purpose: Users need to read conversation history with visual distinction between inbound/outbound messages. This is the right panel of the inbox.
Output: Working message thread with date separators, read receipts, and media support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inbox/02-CONTEXT.md
@.planning/phases/02-inbox/02-RESEARCH.md

# Existing infrastructure
@convex/messages.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create message thread container with auto-scroll</name>
  <files>
    src/components/inbox/message-thread.tsx
    src/components/inbox/empty-state.tsx
  </files>
  <action>
Create the message thread container component:

1. `message-thread.tsx`:
   - Accept props: conversationId, workspaceId, contact (for header display)
   - Use `useQuery(api.messages.listByConversationAsc)` for chronological messages
   - Implement smart auto-scroll (from RESEARCH.md Pattern 3):
     - Track if user is at bottom with scroll handler
     - Auto-scroll to bottom only if user was at bottom
     - Threshold of 100px from bottom
   - Group messages by date for DateSeparator insertion
   - Show loading skeleton while fetching
   - Header section: contact avatar, name, phone, status

Layout structure:
```
<div className="flex flex-col h-full">
  {/* Header */}
  <div className="p-4 border-b bg-background flex items-center gap-3">
    <Avatar>...</Avatar>
    <div>
      <p className="font-medium">{contact.name}</p>
      <p className="text-sm text-muted-foreground">{contact.phone}</p>
    </div>
  </div>

  {/* Messages area - WhatsApp style background */}
  <div
    ref={containerRef}
    onScroll={handleScroll}
    className="flex-1 overflow-y-auto p-4 bg-[#f0f2f5]"
    style={{ backgroundImage: 'url(/chat-bg.svg)' }} // optional WhatsApp pattern
  >
    {/* Date separators + messages */}
    <div ref={messagesEndRef} />
  </div>

  {/* Compose area placeholder - will be filled in Plan 03 */}
  <div className="p-4 border-t bg-background">
    <p className="text-muted-foreground">Compose area coming...</p>
  </div>
</div>
```

2. `empty-state.tsx`:
   - Display when no conversation selected
   - WhatsApp-style centered message with icon
   - Text: "Pilih percakapan untuk mulai mengobrol" (Select a conversation to start chatting)
   - Muted colors, professional feel

Implementation notes:
- Use useEffect with messages dependency to trigger auto-scroll
- Use useRef for scroll container and messages end marker
- Group messages by date using date-fns format('yyyy-MM-dd')
  </action>
  <verify>
Message thread loads messages for selected conversation, auto-scrolls to bottom on open.
  </verify>
  <done>
Message thread displays conversation history with smart auto-scroll and header with contact info.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create message bubble and supporting components</name>
  <files>
    src/components/inbox/message-bubble.tsx
    src/components/inbox/date-separator.tsx
    src/components/inbox/message-status.tsx
  </files>
  <action>
Create the message display components:

1. `message-bubble.tsx`:
   - Accept props: message (from Convex), isOutbound (direction === 'outbound')
   - Brand colors for outbound (bg-primary text-primary-foreground), NOT WhatsApp green
   - Muted background for inbound (bg-white or bg-muted)
   - Support message_type: text, image, document, video, audio
   - For images: render inline with rounded corners, max-w-[300px]
   - For documents: render as download card (icon + filename + download link)
   - Show timestamp (HH:mm format) in corner
   - Show MessageStatus for outbound messages
   - Tail styling: rounded corners, WhatsApp-like bubble shape

Structure:
```tsx
<div className={cn(
  'flex',
  isOutbound ? 'justify-end' : 'justify-start'
)}>
  <div className={cn(
    'max-w-[70%] rounded-lg px-4 py-2 shadow-sm',
    isOutbound
      ? 'bg-primary text-primary-foreground rounded-tr-none'
      : 'bg-white rounded-tl-none'
  )}>
    {/* Content based on message_type */}
    {message.message_type === 'image' && <ImageContent />}
    {message.message_type === 'document' && <DocumentCard />}
    {message.message_type === 'text' && <TextContent />}

    {/* Footer: time + status */}
    <div className="flex items-center justify-end gap-1 mt-1">
      <span className="text-xs opacity-70">
        {format(new Date(message.created_at), 'HH:mm')}
      </span>
      {isOutbound && <MessageStatus status={message.metadata?.status} />}
    </div>
  </div>
</div>
```

2. `date-separator.tsx`:
   - Accept props: date (string 'yyyy-MM-dd')
   - Display: "Hari Ini", "Kemarin", or formatted date "15 Januari 2026"
   - WhatsApp style: centered pill with muted background
   - Use date-fns: isToday, isYesterday, format with Indonesian locale

3. `message-status.tsx`:
   - Accept props: status ('sent' | 'delivered' | 'read' | undefined)
   - Display checkmarks: single gray, double gray, double blue
   - Use Lucide icons: Check, CheckCheck
   - WhatsApp convention: sent=single, delivered=double gray, read=double blue

Per CONTEXT.md: Brand colors for bubbles, not WhatsApp green.
  </action>
  <verify>
`npm run build` passes, messages display with correct styling and read receipts.
  </verify>
  <done>
Message bubbles render with brand colors, date separators group messages, status indicators show for outbound.
  </done>
</task>

</tasks>

<verification>
1. Select a conversation in inbox
2. Message thread displays with correct message order
3. Date separators show between different days
4. Outbound messages on right with brand color
5. Inbound messages on left with muted background
6. Images render inline
7. Timestamps visible on all messages
8. Auto-scroll works when at bottom, respects scroll position when reading history
</verification>

<success_criteria>
- Message thread loads messages from Convex in chronological order
- Date separators display correctly (Hari Ini, Kemarin, dates)
- Outbound bubbles use brand color (not WhatsApp green)
- Inbound bubbles use muted/white background
- Images display inline with max width
- Timestamps show HH:mm format
- Auto-scroll works smoothly
- Empty state shows when no conversation selected
</success_criteria>

<output>
After completion, create `.planning/phases/02-inbox/02-02-SUMMARY.md`
</output>
