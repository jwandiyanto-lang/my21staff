---
phase: 03-your-intern-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/knowledge-base/ai-toggle.tsx
  - src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx
  - src/app/api/workspaces/[id]/ari-config/route.ts
autonomous: true

must_haves:
  truths:
    - "User sees AI toggle at top of Your Intern page above tabs"
    - "Toggling AI on/off saves state immediately without explicit save button"
    - "Toggle state persists across page refreshes"
    - "Visual feedback shows when AI is enabled vs disabled"
  artifacts:
    - path: "src/components/knowledge-base/ai-toggle.tsx"
      provides: "Global AI toggle component with on/off switch"
      min_lines: 60
    - path: "src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx"
      provides: "AIToggle rendered above tabs"
      contains: "AIToggle"
    - path: "src/app/api/workspaces/[id]/ari-config/route.ts"
      provides: "PATCH endpoint for toggle AI enabled/disabled"
      exports: ["PATCH"]
  key_links:
    - from: "src/components/knowledge-base/ai-toggle.tsx"
      to: "/api/workspaces/[id]/ari-config"
      via: "PATCH request on toggle change"
      pattern: "method: 'PATCH'"
    - from: "knowledge-base-client.tsx"
      to: "ai-toggle.tsx"
      via: "Component import and render"
      pattern: "<AIToggle"
---

<objective>
Add Global AI Toggle component to Your Intern page that enables/disables AI processing. Master control visible above all tabs.

Purpose: Give users single on/off switch for entire AI system without navigating tabs.
Output: Working toggle that immediately persists state and shows clear on/off visual feedback.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-your-intern-debug/02-01-SUMMARY.md
@.planning/phases/02-your-intern-debug/02-02-SUMMARY.md
@.planning/phases/03-your-intern-configuration/03-CONTEXT.md
@.planning/phases/03-your-intern-configuration/03-RESEARCH.md

# Existing tab components (for reference)
@src/components/knowledge-base/persona-tab.tsx
@src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx
@src/app/api/workspaces/[id]/ari-config/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AIToggle component with Switch UI</name>
  <files>src/components/knowledge-base/ai-toggle.tsx</files>
  <action>
Create client component at src/components/knowledge-base/ai-toggle.tsx:

**Component Interface:**
```typescript
interface AIToggleProps {
  workspaceId: string
  initialEnabled?: boolean
}
```

**Implementation Requirements:**
1. Use Radix Switch from @/components/ui/switch (already in package.json)
2. Auto-save on toggle change (no save button)
3. Show loading state during save (disable switch while saving)
4. Toast on success ("AI enabled" / "AI disabled") and error
5. Visual indicator: Show "AI Processing: Enabled" or "AI Processing: Disabled" with color-coded badge
6. Dev mode support: if workspaceId === 'demo', skip API call and just toggle locally

**Pattern to Follow:** Use PersonaTab pattern from research (useState + useEffect + fetch + toast)

**API Integration:**
- PATCH /api/workspaces/${workspaceId}/ari-config
- Body: `{ enabled: boolean }`
- Response: `{ config: { enabled: boolean } }`

**Dev Mode Check:**
```typescript
const isDevMode = process.env.NEXT_PUBLIC_DEV_MODE === 'true'
if (isDevMode && workspaceId === 'demo') {
  // Skip API call, just update local state
  setEnabled(newState)
  toast.success(newState ? 'AI enabled' : 'AI disabled')
  return
}
```

**UI Layout:**
- Horizontal layout: Label | Switch | Status badge
- Use bg-accent rounded-lg p-4 for prominence (matches research example)
- Status badge shows green when enabled, gray when disabled

**Why this way:**
- PATCH endpoint already exists in ari-config route (verified in research)
- Pattern matches PersonaTab auto-save UX (consistent with other tabs)
- Dev mode support allows offline testing at localhost:3000/demo
  </action>
  <verify>
1. Component file created at src/components/knowledge-base/ai-toggle.tsx
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. Component imports Switch from @/components/ui/switch
4. Dev mode check included for demo workspace
  </verify>
  <done>
- AIToggle component exists with TypeScript interface
- Switch toggles between enabled/disabled states
- Auto-save on change with toast feedback
- Dev mode bypass implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AIToggle into KnowledgeBaseClient page</name>
  <files>src/app/(dashboard)/[workspace]/knowledge-base/knowledge-base-client.tsx</files>
  <action>
Modify knowledge-base-client.tsx to add Global AI Toggle above tabs:

**Steps:**
1. Import AIToggle component at top
2. Add state to track AI enabled status:
```typescript
const [aiEnabled, setAiEnabled] = useState(true)
```

3. Fetch initial enabled state from API on mount:
```typescript
useEffect(() => {
  async function fetchAiStatus() {
    try {
      const res = await fetch(`/api/workspaces/${workspace.id}/ari-config`)
      if (!res.ok) return
      const data = await res.json()
      setAiEnabled(data.config?.enabled ?? true)
    } catch (error) {
      console.error('Failed to fetch AI status:', error)
    }
  }
  fetchAiStatus()
}, [workspace.id])
```

4. Render AIToggle between header and Tabs component:
```typescript
<div className="p-8 space-y-8">
  {/* Header */}
  <div>
    <h1 className="text-2xl font-bold text-foreground">Your Intern</h1>
    <p className="text-sm text-muted-foreground mt-1">...</p>
  </div>

  {/* Global AI Toggle */}
  <AIToggle
    workspaceId={workspace.id}
    initialEnabled={aiEnabled}
  />

  {/* Tabs for different sections */}
  <Tabs value={activeTab} onValueChange={setActiveTab}>
    ...
  </Tabs>
</div>
```

**Why this placement:**
- Toggle is always visible regardless of active tab
- Located above tabs per CONTEXT.md requirement ("top of page, above tabs")
- Separate from tab content (not inside any TabsContent)

**Optional Enhancement (Claude's discretion):**
- Disable tab editing when AI is OFF by passing aiEnabled prop to tab components
- Or leave tabs always editable (simpler, settings persist for when AI turns back on)
  </action>
  <verify>
1. AIToggle component imported in knowledge-base-client.tsx
2. Component rendered above Tabs component
3. Initial enabled state fetched on mount
4. Page compiles without TypeScript errors: `npx tsc --noEmit`
5. Dev server starts without errors: `npm run dev`
  </verify>
  <done>
- AIToggle visible at top of Your Intern page
- Toggle positioned above all 5 tabs
- Initial state loaded from API on page load
- Page layout preserved (tabs still functional)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify PATCH endpoint and dev mode support</name>
  <files>src/app/api/workspaces/[id]/ari-config/route.ts</files>
  <action>
Verify that PATCH endpoint in ari-config route has proper dev mode support:

**Check Existing PATCH Handler:**
The route should already have a PATCH handler from Phase 2. Verify it includes:

1. Dev mode bypass at the start:
```typescript
export async function PATCH(request: NextRequest, { params }: RouteParams) {
  try {
    const { id: workspaceId } = await params

    if (isDevMode() && workspaceId === 'demo') {
      const body = await request.json()
      return NextResponse.json({
        config: {
          enabled: body.enabled,
          ...DEFAULT_CONFIG,
        },
      })
    }
    // ... rest of implementation
  }
}
```

2. Validation for enabled field:
```typescript
if (typeof body.enabled !== 'boolean') {
  return NextResponse.json(
    { error: 'enabled must be a boolean' },
    { status: 400 }
  )
}
```

3. Convex mutation call (existing):
```typescript
const config = await fetchMutation(api.ari.toggleAiEnabled, {
  workspace_id: workspace._id,
  enabled: body.enabled,
})
```

**If PATCH handler missing or incomplete:**
- Add dev mode check following pattern from GET/PUT handlers
- Ensure it returns mock response for demo workspace
- Keep response shape consistent: `{ config: { enabled: boolean } }`

**Verification Steps:**
1. Read the file to check PATCH handler exists
2. If dev mode check missing, add it following existing GET/PUT pattern
3. Test that PATCH accepts `{ enabled: boolean }` body
4. Test that it returns `{ config: { enabled: boolean } }` response

**Why verify this:**
- Research shows PATCH endpoint exists but we need to confirm dev mode support
- Dev mode bypass is CRITICAL for localhost:3000/demo testing
- Consistent with all other API routes (from Phase 2)
  </action>
  <verify>
1. PATCH handler exists in ari-config route.ts
2. Dev mode check present: if (isDevMode() && workspaceId === 'demo')
3. Returns mock config for demo workspace
4. Validation present for enabled field
5. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
- PATCH /api/workspaces/[id]/ari-config supports dev mode
- Returns appropriate mock response for demo workspace
- Endpoint ready for AIToggle component integration
- All dev mode checks consistent across GET/PUT/PATCH
  </done>
</task>

</tasks>

<verification>
**Manual Testing at localhost:3000/demo:**

1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/demo/knowledge-base
3. Verify Global AI Toggle visible above tabs
4. Toggle AI off → see "AI disabled" toast, badge changes to gray
5. Toggle AI on → see "AI enabled" toast, badge changes to green
6. Refresh page → toggle state persists (still shows last selected state)
7. Check browser console → no errors

**Expected Behavior:**
- Toggle responds immediately (no lag)
- Toast appears on every toggle
- State persists across page refresh
- Dev mode works offline (no network calls to Convex)
</verification>

<success_criteria>
**Measurable Outcomes:**

1. **Visual Presence:** AIToggle component renders at top of Your Intern page, above all tabs
2. **Toggle Functionality:** Switch changes state immediately, shows loading during save
3. **Persistence:** Toggle state survives page refresh (fetched on mount)
4. **Feedback:** Toast notification shown on every toggle change (success or error)
5. **Dev Mode:** Works at localhost:3000/demo without Convex/Clerk (offline testing)
6. **Visual Clarity:** Status badge clearly shows "Enabled" (green) or "Disabled" (gray)

**What "complete" looks like:**
User opens Your Intern page, sees prominent AI toggle at top, can switch it on/off instantly with visual feedback, and settings persist. No confusion about AI state.
</success_criteria>

<output>
After completion, create `.planning/phases/03-your-intern-configuration/03-01-SUMMARY.md`
</output>
