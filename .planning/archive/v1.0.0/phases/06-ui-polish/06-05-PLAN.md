---
phase: 06-ui-polish
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/mock-data.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Mock contacts structure matches Convex contacts schema exactly"
    - "Mock workspace settings structure matches production workspace.settings"
    - "Mock conversations and messages have all required Convex fields"
    - "Dev mode behavior mirrors production (same fields available in UI)"
  artifacts:
    - path: "src/lib/mock-data.ts"
      provides: "Mock data structures matching Convex schema"
      exports: ["MOCK_CONTACTS", "MOCK_WORKSPACE", "MOCK_CONVEX_WORKSPACE", "MOCK_CONVERSATIONS", "MOCK_MESSAGES"]
      min_lines: 400
  key_links:
    - from: "MOCK_CONTACTS"
      to: "convex/schema.ts contacts table"
      via: "field parity"
      pattern: "phone_normalized.*kapso_name.*supabaseId"
    - from: "MOCK_CONVEX_WORKSPACE.settings"
      to: "convex/schema.ts workspaces.settings"
      via: "lead_statuses config"
      pattern: "lead_statuses.*\\[\\]"
    - from: "MOCK_CONVERSATIONS"
      to: "convex/schema.ts conversations table"
      via: "timestamp fields as numbers"
      pattern: "last_message_at.*number"
---

<objective>
Sync local dev mode database structure with production Convex schema to ensure environment parity.

Purpose: Mock data in dev mode should match production Convex schema exactly so that UI behavior is identical between localhost testing and production. Missing fields or incorrect types cause different behavior, making localhost testing unreliable. This addresses the gap: "local database environment should match the online environment."

Output: Mock data structures in src/lib/mock-data.ts fully aligned with Convex schema, all required fields present with correct types.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/planning/STATE.md

@/home/jfransisco/Desktop/21/my21staff/convex/schema.ts
@/home/jfransisco/Desktop/21/my21staff/src/lib/mock-data.ts
</context>

<tasks>

<task type="auto">
  <name>Audit schema vs mock data and identify structural differences</name>
  <files>src/lib/mock-data.ts</files>
  <action>
**Goal:** Ensure mock data matches Convex schema exactly.

**Step 1: Audit MOCK_CONTACTS vs convex/schema.ts contacts table**

Convex schema defines these fields (lines 37-54):
- workspace_id: v.id("workspaces") - Convex ID format
- phone: v.string() ✓ (present)
- phone_normalized: v.optional(v.string()) ✓ (present)
- name: v.optional(v.string()) ✓ (present)
- kapso_name: v.optional(v.string()) - **MISSING in mock**
- email: v.optional(v.string()) ✓ (present)
- lead_score: v.number() ✓ (present)
- lead_status: v.string() ✓ (present)
- tags: v.optional(v.array(v.string())) ✓ (present)
- assigned_to: v.optional(v.string()) ✓ (present)
- source: v.optional(v.string()) - **MISSING in mock** (exists in metadata.source, should be top-level)
- metadata: v.optional(v.any()) ✓ (present)
- cache_updated_at: v.optional(v.number()) ✓ (present)
- created_at: v.number() - **TYPE MISMATCH** (mock uses string, schema uses number)
- updated_at: v.number() - **TYPE MISMATCH** (mock uses string, schema uses number)
- supabaseId: v.string() - **MISSING in mock**

**Changes to MOCK_CONTACTS (lines 140-199):**

1. Add missing fields to each contact object:
```typescript
kapso_name: 'Budi Santoso',  // WhatsApp profile name
source: 'Website',  // Top-level (also keep in metadata for backwards compat)
supabaseId: 'supabase-uuid-001',  // Migration reference
```

2. Fix timestamp types from ISO strings to Unix milliseconds (numbers):
```typescript
// BEFORE:
created_at: '2026-01-15T10:00:00Z',
updated_at: '2026-01-20T14:30:00Z',

// AFTER:
created_at: new Date('2026-01-15T10:00:00Z').getTime(),
updated_at: new Date('2026-01-20T14:30:00Z').getTime(),
```

Apply to all contacts (contact-001, contact-002).

**Step 2: Audit MOCK_CONVEX_WORKSPACE.settings**

Production workspaces store lead_statuses config in settings (from Phase 5):
```typescript
settings: {
  kapso_api_key?: string
  whatsapp_number?: string
  whatsapp_name?: string
  quick_replies?: { id: string; label: string; text: string }[]
  contact_tags?: string[]
  lead_statuses?: {  // ADD THIS
    key: string
    label: string
    color: string
    enabled: boolean
  }[]
}
```

**Changes to MOCK_CONVEX_WORKSPACE.settings (lines 20-47):**

Add lead_statuses array matching production config:
```typescript
settings: {
  kapso_api_key: 'mock-api-key',
  whatsapp_number: '+62 xxx xxxx xxxx',
  whatsapp_name: 'Jonathan Wandiyanto',
  quick_replies: [
    { id: '1', label: 'Greeting', text: 'Halo! Ada yang bisa saya bantu?' },
    { id: '2', label: 'Thanks', text: 'Terima kasih sudah menghubungi kami!' },
  ],
  contact_tags: ['Hot Lead', 'Student', 'Parent', 'Follow Up'],
  lead_statuses: [  // ADD THIS
    { key: 'new', label: 'New', color: '#808080', enabled: true },
    { key: 'cold', label: 'Cold', color: '#3b82f6', enabled: true },
    { key: 'warm', label: 'Warm', color: '#f59e0b', enabled: true },
    { key: 'hot', label: 'Hot', color: '#ef4444', enabled: true },
    { key: 'client', label: 'Client', color: '#10b981', enabled: true },
    { key: 'lost', label: 'Lost', color: '#6b7280', enabled: false },
  ],
},
```

**Step 3: Audit MOCK_CONVERSATIONS vs convex/schema.ts conversations table**

Convex schema defines (lines 62-73):
- last_message_at: v.optional(v.number()) - **TYPE MISMATCH** (mock uses string)
- created_at: v.number() - **TYPE MISMATCH** (mock uses string)
- updated_at: v.number() - **TYPE MISMATCH** (mock uses string)
- supabaseId: v.string() - **MISSING in mock**

**Changes to MOCK_CONVERSATIONS_RAW (lines 204-229):**

1. Fix timestamp types to numbers:
```typescript
// BEFORE:
last_message_at: '2026-01-20T14:30:00Z',
created_at: '2026-01-15T10:00:00Z',
updated_at: '2026-01-20T14:30:00Z',

// AFTER:
last_message_at: new Date('2026-01-20T14:30:00Z').getTime(),
created_at: new Date('2026-01-15T10:00:00Z').getTime(),
updated_at: new Date('2026-01-20T14:30:00Z').getTime(),
```

2. Add supabaseId to each conversation:
```typescript
supabaseId: 'supabase-conv-001',
```

Apply to all conversations (conv-001, conv-002).

**Step 4: Audit MOCK_MESSAGES vs convex/schema.ts messages table**

Convex schema defines (lines 81-94):
- created_at: v.number() - **TYPE MISMATCH** (mock uses string)
- supabaseId: v.string() - **MISSING in mock**

**Changes to MOCK_MESSAGES (lines 238-339):**

1. Fix timestamp type to number for all messages:
```typescript
// BEFORE:
created_at: '2026-01-15T10:00:00Z',

// AFTER:
created_at: new Date('2026-01-15T10:00:00Z').getTime(),
```

2. Add supabaseId to each message:
```typescript
supabaseId: 'supabase-msg-001',
```

Apply to all messages (msg-001 through msg-007).

**Step 5: Verify MOCK_WORKSPACE (lines 115-137)**

This type uses old Supabase types (Contact, Workspace from @/types/database). Check if timestamps need conversion:
- created_at: string (likely okay - this type may expect strings)
- updated_at: string (likely okay)

**Action:** Leave MOCK_WORKSPACE as-is since it uses different type definitions. Only update MOCK_CONVEX_WORKSPACE and Convex-aligned types.

**Step 6: Verify MOCK_NOTES**

MOCK_NOTES is NOT directly mapped to Convex contactNotes schema. Check if used:
- MockNote type defines timestamps as strings (lines 342-349)
- Used in dev mode for notes display

**Changes to MOCK_NOTES (lines 351-376):**

Convex contactNotes schema (lines 101-108) requires:
- workspace_id: v.id("workspaces")
- contact_id: v.id("contacts")
- user_id: v.string()
- content: v.string()
- created_at: v.number() - **TYPE MISMATCH**
- supabaseId: v.string() - **MISSING**

Update MockNote type and data:
```typescript
export interface MockNote {
  id: string
  workspace_id: string  // ADD
  contact_id: string
  user_id: string  // ADD
  content: string
  due_date: string | null  // Keep for UI compatibility
  is_completed: boolean  // Keep for UI compatibility
  created_at: number  // CHANGE from string
  supabaseId: string  // ADD
}

export const MOCK_NOTES: MockNote[] = [
  {
    id: 'note-001',
    workspace_id: 'dev-workspace-001',  // ADD
    contact_id: 'contact-001',
    user_id: 'dev-user-001',  // ADD
    content: 'Follow up about Australia visa requirements - he mentioned budget concerns',
    due_date: '2026-01-28T10:00:00Z',  // Keep for UI
    is_completed: false,  // Keep for UI
    created_at: new Date('2026-01-20T15:00:00Z').getTime(),  // CONVERT
    supabaseId: 'supabase-note-001',  // ADD
  },
  // ... repeat for note-002, note-003
]
```

**Summary of all changes:**
1. MOCK_CONTACTS: Add kapso_name, source (top-level), supabaseId; fix timestamps to numbers
2. MOCK_CONVEX_WORKSPACE.settings: Add lead_statuses array
3. MOCK_CONVERSATIONS_RAW: Fix timestamps to numbers, add supabaseId
4. MOCK_MESSAGES: Fix timestamps to numbers, add supabaseId
5. MOCK_NOTES: Add workspace_id, user_id, supabaseId; fix created_at to number

**Why this matters:**
- UI code expects fields that exist in production
- TypeScript types derive from Convex schema
- Missing fields cause undefined errors or different behavior
- Timestamp type mismatches break date formatting
- Dev mode should be indistinguishable from production in UI behavior
  </action>
  <verify>
1. Check all changes applied:
   ```bash
   # Verify contacts have new fields
   grep -n "kapso_name:" src/lib/mock-data.ts
   grep -n "supabaseId:" src/lib/mock-data.ts
   grep -n "source:" src/lib/mock-data.ts | head -5

   # Verify timestamp conversions
   grep -n "created_at:.*getTime()" src/lib/mock-data.ts | wc -l
   # Should show multiple matches (contacts + conversations + messages + notes)

   # Verify lead_statuses added
   grep -n "lead_statuses:" src/lib/mock-data.ts
   ```

2. Test localhost with dev mode:
   ```bash
   npm run dev
   ```
   Visit http://localhost:3000/demo

3. Check console for errors about:
   - Missing fields
   - Undefined properties
   - Type mismatches
   - Should be NO errors

4. Test Database page:
   - Contact cards display correctly
   - All fields visible (name, status, tags, assignee, timestamps)
   - Status dropdown works (uses lead_statuses from settings)
   - No "undefined" text anywhere

5. Test Settings page:
   - Lead Stages tab shows status list
   - Status config loads from workspace.settings.lead_statuses
   - No missing field warnings

6. Test Inbox page:
   - Conversation list displays
   - Last message timestamps format correctly (not "Invalid Date")
   - Contact names appear
   - No console errors

7. Compare structure with production:
   ```bash
   # Mock should mirror Convex types
   node -e "
   const mock = require('./src/lib/mock-data.ts');
   console.log('Contact fields:', Object.keys(mock.MOCK_CONTACTS[0]));
   console.log('Workspace settings:', Object.keys(mock.MOCK_CONVEX_WORKSPACE.settings));
   "
   ```
  </verify>
  <done>
Mock data structures match Convex schema exactly. All required fields present with correct types. Dev mode provides identical field availability as production. Localhost testing reliably represents production behavior.
  </done>
</task>

</tasks>

<verification>
**Localhost test (comprehensive):**
1. `npm run dev`
2. Visit each page and verify no console errors:
   - http://localhost:3000/demo (Dashboard)
   - http://localhost:3000/demo/inbox (Inbox)
   - http://localhost:3000/demo/database (Database)
   - http://localhost:3000/demo/settings (Settings)

**Field presence verification:**
1. Database page: Check contact detail sheet shows all fields
2. Settings page: Lead Stages tab loads status config
3. Inbox page: Timestamps display correctly (not "Invalid Date")

**Type verification:**
```bash
# Check timestamp conversions
grep "created_at:.*getTime()" src/lib/mock-data.ts | wc -l
# Should be 12+ (contacts, conversations, messages, notes)

# Check supabaseId additions
grep "supabaseId:" src/lib/mock-data.ts | wc -l
# Should be 12+ (contacts, conversations, messages, notes)

# Check lead_statuses in settings
grep -A 10 "lead_statuses:" src/lib/mock-data.ts | grep "key:"
# Should show new, cold, warm, hot, client, lost
```

**No console errors:**
- No "undefined is not an object" errors
- No "Cannot read property 'X' of undefined" errors
- No timestamp parsing errors ("Invalid Date")
- No missing field warnings from UI components
</verification>

<success_criteria>
- All mock data types match Convex schema field-for-field
- Timestamps use Unix milliseconds (numbers) not ISO strings
- Missing fields added: kapso_name, source, supabaseId
- MOCK_CONVEX_WORKSPACE.settings includes lead_statuses array
- Dev mode pages load without errors or missing data warnings
- UI behavior identical between localhost and production
- Contact detail sheet displays all fields correctly
- Status dropdowns use lead_statuses config
- Timestamps format correctly throughout app
</success_criteria>

<output>
After completion, create `planning/phases/06-ui-polish/06-05-SUMMARY.md`
</output>
