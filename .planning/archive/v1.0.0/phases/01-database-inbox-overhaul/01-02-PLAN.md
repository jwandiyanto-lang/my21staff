---
phase: 01-database-inbox-overhaul
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/35_contacts_cache_fields.sql
  - src/lib/phone/normalize.ts
  - src/app/api/webhook/kapso/route.ts
autonomous: true

must_haves:
  truths:
    - "Contacts table stores Kapso profile data (name, profile pic, online status)"
    - "Cache timestamp tracks when Kapso data was last updated"
    - "Phone numbers are normalized to E.164 format on entry"
    - "Webhook updates cache fields when receiving messages"
  artifacts:
    - path: "supabase/migrations/35_contacts_cache_fields.sql"
      provides: "Kapso metadata columns on contacts table"
      min_lines: 20
    - path: "src/lib/phone/normalize.ts"
      provides: "E.164 phone normalization utility"
      exports: ["normalizePhone", "isValidPhone"]
      min_lines: 30
    - path: "src/app/api/webhook/kapso/route.ts"
      provides: "Updated webhook that caches Kapso metadata"
      min_lines: 400
  key_links:
    - from: "src/app/api/webhook/kapso/route.ts"
      to: "src/lib/phone/normalize.ts"
      via: "import normalizePhone"
      pattern: "import.*normalizePhone.*from.*phone/normalize"
    - from: "src/app/api/webhook/kapso/route.ts"
      to: "contacts.kapso_name"
      via: "UPDATE query"
      pattern: "kapso_name|kapso_profile_pic|cache_updated_at"
---

<objective>
Add Kapso metadata caching to contacts table and implement E.164 phone normalization.

Purpose: Enable instant inbox loading by caching WhatsApp profile data, and prevent duplicate contacts by normalizing all phone numbers to consistent E.164 format.

Output: Migration for cache fields, phone normalization utility, updated webhook handler.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-inbox-overhaul/01-CONTEXT.md
@.planning/phases/01-database-inbox-overhaul/01-RESEARCH.md
@supabase/schema.sql
@src/app/api/webhook/kapso/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Kapso cache fields to contacts</name>
  <files>supabase/migrations/35_contacts_cache_fields.sql</files>
  <action>
Create migration to add Kapso metadata columns to existing contacts table:

```sql
-- Add Kapso metadata cache fields to contacts table
-- These are populated from webhook data for instant inbox loading

ALTER TABLE contacts ADD COLUMN IF NOT EXISTS kapso_name VARCHAR(255);
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS kapso_profile_pic TEXT;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS kapso_is_online BOOLEAN DEFAULT false;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS kapso_last_seen TIMESTAMPTZ;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS cache_updated_at TIMESTAMPTZ;

-- Add normalized phone column for consistent matching
-- E.164 format: +628123456789
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS phone_normalized VARCHAR(20);

-- Index for online status filtering (partial index for efficiency)
CREATE INDEX IF NOT EXISTS idx_contacts_kapso_online
  ON contacts(workspace_id, kapso_is_online)
  WHERE kapso_is_online = true;

-- Index for normalized phone lookup
CREATE INDEX IF NOT EXISTS idx_contacts_phone_normalized
  ON contacts(workspace_id, phone_normalized);

-- Backfill normalized phone for existing contacts
-- Basic normalization: strip spaces/dashes, add +62 if starts with 0
UPDATE contacts
SET phone_normalized = CASE
  WHEN phone LIKE '+%' THEN regexp_replace(phone, '[^0-9+]', '', 'g')
  WHEN phone LIKE '0%' THEN '+62' || regexp_replace(substring(phone from 2), '[^0-9]', '', 'g')
  WHEN phone LIKE '62%' THEN '+' || regexp_replace(phone, '[^0-9]', '', 'g')
  ELSE '+62' || regexp_replace(phone, '[^0-9]', '', 'g')
END
WHERE phone_normalized IS NULL;

COMMENT ON COLUMN contacts.kapso_name IS 'WhatsApp profile name from Kapso webhook';
COMMENT ON COLUMN contacts.kapso_profile_pic IS 'WhatsApp profile picture URL from Kapso';
COMMENT ON COLUMN contacts.kapso_is_online IS 'Whether contact is currently online on WhatsApp';
COMMENT ON COLUMN contacts.kapso_last_seen IS 'Last seen timestamp from Kapso';
COMMENT ON COLUMN contacts.cache_updated_at IS 'When Kapso metadata was last refreshed';
COMMENT ON COLUMN contacts.phone_normalized IS 'E.164 normalized phone number for consistent matching';
```
  </action>
  <verify>
```sql
SELECT column_name FROM information_schema.columns
WHERE table_name = 'contacts' AND column_name LIKE 'kapso_%';
-- Should return: kapso_name, kapso_profile_pic, kapso_is_online, kapso_last_seen
```
  </verify>
  <done>Contacts table has Kapso cache fields and phone_normalized column</done>
</task>

<task type="auto">
  <name>Task 2: Create phone normalization utility</name>
  <files>src/lib/phone/normalize.ts</files>
  <action>
Create phone normalization utility using libphonenumber-js:

1. First install the library:
```bash
npm install libphonenumber-js
```

2. Create src/lib/phone/normalize.ts:

```typescript
import { parsePhoneNumber, isValidPhoneNumber, CountryCode } from 'libphonenumber-js'

/**
 * Normalize phone number to E.164 format
 * @param phone - Phone number in any format
 * @param defaultCountry - Default country if no country code (default: ID for Indonesia)
 * @returns E.164 formatted phone number (e.g., +6281234567890) or null if invalid
 */
export function normalizePhone(phone: string, defaultCountry: CountryCode = 'ID'): string | null {
  if (!phone) return null

  // Remove all non-digit characters except +
  const cleaned = phone.replace(/[^\d+]/g, '')

  if (!cleaned) return null

  // Handle Indonesian format: 0812 -> +62812
  if (cleaned.startsWith('0') && defaultCountry === 'ID') {
    const normalized = '+62' + cleaned.slice(1)
    return isValidPhone(normalized) ? normalized : null
  }

  // Handle already E.164 format
  if (cleaned.startsWith('+')) {
    return isValidPhone(cleaned) ? cleaned : null
  }

  // Handle 62xxx format (Indonesian without +)
  if (cleaned.startsWith('62') && cleaned.length >= 10) {
    const normalized = '+' + cleaned
    return isValidPhone(normalized) ? normalized : null
  }

  // Try parsing with default country
  try {
    const parsed = parsePhoneNumber(cleaned, defaultCountry)
    if (parsed && isValidPhoneNumber(parsed.number)) {
      return parsed.format('E.164')
    }
  } catch {
    // Fall through to basic normalization
  }

  // Fallback: assume Indonesian if no country code and reasonable length
  if (cleaned.length >= 9 && cleaned.length <= 15) {
    const normalized = '+62' + cleaned
    return isValidPhone(normalized) ? normalized : null
  }

  return null
}

/**
 * Check if phone number is valid
 * @param phone - Phone number (preferably E.164 format)
 * @returns true if valid
 */
export function isValidPhone(phone: string): boolean {
  if (!phone) return false

  try {
    // For E.164 format, just check basic structure
    if (phone.startsWith('+')) {
      const digits = phone.slice(1)
      return digits.length >= 8 && digits.length <= 15 && /^\d+$/.test(digits)
    }

    // For other formats, try parsing
    return isValidPhoneNumber(phone, 'ID')
  } catch {
    return false
  }
}

/**
 * Format phone for display
 * @param phone - E.164 phone number
 * @returns Formatted display string (e.g., +62 812-3456-7890)
 */
export function formatPhoneDisplay(phone: string): string {
  if (!phone) return ''

  try {
    const parsed = parsePhoneNumber(phone)
    if (parsed) {
      return parsed.formatInternational()
    }
  } catch {
    // Fall through
  }

  return phone
}
```
  </action>
  <verify>
Create a simple test:
```bash
npx tsx -e "
import { normalizePhone, isValidPhone } from './src/lib/phone/normalize'
console.log('0812 ->', normalizePhone('0812-3456-7890'))  // +6281234567890
console.log('+62 ->', normalizePhone('+62 812 3456 7890'))  // +6281234567890
console.log('62xxx ->', normalizePhone('6281234567890'))  // +6281234567890
console.log('valid? ->', isValidPhone('+6281234567890'))  // true
"
```
  </verify>
  <done>Phone normalization utility exports normalizePhone, isValidPhone, formatPhoneDisplay</done>
</task>

<task type="auto">
  <name>Task 3: Update webhook to cache Kapso metadata</name>
  <files>src/app/api/webhook/kapso/route.ts</files>
  <action>
Update the Kapso webhook handler to:

1. Import and use normalizePhone for phone matching
2. Cache Kapso profile data (name, profile pic) on contact creation/update
3. Update cache_updated_at timestamp

Key changes to existing webhook:

**Import normalization:**
```typescript
import { normalizePhone } from '@/lib/phone/normalize'
```

**Update getOrCreateContactsBatch function:**
- Normalize phone numbers before lookup
- Store both original phone and phone_normalized
- Cache kapso_name from webhook profile data
- Set cache_updated_at on contact updates

```typescript
async function getOrCreateContactsBatch(
  supabase: SupabaseClient,
  workspaceId: string,
  phones: string[],
  phoneToName: Map<string, string | null>
): Promise<Map<string, Contact>> {
  const contactMap = new Map<string, Contact>()

  // Normalize all phone numbers for matching
  const normalizedPhones = phones.map(p => normalizePhone(p) || p)
  const phoneToNormalized = new Map<string, string>()
  phones.forEach((p, i) => phoneToNormalized.set(p, normalizedPhones[i]))

  // Get existing contacts by normalized phone
  const { data: existingContacts } = await supabase
    .from('contacts')
    .select('id, phone, phone_normalized, name, kapso_name, workspace_id')
    .eq('workspace_id', workspaceId)
    .in('phone_normalized', normalizedPhones)

  for (const contact of existingContacts || []) {
    // Map back to original phone for lookup
    const originalPhone = phones.find(p =>
      (normalizePhone(p) || p) === contact.phone_normalized
    )
    if (originalPhone) {
      contactMap.set(originalPhone, contact as Contact)
    }

    // Update kapso_name and cache_updated_at if we have new data
    const kapsoName = phoneToName.get(originalPhone || '')
    if (kapsoName && kapsoName !== contact.kapso_name) {
      await supabase
        .from('contacts')
        .update({
          kapso_name: kapsoName,
          cache_updated_at: new Date().toISOString(),
          // Also update name if contact doesn't have one set
          ...(contact.name ? {} : { name: kapsoName })
        })
        .eq('id', contact.id)
    }
  }

  // Create missing contacts with normalized phone
  const missingPhones = phones.filter(p => !contactMap.has(p))
  if (missingPhones.length > 0) {
    const newContacts = missingPhones.map(phone => {
      const normalized = normalizePhone(phone) || phone
      const kapsoName = phoneToName.get(phone) || null
      return {
        workspace_id: workspaceId,
        phone,
        phone_normalized: normalized,
        name: kapsoName, // Use Kapso name as initial name
        kapso_name: kapsoName,
        cache_updated_at: new Date().toISOString(),
        lead_status: 'new',
        lead_score: 0,
      }
    })

    const { data: createdContacts, error } = await supabase
      .from('contacts')
      .insert(newContacts)
      .select('id, phone, phone_normalized, name, kapso_name, workspace_id')

    if (error) {
      console.error('[Webhook] Batch contact create error:', error)
    }

    for (const contact of createdContacts || []) {
      contactMap.set(contact.phone, contact as Contact)
    }
  }

  return contactMap
}
```

**Update Contact type to include new fields:**
```typescript
interface Contact {
  id: string
  phone: string
  phone_normalized?: string
  name: string | null
  kapso_name?: string | null
  workspace_id: string
}
```
  </action>
  <verify>
1. Send a test WhatsApp message to workspace
2. Check contacts table: `SELECT phone, phone_normalized, kapso_name, cache_updated_at FROM contacts WHERE workspace_id = 'xxx' ORDER BY created_at DESC LIMIT 5`
3. Verify phone_normalized is in E.164 format and kapso_name is populated
  </verify>
  <done>Webhook caches Kapso metadata and normalizes phone numbers on contact creation/update</done>
</task>

</tasks>

<verification>
1. Migration applied: `SELECT column_name FROM information_schema.columns WHERE table_name = 'contacts' AND column_name LIKE 'kapso_%'` returns 4 columns
2. Phone normalization works: `normalizePhone('081234567890')` returns `+6281234567890`
3. Webhook populates cache: New contact created via webhook has kapso_name and phone_normalized populated
4. Existing contacts backfilled: `SELECT count(*) FROM contacts WHERE phone_normalized IS NULL` returns 0
</verification>

<success_criteria>
- [x] contacts table has kapso_name, kapso_profile_pic, kapso_is_online, kapso_last_seen, cache_updated_at columns
- [x] contacts table has phone_normalized column with index
- [x] libphonenumber-js installed
- [x] normalizePhone utility handles Indonesian formats (0812, +62, 62xxx)
- [x] Webhook uses normalizePhone for contact matching
- [x] Webhook caches kapso_name on contact create/update
- [x] cache_updated_at is set when Kapso data is refreshed
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-inbox-overhaul/01-02-SUMMARY.md`
</output>
