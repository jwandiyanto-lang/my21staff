---
phase: 01-database-inbox-overhaul
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/migrations/36_ari_rls_policies.sql
  - supabase/migrations/37_ari_realtime.sql
autonomous: true

must_haves:
  truths:
    - "Users can only access ARI data in workspaces they belong to"
    - "RLS policies use optimized SELECT wrapper pattern"
    - "All ARI tables have SELECT, INSERT, UPDATE policies"
    - "Real-time subscriptions work for ARI tables"
  artifacts:
    - path: "supabase/migrations/36_ari_rls_policies.sql"
      provides: "RLS policies for all 7 ARI tables"
      min_lines: 100
    - path: "supabase/migrations/37_ari_realtime.sql"
      provides: "Realtime publication for ARI tables"
      min_lines: 10
  key_links:
    - from: "RLS policies"
      to: "workspace_members"
      via: "Membership check"
      pattern: "SELECT workspace_id FROM workspace_members WHERE user_id"
---

<objective>
Add Row Level Security policies and real-time publication for ARI tables.

Purpose: Ensure multi-tenant isolation (users only see their workspace's data) and enable real-time subscriptions for live updates.

Output: Two migrations - one for RLS policies, one for realtime publication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-database-inbox-overhaul/01-CONTEXT.md
@.planning/phases/01-database-inbox-overhaul/01-RESEARCH.md
@supabase/schema.sql
@.planning/phases/01-database-inbox-overhaul/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS policies for ARI tables</name>
  <files>supabase/migrations/36_ari_rls_policies.sql</files>
  <action>
Create RLS policies for all 7 ARI tables using the optimized SELECT wrapper pattern from research:

```sql
-- =============================================
-- RLS Policies for ARI Tables
-- Uses (SELECT auth.uid()) wrapper for 100x better performance
-- =============================================

-- Enable RLS on all ARI tables
ALTER TABLE ari_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE ari_destinations ENABLE ROW LEVEL SECURITY;
ALTER TABLE ari_conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE ari_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE ari_payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE ari_appointments ENABLE ROW LEVEL SECURITY;
ALTER TABLE ari_ai_comparison ENABLE ROW LEVEL SECURITY;

-- Helper: Check workspace membership (used by all policies)
-- Users can access workspaces they own OR are members of
-- Using (SELECT ...) wrapper for performance optimization

-- =============================================
-- ari_config policies
-- =============================================
CREATE POLICY "Users can view ari_config in their workspaces" ON ari_config
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_config in their workspaces" ON ari_config
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can update ari_config in their workspaces" ON ari_config
  FOR UPDATE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

-- =============================================
-- ari_destinations policies
-- =============================================
CREATE POLICY "Users can view ari_destinations in their workspaces" ON ari_destinations
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_destinations in their workspaces" ON ari_destinations
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can update ari_destinations in their workspaces" ON ari_destinations
  FOR UPDATE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can delete ari_destinations in their workspaces" ON ari_destinations
  FOR DELETE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

-- =============================================
-- ari_conversations policies
-- =============================================
CREATE POLICY "Users can view ari_conversations in their workspaces" ON ari_conversations
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_conversations in their workspaces" ON ari_conversations
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can update ari_conversations in their workspaces" ON ari_conversations
  FOR UPDATE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

-- =============================================
-- ari_messages policies
-- =============================================
CREATE POLICY "Users can view ari_messages in their workspaces" ON ari_messages
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_messages in their workspaces" ON ari_messages
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

-- =============================================
-- ari_payments policies
-- =============================================
CREATE POLICY "Users can view ari_payments in their workspaces" ON ari_payments
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_payments in their workspaces" ON ari_payments
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can update ari_payments in their workspaces" ON ari_payments
  FOR UPDATE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

-- =============================================
-- ari_appointments policies
-- =============================================
CREATE POLICY "Users can view ari_appointments in their workspaces" ON ari_appointments
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_appointments in their workspaces" ON ari_appointments
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can update ari_appointments in their workspaces" ON ari_appointments
  FOR UPDATE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

-- =============================================
-- ari_ai_comparison policies
-- =============================================
CREATE POLICY "Users can view ari_ai_comparison in their workspaces" ON ari_ai_comparison
  FOR SELECT USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can insert ari_ai_comparison in their workspaces" ON ari_ai_comparison
  FOR INSERT WITH CHECK (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );

CREATE POLICY "Users can update ari_ai_comparison in their workspaces" ON ari_ai_comparison
  FOR UPDATE USING (
    workspace_id IN (
      SELECT id FROM workspaces WHERE owner_id = (SELECT auth.uid())
      UNION
      SELECT workspace_id FROM workspace_members WHERE user_id = (SELECT auth.uid())
    )
  );
```
  </action>
  <verify>
```sql
-- Check RLS is enabled on all ARI tables
SELECT tablename, rowsecurity FROM pg_tables
WHERE schemaname = 'public' AND tablename LIKE 'ari_%';
-- All should show rowsecurity = true

-- Check policies exist
SELECT tablename, policyname FROM pg_policies
WHERE schemaname = 'public' AND tablename LIKE 'ari_%';
-- Should have 3-4 policies per table
```
  </verify>
  <done>RLS enabled and policies created for all 7 ARI tables</done>
</task>

<task type="auto">
  <name>Task 2: Enable real-time for ARI tables</name>
  <files>supabase/migrations/37_ari_realtime.sql</files>
  <action>
Add ARI tables to the supabase_realtime publication for real-time subscriptions:

```sql
-- Enable real-time for ARI tables
-- These tables will support postgres_changes subscriptions

-- Add tables to existing publication
-- Note: If publication doesn't exist, it was created in migration 15
ALTER PUBLICATION supabase_realtime ADD TABLE ari_config;
ALTER PUBLICATION supabase_realtime ADD TABLE ari_destinations;
ALTER PUBLICATION supabase_realtime ADD TABLE ari_conversations;
ALTER PUBLICATION supabase_realtime ADD TABLE ari_messages;
ALTER PUBLICATION supabase_realtime ADD TABLE ari_payments;
ALTER PUBLICATION supabase_realtime ADD TABLE ari_appointments;
ALTER PUBLICATION supabase_realtime ADD TABLE ari_ai_comparison;

-- Note: Real-time subscriptions require:
-- 1. RLS to be enabled (done in previous migration)
-- 2. User must have SELECT permission on the table (handled by RLS policies)
-- 3. Client subscribes with filter (e.g., workspace_id=eq.xxx)
```
  </action>
  <verify>
```sql
-- Check tables are in publication
SELECT tablename FROM pg_publication_tables
WHERE pubname = 'supabase_realtime' AND tablename LIKE 'ari_%';
-- Should return all 7 ARI tables
```
  </verify>
  <done>ARI tables added to supabase_realtime publication</done>
</task>

</tasks>

<verification>
1. RLS enabled: `SELECT tablename, rowsecurity FROM pg_tables WHERE tablename LIKE 'ari_%'` - all show true
2. Policies created: `SELECT count(*) FROM pg_policies WHERE tablename LIKE 'ari_%'` - returns 20+ policies
3. Realtime enabled: `SELECT count(*) FROM pg_publication_tables WHERE pubname = 'supabase_realtime' AND tablename LIKE 'ari_%'` returns 7
4. Isolation works: User A cannot see User B's workspace data
</verification>

<success_criteria>
- [x] RLS enabled on all 7 ARI tables
- [x] SELECT policies on all 7 tables
- [x] INSERT policies on all 7 tables
- [x] UPDATE policies on all 7 tables
- [x] DELETE policy on ari_destinations (only table that needs delete)
- [x] Policies use (SELECT auth.uid()) wrapper for performance
- [x] All 7 tables added to supabase_realtime publication
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-inbox-overhaul/01-03-SUMMARY.md`
</output>
