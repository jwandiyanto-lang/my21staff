---
phase: 2.1-production-bug-remediation
plan: 05
type: execute
wave: 2
depends_on: ["2.1-02"]
files_modified:
  - convex/mutations.ts
  - src/components/database/merge-contacts-dialog.tsx
  - src/components/inbox/lead-score-display.tsx
autonomous: true

must_haves:
  truths:
    - "User can merge duplicate contacts successfully"
    - "Merge operation combines contact data correctly"
    - "Lead score displays real calculated values (not dummy data)"
    - "Lead score calculation works consistently"
  artifacts:
    - path: "convex/mutations.ts"
      provides: "Merge contacts mutation"
      exports: ["mergeContacts"]
    - path: "src/components/database/merge-contacts-dialog.tsx"
      provides: "Merge contacts UI with error handling"
      min_lines: 80
    - path: "src/components/inbox/lead-score-display.tsx"
      provides: "Lead score display using real calculated data"
      min_lines: 40
  key_links:
    - from: "src/components/database/merge-contacts-dialog.tsx"
      to: "convex/mutations.mergeContacts"
      via: "useMutation hook"
      pattern: "useMutation\\(api\\.mutations\\.mergeContacts"
    - from: "src/components/inbox/lead-score-display.tsx"
      to: "contact.lead_score"
      via: "read from contact data"
      pattern: "contact\\.lead_score"
---

<objective>
Fix merge contacts feature and remove dummy data from lead score display.

Purpose: Merge contacts feature fails with error (Issue #5), blocking duplicate contact cleanup workflow. Additionally, lead score Chat component displays hardcoded dummy values instead of real calculated scores (Issue #6), while form score works correctly. These issues affect contact data quality and lead scoring accuracy.

Output: Working merge contacts feature and accurate lead score display across all components.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# This plan depends on Plan 02 (database mutations)
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/2.1-production-bug-remediation/2.1-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Implement or fix merge contacts mutation</name>
  <files>
    convex/mutations.ts
    src/components/database/merge-contacts-dialog.tsx
  </files>
  <action>
**Root cause investigation:**

Merge contacts fails with error. This suggests:
1. **Mutation missing** - mergeContacts not implemented in Convex
2. **Logic error** - merge operation has bugs (data conflicts, cascade failures)
3. **Validation failure** - contacts can't be merged (schema constraints)

**Implementation approach:**

Merge contacts is a complex operation that must:
1. Select primary contact (keep) and secondary contact (merge into primary)
2. Combine data from both contacts (prefer non-null, user selects conflicts)
3. Move conversations/messages/notes from secondary to primary
4. Delete secondary contact
5. Update all references to point to primary

**Implementation steps:**

1. **Find merge contacts component**:
```bash
find src/components -name "*merge*"
grep -r "merge.*contact" src/components/database/
```

2. **Create mergeContacts mutation** (convex/mutations.ts):
```typescript
export const mergeContacts = mutation({
  args: {
    primary_id: v.id("contacts"),      // Keep this contact
    secondary_id: v.id("contacts"),    // Merge this into primary, then delete
    workspace_id: v.id("workspaces"),
    merge_data: v.object({
      name: v.optional(v.string()),
      email: v.optional(v.string()),
      phone: v.optional(v.string()),
      tags: v.optional(v.array(v.string())),
      lead_status: v.optional(v.string()),
      // User-selected values for conflicting fields
    }),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Get both contacts
    const primary = await ctx.db.get(args.primary_id);
    const secondary = await ctx.db.get(args.secondary_id);

    if (!primary || !secondary) {
      throw new Error("Contact not found");
    }

    // Verify both belong to same workspace
    if (primary.workspace_id !== args.workspace_id || secondary.workspace_id !== args.workspace_id) {
      throw new Error("Contacts must belong to the same workspace");
    }

    // Update primary contact with merged data
    await ctx.db.patch(args.primary_id, {
      name: args.merge_data.name || primary.name,
      email: args.merge_data.email || primary.email,
      phone: args.merge_data.phone || primary.phone,
      tags: args.merge_data.tags || primary.tags,
      lead_status: args.merge_data.lead_status || primary.lead_status,
      updated_at: Date.now(),
    });

    // Move conversations from secondary to primary
    const secondaryConversations = await ctx.db
      .query("conversations")
      .withIndex("by_contact", (q) => q.eq("contact_id", args.secondary_id))
      .collect();

    for (const conv of secondaryConversations) {
      await ctx.db.patch(conv._id, {
        contact_id: args.primary_id,
      });
    }

    // Move notes from secondary to primary
    const secondaryNotes = await ctx.db
      .query("contactNotes")
      .withIndex("by_contact", (q) => q.eq("contact_id", args.secondary_id))
      .collect();

    for (const note of secondaryNotes) {
      await ctx.db.patch(note._id, {
        contact_id: args.primary_id,
      });
    }

    // Delete secondary contact
    await ctx.db.delete(args.secondary_id);

    return await ctx.db.get(args.primary_id);
  },
});
```

3. **Update merge contacts UI**:
   - Add conflict resolution UI (choose which values to keep)
   - Show preview of merged contact
   - Handle API errors gracefully
   - Confirm before merging (destructive operation)

```typescript
// In merge-contacts-dialog.tsx
function MergeContactsDialog({ contactA, contactB, onClose }) {
  const [mergeData, setMergeData] = useState({
    name: contactA.name || contactB.name,
    email: contactA.email || contactB.email,
    phone: contactA.phone || contactB.phone,
    // User selects which values to keep
  });

  const mergeMutation = useMutation(api.mutations.mergeContacts);

  async function handleMerge() {
    try {
      await mergeMutation({
        primary_id: contactA._id,
        secondary_id: contactB._id,
        workspace_id: workspaceId,
        merge_data: mergeData,
      });
      onClose();
    } catch (error) {
      alert(`Merge failed: ${error.message}`);
    }
  }

  // Render conflict resolution UI...
}
```

4. **Test merge scenarios**:
   - Merge contacts with no conflicts (all same data)
   - Merge contacts with conflicts (different names, emails)
   - Verify conversations moved correctly
   - Verify notes moved correctly
   - Verify secondary contact deleted

**Testing approach:**
1. Create two duplicate contacts manually
2. Open merge dialog
3. Select values to keep
4. Confirm merge
5. Verify primary contact has combined data
6. Verify secondary contact deleted
  </action>
  <verify>
```bash
# Manual verification required
echo "Test merge contacts:"
echo ""
echo "Setup:"
echo "1. Create two test contacts in Database:"
echo "   Contact A: Name='John Doe', Email='john@test.com', Phone='+1234'"
echo "   Contact B: Name='John D.', Email='johndoe@test.com', Phone='+1234'"
echo ""
echo "Merge:"
echo "2. Select both contacts"
echo "3. Click 'Merge Contacts' button"
echo "4. In merge dialog, choose:"
echo "   - Name: 'John Doe' (from A)"
echo "   - Email: 'johndoe@test.com' (from B)"
echo "   - Phone: '+1234' (same, no conflict)"
echo "5. Click 'Confirm Merge'"
echo ""
echo "Verify:"
echo "6. Merge succeeds without errors"
echo "7. Contact list shows only one 'John Doe' with email 'johndoe@test.com'"
echo "8. Contact B no longer exists"
echo "9. Conversations and notes from B are now under A"
echo ""
echo "Expected: Merge succeeds, data combined correctly"
echo "Bug pattern: Merge fails with error"
```
  </verify>
  <done>
- mergeContacts mutation exists in convex/mutations.ts
- Merge operation combines contact data correctly
- Conversations and notes moved from secondary to primary
- Secondary contact deleted after successful merge
- Merge contacts UI shows conflict resolution
- Merge operation succeeds without errors
- Issue #5 from verification report resolved
  </done>
</task>

<task type="auto">
  <name>Remove dummy data from lead score Chat component</name>
  <files>
    src/components/inbox/lead-score-display.tsx
    src/components/inbox/conversation-details.tsx
  </files>
  <action>
**Root cause investigation:**

Lead score Chat component shows dummy data while form score works correctly (Issue #6). This suggests:
1. **Hardcoded values** - Component returns static dummy data instead of reading contact.lead_score
2. **Wrong data source** - Reading from wrong field or using fallback
3. **Debug code** - Temporary dummy data left in production

**Fix steps:**

1. **Find lead score Chat component**:
```bash
find src/components/inbox -name "*lead*" -o -name "*score*"
grep -r "dummy\|fake\|hardcoded" src/components/inbox/
grep -r "lead_score" src/components/inbox/
```

2. **Identify dummy data pattern**:
```typescript
// BAD: Hardcoded dummy data
const leadScore = {
  total: 75,  // Hardcoded!
  breakdown: {
    engagement: 25,
    intent: 30,
    fit: 20,
  }
};

// GOOD: Read from contact data
const leadScore = contact.lead_score || {
  total: 0,
  breakdown: { engagement: 0, intent: 0, fit: 0 }
};
```

3. **Remove dummy data and use real contact.lead_score**:
   - Find where dummy data is defined
   - Replace with `contact.lead_score` from props or context
   - Ensure fallback for contacts without scores (return 0, not dummy values)

4. **Verify form score component for correct pattern**:
   - Check how form score reads lead_score
   - Apply same pattern to Chat component
   - Ensure consistency across all score displays

5. **Test with real contacts**:
   - Contact with calculated score - should show real value
   - New contact without score - should show 0 or "Not calculated"
   - Score should match between Chat and form displays

**Testing approach:**
1. Find contact with lead_score in database
2. View contact in Inbox (Chat component)
3. View contact in form/details
4. Verify both show same score (not dummy values)
  </action>
  <verify>
```bash
# Manual verification required
echo "Test lead score display:"
echo ""
echo "1. Visit https://www.my21staff.com/eagle-overseas/inbox"
echo "2. Open a conversation with a contact that has a lead score"
echo "3. Check lead score in Chat component (right sidebar or header)"
echo "4. Note the displayed score value"
echo "5. Open same contact in Database or details view"
echo "6. Check lead score in form component"
echo "7. Verify both show SAME score (not different values)"
echo ""
echo "Expected: Chat and form show same real calculated score"
echo "Bug pattern: Chat shows dummy values (e.g., always 75)"
```
  </verify>
  <done>
- Lead score Chat component reads from contact.lead_score (not dummy data)
- Chat score matches form score for same contact
- No hardcoded dummy values in production code
- Lead score displays consistently across all components
- Issue #6 from verification report resolved
  </done>
</task>

</tasks>

<verification>
**Merge contacts verification:**
- Create duplicate contacts
- Merge with conflict resolution
- Verify data combined correctly
- Verify secondary deleted

**Lead score verification:**
- View contact in Inbox Chat component
- View same contact in Database form
- Verify scores match (not dummy values)

**Success indicators:**
- Merge contacts works without errors
- Lead score shows real calculated values
- No dummy data in production
- Issues #5 and #6 resolved
</verification>

<success_criteria>
1. Merge contacts operation succeeds and combines data correctly
2. Conversations and notes moved from secondary to primary contact
3. Secondary contact deleted after merge
4. Lead score Chat component shows real calculated values (not dummy data)
5. Lead score consistent across Chat and form displays
6. No hardcoded dummy values in lead score components
7. Verification confirms Issues #5 and #6 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-production-bug-remediation/2.1-05-SUMMARY.md`
</output>
