---
phase: 2.1-production-bug-remediation
plan: 07
type: execute
wave: 3
depends_on: ["2.1-02"]
files_modified:
  - src/components/database/contact-table.tsx
  - src/components/database/add-contact-dialog.tsx
  - src/components/database/contact-table-columns.tsx
  - src/app/api/contacts/route.ts
  - convex/mutations.ts
autonomous: true

must_haves:
  truths:
    - "Database table displays tags column for all contacts"
    - "User can add new contact via Add Contact button/modal"
    - "New contacts save to database successfully"
    - "Auto-assigned 'google-form' tag issue resolved"
    - "Status changes apply globally in real-time"
  artifacts:
    - path: "src/components/database/contact-table.tsx"
      provides: "Contact table with tags column visible"
      min_lines: 150
    - path: "src/components/database/add-contact-dialog.tsx"
      provides: "Add contact modal with form"
      min_lines: 100
    - path: "convex/mutations.ts"
      provides: "Create contact mutation"
      exports: ["createContact"]
  key_links:
    - from: "src/components/database/contact-table.tsx"
      to: "tags column definition"
      via: "table column config"
      pattern: "tags.*column"
    - from: "src/components/database/add-contact-dialog.tsx"
      to: "convex/mutations.createContact"
      via: "useMutation hook"
      pattern: "useMutation\\(api\\.mutations\\.createContact"
---

<objective>
Add missing database features (tags column, add contact button) and fix remaining medium priority issues.

Purpose: Complete the Database page by adding 2 missing features: tags column not displayed in table (Issue #22) and no "Add Contact" button/modal (Issue #23). Also fix auto-assigned "google-form" tag bug (Issue #17) and status changes not auto-applying globally (Issue #19). These complete the database management workflow.

Output: Complete Database page with tags column, add contact functionality, and fixed tag/status behavior.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# This plan depends on Plan 02 (database mutations)
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/2.1-production-bug-remediation/2.1-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Add tags column to Database table and fix auto-tag issue</name>
  <files>
    src/components/database/contact-table.tsx
    src/components/database/contact-table-columns.tsx
    convex/contacts.ts
  </files>
  <action>
**Add tags column and fix auto-tag bug:**

**Issue #22: Tags column missing from table**
- Tags exist in data model but not displayed in UI table
- Need to add tags column definition

**Issue #17: Tags auto-assigned to "google-form"**
- New contacts automatically tagged with "google-form"
- Should default to empty tags array or user-defined tags

**Implementation steps:**

1. **Find contact table component**:
```bash
find src/components/database -name "*table*"
grep -r "contact.*table\|DataTable" src/components/database/
```

2. **Add tags column to table definition**:
```typescript
// src/components/database/contact-table-columns.tsx
import { ColumnDef } from '@tanstack/react-table';

export const columns: ColumnDef<Contact>[] = [
  // Existing columns...
  {
    accessorKey: "name",
    header: "Name",
  },
  {
    accessorKey: "phone",
    header: "Phone",
  },
  {
    accessorKey: "email",
    header: "Email",
  },
  {
    accessorKey: "lead_status",
    header: "Status",
  },

  // ADD tags column
  {
    accessorKey: "tags",
    header: "Tags",
    cell: ({ row }) => {
      const tags = row.original.tags || [];
      return (
        <div className="flex gap-1">
          {tags.map(tag => (
            <span key={tag} className="tag-badge">
              {tag}
            </span>
          ))}
        </div>
      );
    },
  },

  // Actions column...
];
```

3. **Fix auto-assigned "google-form" tag** (Issue #17):
   - Find where new contacts are created
   - Check if tags default to ["google-form"]
   - Change default to empty array []

```bash
# Find where tags are set to "google-form"
grep -r "google-form" src/components/ convex/
```

```typescript
// BEFORE (wrong default)
const newContact = {
  name,
  phone,
  email,
  tags: ["google-form"],  // Auto-assigned!
  // ...
};

// AFTER (correct default)
const newContact = {
  name,
  phone,
  email,
  tags: [],  // Empty by default
  // ...
};
```

4. **Update table to show tags column**:
   - Ensure table component uses updated column definitions
   - Verify tags render as badges/pills
   - Handle empty tags gracefully (show "-" or empty state)

5. **Test tags display**:
   - Contacts with tags show badges in table
   - Contacts without tags show empty state
   - New contacts don't auto-get "google-form" tag

**Testing approach:**
1. View Database table - tags column visible
2. Contact with tags shows badges
3. Contact without tags shows empty
4. Create new contact - tags empty (not "google-form")
  </action>
  <verify>
```bash
# Check for "google-form" auto-assignment
grep -r "google-form" src/components/ convex/ | grep -E "(tags|default)"

# Manual verification
echo ""
echo "Test tags column:"
echo "1. Visit https://www.my21staff.com/eagle-overseas/database"
echo "2. Verify table has 'Tags' column header"
echo "3. Contacts with tags show badge pills"
echo "4. Contacts without tags show empty cell (not 'google-form')"
echo "5. Create new contact - tags should be empty by default"
```
  </verify>
  <done>
- Database table displays tags column
- Tags render as badge pills in table
- Empty tags show gracefully (no error)
- New contacts default to empty tags (not "google-form")
- Issue #17 from verification report resolved (auto-tag bug fixed)
- Issue #22 from verification report resolved (tags column visible)
  </done>
</task>

<task type="auto">
  <name>Add "Add Contact" button and create contact modal</name>
  <files>
    src/components/database/add-contact-dialog.tsx
    src/components/database/database-page.tsx
    convex/mutations.ts
    src/app/api/contacts/route.ts
  </files>
  <action>
**Implement Add Contact feature:**

**Issue #23: No "Add Contact" button/modal**
- Cannot create new contacts via UI
- Workaround requires API or import
- Need button + modal + create mutation

**Implementation steps:**

1. **Add createContact mutation to convex/mutations.ts**:
```typescript
export const createContact = mutation({
  args: {
    workspace_id: v.id("workspaces"),
    name: v.string(),
    phone: v.optional(v.string()),
    email: v.optional(v.string()),
    lead_status: v.optional(v.string()),
    tags: v.optional(v.array(v.string())),
    source: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    await requireWorkspaceMembership(ctx, args.workspace_id);

    // Validate required fields
    if (!args.name.trim()) {
      throw new Error("Name is required");
    }

    // Check for duplicate phone (if provided)
    if (args.phone) {
      const existing = await ctx.db
        .query("contacts")
        .withIndex("by_workspace_phone", (q) =>
          q.eq("workspace_id", args.workspace_id).eq("phone", args.phone)
        )
        .first();

      if (existing) {
        throw new Error(`Contact with phone ${args.phone} already exists`);
      }
    }

    const now = Date.now();
    const contactId = await ctx.db.insert("contacts", {
      workspace_id: args.workspace_id,
      name: args.name,
      phone: args.phone || null,
      email: args.email || null,
      lead_status: args.lead_status || "new",
      tags: args.tags || [],  // Empty by default (not "google-form")
      source: args.source || "manual",
      lead_score: 0,
      created_at: now,
      updated_at: now,
    });

    return await ctx.db.get(contactId);
  },
});
```

2. **Create Add Contact dialog component**:
```typescript
// src/components/database/add-contact-dialog.tsx
import { useState } from 'react';
import { useMutation } from 'convex/react';
import { api } from 'convex/_generated/api';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

interface AddContactDialogProps {
  open: boolean;
  onClose: () => void;
  workspaceId: string;
}

export function AddContactDialog({ open, onClose, workspaceId }: AddContactDialogProps) {
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    email: '',
    lead_status: 'new',
    tags: [] as string[],
  });

  const createContact = useMutation(api.mutations.createContact);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    try {
      await createContact({
        workspace_id: workspaceId,
        name: formData.name,
        phone: formData.phone || undefined,
        email: formData.email || undefined,
        lead_status: formData.lead_status,
        tags: formData.tags,
      });

      // Reset form and close
      setFormData({ name: '', phone: '', email: '', lead_status: 'new', tags: [] });
      onClose();
    } catch (error) {
      alert(`Error creating contact: ${error.message}`);
    }
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Add New Contact</DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label>Name *</label>
            <Input
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              required
            />
          </div>

          <div>
            <label>Phone</label>
            <Input
              value={formData.phone}
              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
              placeholder="+62..."
            />
          </div>

          <div>
            <label>Email</label>
            <Input
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
            />
          </div>

          <div>
            <label>Status</label>
            <select
              value={formData.lead_status}
              onChange={(e) => setFormData({ ...formData, lead_status: e.target.value })}
            >
              <option value="new">New</option>
              <option value="active">Active</option>
              <option value="qualified">Qualified</option>
              <option value="archived">Archived</option>
            </select>
          </div>

          <div className="flex gap-2">
            <Button type="submit">Add Contact</Button>
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

3. **Add "Add Contact" button to Database page**:
```typescript
// src/components/database/database-page.tsx or similar
import { AddContactDialog } from './add-contact-dialog';

export function DatabasePage() {
  const [showAddDialog, setShowAddDialog] = useState(false);

  return (
    <div>
      <div className="page-header">
        <h1>Database</h1>
        <Button onClick={() => setShowAddDialog(true)}>
          Add Contact
        </Button>
      </div>

      <ContactTable />

      <AddContactDialog
        open={showAddDialog}
        onClose={() => setShowAddDialog(false)}
        workspaceId={workspace.id}
      />
    </div>
  );
}
```

4. **Fix status changes auto-apply globally** (Issue #19):
   - Status customization should sync in real-time
   - Use Convex reactivity or add refresh button
   - Ensure status changes visible immediately

5. **Test Add Contact flow**:
   - Click "Add Contact" button
   - Fill form with required fields
   - Submit and verify contact appears in table
   - Verify validation (duplicate phone, required name)

**Testing approach:**
1. Database page has "Add Contact" button
2. Click button opens modal
3. Fill form and submit
4. New contact appears in table immediately
5. Verify no "google-form" tag auto-assigned
  </action>
  <verify>
```bash
# Manual verification
echo "Test Add Contact feature:"
echo ""
echo "1. Visit https://www.my21staff.com/eagle-overseas/database"
echo "2. Verify 'Add Contact' button visible in header"
echo "3. Click 'Add Contact' - modal opens"
echo "4. Fill form:"
echo "   - Name: 'Test Contact'"
echo "   - Phone: '+62123456789'"
echo "   - Email: 'test@example.com'"
echo "   - Status: 'new'"
echo "5. Click 'Add Contact' button in modal"
echo "6. Verify contact appears in table immediately"
echo "7. Verify contact has empty tags (not 'google-form')"
echo "8. Verify duplicate phone validation works"
echo ""
echo "Expected: Add Contact feature works end-to-end"
```
  </verify>
  <done>
- "Add Contact" button visible on Database page
- Clicking button opens Add Contact modal
- Modal form accepts name, phone, email, status, tags
- Form validation works (required name, duplicate phone check)
- New contact saves to database successfully
- New contact appears in table immediately
- New contact has empty tags by default (not "google-form")
- Status changes apply globally without manual refresh
- Issue #19 from verification report resolved (auto-apply status)
- Issue #23 from verification report resolved (Add Contact feature exists)
  </done>
</task>

</tasks>

<verification>
**Tags column verification:**
- Database table displays tags column
- Tags render as badges
- Empty tags show gracefully
- New contacts don't auto-get "google-form" tag

**Add Contact verification:**
- "Add Contact" button visible
- Modal opens and accepts input
- New contact saves and appears in table
- Validation works correctly

**Success indicators:**
- Tags column visible and functional
- Add Contact feature complete
- Auto-tag bug fixed
- Status changes auto-apply
- Issues #17, #19, #22, #23 resolved
</verification>

<success_criteria>
1. Database table displays tags column for all contacts
2. Tags render as badge pills (or empty state if no tags)
3. New contacts default to empty tags (not "google-form" auto-assigned)
4. "Add Contact" button visible on Database page
5. Add Contact modal allows creating new contacts via UI
6. New contacts save to database and appear in table immediately
7. Form validation works (required name, duplicate phone check)
8. Status changes apply globally in real-time (no manual refresh)
9. Verification confirms Issues #17, #19, #22, #23 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-production-bug-remediation/2.1-07-SUMMARY.md`
</output>
