---
phase: 2.1-production-bug-remediation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/workspaces/[id]/ari-config/route.ts
  - convex/ari.ts
  - convex/lib/auth.ts
autonomous: true

must_haves:
  truths:
    - "ARI Config API returns 200 with valid configuration data"
    - "Your Intern Persona tab loads without errors"
    - "Your Intern settings can be saved successfully"
    - "Global AI toggle works in Your Intern interface"
  artifacts:
    - path: "src/app/api/workspaces/[id]/ari-config/route.ts"
      provides: "GET/PUT/PATCH endpoints for ARI configuration"
      exports: ["GET", "PUT", "PATCH"]
    - path: "convex/ari.ts"
      provides: "Convex queries and mutations for ARI config"
      exports: ["getAriConfig", "upsertAriConfig", "toggleAiEnabled"]
  key_links:
    - from: "src/app/api/workspaces/[id]/ari-config/route.ts"
      to: "convex/ari.ts"
      via: "fetchQuery and fetchMutation calls"
      pattern: "fetchQuery\\(api\\.ari\\."
    - from: "src/app/(dashboard)/[workspace]/your-intern"
      to: "/api/workspaces/[id]/ari-config"
      via: "fetch calls from Your Intern tabs"
      pattern: "fetch.*ari-config"
---

<objective>
Fix ARI Config API returning 500 error and restore complete Your Intern functionality.

Purpose: ARI Config API is the root cause blocking all Your Intern features. This API returns 500 in production, preventing persona settings from loading and save operations from succeeding. Fixing this unblocks Issues #2 and #7 from verification report.

Output: Working ARI Config API with all Your Intern tabs functional (Persona, Flow, Database, Scoring, Slots).
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# ARI Config API implementation
@/home/jfransisco/Desktop/21/my21staff/src/app/api/workspaces/[id]/ari-config/route.ts
@/home/jfransisco/Desktop/21/my21staff/convex/ari.ts
</context>

<tasks>

<task type="auto">
  <name>Diagnose and fix ARI Config API 500 error</name>
  <files>
    src/app/api/workspaces/[id]/ari-config/route.ts
    convex/ari.ts
    convex/lib/auth.ts
  </files>
  <action>
**Root cause investigation:**

The ARI Config API returns 500 in production. Common causes for this pattern:
1. **Auth failure** - `requireWorkspaceMembership` may be throwing unhandled errors
2. **Type mismatch** - `workspace._id` conversion to Convex ID type may fail
3. **Missing workspace** - `getBySlug` may return null for production workspace slug
4. **Convex query failure** - Database index or query structure issue

**Fix steps:**

1. **Add comprehensive error logging** to pinpoint failure point:
   - Wrap each operation in try/catch with specific error messages
   - Log workspace lookup result, auth result, config query result
   - Return detailed error responses (visible in production console)

2. **Fix type safety issues**:
   - Ensure `workspace._id` is properly typed as `Id<"workspaces">`
   - Verify `getBySlug` returns workspace with correct ID type
   - Check `upsertAriConfig` accepts correct workspace_id type (string vs Id)

3. **Add null checks and fallbacks**:
   - Check if `requireWorkspaceMembership` result is error response
   - Validate workspace exists before querying config
   - Handle missing config gracefully (return defaults)

4. **Fix Convex mutations** (if needed):
   - Verify `upsertAriConfig` mutation accepts `workspace_id` as string (not Id)
   - Check database schema matches mutation args
   - Ensure `toggleAiEnabled` mutation works correctly

**Expected fix pattern:**

Most likely the issue is workspace ID type mismatch. The API route gets slug (string) but Convex expects Id type. Solution:
- GET/PUT should use workspace slug, not Convex _id
- Convex mutations should accept workspace slug (string), query workspace internally
- OR: Fix workspace lookup to properly convert slug to Convex Id

**Testing approach:**
1. Test GET /api/workspaces/eagle-overseas/ari-config (should return config or defaults)
2. Test PUT with valid config data (should save successfully)
3. Test PATCH to toggle AI enabled (should update config)
  </action>
  <verify>
```bash
# Test API endpoints work without 500 errors
# These commands simulate what Your Intern interface does

# 1. Test GET (fetch config)
curl -X GET https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config \
  -H "Cookie: $(grep clerk /tmp/cookies.txt)" \
  -v | grep -E "(200|config)"

# 2. Test PUT (save config)
curl -X PUT https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config \
  -H "Content-Type: application/json" \
  -H "Cookie: $(grep clerk /tmp/cookies.txt)" \
  -d '{"bot_name":"ARI","tone_description":"Professional and helpful"}' \
  -v | grep -E "(200|config)"

# 3. Test PATCH (toggle AI)
curl -X PATCH https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config \
  -H "Content-Type: application/json" \
  -H "Cookie: $(grep clerk /tmp/cookies.txt)" \
  -d '{"enabled":true}' \
  -v | grep -E "(200|config)"

# All three should return 200 with config object (not 500)
```
  </verify>
  <done>
- ARI Config API GET returns 200 with configuration data (not 500)
- ARI Config API PUT saves configuration successfully (not 500)
- ARI Config API PATCH toggles AI enabled successfully (not 500)
- No unhandled errors in production logs
- Your Intern Persona tab loads without "Failed to load persona settings" error
  </done>
</task>

<task type="auto">
  <name>Verify Your Intern tabs load and function correctly</name>
  <files>
    # No file changes - verification only
  </files>
  <action>
**Verification protocol:**

After fixing ARI Config API, verify all Your Intern functionality works in production:

1. **Test Persona tab**:
   - Visit https://www.my21staff.com/eagle-overseas/your-intern
   - Confirm tab loads without errors
   - Check that existing config displays correctly
   - Test saving changes (bot name, tone description, greeting template)

2. **Test Flow tab**:
   - Switch to Flow tab
   - Confirm flow stages load without errors
   - Test adding/editing flow stages

3. **Test Database tab**:
   - Switch to Database tab
   - Confirm knowledge base entries load
   - Test adding/editing knowledge base items

4. **Test Scoring tab**:
   - Switch to Scoring tab
   - Confirm scoring config loads
   - Test updating scoring rules

5. **Test Slots tab**:
   - Switch to Slots tab (5th tab added in Phase 1)
   - Confirm consultant slots load
   - Test adding/editing slots

6. **Test Global AI Toggle**:
   - Use toggle at top of Your Intern interface
   - Confirm toggle state persists across page refresh
   - Verify PATCH API call succeeds

**Success criteria:**
- All 5 tabs render without console errors
- Configuration data loads successfully
- Save operations succeed (no API errors)
- Global AI toggle works
  </action>
  <verify>
```bash
# Manual verification steps (human-verified)
# Visit production site and test each tab

# Automated checks:
# Check console logs for API errors
echo "Check browser console at https://www.my21staff.com/eagle-overseas/your-intern"
echo "Expected: No 500 errors from ari-config API"
echo "Expected: All 5 tabs render successfully"
echo "Expected: Save operations return 200 status"
```
  </verify>
  <done>
- Your Intern Persona tab loads and displays configuration (Issue #2 resolved)
- Your Intern save operations succeed (Issue #7 resolved)
- All 5 tabs (Persona, Flow, Database, Scoring, Slots) functional
- Global AI toggle works and persists state
- No console errors when using Your Intern interface
  </done>
</task>

</tasks>

<verification>
**API endpoint tests:**
```bash
# Test all ARI Config API endpoints
curl -X GET https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config
curl -X PUT https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config -d '{"bot_name":"ARI"}'
curl -X PATCH https://www.my21staff.com/api/workspaces/eagle-overseas/ari-config -d '{"enabled":true}'
```

**UI verification:**
- Visit https://www.my21staff.com/eagle-overseas/your-intern
- Test all 5 tabs load without errors
- Save configuration changes successfully
- Toggle AI enabled/disabled

**Success indicators:**
- No 500 errors in browser console or server logs
- Your Intern interface fully functional
- Issues #2 and #7 from verification report resolved
</verification>

<success_criteria>
1. ARI Config API returns 200 (not 500) for GET/PUT/PATCH requests
2. Your Intern Persona tab loads without "Failed to load persona settings" error
3. Your Intern save operations succeed (configuration persists)
4. All 5 Your Intern tabs render and function correctly
5. Global AI toggle works and persists state
6. No unhandled errors in production logs
7. Verification confirms Issues #2 and #7 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/2.1-production-bug-remediation/2.1-01-SUMMARY.md`
</output>
