---
phase: 06-ari-flow-integration
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - src/lib/mock-data.ts
  - src/app/(dashboard)/[workspace]/knowledge-base/page.tsx
autonomous: false

must_haves:
  truths:
    - "New demo lead receives AI greeting within 2-5 seconds"
    - "Bot asks Q1 from workspace flow config"
    - "User answer triggers Q2 from flow config"
    - "Lead score updates based on workspace scoring rules"
    - "Bot offers consultation/community based on routing config"
    - "Changing Persona tab → next message uses new personality"
    - "Changing Flow tab → next message follows new questions"
    - "Changing Scoring tab → next analysis uses new thresholds"
  artifacts:
    - path: "src/lib/mock-data.ts"
      provides: "Mock ARI conversation data with flow progression"
      contains: "MOCK_ARI_CONVERSATIONS"
      min_lines: 50
    - path: "src/app/(dashboard)/[workspace]/knowledge-base/page.tsx"
      provides: "Your Intern page with config save feedback"
      contains: "toast"
  key_links:
    - from: "mock conversation"
      to: "AI greeting"
      via: "simulated ARI flow"
      pattern: "greeting.*Ari"
    - from: "workspace config"
      to: "bot behavior"
      via: "getAriContext fetch"
      pattern: "workspace\\.settings"
---

<objective>
End-to-end verification of ARI flow integration in demo mode. Test complete flow from new lead to routing, verify config hot-reload works.

Purpose: Prove ARI flow works end-to-end with workspace configuration before production deployment.
Output: Working demo that shows new lead → greeting → Q1 → answer → Q2 → scoring → routing with live config updates.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-CONTEXT.md

# All prior plans
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-01-SUMMARY.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-02-SUMMARY.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/06-ari-flow-integration/06-03-SUMMARY.md

# Key files
@/home/jfransisco/Desktop/21/my21staff/src/lib/mock-data.ts
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/knowledge-base/page.tsx
@/home/jfransisco/Desktop/21/my21staff/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance mock data with ARI flow progression example</name>
  <files>src/lib/mock-data.ts</files>
  <action>
    Add mock ARI conversation showing complete flow progression for demo mode testing:

    1. Create MOCK_ARI_CONVERSATIONS constant with sample conversation:
       ```typescript
       export const MOCK_ARI_CONVERSATIONS = [
         {
           id: "mock-ari-1",
           contact_id: "mock-contact-new",
           contact_name: "Budi Santoso",
           state: "qualifying", // greeting -> qualifying -> scoring -> routing
           lead_score: 45,
           lead_temperature: "warm",
           next_action: "Ask about passport availability",
           messages: [
             { role: "assistant", content: "Selamat siang! Mau kuliah di luar negeri ya? Boleh tau namanya siapa?", timestamp: Date.now() - 300000 },
             { role: "user", content: "Halo, nama saya Budi", timestamp: Date.now() - 280000 },
             { role: "assistant", content: "Hai kak Budi! Negara tujuannya kemana nih?", timestamp: Date.now() - 260000 },
             { role: "user", content: "Australia kak", timestamp: Date.now() - 240000 },
             { role: "assistant", content: "Oh iya kak, paspor nya udah punya belum?", timestamp: Date.now() - 220000 },
           ],
           created_at: Date.now() - 300000,
           updated_at: Date.now() - 220000,
         }
       ];
       ```
    2. Add helper function getMockAriConversation(contactId: string) to retrieve mock conversation
    3. Export for use in demo mode testing

    Pattern: Mock data shows realistic flow progression for manual testing.
  </action>
  <verify>
    ```bash
    # Check mock ARI conversation exists
    grep "MOCK_ARI_CONVERSATIONS" src/lib/mock-data.ts
    grep "getMockAriConversation" src/lib/mock-data.ts
    ```
  </verify>
  <done>Mock data includes complete ARI conversation example with greeting -> qualifying -> scoring flow</done>
</task>

<task type="auto">
  <name>Task 2: Add config save feedback to Your Intern page</name>
  <files>src/app/(dashboard)/[workspace]/knowledge-base/page.tsx</files>
  <action>
    Enhance Your Intern page to show visual feedback when config changes are saved:

    1. Check if page already has toast notifications (from Phase 3)
    2. If not, add toast import from sonner:
       ```typescript
       import { toast } from "sonner";
       ```
    3. Each tab component (PersonaTab, FlowTab, ScoringTab, SlotManager) should already have auto-save with toast
    4. Verify toast messages show "saved successfully" feedback
    5. Add timestamp or version indicator showing last config update time (optional, Claude's discretion)

    Pattern: Clear visual feedback that config changes are saved and will affect next bot response.
  </action>
  <verify>
    ```bash
    # Check Your Intern page has toast feedback
    grep "toast" src/app/\(dashboard\)/\[workspace\]/knowledge-base/page.tsx

    # Verify tabs have auto-save pattern
    grep "toast.*success" src/components/knowledge-base/persona-tab.tsx
    ```
  </verify>
  <done>Your Intern page shows clear feedback when config saved; user knows changes are live</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete ARI flow integration with hot-reload configuration:
    - Mouth reads workspace persona/flow from getAriContext (Plan 01)
    - Brain applies workspace scoring_rules (Plan 02)
    - Routing respects consultation_slots (Plan 03)
    - Mock data shows flow progression example
  </what-built>
  <how-to-verify>
    **Test 1: Verify getAriContext fetches workspace config**

    1. Start dev server:
       ```bash
       npm run dev
       ```
    2. Open browser console at http://localhost:3000/demo
    3. Check Convex logs or add console.log to getAriContext to verify:
       - workspace.settings fetched
       - persona, flowStages, scoringRules, consultationSlots returned
       - No caching (fresh fetch on each call)

    **Test 2: Verify Mouth uses workspace config**

    1. Navigate to http://localhost:3000/demo/knowledge-base
    2. Edit Persona tab:
       - Change bot name to "TestBot"
       - Change tone to "professional"
       - Save (should see toast notification)
    3. Navigate to Inbox (http://localhost:3000/demo/inbox)
    4. Send test message to mock conversation
    5. EXPECTED: Next AI response uses "TestBot" name and professional tone
    6. If not working: Check browser console for errors, verify getAriContext called

    **Test 3: Verify Brain uses workspace scoring rules**

    1. Navigate to http://localhost:3000/demo/knowledge-base
    2. Go to Scoring tab
    3. Change hot threshold from 70 to 80
    4. Save configuration
    5. Check mock conversation with lead_score 75
    6. EXPECTED: Temperature should be "warm" (not "hot" since 75 < 80)
    7. Verify next_action field appears in conversation data

    **Test 4: Verify routing respects consultation slots**

    1. Navigate to Slots tab in Your Intern
    2. Set only Monday 10:00 as available
    3. Save configuration
    4. Simulate conversation reaching "booking" state
    5. EXPECTED: Bot offers only "Monday 10:00" (not other days/times)
    6. If all slots disabled: Bot should say "will contact you soon"

    **Test 5: Hot-reload verification**

    1. Have Inbox open in one tab, Your Intern in another tab
    2. Change Flow tab question from "Negara tujuan?" to "Which country?"
    3. Save in Your Intern tab
    4. Switch to Inbox tab, send message
    5. EXPECTED: Bot asks "Which country?" (not old question)
    6. NO restart required - immediate effect

    **Expected outcomes:**
    - ✅ getAriContext returns workspace.settings config
    - ✅ Mouth system prompt uses workspace persona and flow
    - ✅ Brain applies workspace scoring thresholds
    - ✅ Routing offers only available consultation slots
    - ✅ Config changes in Your Intern affect next bot response (no restart)
    - ✅ next_action field visible in conversation data
    - ✅ Toast notifications confirm saves

    **If issues found:**
    - Check browser console for errors
    - Verify dev mode check: NEXT_PUBLIC_DEV_MODE=true in .env.local
    - Check Convex dashboard for mutation logs
    - Verify workspace.settings structure matches expected format
  </how-to-verify>
  <resume-signal>
    Type one of:
    - "approved" - All tests pass, config hot-reload works
    - "approved with notes: [details]" - Works but needs polish
    - "issues found: [description]" - Specific problems to fix
  </resume-signal>
</task>

</tasks>

<verification>
After human verification approval:

1. Confirm all integration points working:
   - [ ] getAriContext fetches workspace.settings (persona, flow, scoring, slots)
   - [ ] Mouth uses workspace config (not hardcoded)
   - [ ] Brain applies workspace scoring rules
   - [ ] Routing respects consultation slots
   - [ ] Config changes take effect immediately (no restart)

2. Verify no caching anywhere:
   - [ ] getAriContext is mutation (fresh fetch each time)
   - [ ] processARI calls getAriContext on every message
   - [ ] No in-memory config cache

3. Check demo mode works:
   - [ ] Mock data shows realistic flow progression
   - [ ] Your Intern page loads without errors
   - [ ] Toast notifications confirm saves
</verification>

<success_criteria>
- [ ] Complete ARI flow works: new lead → greeting → Q1 → answer → Q2 → scoring → routing
- [ ] Mouth reads workspace persona and flow config from getAriContext
- [ ] Brain applies workspace scoring_rules to lead_score calculation
- [ ] Routing logic respects workspace consultation_slots (offers only available times)
- [ ] Config changes in Your Intern immediately affect next bot response (no restart)
- [ ] next_action field shows AI's planned next step (visible for debugging)
- [ ] Demo mode shows realistic flow progression with mock data
- [ ] Human verification confirms all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-ari-flow-integration/06-04-SUMMARY.md`
</output>
