---
phase: 05-lead-flow
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Lead created via n8n has all fields populated correctly"
    - "Metadata from form answers is stored and accessible"
    - "Lead appears in Contact Database with correct formatting"
  artifacts:
    - path: "convex/n8n.ts"
      provides: "Lead creation with metadata storage"
      contains: "metadata: args.metadata"
    - path: "convex/contacts.ts"
      provides: "Contact queries for database display"
      exports: ["getAll", "getByWorkspace"]
  key_links:
    - from: "n8n workflow"
      to: "/webhook/n8n"
      via: "HTTP POST with lead_score and metadata"
      pattern: "lead_score.*metadata"
    - from: "Contact Database UI"
      to: "contacts.getByWorkspace"
      via: "useQuery"
      pattern: "useQuery.*contacts.*getByWorkspace"
---

<objective>
Verify lead data appears correctly in Contact Database with all fields

Purpose: Confirm LEAD-02 requirement — Leads appear in Contact Database with correct data
Output: Documented verification of lead data accuracy and completeness
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/05-lead-flow/05-RESEARCH.md
@planning/phases/05-lead-flow/05-01-SUMMARY.md
@convex/n8n.ts
@convex/contacts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify contact data via Convex query</name>
  <files>N/A (no files modified - verification only)</files>
  <action>
Use the Convex dashboard or admin query to verify the contact created in Plan 01:

1. Open Convex Dashboard: https://dashboard.convex.dev
2. Select "intent-otter-212" deployment
3. Go to "Data" tab
4. Select "contacts" table
5. Find the contact with phone "+6281234500001"

Verify these fields:
- `workspace_id`: Should match Eagle workspace ID
- `name`: "Test Lead Phase5"
- `phone`: "+6281234500001"
- `phone_normalized`: "+6281234500001"
- `email`: "test-phase5@example.com"
- `lead_score`: 65
- `lead_status`: "new"
- `tags`: ["google-form"]
- `source`: "n8n"
- `metadata`: Contains form_answers object
- `created_at`: Recent timestamp
- `updated_at`: Same as created_at

Document any discrepancies or missing fields.
  </action>
  <verify>
All required fields are present and correctly populated in Convex dashboard
  </verify>
  <done>
Contact data structure matches expected schema with all fields populated
  </done>
</task>

<task type="auto">
  <name>Task 2: Test phone number normalization variants</name>
  <files>N/A (no files modified - verification only)</files>
  <action>
Test that phone normalization handles Indonesian formats correctly by sending leads with different phone formats:

Test 1 - Indonesian local format (0812...):
```bash
curl -X POST https://intent-otter-212.convex.cloud/webhook/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Local Format Test",
    "phone": "081234500002",
    "email": "local@test.com",
    "lead_score": 50,
    "metadata": { "source": "phone-format-test" }
  }'
```

Expected: Phone stored as "+6281234500002" (0 → +62)

Test 2 - Without plus (62812...):
```bash
curl -X POST https://intent-otter-212.convex.cloud/webhook/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "name": "No Plus Test",
    "phone": "6281234500003",
    "email": "noplus@test.com",
    "lead_score": 50,
    "metadata": { "source": "phone-format-test" }
  }'
```

Expected: Phone stored as "+6281234500003" (62 → +62)

Test 3 - With spaces and dashes:
```bash
curl -X POST https://intent-otter-212.convex.cloud/webhook/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Formatted Phone Test",
    "phone": "+62 812-3450-0004",
    "email": "formatted@test.com",
    "lead_score": 50,
    "metadata": { "source": "phone-format-test" }
  }'
```

Expected: Phone stored as "+6281234500004" (spaces/dashes removed)

Verify each response shows `status: "created"` and document the normalized phone values.
  </action>
  <verify>
All three test cases return `status: "created"` with correctly normalized phone numbers
  </verify>
  <done>
Phone normalization handles Indonesian formats: 0→+62, 62→+62, removes spaces/dashes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Lead data verification with multiple phone formats</what-built>
  <how-to-verify>
1. Open Contact Database:
   - Go to https://my21staff.com/eagle-overseas/database

2. Verify test contacts appear:
   - "Test Lead Phase5" with phone +6281234500001
   - "Local Format Test" with phone +6281234500002
   - "No Plus Test" with phone +6281234500003
   - "Formatted Phone Test" with phone +6281234500004

3. For each contact, check:
   - Name displays correctly
   - Phone is in E.164 format (+62...)
   - Lead Score shows the number (65, 50, 50, 50)
   - Status shows "new"
   - Tags include "google-form"

4. Click on a contact to view details:
   - Email should display
   - Metadata should be accessible (in profile sidebar or details view)

5. Test search functionality:
   - Search by partial phone "812345"
   - Search by name "Format Test"
   - Verify results appear correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all contacts display correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Contact from Plan 01 visible in Convex dashboard with all fields
- [ ] Phone normalization test 1: 0812... → +6281...
- [ ] Phone normalization test 2: 6281... → +6281...
- [ ] Phone normalization test 3: +62 812-... → +6281...
- [ ] All test contacts visible in Contact Database UI
- [ ] Lead scores display correctly
- [ ] Tags and status display correctly
- [ ] Search functionality works
</verification>

<success_criteria>
LEAD-02 is verified when:
1. All contact fields are populated correctly in database
2. Phone normalization handles all Indonesian formats
3. Metadata (form_answers) is stored and accessible
4. Contacts display correctly in Contact Database UI
5. Search finds contacts by phone and name
</success_criteria>

<output>
After completion, create `planning/phases/05-lead-flow/05-02-SUMMARY.md`
</output>
