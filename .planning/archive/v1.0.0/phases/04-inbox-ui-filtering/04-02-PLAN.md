---
phase: 04-inbox-ui-filtering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/inbox/message-bubble.tsx
  - src/components/inbox/message-thread.tsx
autonomous: true

must_haves:
  truths:
    - "Message bubbles display with WhatsApp-style appearance (sender vs receiver differentiation)"
    - "Message thread auto-scrolls to bottom when user is already at bottom"
    - "New message indicator appears when messages arrive while user scrolled up"
    - "Message timestamps show in readable format (Today, Yesterday, date)"
    - "Media attachments (images, documents, video, audio) render correctly within bubbles"
  artifacts:
    - path: "src/components/inbox/message-bubble.tsx"
      provides: "Kapso-styled message bubbles with media support"
      contains: "WhatsApp-like styling with background colors and media rendering"
      min_lines: 120
    - path: "src/components/inbox/message-thread.tsx"
      provides: "Auto-scroll behavior with new message indicator"
      contains: "scroll position detection and auto-scroll logic"
      min_lines: 250
  key_links:
    - from: "src/components/inbox/message-thread.tsx"
      to: "isAtBottom state"
      via: "scroll event handler"
      pattern: "handleScroll|scrollTop|scrollHeight"
    - from: "src/components/inbox/message-thread.tsx"
      to: "messagesEndRef"
      via: "scrollIntoView"
      pattern: "scrollIntoView.*smooth"
    - from: "src/components/inbox/message-bubble.tsx"
      to: "media rendering"
      via: "message_type and media_url props"
      pattern: "message_type.*image|document|video|audio"
---

<objective>
Enhance message thread with Kapso's WhatsApp-style UI: improved message bubble styling, media rendering, and smart auto-scroll behavior.

Purpose: Match WhatsApp Web's messaging experience with proper sender/receiver bubble differentiation, media attachment display, and intelligent scroll handling.
Output: Message bubbles styled like Kapso's aesthetic with media support; message thread with auto-scroll and "new messages" indicator.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-CONTEXT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/04-inbox-ui-filtering/04-RESEARCH.md

# Current message components
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/message-bubble.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/message-thread.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/message-status.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/date-separator.tsx
@/home/jfransisco/Desktop/21/my21staff/src/components/inbox/compose-input.tsx
</context>

<tasks>

<task type="auto">
  <name>Enhance message-bubble with Kapso WhatsApp-style styling and media support</name>
  <files>src/components/inbox/message-bubble.tsx</files>
  <action>
Enhance existing message-bubble.tsx with WhatsApp-style visual design (inspired by Kapso aesthetic from RESEARCH.md).

Current file has basic bubble structure - enhance styling without changing component API or breaking existing usage.

**WhatsApp-style design principles:**

SENDER bubbles (outgoing - from business):
- Background: bg-emerald-500 (WhatsApp green for sent messages)
- Text: text-white
- Border radius: rounded-2xl rounded-tr-sm (sharp corner top-right, characteristic WhatsApp shape)
- Alignment: self-end ml-auto (right-aligned)
- Max width: max-w-[70%] (don't span full width)
- Padding: px-3 py-2
- Shadow: shadow-sm

RECEIVER bubbles (incoming - from customer):
- Background: bg-white dark:bg-gray-800 (white in light mode, dark gray in dark mode)
- Text: text-gray-900 dark:text-gray-100
- Border radius: rounded-2xl rounded-tl-sm (sharp corner top-left)
- Alignment: self-start mr-auto (left-aligned)
- Max width: max-w-[70%]
- Padding: px-3 py-2
- Shadow: shadow-sm
- Border: border border-gray-200 dark:border-gray-700 (subtle outline for definition)

**Message metadata (timestamp, status):**
- Place at bottom-right of bubble
- Font size: text-xs
- Opacity: opacity-70
- For sender: text-white/70
- For receiver: text-gray-500
- Status icon (MessageStatus component): inline, 12px size

**Media attachments (images, documents, video, audio) - CRITICAL:**
- Render above text content within same bubble
- **Images**: rounded-lg, max-width 100%, cursor-pointer (clickable), preserve aspect ratio
- **Documents**: Show file icon + filename + size, use existing document-card component if present
- **Video**: Show video player or thumbnail with play icon
- **Audio**: Show audio player controls
- Media displays ABOVE text in bubble (media first, then text below)
- If media only (no text): Remove padding from bubble, let media be flush against bubble edges
- Verify media URLs render correctly (check message.media_url prop)
- Ensure media doesn't break bubble layout (overflow hidden, max-width constraints)

**Preserve existing functionality:**
- Keep all props: message, isSender, showTimestamp, etc.
- Keep MessageStatus integration
- Keep date-fns formatting for timestamps
- Maintain dev mode support if present
- **CRITICAL**: Preserve ALL media rendering logic - images, documents, video, audio must continue working

DO NOT change component interface - only enhance visual styling within existing structure. DO NOT remove or break media attachment rendering.
  </action>
  <verify>
```bash
# Check WhatsApp-style classes added
grep -q "bg-emerald-500" src/components/inbox/message-bubble.tsx  # Sender green
grep -q "rounded-2xl" src/components/inbox/message-bubble.tsx      # WhatsApp border radius
grep -q "max-w-\[70%\]" src/components/inbox/message-bubble.tsx   # Max width constraint

# Verify media rendering preserved
grep -q "media" src/components/inbox/message-bubble.tsx  # Media handling exists
grep -E -q "image|document|video|audio" src/components/inbox/message-bubble.tsx  # Media types handled

# Verify component still exports properly
grep -q "export.*MessageBubble" src/components/inbox/message-bubble.tsx
```
  </verify>
  <done>message-bubble.tsx enhanced with WhatsApp-style backgrounds (emerald-500 for sender, white/gray-800 for receiver), characteristic rounded corners with sharp edges (rounded-tr-sm/tl-sm), 70% max-width constraint, proper alignment (sender right, receiver left), shadow, metadata positioning, AND verified media attachments (images, documents, video, audio) render correctly above text within bubbles</done>
</task>

<task type="auto">
  <name>Enhance message-thread with smart auto-scroll and new message indicator</name>
  <files>src/components/inbox/message-thread.tsx</files>
  <action>
Enhance existing message-thread.tsx with WhatsApp-style auto-scroll behavior (pattern documented in RESEARCH.md).

Current file likely has basic message rendering - add smart scroll detection and "new messages" indicator.

**Auto-scroll behavior (WhatsApp pattern):**

1. **Scroll position tracking:**
   - Add state: `const [isAtBottom, setIsAtBottom] = useState(true)`
   - Add ref: `const containerRef = useRef<HTMLDivElement>(null)`
   - Create handleScroll function:
     ```typescript
     const handleScroll = useCallback(() => {
       if (!containerRef.current) return
       const { scrollTop, scrollHeight, clientHeight } = containerRef.current
       const threshold = 100 // pixels from bottom
       const atBottom = scrollHeight - scrollTop - clientHeight < threshold
       setIsAtBottom(atBottom)
     }, [])
     ```
   - Attach to scroll container: `onScroll={handleScroll}`

2. **Auto-scroll logic:**
   - Add ref: `const messagesEndRef = useRef<HTMLDivElement>(null)`
   - useEffect on messages change:
     ```typescript
     useEffect(() => {
       if (isAtBottom && messages && messages.length > 0) {
         messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
       }
     }, [messages, isAtBottom])
     ```
   - Place `<div ref={messagesEndRef} />` at end of message list

3. **"New messages" indicator:**
   - Add state: `const [showNewIndicator, setShowNewIndicator] = useState(false)`
   - Show indicator when: `!isAtBottom && (new messages arrived)`
   - Hide indicator when: user scrolls to bottom OR clicks indicator
   - UI:
     ```tsx
     {showNewIndicator && (
       <button
         onClick={() => {
           messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
           setShowNewIndicator(false)
         }}
         className="sticky bottom-4 left-1/2 -translate-x-1/2 z-10 flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-full shadow-lg hover:bg-primary/90 transition-all"
       >
         <ChevronDown className="w-4 h-4" />
         <span className="text-sm font-medium">New messages</span>
       </button>
     )}
     ```
   - Position: Sticky at bottom, centered, floats above messages

4. **Initial scroll on mount:**
   - useEffect on mount to scroll to bottom immediately (no animation)
   - `messagesEndRef.current?.scrollIntoView({ behavior: 'instant' })`

**Preserve existing functionality:**
- Keep message rendering logic (mapping over messages)
- Keep MessageBubble, DateSeparator, ComposeInput integration
- Keep contact info display
- Maintain dev mode support
- Keep conversation status handling

Import ChevronDown from lucide-react if not already imported.

DO NOT change component interface - only add scroll behavior enhancements.
  </action>
  <verify>
```bash
# Check scroll behavior added
grep -q "isAtBottom" src/components/inbox/message-thread.tsx
grep -q "handleScroll" src/components/inbox/message-thread.tsx
grep -q "messagesEndRef" src/components/inbox/message-thread.tsx

# Check new message indicator
grep -q "showNewIndicator" src/components/inbox/message-thread.tsx
grep -q "New messages" src/components/inbox/message-thread.tsx

# Verify scrollIntoView usage
grep -q "scrollIntoView" src/components/inbox/message-thread.tsx
```
  </verify>
  <done>message-thread.tsx enhanced with scroll position tracking (isAtBottom state + handleScroll), auto-scroll logic (scrollIntoView when at bottom), "new messages" floating button indicator (shown when scrolled up with new messages), initial scroll on mount, and smooth vs instant scroll behavior based on context</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Message bubble styling:
```bash
# Verify WhatsApp-style colors
cat src/components/inbox/message-bubble.tsx | grep "bg-emerald-500"  # Sender green
cat src/components/inbox/message-bubble.tsx | grep "bg-white dark:bg-gray-800"  # Receiver white/dark

# Verify border radius
cat src/components/inbox/message-bubble.tsx | grep "rounded-2xl rounded-t[rl]-sm"

# Verify media rendering preserved
cat src/components/inbox/message-bubble.tsx | grep -i "media"
```

2. Auto-scroll behavior:
```bash
# Verify scroll tracking
cat src/components/inbox/message-thread.tsx | grep "isAtBottom"
cat src/components/inbox/message-thread.tsx | grep "containerRef"

# Verify new message indicator
cat src/components/inbox/message-thread.tsx | grep "showNewIndicator"
```

3. Visual test in dev mode:
- Start dev server: `npm run dev`
- Navigate to http://localhost:3000/demo/inbox
- Send message: Should scroll to bottom automatically
- Scroll up manually: Should show "New messages" button when new message arrives
- Click "New messages" button: Should scroll smoothly to bottom
- Message bubbles: Sender right-aligned green, receiver left-aligned white
- Media attachments: Images/documents render correctly within bubbles
</verification>

<success_criteria>
- [ ] Message bubbles styled with WhatsApp aesthetic (emerald-500 sender, white receiver)
- [ ] Sender bubbles right-aligned with rounded-tr-sm, receiver left-aligned with rounded-tl-sm
- [ ] Both bubble types have 70% max-width, shadow, and proper padding
- [ ] **Media attachments (images, documents, video, audio) render correctly within bubbles**
- [ ] **Media displays above text content; media-only messages have flush layout**
- [ ] Message thread tracks scroll position (isAtBottom state)
- [ ] Auto-scroll to bottom when user already at bottom (smooth behavior)
- [ ] "New messages" indicator appears when messages arrive while scrolled up
- [ ] Clicking indicator scrolls smoothly to bottom
- [ ] Initial mount scrolls to bottom instantly (no animation)
- [ ] All existing functionality preserved (MessageStatus, DateSeparator, ComposeInput)
- [ ] Dev mode support maintained
</success_criteria>

<output>
After completion, create `.planning/phases/04-inbox-ui-filtering/04-02-SUMMARY.md`
</output>
