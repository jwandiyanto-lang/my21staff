---
phase: 02-ari-core-conversation
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/lib/ari/state-machine.ts
  - src/lib/ari/context-builder.ts
  - src/lib/ari/index.ts
autonomous: true

must_haves:
  truths:
    - "State machine validates transitions between ARI states"
    - "Context builder creates prompts with CRM data"
    - "System prompt includes form data, conversation state, persona settings"
    - "Indonesian time-based greetings work correctly (pagi/siang/sore/malam)"
  artifacts:
    - path: "src/lib/ari/state-machine.ts"
      provides: "State transition logic"
      exports: ["canTransition", "getNextState"]
    - path: "src/lib/ari/context-builder.ts"
      provides: "Prompt construction"
      exports: ["buildSystemPrompt", "buildMessageHistory"]
  key_links:
    - from: "src/lib/ari/context-builder.ts"
      to: "contacts.metadata.form_answers"
      via: "prompt template"
      pattern: "form_answers|formAnswers"
---

# 02-02-PLAN: ARI State Machine and Context Builder

## Goal

Build the state machine for conversation flow and context builder for AI prompts using CRM data.

## Context

**From 02-01-PLAN:** Types and AI clients are ready

**Research findings (02-RESEARCH.md):**
- State machine: greeting -> qualifying -> scoring -> booking -> payment -> scheduling -> handoff -> completed
- Always allow transition to 'handoff' (escape hatch)
- Context builder pulls: contact name, form_answers, conversation state, recent messages
- Indonesian time-based greetings: pagi (5-11), siang (11-15), sore (15-18), malam (rest)
- WhatsApp brevity: 1-2 sentences, no emoji

**Database context fields:**
- contact.metadata.form_answers: country, budget, timeline, english_level, activity
- ari_config: bot_name, greeting_style, tone, language
- ari_conversations.context: collected data during conversation

## Tasks

<task id="1">
<title>Create state machine with transition validation</title>
<action>
1. Create `src/lib/ari/state-machine.ts`:

2. Define STATE_TRANSITIONS constant (move from types.ts if needed):
   ```typescript
   const STATE_TRANSITIONS: Record<ARIState, ARIState[]> = {
     greeting: ['qualifying'],
     qualifying: ['scoring', 'qualifying'], // Can stay to collect more
     scoring: ['booking', 'handoff'],
     booking: ['payment', 'handoff'],
     payment: ['scheduling', 'payment', 'handoff'], // Can retry
     scheduling: ['handoff', 'scheduling'],
     handoff: ['completed'],
     completed: [],
   };
   ```

3. Implement functions:
   - `canTransition(from: ARIState, to: ARIState): boolean`
     - Always return true if to === 'handoff' (escape hatch)
     - Otherwise check STATE_TRANSITIONS[from].includes(to)

   - `getNextState(current: ARIState, context: ARIContext, leadScore: number): ARIState`
     - greeting -> always go to qualifying
     - qualifying -> if has enough data (score >= 40), go to scoring
     - scoring -> if hot lead (score >= 70), go to booking, else handoff
     - booking -> stay until user response indicates interest
     - payment -> handled by payment webhook (not AI decision)
     - scheduling -> handled by appointment selection

   - `shouldAutoHandoff(state: ARIState, messageCount: number): boolean`
     - Return true if stuck in same state > 10 messages (prevent loops)

4. Include JSDoc with examples for each function
</action>
<verify>
- File exists at src/lib/ari/state-machine.ts
- canTransition('greeting', 'qualifying') returns true
- canTransition('greeting', 'payment') returns false
- canTransition('qualifying', 'handoff') returns true (escape hatch)
</verify>
</task>

<task id="2">
<title>Create context builder for AI prompts</title>
<action>
1. Create `src/lib/ari/context-builder.ts`:

2. Define PromptContext interface:
   ```typescript
   interface PromptContext {
     contact: {
       name?: string | null;
       formAnswers?: Record<string, string>;
       leadScore?: number;
     };
     conversation: {
       state: ARIState;
       context: ARIContext;
       recentMessages: Array<{ role: 'user' | 'assistant'; content: string }>;
     };
     config: {
       botName: string;
       greetingStyle: 'casual' | 'formal' | 'professional';
       tone: { supportive?: boolean; clear?: boolean; encouraging?: boolean };
       language: string;
     };
     destinations?: Array<{
       country: string;
       university: string;
       requirements: Record<string, unknown>;
     }>;
   }
   ```

3. Implement `getTimeBasedGreeting(): string`:
   - Get current hour in WIB (UTC+7)
   - 5-11: 'pagi', 11-15: 'siang', 15-18: 'sore', else: 'malam'

4. Implement `buildSystemPrompt(ctx: PromptContext): string`:
   - Start with persona intro using config.botName
   - Add time-based greeting instruction
   - Add form data section if formAnswers exists (key-value list)
   - Add current state section with state-specific instructions:
     - greeting: Reference form data, ask what they want to know
     - qualifying: Collect missing info, ONE question per message
     - scoring: Summarize readiness, prepare transition
   - Add communication style rules:
     - Singkat: 1-2 kalimat per pesan
     - JANGAN pakai emoji
     - Bahasa santai (saya/kamu)
     - Mirror bahasa customer
   - Add relevant destinations if provided and user asked about universities

5. Implement `buildMessageHistory(messages: ARIMessage[], limit = 10)`:
   - Take last `limit` messages
   - Return as OpenAI-compatible format: { role, content }[]
   - Skip system messages (only user/assistant)

6. Export all functions
</action>
<verify>
- File exists at src/lib/ari/context-builder.ts
- buildSystemPrompt returns string containing bot name
- buildSystemPrompt includes form data when provided
- getTimeBasedGreeting returns valid Indonesian time word
</verify>
</task>

<task id="3">
<title>Update index.ts and add helper utilities</title>
<action>
1. Update `src/lib/ari/index.ts` to export:
   - All types from types.ts
   - canTransition, getNextState, shouldAutoHandoff from state-machine.ts
   - buildSystemPrompt, buildMessageHistory, getTimeBasedGreeting from context-builder.ts
   - selectModel, generateResponse from ai-router.ts

2. Add utility function in context-builder.ts:
   ```typescript
   export function extractFormAnswers(metadata: Json | null): Record<string, string> {
     if (!metadata) return {};
     // Handle nested structure: metadata.form_answers or metadata.metadata.form_answers
     const obj = metadata as Record<string, unknown>;
     const formAnswers = obj.form_answers || obj.metadata?.form_answers;
     if (!formAnswers || typeof formAnswers !== 'object') return {};
     return formAnswers as Record<string, string>;
   }
   ```

3. Ensure all exports are properly typed
</action>
<verify>
- src/lib/ari/index.ts exports all required functions
- `import { buildSystemPrompt, canTransition } from '@/lib/ari'` works
- extractFormAnswers handles both direct and nested form_answers
</verify>
</task>

## Verification

- [ ] State machine enforces valid transitions
- [ ] Handoff is always allowed (escape hatch works)
- [ ] System prompt includes contact name from form
- [ ] System prompt includes form answers
- [ ] Time-based greeting returns correct Indonesian word
- [ ] Message history limited to last 10 messages

## Success Criteria

- State machine validates all 8 ARI states
- Context builder creates personalized prompts with CRM data
- Indonesian time greetings (pagi/siang/sore/malam) work correctly
- Form data is extracted and included in prompts

## Requirements Addressed

- **ARI-02**: Greet by name with form context (via buildSystemPrompt)
- **ARI-06**: Maintain conversation context (via buildMessageHistory)
- **ARI-07**: Natural Indonesian with configurable persona (via prompt template)
