---
phase: 05-real-time-handover
plan: "03"
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/inbox/conversation-list.tsx
  - src/components/inbox/message-thread.tsx
autonomous: false

must_haves:
  truths:
    - "User can see which conversations are in AI mode vs Human mode"
    - "Mode indicator is visible in conversation list (badge or icon)"
    - "Mode indicator is visible in message thread header"
    - "Real-time message updates work end-to-end without page refresh"
    - "Toggle changes mode and system message appears"
  artifacts:
    - path: "src/components/inbox/conversation-list.tsx"
      provides: "Mode badge on conversation items"
      contains: "Bot.*User"
      min_lines: 100
    - path: "src/components/inbox/message-thread.tsx"
      provides: "Mode indicator in thread header"
      contains: "conversationStatus"
      min_lines: 150
  key_links:
    - from: "src/components/inbox/conversation-list.tsx"
      to: "conversation.status"
      via: "Badge component showing AI/Human icon"
      pattern: "status.*handover.*User.*Bot"
    - from: "src/components/inbox/message-thread.tsx"
      to: "TypingIndicator"
      via: "Conditional render while AI responds"
      pattern: "isAiResponding.*TypingIndicator"
---

<objective>
Add visual mode indicators throughout Inbox UI and verify complete end-to-end real-time message flow with AI/Human mode toggle working correctly.

Purpose: User can see mode status at a glance and confirm real-time sync works
Output: Complete visual feedback system + verified real-time workflow
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-real-time-handover/05-CONTEXT.md
@.planning/phases/05-real-time-handover/05-RESEARCH.md
@.planning/phases/05-real-time-handover/05-01-SUMMARY.md
@.planning/phases/05-real-time-handover/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add mode indicators to conversation list and message thread</name>
  <files>
    src/components/inbox/conversation-list.tsx
    src/components/inbox/message-thread.tsx
  </files>
  <action>
    Add visual indicators showing which mode (AI or Human) each conversation is in:

    1. **Conversation list mode badge** (conversation-list.tsx):
       - Add small badge/icon to each conversation item showing mode
       - AI mode (status = 'open'): Show Bot icon with subtle green background
       - Human mode (status = 'handover'): Show User icon with subtle blue background
       - Position: Near avatar or in top-right corner of conversation item
       - Use existing Shadcn Badge component with custom variant
       - Example:
         ```typescript
         <Badge variant="outline" className={cn("text-xs gap-1",
           conversation.status === 'handover' ? "bg-blue-50 text-blue-700" : "bg-green-50 text-green-700"
         )}>
           {conversation.status === 'handover' ? <User className="w-3 h-3" /> : <Bot className="w-3 h-3" />}
           {conversation.status === 'handover' ? 'Human' : 'AI'}
         </Badge>
         ```

    2. **Thread header mode indicator** (message-thread.tsx):
       - Update existing header to prominently show current mode
       - Show mode next to contact name or near toggle button
       - Use same icon pattern (Bot for AI, User for Human)
       - Make it clear which mode is active
       - Example: `{isAiActive ? 'ðŸ¤– AI Mode' : 'ðŸ‘¤ Human Mode'}`

    3. **Dev mode support**:
       - Ensure indicators work with mock data
       - MOCK_CONVERSATIONS should have status field ('open' or 'handover')
       - Toggle in dev mode should update local state and re-render indicators

    WHY visual indicators: User needs to see at a glance which conversations are being handled by AI vs require human attention.

    WHY in both locations: List view for quick scanning, thread header for current context.

    FOLLOW PATTERNS: Use existing Badge, Bot, User icons from lucide-react. Match color scheme from existing status badges (LEAD_STATUS_CONFIG pattern).
  </action>
  <verify>
    - Run `npm run dev` and visit http://localhost:3000/demo/inbox
    - Check conversation list - verify mode badge appears on each item
    - Select a conversation - verify mode indicator in thread header
    - Toggle mode - verify both indicators update
    - Check console - no errors
    - Verify colors and icons are clear and consistent
  </verify>
  <done>
    - Mode badge added to conversation list items (Bot icon = AI, User icon = Human)
    - Mode indicator added to message thread header
    - Both indicators update when mode is toggled
    - Dev mode shows indicators correctly with mock data
    - Visual design consistent with existing Inbox patterns
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete real-time message sync and AI/Human mode toggle system with visual feedback:
    - Real-time message updates via Convex subscriptions (Plan 05-01)
    - AI/Human toggle with confirmation dialog and system messages (Plan 05-01)
    - Typing indicator during AI responses (Plan 05-01)
    - ARI processing gate based on conversation.status (Plan 05-02)
    - Mode indicators in conversation list and message thread (Plan 05-03)
  </what-built>

  <how-to-verify>
    **Test in dev mode first (/demo/inbox):**

    1. **Visual indicators test:**
       - Visit http://localhost:3000/demo/inbox
       - Verify conversation list shows mode badges (Bot = AI, User = Human)
       - Select conversation - verify mode indicator in thread header
       - Confirm icons and colors are clear

    2. **Toggle functionality test:**
       - Click AI/Human toggle button in message thread
       - Verify confirmation dialog appears with warning message
       - Click "Confirm" - verify system message appears in thread: "[You switched to Human mode]"
       - Verify mode badge updates in conversation list
       - Verify mode indicator updates in thread header
       - Toggle back to AI mode - verify confirmation dialog again
       - Confirm system message: "[AI mode enabled]"

    3. **Real-time subscription test:**
       - Open browser console (F12)
       - Check for any errors or warnings
       - Verify no "subscription failed" messages
       - Confirm dev mode is using mock data (no Convex calls)

    **Test with Kapso webhook (if available):**

    4. **AI mode test:**
       - Ensure conversation is in AI mode (toggle ON, green Bot badge)
       - Use Kapso MCP tools to send test message to conversation
       - Verify message appears in Inbox within <2 seconds (no refresh needed)
       - Verify typing indicator shows while AI responds
       - Verify AI response appears automatically

    5. **Human mode test:**
       - Toggle conversation to Human mode (blue User badge)
       - Use Kapso MCP tools to send another test message
       - Verify message appears instantly (real-time sync still works)
       - Verify NO AI response (ARI processing skipped)
       - Check Convex logs for "[ARI Gate] Skipping ARI..." message

    6. **Conversation list reordering:**
       - Send message to different conversation
       - Verify that conversation moves to top of list
       - Verify unread count updates
       - Verify mode badge persists through reorder

    **Expected outcomes:**
    - âœ“ Real-time updates work without page refresh (<2 sec latency)
    - âœ“ Confirmation required before mode switch (prevents accidents)
    - âœ“ System messages appear after toggle (clear feedback)
    - âœ“ Mode badges visible in list and header (clear status)
    - âœ“ AI responds only when mode = AI (handover gate works)
    - âœ“ Typing indicator shows during AI response (WhatsApp UX)
    - âœ“ No errors in browser console or Convex logs
  </how-to-verify>

  <resume-signal>
    Type "approved" if all tests pass, or describe any issues found.

    If issues found, describe what's broken:
    - Which test failed?
    - What was expected vs actual behavior?
    - Any error messages in console?
  </resume-signal>
</task>

</tasks>

<verification>
See checkpoint task for complete verification steps.

**Key verification points:**
- Mode badges visible in conversation list (Bot = AI, User = Human)
- Mode indicator visible in thread header
- Toggle shows confirmation dialog before switching
- System message appears after successful toggle
- Real-time message sync works (<2 sec latency)
- AI responds only when conversation.status = 'open'
- Human mode (status = 'handover') skips ARI processing
- No console errors in dev mode or production
</verification>

<success_criteria>
1. Mode badges visible in conversation list (Bot icon for AI, User icon for Human)
2. Mode indicator visible in message thread header
3. Both indicators update immediately when mode is toggled
4. Real-time message sync verified working without page refresh
5. AI/Human toggle requires confirmation before switching
6. System message appears in thread after mode change
7. ARI processing skipped when conversation.status = 'handover'
8. Complete workflow tested and approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-handover/05-03-SUMMARY.md`
</output>
