---
phase: 03-workspace-roles
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(dashboard)/[workspace]/team/page.tsx
  - src/app/(dashboard)/[workspace]/team/team-client.tsx
  - src/components/ui/permission-button.tsx
  - src/app/api/members/[id]/role/route.ts
autonomous: false

must_haves:
  truths:
    - "User can see their own role in the team list"
    - "User can see role badges for all team members"
    - "Owner can change member role (member <-> admin)"
    - "Non-owners see disabled role change controls with tooltip"
    - "Role change sends notification email"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/team/page.tsx"
      provides: "Team page with current user role"
      contains: "currentUserRole"
    - path: "src/app/(dashboard)/[workspace]/team/team-client.tsx"
      provides: "Team UI with role management"
      contains: "RoleSelect"
    - path: "src/components/ui/permission-button.tsx"
      provides: "Reusable permission-aware button"
      exports: ["PermissionButton"]
    - path: "src/app/api/members/[id]/role/route.ts"
      provides: "Role change API endpoint"
      exports: ["PATCH"]
  key_links:
    - from: "team-client.tsx"
      to: "src/lib/permissions/check.ts"
      via: "imports hasPermission"
      pattern: "import.*hasPermission.*from.*permissions"
    - from: "team-client.tsx"
      to: "PermissionButton"
      via: "uses for invite button"
      pattern: "PermissionButton"
    - from: "PATCH /api/members/[id]/role"
      to: "src/lib/email/send.ts"
      via: "sends role change email"
      pattern: "sendRoleChangeEmail|send.*Email"
---

<objective>
Add role management UI to team page â€” show role badges, enable owner to change roles, disable controls for non-owners with tooltips.

Purpose: UI enforcement of role permissions with good UX (disabled+tooltip, not hidden).
Output: Team page shows roles, owners can change roles, non-owners see why they can't.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-roles/03-CONTEXT.md
@.planning/phases/03-workspace-roles/03-RESEARCH.md
@.planning/phases/03-workspace-roles/03-01-SUMMARY.md

# Existing team page to modify
@src/app/(dashboard)/[workspace]/team/page.tsx
@src/app/(dashboard)/[workspace]/team/team-client.tsx

# Email templates reference
@src/lib/email/send.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PermissionButton component</name>
  <files>src/components/ui/permission-button.tsx</files>
  <action>
Create reusable permission-aware button per CONTEXT.md and RESEARCH.md patterns.

```typescript
'use client'

import { Button, type ButtonProps } from '@/components/ui/button'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip'
import { hasPermission } from '@/lib/permissions/check'
import { type Permission, type WorkspaceRole } from '@/lib/permissions/types'

interface PermissionButtonProps extends ButtonProps {
  permission: Permission
  userRole: WorkspaceRole
  tooltipMessage?: string
}

export function PermissionButton({
  permission,
  userRole,
  tooltipMessage = 'Contact your workspace owner to access this',
  children,
  onClick,
  ...props
}: PermissionButtonProps) {
  const allowed = hasPermission(userRole, permission)

  if (allowed) {
    return (
      <Button onClick={onClick} {...props}>
        {children}
      </Button>
    )
  }

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild className="disabled:pointer-events-auto">
          <Button disabled {...props}>
            {children}
          </Button>
        </TooltipTrigger>
        <TooltipContent>
          <p>{tooltipMessage}</p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  )
}
```

Key points:
- `disabled:pointer-events-auto` on TooltipTrigger (per RESEARCH.md - accessibility fix)
- Default tooltip message per CONTEXT.md tone: "Contact your workspace owner to access this"
- Extends ButtonProps for full flexibility
  </action>
  <verify>
```bash
npx tsc --noEmit src/components/ui/permission-button.tsx
```
  </verify>
  <done>
PermissionButton component renders enabled button for permitted users, disabled button with tooltip for others.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update team page to pass current user role</name>
  <files>
    src/app/(dashboard)/[workspace]/team/page.tsx
    src/app/(dashboard)/[workspace]/team/team-client.tsx
  </files>
  <action>
**page.tsx changes:**
1. Query current user's role from workspace_members
2. Pass `currentUserRole` to TeamClient

```typescript
// After getting workspace, get current user's role
const { data: currentMembership } = await supabase
  .from('workspace_members')
  .select('role')
  .eq('workspace_id', workspace.id)
  .eq('user_id', user.id)
  .single()

const currentUserRole = (currentMembership?.role || 'member') as WorkspaceRole

// Pass to client:
return (
  <TeamClient
    workspace={workspace}
    members={membersWithProfiles}
    currentUserRole={currentUserRole}
  />
)
```

**team-client.tsx changes:**
1. Add `currentUserRole: WorkspaceRole` to props interface
2. Import `hasPermission` from permissions
3. Use PermissionButton for Invite button
4. Add role dropdown/select for each member (owner can change)
5. Disable role change for owner role (cannot change owner)
6. Disable role change controls for non-owners

Role dropdown for member row:
```tsx
{member.role === 'owner' ? (
  <Badge variant="default">owner</Badge>
) : hasPermission(currentUserRole, 'team:change_role') ? (
  <Select
    value={member.role}
    onValueChange={(newRole) => handleRoleChange(member.id, newRole)}
  >
    <SelectTrigger className="w-24">
      <SelectValue />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="admin">admin</SelectItem>
      <SelectItem value="member">member</SelectItem>
    </SelectContent>
  </Select>
) : (
  <Badge variant="secondary">{member.role}</Badge>
)}
```

Add `handleRoleChange` function that calls API and shows toast on success/error.

**Invite button update:**
Replace current Button with PermissionButton:
```tsx
<PermissionButton
  permission="team:invite"
  userRole={currentUserRole}
  onClick={handleInvite}
  disabled={isInviting || !email.trim()}
>
  <UserPlus className="h-4 w-4 mr-2" />
  {isInviting ? 'Inviting...' : 'Invite'}
</PermissionButton>
```

**Remove member button update:**
Replace trash button with PermissionButton:
```tsx
<PermissionButton
  permission="team:remove"
  userRole={currentUserRole}
  variant="ghost"
  size="icon"
  className="h-8 w-8"
  onClick={() => handleRemove(member.id)}
>
  <Trash2 className="h-4 w-4 text-muted-foreground" />
</PermissionButton>
```
  </action>
  <verify>
```bash
npm run build
# Visit /[workspace]/team as owner - should see role dropdowns
# Visit /[workspace]/team as member - should see disabled controls with tooltips
```
  </verify>
  <done>
Team page shows current user's role, owners see role dropdowns, non-owners see disabled controls with helpful tooltips.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create role change API endpoint with email notification</name>
  <files>
    src/app/api/members/[id]/role/route.ts
    src/lib/email/send.ts
    src/emails/role-change.tsx
  </files>
  <action>
**Create API endpoint (src/app/api/members/[id]/role/route.ts):**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { requireWorkspaceMembership } from '@/lib/auth/workspace-auth'
import { requirePermission } from '@/lib/permissions/check'
import { type WorkspaceRole } from '@/lib/permissions/types'
import { sendRoleChangeEmail } from '@/lib/email/send'

interface RouteParams {
  params: Promise<{ id: string }>
}

export async function PATCH(request: NextRequest, { params }: RouteParams) {
  try {
    const { id: memberId } = await params
    const { role: newRole } = await request.json()

    // Validate new role
    if (!['admin', 'member'].includes(newRole)) {
      return NextResponse.json(
        { error: 'Invalid role. Must be admin or member.' },
        { status: 400 }
      )
    }

    const supabase = await createClient()

    // Get the membership to change
    const { data: targetMember } = await supabase
      .from('workspace_members')
      .select('id, workspace_id, user_id, role')
      .eq('id', memberId)
      .single()

    if (!targetMember) {
      return NextResponse.json({ error: 'Member not found' }, { status: 404 })
    }

    // Cannot change owner role
    if (targetMember.role === 'owner') {
      return NextResponse.json(
        { error: 'Cannot change owner role. Contact my21staff support for ownership transfer.' },
        { status: 400 }
      )
    }

    // Check caller's permission
    const authResult = await requireWorkspaceMembership(targetMember.workspace_id)
    if (authResult instanceof NextResponse) return authResult

    const permError = requirePermission(
      authResult.role,
      'team:change_role',
      'Only workspace owners can change roles'
    )
    if (permError) return permError

    // Update the role
    const { error: updateError } = await supabase
      .from('workspace_members')
      .update({ role: newRole })
      .eq('id', memberId)

    if (updateError) {
      console.error('Failed to update role:', updateError)
      return NextResponse.json(
        { error: 'Failed to update role' },
        { status: 500 }
      )
    }

    // Get user email for notification
    const { data: profile } = await supabase
      .from('profiles')
      .select('email, full_name')
      .eq('id', targetMember.user_id)
      .single()

    // Get workspace name for email
    const { data: workspace } = await supabase
      .from('workspaces')
      .select('name')
      .eq('id', targetMember.workspace_id)
      .single()

    // Send notification email (don't fail the request if email fails)
    if (profile?.email) {
      try {
        await sendRoleChangeEmail({
          to: profile.email,
          userName: profile.full_name || profile.email,
          workspaceName: workspace?.name || 'your workspace',
          oldRole: targetMember.role as WorkspaceRole,
          newRole: newRole as WorkspaceRole,
        })
      } catch (emailError) {
        console.error('Failed to send role change email:', emailError)
        // Continue - role was changed successfully
      }
    }

    return NextResponse.json({ success: true, role: newRole })
  } catch (error) {
    console.error('Role change error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

**Add sendRoleChangeEmail to src/lib/email/send.ts:**

```typescript
interface RoleChangeEmailParams {
  to: string
  userName: string
  workspaceName: string
  oldRole: WorkspaceRole
  newRole: WorkspaceRole
}

export async function sendRoleChangeEmail({
  to,
  userName,
  workspaceName,
  oldRole,
  newRole,
}: RoleChangeEmailParams) {
  const resend = getResend()

  const { error } = await resend.emails.send({
    from: 'my21staff <noreply@my21staff.com>',
    to,
    subject: `Your role in ${workspaceName} has been updated`,
    react: RoleChangeEmail({ userName, workspaceName, oldRole, newRole }),
  })

  if (error) {
    throw new Error(`Failed to send role change email: ${error.message}`)
  }
}
```

**Create email template (src/emails/role-change.tsx):**

Simple React Email template:
- Subject: "Your role in {workspace} has been updated"
- Body: "{userName}, your role has been changed from {oldRole} to {newRole} in {workspaceName}."
- Follow existing invitation email template style
  </action>
  <verify>
```bash
npm run build
# Test role change as owner - should work and send email
# Test role change as admin/member - should get 403
```
  </verify>
  <done>
PATCH /api/members/[id]/role changes role and sends notification email. Returns 403 for non-owners, 400 for invalid role or owner target.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete role management system:
- PermissionButton component with disabled+tooltip pattern
- Team page with role badges and role change dropdowns
- Role change API with email notifications
- All permission checks enforced
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Log in as workspace OWNER
3. Visit /[workspace]/team
4. Verify: Can see role dropdown for admin/member users
5. Change a member's role to admin
6. Check: Email notification received
7. Log out and log in as that ADMIN user
8. Visit /[workspace]/team
9. Verify: Invite button is DISABLED with tooltip "Contact your workspace owner..."
10. Verify: Role dropdowns show as static badges (no edit capability)
11. Verify: Remove member button is DISABLED with tooltip
12. Log in as MEMBER user
13. Verify: Same disabled behavior as admin
14. Test API directly with curl as member - should get 403
  </how-to-verify>
  <resume-signal>Type "approved" if role management works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Owner can change member/admin roles via dropdown
3. Non-owners see disabled controls with helpful tooltips
4. Role change sends email notification
5. API returns proper 403 errors for unauthorized users
6. Owner role cannot be changed via UI or API
</verification>

<success_criteria>
- Team page shows role badges for all members
- Role dropdown visible only to owners
- PermissionButton renders disabled+tooltip for unauthorized users
- Role change API works for owners, returns 403 for others
- Email sent on role change
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-roles/03-03-SUMMARY.md`
</output>
