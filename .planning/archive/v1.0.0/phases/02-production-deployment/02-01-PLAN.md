---
phase: 02-production-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
  - .env.production
autonomous: true

must_haves:
  truths:
    - "Production build completes without TypeScript errors"
    - "All environment variables are documented and validated"
    - "Build output shows zero compilation errors"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx"
      provides: "Fixed calculatedScore variable reference"
      min_lines: 1200
    - path: ".env.production"
      provides: "Production environment template"
      contains: "NEXT_PUBLIC_DEV_MODE=false"
  key_links:
    - from: "contact-detail-sheet.tsx line 1159"
      to: "calculatedTotalScore variable"
      via: "direct reference"
      pattern: "calculatedTotalScore"
---

<objective>
Fix production build errors and prepare environment configuration for deployment.

Purpose: Ensure codebase can build successfully and all required environment variables are identified and validated before deployment.

Output: Clean production build passing all TypeScript checks, complete environment variable documentation.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/01-localhost-polish/PHASE-COMPLETE.md
@/home/jfransisco/Desktop/21/my21staff/docs/PRODUCTION-CHECKLIST.md
</context>

<tasks>

<task type="auto">
  <name>Fix production build error</name>
  <files>src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx</files>
  <action>
Fix TypeScript error in contact-detail-sheet.tsx lines 1159-1160:

**Error:** `Cannot find name 'calculatedScore'. Did you mean 'calculatedTotalScore'?`

**Root cause:** Variable name mismatch. Line 800 defines `calculatedTotalScore` but lines 1159-1160 reference undefined `calculatedScore`.

**Fix:**
1. Read contact-detail-sheet.tsx
2. Locate lines 1159-1160 (Total score display in Lead Score breakdown)
3. Replace both instances of `calculatedScore` with `calculatedTotalScore`
4. Verify change matches the variable defined at line 800

**Context:** This is the Lead Score breakdown total row in the contact detail sheet. The score comes from `calculatedTotalScore = mainFieldsFormScore + chatScore` (line 800).

Do NOT change the variable name at line 800. Do NOT add new variables. Simply fix the reference to use the correct existing variable name.
  </action>
  <verify>
Run production build and confirm TypeScript compilation succeeds:

```bash
npm run build 2>&1 | grep -E "(Compiled successfully|Failed to compile)"
```

Expected output: "Compiled successfully"
  </verify>
  <done>
Production build completes without TypeScript errors. Build output shows "Compiled successfully" with no type errors about calculatedScore.
  </done>
</task>

<task type="auto">
  <name>Audit and document environment variables</name>
  <files>.env.production</files>
  <action>
Create comprehensive environment variable documentation for production deployment.

**Audit current .env.local:**
1. List all environment variables currently in use
2. Categorize by service (Convex, Clerk, Kapso, Feature Flags)
3. Identify which are development-only vs production-required

**Create .env.production template:**

```env
# ============================================
# PRODUCTION ENVIRONMENT VARIABLES
# ============================================
# DO NOT COMMIT THIS FILE WITH REAL VALUES
# This is a template showing required variables
# ============================================

# Feature Flags (CRITICAL)
# MUST be false or removed in production
NEXT_PUBLIC_DEV_MODE=false

# Convex (Database + Real-time)
NEXT_PUBLIC_CONVEX_URL=https://intent-otter-212.convex.cloud
CONVEX_DEPLOY_KEY=prod_xxx...xxx

# Clerk (Authentication)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxx...xxx
CLERK_SECRET_KEY=sk_live_xxx...xxx
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/eagle-overseas
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/eagle-overseas

# Kapso (WhatsApp Integration)
KAPSO_API_KEY=xxx...xxx
KAPSO_API_URL=https://api.kapso.ai/v1
KAPSO_WEBHOOK_SECRET=xxx...xxx

# Deployment (Internal)
CONVEX_DEPLOYMENT=prod:intent-otter-212

# Total: 13 environment variables
```

**Validation checklist in comments:**
- [ ] NEXT_PUBLIC_DEV_MODE is false or removed
- [ ] Convex URL matches production deployment
- [ ] Clerk keys are from production environment (pk_live_, sk_live_)
- [ ] Kapso credentials match production account
- [ ] All secrets are non-empty and properly formatted

Write this file to `.env.production` as a template (with placeholder values). Do NOT include real secrets.
  </action>
  <verify>
Confirm template created and contains all required variables:

```bash
cat .env.production | grep -E "^(NEXT_PUBLIC_|CONVEX_|CLERK_|KAPSO_)" | wc -l
```

Expected: 13 lines (matching the count from PRODUCTION-CHECKLIST.md)
  </verify>
  <done>
.env.production template exists with all 13 required variables documented. Each variable has a comment explaining its purpose. File includes validation checklist.
  </done>
</task>

<task type="auto">
  <name>Verify Clerk JWT template configuration</name>
  <files></files>
  <action>
Verify Clerk JWT template includes required `org_id` claim for Convex authentication.

**Background:** Convex uses ConvexProviderWithClerk which requires JWT tokens to include organization ID. Without this claim, workspace-scoped queries will fail in production.

**Verification steps:**

1. Document the JWT template requirement in verification output:
   ```
   Required JWT claims for Convex:
   - sub (user ID) - automatic
   - org_id (organization ID) - MUST be added manually
   ```

2. Create verification instructions for user:
   ```
   Clerk Dashboard → Configure → Sessions → JWT Templates
   - Find "convex" template
   - Verify claims include: {"org_id": "{{org.id}}"}
   - If missing, this MUST be added before deployment
   ```

3. Document the failure symptom if missing:
   ```
   If org_id claim is missing:
   - User can authenticate successfully
   - Dashboard loads but shows no data
   - Convex queries return empty results
   - No error messages (silent failure)
   ```

This is a **checkpoint item for user** - Claude cannot access Clerk dashboard to verify directly. Output clear instructions for manual verification.
  </action>
  <verify>
Output verification instructions:

```bash
echo "Clerk JWT Template Verification Required"
echo "========================================"
echo "Before deploying to production:"
echo "1. Visit Clerk Dashboard → Configure → Sessions → JWT Templates"
echo "2. Find or create 'convex' template"
echo "3. Verify claims include: {\"org_id\": \"{{org.id}}\"}"
echo "4. Without this claim, workspace queries will fail silently"
echo ""
echo "This cannot be automated - requires manual dashboard access"
```
  </verify>
  <done>
Clerk JWT template requirement documented with clear verification steps. User knows to check org_id claim exists in Clerk dashboard before deployment.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Production build succeeds without errors
2. .env.production template exists with 13 variables documented
3. Clerk JWT template requirement documented for user verification

Run final build verification:
```bash
npm run build && echo "✅ Build ready for deployment"
```
</verification>

<success_criteria>
1. `npm run build` completes successfully with no TypeScript errors
2. .env.production template created with all 13 variables and validation checklist
3. Clerk JWT template verification instructions documented
4. No build warnings about missing environment variables
5. Build output shows "Compiled successfully" message
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-deployment/02-01-SUMMARY.md`
</output>
