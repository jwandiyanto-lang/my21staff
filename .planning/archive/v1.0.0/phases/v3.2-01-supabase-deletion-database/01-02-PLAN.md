---
phase: v3.2-01
plan: "02"
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/app/(dashboard)/[workspace]/layout.tsx
  - src/components/workspace/sidebar.tsx
  - src/components/workspace/workspace-switcher.tsx
autonomous: true

must_haves:
  truths:
    - "Workspace layout loads without Supabase"
    - "Sidebar renders without Supabase client"
    - "User can navigate to Lead Management page"
    - "App builds successfully"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/layout.tsx"
      provides: "Workspace layout with Clerk auth + Convex workspace query"
      contains: "fetchQuery"
    - path: "src/components/workspace/sidebar.tsx"
      provides: "Sidebar without Supabase"
  key_links:
    - from: "src/app/(dashboard)/[workspace]/layout.tsx"
      to: "api.workspaces.getBySlug"
      via: "fetchQuery"
      pattern: "fetchQuery.*workspaces"
    - from: "src/app/(dashboard)/[workspace]/layout.tsx"
      to: "@clerk/nextjs/server"
      via: "auth import"
      pattern: "auth.*@clerk"
---

<objective>
Migrate workspace layout and sidebar to use Convex instead of Supabase.

Purpose: Enable the app to build and run after Supabase deletion
Output: Working layout with Clerk auth and Convex data fetching
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-CONTEXT.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-RESEARCH.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-01-SUMMARY.md
@src/app/(dashboard)/[workspace]/layout.tsx
@src/app/(dashboard)/[workspace]/database/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate workspace layout to Clerk + Convex</name>
  <files>src/app/(dashboard)/[workspace]/layout.tsx</files>
  <action>
Rewrite layout.tsx to use Clerk auth and Convex for workspace validation. Follow the pattern from database/page.tsx.

**Replace entire file with:**

```typescript
import { notFound, redirect } from 'next/navigation'
import { auth } from '@clerk/nextjs/server'
import { fetchQuery } from 'convex/nextjs'
import { api } from 'convex/_generated/api'
import { WorkspaceSidebar } from '@/components/workspace/sidebar'
import { MOCK_WORKSPACE, isDevMode } from '@/lib/mock-data'

interface WorkspaceLayoutProps {
  children: React.ReactNode
  params: Promise<{ workspace: string }>
}

export default async function WorkspaceLayout({
  children,
  params,
}: WorkspaceLayoutProps) {
  const { workspace: workspaceSlug } = await params

  // Dev mode: skip auth and use mock workspace
  if (isDevMode()) {
    const workspace = { id: MOCK_WORKSPACE.id, name: MOCK_WORKSPACE.name, slug: MOCK_WORKSPACE.slug }
    return (
      <div className="flex h-screen overflow-hidden bg-background">
        <div className="noise-overlay" style={{ opacity: 0.03 }} />
        <WorkspaceSidebar workspace={workspace} isAdmin={true} />
        <main className="flex-1 flex flex-col overflow-hidden">
          <div className="flex-1 overflow-auto custom-scrollbar">
            {children}
          </div>
          <footer className="h-10 px-8 bg-sidebar/40 border-t border-black/5 flex items-center justify-between shrink-0">
            <div />
            <div className="flex items-center gap-2">
              <span className="w-1.5 h-1.5 rounded-full bg-accent" />
              <span className="text-[10px] font-bold uppercase tracking-widest text-muted-foreground">
                Network Stable
              </span>
            </div>
          </footer>
        </main>
      </div>
    )
  }

  // Production mode: use Clerk auth
  const { userId } = await auth()
  if (!userId) {
    redirect('/sign-in')
  }

  // Fetch workspace from Convex
  const workspace = await fetchQuery(api.workspaces.getBySlug, {
    slug: workspaceSlug,
  })

  if (!workspace) {
    notFound()
  }

  // For now, everyone with access is treated as admin
  // TODO: Check organization membership role from Clerk
  const isAdmin = true

  return (
    <div className="flex h-screen overflow-hidden bg-background">
      <div className="noise-overlay" style={{ opacity: 0.03 }} />
      <WorkspaceSidebar
        workspace={{ id: workspace._id, name: workspace.name, slug: workspace.slug }}
        isAdmin={isAdmin}
      />
      <main className="flex-1 flex flex-col overflow-hidden">
        <div className="flex-1 overflow-auto custom-scrollbar">
          {children}
        </div>
        <footer className="h-10 px-8 bg-secondary border-t border-primary/10 flex items-center justify-between shrink-0">
          <div />
          <div className="flex items-center gap-2">
            <span className="w-1.5 h-1.5 rounded-full bg-[#22c55e]" />
            <span className="text-[10px] font-bold uppercase tracking-widest text-muted-foreground">
              Network Stable
            </span>
          </div>
        </footer>
      </main>
    </div>
  )
}
```

**Key changes:**
- Import auth from @clerk/nextjs/server (not Supabase)
- Import fetchQuery from convex/nextjs
- Use api.workspaces.getBySlug (same pattern as database/page.tsx)
- Redirect to /sign-in (Clerk route) not /login
- Use workspace._id for Convex ID format
  </action>
  <verify>
1. `npx tsc --noEmit` - no TypeScript errors
2. No Supabase imports in layout.tsx: `grep -c "supabase" src/app/\(dashboard\)/\[workspace\]/layout.tsx` returns 0
  </verify>
  <done>
Layout.tsx uses Clerk auth and Convex fetchQuery. No Supabase imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up sidebar and workspace-switcher</name>
  <files>
src/components/workspace/sidebar.tsx
src/components/workspace/workspace-switcher.tsx
  </files>
  <action>
**For sidebar.tsx:**

The sidebar was already updated in Plan 01 to remove Supabase. Verify it has no Supabase imports and the unread count is set to 0 or removed.

If any cleanup needed:
1. Remove any remaining createClient imports
2. Remove useEffect that fetches unread count
3. Keep unreadCount state but set to 0

**For workspace-switcher.tsx:**

Check if it uses Supabase:
- If yes: Remove Supabase client usage, simplify to just display current workspace
- If no: Leave as-is

The workspace-switcher should just show the current workspace name. Multi-workspace switching can be added later.

Simple implementation if rewrite needed:
```typescript
'use client'

import { Building2 } from 'lucide-react'

interface WorkspaceSwitcherProps {
  workspace: {
    name: string
    slug: string
  }
}

export function WorkspaceSwitcher({ workspace }: WorkspaceSwitcherProps) {
  return (
    <div className="flex items-center gap-2 px-2 py-1.5">
      <Building2 className="h-4 w-4 text-muted-foreground" />
      <span className="text-sm font-medium truncate">{workspace.name}</span>
    </div>
  )
}
```
  </action>
  <verify>
1. `grep -c "supabase" src/components/workspace/sidebar.tsx` returns 0
2. `grep -c "supabase" src/components/workspace/workspace-switcher.tsx` returns 0
3. `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
Both sidebar.tsx and workspace-switcher.tsx have no Supabase imports.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full build succeeds</name>
  <files>None</files>
  <action>
Run the full build to verify everything works:

```bash
npm run build
```

**Expected result:** Build succeeds with no errors.

If build fails:
1. Read the error message carefully
2. Fix the issue (likely a missed Supabase import somewhere)
3. Re-run build until it passes

Common issues to check:
- Any remaining `@/lib/supabase` imports
- Missing types that were in Supabase files
- Import errors from deleted components

After build succeeds, start dev server and verify:
```bash
npm run dev
```

Navigate to http://localhost:3000/eagle-overseas/database and verify:
1. Page loads without errors
2. Sidebar shows Lead Management link
3. Contacts table displays (may be empty if no mock data)
  </action>
  <verify>
1. `npm run build` exits with code 0
2. No TypeScript errors
3. Dev server starts and database page loads
  </verify>
  <done>
App builds successfully. Layout and sidebar work with Convex + Clerk.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `grep -r "supabase" src/` returns only false positives (comments, etc.) or nothing
3. Dev server runs and /eagle-overseas/database loads correctly
</verification>

<success_criteria>
- Workspace layout uses Clerk auth and Convex fetchQuery
- Sidebar and workspace-switcher have no Supabase imports
- App builds without errors
- Database page accessible via navigation
</success_criteria>

<output>
After completion, create `.planning/phases/v3.2-01-supabase-deletion-database/01-02-SUMMARY.md`
</output>
