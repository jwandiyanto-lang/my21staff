---
phase: v3.2-01
plan: "03"
type: execute
wave: 3
depends_on: ["02"]
files_modified:
  - src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
  - src/components/contacts/contact-detail-dialog.tsx
  - src/app/api/contacts/[id]/notes/route.ts
autonomous: true

must_haves:
  truths:
    - "Contact detail opens as centered modal dialog (not sheet)"
    - "Modal has 4 tabs: Profile, Documents, Conversations, Notes"
    - "Profile tab shows contact fields and is inline editable"
    - "No Supabase imports in contact detail component"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx"
      provides: "Dialog component for contact details"
      contains: "Dialog"
    - path: "src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx"
      provides: "4-tab interface"
      contains: "Tabs"
    - path: "src/app/api/contacts/[id]/notes/route.ts"
      provides: "Notes CRUD API endpoint"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx"
      to: "/api/contacts/[id]/notes"
      via: "fetch for notes operations"
      pattern: "fetch.*api/contacts.*notes"
---

<objective>
Convert the contact detail sheet to a modal dialog with 4 tabs (Profile, Documents, Conversations, Notes).

Purpose: User requested modal instead of sheet, with organized tabbed interface per CONTEXT.md
Output: Contact detail dialog with 4 functional tabs, using Convex via API routes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-CONTEXT.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-RESEARCH.md
@.planning/phases/v3.2-01-supabase-deletion-database/01-02-SUMMARY.md
@src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
@src/app/(dashboard)/[workspace]/database/database-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert Sheet to Dialog and implement 4-tab structure</name>
  <files>src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx</files>
  <action>
Rewrite contact-detail-sheet.tsx to use Dialog instead of Sheet, organized into 4 tabs.

**Key changes:**

1. Replace Sheet imports with Dialog:
```typescript
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
```

2. Add Tabs imports:
```typescript
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
```

3. Remove ALL Supabase imports - no createClient

4. Structure the component:
```typescript
export function ContactDetailSheet({ contact, open, onOpenChange, onUpdate }: ContactDetailSheetProps) {
  const [activeTab, setActiveTab] = useState('profile')

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[85vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <DialogTitle>{contact?.name || contact?.phone || 'Contact'}</DialogTitle>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={setActiveTab} className="flex-1 flex flex-col overflow-hidden">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="profile">Profile</TabsTrigger>
            <TabsTrigger value="documents">Documents</TabsTrigger>
            <TabsTrigger value="conversations">Conversations</TabsTrigger>
            <TabsTrigger value="notes">Notes</TabsTrigger>
          </TabsList>

          <div className="flex-1 overflow-auto mt-4">
            <TabsContent value="profile" className="m-0">
              {/* Profile fields - reuse existing editable fields */}
            </TabsContent>

            <TabsContent value="documents" className="m-0">
              <div className="text-sm text-muted-foreground p-4 text-center">
                No documents yet
              </div>
            </TabsContent>

            <TabsContent value="conversations" className="m-0">
              <div className="text-sm text-muted-foreground p-4 text-center">
                Conversations will appear here
              </div>
            </TabsContent>

            <TabsContent value="notes" className="m-0">
              {/* Notes list + add note form */}
            </TabsContent>
          </div>
        </Tabs>
      </DialogContent>
    </Dialog>
  )
}
```

**Profile tab content:**
- Keep the existing editable fields (name, email, phone, status, tags, assigned_to)
- Use the existing inline edit pattern with Input components
- Keep the updateContact mutation via API route

**Notes tab content:**
- Show list of notes (from existing contact.notes or contactNotes query)
- Add note form at bottom
- Each note shows: content, created_at, created_by
- Use /api/contacts/[id]/notes endpoint for CRUD

**Documents and Conversations tabs:**
- Placeholder for now (empty state message)
- Will be implemented when inbox is rebuilt

**Remove old code:**
- Delete loadMessages function (uses Supabase directly)
- Delete loadActivities function (uses Supabase directly)
- Remove Supabase realtime subscription
- Remove chat/message display code

**Keep:**
- Score breakdown display (from metadata)
- Tag management
- Status dropdown
- Assigned to dropdown
  </action>
  <verify>
1. `grep -c "supabase" src/app/\(dashboard\)/\[workspace\]/database/contact-detail-sheet.tsx` returns 0
2. File contains "Dialog" import
3. File contains "Tabs" import
4. `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
Contact detail converted to Dialog with 4 tabs. Profile tab has editable fields. No Supabase imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Notes API endpoint and implement Notes tab</name>
  <files>
src/app/api/contacts/[id]/notes/route.ts
src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
  </files>
  <action>
**Create the Notes API endpoint:**

```typescript
// src/app/api/contacts/[id]/notes/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@clerk/nextjs/server'
import { ConvexHttpClient } from 'convex/browser'
import { api } from 'convex/_generated/api'

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

  const { id } = await params
  const notes = await convex.query(api.contactNotes.getByContact, { contact_id: id as any })
  return NextResponse.json({ notes })
}

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

  const { id } = await params
  const body = await request.json()

  const note = await convex.mutation(api.contactNotes.create, {
    contact_id: id as any,
    content: body.content,
    user_id: userId,
    due_date: body.due_date || undefined,
  })

  return NextResponse.json({ note })
}
```

**In contact-detail-sheet.tsx Notes TabContent:**

```typescript
<TabsContent value="notes" className="m-0 space-y-4">
  {/* Add note form */}
  <form onSubmit={handleAddNote} className="space-y-2">
    <Textarea
      value={newNote}
      onChange={(e) => setNewNote(e.target.value)}
      placeholder="Add a note..."
      className="min-h-[80px]"
    />
    <div className="flex justify-end">
      <Button type="submit" size="sm" disabled={!newNote.trim()}>
        Add Note
      </Button>
    </div>
  </form>

  {/* Notes list */}
  <div className="space-y-3">
    {notes.map((note) => (
      <div key={note._id} className="p-3 bg-muted/50 rounded-lg">
        <p className="text-sm">{note.content}</p>
        <p className="text-xs text-muted-foreground mt-1">
          {format(new Date(note.created_at), 'MMM d, yyyy h:mm a')}
        </p>
      </div>
    ))}
    {notes.length === 0 && (
      <p className="text-sm text-muted-foreground text-center py-4">
        No notes yet
      </p>
    )}
  </div>
</TabsContent>
```

Use TanStack Query to fetch and cache notes:
```typescript
const { data: notesData } = useQuery({
  queryKey: ['contact-notes', contact?.id],
  queryFn: async () => {
    const res = await fetch(`/api/contacts/${contact.id}/notes`)
    return res.json()
  },
  enabled: !!contact?.id && activeTab === 'notes',
})
```
  </action>
  <verify>
1. Notes API route file exists
2. Notes tab shows empty state when no notes
3. Add note form submits and note appears in list
4. `npm run build` succeeds
  </verify>
  <done>
Notes API endpoint created. Notes tab displays notes list and allows adding new notes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify dialog works in database page</name>
  <files>None</files>
  <action>
Start dev server and test the contact detail dialog:

```bash
npm run dev
```

Navigate to http://localhost:3000/eagle-overseas/database

Test:
1. Click on a contact row - dialog should open (centered modal)
2. Dialog shows 4 tabs at top
3. Profile tab shows contact fields (name, email, phone, etc.)
4. Can edit a field and save
5. Documents tab shows placeholder
6. Conversations tab shows placeholder
7. Notes tab shows notes list (may be empty)
8. Can add a note
9. Dialog closes when clicking X or outside

If database-client.tsx references the old Sheet behavior, update it to work with Dialog:
- The onOpenChange prop should still work the same
- The component name can stay ContactDetailSheet (even though it's now a Dialog)
  </action>
  <verify>
1. Dialog opens when clicking contact
2. All 4 tabs are visible and clickable
3. Profile fields are editable
4. Notes can be added
5. No console errors
  </verify>
  <done>
Contact detail dialog works with 4 tabs. Profile editable, notes functional.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. Contact detail opens as centered dialog (not sliding sheet)
3. 4 tabs visible: Profile, Documents, Conversations, Notes
4. Profile tab has editable fields that save
5. Notes tab has add form and displays notes
6. No Supabase imports anywhere in contact detail code
</verification>

<success_criteria>
- Contact detail is Dialog (modal), not Sheet
- 4-tab interface implemented per CONTEXT.md decision
- Profile fields inline editable
- Notes tab functional (view + add)
- Documents and Conversations show placeholder
- Zero Supabase imports
</success_criteria>

<output>
After completion, create `.planning/phases/v3.2-01-supabase-deletion-database/01-03-SUMMARY.md`
</output>
