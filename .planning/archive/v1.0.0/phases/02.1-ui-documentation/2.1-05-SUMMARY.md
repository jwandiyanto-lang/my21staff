---
phase: 02.1-ui-documentation
plan: 05
subsystem: database
tags: [contact-merge, lead-scoring, ui-fixes, data-integrity]

# Dependency graph
requires:
  - phase: 02-02
    provides: Production deployment at https://www.my21staff.com
  - phase: 02-03
    provides: Production verification with 23 bugs documented
provides:
  - Working contact merge operation with tags union and conversation transfer
  - Clean lead score UI without dummy data placeholders
  - Fixed primary/secondary contact selection in merge dialog
affects: [database-operations, contact-management, lead-qualification]

# Tech tracking
tech-stack:
  added: []
  patterns: [tags-union-merge, contact-consolidation-flow]

key-files:
  created: []
  modified:
    - src/app/(dashboard)/[workspace]/database/merge-contacts-dialog.tsx
    - src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
    - convex/contacts.ts

key-decisions:
  - "Tags automatically merged (union of both contacts) instead of user selection"
  - "Primary contact determined by user's name field selection"
  - "Chat score removed until Phase 3 bot integration (was dummy data)"
  - "Lead score now shows only form score until bot conversations are live"

patterns-established:
  - "Contact merge respects user's primary contact choice across all fields"
  - "Auto-merge fields (tags, metadata) shown as read-only preview in UI"
  - "Placeholder messages for unavailable features (chat scoring) with context"

# Metrics
duration: 4min
completed: 2026-01-29
---

# Phase 2.1 Plan 05: Contact Merge & Lead Score Fixes Summary

**Contact merge now correctly consolidates duplicates with tags union and real lead scores displayed (dummy data removed)**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-29T06:11:24Z
- **Completed:** 2026-01-29T06:14:58Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments
- Fixed contact merge to respect user's primary contact selection (based on name field)
- Implemented automatic tags union (no user selection needed)
- Removed all dummy chat score data (was hardcoded to 47 pts with fake conversation outcomes)
- Lead score now shows real form score and placeholder for unavailable chat score

## Task Commits

Each task was committed atomically:

1. **Task 1: Investigate and fix merge contacts failure** - `5cca2b1` (fix)
2. **Task 2: Deploy and verify merge in production** - (deployment via git push)
3. **Task 3: Remove dummy data from lead score chat component** - `7e28f12` (fix)

**Plan metadata:** Will be committed with SUMMARY.md

## Files Created/Modified
- `src/app/(dashboard)/[workspace]/database/merge-contacts-dialog.tsx` - Fixed primary/secondary selection logic, added tags auto-merge UI
- `src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx` - Removed hardcoded chat score (47 pts), replaced with placeholder
- `convex/contacts.ts` - Merge mutation already correct (no changes needed)

## Decisions Made

**1. Tags auto-merged instead of user selection**
- Rationale: Tags should be combined (union) from both contacts, not chosen from one
- Implementation: UI shows read-only preview of merged tags
- User only selects scalar fields (name, email, phone, status, score)

**2. Primary contact determined by name field selection**
- Rationale: User's name choice indicates which contact they want to keep
- Implementation: Primary/secondary IDs passed to mutation based on name selection
- Ensures metadata precedence and conversation transfer work correctly

**3. Chat score removed until Phase 3**
- Rationale: Hardcoded dummy data (47 pts with fake outcomes) was confusing
- Implementation: Set to 0, show "Not calculated" in UI
- TODO added for Phase 3 bot integration when real chat scoring available

## Deviations from Plan

None - plan executed exactly as written. All fixes implemented as specified.

## Issues Encountered

**Issue: Merge dialog always used contact1 as primary**
- Problem: Original code hardcoded `primaryId: contact1.id` regardless of user selection
- Solution: Changed to respect user's name field choice for determining primary contact
- Impact: Merge now correctly consolidates into user's chosen contact

**Issue: Tags required user selection but should auto-merge**
- Problem: Plan specified tags should be union of both, but UI showed radio buttons
- Solution: Display tags as read-only "Auto-merged" field with preview
- Impact: User no longer needs to select tags (reduces merge steps by 1)

**Issue: Chat score showed dummy data confusing users**
- Problem: Hardcoded 47 pts with fake conversation outcomes (IELTS, Budget, etc)
- Solution: Removed all dummy data, show placeholder explaining not yet calculated
- Impact: Clear expectation that chat scoring comes in Phase 3 (bot integration)

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for:**
- Contact merge workflow fully functional (duplicate consolidation works)
- Lead scoring display accurate (form score only until bot integration)
- Database operations continue (merge tested in production)

**Blockers resolved:**
- Issue #5: Merge contacts operation now works correctly
- Issue #6: Lead score chat component shows real data (no dummy values)

**Remaining Phase 2.1 bugs:**
- 5 critical bugs remaining (down from 7 after this plan)
- Next targets: Inbox filter tabs, form field activation

---
*Phase: 02.1-ui-documentation*
*Completed: 2026-01-29*
