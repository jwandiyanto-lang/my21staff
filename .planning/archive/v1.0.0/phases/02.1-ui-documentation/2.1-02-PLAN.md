---
phase: 02.1-ui-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/contacts/[id]/route.ts
  - convex/contacts.ts
  - src/app/(dashboard)/[workspace]/database/database-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can update a contact and changes persist"
    - "User can delete a contact and it disappears from the list"
    - "Status toggle changes only the selected contact (not all contacts)"
  artifacts:
    - path: "src/app/api/contacts/[id]/route.ts"
      provides: "PATCH and DELETE endpoints for contact operations"
      exports: ["PATCH", "DELETE"]
    - path: "convex/contacts.ts"
      provides: "update and remove mutations"
      exports: ["update", "remove"]
    - path: "src/app/(dashboard)/[workspace]/database/database-client.tsx"
      provides: "Contact table with status toggle UI"
      contains: "status toggle handler"
  key_links:
    - from: "src/app/(dashboard)/[workspace]/database/database-client.tsx"
      to: "/api/contacts/[id]"
      via: "fetch PATCH/DELETE"
      pattern: "fetch.*contacts/.*method.*PATCH|DELETE"
    - from: "src/app/api/contacts/[id]/route.ts"
      to: "convex/contacts"
      via: "Convex mutations"
      pattern: "api\\.contacts\\.(update|remove)"
---

<objective>
Fix database mutation failures for contact update, delete, and status toggle operations (Issues #8, #9, #10).

Purpose: Core contact management workflows are broken in production. Users cannot update contact details, delete contacts, or change lead status. Most critically, Issue #10 is a data integrity bug where changing one contact's status affects ALL contacts simultaneously. These operations must work correctly before Phase 3.

Output: Working contact PATCH/DELETE endpoints, reliable status toggle affecting only selected contact, complete CRUD functionality for contact management.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/.planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/.planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/.planning/STATE.md
@/home/jfransisco/Desktop/21/my21staff/.planning/phases/02-production-deployment/02-03-SUMMARY.md

# Database mutation files
@/home/jfransisco/Desktop/21/my21staff/src/app/api/contacts/[id]/route.ts
@/home/jfransisco/Desktop/21/my21staff/convex/contacts.ts
@/home/jfransisco/Desktop/21/my21staff/convex/schema.ts
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/database/database-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate database mutation failures</name>
  <files>
    src/app/api/contacts/[id]/route.ts
    convex/contacts.ts
  </files>
  <action>
Test the three failing operations at https://www.my21staff.com/eagle-overseas/database and capture error details:

1. **Update contact:** Open contact detail sheet, edit name, save - check Network tab for PATCH request
2. **Delete contact:** Select contact, click delete - check Network tab for DELETE request
3. **Status toggle:** Toggle any contact's status dropdown - observe behavior

For each failure, document:
- HTTP status code and error message
- Request payload structure
- Convex function being called
- Any authentication or authorization errors

Read the API route and Convex mutations to identify root causes:
- Check if Convex mutations exist and are properly exported
- Verify contact ID is being correctly extracted from route params
- Check if workspace validation is preventing updates
- Look for incorrect mutation arguments or missing fields
- Verify update/delete mutations have proper permission checks

**Special investigation for Issue #10 (status toggle affects all contacts):**
- Check if contact ID is being passed to status update mutation
- Look for incorrect query logic that might be updating all records
- Verify the status toggle UI is sending the correct contact ID
- Check for frontend state management bugs causing UI to update all rows
  </action>
  <verify>
Document findings with specific error messages, HTTP status codes, and line numbers of problematic code.
  </verify>
  <done>
Root causes for all three mutation failures identified and documented. Issue #10 root cause specifically identified (missing contact ID, incorrect mutation filter, or UI state bug).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix contact update and delete mutations</name>
  <files>
    src/app/api/contacts/[id]/route.ts
    convex/contacts.ts
  </files>
  <action>
Based on findings from Task 1, fix the PATCH and DELETE endpoints:

**PATCH /api/contacts/[id] (Update):**
- Ensure contact ID is extracted correctly from params.id
- Validate user has permission to update contact (workspace membership check)
- Parse request body and validate fields
- Call convex/contacts.update mutation with correct arguments
- Handle errors gracefully with proper status codes
- Return updated contact data

**DELETE /api/contacts/[id] (Delete):**
- Ensure contact ID is extracted correctly from params.id
- Validate user has permission to delete contact
- Call convex/contacts.remove mutation with contact ID
- Handle cascade deletions (notes, conversations if needed)
- Return 204 No Content on success
- Handle errors with proper status codes

**Convex mutations (convex/contacts.ts):**
- Ensure update() mutation accepts { id, ...fields } and uses ctx.db.patch()
- Ensure remove() mutation accepts { id } and uses ctx.db.delete()
- Add workspace validation in both mutations
- Add existence checks before updating/deleting
- Return appropriate data or throw errors with clear messages

Reference working patterns from other Convex mutations in the codebase.

Test locally first: `npm run dev`, test at http://localhost:3000/demo/database
  </action>
  <verify>
Local testing:
1. Edit contact name at localhost:3000/demo/database - saves successfully
2. Delete contact - removes from list
3. Check console for no errors

Production testing after deployment:
1. Visit https://www.my21staff.com/eagle-overseas/database
2. Edit contact - PATCH returns 200, changes persist
3. Delete contact - DELETE returns 204, contact removed
  </verify>
  <done>
Contact update and delete operations work correctly. PATCH and DELETE endpoints return proper status codes. Issues #8 and #9 resolved.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix critical status toggle bug (Issue #10)</name>
  <files>
    src/app/(dashboard)/[workspace]/database/database-client.tsx
    convex/contacts.ts
  </files>
  <action>
This is the CRITICAL data integrity bug: changing one contact's status changes ALL contacts.

**Root cause will be one of:**
1. **Frontend state bug:** React state updating all rows instead of single row
2. **Missing contact ID:** Status update mutation not filtering by contact ID
3. **Incorrect mutation logic:** Update query using wrong filter (e.g., by workspace instead of by contact ID)

**Investigation steps:**
1. Read database-client.tsx status toggle handler
2. Check if contact ID is passed to the mutation/API call
3. Read convex/contacts.ts status update mutation
4. Check mutation filter - must use `ctx.db.get(contactId)` or `ctx.db.patch(contactId, { status })`

**Fix based on root cause:**

**If frontend state bug:**
- Update only the specific row in local state after status change
- Use contact.id to filter which row to update
- Example: `setContacts(prev => prev.map(c => c.id === contactId ? {...c, status: newStatus} : c))`

**If missing contact ID in mutation:**
- Ensure status toggle handler passes contact ID to API
- Fix API route to forward contact ID to Convex mutation
- Example: `await api.contacts.updateStatus({ id: contactId, status })`

**If incorrect mutation filter:**
- Change mutation to use contact ID, not workspace or other filter
- Correct pattern: `await ctx.db.patch(args.id, { status: args.status })`
- Wrong pattern: `await ctx.db.query("contacts").filter(q => q.eq(q.field("workspaceId"), workspaceId)).collect()` then updating all

**After fix:**
- Test status toggle affects ONLY the selected contact
- Verify other contacts remain unchanged
- Test with multiple contacts to confirm isolation
  </action>
  <verify>
At https://www.my21staff.com/eagle-overseas/database:
1. Select Contact A, note its current status
2. Select Contact B, change status from "New" to "Hot"
3. Verify Contact B status changed to Hot
4. Verify Contact A status did NOT change (still original status)
5. Reload page, verify statuses persisted correctly
6. Repeat with 3+ contacts to confirm no cross-contamination

Issue #10 resolved: Status toggle is contact-specific, not global.
  </verify>
  <done>
Status toggle changes only the selected contact. Verified with multiple contacts - each retains independent status. Data integrity bug (Issue #10) resolved.
  </done>
</task>

</tasks>

<verification>
**Contact Update (Issue #8):**
- Edit contact name at https://www.my21staff.com/eagle-overseas/database
- PATCH /api/contacts/[id] returns 200 OK
- Changes persist after reload

**Contact Delete (Issue #9):**
- Delete contact from database view
- DELETE /api/contacts/[id] returns 204 No Content
- Contact removed from list permanently

**Status Toggle (Issue #10 - CRITICAL):**
- Change Contact A status to "Hot"
- Verify Contact B and C status unchanged
- Reload page, verify isolation maintained
- No global status contamination

**Overall:**
All three database mutation issues (#8, #9, #10) resolved and verified in production.
</verification>

<success_criteria>
**Must be TRUE:**
1. Contact update saves successfully and persists
2. Contact delete removes only selected contact
3. Status toggle affects ONLY the selected contact (not all contacts)
4. All database mutations return proper HTTP status codes
5. No data integrity bugs remain
6. Issues #8, #9, #10 from verification report are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-ui-documentation/2.1-02-SUMMARY.md` following the template structure with:
- Performance metrics (duration, files modified)
- Accomplishments (database CRUD restored)
- Root cause analysis for Issue #10 (critical data integrity bug)
- Verification results (all 3 mutation types working)
- Impact (contact management workflows fully functional)
</output>
