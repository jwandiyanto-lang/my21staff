---
phase: 05-implementation
plan: 02
type: execute
wave: 1
depends_on: [05-01]
files_modified: [convex/mutations.ts, convex/messages.ts, convex/contacts.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Contacts can be created, updated, deleted via Convex mutations"
    - "Messages can be created and conversations updated via Convex mutations"
    - "Conversations can be assigned and marked as read via Convex mutations"
  artifacts:
    - path: "convex/mutations.ts"
      provides: "CRUD operations for all tables"
      exports: ["createContact", "updateContact", "createMessage", "markConversationRead"]
    - path: "convex/contacts.ts"
      provides: "Contact query functions"
      exports: ["getByPhone", "getContextByPhone", "listByWorkspace"]
    - path: "convex/messages.ts"
      provides: "Message query and mutation functions"
      exports: ["listByConversation", "create", "markRead"]
  key_links:
    - from: "convex/mutations.ts"
      to: "convex/lib/auth.ts"
      via: "requireWorkspaceMembership()"
      pattern: "requireWorkspaceMembership"
    - from: "convex/messages.ts"
      to: "convex/mutations.ts"
      via: "Mutation imports"
      pattern: "import.*mutations"
---

<objective>
Create Convex mutations and query functions for all CRUD operations needed by Next.js API routes.

Purpose: Replace Supabase database operations with Convex functions for contacts, messages, and conversations.

Output: Complete Convex functions for contacts, messages, conversations with authorization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@convex/schema.ts
@convex/lib/auth.ts
@convex/contacts.ts
@convex/conversations.ts
@.planning/phases/05-implementation/05-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Create contact mutations (create, update, delete)</name>
  <files>convex/mutations.ts</files>
  <action>
    Create convex/mutations.ts with contact CRUD operations:

    1. createContact - creates new contact with normalization
       - Takes: workspace_id, phone, name, email, tags, metadata, source
       - Normalizes phone (remove non-digits)
       - Sets lead_status='new', lead_score=0, kapso_name, cache_updated_at
       - Returns created contact ID

    2. updateContact - updates contact fields
       - Takes: contact_id, workspace_id, updates (name, email, lead_status, lead_score, tags, assigned_to, etc.)
       - Verifies workspace membership
       - Returns updated contact

    3. deleteContact - soft delete contact
       - Takes: contact_id, workspace_id
       - Verifies workspace membership
       - Deletes from Convex (no soft delete needed - fresh start)

    All mutations use requireWorkspaceMembership() for authorization.
    Use v.optional(v.any()) for fields like metadata.
  </action>
  <verify>cat convex/mutations.ts | grep -E "(createContact|updateContact|deleteContact)"</verify>
  <done>Contact mutations created with workspace authorization</done>
</task>

<task type="auto">
  <name>Create message and conversation mutations</name>
  <files>convex/mutations.ts</files>
  <action>
    Add to convex/mutations.ts message/conversation operations:

    1. createMessage - creates outbound message
       - Takes: conversation_id, workspace_id, content, direction='outbound', sender_type='user', sender_id, message_type='text', kapso_message_id, metadata
       - Verifies workspace membership
       - Creates message record
       - Updates conversation.last_message_at, last_message_preview

    2. markConversationRead - clears unread count
       - Takes: conversation_id, workspace_id
       - Verifies workspace membership
       - Sets unread_count=0

    3. updateConversationStatus - changes status (open/closed/handover)
       - Takes: conversation_id, workspace_id, status
       - Verifies workspace membership
       - Updates status field

    4. assignConversation - assigns to user
       - Takes: conversation_id, workspace_id, assigned_to (user_id or null)
       - Verifies workspace membership
       - Updates assigned_to field

    All mutations use requireWorkspaceMembership() for authorization.
  </action>
  <verify>cat convex/mutations.ts | grep -E "(createMessage|markConversationRead|assignConversation)"</verify>
  <done>Message and conversation mutations created</done>
</task>

<task type="auto">
  <name>Create webhook mutations for Kapso integration</name>
  <files>convex/mutations.ts</files>
  <action>
    Add webhook processing mutations to convex/mutations.ts:

    1. upsertContact - get or create contact by phone (for inbound messages)
       - Takes: workspace_id, phone, name (from WhatsApp profile)
       - Normalizes phone, sets phone_normalized
       - Updates kapso_name, cache_updated_at if contact exists
       - Returns contact ID

    2. upsertConversation - get or create conversation
       - Takes: workspace_id, contact_id
       - Creates conversation with status='open', unread_count=0 if new
       - Returns conversation ID

    3. createInboundMessage - creates inbound message from webhook
       - Takes: conversation_id, workspace_id, phone, message (id, type, text body, media url, etc.)
       - Creates message with direction='inbound', sender_type='contact'
       - Updates conversation.unread_count (+1), last_message_at, last_message_preview
       - Stores reply context in metadata if present (reply_to_kapso_id, reply_to_from)

    These mutations are used by Kapso webhook HTTP action in Plan 04.
  </action>
  <verify>cat convex/mutations.ts | grep -E "(upsertContact|upsertConversation|createInboundMessage)"</verify>
  <done>Webhook mutations for Kapso integration created</done>
</task>

<task type="auto">
  <name>Create messages query functions</name>
  <files>convex/messages.ts</files>
  <action>
    Create convex/messages.ts with query functions:

    1. listByConversation - lists messages for a conversation
       - Args: conversation_id, workspace_id, limit=100
       - Verifies workspace membership
       - Orders by created_at DESC (newest first)
       - Uses by_conversation_time index

    2. getById - gets single message
       - Args: message_id, workspace_id
       - Verifies workspace membership
       - Returns message with conversation info

    Use existing by_conversation_time index for efficient queries.
    All queries use requireWorkspaceMembership() for authorization.
  </action>
  <verify>cat convex/messages.ts | grep -E "(listByConversation|getById)"</verify>
  <done>Message query functions created with indexes</done>
</task>

<task type="auto">
  <name>Extend contact query functions for inbox</name>
  <files>convex/contacts.ts</files>
  <action>
    Add to convex/contacts.ts additional queries needed by inbox:

    1. listByWorkspace - lists contacts with filters
       - Args: workspace_id, limit, assigned_to (optional), lead_status (optional)
       - Verifies workspace membership
       - Uses by_workspace or by_assigned index based on filters
       - Orders by created_at DESC

    2. listByTag - lists contacts with specific tag
       - Args: workspace_id, tag
       - Verifies workspace membership
       - Filters contacts array for tag match (since no tag index)

    Update existing getContextByPhone to use updated schema fields (kapso_name, phone_normalized).
    Keep existing getByPhone function as-is (it's already efficient).
  </action>
  <verify>cat convex/contacts.ts | grep -E "(listByWorkspace|listByTag)"</verify>
  <done>Contact query functions extended for inbox filters</done>
</task>

</tasks>

<verification>
1. convex/mutations.ts exists with all CRUD mutations
2. convex/messages.ts exists with query functions
3. All mutations use requireWorkspaceMembership() for authorization
4. Functions match Next.js API route needs (createMessage, upsertContact, etc.)
</verification>

<success_criteria>
1. All CRUD operations available via Convex mutations
2. All mutations include workspace authorization checks
3. Query functions use appropriate indexes for performance
4. Next.js API routes can be updated to use these functions
</success_criteria>

<output>
After completion, create `.planning/phases/05-implementation/05-02-SUMMARY.md`
</output>
