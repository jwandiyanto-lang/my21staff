---
phase: 05-implementation
plan: 07
type: execute
wave: 5
depends_on: [05-01, 05-02, 05-03, 05-04, 05-05, 05-06]
files_modified: [convex.json, package.json, scripts/migrate-convex.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Convex project deployed to production"
    - "HTTP actions accessible (Kapso webhook works)"
    - "All API routes return sub-500ms P95"
  artifacts:
    - path: "deployment-log.txt"
      provides: "Deployment record"
      contains: "npx convex deploy output"
    - path: "convex-test-results.txt"
      provides: "Performance verification"
      contains: "P95 response times"
  key_links:
    - from: "deployment-log.txt"
      to: "Vercel deployment"
      via: "vercel --prod"
      pattern: "vercel.*deploy"
    - from: "convex-test-results.txt"
      to: "Phase 5 verification"
      via: "metrics comparison"
      pattern: "P95.*37ms|P95.*<500ms"
---

<objective>
Deploy Convex to production, verify HTTP actions work, and benchmark performance against 500ms target.

Purpose: Complete migration by deploying all Convex functions and confirming sub-500ms response times.

Output: Deployed Convex backend with verified performance metrics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@convex/json
@convex/schema.ts
@.planning/phases/10-convex-spike/03-06-SUMMARY.md
@.planning/phases/05-implementation/05-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Deploy Convex functions to production</name>
  <files>convex/_generated/*.d.ts</files>
  <action>
    Run npx convex deploy to push all functions, schema, and HTTP actions:

    Command: npx convex deploy --verbose

    This deploys:
    - Updated schema (workspaces with by_kapso_phone index, etc.)
    - All query functions (contacts, conversations, messages, workspaces, workspaceMembers)
    - All mutation functions (CRUD, webhook processing)
    - HTTP actions (Kapso webhook, contacts HTTP)
    - Scheduled functions (webhook processing, ARI)

    Check for deployment errors. If any, fix and redeploy.
  </action>
  <verify>grep "Success\|Failed" deployment-log.txt || npx convex deploy --dry-run 2>&1 | tee deployment-log.txt | grep "Success\|Failed"</verify>
  <done>Convex functions deployed to production</done>
</task>

<task type="auto">
  <name>Test Kapso webhook HTTP action</name>
  <files>scripts/test-webhook.ts</files>
  <action>
    Create and run webhook test:

    1. Create scripts/test-webhook.ts:
       - Send test POST to Convex webhook URL
       - Use CRM_API_KEY for authentication
       - Send sample Meta/WhatsApp payload
       - Verify response status 200

    2. Run test: tsx scripts/test-webhook.ts

    3. Verify webhook processed:
       - Check Convex dashboard for new messages
       - Verify contacts/conversations/messages created

    The webhook URL format: https://intent-otter-212.convex.cloud/api/webhook/kapso

    Note: Need to update Kapso dashboard to point to Convex webhook URL (after test passes).
  </action>
  <verify>grep "200 OK\|received.*true" scripts/test-webhook-output.txt 2>/dev/null || curl -X POST "https://intent-otter-212.convex.cloud/api/webhook/kapso" -H "x-api-key: $CRM_API_KEY" -d '{"entry":[]}' | grep "received"</verify>
  <done>Kapso webhook HTTP action responds correctly</done>
</task>

<task type="auto">
  <name>Benchmark hot path API response times</name>
  <files>scripts/benchmark-convex.ts</files>
  <action>
    Run performance benchmark on hot paths:

    1. Create scripts/benchmark-convex.ts:
       - Test /api/contacts/by-phone (50 iterations)
       - Test /api/conversations (50 iterations)
       - Test /api/messages/send (10 iterations)
       - Calculate P50, P95, P99, mean

    2. Run benchmark: tsx scripts/benchmark-convex.ts

    3. Compare against 500ms target:
       - P95 must be < 500ms
       - If not, investigate and optimize

    4. Save results to convex-test-results.txt

    Expected results based on Phase 3: P95 ~37ms (well under target).
  </action>
  <verify>grep "P95" convex-test-results.txt | awk '{print $2}' | head -1</verify>
  <done>Hot path API P95 < 500ms verified</done>
</task>

<task type="auto">
  <name>Deploy Next.js to Vercel</name>
  <files></files>
  <action>
    Deploy updated Next.js app to Vercel:

    Command: vercel --prod

    This deploys:
    - Updated API routes using Convex
    - Updated React Query hooks using Convex
    - Removed Supabase subscriptions from inbox

    After deployment, verify:
    - Inbox loads and shows conversations
    - Messages send successfully
    - Real-time updates work (send message via Kapso, appears in inbox)

    Note: Update Kapso webhook URL to new Vercel endpoint if still using Next.js webhook.
    Since Plan 04 created Convex webhook, update Kapso to point to Convex URL.
  </action>
  <verify>vercel ls | grep $(git rev-parse --abbrev-ref HEAD)</verify>
  <done>Next.js deployed to Vercel production</done>
</task>

<task type="auto">
  <name>Update Kapso webhook URL</name>
  <files></files>
  <action>
    Update Kapso dashboard to use Convex webhook:

    New webhook URL: https://intent-otter-212.convex.cloud/api/webhook/kapso

    Actions:
    1. Log current Kapso webhook URL (from dashboard or env)
    2. Document migration: change Next.js webhook URL to Convex URL
    3. Update Kapso dashboard via API or manual (if no API)
    4. Verify webhook signature verification (KAPSO_WEBHOOK_SECRET set in Convex env)

    This is a user action if Kapso dashboard has no API.
    For planning, document the required change.
  </action>
  <verify>echo "Kapso webhook URL update: https://intent-otter-212.convex.cloud/api/webhook/kapso (documented for manual update)" > webhook-migration.txt && cat webhook-migration.txt</verify>
  <done>Kapso webhook URL documented for migration</done>
</task>

<task type="auto">
  <name>Create deployment summary</name>
  <files>deployment-summary.md</files>
  <action>
    Create deployment-summary.md with:

    ## Convex Migration Complete

    - Convex project: intent-otter-212
    - Deployment date: [current date]
    - Environment: Production

    ### Performance Metrics
    - /api/contacts/by-phone P95: [from benchmark]
    - /api/conversations P95: [from benchmark]
    - /api/messages/send P95: [from benchmark]
    - Target: 500ms
    - Result: PASS/FAIL

    ### Kapso Webhook
    - Old URL: [Next.js URL - from Kapso dashboard]
    - New URL: https://intent-otter-212.convex.cloud/api/webhook/kapso
    - Action required: Update Kapso dashboard (manual step)

    ### Next.js Deployment
    - URL: https://my21staff.com
    - Status: Deployed

    ### Supabase
    - Kept for: Auth only (supabase.auth)
    - Removed: All CRM data queries
  </action>
  <verify>cat deployment-summary.md | grep -E "(Performance|Webhook|Supabase)"</verify>
  <done>Deployment summary documented</done>
</task>

</tasks>

<verification>
1. npx convex deploy completed successfully
2. Convex HTTP action /webhook/kapso responds 200
3. Benchmark results show P95 < 500ms for all hot paths
4. Next.js deployed to Vercel production
5. Kapso webhook URL documented for migration
6. Deployment summary created with all metrics
</verification>

<success_criteria>
1. Convex functions deployed to production environment
2. Kapso webhook accessible and processes messages correctly
3. API response times P95 < 500ms verified
4. Next.js app deployed with Convex integration
5. Supabase kept for auth only (data queries removed)
6. Migration complete - sub-500ms performance achieved
</success_criteria>

<output>
After completion, create `.planning/phases/05-implementation/05-07-SUMMARY.md`
</output>
