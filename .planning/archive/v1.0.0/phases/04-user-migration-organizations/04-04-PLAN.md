---
phase: 04-user-migration-organizations
plan: 04
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-03b"]
files_modified:
  - convex/http.ts
  - convex/organizations.ts
  - convex/schema.ts
autonomous: false
user_setup:
  - service: clerk
    why: "Organization webhooks need configuration"
    dashboard_config:
      - task: "Add organization webhook events"
        location: "Clerk Dashboard -> Webhooks -> Edit webhook -> Select organization.* events"

must_haves:
  truths:
    - "Organization membership syncs to Convex via webhook"
    - "New organization invitations work via Clerk"
    - "Owner role permissions enforced"
  artifacts:
    - path: "convex/http.ts"
      provides: "Organization webhook handlers"
      contains: "organization.membership"
    - path: "convex/organizations.ts"
      provides: "Organization CRUD mutations"
      exports: ["addMember", "removeMember", "updateMemberRole"]
  key_links:
    - from: "convex/http.ts"
      to: "convex/organizations.ts"
      via: "internal mutations"
      pattern: "internal\\.organizations"
    - from: "Clerk webhook"
      to: "convex/http.ts"
      via: "POST /webhook/clerk"
      pattern: "organization\\.membership"
---

<objective>
Implement Clerk organization webhooks and replace custom invitation system.

Purpose: Enable Clerk-native team invitations and organization management
Output: Organization membership syncs via webhook, invitations work through Clerk
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-migration-organizations/04-02-SUMMARY.md
@.planning/phases/04-user-migration-organizations/04-03-SUMMARY.md
@.planning/phases/04-user-migration-organizations/04-03b-SUMMARY.md
@convex/http.ts
@convex/schema.ts
@convex/workspaceMembers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add organization table and mutations</name>
  <files>convex/schema.ts, convex/organizations.ts</files>
  <action>
1. **Update schema.ts** - Add organizations table:

```typescript
// Organizations (synced from Clerk)
organizations: defineTable({
  clerk_org_id: v.string(),          // Clerk organization ID
  workspace_id: v.id("workspaces"),   // Link to existing workspace
  name: v.string(),
  slug: v.string(),
  created_at: v.number(),
  updated_at: v.number(),
})
  .index("by_clerk_org_id", ["clerk_org_id"])
  .index("by_workspace", ["workspace_id"]),

// Organization members (synced from Clerk)
organizationMembers: defineTable({
  organization_id: v.id("organizations"),
  clerk_user_id: v.string(),          // Clerk user ID
  role: v.string(),                   // 'admin', 'member' (Clerk roles)
  created_at: v.number(),
  updated_at: v.number(),
})
  .index("by_org_user", ["organization_id", "clerk_user_id"])
  .index("by_user", ["clerk_user_id"]),
```

2. **Create convex/organizations.ts** with internalMutation handlers:

```typescript
// createOrganization - called by webhook on organization.created
// updateOrganization - called by webhook on organization.updated
// deleteOrganization - called by webhook on organization.deleted
// addMember - called by webhook on organizationMembership.created
// updateMemberRole - called by webhook on organizationMembership.updated
// removeMember - called by webhook on organizationMembership.deleted
```

Each mutation should be idempotent (check if exists before insert).

Link organizations to workspaces via public_metadata.convexWorkspaceId stored during migration.
  </action>
  <verify>
Run `npx convex dev` - schema deploys without errors
  </verify>
  <done>Organization schema and mutations exist</done>
</task>

<task type="auto">
  <name>Task 2: Extend webhook handler for organization events</name>
  <files>convex/http.ts</files>
  <action>
Update the Clerk webhook handler in http.ts to handle organization events:

```typescript
// Add to existing switch statement in webhook handler:

case "organization.created":
  await ctx.runMutation(internal.organizations.createOrganization, {
    clerk_org_id: data.id,
    name: data.name,
    slug: data.slug,
    workspace_id: data.public_metadata?.convexWorkspaceId, // From migration
  });
  break;

case "organization.updated":
  await ctx.runMutation(internal.organizations.updateOrganization, {
    clerk_org_id: data.id,
    name: data.name,
    slug: data.slug,
  });
  break;

case "organization.deleted":
  await ctx.runMutation(internal.organizations.deleteOrganization, {
    clerk_org_id: data.id,
  });
  break;

case "organizationMembership.created":
  await ctx.runMutation(internal.organizations.addMember, {
    clerk_org_id: data.organization.id,
    clerk_user_id: data.public_user_data.user_id,
    role: data.role, // 'admin' or 'member'
  });
  break;

case "organizationMembership.updated":
  await ctx.runMutation(internal.organizations.updateMemberRole, {
    clerk_org_id: data.organization.id,
    clerk_user_id: data.public_user_data.user_id,
    role: data.role,
  });
  break;

case "organizationMembership.deleted":
  await ctx.runMutation(internal.organizations.removeMember, {
    clerk_org_id: data.organization.id,
    clerk_user_id: data.public_user_data.user_id,
  });
  break;
```

Also log organization events to webhookAudit for debugging.
  </action>
  <verify>
Run `npx convex dev` - no TypeScript errors
  </verify>
  <done>Webhook handler processes organization events</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure organization webhooks in Clerk</name>
  <what-built>Webhook handlers for organization events</what-built>
  <action>
Add organization events to existing Clerk webhook:

1. Go to Clerk Dashboard -> Webhooks
2. Click on the existing webhook (pleasant-antelope-109.convex.site/webhook/clerk)
3. Under "Events", add:
   - organization.created
   - organization.updated
   - organization.deleted
   - organizationMembership.created
   - organizationMembership.updated
   - organizationMembership.deleted
4. Save changes
  </action>
  <how-to-verify>
1. Go to Clerk Dashboard -> Organizations
2. Add a test member to an organization
3. Check Convex Dashboard -> webhookAudit table for the event
4. Type "done" when webhook is configured and tested
  </how-to-verify>
  <resume-signal>Type "done" when organization webhooks are configured</resume-signal>
</task>

</tasks>

<verification>
1. Organization events appear in webhookAudit table
2. Adding member in Clerk -> creates record in organizationMembers
3. Removing member in Clerk -> deletes record in organizationMembers
4. No errors in Convex function logs
</verification>

<success_criteria>
- ORG-02: Clerk organization invitations replace custom invitation system
- ORG-03: Role-based permissions work with Clerk roles
- Organization membership syncs bidirectionally
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-migration-organizations/04-04-SUMMARY.md`
</output>
