---
phase: 08-sealion-kapso
plan: 01
type: execute
---

<objective>
Connect Sea Lion AI (Indonesian-focused LLM) to Kapso for automated WhatsApp responses.

Purpose: Enable AI-powered auto-replies in Bahasa Indonesia for customer inquiries.
Output: Working Kapso workflow that receives WhatsApp messages and sends Sea Lion AI responses.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-sealion-kapso/08-CONTEXT.md
@.planning/phases/06-kapso-live/06-01-SUMMARY.md

**Tech available:** Kapso webhook handler exists at /api/webhook/kapso
**Sea Lion API:** OpenAI-compatible at https://api.sea-lion.ai/v1
**Model:** aisingapore/Gemma-SEA-LION-v4-27B-IT

**Key constraint:** This phase is Kapso-side configuration, not Next.js code changes.
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Sea Lion API key in Kapso secrets</action>
  <instructions>
    1. Log in to Kapso dashboard: https://app.kapso.ai
    2. Navigate to Settings → Secrets
    3. Add new secret:
       - Name: `SEALION_API_KEY`
       - Value: [your Sea Lion API key]
    4. Save the secret
  </instructions>
  <verification>Secret appears in Kapso secrets list</verification>
  <resume-signal>Type "secret configured" when done</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Kapso Function for Sea Lion AI</action>
  <instructions>
    1. In Kapso dashboard, go to Functions
    2. Create new function named `sea-lion-reply`
    3. Paste this code:

    ```javascript
    async function handler(request, env) {
      const data = await request.json();
      const userMessage = data.message || data.body || '';

      if (!userMessage) {
        return new Response(JSON.stringify({ error: 'No message provided' }), {
          status: 400,
          headers: { 'Content-Type': 'application/json' }
        });
      }

      const response = await fetch('https://api.sea-lion.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${env.SEALION_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'aisingapore/Gemma-SEA-LION-v4-27B-IT',
          messages: [
            {
              role: 'system',
              content: `Kamu adalah asisten AI untuk my21staff, platform CRM WhatsApp untuk UMKM Indonesia.

Panduan:
- Jawab dalam Bahasa Indonesia yang ramah dan profesional
- Bantu pelanggan dengan pertanyaan tentang produk/layanan
- Jika tidak yakin, minta maaf dan sarankan menghubungi tim support
- Jaga jawaban tetap singkat dan jelas (max 2-3 paragraf)
- Gunakan bahasa yang mudah dipahami UMKM`
            },
            { role: 'user', content: userMessage }
          ],
          temperature: 0.7,
          max_tokens: 512
        })
      });

      if (!response.ok) {
        const error = await response.text();
        console.error('Sea Lion API error:', error);
        return new Response(JSON.stringify({
          reply: 'Maaf, terjadi kesalahan. Silakan coba lagi nanti.'
        }), {
          headers: { 'Content-Type': 'application/json' }
        });
      }

      const result = await response.json();
      const aiReply = result.choices?.[0]?.message?.content || 'Maaf, tidak dapat memproses permintaan.';

      return new Response(JSON.stringify({ reply: aiReply }), {
        headers: { 'Content-Type': 'application/json' }
      });
    }
    ```

    4. Deploy the function
    5. Test with sample input: `{"message": "Halo, apa itu my21staff?"}`
  </instructions>
  <verification>Function returns AI-generated Indonesian response</verification>
  <resume-signal>Type "function deployed" and paste sample response</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create Kapso Workflow for auto-reply</action>
  <instructions>
    1. In Kapso dashboard, go to Workflows
    2. Create new workflow named `AI Auto-Reply`
    3. Configure trigger:
       - Type: WhatsApp incoming message
       - Filter: All messages (or specific phone number if testing)

    4. Add action: Call Function
       - Function: `sea-lion-reply`
       - Input mapping: `{ "message": "{{message.text.body}}" }`

    5. Add action: Send WhatsApp Message
       - Recipient: `{{message.from}}`
       - Message: `{{function.reply}}`

    6. Activate the workflow
  </instructions>
  <verification>Workflow shows as active in Kapso dashboard</verification>
  <resume-signal>Type "workflow active" when done</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Sea Lion + Kapso AI auto-reply system</what-built>
  <how-to-verify>
    1. Send a test WhatsApp message to your Kapso-connected number
    2. Example: "Halo, apa itu my21staff?"
    3. Wait for AI response (should take 3-10 seconds)
    4. Verify response is in Bahasa Indonesia
    5. Verify response is helpful and professional
    6. Check Kapso logs for any errors
  </how-to-verify>
  <resume-signal>Type "approved" if working, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] SEALION_API_KEY secret configured in Kapso
- [ ] sea-lion-reply function deployed and responding
- [ ] AI Auto-Reply workflow active
- [ ] End-to-end test: WhatsApp message → AI response delivered
</verification>

<success_criteria>

- Sea Lion API key stored securely in Kapso
- Kapso function successfully calls Sea Lion API
- Workflow triggers on inbound WhatsApp messages
- AI responses are in Bahasa Indonesia
- Response sent back via WhatsApp within 10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/08-sealion-kapso/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Sea Lion + Kapso Summary

**[One-liner about what was configured]**

## Accomplishments

- [Kapso configurations made]
- [Function deployed]
- [Workflow activated]

## Configuration Details

- Function name: sea-lion-reply
- Workflow name: AI Auto-Reply
- Model: aisingapore/Gemma-SEA-LION-v4-27B-IT

## Issues Encountered

[Any API errors, workflow issues, or adjustments made]

## Next Step

Phase complete, ready for Phase 9: Sheets to Database
</output>
