---
phase: 22-settings-data-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  - src/app/api/contacts/export/route.ts
  - src/app/api/notes/export/route.ts
  - src/app/api/contacts/template/route.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can export contacts to CSV from Settings page"
    - "User can export notes to CSV from Settings page"
    - "User can download a CSV template for imports"
    - "Exported CSV includes all relevant fields"
  artifacts:
    - path: "src/app/api/contacts/export/route.ts"
      provides: "GET endpoint for contacts CSV export"
      exports: ["GET"]
    - path: "src/app/api/notes/export/route.ts"
      provides: "GET endpoint for notes CSV export"
      exports: ["GET"]
    - path: "src/app/api/contacts/template/route.ts"
      provides: "GET endpoint for CSV template download"
      exports: ["GET"]
  key_links:
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "/api/contacts/export"
      via: "Download button click"
      pattern: "api/contacts/export"
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "/api/notes/export"
      via: "Download button click"
      pattern: "api/notes/export"
---

<objective>
Add Data Management tab to Settings page with CSV export functionality for contacts and notes.

Purpose: Allow users to download their CRM data for backup, analysis, or migration purposes.
Output: Working export buttons that download CSV files with proper formatting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-settings-data-management/22-RESEARCH.md

@src/app/(dashboard)/[workspace]/settings/settings-client.tsx
@src/app/(dashboard)/[workspace]/settings/page.tsx
@src/lib/supabase/server.ts
@src/lib/auth/workspace-auth.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PapaParse and Create Export API Routes</name>
  <files>
    package.json
    src/app/api/contacts/export/route.ts
    src/app/api/notes/export/route.ts
    src/app/api/contacts/template/route.ts
  </files>
  <action>
1. Install PapaParse:
   ```bash
   npm install papaparse
   npm install -D @types/papaparse
   ```

2. Create contacts export endpoint at `src/app/api/contacts/export/route.ts`:
   - GET endpoint accepting `workspace` query param
   - Use `requireWorkspaceMembership` for auth
   - Query all contacts for workspace (name, phone, email, lead_status, lead_score, tags, assigned_to, created_at)
   - Use `Papa.unparse()` to convert to CSV
   - Convert tags array to comma-separated string
   - Return CSV with headers:
     - Content-Type: text/csv
     - Content-Disposition: attachment; filename="contacts-{timestamp}.csv"

3. Create notes export endpoint at `src/app/api/notes/export/route.ts`:
   - GET endpoint accepting `workspace` query param
   - Use `requireWorkspaceMembership` for auth
   - Query contact_notes with contact name (join contacts table)
   - Fields: contact_name, content, note_type, due_date, completed_at, created_at
   - Use `Papa.unparse()` to convert to CSV
   - Return CSV with proper headers

4. Create template endpoint at `src/app/api/contacts/template/route.ts`:
   - GET endpoint (no auth required for template)
   - Return CSV with headers and one example row:
     ```
     name,phone,email,tags,lead_status,lead_score
     John Doe,+6281234567890,john@example.com,"hot-lead, instagram",warm,75
     ```
   - Content-Disposition: attachment; filename="contacts-template.csv"

Use PapaParse patterns from 22-RESEARCH.md. Phone format should be E.164 (+62...).
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build should pass with no TypeScript errors.
  </verify>
  <done>
    Three API routes created: /api/contacts/export, /api/notes/export, /api/contacts/template
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Data Tab to Settings UI</name>
  <files>
    src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  </files>
  <action>
Add a new "Data" tab to the existing Settings page tabs:

1. Import new icons from lucide-react: `Download, FileSpreadsheet`

2. Add new TabsTrigger for "Data" tab after "Tags" tab:
   ```tsx
   <TabsTrigger value="data" className="gap-2">
     <FileSpreadsheet className="h-4 w-4" />
     Data
   </TabsTrigger>
   ```

3. Add TabsContent for "data" with two cards:

   Card 1: Export Data
   - Title: "Export Data"
   - Description: "Download your contacts and notes as CSV files"
   - Two download buttons side by side:
     - "Download Contacts" - triggers GET /api/contacts/export?workspace={id}
     - "Download Notes" - triggers GET /api/notes/export?workspace={id}
   - Use anchor tags with href and download attribute, or window.open()

   Card 2: Import Template
   - Title: "Import Template"
   - Description: "Download a CSV template to prepare your data for import"
   - Button: "Download Template" - triggers GET /api/contacts/template
   - Note: "Upload functionality coming soon" (placeholder for Plan 02)

4. Download implementation:
   ```tsx
   const handleExportContacts = () => {
     window.open(`/api/contacts/export?workspace=${workspace.id}`, '_blank')
   }
   ```

Style consistently with existing cards (same spacing, CardHeader/CardContent structure).
  </action>
  <verify>
    ```bash
    npm run dev
    ```
    Navigate to /{workspace}/settings, click "Data" tab, verify buttons are visible.
  </verify>
  <done>
    Data tab visible in Settings with Export Contacts, Export Notes, and Download Template buttons.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Export contacts downloads CSV with all contact fields
3. Export notes downloads CSV with note content and contact names
4. Template download provides valid CSV structure
5. All downloads work only for authenticated workspace members (except template)
</verification>

<success_criteria>
- [ ] PapaParse installed
- [ ] /api/contacts/export returns valid CSV
- [ ] /api/notes/export returns valid CSV
- [ ] /api/contacts/template returns template CSV
- [ ] Settings page has Data tab with working export buttons
</success_criteria>

<output>
After completion, create `.planning/phases/22-settings-data-management/22-01-SUMMARY.md`
</output>
