---
phase: 22-settings-data-management
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/leads/route.ts
  - src/app/pricing/page.tsx
autonomous: true

must_haves:
  truths:
    - "Pricing form submissions create contacts in my21staff workspace"
    - "Phone numbers are normalized to E.164 format"
    - "Contacts are tagged with 'pricing-form' and selected plan"
    - "Form metadata (business type, lead sources) is stored"
    - "Existing contacts are updated, not duplicated"
  artifacts:
    - path: "src/app/api/leads/route.ts"
      provides: "Public POST endpoint for pricing form"
      exports: ["POST"]
  key_links:
    - from: "src/app/pricing/page.tsx"
      to: "/api/leads"
      via: "fetch POST on form submit"
      pattern: "api/leads"
    - from: "src/app/api/leads/route.ts"
      to: "contacts table"
      via: "supabase insert/update"
      pattern: "supabase.*contacts"
---

<objective>
Create public API endpoint for pricing form to capture leads directly into CRM.

Purpose: Eliminate dependency on n8n webhook, store leads directly in my21staff workspace.
Output: Working /api/leads endpoint and updated pricing form submission.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-settings-data-management/22-RESEARCH.md

@src/app/pricing/page.tsx
@src/lib/supabase/server.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Public Leads API Endpoint</name>
  <files>
    src/app/api/leads/route.ts
    src/lib/utils/phone.ts
  </files>
  <action>
Create a public API endpoint at `src/app/api/leads/route.ts` for pricing form submissions.

**Important:** This endpoint is PUBLIC (no auth) - it's called from the pricing page before users are logged in.

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createApiAdminClient } from '@/lib/supabase/server'
import { normalizePhone, isValidPhone } from '@/lib/utils/phone'

// my21staff workspace ID for pricing form leads
const MY21STAFF_WORKSPACE_ID = '0318fda5-22c4-419b-bdd8-04471b818d17'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()

    // Extract form fields
    const {
      nama,
      whatsapp,
      jenisBisnis,
      dariManaTahu,
      leadSources,
      currentTracking,
      leadsPerMonth,
      masalahBisnis,
      teamSize,
      paket,
    } = body

    // Validate required fields
    if (!nama || !whatsapp) {
      return NextResponse.json(
        { error: 'Nama dan WhatsApp wajib diisi' },
        { status: 400 }
      )
    }

    // Normalize and validate phone
    const phone = normalizePhone(whatsapp)
    if (!isValidPhone(phone)) {
      return NextResponse.json(
        { error: 'Nomor WhatsApp tidak valid' },
        { status: 400 }
      )
    }

    const adminClient = createApiAdminClient()

    // Check for existing contact
    const { data: existing } = await adminClient
      .from('contacts')
      .select('id, tags')
      .eq('workspace_id', MY21STAFF_WORKSPACE_ID)
      .eq('phone', phone)
      .single()

    // Prepare tags: always include pricing-form, add plan if provided
    const newTags = ['pricing-form']
    if (paket) {
      newTags.push(paket.toLowerCase().replace(/\s+/g, '-'))
    }

    // Prepare metadata
    const metadata = {
      jenisBisnis,
      dariManaTahu,
      leadSources: typeof leadSources === 'string' ? leadSources : leadSources?.join(', '),
      currentTracking,
      leadsPerMonth,
      masalahBisnis,
      teamSize,
      paket,
      submittedAt: new Date().toISOString(),
    }

    if (existing) {
      // Update existing contact, merge tags
      const existingTags = existing.tags || []
      const mergedTags = [...new Set([...existingTags, ...newTags])]

      const { data: contact, error } = await adminClient
        .from('contacts')
        .update({
          name: nama,
          tags: mergedTags,
          metadata,
          updated_at: new Date().toISOString(),
        })
        .eq('id', existing.id)
        .select()
        .single()

      if (error) {
        console.error('Lead update error:', error)
        return NextResponse.json(
          { error: 'Gagal menyimpan data' },
          { status: 500 }
        )
      }

      return NextResponse.json({
        success: true,
        contact,
        status: 'updated',
      })
    }

    // Create new contact
    const { data: contact, error } = await adminClient
      .from('contacts')
      .insert({
        workspace_id: MY21STAFF_WORKSPACE_ID,
        phone,
        name: nama,
        lead_status: 'new',
        lead_score: 50, // Mid score - interested enough to fill form
        tags: newTags,
        metadata,
      })
      .select()
      .single()

    if (error) {
      console.error('Lead creation error:', error)
      return NextResponse.json(
        { error: 'Gagal menyimpan data' },
        { status: 500 }
      )
    }

    return NextResponse.json({
      success: true,
      contact,
      status: 'created',
    })
  } catch (error) {
    console.error('Leads API error:', error)
    return NextResponse.json(
      { error: 'Terjadi kesalahan server' },
      { status: 500 }
    )
  }
}
```

**Note:** If `src/lib/utils/phone.ts` doesn't exist yet (created in 22-02), create it here with the normalizePhone and isValidPhone functions:

```typescript
// src/lib/utils/phone.ts
export function normalizePhone(phone: string): string {
  let cleaned = phone.replace(/[^\d+]/g, '')
  const hasPlus = cleaned.startsWith('+')
  if (hasPlus) cleaned = cleaned.slice(1)

  if (cleaned.startsWith('0')) {
    cleaned = '62' + cleaned.slice(1)
  }

  if (cleaned.length <= 12 && !cleaned.startsWith('62')) {
    cleaned = '62' + cleaned
  }

  return '+' + cleaned
}

export function isValidPhone(phone: string): boolean {
  const normalized = normalizePhone(phone)
  return /^\+\d{10,15}$/.test(normalized)
}
```
  </action>
  <verify>
    ```bash
    npm run build
    ```
    Build passes.
  </verify>
  <done>
    /api/leads endpoint created that creates/updates contacts in my21staff workspace.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Pricing Form to Use Leads API</name>
  <files>
    src/app/pricing/page.tsx
  </files>
  <action>
Update the pricing page to submit to /api/leads instead of n8n webhook.

Find the handleSubmit function and update it:

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setIsSubmitting(true);

  try {
    const response = await fetch('/api/leads', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        nama,
        whatsapp: `${countryCode}${whatsapp}`,
        jenisBisnis,
        dariManaTahu,
        leadSources,
        currentTracking,
        leadsPerMonth,
        masalahBisnis,
        teamSize,
        paket: selectedPlan,
      }),
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Gagal mengirim form');
    }

    // Success
    setSubmitSuccess(true);
    resetForm();

    // Close modal after success
    setTimeout(() => {
      setModalOpen(false);
      setSubmitSuccess(false);
    }, 2000);
  } catch (error) {
    console.error('Form submission error:', error);
    alert(error instanceof Error ? error.message : 'Gagal mengirim form. Silakan coba lagi.');
  } finally {
    setIsSubmitting(false);
  }
};
```

Remove or comment out the n8n webhook URL reference:
```typescript
// OLD: const webhookUrl = process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL || "...";
// Now using /api/leads directly
```
  </action>
  <verify>
    ```bash
    npm run dev
    ```
    Visit /pricing, fill out form, submit. Check database for new contact.
  </verify>
  <done>
    Pricing form submits to /api/leads and creates contact in CRM.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. POST /api/leads accepts form data and creates contact
3. Phone numbers normalized correctly (+62 format)
4. Contact tagged with 'pricing-form' and plan name
5. Metadata stored with all form fields
6. Duplicate phone numbers update existing contact
7. Pricing form submission works end-to-end
</verification>

<success_criteria>
- [ ] /api/leads endpoint created
- [ ] Phone normalization works for various formats
- [ ] New contacts created in my21staff workspace
- [ ] Existing contacts updated (not duplicated)
- [ ] Tags include pricing-form and plan name
- [ ] Pricing page form submits successfully
- [ ] Form shows success state after submission
</success_criteria>

<output>
After completion, create `.planning/phases/22-settings-data-management/22-04-SUMMARY.md`
</output>
