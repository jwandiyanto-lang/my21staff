---
phase: 04-inbox-send
plan: 01
type: execute
---

<objective>
Wire up the Send button to Kapso API with optimistic UI for sent messages.

Purpose: Enable users to send WhatsApp messages directly from the CRM inbox without switching apps — completing the core value proposition.
Output: Functional message sending with instant UI feedback and error handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (directly related):
@.planning/phases/03-inbox-core/03-02-SUMMARY.md

# Key files to reference:
@src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
@src/app/(dashboard)/[workspace]/inbox/message-input.tsx
@src/app/(dashboard)/[workspace]/inbox/message-thread.tsx
@src/types/database.ts
@src/lib/mock-data.ts

# v1 reference (copy pattern):
~/Desktop/21/my21staff/src/lib/kapso/client.ts

**Tech stack available:** Next.js 15, React 19, Supabase, Shadcn/ui
**Established patterns:** Dev mode bypass, optimistic updates, ScrollArea with scroll-to-bottom

**Constraining decisions:**
- 03-02: Message bubbles 70% max-width, outbound right/primary, inbound left/muted
- 03-02: Lazy load messages on conversation selection
- Dev mode bypass for local testing without Kapso
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy Kapso client from v1</name>
  <files>src/lib/kapso/client.ts</files>
  <action>
Copy the Kapso client from v1 (~/Desktop/21/my21staff/src/lib/kapso/client.ts) to v2.
Only copy the core functions needed for v2:
- KapsoCredentials interface
- KapsoResponse interface
- cleanPhoneNumber helper
- getApiUrl helper
- sendMessage function
- createKapsoClient factory

Skip sendButtons and sendList for now (not needed for MVP text messaging).

The client uses fetch directly — no extra dependencies needed.
  </action>
  <verify>File exists at src/lib/kapso/client.ts with sendMessage export</verify>
  <done>Kapso client copied with sendMessage function available</done>
</task>

<task type="auto">
  <name>Task 2: Create send message API route</name>
  <files>src/app/api/messages/send/route.ts</files>
  <action>
Create POST /api/messages/send that:

1. Accepts body: { conversationId, content }
2. Gets current user from Supabase auth
3. Fetches conversation to get workspace_id and contact phone
4. Fetches workspace to get kapso_phone_id (and kapso_api_key from settings JSON)
5. Calls Kapso sendMessage with credentials
6. On success:
   - Insert message to Supabase (direction: 'outbound', sender_type: 'user', kapso_message_id from response)
   - Update conversation.last_message_at and last_message_preview
7. Return the created message

Error handling:
- 401 if not authenticated
- 404 if conversation not found or not authorized
- 500 if Kapso fails (with error message)

Dev mode: Check SUPABASE_ENV === 'dev' to skip actual Kapso call (return mock success).
  </action>
  <verify>curl -X POST /api/messages/send with valid auth should return 200 with message object</verify>
  <done>API route handles send, stores message, updates conversation, returns result</done>
</task>

<task type="auto">
  <name>Task 3: Wire up MessageInput with optimistic UI</name>
  <files>src/app/(dashboard)/[workspace]/inbox/message-input.tsx, src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx</files>
  <action>
MessageInput changes:
- Accept props: conversationId, contactPhone, onMessageSent callback
- Remove disabled state
- Add useState for message content and sending state
- On submit:
  1. Create optimistic message object (id: crypto.randomUUID(), status: 'sending')
  2. Call onMessageSent with optimistic message immediately
  3. POST to /api/messages/send
  4. On success: call onMessageSent with real message (replace optimistic)
  5. On error: show toast, call onMessageSent to remove optimistic message
- Disable button while sending
- Clear input on success

InboxClient changes:
- Pass conversationId and contact.phone to MessageInput
- Add handleMessageSent callback that:
  1. Appends optimistic message to messages state
  2. Replaces/removes on real result
- Messages with status='sending' should show subtle indicator (opacity-70 or spinner)

MessageThread changes:
- Handle message.status === 'sending' with visual feedback (opacity or small spinner)
  </action>
  <verify>Type message, click send → message appears immediately (optimistic), then confirms or shows error</verify>
  <done>Send button works with optimistic UI, errors show toast, input clears on success</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] In dev mode: send message shows optimistic UI, mock succeeds
- [ ] Message appears in thread immediately on send
- [ ] Input clears after successful send
- [ ] Error toast shows if send fails
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Send button functional with optimistic UI
- Dev mode works without Kapso credentials
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-inbox-send/04-01-SUMMARY.md` following the summary template with frontmatter.
</output>
