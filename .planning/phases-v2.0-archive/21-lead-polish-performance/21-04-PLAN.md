---
wave: 2
depends_on: []
files_modified: [src/app/(dashboard)/[workspace]/database/columns.tsx, src/app/(dashboard)/[workspace]/database/database-client.tsx]
autonomous: true
---

# 21-04: Inline Tags Dropdown

## Objective

Add per-row inline tags editing dropdown in the database table, matching the existing status and assign dropdown patterns.

## Tasks

<task id="1">
Update `src/app/(dashboard)/[workspace]/database/columns.tsx`:

Add `onTagsChange` to ColumnsConfig interface (around line 25-30):
```typescript
interface ColumnsConfig {
  onStatusChange?: (contactId: string, newStatus: LeadStatus) => void
  onAssigneeChange?: (contactId: string, assigneeId: string | null) => void
  onTagsChange?: (contactId: string, tags: string[]) => void  // Add this
  onDelete?: (contact: Contact) => void
  teamMembers?: TeamMember[]
  contactTags?: string[]  // Add this
}
```

Update createColumns function signature:
```typescript
export function createColumns({
  onStatusChange,
  onAssigneeChange,
  onTagsChange,
  onDelete,
  teamMembers = [],
  contactTags = []
}: ColumnsConfig = {}): ColumnDef<Contact>[]
```
</task>

<task id="2">
Replace the tags column cell (lines 146-168) with an inline dropdown:

```typescript
{
  accessorKey: 'tags',
  header: 'Tags',
  cell: ({ row }) => {
    const contact = row.original
    const tags = row.getValue('tags') as string[] || []

    if (!onTagsChange || contactTags.length === 0) {
      // Read-only display
      if (tags.length === 0) {
        return <span className="text-muted-foreground">-</span>
      }
      return (
        <div className="flex flex-wrap gap-1 max-w-[200px]">
          {tags.slice(0, 2).map((tag) => (
            <Badge key={tag} variant="secondary" className="text-xs">
              {tag}
            </Badge>
          ))}
          {tags.length > 2 && (
            <Badge variant="outline" className="text-xs">
              +{tags.length - 2}
            </Badge>
          )}
        </div>
      )
    }

    // Editable dropdown
    const toggleTag = (tag: string) => {
      const newTags = tags.includes(tag)
        ? tags.filter(t => t !== tag)
        : [...tags, tag]
      onTagsChange(contact.id, newTags)
    }

    return (
      <DropdownMenu>
        <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
          {tags.length === 0 ? (
            <button className="flex items-center gap-1 px-2 py-1 rounded-md text-xs text-muted-foreground hover:bg-muted transition-colors">
              ---
              <ChevronDown className="h-3 w-3" />
            </button>
          ) : (
            <button className="flex items-center gap-1 px-2 py-1 rounded-md text-xs hover:bg-muted transition-colors">
              <div className="flex gap-1 max-w-[150px]">
                {tags.slice(0, 2).map((tag) => (
                  <Badge key={tag} variant="secondary" className="text-xs">
                    {tag}
                  </Badge>
                ))}
                {tags.length > 2 && (
                  <Badge variant="outline" className="text-xs">
                    +{tags.length - 2}
                  </Badge>
                )}
              </div>
              <ChevronDown className="h-3 w-3 ml-1" />
            </button>
          )}
        </DropdownMenuTrigger>
        <DropdownMenuContent align="start" onClick={(e) => e.stopPropagation()}>
          {contactTags.map((tag) => {
            const isSelected = tags.includes(tag)
            return (
              <DropdownMenuItem
                key={tag}
                onClick={() => toggleTag(tag)}
                className="flex items-center gap-2"
              >
                <Checkbox checked={isSelected} className="h-4 w-4" />
                <span>{tag}</span>
              </DropdownMenuItem>
            )
          })}
        </DropdownMenuContent>
      </DropdownMenu>
    )
  },
},
```

Add Checkbox import at top of file:
```typescript
import { Checkbox } from '@/components/ui/checkbox'
```
</task>

<task id="3">
Update `src/app/(dashboard)/[workspace]/database/database-client.tsx`:

Add tags change handler (after handleAssigneeChange around line 159):
```typescript
// Handle inline tags change
const handleTagsChange = useCallback(async (contactId: string, newTags: string[]) => {
  // Optimistic update
  setContacts((prev) =>
    prev.map((c) =>
      c.id === contactId ? { ...c, tags: newTags } : c
    )
  )

  // Call API
  try {
    const response = await fetch(`/api/contacts/${contactId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tags: newTags }),
    })

    if (!response.ok) {
      throw new Error('Failed to update tags')
    }
    toast.success('Tags updated')
  } catch (error) {
    console.error('Failed to update contact tags:', error)
    // Revert on error
    setContacts(initialContacts)
    toast.error('Failed to update tags')
  }
}, [initialContacts])
```

Update createColumns call (around line 198-204):
```typescript
const allColumns = useMemo(
  () => createColumns({
    onStatusChange: handleStatusChange,
    onAssigneeChange: handleAssigneeChange,
    onTagsChange: handleTagsChange,  // Add this
    onDelete: setContactToDelete,
    teamMembers: columnTeamMembers,
    contactTags,  // Add this
  }),
  [handleStatusChange, handleAssigneeChange, handleTagsChange, columnTeamMembers, contactTags]
)
```
</task>

## Verification

- [ ] Tags column shows dropdown on click
- [ ] Clicking tag toggles it (checkbox updates)
- [ ] Changes persist immediately via API
- [ ] Optimistic UI updates without page refresh
- [ ] Empty tags show "---" with dropdown
- [ ] Multiple tags display with "+N" for overflow

## must_haves

- Inline tags dropdown in database table
- Checkbox-style tag selection
- Optimistic UI updates
