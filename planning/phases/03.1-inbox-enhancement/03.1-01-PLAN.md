# Phase 3.1 Plan 01: Inbox Enhancement â€” Profile, Handover, Merge

## Overview

Add missing inbox features from v2.0: contact profile sidebar, AI/Human handover toggle, and merge contacts functionality.

## Goal

When viewing a conversation in the inbox:
1. Contact profile sidebar appears on the right (editable fields, lead score, tags)
2. AI/Human handover toggle button in message thread header
3. Ability to merge duplicate contacts

## Dependencies

- Phase 3 (AI System) - Complete
- Existing components: `info-sidebar.tsx`, `merge-contacts-dialog.tsx`, handover API route

## Tasks

### Task 1: Integrate Profile Sidebar into Inbox

**What:** Add the existing `InfoSidebar` component to the inbox view

**Files to modify:**
- `src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx`

**Implementation:**
1. Import `InfoSidebar` from `@/components/contact/info-sidebar`
2. Add third column (right sidebar) when conversation is selected
3. Pass contact data, conversation status, team members
4. Wire up `onContactUpdate` callback to Convex mutation

**Code pattern:**
```tsx
<div className="flex h-[calc(100vh-4rem)]">
  {/* Left: Conversation list (w-80) */}
  {/* Center: Message thread (flex-1) */}
  {/* Right: Info sidebar (w-80) - only when conversation selected */}
  {selectedConversationId && selectedContact && (
    <InfoSidebar
      contact={selectedContact}
      messagesCount={messages?.length || 0}
      lastActivity={lastActivity}
      conversationStatus={conversationStatus}
      contactTags={contactTags}
      teamMembers={teamMembers}
      assignedTo={assignedTo}
      conversationId={selectedConversationId}
      onContactUpdate={handleContactUpdate}
      onAssignmentChange={handleAssignmentChange}
    />
  )}
</div>
```

**Convex queries needed:**
- `api.workspaces.getMembers` - for team member list
- `api.contacts.update` - for contact updates

---

### Task 2: Add AI/Human Handover Toggle to Message Thread

**What:** Add toggle button in message thread header to switch between AI and human control

**Files to modify:**
- `src/components/inbox/message-thread.tsx`

**Implementation:**
1. Add conversation status state (from parent or query)
2. Create toggle button with two states:
   - AI Active: Green "ðŸ¤– ARI Active" button
   - Human Mode: Orange "ðŸ‘¤ Manual" button
3. On click, call `/api/conversations/[id]/handover` API
4. Show loading state during toggle

**UI Pattern:**
```tsx
{/* In message thread header, after contact name */}
<div className="flex items-center gap-2">
  <Button
    variant={isAiActive ? "default" : "outline"}
    size="sm"
    onClick={handleHandoverToggle}
    disabled={isToggling}
    className={cn(
      "text-xs",
      isAiActive
        ? "bg-green-600 hover:bg-green-700"
        : "bg-orange-500 hover:bg-orange-600 text-white"
    )}
  >
    {isToggling ? (
      <Loader2 className="h-3 w-3 animate-spin mr-1" />
    ) : isAiActive ? (
      <Bot className="h-3 w-3 mr-1" />
    ) : (
      <User className="h-3 w-3 mr-1" />
    )}
    {isAiActive ? "ARI Active" : "Manual"}
  </Button>
</div>
```

**API call:**
```typescript
const handleHandoverToggle = async () => {
  setIsToggling(true)
  try {
    const res = await fetch(`/api/conversations/${conversationId}/handover`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ai_paused: isAiActive }) // Toggle current state
    })
    if (res.ok) {
      // Refetch conversation or update local state
      setIsAiActive(!isAiActive)
    }
  } finally {
    setIsToggling(false)
  }
}
```

---

### Task 3: Add Merge Button to Profile Sidebar

**What:** Add "Merge with..." button in profile sidebar that opens merge dialog

**Files to modify:**
- `src/components/contact/info-sidebar.tsx`
- `src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx`

**Implementation:**
1. Add "Merge" button to info-sidebar actions
2. When clicked, open merge contacts dialog
3. Show searchable list of contacts to merge with
4. Use existing `MergeContactsDialog` component

**UI Pattern:**
```tsx
{/* In info-sidebar, after "Add note" button */}
<Button
  variant="outline"
  size="sm"
  className="flex-1 text-xs"
  onClick={() => setShowMergeDialog(true)}
>
  <GitMerge className="h-3 w-3 mr-1" />
  Merge
</Button>
```

---

### Task 4: Wire Up Convex Mutations

**What:** Ensure all Convex mutations work for contact updates and handover

**Files to check/modify:**
- `convex/contacts.ts` - update mutation
- `convex/conversations.ts` - updateConversationStatus mutation

**Verify:**
1. `contacts.update` mutation exists and handles all fields
2. `conversations.updateConversationStatus` mutation exists
3. Both have auth checks disabled (same pattern as messages.ts)

---

## Acceptance Criteria

- [ ] Clicking conversation shows 3-column layout: list | messages | profile
- [ ] Profile sidebar shows contact info, lead score, tags, assignment
- [ ] Contact fields are editable inline (name, phone, email, status, score)
- [ ] AI/Human toggle button visible in message thread header
- [ ] Clicking toggle switches between "ARI Active" and "Manual" mode
- [ ] Handover updates conversation status in database
- [ ] When AI is paused, bot doesn't auto-respond (handled by processARI)
- [ ] Merge button opens dialog with contact selection
- [ ] Merging combines contacts correctly

## Files Changed

| File | Change |
|------|--------|
| `src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx` | Add InfoSidebar, wire up mutations |
| `src/components/inbox/message-thread.tsx` | Add handover toggle button |
| `src/components/contact/info-sidebar.tsx` | Add merge button |
| `convex/conversations.ts` | Verify/fix updateConversationStatus |

## Estimated Scope

- **Tasks:** 4
- **Files:** 4-5
- **Complexity:** Medium (integration of existing components)

---
*Phase: 03.1-inbox-enhancement*
*Created: 2026-01-25*
