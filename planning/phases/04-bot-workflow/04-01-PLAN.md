---
phase: 04-bot-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/context.ts
autonomous: true

must_haves:
  truths:
    - "Bot greets user with time-appropriate greeting"
    - "Bot asks for name if not known"
    - "Bot asks for destination country"
  artifacts:
    - path: "convex/ai/context.ts"
      provides: "State-aware greeting prompt builder"
      exports: ["buildMouthSystemPrompt", "QualificationContext"]
  key_links:
    - from: "convex/ai/context.ts"
      to: "convex/ai/mouth.ts"
      via: "buildMouthSystemPrompt import"
      pattern: "buildMouthSystemPrompt"
---

<objective>
Add greeting state awareness to Mouth system prompt.

Purpose: Enable bot to greet users naturally and collect basic info (name, destination)
Output: Enhanced buildMouthSystemPrompt that adapts behavior based on conversation state
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/04-bot-workflow/04-RESEARCH.md
@convex/ai/context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define QualificationContext interface</name>
  <files>convex/ai/context.ts</files>
  <action>
Add TypeScript interface for QualificationContext at the top of the file (after ConversationMessage interface):

```typescript
/**
 * Qualification data collected during bot conversation.
 * Stored in ariConversations.context field.
 */
export interface QualificationContext {
  // Phase 1: Basic info
  collected: {
    full_name?: string;
    destination_country?: string;  // Australia, Canada, UK, USA
    education_level?: string;      // SMA, S1, S2
  };
  // Phase 2: Documents
  documents: {
    passport?: boolean | null;     // true/false/null (not asked)
    cv?: boolean | null;
    english_test?: boolean | null;
    english_score?: number | null; // IELTS score if available
    transcript?: boolean | null;
  };
  // Routing decision
  routing?: {
    offered_at?: number;
    choice?: "community" | "consultation" | null;
    community_link_sent?: boolean;
    consultation_requested_at?: number;
  };
}
```

This interface documents the structure without requiring runtime validation (context is v.any()).
  </action>
  <verify>TypeScript compiles without errors: `npx convex dev --once`</verify>
  <done>QualificationContext interface exported from context.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add greeting state instructions to buildMouthSystemPrompt</name>
  <files>convex/ai/context.ts</files>
  <action>
Enhance buildMouthSystemPrompt to accept additional parameters and add greeting state logic:

1. Update function signature to accept optional state and context:
```typescript
export function buildMouthSystemPrompt(
  botName: string = "Ari",
  contactName: string = "kakak",
  language: string = "id",
  state: string = "greeting",
  context?: QualificationContext
): string
```

2. Add helper function buildGreetingInstructions (as shown in RESEARCH.md):
```typescript
function buildGreetingInstructions(isIndonesian: boolean): string {
  if (isIndonesian) {
    return `## TUGAS SAAT INI: Sapa dan kenalan
- Sapa dengan ramah sesuai waktu (pagi/siang/sore/malam)
- Tanya nama lengkap kalau belum tau
- Tanya negara tujuan kuliah
- JANGAN tanya semua sekaligus, satu per satu

CONTOH:
User: "halo"
Ari: "siang kak! mau kuliah di luar negeri ya? boleh tau namanya siapa?"

User: "aku dewi"
Ari: "hai kak dewi! negara tujuannya kemana nih?"`;
  }
  return `## CURRENT TASK: Greet and get to know
- Greet warmly based on time of day
- Ask for full name if unknown
- Ask for destination country
- Ask ONE thing at a time`;
}
```

3. Update the system prompt string to include state-specific instructions when state is "greeting":
```typescript
const stateInstructions = state === "greeting"
  ? buildGreetingInstructions(isIndonesian)
  : "";

// Add to system prompt after the style section
return `${existingContent}

${stateInstructions}`;
```

Keep existing prompt structure, just append state instructions.
  </action>
  <verify>
1. `npx convex dev --once` compiles without errors
2. Grep for new function: `grep -n "buildGreetingInstructions" convex/ai/context.ts`
  </verify>
  <done>buildMouthSystemPrompt supports state parameter and includes greeting instructions when state="greeting"</done>
</task>

</tasks>

<verification>
- [ ] QualificationContext interface exists and is exported
- [ ] buildMouthSystemPrompt accepts state and context parameters
- [ ] buildGreetingInstructions helper function exists
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
buildMouthSystemPrompt can generate greeting-specific instructions when state="greeting"
</success_criteria>

<output>
After completion, create `planning/phases/04-bot-workflow/04-01-SUMMARY.md`
</output>
