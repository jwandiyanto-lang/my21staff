---
phase: 04-bot-workflow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ai/context.ts
autonomous: true

must_haves:
  truths:
    - "Bot asks about documents one at a time"
    - "Bot tracks which documents have been asked"
    - "Bot acknowledges document status (have/don't have)"
  artifacts:
    - path: "convex/ai/context.ts"
      provides: "Qualifying state prompt instructions"
      exports: ["buildMouthSystemPrompt"]
  key_links:
    - from: "context.ts buildQualifyingInstructions"
      to: "QualificationContext.documents"
      via: "checks document status"
      pattern: "context\\.documents"
---

<objective>
Add qualifying state awareness to Mouth system prompt.

Purpose: Enable bot to collect document information (passport, CV, IELTS, transcript) one at a time
Output: buildQualifyingInstructions helper that generates document-collection prompts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/04-bot-workflow/04-RESEARCH.md
@convex/ai/context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add buildQualifyingInstructions helper</name>
  <files>convex/ai/context.ts</files>
  <action>
Add helper function to generate document-collection instructions based on what's already been asked:

```typescript
/**
 * Build qualifying instructions based on document collection progress.
 * Asks about documents one at a time in order: passport -> CV -> english_test -> transcript
 */
function buildQualifyingInstructions(
  context: QualificationContext | undefined,
  isIndonesian: boolean
): string {
  const docs = context?.documents || {};

  // Determine next document to ask about (null = not asked yet)
  const nextDoc = docs.passport === undefined ? "passport" :
                  docs.cv === undefined ? "CV" :
                  docs.english_test === undefined ? "IELTS/TOEFL" :
                  docs.transcript === undefined ? "ijazah/transkrip" : null;

  if (isIndonesian) {
    if (!nextDoc) {
      return `## TUGAS SAAT INI: Semua dokumen sudah ditanya
- Rangkum status dokumen yang sudah dikumpulkan
- Siap untuk tawarkan next step (komunitas atau konsultasi)`;
    }

    return `## TUGAS SAAT INI: Tanya dokumen
- Tanya tentang ${nextDoc}
- Kalau sudah punya, bilang "oke bagus!"
- Kalau belum punya, bilang "gpp nanti kita bantu"
- HANYA tanya SATU dokumen per pesan

CONTOH:
Ari: "oh iya kak, ${nextDoc}nya udah punya belum?"

User: "belum ada"
Ari: "gpp kak, nanti kita bantu urus. terus kalau CV udah ada?"

User: "udah"
Ari: "oke bagus! kalau IELTS atau TOEFL gimana?"`;
  }

  if (!nextDoc) {
    return `## CURRENT TASK: All documents asked
- Summarize collected document status
- Ready to offer next steps`;
  }

  return `## CURRENT TASK: Ask about documents
- Ask about ${nextDoc}
- If they have it, acknowledge positively
- If not, reassure them we can help
- Ask ONE document at a time`;
}
```
  </action>
  <verify>`npx convex dev --once` compiles without errors</verify>
  <done>buildQualifyingInstructions helper exists and handles document collection flow</done>
</task>

<task type="auto">
  <name>Task 2: Wire qualifying state into buildMouthSystemPrompt</name>
  <files>convex/ai/context.ts</files>
  <action>
Update buildMouthSystemPrompt to use buildQualifyingInstructions when state is "qualifying":

1. Update the state instructions logic:
```typescript
let stateInstructions = "";
switch (state) {
  case "greeting":
    stateInstructions = buildGreetingInstructions(isIndonesian);
    break;
  case "qualifying":
    stateInstructions = buildQualifyingInstructions(context, isIndonesian);
    break;
  // routing will be added in next plan
}
```

2. Add collected data summary if context exists:
```typescript
function formatCollectedData(context: QualificationContext | undefined): string {
  if (!context) return "";

  const lines: string[] = [];
  const { collected, documents } = context;

  if (collected?.full_name) lines.push(`Nama: ${collected.full_name}`);
  if (collected?.destination_country) lines.push(`Tujuan: ${collected.destination_country}`);
  if (collected?.education_level) lines.push(`Pendidikan: ${collected.education_level}`);

  if (documents) {
    if (documents.passport !== undefined) lines.push(`Passport: ${documents.passport ? 'Ada' : 'Belum'}`);
    if (documents.cv !== undefined) lines.push(`CV: ${documents.cv ? 'Ada' : 'Belum'}`);
    if (documents.english_test !== undefined) lines.push(`IELTS/TOEFL: ${documents.english_test ? 'Ada' : 'Belum'}`);
    if (documents.transcript !== undefined) lines.push(`Ijazah/Transkrip: ${documents.transcript ? 'Ada' : 'Belum'}`);
  }

  if (lines.length === 0) return "";
  return `## DATA YANG SUDAH DIKUMPULKAN\n${lines.join('\n')}`;
}
```

3. Include collected data in the prompt:
```typescript
const collectedDataSection = formatCollectedData(context);

return `${basePrompt}

${stateInstructions}

${collectedDataSection}`;
```
  </action>
  <verify>
1. `npx convex dev --once` compiles
2. `grep -n "qualifying" convex/ai/context.ts` shows case handling
  </verify>
  <done>buildMouthSystemPrompt handles "qualifying" state with document collection instructions</done>
</task>

</tasks>

<verification>
- [ ] buildQualifyingInstructions helper function exists
- [ ] formatCollectedData helper function exists
- [ ] buildMouthSystemPrompt switch statement handles "greeting" and "qualifying"
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
buildMouthSystemPrompt generates document-collection instructions when state="qualifying"
</success_criteria>

<output>
After completion, create `planning/phases/04-bot-workflow/04-02-SUMMARY.md`
</output>
