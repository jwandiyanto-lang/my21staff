---
phase: 03-ai-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "aiUsage table exists in Convex schema"
    - "Anthropic SDK installed and available"
    - "Eagle workspace has correct ARI config linkage"
  artifacts:
    - path: "convex/schema.ts"
      provides: "aiUsage table definition"
      contains: "aiUsage: defineTable"
    - path: "package.json"
      provides: "Anthropic SDK dependency"
      contains: "@anthropic-ai/sdk"
  key_links:
    - from: "convex/schema.ts"
      to: "convex/ai/cost-tracker.ts"
      via: "aiUsage table schema"
      pattern: "aiUsage"
---

<objective>
Foundation for dual-AI system — schema updates, dependencies, and workspace linkage verification

Purpose: Before implementing AI modules, we need the cost tracking schema, Anthropic SDK for Claude calls, and verified workspace linkage (fixing the workspace ID mismatch from Phase 2).

Output: Updated schema with aiUsage table, Anthropic SDK installed, verified Eagle workspace ARI config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/STATE.md
@planning/phases/03-ai-system/03-RESEARCH.md
@convex/schema.ts
@convex/kapso.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aiUsage table to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add aiUsage table to schema.ts for tracking AI model costs:

```typescript
// ============================================
// AI USAGE (Cost tracking for Mouth and Brain)
// ============================================
aiUsage: defineTable({
  workspace_id: v.id("workspaces"),
  conversation_id: v.optional(v.id("ariConversations")),
  model: v.string(),  // "sea-lion", "grok-beta", "claude-haiku-4.5", "claude-sonnet-4.5"
  ai_type: v.string(),  // "mouth" or "brain"
  input_tokens: v.number(),
  output_tokens: v.number(),
  cache_read_tokens: v.optional(v.number()),  // Claude prompt caching
  cost_usd: v.number(),
  created_at: v.number(),
})
  .index("by_workspace", ["workspace_id"])
  .index("by_workspace_type", ["workspace_id", "ai_type"])
  .index("by_conversation", ["conversation_id"]),
```

Place this after the ariMessages table definition.

IMPORTANT: Use `v.optional()` for fields that may not always have values. Do NOT use null.
  </action>
  <verify>Run `npx convex dev` and confirm schema push succeeds without errors. Check Convex dashboard shows aiUsage table.</verify>
  <done>aiUsage table exists in Convex schema with indexes for workspace, ai_type, and conversation queries.</done>
</task>

<task type="auto">
  <name>Task 2: Install Anthropic SDK for Claude API</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the Anthropic SDK for Claude API calls (The Brain):

```bash
npm install @anthropic-ai/sdk
```

This SDK provides TypeScript support, streaming, and prompt caching features needed for cost-optimized Claude calls.
  </action>
  <verify>Run `npm ls @anthropic-ai/sdk` to confirm installation. Check package.json includes the dependency.</verify>
  <done>@anthropic-ai/sdk is installed and listed in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 3: Verify and fix Eagle workspace ARI linkage</name>
  <files>None (verification task)</files>
  <action>
Phase 2 reported: "ARI not enabled for workspace js7b1cwpdpadcgds1cr8dqw7dh7zv3a3" — the workspace ID found by kapso_phone_id lookup differs from where ARI was configured.

Investigation steps:
1. Query Convex dashboard to find:
   - Eagle workspace by slug "eagle-overseas" and note its _id
   - The workspace with kapso_phone_id configured and note its _id
   - The workspace with ariConfig and note its workspace_id field

2. Expected outcome: All three should be the same workspace ID. If not:
   - The ariConfig was created for wrong workspace_id
   - Need to delete and recreate ariConfig for correct workspace

3. Run verification queries via Convex dashboard Data Browser:
   - workspaces table: Find by slug="eagle-overseas"
   - workspaces table: Find by kapso_phone_id (should match)
   - ariConfig table: Check workspace_id matches

4. If mismatch found, document the correct workspace_id and create new ariConfig:
   - Use seedAriConfig mutation with correct workspace_id
   - Delete old ariConfig record if exists for wrong workspace

Log findings in plan summary for future reference.
  </action>
  <verify>Query ariConfig via Convex dashboard: The workspace_id field matches the Eagle workspace _id that has kapso_phone_id configured.</verify>
  <done>Eagle workspace has correctly linked ariConfig — same workspace_id for kapso credentials and ARI config.</done>
</task>

</tasks>

<verification>
1. Schema: `npx convex dev` completes without errors
2. Dependencies: `npm ls @anthropic-ai/sdk` shows version installed
3. Workspace linkage: Convex dashboard shows ariConfig.workspace_id matches workspaces._id for Eagle
</verification>

<success_criteria>
- aiUsage table exists in Convex schema with by_workspace, by_workspace_type, by_conversation indexes
- @anthropic-ai/sdk is installed (check package.json)
- Eagle workspace ariConfig.workspace_id matches the workspace with kapso_phone_id
</success_criteria>

<output>
After completion, create `planning/phases/03-ai-system/03-01-SUMMARY.md`
</output>
