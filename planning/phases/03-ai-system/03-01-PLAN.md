---
phase: 03-ai-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "AI usage costs are trackable per workspace"
    - "Grok API calls work from Convex actions"
    - "Eagle workspace can process ARI messages with AI"
  artifacts:
    - path: "convex/schema.ts"
      provides: "aiUsage table definition plus contacts/ariConversations lead fields"
      contains: "aiUsage: defineTable"
  key_links:
    - from: "convex/schema.ts"
      to: "convex/ai/cost-tracker.ts"
      via: "aiUsage table schema"
      pattern: "aiUsage"
    - from: "convex/schema.ts"
      to: "convex/ai/brain.ts"
      via: "contacts.lead_score and ariConversations.state fields"
      pattern: "lead_score|lead_status|state|lead_temperature"
---

<objective>
Foundation for dual-AI system — schema updates, dependencies, and workspace linkage verification

Purpose: Before implementing AI modules, we need the cost tracking schema, lead scoring fields on contacts/ariConversations, Anthropic SDK for Claude calls, and verified workspace linkage (fixing the workspace ID mismatch from Phase 2).

Output: Updated schema with aiUsage table and lead fields, Anthropic SDK installed, verified Eagle workspace ARI config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/STATE.md
@planning/phases/03-ai-system/03-RESEARCH.md
@convex/schema.ts
@convex/kapso.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aiUsage table and lead scoring fields to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add aiUsage table AND lead scoring fields to contacts and ariConversations tables in schema.ts:

**1. Add aiUsage table** (place after ariMessages table definition):

```typescript
// ============================================
// AI USAGE (Cost tracking for Mouth and Brain)
// ============================================
aiUsage: defineTable({
  workspace_id: v.id("workspaces"),
  conversation_id: v.optional(v.id("ariConversations")),
  model: v.string(),  // "sea-lion", "grok-beta"
  ai_type: v.string(),  // "mouth" or "brain"
  input_tokens: v.number(),
  output_tokens: v.number(),
  cost_usd: v.number(),
  created_at: v.number(),
})
  .index("by_workspace", ["workspace_id"])
  .index("by_workspace_type", ["workspace_id", "ai_type"])
  .index("by_conversation", ["conversation_id"]),
```

**2. Add lead scoring fields to contacts table** (add these optional fields):

```typescript
// In the contacts table definition, add:
lead_score: v.optional(v.number()),      // 0-100 lead score from Brain
lead_status: v.optional(v.string()),     // "hot", "warm", "cold", "new"
```

**3. Add state fields to ariConversations table** (add these fields):

```typescript
// In the ariConversations table definition, add:
state: v.optional(v.string()),           // "greeting", "qualifying", "scheduling", "handoff"
lead_score: v.optional(v.number()),      // Conversation-level score
lead_temperature: v.optional(v.string()), // "hot", "warm", "cold"
```

IMPORTANT:
- Use `v.optional()` for all new fields to maintain backward compatibility with existing records
- Do NOT use null — Convex uses undefined for optional fields
- The Brain (Plan 03-03) will write to these fields; they must exist in schema first
  </action>
  <verify>Run `npx convex dev` and confirm schema push succeeds without errors. Check Convex dashboard shows aiUsage table and updated contacts/ariConversations tables with new fields.</verify>
  <done>Schema has aiUsage table with indexes, contacts table has lead_score and lead_status fields, ariConversations table has state, lead_score, and lead_temperature fields.</done>
</task>

<task type="auto">
  <name>Task 2: Verify Grok API key is configured</name>
  <files>None (verification only)</files>
  <action>
The Brain will use Grok API (not Claude). Verify GROK_API_KEY is set in Convex environment:

1. Check Convex dashboard → Settings → Environment Variables
2. Confirm GROK_API_KEY exists (from xAI Console)

If not set, document that it needs to be added before Plan 03-03.

Note: No SDK installation needed - Grok uses standard fetch API with OpenAI-compatible format.
  </action>
  <verify>Check Convex dashboard environment variables for GROK_API_KEY presence.</verify>
  <done>GROK_API_KEY is confirmed in Convex environment (or documented as needed).</done>
</task>

<task type="auto">
  <name>Task 3: Investigate and document Eagle workspace ARI linkage</name>
  <files>None (reconnaissance task — findings documented in summary)</files>
  <action>
Phase 2 reported: "ARI not enabled for workspace js7b1cwpdpadcgds1cr8dqw7dh7zv3a3" — the workspace ID found by kapso_phone_id lookup differs from where ARI was configured.

This is a RECONNAISSANCE task. Document findings in the plan summary.

Investigation steps:
1. Query Convex dashboard to find:
   - Eagle workspace by slug "eagle-overseas" and note its _id
   - The workspace with kapso_phone_id configured and note its _id
   - The workspace with ariConfig and note its workspace_id field

2. Expected outcome: All three should be the same workspace ID. If not:
   - The ariConfig was created for wrong workspace_id
   - Document the mismatch in summary
   - Either fix now (if simple) or note as blocking issue

3. Run verification queries via Convex dashboard Data Browser:
   - workspaces table: Find by slug="eagle-overseas"
   - workspaces table: Find by kapso_phone_id (should match)
   - ariConfig table: Check workspace_id matches

4. Document findings in plan summary:
   - The correct workspace_id for Eagle
   - Whether ariConfig is correctly linked
   - Any actions taken to fix (or needed to fix)

Log findings for future reference. This may require a follow-up fix task if workspace ID mismatch is confirmed.
  </action>
  <verify>Query ariConfig via Convex dashboard: Document whether workspace_id field matches the Eagle workspace _id that has kapso_phone_id configured.</verify>
  <done>Investigation complete — summary documents the correct workspace_id for Eagle and whether ariConfig linkage is correct or needs fixing.</done>
</task>

</tasks>

<verification>
1. Schema: `npx convex dev` completes without errors
2. Schema fields: contacts has lead_score/lead_status, ariConversations has state/lead_score/lead_temperature
3. Grok API: GROK_API_KEY confirmed in Convex environment variables
4. Workspace linkage: Investigation findings documented in summary
</verification>

<success_criteria>
- aiUsage table exists in Convex schema with by_workspace, by_workspace_type, by_conversation indexes
- contacts table has lead_score (optional number) and lead_status (optional string) fields
- ariConversations table has state (optional string), lead_score (optional number), lead_temperature (optional string) fields
- GROK_API_KEY is set in Convex environment (or documented as blocking)
- Summary documents Eagle workspace ariConfig investigation findings
</success_criteria>

<output>
After completion, create `planning/phases/03-ai-system/03-01-SUMMARY.md`
</output>
