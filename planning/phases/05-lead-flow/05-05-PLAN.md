---
phase: 05-lead-flow
plan: 05
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - src/app/api/contacts/[id]/route.ts
  - src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
autonomous: false

must_haves:
  truths:
    - "DELETE request to /api/contacts/{id} successfully deletes the contact"
    - "PATCH request to /api/contacts/{id} can update phone field"
    - "Delete button in contact detail sheet works correctly"
  artifacts:
    - path: "src/app/api/contacts/[id]/route.ts"
      provides: "DELETE and PATCH handlers for single contact"
      exports: ["DELETE", "PATCH"]
    - path: "src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx"
      provides: "Delete button calling correct endpoint"
      contains: "fetch(`/api/contacts/${contact.id}`"
  key_links:
    - from: "contact-detail-sheet.tsx"
      to: "/api/contacts/[id]"
      via: "fetch DELETE request"
      pattern: "method.*DELETE"
    - from: "/api/contacts/[id]/route.ts DELETE"
      to: "convex deleteContact mutation"
      via: "convex.mutation"
      pattern: "mutation.*deleteContact"
---

<objective>
Fix DELETE and UPDATE contact functionality in the API

Purpose: Contact CRUD operations work correctly from the Database UI
Output: DELETE handler added to /api/contacts/[id], phone field support in PATCH
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@src/app/api/contacts/[id]/route.ts
@src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
@convex/mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DELETE handler to /api/contacts/[id]</name>
  <files>src/app/api/contacts/[id]/route.ts</files>
  <action>
Add a DELETE handler to the existing route file. The file currently only has PATCH.

Add this DELETE handler after the existing PATCH handler:

```typescript
/**
 * DELETE /api/contacts/[id] - Delete a contact
 */
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { userId } = await auth()
  if (!userId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  try {
    const { id } = await params

    // Delete contact from Convex
    await convex.mutation(api.mutations.deleteContact, {
      contact_id: id,
    })

    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('DELETE /api/contacts/[id] error:', error)
    return NextResponse.json(
      { error: 'Failed to delete contact' },
      { status: 500 }
    )
  }
}
```

Note: The convex mutation `api.mutations.deleteContact` should already exist. If not, check convex/mutations.ts for the correct mutation name.
  </action>
  <verify>
1. Read the file and confirm DELETE export exists
2. Check that it calls a Convex mutation to delete the contact
  </verify>
  <done>
DELETE /api/contacts/{id} endpoint returns 200 on successful deletion
  </done>
</task>

<task type="auto">
  <name>Task 2: Add phone field support to PATCH handler</name>
  <files>src/app/api/contacts/[id]/route.ts</files>
  <action>
In the existing PATCH handler, add support for updating the phone field.

Find the section that extracts allowed fields (around line 25-31):

```typescript
// Extract allowed fields for update
const updates: any = {}
if (body.name !== undefined) updates.name = body.name
if (body.email !== undefined) updates.email = body.email
if (body.lead_status !== undefined) updates.lead_status = body.lead_status
if (body.lead_score !== undefined) updates.lead_score = body.lead_score
if (body.tags !== undefined) updates.tags = body.tags
if (body.assigned_to !== undefined) updates.assigned_to = body.assigned_to
```

Add the phone field:

```typescript
// Extract allowed fields for update
const updates: any = {}
if (body.name !== undefined) updates.name = body.name
if (body.phone !== undefined) updates.phone = body.phone
if (body.email !== undefined) updates.email = body.email
if (body.lead_status !== undefined) updates.lead_status = body.lead_status
if (body.lead_score !== undefined) updates.lead_score = body.lead_score
if (body.tags !== undefined) updates.tags = body.tags
if (body.assigned_to !== undefined) updates.assigned_to = body.assigned_to
```
  </action>
  <verify>
Read the file and confirm `body.phone !== undefined` check exists in PATCH handler
  </verify>
  <done>
PATCH /api/contacts/{id} can update contact phone number
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>DELETE and PATCH contact functionality</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`

2. Open Contact Database:
   - Go to http://localhost:3000/eagle-overseas/database

3. Test DELETE:
   - Click on any test contact (e.g., one created during Phase 5 testing)
   - In the contact detail sheet, find the delete button
   - Click delete and confirm
   - Contact should be removed from the list
   - No error should appear

4. Test PATCH with phone (if UI supports phone editing):
   - Open a contact detail
   - If there's a phone edit field, change the number
   - Save changes
   - Verify the phone number persists after refresh

5. Verify filters still work:
   - Try status filter (new/qualified/consultation/community)
   - Try tag filter (if tags exist)
   - Try assigned to filter (if team members exist)
  </how-to-verify>
  <resume-signal>Type "approved" if delete and update work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] DELETE handler exists in /api/contacts/[id]/route.ts
- [ ] DELETE returns 200 on successful deletion
- [ ] PATCH handler supports phone field updates
- [ ] No TypeScript errors: `npx tsc --noEmit`
- [ ] Delete button in UI successfully removes contact
- [ ] Filters continue to work (status, tag, assigned to)
</verification>

<success_criteria>
Contact CRUD is fully functional:
1. DELETE /api/contacts/{id} deletes the contact
2. PATCH /api/contacts/{id} supports phone field updates
3. UI delete button works without 404 error
4. Existing filter functionality is preserved
</success_criteria>

<output>
After completion, create `planning/phases/05-lead-flow/05-05-SUMMARY.md`
</output>
