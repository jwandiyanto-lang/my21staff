---
phase: 05-data-migration
plan: 05
type: execute
wave: 4
depends_on: ["05-03", "05-04"]
files_modified:
  - src/app/api/tickets/route.ts
  - src/app/api/tickets/[id]/route.ts
  - src/app/api/tickets/[id]/comments/route.ts
  - src/app/api/tickets/[id]/transition/route.ts
  - src/app/api/portal/tickets/route.ts
  - src/app/api/portal/tickets/[id]/route.ts
  - src/lib/ari/processor.ts
  - src/lib/ari/handoff.ts
  - src/lib/ari/scheduling.ts
autonomous: true

must_haves:
  truths:
    - "Tickets API reads from Convex instead of Supabase"
    - "Portal tickets API works with Convex"
    - "ARI processor uses Convex for conversation state"
    - "ARI handoff uses Convex for appointment creation"
    - "All Supabase queries removed from API routes"
  artifacts:
    - path: "src/app/api/tickets/route.ts"
      provides: "Tickets API using Convex"
      contains: "api\\.tickets\\."
    - path: "src/lib/ari/processor.ts"
      provides: "ARI processor using Convex"
      contains: "fetchQuery|fetchMutation"
  key_links:
    - from: "src/app/api/tickets/route.ts"
      to: "convex/tickets.ts"
      via: "Convex client"
      pattern: "fetchQuery|fetchMutation"
---

<objective>
Complete API migration by updating tickets, portal, and ARI processor to use Convex.

Purpose: Finalize the data layer migration, ensuring all API routes use Convex.
Output: All API routes migrated, phase verification complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-data-migration/05-03-SUMMARY.md
@.planning/phases/05-data-migration/05-04-SUMMARY.md

Reference existing Convex patterns:
@convex/tickets.ts
@convex/contacts.ts
@src/lib/convex/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update tickets API routes</name>
  <files>
    src/app/api/tickets/route.ts
    src/app/api/tickets/[id]/route.ts
    src/app/api/tickets/[id]/comments/route.ts
    src/app/api/tickets/[id]/transition/route.ts
    src/app/api/tickets/[id]/approval/route.ts
    src/app/api/tickets/[id]/reopen/route.ts
    src/app/api/tickets/[id]/attachments/route.ts
  </files>
  <action>
Update all tickets API routes to use Convex. The tickets schema already exists in Convex (from v3.0).

**tickets/route.ts:**
1. Replace Supabase with Convex imports
2. GET: Use existing `api.tickets.listTickets` query
3. POST: Use existing `api.tickets.createTicket` mutation
4. Remove profile joins (Clerk provides user info)

**tickets/[id]/route.ts:**
1. GET: `fetchQuery(api.tickets.getTicket, { ticketId })`
2. PUT: `fetchMutation(api.tickets.updateTicket, { ticketId, ...updates })`
3. DELETE: If exists, use delete mutation

**tickets/[id]/comments/route.ts:**
1. GET: `fetchQuery(api.tickets.getTicketComments, { ticketId })`
2. POST: `fetchMutation(api.tickets.addComment, { ticketId, content })`

**tickets/[id]/transition/route.ts:**
1. POST: `fetchMutation(api.tickets.transitionStage, { ticketId, toStage, reason })`
2. This should also create status history entry

**tickets/[id]/approval/route.ts:**
1. POST: Handle approval/rejection for stage skip

**tickets/[id]/reopen/route.ts:**
1. POST: Reopen closed ticket via token

**tickets/[id]/attachments/route.ts:**
1. Keep as-is if using Supabase storage, OR
2. If attachments stored elsewhere, update accordingly

Note: Check if convex/tickets.ts needs additional mutations. Add if missing:
- transitionStage (with status history)
- addComment
- handleApproval
- reopenTicket
  </action>
  <verify>
Test tickets endpoints:
- GET /api/tickets?workspaceId=... returns tickets
- POST /api/tickets creates ticket
- GET /api/tickets/[id]/comments returns comments
  </verify>
  <done>Tickets API routes using Convex</done>
</task>

<task type="auto">
  <name>Task 2: Update portal tickets API</name>
  <files>
    src/app/api/portal/tickets/route.ts
    src/app/api/portal/tickets/[id]/route.ts
    src/app/api/portal/tickets/[id]/comments/route.ts
  </files>
  <action>
Update portal tickets API (client-facing support portal):

**portal/tickets/route.ts:**
1. This is the central support hub for My21Staff workspace
2. GET: List all tickets across workspaces (admin view)
3. Use Convex query with appropriate filter

**portal/tickets/[id]/route.ts:**
1. GET: Fetch ticket details for portal view
2. PUT: Update ticket from portal

**portal/tickets/[id]/comments/route.ts:**
1. GET: List comments
2. POST: Add comment from portal

Key differences from workspace tickets:
- Portal may need cross-workspace access
- Ensure admin auth check is preserved
- Map user info from Clerk instead of profiles table
  </action>
  <verify>
Test portal endpoints (requires admin auth):
- GET /api/portal/tickets returns tickets list
- GET /api/portal/tickets/[id] returns ticket detail
  </verify>
  <done>Portal tickets API using Convex</done>
</task>

<task type="auto">
  <name>Task 3: Update ARI processor and handoff</name>
  <files>
    src/lib/ari/processor.ts
    src/lib/ari/handoff.ts
    src/lib/ari/scheduling.ts
    src/lib/ari/knowledge-base.ts
    src/app/api/cron/appointment-reminders/route.ts
  </files>
  <action>
Update ARI core files to use Convex for database operations:

**processor.ts:**
1. Replace Supabase queries for ari_conversations with Convex
2. Use `api.ariConversations.getByContact` query
3. Use `api.ariConversations.updateState` mutation
4. Replace ari_messages Supabase insert with Convex mutation

**handoff.ts:**
1. Replace ari_appointments Supabase insert with Convex
2. Use `api.ari.createAppointment` mutation (add if not in ari.ts)

**scheduling.ts:**
1. Replace consultant_slots query with Convex
2. Use `api.ari.getAvailableSlots` query
3. Replace ari_appointments query with Convex

**knowledge-base.ts:**
1. Replace ari_knowledge_entries query with Convex
2. Use `api.ari.getKnowledgeEntries` query

**cron/appointment-reminders/route.ts:**
1. Replace ari_appointments query with Convex
2. Query upcoming appointments
3. May need to add appointmentQuery to ari.ts

Pattern:
```typescript
// Before (Supabase)
const { data } = await supabase.from('ari_conversations').select('*')...

// After (Convex)
import { fetchQuery, fetchMutation } from '@/lib/convex/server';
import { api } from '@/convex/_generated/api';

const conversation = await fetchQuery(api.ariConversations.getByContact, {
  workspaceId, contactId
});
```
  </action>
  <verify>
- ARI processor compiles without errors
- Handoff creates appointments in Convex
- Scheduling queries slots from Convex
  </verify>
  <done>ARI core using Convex for all database operations</done>
</task>

</tasks>

<verification>
- [ ] All tickets API endpoints work with Convex
- [ ] Portal tickets endpoints work with Convex
- [ ] ARI processor reads/writes to Convex
- [ ] ARI handoff creates appointments in Convex
- [ ] No Supabase imports remain in updated files
- [ ] `grep -r "from('ari_" src/` returns no matches (excluding comments)
- [ ] `grep -r "from('tickets" src/` returns no matches (excluding comments)
</verification>

<success_criteria>
Phase 5 data migration complete:
- All API routes using Convex instead of Supabase
- Tickets system fully migrated
- ARI system fully migrated
- CMS system fully migrated
- Data integrity preserved
- Ready for Phase 6 (n8n integration)
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-migration/05-05-SUMMARY.md`
</output>
