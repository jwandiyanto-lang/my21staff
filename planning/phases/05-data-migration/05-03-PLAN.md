---
phase: 05-data-migration
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - convex/ari.ts
  - src/app/api/workspaces/[id]/ari-config/route.ts
  - src/app/api/workspaces/[id]/flow-stages/route.ts
  - src/app/api/workspaces/[id]/knowledge/route.ts
  - src/app/api/workspaces/[id]/knowledge/[entryId]/route.ts
  - src/app/api/workspaces/[id]/scoring-config/route.ts
  - src/app/api/workspaces/[id]/slots/route.ts
  - src/app/api/workspaces/[id]/slots/[slotId]/route.ts
autonomous: true

must_haves:
  truths:
    - "ARI config API reads from Convex instead of Supabase"
    - "Flow stages API reads from Convex instead of Supabase"
    - "Knowledge base API reads from Convex instead of Supabase"
    - "Scoring config API reads from Convex instead of Supabase"
    - "Consultant slots API reads from Convex instead of Supabase"
  artifacts:
    - path: "convex/ari.ts"
      provides: "Convex queries and mutations for ARI tables"
      exports: ["getAriConfig", "upsertAriConfig", "getFlowStages", "getKnowledgeCategories", "getKnowledgeEntries", "getScoringConfig", "getConsultantSlots"]
    - path: "src/app/api/workspaces/[id]/ari-config/route.ts"
      provides: "ARI config API using Convex"
      contains: "useQuery|fetchQuery"
  key_links:
    - from: "src/app/api/workspaces/[id]/ari-config/route.ts"
      to: "convex/ari.ts"
      via: "Convex client"
      pattern: "api\\.ari\\."
---

<objective>
Update ARI-related API routes to use Convex instead of Supabase.

Purpose: Complete the API migration for ARI configuration, flow stages, knowledge base, scoring, and slots.
Output: All ARI admin API routes using Convex backend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-data-migration/05-02-SUMMARY.md

Reference existing Convex patterns:
@convex/contacts.ts
@convex/workspaces.ts
@src/lib/convex/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ARI Convex queries and mutations</name>
  <files>convex/ari.ts</files>
  <action>
Create convex/ari.ts with queries and mutations for ARI tables:

**ARI Config:**
```typescript
import { v } from "convex/values";
import { query, mutation } from "./_generated/server";

// Get ARI config for workspace (or return defaults)
export const getAriConfig = query({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const config = await ctx.db
      .query("ariConfig")
      .withIndex("by_workspace", (q) => q.eq("workspace_id", args.workspaceId))
      .first();

    if (config) return config;

    // Return defaults
    return {
      workspace_id: args.workspaceId,
      bot_name: "ARI",
      greeting_style: "professional",
      language: "id",
      tone: { supportive: true, clear: true, encouraging: true },
      community_link: null,
    };
  },
});

// Upsert ARI config
export const upsertAriConfig = mutation({
  args: {
    workspaceId: v.id("workspaces"),
    bot_name: v.string(),
    greeting_style: v.string(),
    language: v.string(),
    tone: v.any(),
    community_link: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const existing = await ctx.db
      .query("ariConfig")
      .withIndex("by_workspace", (q) => q.eq("workspace_id", args.workspaceId))
      .first();

    const now = Date.now();
    if (existing) {
      await ctx.db.patch(existing._id, {
        bot_name: args.bot_name,
        greeting_style: args.greeting_style,
        language: args.language,
        tone: args.tone,
        community_link: args.community_link,
        updated_at: now,
      });
      return existing._id;
    }

    return await ctx.db.insert("ariConfig", {
      workspace_id: args.workspaceId,
      bot_name: args.bot_name,
      greeting_style: args.greeting_style,
      language: args.language,
      tone: args.tone,
      community_link: args.community_link,
      created_at: now,
      updated_at: now,
    });
  },
});
```

**Flow Stages:**
- getFlowStages(workspaceId): Query ariFlowStages by workspace, ordered by stage_order
- createFlowStage, updateFlowStage, deleteFlowStage mutations

**Knowledge Base:**
- getKnowledgeCategories(workspaceId): Query ariKnowledgeCategories by workspace
- getKnowledgeEntries(workspaceId, categoryId?): Query ariKnowledgeEntries
- createKnowledgeEntry, updateKnowledgeEntry, deleteKnowledgeEntry mutations

**Scoring Config:**
- getScoringConfig(workspaceId): Query ariScoringConfig or return defaults
- upsertScoringConfig mutation

**Consultant Slots:**
- getConsultantSlots(workspaceId): Query consultantSlots by workspace
- createSlot, updateSlot, deleteSlot mutations
  </action>
  <verify>Run `npx convex dev` - all functions compile without errors</verify>
  <done>Convex ARI module created with all queries and mutations</done>
</task>

<task type="auto">
  <name>Task 2: Update ARI config and flow stages API routes</name>
  <files>
    src/app/api/workspaces/[id]/ari-config/route.ts
    src/app/api/workspaces/[id]/flow-stages/route.ts
  </files>
  <action>
Update API routes to use Convex instead of Supabase:

**ari-config/route.ts:**
1. Import Convex server client: `import { fetchQuery, fetchMutation } from '@/lib/convex/server'`
2. Import API: `import { api } from '@/convex/_generated/api'`
3. Replace Supabase query with:
   ```typescript
   // GET
   const workspace = await fetchQuery(api.workspaces.getBySlug, { slug: workspaceId });
   if (!workspace) return NextResponse.json({ error: 'Workspace not found' }, { status: 404 });
   const config = await fetchQuery(api.ari.getAriConfig, { workspaceId: workspace._id });
   return NextResponse.json({ config });

   // PUT
   await fetchMutation(api.ari.upsertAriConfig, { workspaceId: workspace._id, ...body });
   ```
4. Remove Supabase imports and client usage
5. Keep workspace membership check (use existing pattern)

**flow-stages/route.ts:**
1. Same pattern: Replace Supabase with Convex queries
2. GET: `fetchQuery(api.ari.getFlowStages, { workspaceId: workspace._id })`
3. POST: `fetchMutation(api.ari.createFlowStage, { ... })`
4. PUT/DELETE: Update and delete mutations

Preserve:
- Authentication checks (requireWorkspaceMembership)
- Input validation
- Error handling patterns
  </action>
  <verify>
Test endpoints with curl:
- GET /api/workspaces/eagle-overseas/ari-config returns config
- GET /api/workspaces/eagle-overseas/flow-stages returns stages array
  </verify>
  <done>ARI config and flow stages APIs using Convex</done>
</task>

<task type="auto">
  <name>Task 3: Update knowledge, scoring, and slots API routes</name>
  <files>
    src/app/api/workspaces/[id]/knowledge/route.ts
    src/app/api/workspaces/[id]/knowledge/[entryId]/route.ts
    src/app/api/workspaces/[id]/scoring-config/route.ts
    src/app/api/workspaces/[id]/slots/route.ts
    src/app/api/workspaces/[id]/slots/[slotId]/route.ts
  </files>
  <action>
Update remaining ARI API routes to use Convex:

**knowledge/route.ts:**
- GET: Fetch categories and entries from Convex
- POST: Create entry via Convex mutation

**knowledge/[entryId]/route.ts:**
- GET: Fetch single entry
- PUT: Update entry
- DELETE: Delete entry

**scoring-config/route.ts:**
- GET: Fetch or return defaults
- PUT: Upsert config

**slots/route.ts:**
- GET: List slots for workspace
- POST: Create slot

**slots/[slotId]/route.ts:**
- GET: Fetch single slot
- PUT: Update slot
- DELETE: Delete slot

For each file:
1. Remove Supabase imports
2. Add Convex imports
3. Replace database calls with Convex queries/mutations
4. Keep auth checks and validation
  </action>
  <verify>
Test endpoints:
- GET /api/workspaces/eagle-overseas/knowledge returns categories/entries
- GET /api/workspaces/eagle-overseas/scoring-config returns config
- GET /api/workspaces/eagle-overseas/slots returns slots array
  </verify>
  <done>All ARI admin API routes using Convex</done>
</task>

</tasks>

<verification>
- [ ] `npx convex dev` shows all ARI functions deployed
- [ ] ari-config API returns config from Convex
- [ ] flow-stages API returns stages from Convex
- [ ] knowledge API returns categories/entries from Convex
- [ ] scoring-config API returns config from Convex
- [ ] slots API returns slots from Convex
- [ ] No Supabase imports remain in updated files
</verification>

<success_criteria>
ARI admin APIs migrated to Convex:
- All 7 ARI-related API routes use Convex
- CRUD operations work correctly
- Auth checks preserved
- Ready for CMS API migration in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-migration/05-03-SUMMARY.md`
</output>
