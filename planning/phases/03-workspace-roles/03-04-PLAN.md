---
phase: 03-workspace-roles
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/team/team-client.tsx
  - src/app/api/workspace-members/[id]/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Owner can invite team members and see success toast"
    - "Owner can remove team members and see success toast"
    - "Remove member API returns 403 for non-owners with new permission system"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/team/team-client.tsx"
      provides: "Wired handleInvite and handleRemove functions"
      contains: "fetch.*api/invitations"
    - path: "src/app/api/workspace-members/[id]/route.ts"
      provides: "Updated permission check using requirePermission"
      contains: "requirePermission"
  key_links:
    - from: "team-client.tsx"
      to: "/api/invitations"
      via: "fetch POST in handleInvite"
      pattern: "fetch.*api/invitations.*POST"
    - from: "team-client.tsx"
      to: "/api/workspace-members/[id]"
      via: "fetch DELETE in handleRemove"
      pattern: "fetch.*api/workspace-members.*DELETE"
    - from: "workspace-members/[id]/route.ts"
      to: "requirePermission"
      via: "import and use"
      pattern: "requirePermission.*team:remove"
---

<objective>
Close verification gaps: Wire team UI stubs to APIs and update workspace-members route to use new permission system.

Purpose: Complete the Phase 3 permission enforcement by connecting the already-functional APIs to the team management UI and ensuring consistent permission checks across all team management endpoints.

Output: Fully functional invite and remove member buttons; consistent permission enforcement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workspace-roles/03-VERIFICATION.md

Source files to modify:
@src/app/(dashboard)/[workspace]/team/team-client.tsx
@src/app/api/workspace-members/[id]/route.ts

Reference for API patterns:
@src/app/api/invitations/route.ts
@src/lib/auth/workspace-auth.ts
@src/lib/permissions/check.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire handleInvite and handleRemove in team-client.tsx</name>
  <files>src/app/(dashboard)/[workspace]/team/team-client.tsx</files>
  <action>
    Update team-client.tsx to wire the stub functions to actual API calls:

    1. **handleInvite function** (lines 68-82):
       - Replace the TODO comment and toast.info stub
       - POST to `/api/invitations` with body: `{ email: email.trim(), workspaceId: workspace.id }`
       - On success (response.ok): show toast.success("Undangan berhasil dikirim ke {email}"), clear email input, call router.refresh()
       - On error: parse error from response.json(), show toast.error with error message
       - Keep the try/catch, isInviting state, and finally block as-is

    2. **handleRemove function** (lines 110-113):
       - Replace the TODO comment and toast.info stub
       - Add confirmation: if (!confirm('Hapus anggota ini dari workspace?')) return
       - DELETE to `/api/workspace-members/${memberId}`
       - On success: show toast.success("Anggota berhasil dihapus"), call router.refresh()
       - On error: parse error, show toast.error with error message
       - Add loading state similar to handleRoleChange (optional but recommended)

    Keep all existing imports, state, and other functions unchanged.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    No TODO comments remain in handleInvite or handleRemove
  </verify>
  <done>
    handleInvite calls POST /api/invitations with email and workspaceId
    handleRemove calls DELETE /api/workspace-members/[id] with confirmation
    Both show appropriate success/error toasts and refresh the page
  </done>
</task>

<task type="auto">
  <name>Task 2: Update workspace-members DELETE route to use requirePermission</name>
  <files>src/app/api/workspace-members/[id]/route.ts</files>
  <action>
    Update the DELETE route to use the new permission system instead of the old owner/admin check:

    1. **Add imports** at top of file:
       ```typescript
       import { requireWorkspaceMembership } from '@/lib/auth/workspace-auth'
       import { requirePermission } from '@/lib/permissions/check'
       ```

    2. **Replace permission check logic** (lines 42-55):
       - After getting memberToDelete, use requireWorkspaceMembership(memberToDelete.workspace_id)
       - Check if authResult is NextResponse (unauthorized), if so return it
       - Then use requirePermission(authResult.role, 'team:remove', 'Only workspace owners can remove team members')
       - If permError, return it

    3. **Remove old pattern**:
       - Remove the manual currentUserMembership query
       - Remove the `if (!currentUserMembership || !['owner', 'admin'].includes(...))` check

    Note: Per CONTEXT.md, team:remove is owner-only (not admin). This is correct as per the permission constants.

    Keep the owner deletion protection (cannot remove owner) before the permission check.
    Keep the adminClient usage for the actual delete operation.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Route uses requirePermission pattern consistent with /api/invitations
  </verify>
  <done>
    DELETE route imports requireWorkspaceMembership and requirePermission
    Route uses requirePermission(role, 'team:remove') instead of manual role check
    Route returns 403 for non-owners with "Only workspace owners can remove team members" message
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```

2. **Pattern consistency check:**
   ```bash
   grep -n "requirePermission" src/app/api/workspace-members/[id]/route.ts
   grep -n "TODO" src/app/(dashboard)/[workspace]/team/team-client.tsx
   ```
   First should show requirePermission usage, second should show no results.

3. **Functional verification (manual):**
   - Log in as workspace owner
   - Go to /[workspace]/team
   - Test invite: Enter email, click Invite, verify toast and email sent
   - Test remove: Click trash icon on non-owner member, confirm, verify toast and member removed
</verification>

<success_criteria>
- handleInvite calls POST /api/invitations and handles response
- handleRemove calls DELETE /api/workspace-members/[id] with confirmation
- workspace-members DELETE uses requirePermission('team:remove')
- No TODO stubs remain in team-client.tsx for these functions
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-workspace-roles/03-04-SUMMARY.md`
</output>
