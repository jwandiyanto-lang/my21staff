---
phase: 05-central-support-hub
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/(dashboard)/[workspace]/support/page.tsx
  - src/app/(dashboard)/[workspace]/support/support-client.tsx
  - src/app/(dashboard)/[workspace]/support/[id]/page.tsx
  - src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx
  - src/app/api/tickets/[id]/comments/route.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin workspace sees all tickets routed to it"
    - "Admin can identify which client workspace each ticket came from"
    - "Admin can add internal notes hidden from clients"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/support/page.tsx"
      provides: "Admin ticket list including client tickets"
      contains: "admin_workspace_id"
    - path: "src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx"
      provides: "Internal comment toggle for admins"
      contains: "is_internal"
  key_links:
    - from: "src/app/(dashboard)/[workspace]/support/page.tsx"
      to: "tickets table"
      via: "Supabase query with admin_workspace_id"
      pattern: "admin_workspace_id"
---

<objective>
Update admin support pages to show all client tickets and add internal notes feature.

Purpose: Enable my21staff admin workspace to view and manage all client tickets from a central location with ability to add internal notes.

Output: Updated admin support pages with client ticket visibility and internal comments toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-tawkto-integration/05-RESEARCH.md
@.planning/phases/05-tawkto-integration/05-01-SUMMARY.md

@src/app/(dashboard)/[workspace]/support/page.tsx
@src/app/(dashboard)/[workspace]/support/support-client.tsx
@src/app/(dashboard)/[workspace]/support/[id]/page.tsx
@src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx
@src/app/api/tickets/[id]/comments/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update admin ticket list to show client tickets</name>
  <files>
    src/app/(dashboard)/[workspace]/support/page.tsx
    src/app/(dashboard)/[workspace]/support/support-client.tsx
  </files>
  <action>
1. Update src/app/(dashboard)/[workspace]/support/page.tsx:

Modify ticket query to include both:
- Internal tickets (workspace_id = current, admin_workspace_id IS NULL)
- Client tickets routed here (admin_workspace_id = current workspace)

```typescript
// Fetch internal tickets (created in this workspace)
const { data: internalTickets } = await supabase
  .from('tickets')
  .select(`
    *,
    requester:profiles!tickets_requester_id_fkey(id, full_name, email),
    assignee:profiles!tickets_assigned_to_fkey(id, full_name, email)
  `)
  .eq('workspace_id', workspace.id)
  .is('admin_workspace_id', null)
  .order('created_at', { ascending: false })

// Fetch client tickets routed to this admin workspace
const { data: clientTickets } = await supabase
  .from('tickets')
  .select(`
    *,
    requester:profiles!tickets_requester_id_fkey(id, full_name, email),
    assignee:profiles!tickets_assigned_to_fkey(id, full_name, email),
    source_workspace:workspaces!tickets_workspace_id_fkey(id, name, slug)
  `)
  .eq('admin_workspace_id', workspace.id)
  .order('created_at', { ascending: false })

// Combine and pass to client
const allTickets = [
  ...(internalTickets || []).map(t => ({ ...t, isClientTicket: false })),
  ...(clientTickets || []).map(t => ({ ...t, isClientTicket: true }))
].sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
```

2. Update src/app/(dashboard)/[workspace]/support/support-client.tsx:

Add to TicketData interface:
- `isClientTicket: boolean`
- `source_workspace?: { id: string; name: string; slug: string } | null`

Add column or badge to show source workspace for client tickets:
- Display source workspace name with different styling for client tickets
- Add "Client" badge or indicator

Add tabs or filter for "All", "Internal", "Client" tickets:
```typescript
const sourceFilters = [
  { value: 'all', label: 'All' },
  { value: 'internal', label: 'Internal' },
  { value: 'client', label: 'Client' }
]
```

Update table to show "Source" column for client tickets showing workspace name.
  </action>
  <verify>Run `npm run build`, then manually verify admin sees both internal and client tickets with source indicator</verify>
  <done>Admin ticket list shows all tickets with source workspace indicator for client tickets</done>
</task>

<task type="auto">
  <name>Task 2: Add internal comments feature</name>
  <files>
    src/app/(dashboard)/[workspace]/support/[id]/page.tsx
    src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx
    src/app/api/tickets/[id]/comments/route.ts
  </files>
  <action>
1. Update src/app/(dashboard)/[workspace]/support/[id]/page.tsx:

For ticket detail, fetch ticket allowing access if user is in workspace_id OR admin_workspace_id:
```typescript
// Get ticket - allow access if in workspace OR admin workspace
const { data: ticket, error: ticketError } = await supabase
  .from('tickets')
  .select(`
    *,
    requester:profiles!tickets_requester_id_fkey(id, full_name, email),
    assignee:profiles!tickets_assigned_to_fkey(id, full_name, email),
    source_workspace:workspaces!tickets_workspace_id_fkey(id, name, slug)
  `)
  .eq('id', ticketId)
  .single()

// Verify access - either workspace member or admin workspace member
const isWorkspaceMember = ticket.workspace_id === workspace.id
const isAdminWorkspaceMember = ticket.admin_workspace_id === workspace.id

if (!isWorkspaceMember && !isAdminWorkspaceMember) {
  notFound()
}

// Pass isClientTicket flag to client component
const isClientTicket = ticket.admin_workspace_id !== null
```

2. Update src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx:

Add CommentData interface update:
- `is_internal: boolean`

Add internal comment toggle (checkbox) next to comment textarea:
```tsx
const [isInternalComment, setIsInternalComment] = useState(false)

// Only show for owner/admin
{(currentUserRole === 'owner' || currentUserRole === 'admin') && isClientTicket && (
  <div className="flex items-center space-x-2 mb-2">
    <Checkbox
      id="internal"
      checked={isInternalComment}
      onCheckedChange={(checked) => setIsInternalComment(checked === true)}
    />
    <Label htmlFor="internal" className="text-sm font-normal cursor-pointer text-muted-foreground">
      Internal note (hidden from client)
    </Label>
  </div>
)}
```

Update comment submit to include is_internal:
```typescript
body: JSON.stringify({ content: commentText, is_internal: isInternalComment })
```

Style internal comments differently in list:
```tsx
<div className={`p-4 rounded-lg ${
  comment.is_internal
    ? 'bg-amber-50 border-l-2 border-amber-400' // Internal note styling
    : comment.is_stage_change
      ? 'bg-muted/50 border-l-2 border-primary'
      : 'bg-muted/30'
}`}>
  {comment.is_internal && (
    <Badge variant="outline" className="mb-2 text-xs text-amber-600 border-amber-300">
      Internal Note
    </Badge>
  )}
  ...
</div>
```

If isClientTicket, show source workspace info in header.

3. Update src/app/api/tickets/[id]/comments/route.ts:

Accept is_internal in POST body:
```typescript
const { content, is_internal = false } = body

// Only allow is_internal for owner/admin
let isInternal = false
if (is_internal) {
  const { data: membership } = await supabase
    .from('workspace_members')
    .select('role')
    .eq('workspace_id', ticket.workspace_id)
    .eq('user_id', user.id)
    .single()

  // Also check admin workspace
  let adminRole = null
  if (ticket.admin_workspace_id) {
    const { data: adminMembership } = await supabase
      .from('workspace_members')
      .select('role')
      .eq('workspace_id', ticket.admin_workspace_id)
      .eq('user_id', user.id)
      .single()
    adminRole = adminMembership?.role
  }

  if (['owner', 'admin'].includes(membership?.role) || ['owner', 'admin'].includes(adminRole)) {
    isInternal = true
  }
}

// Insert with is_internal
const { data: comment, error } = await supabase
  .from('ticket_comments')
  .insert({
    ticket_id: ticketId,
    author_id: user.id,
    content: content.trim(),
    is_internal: isInternal,
    is_stage_change: false
  })
```
  </action>
  <verify>
1. `npm run build` passes
2. Admin can add internal comment on client ticket
3. Internal comments show different styling with "Internal Note" badge
  </verify>
  <done>Admin can add internal notes on client tickets, internal notes styled differently and hidden from clients</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Admin workspace ticket list shows client tickets with source indicator
3. Tabs/filter works for All/Internal/Client tickets
4. Internal comment checkbox appears on client tickets for admin
5. Internal comments have amber styling with badge
</verification>

<success_criteria>
- Admin sees both internal and client tickets in list
- Client tickets show source workspace name
- Admin can filter by internal/client tickets
- Admin can add internal notes on client tickets
- Internal notes styled differently with "Internal Note" badge
- Internal notes hidden from client view (via portal API)
</success_criteria>

<output>
After completion, create `.planning/phases/05-tawkto-integration/05-04-SUMMARY.md`
</output>
