---
phase: 06-ui-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/database/columns.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking status dropdown on Contact A changes Contact A's status (not Contact B)"
    - "Tags dropdown toggles tags on the correct contact"
    - "Assignee dropdown assigns the correct contact"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/database/columns.tsx"
      provides: "Database table column definitions with unique keys on DropdownMenu components"
      exports: ["createColumns"]
      min_lines: 400
  key_links:
    - from: "DropdownMenu (Status column)"
      to: "onStatusChange handler"
      via: "onClick with contactId"
      pattern: "key=\\{contactId\\}"
    - from: "DropdownMenu (Tags column)"
      to: "onTagsChange handler"
      via: "toggleTag function"
      pattern: "key=\\{contactId\\}"
    - from: "DropdownMenu (Assignee column)"
      to: "onAssigneeChange handler"
      via: "onClick with contactId"
      pattern: "key=\\{contactId\\}"
---

<objective>
Fix Database dropdown closure bug by adding unique key props to force React component recreation.

Purpose: All three dropdowns (Status, Tags, Assignee) are modifying the WRONG contact because Radix UI DropdownMenu components lack unique key props. When table re-renders due to optimistic updates, React reconciliation reuses component instances with stale closures that capture the wrong contactId. Adding `key={contactId}` forces React to create fresh component instances with correct closures.

Output: Dropdowns work correctly - clicking a dropdown on Contact A modifies Contact A, not a different contact.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/planning/STATE.md

@/home/jfransisco/Desktop/21/my21staff/planning/debug/database-dropdown-bug.md
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/database/columns.tsx
</context>

<tasks>

<task type="auto">
  <name>Add key={contactId} to all three DropdownMenu components</name>
  <files>src/app/(dashboard)/[workspace]/database/columns.tsx</files>
  <action>
**Context - Why Previous Attempts Failed:**

Commit 77d8f8a ("fix: ensure dropdown closure captures correct contactId") renamed variables from `contact.id` to `contactId` in the onClick handlers. This made NO functional difference because BOTH are local variables captured in the same closure scope at the same time. Whether you write `onClick={() => updateStatus(contact.id)}` or `onClick={() => updateStatus(contactId)}`, the captured value is identical.

The root cause was NEVER addressed: Radix UI DropdownMenu components lack unique `key` props. Without keys, React's reconciliation algorithm reuses existing component instances when the table re-renders (triggered by optimistic updates). Instance reuse means old closures persist with stale contactId values.

**This plan addresses the actual root cause** by adding React `key` props to force component recreation and fresh closures.

**Root Cause:** Radix UI DropdownMenu components in the Status, Tags, and Assignee columns lack unique `key` props. When the table re-renders (triggered by optimistic updates), React's reconciliation algorithm reuses existing component instances instead of creating new ones. This causes the onClick handlers to retain stale closures that reference the wrong contactId.

**Technical explanation:**
- Without key: React sees "DropdownMenu at cell position" and reuses the same instance when row data changes
- Instance reuse = old closures = wrong contactId in onClick handlers
- With key={contactId}: React sees "DropdownMenu with unique key" and creates NEW instance when key changes
- New instance = new closures = correct contactId captured fresh

**Fix: Add key prop to three DropdownMenu components**

**Change 1: Status dropdown (around line 102)**

Find the Status column's cell renderer that returns the DropdownMenu. It looks like:
```tsx
return (
  <DropdownMenu>
    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
```

Change to:
```tsx
return (
  <DropdownMenu key={contactId}>
    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
```

**Change 2: Tags dropdown (around line 187)**

Find the Tags column's cell renderer that returns the DropdownMenu. It looks like:
```tsx
return (
  <DropdownMenu>
    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
```

Change to:
```tsx
return (
  <DropdownMenu key={contactId}>
    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
```

**Change 3: Assignee dropdown (around line 248)**

Find the Assignee column's cell renderer that returns the DropdownMenu. It looks like:
```tsx
return (
  <DropdownMenu>
    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
```

Change to:
```tsx
return (
  <DropdownMenu key={contactId}>
    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
```

**IMPORTANT:**
- Only add `key` to the `<DropdownMenu>` component itself
- Do NOT modify DropdownMenuTrigger or DropdownMenuContent
- Do NOT modify the existing `contactId` capture lines (79, 155, 233) - those are correct
- Do NOT modify the onClick handlers - they already use `contactId` correctly
- Do NOT modify the existing `key` props on DropdownMenuItem components - those are for array mapping

**Why this fixes the bug:**
1. React's reconciliation now creates NEW DropdownMenu instance when contactId changes
2. New instance = new cell renderer execution = fresh closures
3. Fresh closures capture the CORRECT contactId for that row
4. onClick handlers now reference correct contact
5. No more "clicking Contact A changes Contact B" bug

**Effect on performance:** Minimal. React was already re-rendering cells on data changes. Adding keys just ensures correct component instance management.
  </action>
  <verify>
1. Check the changes were applied:
   ```bash
   grep -n "<DropdownMenu key=" src/app/(dashboard)/[workspace]/database/columns.tsx
   ```
   Should show exactly 3 matches (Status, Tags, Assignee columns)

2. Test localhost with dev mode:
   ```bash
   npm run dev
   ```
   Visit http://localhost:3000/demo/database

3. Test Status dropdown:
   - Click status dropdown on Budi Santoso (first contact)
   - Change status to "Hot"
   - Verify Budi's status changes (not Siti's or any other contact)

4. Test Tags dropdown:
   - Click tags dropdown on Siti Nurhaliza (second contact)
   - Toggle "follow-up" tag on
   - Toggle "interested" tag on
   - Verify Siti's tags change (not Budi's)

5. Test Assignee dropdown:
   - Click assignee dropdown on Budi
   - Select a team member
   - Verify Budi's assignee changes (not Siti's)

6. Test with rapid changes (stress test):
   - Quickly change status on Contact A
   - Immediately change tags on Contact B
   - Immediately change assignee on Contact A again
   - Verify all changes applied to correct contacts

7. Check console for React warnings - should be none about missing keys or stale closures
  </verify>
  <done>
All three dropdowns (Status, Tags, Assignee) correctly modify the clicked contact. No more "wrong contact" bug. User can reliably update any contact's status, tags, or assignee without accidentally modifying a different contact.
  </done>
</task>

</tasks>

<verification>
**Localhost test:**
1. `npm run dev`
2. Visit http://localhost:3000/demo/database
3. Test each dropdown (Status, Tags, Assignee) on mock contacts
4. Verify correct contact is modified every time
5. No console errors or React warnings

**Production test:**
1. Navigate to Database page
2. Test Status dropdown: Click on Contact A, change to "Hot", verify Contact A changes
3. Test Tags dropdown: Click on Contact B, toggle tags, verify Contact B changes
4. Test Assignee dropdown: Click on Contact C, assign member, verify Contact C changes
5. Rapid changes: Quickly update multiple contacts, verify each change applies to correct contact

**Code verification:**
```bash
# Count DropdownMenu components with key props
grep -c "<DropdownMenu key={contactId}>" src/app/(dashboard)/[workspace]/database/columns.tsx
# Should be exactly 3
```

**Visual confirmation:**
- Status badge updates on the correct contact row
- Tags chips update on the correct contact row
- Assignee name updates on the correct contact row
- No cross-contact contamination
</verification>

<success_criteria>
- Status dropdown changes the correct contact's status (not a different contact)
- Tags dropdown toggles tags on the correct contact
- Assignee dropdown assigns the correct contact
- Works correctly with optimistic updates and rapid changes
- No React key warnings in console
- Both production and dev mode work correctly
</success_criteria>

<output>
After completion, create `planning/phases/06-ui-polish/06-04-SUMMARY.md`
</output>
