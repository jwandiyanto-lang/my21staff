---
phase: 06-ui-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/settings/page.tsx
  - src/app/(dashboard)/[workspace]/settings/settings-client.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settings page loads without React errors or crashes in production"
    - "Settings page displays all sections (General, Lead Stages, ARI)"
    - "AI status toggle is visible and reflects workspace configuration"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      provides: "Client component that fetches AI config with Clerk auth context"
      exports: ["SettingsClient"]
    - path: "src/app/(dashboard)/[workspace]/settings/page.tsx"
      provides: "Server component that only fetches workspace (no auth required)"
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/[workspace]/settings/page.tsx"
      to: "api.workspaces.getBySlug"
      via: "fetchQuery during SSR"
      pattern: "fetchQuery\\(api\\.workspaces\\.getBySlug"
    - from: "src/app/(dashboard)/[workspace]/settings/settings-client.tsx"
      to: "api.ari.getAriConfig"
      via: "useQuery with Clerk context"
      pattern: "useQuery\\(api\\.ari\\.getAriConfig"
---

<objective>
Fix Settings page crash by moving auth-protected query to client component.

Purpose: Settings page is crashing because it calls `fetchQuery(api.ari.getAriConfig)` during server-side rendering (SSR), but this query requires Clerk authentication which is unavailable in SSR context. The fix separates concerns: server component fetches public workspace data, client component fetches auth-protected AI config.

Output: Settings page loads successfully in production without server-side exceptions.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/planning/STATE.md

@/home/jfransisco/Desktop/21/my21staff/planning/debug/settings-page-crash.md
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/settings/page.tsx
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/settings/settings-client.tsx
@/home/jfransisco/Desktop/21/my21staff/convex/ari.ts
</context>

<tasks>

<task type="auto">
  <name>Move AI config fetch to client component</name>
  <files>
    src/app/(dashboard)/[workspace]/settings/page.tsx
    src/app/(dashboard)/[workspace]/settings/settings-client.tsx
  </files>
  <action>
**Root Cause:** Settings page (server component) calls `fetchQuery(api.ari.getAriConfig)` during SSR (line 48), but `getAriConfig` requires Clerk auth via `requireWorkspaceMembership`, which is unavailable in SSR context. This throws "Unauthorized" error and crashes the page.

**Why previous fix didn't work:** Commit 40fb338 fixed CLIENT-SIDE Clerk hook usage (useAuth), but this is a SERVER-SIDE auth issue in Convex queries.

**Fix Strategy:** Move AI config fetch from server component to client component where Clerk auth context is available via ClerkProvider.

**Changes to page.tsx (server component):**
1. Remove lines 47-53 (ARI config fetch and aiEnabled calculation)
2. Remove `fetchQuery` import if no longer used
3. Pass workspace data to SettingsClient WITHOUT aiEnabled prop
4. SettingsClient will fetch AI config itself using useQuery with Clerk context

**Changes to settings-client.tsx (client component):**
1. Remove `aiEnabled` from component props interface
2. Add Convex useQuery import: `import { useQuery } from 'convex/react'`
3. Add `api` import: `import { api } from 'convex/_generated/api'`
4. Inside component, fetch AI config with useQuery:
   ```tsx
   const ariConfig = useQuery(api.ari.getAriConfig, { workspace_id: workspace.id })
   const aiEnabled = ariConfig?.enabled !== false
   ```
5. Handle loading state: while `ariConfig === undefined`, show loading indicator or disable AI toggle
6. Use computed `aiEnabled` in existing code (should already be using this variable)

**Dev mode handling:**
- In page.tsx, dev mode already returns early with mock data (line 23), so no SSR issues in dev mode
- In settings-client.tsx, add dev mode check before useQuery:
  ```tsx
  const isDevMode = process.env.NEXT_PUBLIC_DEV_MODE === 'true'
  const ariConfig = useQuery(api.ari.getAriConfig, isDevMode ? 'skip' : { workspace_id: workspace.id })
  const aiEnabled = isDevMode ? true : (ariConfig?.enabled !== false)
  ```

**Why this fixes the bug:** Client components have access to ClerkProvider context, so `getAuthUserId(ctx)` in Convex queries will return valid user ID. Server components do NOT have this context during SSR.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/demo/settings - should load without errors
3. Check browser console - no React errors, no "Unauthorized" errors
4. Deploy to production and test Settings page - should load successfully
  </verify>
  <done>
Settings page loads without crashes in both localhost and production. AI toggle displays correctly with workspace configuration.
  </done>
</task>

</tasks>

<verification>
**Production test:**
1. Navigate to Settings page in production
2. Page loads without server-side exception (Digest: 2181255606)
3. All settings sections visible (General, Lead Stages, ARI)
4. AI toggle reflects correct workspace state

**Dev mode test:**
1. Visit http://localhost:3000/demo/settings
2. Page loads with mock data
3. No console errors

**Code verification:**
1. `grep -n "fetchQuery.*getAriConfig" src/app/(dashboard)/[workspace]/settings/page.tsx` - should return no results
2. `grep -n "useQuery.*getAriConfig" src/app/(dashboard)/[workspace]/settings/settings-client.tsx` - should show client-side query
</verification>

<success_criteria>
- [x] Settings page loads in production without server-side errors
- [x] AI status fetched on client side with Clerk auth context
- [x] Dev mode continues to work with mock data
- [x] Settings UI displays all sections correctly
- [x] No more "Unauthorized" errors in Convex logs
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-polish/06-01-SUMMARY.md`
</output>
