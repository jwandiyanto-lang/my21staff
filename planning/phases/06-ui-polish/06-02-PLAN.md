---
phase: 06-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/[workspace]/database/columns.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking status dropdown on Contact A changes Contact A's status (not a different contact)"
    - "Tags dropdown toggles tags on the correct contact"
    - "Assignee dropdown assigns the correct contact"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/database/columns.tsx"
      provides: "Database table column definitions with fixed dropdown component keys"
      exports: ["createColumns"]
      min_lines: 400
  key_links:
    - from: "DropdownMenu (Status column)"
      to: "onStatusChange handler"
      via: "onClick with contactId closure"
      pattern: "onClick.*onStatusChange.*contactId"
    - from: "DropdownMenu (Tags column)"
      to: "onTagsChange handler"
      via: "toggleTag closure"
      pattern: "onClick.*toggleTag"
    - from: "DropdownMenu (Assignee column)"
      to: "onAssigneeChange handler"
      via: "onClick with contactId closure"
      pattern: "onClick.*onAssigneeChange.*contactId"
---

<objective>
Fix Database dropdown closure bug by adding unique key props to force React to recreate component instances.

Purpose: All three dropdowns (Status, Tags, Assignee) are changing the WRONG contact because Radix UI DropdownMenu components lack unique key props. When the table re-renders due to optimistic updates, React reuses component instances with stale closures that reference the wrong contactId. Adding `key={contactId}` forces React to create fresh instances with correct closures.

Output: Dropdowns work correctly - clicking a dropdown on Contact A modifies Contact A, not a different contact.
</objective>

<execution_context>
@/home/jfransisco/.claude/get-shit-done/workflows/execute-plan.md
@/home/jfransisco/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jfransisco/Desktop/21/my21staff/planning/PROJECT.md
@/home/jfransisco/Desktop/21/my21staff/planning/ROADMAP.md
@/home/jfransisco/Desktop/21/my21staff/planning/STATE.md

@/home/jfransisco/Desktop/21/my21staff/planning/debug/database-dropdown-bug.md
@/home/jfransisco/Desktop/21/my21staff/src/app/(dashboard)/[workspace]/database/columns.tsx
</context>

<tasks>

<task type="auto">
  <name>Add unique key props to all three DropdownMenu components</name>
  <files>src/app/(dashboard)/[workspace]/database/columns.tsx</files>
  <action>
**Root Cause:** Radix UI DropdownMenu components in Status, Tags, and Assignee columns lack unique `key` props. When table re-renders (due to optimistic updates), React reconciliation reuses component instances across different rows, causing onClick handlers to reference stale closures with wrong contactId values.

**Why previous fix failed:** Commit 77d8f8a changed `contact.id` to `contactId` in onClick handlers, but both are local variables in the same scope, so this made NO difference. The real issue is React component reconciliation, not closure scope.

**Fix Strategy:** Add `key={contactId}` to each DropdownMenu component to force React to create new instances when row data changes, ensuring fresh closures with correct contactId.

**Changes required:**

1. **Status column (line 102):**
   ```tsx
   return (
     <DropdownMenu key={contactId}>  {/* ADD THIS KEY */}
       <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
         {/* ... existing code ... */}
       </DropdownMenuTrigger>
       <DropdownMenuContent align="start" onClick={(e) => e.stopPropagation()}>
         {/* ... existing code ... */}
       </DropdownMenuContent>
     </DropdownMenu>
   )
   ```

2. **Tags column (line 187):**
   ```tsx
   return (
     <DropdownMenu key={contactId}>  {/* ADD THIS KEY */}
       <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
         {/* ... existing code ... */}
       </DropdownMenuTrigger>
       <DropdownMenuContent align="start" onClick={(e) => e.stopPropagation()}>
         {/* ... existing code ... */}
       </DropdownMenuContent>
     </DropdownMenu>
   )
   ```

3. **Assignee column (line 248):**
   ```tsx
   return (
     <DropdownMenu key={contactId}>  {/* ADD THIS KEY */}
       <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
         {/* ... existing code ... */}
       </DropdownMenuTrigger>
       <DropdownMenuContent align="start" onClick={(e) => e.stopPropagation()}>
         {/* ... existing code ... */}
       </DropdownMenuContent>
     </DropdownMenu>
   )
   ```

**Technical explanation:**
- Without key: React sees "DropdownMenu at row index 0" and reuses it when data changes
- With key={contactId}: React sees "DropdownMenu with key 'abc123'" and creates NEW instance if key changes
- New instance = new closures = correct contactId captured

**IMPORTANT:** Only add `key` prop to the `<DropdownMenu>` component itself, NOT to DropdownMenuTrigger or DropdownMenuContent. The key on the root component is sufficient to force recreation of the entire dropdown tree.

**Do NOT modify:**
- The `contactId` capture on line 79 (Status), 155 (Tags), 233 (Assignee) - this is already correct
- The onClick handlers - they are already using the captured `contactId` correctly
- The existing `key` props on DropdownMenuItem components - those are for mapping arrays
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/demo/database
3. Test Status dropdown:
   - Click status dropdown on Budi Santoso
   - Change status to "Hot"
   - Verify Budi's status changes (not Siti's)
4. Test Tags dropdown:
   - Click tags dropdown on Siti Nurhaliza
   - Toggle "follow-up" tag
   - Verify Siti's tags change (not Budi's)
5. Test Assignee dropdown:
   - Click assignee dropdown on Budi
   - Assign to team member
   - Verify Budi's assignee changes (not Siti's)
6. Check browser console - no React warnings about keys
  </verify>
  <done>
All three dropdowns (Status, Tags, Assignee) modify the correct contact. User can click dropdown on any contact and changes apply to THAT contact, not a different one.
  </done>
</task>

</tasks>

<verification>
**Production test:**
1. Navigate to Database page
2. Open status dropdown on Contact A
3. Change status
4. Verify Contact A's status changes (not Contact B)
5. Repeat for Tags and Assignee dropdowns
6. Test with multiple rapid changes (optimistic updates)

**Dev mode test:**
1. Visit http://localhost:3000/demo/database
2. Test all three dropdowns with mock contacts (Budi, Siti)
3. Verify correct contact is modified each time

**Code verification:**
1. `grep -n "^      <DropdownMenu key=" src/app/(dashboard)/[workspace]/database/columns.tsx` - should show 3 results (Status, Tags, Assignee)
2. Each DropdownMenu component should have `key={contactId}` prop
</verification>

<success_criteria>
- [x] Status dropdown changes the correct contact's status
- [x] Tags dropdown toggles tags on the correct contact
- [x] Assignee dropdown assigns the correct contact
- [x] Works with optimistic updates (rapid changes)
- [x] No React key warnings in console
- [x] Both production and dev mode work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-polish/06-02-SUMMARY.md`
</output>
