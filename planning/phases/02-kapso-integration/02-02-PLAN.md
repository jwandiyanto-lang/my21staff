---
phase: 02-kapso-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/ariConfig.ts
autonomous: true

must_haves:
  truths:
    - "Eagle workspace has ARI configuration record"
    - "ARI bot name is 'Ari' for Eagle Overseas Education"
    - "ARI greeting style and language are configured for Indonesian market"
  artifacts:
    - path: "convex/ariConfig.ts"
      provides: "createAriConfig mutation"
      exports: ["createAriConfig", "getByWorkspace"]
  key_links:
    - from: "convex/kapso.ts"
      to: "ariConfig table"
      via: "by_workspace index query"
      pattern: 'query\\("ariConfig"\\)'
---

<objective>
Create ARI configuration for Eagle Overseas Education workspace.

Purpose: Without an ariConfig record, the processARI function skips AI response generation. The bot will receive messages but never reply.

Output: Eagle workspace has ARI configured with appropriate bot personality for education consultancy.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/02-kapso-integration/02-RESEARCH.md
@convex/schema.ts
@convex/kapso.ts
@business/bots/ARI.md (if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check existing ARI config and create query/mutation functions</name>
  <files>convex/ariConfig.ts</files>
  <action>
Check if convex/ariConfig.ts exists. If not, create it with:

1. `getByWorkspace` query - Find ariConfig by workspace_id
2. `createAriConfig` mutation - Create new ariConfig record
3. `updateAriConfig` mutation - Update existing ariConfig

Schema reference (from convex/schema.ts):
```typescript
ariConfig: {
  workspace_id: v.id("workspaces"),
  bot_name: v.string(),
  greeting_style: v.string(), // 'professional', 'friendly', 'casual'
  language: v.string(), // 'id', 'en'
  tone: v.optional(v.any()),
  community_link: v.optional(v.string()),
  created_at: v.number(),
  updated_at: v.number(),
}
```

For Eagle Overseas Education:
- bot_name: "Ari" (their AI assistant)
- greeting_style: "friendly" (education consultancy = approachable)
- language: "id" (Indonesian primary, English secondary)
- community_link: null (to be set later)
  </action>
  <verify>
TypeScript compiles: `npx convex dev --once`
Functions exported correctly.
  </verify>
  <done>ariConfig query and mutation functions exist.</done>
</task>

<task type="auto">
  <name>Task 2: Verify or create Eagle ARI config record</name>
  <files>convex/ariConfig.ts</files>
  <action>
Check if Eagle workspace already has an ariConfig record:

1. Query ariConfig by Eagle workspace_id
2. If exists, document current settings
3. If not exists, create one with these values:
   - bot_name: "Ari"
   - greeting_style: "friendly"
   - language: "id"
   - tone: { supportive: true, clear: true, encouraging: true }

To get Eagle workspace_id, first query workspaces by slug "eagle-overseas".

If creating via CLI:
```bash
# First get workspace ID
npx convex run workspaces:getBySlug '{"slug": "eagle-overseas"}'

# Then create ariConfig (replace WORKSPACE_ID)
npx convex run ariConfig:createAriConfig '{
  "workspace_id": "WORKSPACE_ID",
  "bot_name": "Ari",
  "greeting_style": "friendly",
  "language": "id"
}'
```

If ariConfig exists but needs updates, use updateAriConfig.
  </action>
  <verify>
Run: `npx convex run ariConfig:getByWorkspace '{"workspace_id": "WORKSPACE_ID"}'`
Confirm ariConfig record exists with correct bot_name "Ari".
  </verify>
  <done>Eagle workspace has ARI configuration with bot_name "Ari".</done>
</task>

<task type="auto">
  <name>Task 3: Verify ARI processing flow in code</name>
  <files>convex/kapso.ts</files>
  <action>
Review convex/kapso.ts to confirm ARI processing flow is correct:

1. Check processWorkspaceMessages() schedules processARI for text messages
2. Confirm processARI:
   - Queries ariConfig by workspace_id
   - Gets contact info
   - Creates/gets ariConversation
   - Builds system prompt with bot_name
   - Calls generateAIResponse
   - Sends response via sendKapsoMessage

Look for any @ts-ignore or @ts-nocheck that might indicate issues.
Document any potential problems found.

If buildSystemPrompt() uses hardcoded values instead of ariConfig fields, fix it.
The system prompt should use:
- ariConfig.bot_name (not hardcoded "ARI")
- ariConfig.greeting_style
- ariConfig.language
  </action>
  <verify>
Read convex/kapso.ts buildSystemPrompt function.
Confirm it uses ariConfig.bot_name, not hardcoded value.
  </verify>
  <done>ARI processing correctly uses workspace-specific configuration.</done>
</task>

</tasks>

<verification>
1. ariConfig.ts has getByWorkspace and createAriConfig functions
2. Eagle workspace has ariConfig record with bot_name "Ari"
3. processARI uses ariConfig values for system prompt
4. No TypeScript errors
</verification>

<success_criteria>
- ariConfig CRUD operations available via Convex functions
- Eagle workspace has ARI configuration
- System prompt dynamically uses ariConfig values
</success_criteria>

<output>
After completion, create `planning/phases/02-kapso-integration/02-02-SUMMARY.md`
</output>
