---
phase: 02-kapso-integration
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Webhook POST receives test message and logs payload"
    - "Message appears in Convex messages table"
    - "ARI generates and sends response"
    - "Inbox UI displays the conversation"
  artifacts:
    - path: "N/A"
      provides: "End-to-end verification"
  key_links:
    - from: "Kapso webhook POST"
      to: "convex/kapso.ts processWebhook"
      via: "ctx.scheduler.runAfter"
      pattern: "processWebhook"
    - from: "processWebhook"
      to: "processARI"
      via: "ctx.scheduler.runAfter"
      pattern: "processARI"
    - from: "Inbox UI"
      to: "api.conversations.listWithFilters"
      via: "useQuery"
      pattern: "useQuery.*conversations"
---

<objective>
End-to-end verification of Kapso WhatsApp integration.

Purpose: Confirm the complete message flow works in production: WhatsApp -> Kapso -> Convex webhook -> message storage -> ARI response -> inbox display.

Output: Verified working integration with test conversation visible in inbox.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PROJECT.md
@planning/ROADMAP.md
@planning/phases/02-kapso-integration/02-RESEARCH.md
@planning/phases/02-kapso-integration/02-01-SUMMARY.md
@planning/phases/02-kapso-integration/02-02-SUMMARY.md
@convex/kapso.ts
@src/app/(dashboard)/[workspace]/inbox/inbox-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify webhook POST processing</name>
  <files>N/A (verification only)</files>
  <action>
Test the webhook POST endpoint with a simulated Kapso payload:

1. Create a test payload matching Meta/WhatsApp webhook format:
```json
{
  "object": "whatsapp_business_account",
  "entry": [{
    "id": "ENTRY_ID",
    "changes": [{
      "field": "messages",
      "value": {
        "messaging_product": "whatsapp",
        "metadata": {
          "display_phone_number": "1234567890",
          "phone_number_id": "EAGLE_KAPSO_PHONE_ID"
        },
        "contacts": [{
          "profile": { "name": "Test User" },
          "wa_id": "6281234567890"
        }],
        "messages": [{
          "from": "6281234567890",
          "id": "wamid.test123",
          "timestamp": "1706184000",
          "type": "text",
          "text": { "body": "Halo, saya mau tanya tentang kuliah di luar negeri" }
        }]
      }
    }]
  }]
}
```

2. Send to production webhook:
```bash
curl -X POST "https://intent-otter-212.convex.site/webhook/kapso" \
  -H "Content-Type: application/json" \
  -d '{"object":"whatsapp_business_account","entry":[{"id":"ENTRY_ID","changes":[{"field":"messages","value":{"messaging_product":"whatsapp","metadata":{"display_phone_number":"1234567890","phone_number_id":"EAGLE_PHONE_ID"},"contacts":[{"profile":{"name":"Test User"},"wa_id":"6281234567890"}],"messages":[{"from":"6281234567890","id":"wamid.test_'$(date +%s)'","timestamp":"'$(date +%s)'","type":"text","text":{"body":"Halo, saya mau tanya"}}]}}]}]}'
```

Note: Replace EAGLE_PHONE_ID with actual kapso_phone_id from 02-01.

3. Check Convex logs for:
   - "[Kapso Webhook] Received payload"
   - "[Kapso Webhook] Queued for async processing"
   - "[Kapso] Processed X messages"
  </action>
  <verify>
Webhook returns 200 OK.
Convex logs show successful processing.
  </verify>
  <done>Webhook POST receives and processes payloads correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Verify message storage and ARI processing</name>
  <files>N/A (verification only)</files>
  <action>
Check Convex dashboard or query to verify:

1. Contact created/updated:
   - Query contacts table for phone "6281234567890"
   - Confirm workspace_id matches Eagle
   - Confirm name is "Test User" (from Kapso profile)

2. Conversation created:
   - Query conversations table by contact_id
   - Confirm status is "open"
   - Confirm unread_count > 0

3. Message stored:
   - Query messages table by conversation_id
   - Confirm direction is "inbound"
   - Confirm content matches test message
   - Confirm kapso_message_id is set

4. ARI processing:
   - Check Convex logs for "[ARI] Processing message"
   - If ARI config exists, should see AI response attempt
   - If Sea-Lion fails, should see Grok fallback
   - Look for "[ARI] Response sent"

If no ARI processing occurred, check:
- ariConfig exists for workspace
- meta_access_token is set (required for sending)
- Message type was "text"
  </action>
  <verify>
Run Convex dashboard queries to confirm data exists.
Check logs for ARI processing.
  </verify>
  <done>Messages stored correctly; ARI processing triggered if configured.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Kapso WhatsApp integration with webhook processing, message storage, and inbox display.</what-built>
  <how-to-verify>
1. Open production app: https://www.my21staff.com
2. Sign in with Google (Jonathan's account)
3. Navigate to Eagle Overseas workspace
4. Go to Inbox page
5. Verify:
   - Conversation list shows the test conversation
   - Test User contact appears with correct phone
   - Clicking conversation shows message thread
   - Test message "Halo, saya mau tanya" is visible
   - If ARI responded, bot message appears below

6. If inbox is empty:
   - Check browser console for errors
   - Verify workspace context is correct
   - Check Convex dashboard for messages table data

7. Test sending a reply:
   - Type a message in compose input
   - Click send
   - Verify message appears in thread
   - Check Convex logs for outbound processing
  </how-to-verify>
  <resume-signal>Type "approved" if inbox shows conversation correctly, or describe issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Webhook POST returns 200 and logs show processing
2. Contact, conversation, and message records exist in Convex
3. ARI processing triggered (if credentials configured)
4. Inbox UI displays conversation and messages
5. Manual reply from inbox works
</verification>

<success_criteria>
- KAPSO-01: Kapso webhook receives WhatsApp messages - VERIFIED
- KAPSO-02: Bot sends replies via Kapso API - VERIFIED (if ARI enabled)
- KAPSO-03: Message history syncs to Convex - VERIFIED
- KAPSO-04: Webhook verification working - VERIFIED (from 02-01)
</success_criteria>

<output>
After completion, create `planning/phases/02-kapso-integration/02-03-SUMMARY.md`
</output>
