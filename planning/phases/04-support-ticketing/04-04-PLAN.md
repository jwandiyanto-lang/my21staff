---
phase: 04-support-ticketing
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/app/(dashboard)/[workspace]/support/page.tsx
  - src/app/(dashboard)/[workspace]/support/support-client.tsx
  - src/app/(dashboard)/[workspace]/support/ticket-form-sheet.tsx
  - src/app/(dashboard)/[workspace]/support/[id]/page.tsx
  - src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx
  - src/app/(dashboard)/[workspace]/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can see ticket list at /[workspace]/support"
    - "User can create new ticket via form sheet"
    - "User can view ticket detail at /[workspace]/support/[id]"
    - "User can see comments timeline on ticket detail"
    - "User can add comments to ticket"
    - "Assigned staff can transition ticket stages"
    - "Requester sees approval banner if pending"
    - "Support nav item visible in sidebar"
  artifacts:
    - path: "src/app/(dashboard)/[workspace]/support/page.tsx"
      provides: "Ticket list page"
      min_lines: 30
    - path: "src/app/(dashboard)/[workspace]/support/[id]/page.tsx"
      provides: "Ticket detail page"
      min_lines: 40
    - path: "src/app/(dashboard)/[workspace]/support/ticket-form-sheet.tsx"
      provides: "New ticket creation form"
      min_lines: 80
  key_links:
    - from: "support/support-client.tsx"
      to: "/api/tickets"
      via: "fetch for ticket list"
      pattern: "fetch.*api/tickets"
    - from: "support/[id]/ticket-detail-client.tsx"
      to: "/api/tickets/[id]/transition"
      via: "transition action"
      pattern: "api/tickets.*transition"
---

<objective>
Create support ticketing UI - ticket list, new ticket form, and ticket detail with comments and stage management.

Purpose: User-facing interface for submitting and tracking support tickets.
Output: Complete support page at /[workspace]/support with full ticket lifecycle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-support-ticketing/04-CONTEXT.md
@.planning/phases/04-support-ticketing/04-03-SUMMARY.md
@src/app/(dashboard)/[workspace]/team/page.tsx
@src/app/(dashboard)/[workspace]/team/team-client.tsx
@src/app/(dashboard)/[workspace]/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ticket list page and form sheet</name>
  <files>src/app/(dashboard)/[workspace]/support/page.tsx, src/app/(dashboard)/[workspace]/support/support-client.tsx, src/app/(dashboard)/[workspace]/support/ticket-form-sheet.tsx</files>
  <action>
Create src/app/(dashboard)/[workspace]/support/ directory with:

**page.tsx** (Server Component):
```typescript
// Follow pattern from team/page.tsx
// - Get workspace from params
// - Verify user auth and workspace membership
// - Fetch tickets server-side for initial render
// - Get current user's role for permission checks
// - Pass to SupportClient
```

**support-client.tsx** (Client Component):
- State: tickets[], loading, filter (stage)
- Header with "Dukungan" title and "Tiket Baru" button (opens sheet)
- Stage filter tabs: Semua, Laporan, Diskusi, Keputusan, Implementasi, Selesai
- Ticket table/list with columns:
  - Title (link to detail)
  - Category badge
  - Priority badge (color-coded)
  - Stage badge
  - Requester name
  - Assigned to (or "Belum ditugaskan")
  - Created date
- Empty state if no tickets
- Use existing shadcn components: Button, Badge, Tabs

**ticket-form-sheet.tsx** (Client Component):
- Sheet dialog for new ticket creation
- Form fields:
  - Title (Input, required, max 255)
  - Description (Textarea, required)
  - Category (Select: Bug, Fitur, Pertanyaan)
  - Priority (RadioGroup: Rendah, Sedang, Tinggi)
- Submit handler: POST /api/tickets
- Loading state with Loader2
- Toast on success/error (sonner)
- Close sheet on success and refresh list

UI in Bahasa Indonesia per CLAUDE.md requirements.
  </action>
  <verify>Visit http://localhost:3000/[workspace]/support - should show ticket list. Click "Tiket Baru" - form sheet opens.</verify>
  <done>Ticket list and creation form working</done>
</task>

<task type="auto">
  <name>Task 2: Create ticket detail page with comments and transitions</name>
  <files>src/app/(dashboard)/[workspace]/support/[id]/page.tsx, src/app/(dashboard)/[workspace]/support/[id]/ticket-detail-client.tsx</files>
  <action>
Create src/app/(dashboard)/[workspace]/support/[id]/ directory with:

**page.tsx** (Server Component):
- Get ticket and comments server-side
- Get current user's role and ID
- Verify user is workspace member
- Pass to TicketDetailClient

**ticket-detail-client.tsx** (Client Component):

**Header section:**
- Back link to /[workspace]/support
- Title + category/priority badges
- Stage progress indicator (horizontal pills showing current stage)
- Assigned to dropdown (if owner/admin - uses tickets:assign permission)

**Approval banner (if pending_approval && requester):**
- Yellow alert showing pending stage skip request
- "Setuju" and "Tolak" buttons
- Calls POST /api/tickets/[id]/approval

**Main content - two columns or stacked:**

Left/Top - Ticket details:
- Description (markdown or plain text)
- Created at, Requester name
- Status history timeline (optional, can be collapsible)

Right/Bottom - Comments:
- Flat comment list with author, timestamp, content
- System comments (is_stage_change) styled differently (gray background)
- New comment textarea at bottom
- Submit button for comment

**Stage transition section (if owner/admin/assigned):**
- Show next stage button: "Lanjut ke [Next Stage]"
- If owner/admin: dropdown for skip stages
- Checkbox "Beritahu peserta via email"
- Optional comment field for transition reason
- Calls POST /api/tickets/[id]/transition

**Reopen section (if closed && requester):**
- "Buka Kembali" button
- Calls POST /api/tickets/[id]/reopen with no token (authenticated requester)

Use getValidTargetStages() from @/lib/tickets for dropdown options.
  </action>
  <verify>Visit http://localhost:3000/[workspace]/support/[ticketId] - shows detail with comments. Test stage transition works.</verify>
  <done>Full ticket detail page with comments, transitions, and approval UI</done>
</task>

<task type="auto">
  <name>Task 3: Add support link to sidebar navigation</name>
  <files>src/app/(dashboard)/[workspace]/layout.tsx</files>
  <action>
Update the workspace layout to include support page in navigation.

Find the sidebar navigation section and add:
```typescript
import { Headphones } from 'lucide-react'  // or LifeBuoy, MessageSquareMore

// In navigation items array, add:
{
  href: `/${workspaceSlug}/support`,
  label: 'Dukungan',
  icon: Headphones,  // or appropriate icon
}
```

Position after "Database" (leads) and before "Settings" in the nav order:
1. Dashboard
2. Inbox
3. Database
4. Website
5. **Dukungan** (new)
6. Team
7. Integrasi
8. Settings

Use existing nav item pattern from layout.tsx - likely NavLink or similar component with active state styling.
  </action>
  <verify>Navigate to workspace - sidebar shows "Dukungan" link. Clicking it goes to /[workspace]/support.</verify>
  <done>Support page accessible from main navigation</done>
</task>

</tasks>

<verification>
1. /[workspace]/support page loads with ticket list
2. Stage filter tabs filter tickets correctly
3. New ticket form creates ticket and refreshes list
4. /[workspace]/support/[id] shows ticket detail
5. Comments load and display in timeline
6. New comment can be added
7. Stage transition works for authorized users
8. Approval banner shows for requester on pending tickets
9. Reopen button shows for requester on closed tickets
10. Sidebar navigation includes Dukungan link
</verification>

<success_criteria>
- Complete support ticketing UI in Bahasa Indonesia
- Ticket creation with required field validation
- Ticket list with filtering by stage
- Ticket detail with full comment history
- Stage transition with notification toggle
- Approval workflow for stage skipping
- Reopen capability for requester
- Integrated into main navigation
- Follows existing UI patterns (shadcn, Tailwind)
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-ticketing/04-04-SUMMARY.md`
</output>
