---
phase: 05-polish-deploy
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: []
autonomous: false
model: opus

must_haves:
  truths:
    - "WhatsApp message received via ngrok appears in inbox"
    - "Reply sent from inbox is delivered to WhatsApp"
    - "Full round-trip messaging works on localhost"
  artifacts: []
  key_links:
    - from: "Kapso webhook"
      to: "localhost:3000/api/webhook/kapso"
      via: "ngrok tunnel"
      pattern: "ngrok-free.dev"
---

<objective>
Test full round-trip WhatsApp messaging via ngrok tunnel with Kapso webhooks.

Purpose: Verify the rebuilt inbox works with live Kapso integration before any deployment.
Output: Verified working inbox with documented test results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/phases/05-polish-deploy/05-RESEARCH.md (webhook testing patterns)
@planning/phases/05-polish-deploy/05-01-SUMMARY.md (ngrok setup from Plan 01)
@src/app/api/webhook/kapso/route.ts (webhook handler to verify)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start services and configure webhook</name>
  <files></files>
  <action>
    1. Start Next.js dev server: `npm run dev`
    2. In separate terminal, start ngrok: `node scripts/start-ngrok.js`
    3. Copy the ngrok public URL from output
    4. Document the current Kapso webhook URL (for revert later)
    5. Provide user with the new webhook URL to configure in Kapso dashboard

    Note: User must manually update Kapso webhook URL in their dashboard.
    This is a checkpoint:human-action because Kapso dashboard access is required.
  </action>
  <verify>
    - Dev server running on localhost:3000
    - ngrok tunnel active with public URL
    - User has the webhook URL ready: {ngrok-url}/api/webhook/kapso
  </verify>
  <done>Both services running, webhook URL ready for Kapso configuration</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Update Kapso webhook URL in dashboard</action>
  <instructions>
    Go to Kapso dashboard and update the webhook URL to the ngrok URL provided.

    Current webhook URL (to revert later): intent-otter-212.convex.site/webhook/kapso
    New webhook URL: {ngrok-url}/api/webhook/kapso

    Steps:
    1. Log into Kapso dashboard
    2. Find webhook configuration
    3. Update URL to ngrok URL
    4. Save changes
  </instructions>
  <resume-signal>Type "configured" when Kapso webhook URL is updated</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test receive direction (WhatsApp to Inbox)</name>
  <files></files>
  <action>
    Ask user to send a test WhatsApp message to the configured number.

    Check:
    1. Terminal shows webhook received (console logs)
    2. Open inbox at localhost:3000/eagle-overseas/inbox
    3. Verify message appears in conversation list
    4. Click conversation to view message content

    If message doesn't appear:
    - Check terminal for webhook errors
    - Verify ngrok is still connected
    - Check Convex dashboard for any errors
  </action>
  <verify>
    Message visible in inbox UI at localhost:3000
  </verify>
  <done>Incoming WhatsApp message appears in inbox</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Webhook receive flow (WhatsApp to Inbox)</what-built>
  <how-to-verify>
    1. Send a test WhatsApp message to the configured number
    2. Open localhost:3000/eagle-overseas/inbox
    3. Check if message appears in the conversation list
    4. Click the conversation to see message content
  </how-to-verify>
  <resume-signal>Type "received" if message appears, or describe the issue</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Test send direction (Inbox to WhatsApp)</name>
  <files></files>
  <action>
    From the inbox UI:
    1. Select the conversation with the test message
    2. Type a reply message
    3. Click send
    4. Verify message appears in the conversation UI (optimistic update)

    Ask user to check WhatsApp:
    - Reply should be delivered to the WhatsApp sender
  </action>
  <verify>
    - Message appears in inbox conversation
    - Message delivered to WhatsApp (user confirms)
  </verify>
  <done>Sent message appears in inbox and delivered to WhatsApp</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full round-trip messaging (receive + send)</what-built>
  <how-to-verify>
    1. In inbox, select the test conversation
    2. Type a reply message and send
    3. Check WhatsApp for the delivered reply
    4. Verify the sent message appears in inbox conversation
  </how-to-verify>
  <resume-signal>Type "verified" if round-trip works, or describe the issue</resume-signal>
</task>

<task type="auto">
  <name>Task 7: Cleanup and document results</name>
  <files></files>
  <action>
    1. Ask user to revert Kapso webhook URL back to production: intent-otter-212.convex.site/webhook/kapso
    2. Stop ngrok (Ctrl+C)
    3. Document test results:
       - Receive: PASS/FAIL
       - Send: PASS/FAIL
       - Any issues encountered
  </action>
  <verify>
    - Kapso webhook URL reverted
    - ngrok stopped
    - Test results documented
  </verify>
  <done>Webhook testing complete, services cleaned up</done>
</task>

</tasks>

<verification>
1. WhatsApp message received and visible in inbox
2. Reply sent from inbox and delivered to WhatsApp
3. Kapso webhook URL reverted to production
4. ngrok tunnel stopped
</verification>

<success_criteria>
- Full round-trip messaging verified working on localhost
- Kapso webhook URL reverted to production URL
- Test results documented
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-deploy/05-02-SUMMARY.md`
</output>
