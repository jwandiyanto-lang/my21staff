---
phase: 05-website-manager
plan: 04
type: execute
---

<objective>
Implement webinar CRUD and public registration flow that creates contacts.

Purpose: Allow admins to create webinars, and let visitors register which creates CRM contacts.
Output: Webinar create/edit form, public registration page, registration â†’ contact creation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-website-manager/05-03-SUMMARY.md
@src/app/(dashboard)/[workspace]/website/website-client.tsx
@src/app/(dashboard)/[workspace]/website/article-form-sheet.tsx
@src/lib/mock-data.ts
@src/types/database.ts
@src/middleware.ts

**Core value:** Registration flow creates contacts in CRM - this is the lead generation path.
**Pattern:** Follow article-form-sheet pattern for webinar form.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add webinar create/edit sheet</name>
  <files>
    src/app/(dashboard)/[workspace]/website/webinar-form-sheet.tsx,
    src/app/(dashboard)/[workspace]/website/website-client.tsx
  </files>
  <action>
Create WebinarFormSheet component for creating and editing webinars:

**webinar-form-sheet.tsx:**
- Sheet that opens from right side
- Form fields:
  - Title (Input, required)
  - Slug (Input, auto-generated from title)
  - Description (Textarea)
  - Cover Image URL (Input, optional)
  - Scheduled At (datetime-local input, required)
  - Duration (Input type number, minutes, default 60)
  - Meeting URL (Input, Zoom/Meet link, optional)
  - Max Registrations (Input type number, optional - blank = unlimited)
  - Status (Select: draft/published/completed/cancelled)
- Save button calls API route
- Pre-populate for editing
- Toast on save

**Update website-client.tsx:**
- Add state for selectedWebinar and isWebinarSheetOpen
- "Create Webinar" button in Webinars tab opens sheet
- Card click opens sheet with existing webinar
- Show registration count on cards (e.g., "12 registrations")
  </action>
  <verify>Click Create Webinar, fill form with scheduled date, submit saves; existing webinar opens with data</verify>
  <done>Webinar form sheet opens, saves correctly, list updates</done>
</task>

<task type="auto">
  <name>Task 2: Create webinar API routes</name>
  <files>
    src/app/api/webinars/route.ts,
    src/app/api/webinars/[id]/route.ts
  </files>
  <action>
Create API routes for webinar CRUD:

**/api/webinars (route.ts):**
- GET: List webinars for workspace with registration counts
  - Join with webinar_registrations to get count
  - Order by scheduled_at DESC
- POST: Create new webinar
  - Validate required fields (title, slug, workspace_id, scheduled_at)
  - Set published_at if status is 'published'

**/api/webinars/[id] (route.ts):**
- GET: Get single webinar with registration count
- PUT: Update webinar
- DELETE: Delete webinar (cascades to registrations)

All routes require authentication.
Dev mode bypass: Return mock success with fake registration counts.
  </action>
  <verify>Test API routes, verify registration counts return correctly</verify>
  <done>Webinar API routes handle CRUD with registration counts</done>
</task>

<task type="auto">
  <name>Task 3: Create public webinar registration page and API</name>
  <files>
    src/app/webinars/[workspace]/[slug]/page.tsx,
    src/app/api/webinars/register/route.ts,
    src/middleware.ts
  </files>
  <action>
Create public webinar page with registration form:

**Update middleware.ts:**
Add '/webinars' to publicRoutes.

**page.tsx (server component with client form):**
- Fetch webinar by workspace and slug
- Only show if status === 'published' and scheduled_at is in future
- If past or not published, show appropriate message
- Display:
  - Cover image
  - Title
  - Description
  - Date/time (formatted nicely with timezone)
  - Duration
  - Spots remaining (if max_registrations set)
- Registration form:
  - Name (Input, required)
  - Phone (Input, required - include country code hint)
  - Email (Input, optional)
  - Submit button "Register Now"
- On submit, call /api/webinars/register
- Show success message with confirmation

**/api/webinars/register (route.ts):**
This is the KEY lead generation endpoint:
1. Validate: webinar_id, name, phone required
2. Get workspace_id from webinar
3. Check if contact exists with this phone in workspace
   - If exists: use existing contact_id
   - If not: CREATE new contact (this is the lead gen!)
     - phone, name, email from form
     - lead_status: 'new'
     - metadata: { source: 'webinar_registration', webinar_slug: '...' }
4. Check registration limit if max_registrations set
5. Create webinar_registration linking contact to webinar
6. Return success with contact_id

IMPORTANT: This endpoint is PUBLIC (no auth required) - it's for visitors registering.

Dev mode: In dev mode, just return success with fake IDs.
  </action>
  <verify>Visit /webinars/{workspace}/{slug}, fill registration form, submit creates contact</verify>
  <done>Public registration page works, submitting creates contact in CRM</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete webinar system with lead generation</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Navigate to /{workspace}/website, go to Webinars tab
    3. Click "Create Webinar"
    4. Fill in: Title "Test Webinar", scheduled date in future, status Published
    5. Save - webinar appears in list
    6. Open new incognito tab (simulating visitor)
    7. Go to /webinars/{workspace}/test-webinar
    8. See webinar details and registration form
    9. Fill: Name "John Doe", Phone "+62812345678"
    10. Submit - see success message
    11. Go back to CRM (logged in tab)
    12. Check Database view - "John Doe" should appear as new contact!
    13. Check contact metadata shows source: webinar_registration
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Webinar form sheet works for create/edit
- [ ] API routes handle CRUD with registration counts
- [ ] Public registration page displays webinar details
- [ ] Registration form creates contact in CRM
- [ ] Past webinars show appropriate message
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>

- Webinars can be created and edited
- Public webinar page shows registration form
- Registration creates new contact in CRM (lead generation!)
- Registration count displayed on admin view
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-website-manager/05-04-SUMMARY.md`

This completes Phase 5: Website Manager.
Update STATE.md to reflect Phase 5 completion.
</output>
