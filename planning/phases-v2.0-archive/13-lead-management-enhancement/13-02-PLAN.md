---
phase: 13-lead-management-enhancement
plan: 02
type: execute
---

<objective>
Add tag management and message history to contact detail sheet.

Purpose: Complete the contact detail sheet with full tag editing and actual message history from conversations.
Output: Tag editor with add/remove functionality, Messages tab showing conversation history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-lead-management-enhancement/13-01-SUMMARY.md

**Key files:**
@src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx
@src/app/(dashboard)/[workspace]/inbox/message-thread.tsx
@src/types/database.ts

**Established patterns:**
- PATCH /api/contacts/[id] exists from Plan 01
- Inbox uses Kapso API for message history
- Shadcn/ui components for UI

**Data model:**
- contacts.tags is string[] in database
- conversations linked to contacts via contact_id
- messages linked to conversations via conversation_id
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tag management to detail sheet</name>
  <files>src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx</files>
  <action>
Add tag editing functionality:

1. **Tag display with remove:**
   - Each tag Badge gets an X button
   - Click X removes tag (calls PATCH API with updated tags array)
   - Optimistic removal with revert on error

2. **Add tag input:**
   - Add Input + Button below tags list
   - Button adds new tag to array (calls PATCH API)
   - Clear input after successful add
   - Prevent duplicate tags
   - Trim whitespace from tag names

3. **Common tags suggestion (optional):**
   - If workspace has common tags, show as clickable suggestions
   - For now, just free-form input is fine

Use existing PATCH /api/contacts/[id] endpoint from Plan 01.
  </action>
  <verify>npm run build passes, can add tags via input, can remove tags via X button</verify>
  <done>Tags can be added and removed, changes persist to database</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Messages tab with conversation data</name>
  <files>src/app/(dashboard)/[workspace]/database/contact-detail-sheet.tsx</files>
  <action>
Replace Messages tab placeholder with actual message history:

1. **Fetch conversation and messages:**
   - When Messages tab is selected, fetch conversation for this contact
   - Use existing /api/kapso/messages or direct Supabase query
   - Handle case where no conversation exists yet

2. **Display messages:**
   - Show messages in chronological order (oldest first)
   - Style inbound (from contact) vs outbound (from user) differently
   - Show timestamp for each message
   - Reuse styling patterns from inbox/message-thread.tsx

3. **Empty state:**
   - If no conversation exists: "No messages yet"
   - If conversation exists but no messages: "Conversation started, no messages"

4. **Quick action:**
   - Keep existing "Open in Inbox" button for full chat experience
   - Messages tab is read-only preview

Use Supabase client to fetch. Consider lazy loading on tab select to avoid fetching for contacts user doesn't expand.
  </action>
  <verify>npm run build passes, Messages tab shows actual message history (or appropriate empty state)</verify>
  <done>Messages tab displays conversation history, links to full Inbox</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Can add new tags to contact
- [ ] Can remove existing tags from contact
- [ ] Tags persist to database
- [ ] Messages tab shows actual messages (if conversation exists)
- [ ] Messages tab shows empty state (if no conversation)
- [ ] "Open in Inbox" button still works
</verification>

<success_criteria>

- Tag management fully functional (add/remove)
- Messages tab shows real conversation data
- Empty states handled gracefully
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-lead-management-enhancement/13-02-SUMMARY.md`
</output>
